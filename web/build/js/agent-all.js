(function(window,undefined){var TraceKit={};var _oldTraceKit=window.TraceKit;var _slice=[].slice;var UNKNOWN_FUNCTION="?";
function _has(object,key){return Object.prototype.hasOwnProperty.call(object,key)}function _isUndefined(what){return typeof what==="undefined"
}TraceKit.noConflict=function noConflict(){window.TraceKit=_oldTraceKit;return TraceKit};TraceKit.wrap=function traceKitWrapper(func){function wrapped(){try{return func.apply(this,arguments)
}catch(e){TraceKit.report(e);throw e}}return wrapped};TraceKit.report=(function reportModuleWrapper(){var handlers=[],lastException=null,lastExceptionStack=null;
function subscribe(handler){installGlobalHandler();handlers.push(handler)}function unsubscribe(handler){for(var i=handlers.length-1;
i>=0;--i){if(handlers[i]===handler){handlers.splice(i,1)}}}function notifyHandlers(stack,windowError){var exception=null;
if(windowError&&!TraceKit.collectWindowErrors){return}for(var i in handlers){if(_has(handlers,i)){try{handlers[i].apply(null,[stack].concat(_slice.call(arguments,2)))
}catch(inner){exception=inner}}}if(exception){throw exception}}var _oldOnerrorHandler,_onErrorHandlerInstalled;
function traceKitWindowOnError(message,url,lineNo){var stack=null;if(lastExceptionStack){TraceKit.computeStackTrace.augmentStackTraceWithInitialElement(lastExceptionStack,url,lineNo,message);
stack=lastExceptionStack;lastExceptionStack=null;lastException=null}else{var location={"url":url,"line":lineNo};
location.func=TraceKit.computeStackTrace.guessFunctionName(location.url,location.line);location.context=TraceKit.computeStackTrace.gatherContext(location.url,location.line);
stack={"mode":"onerror","message":message,"url":document.location.href,"stack":[location],"useragent":navigator.userAgent}
}notifyHandlers(stack,"from window.onerror");if(_oldOnerrorHandler){return _oldOnerrorHandler.apply(this,arguments)
}return false}function installGlobalHandler(){if(_onErrorHandlerInstalled===true){return}_oldOnerrorHandler=window.onerror;
window.onerror=traceKitWindowOnError;_onErrorHandlerInstalled=true}function report(ex){var args=_slice.call(arguments,1);
if(lastExceptionStack){if(lastException===ex){return}else{var s=lastExceptionStack;lastExceptionStack=null;
lastException=null;notifyHandlers.apply(null,[s,null].concat(args))}}var stack=TraceKit.computeStackTrace(ex);
lastExceptionStack=stack;lastException=ex;window.setTimeout(function(){if(lastException===ex){lastExceptionStack=null;
lastException=null;notifyHandlers.apply(null,[stack,null].concat(args))}},(stack.incomplete?2000:0));
throw ex}report.subscribe=subscribe;report.unsubscribe=unsubscribe;return report}());TraceKit.computeStackTrace=(function computeStackTraceWrapper(){var debug=false,sourceCache={};
function loadSource(url){if(!TraceKit.remoteFetching){return""}try{function getXHR(){try{return new window.XMLHttpRequest()
}catch(e){return new window.ActiveXObject("Microsoft.XMLHTTP")}}var request=getXHR();request.open("GET",url,false);
request.send("");return request.responseText}catch(e){return""}}function getSource(url){if(!_has(sourceCache,url)){var source="";
if(url.indexOf(document.domain)!==-1){source=loadSource(url)}sourceCache[url]=source?source.split("\n"):[]
}return sourceCache[url]}function guessFunctionName(url,lineNo){var reFunctionArgNames=/function ([^(]*)\(([^)]*)\)/,reGuessFunction=/['"]?([0-9A-Za-z$_]+)['"]?\s*[:=]\s*(function|eval|new Function)/,line="",maxLines=10,source=getSource(url),m;
if(!source.length){return UNKNOWN_FUNCTION}for(var i=0;i<maxLines;++i){line=source[lineNo-i]+line;if(!_isUndefined(line)){if((m=reGuessFunction.exec(line))){return m[1]
}else{if((m=reFunctionArgNames.exec(line))){return m[1]}}}}return UNKNOWN_FUNCTION}function gatherContext(url,line){var source=getSource(url);
if(!source.length){return null}var context=[],linesBefore=Math.floor(TraceKit.linesOfContext/2),linesAfter=linesBefore+(TraceKit.linesOfContext%2),start=Math.max(0,line-linesBefore-1),end=Math.min(source.length,line+linesAfter-1);
line-=1;for(var i=start;i<end;++i){if(!_isUndefined(source[i])){context.push(source[i])}}return context.length>0?context:null
}function escapeRegExp(text){return text.replace(/[\-\[\]{}()*+?.,\\\^$|#]/g,"\\$&")}function escapeCodeAsRegExpForMatchingInsideHTML(body){return escapeRegExp(body).replace("<","(?:<|&lt;)").replace(">","(?:>|&gt;)").replace("&","(?:&|&amp;)").replace('"','(?:"|&quot;)').replace(/\s+/g,"\\s+")
}function findSourceInUrls(re,urls){var source,m;for(var i=0,j=urls.length;i<j;++i){if((source=getSource(urls[i])).length){source=source.join("\n");
if((m=re.exec(source))){return{"url":urls[i],"line":source.substring(0,m.index).split("\n").length,"column":m.index-source.lastIndexOf("\n",m.index)-1}
}}}return null}function findSourceInLine(fragment,url,line){var source=getSource(url),re=new RegExp("\\b"+escapeRegExp(fragment)+"\\b"),m;
line-=1;if(source&&source.length>line&&(m=re.exec(source[line]))){return m.index}return null}function findSourceByFunctionBody(func){var urls=[window.location.href],scripts=document.getElementsByTagName("script"),body,code=""+func,codeRE=/^function(?:\s+([\w$]+))?\s*\(([\w\s,]*)\)\s*\{\s*(\S[\s\S]*\S)\s*\}\s*$/,eventRE=/^function on([\w$]+)\s*\(event\)\s*\{\s*(\S[\s\S]*\S)\s*\}\s*$/,re,parts,result;
for(var i=0;i<scripts.length;++i){var script=scripts[i];if(script.src){urls.push(script.src)}}if(!(parts=codeRE.exec(code))){re=new RegExp(escapeRegExp(code).replace(/\s+/g,"\\s+"))
}else{var name=parts[1]?"\\s+"+parts[1]:"",args=parts[2].split(",").join("\\s*,\\s*");body=escapeRegExp(parts[3]).replace(/;$/,";?");
re=new RegExp("function"+name+"\\s*\\(\\s*"+args+"\\s*\\)\\s*{\\s*"+body+"\\s*}")}if((result=findSourceInUrls(re,urls))){return result
}if((parts=eventRE.exec(code))){var event=parts[1];body=escapeCodeAsRegExpForMatchingInsideHTML(parts[2]);
re=new RegExp("on"+event+"=[\\'\"]\\s*"+body+"\\s*[\\'\"]","i");if((result=findSourceInUrls(re,urls[0]))){return result
}re=new RegExp(body);if((result=findSourceInUrls(re,urls))){return result}}return null}function computeStackTraceFromStackProp(ex){if(!ex.stack){return null
}var chrome=/^\s*at (?:((?:\[object object\])?\S+) )?\(?((?:file|http|https):.*?):(\d+)(?::(\d+))?\)?\s*$/i,gecko=/^\s*(\S*)(?:\((.*?)\))?@((?:file|http|https).*?):(\d+)(?::(\d+))?\s*$/i,lines=ex.stack.split("\n"),stack=[],parts,element,reference=/^(.*) is undefined$/.exec(ex.message);
for(var i=0,j=lines.length;i<j;++i){if((parts=gecko.exec(lines[i]))){element={"url":parts[3],"func":parts[1]||UNKNOWN_FUNCTION,"args":parts[2]?parts[2].split(","):"","line":+parts[4],"column":parts[5]?+parts[5]:null}
}else{if((parts=chrome.exec(lines[i]))){element={"url":parts[2],"func":parts[1]||UNKNOWN_FUNCTION,"line":+parts[3],"column":parts[4]?+parts[4]:null}
}else{continue}}if(!element.func&&element.line){element.func=guessFunctionName(element.url,element.line)
}if(element.line){element.context=gatherContext(element.url,element.line)}stack.push(element)}if(stack[0]&&stack[0].line&&!stack[0].column&&reference){stack[0].column=findSourceInLine(reference[1],stack[0].url,stack[0].line)
}if(!stack.length){return null}return{"mode":"stack","name":ex.name,"message":ex.message,"url":document.location.href,"stack":stack,"useragent":navigator.userAgent}
}function computeStackTraceFromStacktraceProp(ex){var stacktrace=ex.stacktrace;var testRE=/ line (\d+), column (\d+) in (?:<anonymous function: ([^>]+)>|([^\)]+))\((.*)\) in (.*):\s*$/i,lines=stacktrace.split("\n"),stack=[],parts;
for(var i=0,j=lines.length;i<j;i+=2){if((parts=testRE.exec(lines[i]))){var element={"line":+parts[1],"column":+parts[2],"func":parts[3]||parts[4],"args":parts[5]?parts[5].split(","):[],"url":parts[6]};
if(!element.func&&element.line){element.func=guessFunctionName(element.url,element.line)}if(element.line){try{element.context=gatherContext(element.url,element.line)
}catch(exc){}}if(!element.context){element.context=[lines[i+1]]}stack.push(element)}}if(!stack.length){return null
}return{"mode":"stacktrace","name":ex.name,"message":ex.message,"url":document.location.href,"stack":stack,"useragent":navigator.userAgent}
}function computeStackTraceFromOperaMultiLineMessage(ex){var lines=ex.message.split("\n");if(lines.length<4){return null
}var lineRE1=/^\s*Line (\d+) of linked script ((?:file|http|https)\S+)(?:: in function (\S+))?\s*$/i,lineRE2=/^\s*Line (\d+) of inline#(\d+) script in ((?:file|http|https)\S+)(?:: in function (\S+))?\s*$/i,lineRE3=/^\s*Line (\d+) of function script\s*$/i,stack=[],scripts=document.getElementsByTagName("script"),inlineScriptBlocks=[],parts,i,len,source;
for(i in scripts){if(_has(scripts,i)&&!scripts[i].src){inlineScriptBlocks.push(scripts[i])}}for(i=2,len=lines.length;
i<len;i+=2){var item=null;if((parts=lineRE1.exec(lines[i]))){item={"url":parts[2],"func":parts[3],"line":+parts[1]}
}else{if((parts=lineRE2.exec(lines[i]))){item={"url":parts[3],"func":parts[4]};var relativeLine=(+parts[1]);
var script=inlineScriptBlocks[parts[2]-1];if(script){source=getSource(item.url);if(source){source=source.join("\n");
var pos=source.indexOf(script.innerText);if(pos>=0){item.line=relativeLine+source.substring(0,pos).split("\n").length
}}}}else{if((parts=lineRE3.exec(lines[i]))){var url=window.location.href.replace(/#.*$/,""),line=parts[1];
var re=new RegExp(escapeCodeAsRegExpForMatchingInsideHTML(lines[i+1]));source=findSourceInUrls(re,[url]);
item={"url":url,"line":source?source.line:line,"func":""}}}}if(item){if(!item.func){item.func=guessFunctionName(item.url,item.line)
}var context=gatherContext(item.url,item.line);var midline=(context?context[Math.floor(context.length/2)]:null);
if(context&&midline.replace(/^\s*/,"")===lines[i+1].replace(/^\s*/,"")){item.context=context}else{item.context=[lines[i+1]]
}stack.push(item)}}if(!stack.length){return null}return{"mode":"multiline","name":ex.name,"message":lines[0],"url":document.location.href,"stack":stack,"useragent":navigator.userAgent}
}function augmentStackTraceWithInitialElement(stackInfo,url,lineNo,message){var initial={"url":url,"line":lineNo};
if(initial.url&&initial.line){stackInfo.incomplete=false;if(!initial.func){initial.func=guessFunctionName(initial.url,initial.line)
}if(!initial.context){initial.context=gatherContext(initial.url,initial.line)}var reference=/ '([^']+)' /.exec(message);
if(reference){initial.column=findSourceInLine(reference[1],initial.url,initial.line)}if(stackInfo.stack.length>0){if(stackInfo.stack[0].url===initial.url){if(stackInfo.stack[0].line===initial.line){return false
}else{if(!stackInfo.stack[0].line&&stackInfo.stack[0].func===initial.func){stackInfo.stack[0].line=initial.line;
stackInfo.stack[0].context=initial.context;return false}}}}stackInfo.stack.unshift(initial);stackInfo.partial=true;
return true}else{stackInfo.incomplete=true}return false}function computeStackTraceByWalkingCallerChain(ex,depth){var functionName=/function\s+([_$a-zA-Z\xA0-\uFFFF][_$a-zA-Z0-9\xA0-\uFFFF]*)?\s*\(/i,stack=[],funcs={},recursion=false,parts,item,source;
for(var curr=computeStackTraceByWalkingCallerChain.caller;curr&&!recursion;curr=curr.caller){if(curr===computeStackTrace||curr===TraceKit.report){continue
}item={"url":null,"func":UNKNOWN_FUNCTION,"line":null,"column":null};if(curr.name){item.func=curr.name
}else{if((parts=functionName.exec(curr.toString()))){item.func=parts[1]}}if((source=findSourceByFunctionBody(curr))){item.url=source.url;
item.line=source.line;if(item.func===UNKNOWN_FUNCTION){item.func=guessFunctionName(item.url,item.line)
}var reference=/ '([^']+)' /.exec(ex.message||ex.description);if(reference){item.column=findSourceInLine(reference[1],source.url,source.line)
}}if(funcs[""+curr]){recursion=true}else{funcs[""+curr]=true}stack.push(item)}if(depth){stack.splice(0,depth)
}var result={"mode":"callers","name":ex.name,"message":ex.message,"url":document.location.href,"stack":stack,"useragent":navigator.userAgent};
augmentStackTraceWithInitialElement(result,ex.sourceURL||ex.fileName,ex.line||ex.lineNumber,ex.message||ex.description);
return result}function computeStackTrace(ex,depth){var stack=null;depth=(depth==null?0:+depth);try{stack=computeStackTraceFromStacktraceProp(ex);
if(stack){return stack}}catch(e){if(debug){throw e}}try{stack=computeStackTraceFromStackProp(ex);if(stack){return stack
}}catch(e){if(debug){throw e}}try{stack=computeStackTraceFromOperaMultiLineMessage(ex);if(stack){return stack
}}catch(e){if(debug){throw e}}try{stack=computeStackTraceByWalkingCallerChain(ex,depth+1);if(stack){return stack
}}catch(e){if(debug){throw e}}return{"mode":"failed"}}function computeStackTraceOfCaller(depth){depth=(depth==null?0:+depth)+1;
try{throw new Error()}catch(ex){return computeStackTrace(ex,depth+1)}return null}computeStackTrace.augmentStackTraceWithInitialElement=augmentStackTraceWithInitialElement;
computeStackTrace.guessFunctionName=guessFunctionName;computeStackTrace.gatherContext=gatherContext;computeStackTrace.ofCaller=computeStackTraceOfCaller;
return computeStackTrace}());(function extendToAsynchronousCallbacks(){var _helper=function _helper(fnName){var originalFn=window[fnName];
window[fnName]=function traceKitAsyncExtension(){var args=_slice.call(arguments);var originalCallback=args[0];
if(typeof(originalCallback)==="function"){args[0]=TraceKit.wrap(originalCallback)}if(originalFn.apply){return originalFn.apply(this,args)
}else{return originalFn(args[0],args[1])}}};_helper("setTimeout");_helper("setInterval")}());if(!TraceKit.remoteFetching){TraceKit.remoteFetching=true
}if(!TraceKit.collectWindowErrors){TraceKit.collectWindowErrors=true}if(!TraceKit.linesOfContext||TraceKit.linesOfContext<1){TraceKit.linesOfContext=11
}window.TraceKit=TraceKit}(window));window.Modernizr=function(a,b,c){function B(a){j.cssText=a}function C(a,b){return B(n.join(a+";")+(b||""))
}function D(a,b){return typeof a===b}function E(a,b){return !!~(""+a).indexOf(b)}function F(a,b){for(var d in a){if(j[a[d]]!==c){return b=="pfx"?a[d]:!0
}}return !1}function G(a,b,d){for(var e in a){var f=b[a[e]];if(f!==c){return d===!1?a[e]:D(f,"function")?f.bind(d||b):f
}}return !1}function H(a,b,c){var d=a.charAt(0).toUpperCase()+a.substr(1),e=(a+" "+p.join(d+" ")+d).split(" ");
return D(b,"string")||D(b,"undefined")?F(e,b):(e=(a+" "+q.join(d+" ")+d).split(" "),G(e,b,c))}var d="2.5.3",e={},f=!0,g=b.documentElement,h="modernizr",i=b.createElement(h),j=i.style,k,l=":)",m={}.toString,n=" -webkit- -moz- -o- -ms- ".split(" "),o="Webkit Moz O ms",p=o.split(" "),q=o.toLowerCase().split(" "),r={},s={},t={},u=[],v=u.slice,w,x=function(a,c,d,e){var f,i,j,k=b.createElement("div"),l=b.body,m=l?l:b.createElement("body");
if(parseInt(d,10)){while(d--){j=b.createElement("div"),j.id=e?e[d]:h+(d+1),k.appendChild(j)}}return f=["&#173;","<style>",a,"</style>"].join(""),k.id=h,(l?k:m).innerHTML+=f,m.appendChild(k),l||(m.style.background="",g.appendChild(m)),i=c(k,a),l?k.parentNode.removeChild(k):m.parentNode.removeChild(m),!!i
},y=function(){function d(d,e){e=e||b.createElement(a[d]||"div"),d="on"+d;var f=d in e;return f||(e.setAttribute||(e=b.createElement("div")),e.setAttribute&&e.removeAttribute&&(e.setAttribute(d,""),f=D(e[d],"function"),D(e[d],"undefined")||(e[d]=c),e.removeAttribute(d))),e=null,f
}var a={select:"input",change:"input",submit:"form",reset:"form",error:"img",load:"img",abort:"img"};
return d}(),z={}.hasOwnProperty,A;!D(z,"undefined")&&!D(z.call,"undefined")?A=function(a,b){return z.call(a,b)
}:A=function(a,b){return b in a&&D(a.constructor.prototype[b],"undefined")},Function.prototype.bind||(Function.prototype.bind=function(b){var c=this;
if(typeof c!="function"){throw new TypeError}var d=v.call(arguments,1),e=function(){if(this instanceof e){var a=function(){};
a.prototype=c.prototype;var f=new a,g=c.apply(f,d.concat(v.call(arguments)));return Object(g)===g?g:f
}return c.apply(b,d.concat(v.call(arguments)))};return e});var I=function(a,c){var d=a.join(""),f=c.length;
x(d,function(a,c){var d=b.styleSheets[b.styleSheets.length-1],g=d?d.cssRules&&d.cssRules[0]?d.cssRules[0].cssText:d.cssText||"":"",h=a.childNodes,i={};
while(f--){i[h[f].id]=h[f]}e.csstransforms3d=(i.csstransforms3d&&i.csstransforms3d.offsetLeft)===9&&i.csstransforms3d.offsetHeight===3,e.generatedcontent=(i.generatedcontent&&i.generatedcontent.offsetHeight)>=1,e.fontface=/src/i.test(g)&&g.indexOf(c.split(" ")[0])===0
},f,c)}(['@font-face {font-family:"font";src:url("https://")}',["@media (",n.join("transform-3d),("),h,")","{#csstransforms3d{left:9px;position:absolute;height:3px;}}"].join(""),['#generatedcontent:after{content:"',l,'";visibility:hidden}'].join("")],["fontface","csstransforms3d","generatedcontent"]);
r.canvas=function(){var a=b.createElement("canvas");return !!a.getContext&&!!a.getContext("2d")},r.canvastext=function(){return !!e.canvas&&!!D(b.createElement("canvas").getContext("2d").fillText,"function")
},r.postmessage=function(){return !!a.postMessage},r.hashchange=function(){return y("hashchange",a)&&(b.documentMode===c||b.documentMode>7)
},r.history=function(){return !!a.history&&!!history.pushState},r.draganddrop=function(){var a=b.createElement("div");
return"draggable" in a||"ondragstart" in a&&"ondrop" in a},r.websockets=function(){for(var b=-1,c=p.length;
++b<c;){if(a[p[b]+"WebSocket"]){return !0}}return"WebSocket" in a},r.rgba=function(){return B("background-color:rgba(150,255,150,.5)"),E(j.backgroundColor,"rgba")
},r.borderradius=function(){return H("borderRadius")},r.boxshadow=function(){return H("boxShadow")},r.textshadow=function(){return b.createElement("div").style.textShadow===""
},r.opacity=function(){return C("opacity:.55"),/^0.55$/.test(j.opacity)},r.cssanimations=function(){return H("animationName")
},r.cssgradients=function(){var a="background-image:",b="gradient(linear,left top,right bottom,from(#9f9),to(white));",c="linear-gradient(left top,#9f9, white);";
return B((a+"-webkit- ".split(" ").join(b+a)+n.join(c+a)).slice(0,-a.length)),E(j.backgroundImage,"gradient")
},r.csstransforms=function(){return !!H("transform")},r.csstransforms3d=function(){var a=!!H("perspective");
return a&&"webkitPerspective" in g.style&&(a=e.csstransforms3d),a},r.csstransitions=function(){return H("transition")
},r.fontface=function(){return e.fontface},r.generatedcontent=function(){return e.generatedcontent},r.video=function(){var a=b.createElement("video"),c=!1;
try{if(c=!!a.canPlayType){c=new Boolean(c),c.ogg=a.canPlayType('video/ogg; codecs="theora"').replace(/^no$/,""),c.h264=a.canPlayType('video/mp4; codecs="avc1.42E01E"').replace(/^no$/,""),c.webm=a.canPlayType('video/webm; codecs="vp8, vorbis"').replace(/^no$/,"")
}}catch(d){}return c},r.audio=function(){var a=b.createElement("audio"),c=!1;try{if(c=!!a.canPlayType){c=new Boolean(c),c.ogg=a.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),c.mp3=a.canPlayType("audio/mpeg;").replace(/^no$/,""),c.wav=a.canPlayType('audio/wav; codecs="1"').replace(/^no$/,""),c.m4a=(a.canPlayType("audio/x-m4a;")||a.canPlayType("audio/aac;")).replace(/^no$/,"")
}}catch(d){}return c},r.localstorage=function(){try{return localStorage.setItem(h,h),localStorage.removeItem(h),!0
}catch(a){return !1}},r.sessionstorage=function(){try{return sessionStorage.setItem(h,h),sessionStorage.removeItem(h),!0
}catch(a){return !1}},r.applicationcache=function(){return !!a.applicationCache};for(var J in r){A(r,J)&&(w=J.toLowerCase(),e[w]=r[J](),u.push((e[w]?"":"no-")+w))
}return e.addTest=function(a,b){if(typeof a=="object"){for(var d in a){A(a,d)&&e.addTest(d,a[d])}}else{a=a.toLowerCase();
if(e[a]!==c){return e}b=typeof b=="function"?b():b,g.className+=" "+(b?"":"no-")+a,e[a]=b}return e},B(""),i=k=null,e._version=d,e._prefixes=n,e._domPrefixes=q,e._cssomPrefixes=p,e.hasEvent=y,e.testProp=function(a){return F([a])
},e.testAllProps=H,e.testStyles=x,e.prefixed=function(a,b,c){return b?H(a,b,c):H(a,"pfx")},g.className=g.className.replace(/(^|\s)no-js(\s|$)/,"$1$2")+(f?" js "+u.join(" "):""),e
}(this,this.document);Modernizr.addTest("osmac",function(){if(!navigator||!navigator.appVersion){return false
}return(navigator.appVersion.indexOf("Mac")!=-1)});Modernizr.addTest("browser-ie",function(){if(!navigator||!navigator.appVersion){return false
}return(navigator.appVersion.toLowerCase().indexOf("msie")!=-1)});Modernizr.addTest("ipad",function(){return !!navigator.userAgent.match(/iPad/i)
});Modernizr.addTest("iphone",function(){return !!navigator.userAgent.match(/iPhone/i)});Modernizr.addTest("ipod",function(){return !!navigator.userAgent.match(/iPod/i)
});Modernizr.addTest("appleios",function(){return(Modernizr.ipad||Modernizr.ipod||Modernizr.iphone)});
if(typeof JSON!=="object"){JSON={}}(function(){function f(n){return n<10?"0"+n:n}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null
};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()
}}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;
function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];
return typeof c==="string"?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'
}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==="object"&&typeof value.toJSON==="function"){value=value.toJSON(key)
}if(typeof rep==="function"){value=rep.call(holder,key,value)}switch(typeof value){case"string":return quote(value);
case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);
case"object":if(!value){return"null"}gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==="[object Array]"){length=value.length;
for(i=0;i<length;i+=1){partial[i]=str(i,value)||"null"}v=partial.length===0?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]";
gap=mind;return v}if(rep&&typeof rep==="object"){length=rep.length;for(i=0;i<length;i+=1){if(typeof rep[i]==="string"){k=rep[i];
v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}else{for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=str(k,value);
if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}v=partial.length===0?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}";
gap=mind;return v}}if(typeof JSON.stringify!=="function"){JSON.stringify=function(value,replacer,space){var i;
gap="";indent="";if(typeof space==="number"){for(i=0;i<space;i+=1){indent+=" "}}else{if(typeof space==="string"){indent=space
}}rep=replacer;if(replacer&&typeof replacer!=="function"&&(typeof replacer!=="object"||typeof replacer.length!=="number")){throw new Error("JSON.stringify")
}return str("",{"":value})}}if(typeof JSON.parse!=="function"){JSON.parse=function(text,reviver){var j;
function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==="object"){for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=walk(value,k);
if(v!==undefined){value[k]=v}else{delete value[k]}}}}return reviver.call(holder,key,value)}text=String(text);
cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)
})}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");
return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")}}}());
/*! jQuery v1.7.2 jquery.com | jquery.org/license */
(function(a,b){function cy(a){return f.isWindow(a)?a:a.nodeType===9?a.defaultView||a.parentWindow:!1
}function cu(a){if(!cj[a]){var b=c.body,d=f("<"+a+">").appendTo(b),e=d.css("display");d.remove();if(e==="none"||e===""){ck||(ck=c.createElement("iframe"),ck.frameBorder=ck.width=ck.height=0),b.appendChild(ck);
if(!cl||!ck.createElement){cl=(ck.contentWindow||ck.contentDocument).document,cl.write((f.support.boxModel?"<!doctype html>":"")+"<html><body>"),cl.close()
}d=cl.createElement(a),cl.body.appendChild(d),e=f.css(d,"display"),b.removeChild(ck)}cj[a]=e}return cj[a]
}function ct(a,b){var c={};f.each(cp.concat.apply([],cp.slice(0,b)),function(){c[this]=a});return c}function cs(){cq=b
}function cr(){setTimeout(cs,0);return cq=f.now()}function ci(){try{return new a.ActiveXObject("Microsoft.XMLHTTP")
}catch(b){}}function ch(){try{return new a.XMLHttpRequest}catch(b){}}function cb(a,c){a.dataFilter&&(c=a.dataFilter(c,a.dataType));
var d=a.dataTypes,e={},g,h,i=d.length,j,k=d[0],l,m,n,o,p;for(g=1;g<i;g++){if(g===1){for(h in a.converters){typeof h=="string"&&(e[h.toLowerCase()]=a.converters[h])
}}l=k,k=d[g];if(k==="*"){k=l}else{if(l!=="*"&&l!==k){m=l+" "+k,n=e[m]||e["* "+k];if(!n){p=b;for(o in e){j=o.split(" ");
if(j[0]===l||j[0]==="*"){p=e[j[1]+" "+k];if(p){o=e[o],o===!0?n=p:p===!0&&(n=o);break}}}}!n&&!p&&f.error("No conversion from "+m.replace(" "," to ")),n!==!0&&(c=n?n(c):p(o(c)))
}}}return c}function ca(a,c,d){var e=a.contents,f=a.dataTypes,g=a.responseFields,h,i,j,k;for(i in g){i in d&&(c[g[i]]=d[i])
}while(f[0]==="*"){f.shift(),h===b&&(h=a.mimeType||c.getResponseHeader("content-type"))}if(h){for(i in e){if(e[i]&&e[i].test(h)){f.unshift(i);
break}}}if(f[0] in d){j=f[0]}else{for(i in d){if(!f[0]||a.converters[i+" "+f[0]]){j=i;break}k||(k=i)}j=j||k
}if(j){j!==f[0]&&f.unshift(j);return d[j]}}function b_(a,b,c,d){if(f.isArray(b)){f.each(b,function(b,e){c||bD.test(a)?d(a,e):b_(a+"["+(typeof e=="object"?b:"")+"]",e,c,d)
})}else{if(!c&&f.type(b)==="object"){for(var e in b){b_(a+"["+e+"]",b[e],c,d)}}else{d(a,b)}}}function b$(a,c){var d,e,g=f.ajaxSettings.flatOptions||{};
for(d in c){c[d]!==b&&((g[d]?a:e||(e={}))[d]=c[d])}e&&f.extend(!0,a,e)}function bZ(a,c,d,e,f,g){f=f||c.dataTypes[0],g=g||{},g[f]=!0;
var h=a[f],i=0,j=h?h.length:0,k=a===bS,l;for(;i<j&&(k||!l);i++){l=h[i](c,d,e),typeof l=="string"&&(!k||g[l]?l=b:(c.dataTypes.unshift(l),l=bZ(a,c,d,e,l,g)))
}(k||!l)&&!g["*"]&&(l=bZ(a,c,d,e,"*",g));return l}function bY(a){return function(b,c){typeof b!="string"&&(c=b,b="*");
if(f.isFunction(c)){var d=b.toLowerCase().split(bO),e=0,g=d.length,h,i,j;for(;e<g;e++){h=d[e],j=/^\+/.test(h),j&&(h=h.substr(1)||"*"),i=a[h]=a[h]||[],i[j?"unshift":"push"](c)
}}}}function bB(a,b,c){var d=b==="width"?a.offsetWidth:a.offsetHeight,e=b==="width"?1:0,g=4;if(d>0){if(c!=="border"){for(;
e<g;e+=2){c||(d-=parseFloat(f.css(a,"padding"+bx[e]))||0),c==="margin"?d+=parseFloat(f.css(a,c+bx[e]))||0:d-=parseFloat(f.css(a,"border"+bx[e]+"Width"))||0
}}return d+"px"}d=by(a,b);if(d<0||d==null){d=a.style[b]}if(bt.test(d)){return d}d=parseFloat(d)||0;if(c){for(;
e<g;e+=2){d+=parseFloat(f.css(a,"padding"+bx[e]))||0,c!=="padding"&&(d+=parseFloat(f.css(a,"border"+bx[e]+"Width"))||0),c==="margin"&&(d+=parseFloat(f.css(a,c+bx[e]))||0)
}}return d+"px"}function bo(a){var b=c.createElement("div");bh.appendChild(b),b.innerHTML=a.outerHTML;
return b.firstChild}function bn(a){var b=(a.nodeName||"").toLowerCase();b==="input"?bm(a):b!=="script"&&typeof a.getElementsByTagName!="undefined"&&f.grep(a.getElementsByTagName("input"),bm)
}function bm(a){if(a.type==="checkbox"||a.type==="radio"){a.defaultChecked=a.checked}}function bl(a){return typeof a.getElementsByTagName!="undefined"?a.getElementsByTagName("*"):typeof a.querySelectorAll!="undefined"?a.querySelectorAll("*"):[]
}function bk(a,b){var c;b.nodeType===1&&(b.clearAttributes&&b.clearAttributes(),b.mergeAttributes&&b.mergeAttributes(a),c=b.nodeName.toLowerCase(),c==="object"?b.outerHTML=a.outerHTML:c!=="input"||a.type!=="checkbox"&&a.type!=="radio"?c==="option"?b.selected=a.defaultSelected:c==="input"||c==="textarea"?b.defaultValue=a.defaultValue:c==="script"&&b.text!==a.text&&(b.text=a.text):(a.checked&&(b.defaultChecked=b.checked=a.checked),b.value!==a.value&&(b.value=a.value)),b.removeAttribute(f.expando),b.removeAttribute("_submit_attached"),b.removeAttribute("_change_attached"))
}function bj(a,b){if(b.nodeType===1&&!!f.hasData(a)){var c,d,e,g=f._data(a),h=f._data(b,g),i=g.events;
if(i){delete h.handle,h.events={};for(c in i){for(d=0,e=i[c].length;d<e;d++){f.event.add(b,c,i[c][d])
}}}h.data&&(h.data=f.extend({},h.data))}}function bi(a,b){return f.nodeName(a,"table")?a.getElementsByTagName("tbody")[0]||a.appendChild(a.ownerDocument.createElement("tbody")):a
}function U(a){var b=V.split("|"),c=a.createDocumentFragment();if(c.createElement){while(b.length){c.createElement(b.pop())
}}return c}function T(a,b,c){b=b||0;if(f.isFunction(b)){return f.grep(a,function(a,d){var e=!!b.call(a,d,a);
return e===c})}if(b.nodeType){return f.grep(a,function(a,d){return a===b===c})}if(typeof b=="string"){var d=f.grep(a,function(a){return a.nodeType===1
});if(O.test(b)){return f.filter(b,d,!c)}b=f.filter(b,d)}return f.grep(a,function(a,d){return f.inArray(a,b)>=0===c
})}function S(a){return !a||!a.parentNode||a.parentNode.nodeType===11}function K(){return !0}function J(){return !1
}function n(a,b,c){var d=b+"defer",e=b+"queue",g=b+"mark",h=f._data(a,d);h&&(c==="queue"||!f._data(a,e))&&(c==="mark"||!f._data(a,g))&&setTimeout(function(){!f._data(a,e)&&!f._data(a,g)&&(f.removeData(a,d,!0),h.fire())
},0)}function m(a){for(var b in a){if(b==="data"&&f.isEmptyObject(a[b])){continue}if(b!=="toJSON"){return !1
}}return !0}function l(a,c,d){if(d===b&&a.nodeType===1){var e="data-"+c.replace(k,"-$1").toLowerCase();
d=a.getAttribute(e);if(typeof d=="string"){try{d=d==="true"?!0:d==="false"?!1:d==="null"?null:f.isNumeric(d)?+d:j.test(d)?f.parseJSON(d):d
}catch(g){}f.data(a,c,d)}else{d=b}}return d}function h(a){var b=g[a]={},c,d;a=a.split(/\s+/);for(c=0,d=a.length;
c<d;c++){b[a[c]]=!0}return b}var c=a.document,d=a.navigator,e=a.location,f=function(){function J(){if(!e.isReady){try{c.documentElement.doScroll("left")
}catch(a){setTimeout(J,1);return}e.ready()}}var e=function(a,b){return new e.fn.init(a,b,h)},f=a.jQuery,g=a.$,h,i=/^(?:[^#<]*(<[\w\W]+>)[^>]*$|#([\w\-]*)$)/,j=/\S/,k=/^\s+/,l=/\s+$/,m=/^<(\w+)\s*\/?>(?:<\/\1>)?$/,n=/^[\],:{}\s]*$/,o=/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,p=/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,q=/(?:^|:|,)(?:\s*\[)+/g,r=/(webkit)[ \/]([\w.]+)/,s=/(opera)(?:.*version)?[ \/]([\w.]+)/,t=/(msie) ([\w.]+)/,u=/(mozilla)(?:.*? rv:([\w.]+))?/,v=/-([a-z]|[0-9])/ig,w=/^-ms-/,x=function(a,b){return(b+"").toUpperCase()
},y=d.userAgent,z,A,B,C=Object.prototype.toString,D=Object.prototype.hasOwnProperty,E=Array.prototype.push,F=Array.prototype.slice,G=String.prototype.trim,H=Array.prototype.indexOf,I={};
e.fn=e.prototype={constructor:e,init:function(a,d,f){var g,h,j,k;if(!a){return this}if(a.nodeType){this.context=this[0]=a,this.length=1;
return this}if(a==="body"&&!d&&c.body){this.context=c,this[0]=c.body,this.selector=a,this.length=1;return this
}if(typeof a=="string"){a.charAt(0)!=="<"||a.charAt(a.length-1)!==">"||a.length<3?g=i.exec(a):g=[null,a,null];
if(g&&(g[1]||!d)){if(g[1]){d=d instanceof e?d[0]:d,k=d?d.ownerDocument||d:c,j=m.exec(a),j?e.isPlainObject(d)?(a=[c.createElement(j[1])],e.fn.attr.call(a,d,!0)):a=[k.createElement(j[1])]:(j=e.buildFragment([g[1]],[k]),a=(j.cacheable?e.clone(j.fragment):j.fragment).childNodes);
return e.merge(this,a)}h=c.getElementById(g[2]);if(h&&h.parentNode){if(h.id!==g[2]){return f.find(a)}this.length=1,this[0]=h
}this.context=c,this.selector=a;return this}return !d||d.jquery?(d||f).find(a):this.constructor(d).find(a)
}if(e.isFunction(a)){return f.ready(a)}a.selector!==b&&(this.selector=a.selector,this.context=a.context);
return e.makeArray(a,this)},selector:"",jquery:"1.7.2",length:0,size:function(){return this.length},toArray:function(){return F.call(this,0)
},get:function(a){return a==null?this.toArray():a<0?this[this.length+a]:this[a]},pushStack:function(a,b,c){var d=this.constructor();
e.isArray(a)?E.apply(d,a):e.merge(d,a),d.prevObject=this,d.context=this.context,b==="find"?d.selector=this.selector+(this.selector?" ":"")+c:b&&(d.selector=this.selector+"."+b+"("+c+")");
return d},each:function(a,b){return e.each(this,a,b)},ready:function(a){e.bindReady(),A.add(a);return this
},eq:function(a){a=+a;return a===-1?this.slice(a):this.slice(a,a+1)},first:function(){return this.eq(0)
},last:function(){return this.eq(-1)},slice:function(){return this.pushStack(F.apply(this,arguments),"slice",F.call(arguments).join(","))
},map:function(a){return this.pushStack(e.map(this,function(b,c){return a.call(b,c,b)}))},end:function(){return this.prevObject||this.constructor(null)
},push:E,sort:[].sort,splice:[].splice},e.fn.init.prototype=e.fn,e.extend=e.fn.extend=function(){var a,c,d,f,g,h,i=arguments[0]||{},j=1,k=arguments.length,l=!1;
typeof i=="boolean"&&(l=i,i=arguments[1]||{},j=2),typeof i!="object"&&!e.isFunction(i)&&(i={}),k===j&&(i=this,--j);
for(;j<k;j++){if((a=arguments[j])!=null){for(c in a){d=i[c],f=a[c];if(i===f){continue}l&&f&&(e.isPlainObject(f)||(g=e.isArray(f)))?(g?(g=!1,h=d&&e.isArray(d)?d:[]):h=d&&e.isPlainObject(d)?d:{},i[c]=e.extend(l,h,f)):f!==b&&(i[c]=f)
}}}return i},e.extend({noConflict:function(b){a.$===e&&(a.$=g),b&&a.jQuery===e&&(a.jQuery=f);return e
},isReady:!1,readyWait:1,holdReady:function(a){a?e.readyWait++:e.ready(!0)},ready:function(a){if(a===!0&&!--e.readyWait||a!==!0&&!e.isReady){if(!c.body){return setTimeout(e.ready,1)
}e.isReady=!0;if(a!==!0&&--e.readyWait>0){return}A.fireWith(c,[e]),e.fn.trigger&&e(c).trigger("ready").off("ready")
}},bindReady:function(){if(!A){A=e.Callbacks("once memory");if(c.readyState==="complete"){return setTimeout(e.ready,1)
}if(c.addEventListener){c.addEventListener("DOMContentLoaded",B,!1),a.addEventListener("load",e.ready,!1)
}else{if(c.attachEvent){c.attachEvent("onreadystatechange",B),a.attachEvent("onload",e.ready);var b=!1;
try{b=a.frameElement==null}catch(d){}c.documentElement.doScroll&&b&&J()}}}},isFunction:function(a){return e.type(a)==="function"
},isArray:Array.isArray||function(a){return e.type(a)==="array"},isWindow:function(a){return a!=null&&a==a.window
},isNumeric:function(a){return !isNaN(parseFloat(a))&&isFinite(a)},type:function(a){return a==null?String(a):I[C.call(a)]||"object"
},isPlainObject:function(a){if(!a||e.type(a)!=="object"||a.nodeType||e.isWindow(a)){return !1}try{if(a.constructor&&!D.call(a,"constructor")&&!D.call(a.constructor.prototype,"isPrototypeOf")){return !1
}}catch(c){return !1}var d;for(d in a){}return d===b||D.call(a,d)},isEmptyObject:function(a){for(var b in a){return !1
}return !0},error:function(a){throw new Error(a)},parseJSON:function(b){if(typeof b!="string"||!b){return null
}b=e.trim(b);if(a.JSON&&a.JSON.parse){return a.JSON.parse(b)}if(n.test(b.replace(o,"@").replace(p,"]").replace(q,""))){return(new Function("return "+b))()
}e.error("Invalid JSON: "+b)},parseXML:function(c){if(typeof c!="string"||!c){return null}var d,f;try{a.DOMParser?(f=new DOMParser,d=f.parseFromString(c,"text/xml")):(d=new ActiveXObject("Microsoft.XMLDOM"),d.async="false",d.loadXML(c))
}catch(g){d=b}(!d||!d.documentElement||d.getElementsByTagName("parsererror").length)&&e.error("Invalid XML: "+c);
return d},noop:function(){},globalEval:function(b){b&&j.test(b)&&(a.execScript||function(b){a.eval.call(a,b)
})(b)},camelCase:function(a){return a.replace(w,"ms-").replace(v,x)},nodeName:function(a,b){return a.nodeName&&a.nodeName.toUpperCase()===b.toUpperCase()
},each:function(a,c,d){var f,g=0,h=a.length,i=h===b||e.isFunction(a);if(d){if(i){for(f in a){if(c.apply(a[f],d)===!1){break
}}}else{for(;g<h;){if(c.apply(a[g++],d)===!1){break}}}}else{if(i){for(f in a){if(c.call(a[f],f,a[f])===!1){break
}}}else{for(;g<h;){if(c.call(a[g],g,a[g++])===!1){break}}}}return a},trim:G?function(a){return a==null?"":G.call(a)
}:function(a){return a==null?"":(a+"").replace(k,"").replace(l,"")},makeArray:function(a,b){var c=b||[];
if(a!=null){var d=e.type(a);a.length==null||d==="string"||d==="function"||d==="regexp"||e.isWindow(a)?E.call(c,a):e.merge(c,a)
}return c},inArray:function(a,b,c){var d;if(b){if(H){return H.call(b,a,c)}d=b.length,c=c?c<0?Math.max(0,d+c):c:0;
for(;c<d;c++){if(c in b&&b[c]===a){return c}}}return -1},merge:function(a,c){var d=a.length,e=0;if(typeof c.length=="number"){for(var f=c.length;
e<f;e++){a[d++]=c[e]}}else{while(c[e]!==b){a[d++]=c[e++]}}a.length=d;return a},grep:function(a,b,c){var d=[],e;
c=!!c;for(var f=0,g=a.length;f<g;f++){e=!!b(a[f],f),c!==e&&d.push(a[f])}return d},map:function(a,c,d){var f,g,h=[],i=0,j=a.length,k=a instanceof e||j!==b&&typeof j=="number"&&(j>0&&a[0]&&a[j-1]||j===0||e.isArray(a));
if(k){for(;i<j;i++){f=c(a[i],i,d),f!=null&&(h[h.length]=f)}}else{for(g in a){f=c(a[g],g,d),f!=null&&(h[h.length]=f)
}}return h.concat.apply([],h)},guid:1,proxy:function(a,c){if(typeof c=="string"){var d=a[c];c=a,a=d}if(!e.isFunction(a)){return b
}var f=F.call(arguments,2),g=function(){return a.apply(c,f.concat(F.call(arguments)))};g.guid=a.guid=a.guid||g.guid||e.guid++;
return g},access:function(a,c,d,f,g,h,i){var j,k=d==null,l=0,m=a.length;if(d&&typeof d=="object"){for(l in d){e.access(a,c,l,d[l],1,h,f)
}g=1}else{if(f!==b){j=i===b&&e.isFunction(f),k&&(j?(j=c,c=function(a,b,c){return j.call(e(a),c)}):(c.call(a,f),c=null));
if(c){for(;l<m;l++){c(a[l],d,j?f.call(a[l],l,c(a[l],d)):f,i)}}g=1}}return g?a:k?c.call(a):m?c(a[0],d):h
},now:function(){return(new Date).getTime()},uaMatch:function(a){a=a.toLowerCase();var b=r.exec(a)||s.exec(a)||t.exec(a)||a.indexOf("compatible")<0&&u.exec(a)||[];
return{browser:b[1]||"",version:b[2]||"0"}},sub:function(){function a(b,c){return new a.fn.init(b,c)}e.extend(!0,a,this),a.superclass=this,a.fn=a.prototype=this(),a.fn.constructor=a,a.sub=this.sub,a.fn.init=function(d,f){f&&f instanceof e&&!(f instanceof a)&&(f=a(f));
return e.fn.init.call(this,d,f,b)},a.fn.init.prototype=a.fn;var b=a(c);return a},browser:{}}),e.each("Boolean Number String Function Array Date RegExp Object".split(" "),function(a,b){I["[object "+b+"]"]=b.toLowerCase()
}),z=e.uaMatch(y),z.browser&&(e.browser[z.browser]=!0,e.browser.version=z.version),e.browser.webkit&&(e.browser.safari=!0),j.test("Â ")&&(k=/^[\s\xA0]+/,l=/[\s\xA0]+$/),h=e(c),c.addEventListener?B=function(){c.removeEventListener("DOMContentLoaded",B,!1),e.ready()
}:c.attachEvent&&(B=function(){c.readyState==="complete"&&(c.detachEvent("onreadystatechange",B),e.ready())
});return e}(),g={};f.Callbacks=function(a){a=a?g[a]||h(a):{};var c=[],d=[],e,i,j,k,l,m,n=function(b){var d,e,g,h,i;
for(d=0,e=b.length;d<e;d++){g=b[d],h=f.type(g),h==="array"?n(g):h==="function"&&(!a.unique||!p.has(g))&&c.push(g)
}},o=function(b,f){f=f||[],e=!a.memory||[b,f],i=!0,j=!0,m=k||0,k=0,l=c.length;for(;c&&m<l;m++){if(c[m].apply(b,f)===!1&&a.stopOnFalse){e=!0;
break}}j=!1,c&&(a.once?e===!0?p.disable():c=[]:d&&d.length&&(e=d.shift(),p.fireWith(e[0],e[1])))},p={add:function(){if(c){var a=c.length;
n(arguments),j?l=c.length:e&&e!==!0&&(k=a,o(e[0],e[1]))}return this},remove:function(){if(c){var b=arguments,d=0,e=b.length;
for(;d<e;d++){for(var f=0;f<c.length;f++){if(b[d]===c[f]){j&&f<=l&&(l--,f<=m&&m--),c.splice(f--,1);if(a.unique){break
}}}}}return this},has:function(a){if(c){var b=0,d=c.length;for(;b<d;b++){if(a===c[b]){return !0}}}return !1
},empty:function(){c=[];return this},disable:function(){c=d=e=b;return this},disabled:function(){return !c
},lock:function(){d=b,(!e||e===!0)&&p.disable();return this},locked:function(){return !d},fireWith:function(b,c){d&&(j?a.once||d.push([b,c]):(!a.once||!e)&&o(b,c));
return this},fire:function(){p.fireWith(this,arguments);return this},fired:function(){return !!i}};return p
};var i=[].slice;f.extend({Deferred:function(a){var b=f.Callbacks("once memory"),c=f.Callbacks("once memory"),d=f.Callbacks("memory"),e="pending",g={resolve:b,reject:c,notify:d},h={done:b.add,fail:c.add,progress:d.add,state:function(){return e
},isResolved:b.fired,isRejected:c.fired,then:function(a,b,c){i.done(a).fail(b).progress(c);return this
},always:function(){i.done.apply(i,arguments).fail.apply(i,arguments);return this},pipe:function(a,b,c){return f.Deferred(function(d){f.each({done:[a,"resolve"],fail:[b,"reject"],progress:[c,"notify"]},function(a,b){var c=b[0],e=b[1],g;
f.isFunction(c)?i[a](function(){g=c.apply(this,arguments),g&&f.isFunction(g.promise)?g.promise().then(d.resolve,d.reject,d.notify):d[e+"With"](this===i?d:this,[g])
}):i[a](d[e])})}).promise()},promise:function(a){if(a==null){a=h}else{for(var b in h){a[b]=h[b]}}return a
}},i=h.promise({}),j;for(j in g){i[j]=g[j].fire,i[j+"With"]=g[j].fireWith}i.done(function(){e="resolved"
},c.disable,d.lock).fail(function(){e="rejected"},b.disable,d.lock),a&&a.call(i,i);return i},when:function(a){function m(a){return function(b){e[a]=arguments.length>1?i.call(arguments,0):b,j.notifyWith(k,e)
}}function l(a){return function(c){b[a]=arguments.length>1?i.call(arguments,0):c,--g||j.resolveWith(j,b)
}}var b=i.call(arguments,0),c=0,d=b.length,e=Array(d),g=d,h=d,j=d<=1&&a&&f.isFunction(a.promise)?a:f.Deferred(),k=j.promise();
if(d>1){for(;c<d;c++){b[c]&&b[c].promise&&f.isFunction(b[c].promise)?b[c].promise().then(l(c),j.reject,m(c)):--g
}g||j.resolveWith(j,b)}else{j!==a&&j.resolveWith(j,d?[a]:[])}return k}}),f.support=function(){var b,d,e,g,h,i,j,k,l,m,n,o,p=c.createElement("div"),q=c.documentElement;
p.setAttribute("className","t"),p.innerHTML="   <link/><table></table><a href='/a' style='top:1px;float:left;opacity:.55;'>a</a><input type='checkbox'/>",d=p.getElementsByTagName("*"),e=p.getElementsByTagName("a")[0];
if(!d||!d.length||!e){return{}}g=c.createElement("select"),h=g.appendChild(c.createElement("option")),i=p.getElementsByTagName("input")[0],b={leadingWhitespace:p.firstChild.nodeType===3,tbody:!p.getElementsByTagName("tbody").length,htmlSerialize:!!p.getElementsByTagName("link").length,style:/top/.test(e.getAttribute("style")),hrefNormalized:e.getAttribute("href")==="/a",opacity:/^0.55/.test(e.style.opacity),cssFloat:!!e.style.cssFloat,checkOn:i.value==="on",optSelected:h.selected,getSetAttribute:p.className!=="t",enctype:!!c.createElement("form").enctype,html5Clone:c.createElement("nav").cloneNode(!0).outerHTML!=="<:nav></:nav>",submitBubbles:!0,changeBubbles:!0,focusinBubbles:!1,deleteExpando:!0,noCloneEvent:!0,inlineBlockNeedsLayout:!1,shrinkWrapBlocks:!1,reliableMarginRight:!0,pixelMargin:!0},f.boxModel=b.boxModel=c.compatMode==="CSS1Compat",i.checked=!0,b.noCloneChecked=i.cloneNode(!0).checked,g.disabled=!0,b.optDisabled=!h.disabled;
try{delete p.test}catch(r){b.deleteExpando=!1}!p.addEventListener&&p.attachEvent&&p.fireEvent&&(p.attachEvent("onclick",function(){b.noCloneEvent=!1
}),p.cloneNode(!0).fireEvent("onclick")),i=c.createElement("input"),i.value="t",i.setAttribute("type","radio"),b.radioValue=i.value==="t",i.setAttribute("checked","checked"),i.setAttribute("name","t"),p.appendChild(i),j=c.createDocumentFragment(),j.appendChild(p.lastChild),b.checkClone=j.cloneNode(!0).cloneNode(!0).lastChild.checked,b.appendChecked=i.checked,j.removeChild(i),j.appendChild(p);
if(p.attachEvent){for(n in {submit:1,change:1,focusin:1}){m="on"+n,o=m in p,o||(p.setAttribute(m,"return;"),o=typeof p[m]=="function"),b[n+"Bubbles"]=o
}}j.removeChild(p),j=g=h=p=i=null,f(function(){var d,e,g,h,i,j,l,m,n,q,r,s,t,u=c.getElementsByTagName("body")[0];
!u||(m=1,t="padding:0;margin:0;border:",r="position:absolute;top:0;left:0;width:1px;height:1px;",s=t+"0;visibility:hidden;",n="style='"+r+t+"5px solid #000;",q="<div "+n+"display:block;'><div style='"+t+"0;display:block;overflow:hidden;'></div></div>"+"<table "+n+"' cellpadding='0' cellspacing='0'>"+"<tr><td></td></tr></table>",d=c.createElement("div"),d.style.cssText=s+"width:0;height:0;position:static;top:0;margin-top:"+m+"px",u.insertBefore(d,u.firstChild),p=c.createElement("div"),d.appendChild(p),p.innerHTML="<table><tr><td style='"+t+"0;display:none'></td><td>t</td></tr></table>",k=p.getElementsByTagName("td"),o=k[0].offsetHeight===0,k[0].style.display="",k[1].style.display="none",b.reliableHiddenOffsets=o&&k[0].offsetHeight===0,a.getComputedStyle&&(p.innerHTML="",l=c.createElement("div"),l.style.width="0",l.style.marginRight="0",p.style.width="2px",p.appendChild(l),b.reliableMarginRight=(parseInt((a.getComputedStyle(l,null)||{marginRight:0}).marginRight,10)||0)===0),typeof p.style.zoom!="undefined"&&(p.innerHTML="",p.style.width=p.style.padding="1px",p.style.border=0,p.style.overflow="hidden",p.style.display="inline",p.style.zoom=1,b.inlineBlockNeedsLayout=p.offsetWidth===3,p.style.display="block",p.style.overflow="visible",p.innerHTML="<div style='width:5px;'></div>",b.shrinkWrapBlocks=p.offsetWidth!==3),p.style.cssText=r+s,p.innerHTML=q,e=p.firstChild,g=e.firstChild,i=e.nextSibling.firstChild.firstChild,j={doesNotAddBorder:g.offsetTop!==5,doesAddBorderForTableAndCells:i.offsetTop===5},g.style.position="fixed",g.style.top="20px",j.fixedPosition=g.offsetTop===20||g.offsetTop===15,g.style.position=g.style.top="",e.style.overflow="hidden",e.style.position="relative",j.subtractsBorderForOverflowNotVisible=g.offsetTop===-5,j.doesNotIncludeMarginInBodyOffset=u.offsetTop!==m,a.getComputedStyle&&(p.style.marginTop="1%",b.pixelMargin=(a.getComputedStyle(p,null)||{marginTop:0}).marginTop!=="1%"),typeof d.style.zoom!="undefined"&&(d.style.zoom=1),u.removeChild(d),l=p=d=null,f.extend(b,j))
});return b}();var j=/^(?:\{.*\}|\[.*\])$/,k=/([A-Z])/g;f.extend({cache:{},uuid:0,expando:"jQuery"+(f.fn.jquery+Math.random()).replace(/\D/g,""),noData:{embed:!0,object:"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000",applet:!0},hasData:function(a){a=a.nodeType?f.cache[a[f.expando]]:a[f.expando];
return !!a&&!m(a)},data:function(a,c,d,e){if(!!f.acceptData(a)){var g,h,i,j=f.expando,k=typeof c=="string",l=a.nodeType,m=l?f.cache:a,n=l?a[j]:a[j]&&j,o=c==="events";
if((!n||!m[n]||!o&&!e&&!m[n].data)&&k&&d===b){return}n||(l?a[j]=n=++f.uuid:n=j),m[n]||(m[n]={},l||(m[n].toJSON=f.noop));
if(typeof c=="object"||typeof c=="function"){e?m[n]=f.extend(m[n],c):m[n].data=f.extend(m[n].data,c)}g=h=m[n],e||(h.data||(h.data={}),h=h.data),d!==b&&(h[f.camelCase(c)]=d);
if(o&&!h[c]){return g.events}k?(i=h[c],i==null&&(i=h[f.camelCase(c)])):i=h;return i}},removeData:function(a,b,c){if(!!f.acceptData(a)){var d,e,g,h=f.expando,i=a.nodeType,j=i?f.cache:a,k=i?a[h]:h;
if(!j[k]){return}if(b){d=c?j[k]:j[k].data;if(d){f.isArray(b)||(b in d?b=[b]:(b=f.camelCase(b),b in d?b=[b]:b=b.split(" ")));
for(e=0,g=b.length;e<g;e++){delete d[b[e]]}if(!(c?m:f.isEmptyObject)(d)){return}}}if(!c){delete j[k].data;
if(!m(j[k])){return}}f.support.deleteExpando||!j.setInterval?delete j[k]:j[k]=null,i&&(f.support.deleteExpando?delete a[h]:a.removeAttribute?a.removeAttribute(h):a[h]=null)
}},_data:function(a,b,c){return f.data(a,b,c,!0)},acceptData:function(a){if(a.nodeName){var b=f.noData[a.nodeName.toLowerCase()];
if(b){return b!==!0&&a.getAttribute("classid")===b}}return !0}}),f.fn.extend({data:function(a,c){var d,e,g,h,i,j=this[0],k=0,m=null;
if(a===b){if(this.length){m=f.data(j);if(j.nodeType===1&&!f._data(j,"parsedAttrs")){g=j.attributes;for(i=g.length;
k<i;k++){h=g[k].name,h.indexOf("data-")===0&&(h=f.camelCase(h.substring(5)),l(j,h,m[h]))}f._data(j,"parsedAttrs",!0)
}}return m}if(typeof a=="object"){return this.each(function(){f.data(this,a)})}d=a.split(".",2),d[1]=d[1]?"."+d[1]:"",e=d[1]+"!";
return f.access(this,function(c){if(c===b){m=this.triggerHandler("getData"+e,[d[0]]),m===b&&j&&(m=f.data(j,a),m=l(j,a,m));
return m===b&&d[1]?this.data(d[0]):m}d[1]=c,this.each(function(){var b=f(this);b.triggerHandler("setData"+e,d),f.data(this,a,c),b.triggerHandler("changeData"+e,d)
})},null,c,arguments.length>1,null,!1)},removeData:function(a){return this.each(function(){f.removeData(this,a)
})}}),f.extend({_mark:function(a,b){a&&(b=(b||"fx")+"mark",f._data(a,b,(f._data(a,b)||0)+1))},_unmark:function(a,b,c){a!==!0&&(c=b,b=a,a=!1);
if(b){c=c||"fx";var d=c+"mark",e=a?0:(f._data(b,d)||1)-1;e?f._data(b,d,e):(f.removeData(b,d,!0),n(b,c,"mark"))
}},queue:function(a,b,c){var d;if(a){b=(b||"fx")+"queue",d=f._data(a,b),c&&(!d||f.isArray(c)?d=f._data(a,b,f.makeArray(c)):d.push(c));
return d||[]}},dequeue:function(a,b){b=b||"fx";var c=f.queue(a,b),d=c.shift(),e={};d==="inprogress"&&(d=c.shift()),d&&(b==="fx"&&c.unshift("inprogress"),f._data(a,b+".run",e),d.call(a,function(){f.dequeue(a,b)
},e)),c.length||(f.removeData(a,b+"queue "+b+".run",!0),n(a,b,"queue"))}}),f.fn.extend({queue:function(a,c){var d=2;
typeof a!="string"&&(c=a,a="fx",d--);if(arguments.length<d){return f.queue(this[0],a)}return c===b?this:this.each(function(){var b=f.queue(this,a,c);
a==="fx"&&b[0]!=="inprogress"&&f.dequeue(this,a)})},dequeue:function(a){return this.each(function(){f.dequeue(this,a)
})},delay:function(a,b){a=f.fx?f.fx.speeds[a]||a:a,b=b||"fx";return this.queue(b,function(b,c){var d=setTimeout(b,a);
c.stop=function(){clearTimeout(d)}})},clearQueue:function(a){return this.queue(a||"fx",[])},promise:function(a,c){function m(){--h||d.resolveWith(e,[e])
}typeof a!="string"&&(c=a,a=b),a=a||"fx";var d=f.Deferred(),e=this,g=e.length,h=1,i=a+"defer",j=a+"queue",k=a+"mark",l;
while(g--){if(l=f.data(e[g],i,b,!0)||(f.data(e[g],j,b,!0)||f.data(e[g],k,b,!0))&&f.data(e[g],i,f.Callbacks("once memory"),!0)){h++,l.add(m)
}}m();return d.promise(c)}});var o=/[\n\t\r]/g,p=/\s+/,q=/\r/g,r=/^(?:button|input)$/i,s=/^(?:button|input|object|select|textarea)$/i,t=/^a(?:rea)?$/i,u=/^(?:autofocus|autoplay|async|checked|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped|selected)$/i,v=f.support.getSetAttribute,w,x,y;
f.fn.extend({attr:function(a,b){return f.access(this,f.attr,a,b,arguments.length>1)},removeAttr:function(a){return this.each(function(){f.removeAttr(this,a)
})},prop:function(a,b){return f.access(this,f.prop,a,b,arguments.length>1)},removeProp:function(a){a=f.propFix[a]||a;
return this.each(function(){try{this[a]=b,delete this[a]}catch(c){}})},addClass:function(a){var b,c,d,e,g,h,i;
if(f.isFunction(a)){return this.each(function(b){f(this).addClass(a.call(this,b,this.className))})}if(a&&typeof a=="string"){b=a.split(p);
for(c=0,d=this.length;c<d;c++){e=this[c];if(e.nodeType===1){if(!e.className&&b.length===1){e.className=a
}else{g=" "+e.className+" ";for(h=0,i=b.length;h<i;h++){~g.indexOf(" "+b[h]+" ")||(g+=b[h]+" ")}e.className=f.trim(g)
}}}}return this},removeClass:function(a){var c,d,e,g,h,i,j;if(f.isFunction(a)){return this.each(function(b){f(this).removeClass(a.call(this,b,this.className))
})}if(a&&typeof a=="string"||a===b){c=(a||"").split(p);for(d=0,e=this.length;d<e;d++){g=this[d];if(g.nodeType===1&&g.className){if(a){h=(" "+g.className+" ").replace(o," ");
for(i=0,j=c.length;i<j;i++){h=h.replace(" "+c[i]+" "," ")}g.className=f.trim(h)}else{g.className=""}}}}return this
},toggleClass:function(a,b){var c=typeof a,d=typeof b=="boolean";if(f.isFunction(a)){return this.each(function(c){f(this).toggleClass(a.call(this,c,this.className,b),b)
})}return this.each(function(){if(c==="string"){var e,g=0,h=f(this),i=b,j=a.split(p);while(e=j[g++]){i=d?i:!h.hasClass(e),h[i?"addClass":"removeClass"](e)
}}else{if(c==="undefined"||c==="boolean"){this.className&&f._data(this,"__className__",this.className),this.className=this.className||a===!1?"":f._data(this,"__className__")||""
}}})},hasClass:function(a){var b=" "+a+" ",c=0,d=this.length;for(;c<d;c++){if(this[c].nodeType===1&&(" "+this[c].className+" ").replace(o," ").indexOf(b)>-1){return !0
}}return !1},val:function(a){var c,d,e,g=this[0];if(!!arguments.length){e=f.isFunction(a);return this.each(function(d){var g=f(this),h;
if(this.nodeType===1){e?h=a.call(this,d,g.val()):h=a,h==null?h="":typeof h=="number"?h+="":f.isArray(h)&&(h=f.map(h,function(a){return a==null?"":a+""
})),c=f.valHooks[this.type]||f.valHooks[this.nodeName.toLowerCase()];if(!c||!("set" in c)||c.set(this,h,"value")===b){this.value=h
}}})}if(g){c=f.valHooks[g.type]||f.valHooks[g.nodeName.toLowerCase()];if(c&&"get" in c&&(d=c.get(g,"value"))!==b){return d
}d=g.value;return typeof d=="string"?d.replace(q,""):d==null?"":d}}}),f.extend({valHooks:{option:{get:function(a){var b=a.attributes.value;
return !b||b.specified?a.value:a.text}},select:{get:function(a){var b,c,d,e,g=a.selectedIndex,h=[],i=a.options,j=a.type==="select-one";
if(g<0){return null}c=j?g:0,d=j?g+1:i.length;for(;c<d;c++){e=i[c];if(e.selected&&(f.support.optDisabled?!e.disabled:e.getAttribute("disabled")===null)&&(!e.parentNode.disabled||!f.nodeName(e.parentNode,"optgroup"))){b=f(e).val();
if(j){return b}h.push(b)}}if(j&&!h.length&&i.length){return f(i[g]).val()}return h},set:function(a,b){var c=f.makeArray(b);
f(a).find("option").each(function(){this.selected=f.inArray(f(this).val(),c)>=0}),c.length||(a.selectedIndex=-1);
return c}}},attrFn:{val:!0,css:!0,html:!0,text:!0,data:!0,width:!0,height:!0,offset:!0},attr:function(a,c,d,e){var g,h,i,j=a.nodeType;
if(!!a&&j!==3&&j!==8&&j!==2){if(e&&c in f.attrFn){return f(a)[c](d)}if(typeof a.getAttribute=="undefined"){return f.prop(a,c,d)
}i=j!==1||!f.isXMLDoc(a),i&&(c=c.toLowerCase(),h=f.attrHooks[c]||(u.test(c)?x:w));if(d!==b){if(d===null){f.removeAttr(a,c);
return}if(h&&"set" in h&&i&&(g=h.set(a,d,c))!==b){return g}a.setAttribute(c,""+d);return d}if(h&&"get" in h&&i&&(g=h.get(a,c))!==null){return g
}g=a.getAttribute(c);return g===null?b:g}},removeAttr:function(a,b){var c,d,e,g,h,i=0;if(b&&a.nodeType===1){d=b.toLowerCase().split(p),g=d.length;
for(;i<g;i++){e=d[i],e&&(c=f.propFix[e]||e,h=u.test(e),h||f.attr(a,e,""),a.removeAttribute(v?e:c),h&&c in a&&(a[c]=!1))
}}},attrHooks:{type:{set:function(a,b){if(r.test(a.nodeName)&&a.parentNode){f.error("type property can't be changed")
}else{if(!f.support.radioValue&&b==="radio"&&f.nodeName(a,"input")){var c=a.value;a.setAttribute("type",b),c&&(a.value=c);
return b}}}},value:{get:function(a,b){if(w&&f.nodeName(a,"button")){return w.get(a,b)}return b in a?a.value:null
},set:function(a,b,c){if(w&&f.nodeName(a,"button")){return w.set(a,b,c)}a.value=b}}},propFix:{tabindex:"tabIndex",readonly:"readOnly","for":"htmlFor","class":"className",maxlength:"maxLength",cellspacing:"cellSpacing",cellpadding:"cellPadding",rowspan:"rowSpan",colspan:"colSpan",usemap:"useMap",frameborder:"frameBorder",contenteditable:"contentEditable"},prop:function(a,c,d){var e,g,h,i=a.nodeType;
if(!!a&&i!==3&&i!==8&&i!==2){h=i!==1||!f.isXMLDoc(a),h&&(c=f.propFix[c]||c,g=f.propHooks[c]);return d!==b?g&&"set" in g&&(e=g.set(a,d,c))!==b?e:a[c]=d:g&&"get" in g&&(e=g.get(a,c))!==null?e:a[c]
}},propHooks:{tabIndex:{get:function(a){var c=a.getAttributeNode("tabindex");return c&&c.specified?parseInt(c.value,10):s.test(a.nodeName)||t.test(a.nodeName)&&a.href?0:b
}}}}),f.attrHooks.tabindex=f.propHooks.tabIndex,x={get:function(a,c){var d,e=f.prop(a,c);return e===!0||typeof e!="boolean"&&(d=a.getAttributeNode(c))&&d.nodeValue!==!1?c.toLowerCase():b
},set:function(a,b,c){var d;b===!1?f.removeAttr(a,c):(d=f.propFix[c]||c,d in a&&(a[d]=!0),a.setAttribute(c,c.toLowerCase()));
return c}},v||(y={name:!0,id:!0,coords:!0},w=f.valHooks.button={get:function(a,c){var d;d=a.getAttributeNode(c);
return d&&(y[c]?d.nodeValue!=="":d.specified)?d.nodeValue:b},set:function(a,b,d){var e=a.getAttributeNode(d);
e||(e=c.createAttribute(d),a.setAttributeNode(e));return e.nodeValue=b+""}},f.attrHooks.tabindex.set=w.set,f.each(["width","height"],function(a,b){f.attrHooks[b]=f.extend(f.attrHooks[b],{set:function(a,c){if(c===""){a.setAttribute(b,"auto");
return c}}})}),f.attrHooks.contenteditable={get:w.get,set:function(a,b,c){b===""&&(b="false"),w.set(a,b,c)
}}),f.support.hrefNormalized||f.each(["href","src","width","height"],function(a,c){f.attrHooks[c]=f.extend(f.attrHooks[c],{get:function(a){var d=a.getAttribute(c,2);
return d===null?b:d}})}),f.support.style||(f.attrHooks.style={get:function(a){return a.style.cssText.toLowerCase()||b
},set:function(a,b){return a.style.cssText=""+b}}),f.support.optSelected||(f.propHooks.selected=f.extend(f.propHooks.selected,{get:function(a){var b=a.parentNode;
b&&(b.selectedIndex,b.parentNode&&b.parentNode.selectedIndex);return null}})),f.support.enctype||(f.propFix.enctype="encoding"),f.support.checkOn||f.each(["radio","checkbox"],function(){f.valHooks[this]={get:function(a){return a.getAttribute("value")===null?"on":a.value
}}}),f.each(["radio","checkbox"],function(){f.valHooks[this]=f.extend(f.valHooks[this],{set:function(a,b){if(f.isArray(b)){return a.checked=f.inArray(f(a).val(),b)>=0
}}})});var z=/^(?:textarea|input|select)$/i,A=/^([^\.]*)?(?:\.(.+))?$/,B=/(?:^|\s)hover(\.\S+)?\b/,C=/^key/,D=/^(?:mouse|contextmenu)|click/,E=/^(?:focusinfocus|focusoutblur)$/,F=/^(\w*)(?:#([\w\-]+))?(?:\.([\w\-]+))?$/,G=function(a){var b=F.exec(a);
b&&(b[1]=(b[1]||"").toLowerCase(),b[3]=b[3]&&new RegExp("(?:^|\\s)"+b[3]+"(?:\\s|$)"));return b},H=function(a,b){var c=a.attributes||{};
return(!b[1]||a.nodeName.toLowerCase()===b[1])&&(!b[2]||(c.id||{}).value===b[2])&&(!b[3]||b[3].test((c["class"]||{}).value))
},I=function(a){return f.event.special.hover?a:a.replace(B,"mouseenter$1 mouseleave$1")};f.event={add:function(a,c,d,e,g){var h,i,j,k,l,m,n,o,p,q,r,s;
if(!(a.nodeType===3||a.nodeType===8||!c||!d||!(h=f._data(a)))){d.handler&&(p=d,d=p.handler,g=p.selector),d.guid||(d.guid=f.guid++),j=h.events,j||(h.events=j={}),i=h.handle,i||(h.handle=i=function(a){return typeof f!="undefined"&&(!a||f.event.triggered!==a.type)?f.event.dispatch.apply(i.elem,arguments):b
},i.elem=a),c=f.trim(I(c)).split(" ");for(k=0;k<c.length;k++){l=A.exec(c[k])||[],m=l[1],n=(l[2]||"").split(".").sort(),s=f.event.special[m]||{},m=(g?s.delegateType:s.bindType)||m,s=f.event.special[m]||{},o=f.extend({type:m,origType:l[1],data:e,handler:d,guid:d.guid,selector:g,quick:g&&G(g),namespace:n.join(".")},p),r=j[m];
if(!r){r=j[m]=[],r.delegateCount=0;if(!s.setup||s.setup.call(a,e,n,i)===!1){a.addEventListener?a.addEventListener(m,i,!1):a.attachEvent&&a.attachEvent("on"+m,i)
}}s.add&&(s.add.call(a,o),o.handler.guid||(o.handler.guid=d.guid)),g?r.splice(r.delegateCount++,0,o):r.push(o),f.event.global[m]=!0
}a=null}},global:{},remove:function(a,b,c,d,e){var g=f.hasData(a)&&f._data(a),h,i,j,k,l,m,n,o,p,q,r,s;
if(!!g&&!!(o=g.events)){b=f.trim(I(b||"")).split(" ");for(h=0;h<b.length;h++){i=A.exec(b[h])||[],j=k=i[1],l=i[2];
if(!j){for(j in o){f.event.remove(a,j+b[h],c,d,!0)}continue}p=f.event.special[j]||{},j=(d?p.delegateType:p.bindType)||j,r=o[j]||[],m=r.length,l=l?new RegExp("(^|\\.)"+l.split(".").sort().join("\\.(?:.*\\.)?")+"(\\.|$)"):null;
for(n=0;n<r.length;n++){s=r[n],(e||k===s.origType)&&(!c||c.guid===s.guid)&&(!l||l.test(s.namespace))&&(!d||d===s.selector||d==="**"&&s.selector)&&(r.splice(n--,1),s.selector&&r.delegateCount--,p.remove&&p.remove.call(a,s))
}r.length===0&&m!==r.length&&((!p.teardown||p.teardown.call(a,l)===!1)&&f.removeEvent(a,j,g.handle),delete o[j])
}f.isEmptyObject(o)&&(q=g.handle,q&&(q.elem=null),f.removeData(a,["events","handle"],!0))}},customEvent:{getData:!0,setData:!0,changeData:!0},trigger:function(c,d,e,g){if(!e||e.nodeType!==3&&e.nodeType!==8){var h=c.type||c,i=[],j,k,l,m,n,o,p,q,r,s;
if(E.test(h+f.event.triggered)){return}h.indexOf("!")>=0&&(h=h.slice(0,-1),k=!0),h.indexOf(".")>=0&&(i=h.split("."),h=i.shift(),i.sort());
if((!e||f.event.customEvent[h])&&!f.event.global[h]){return}c=typeof c=="object"?c[f.expando]?c:new f.Event(h,c):new f.Event(h),c.type=h,c.isTrigger=!0,c.exclusive=k,c.namespace=i.join("."),c.namespace_re=c.namespace?new RegExp("(^|\\.)"+i.join("\\.(?:.*\\.)?")+"(\\.|$)"):null,o=h.indexOf(":")<0?"on"+h:"";
if(!e){j=f.cache;for(l in j){j[l].events&&j[l].events[h]&&f.event.trigger(c,d,j[l].handle.elem,!0)}return
}c.result=b,c.target||(c.target=e),d=d!=null?f.makeArray(d):[],d.unshift(c),p=f.event.special[h]||{};
if(p.trigger&&p.trigger.apply(e,d)===!1){return}r=[[e,p.bindType||h]];if(!g&&!p.noBubble&&!f.isWindow(e)){s=p.delegateType||h,m=E.test(s+h)?e:e.parentNode,n=null;
for(;m;m=m.parentNode){r.push([m,s]),n=m}n&&n===e.ownerDocument&&r.push([n.defaultView||n.parentWindow||a,s])
}for(l=0;l<r.length&&!c.isPropagationStopped();l++){m=r[l][0],c.type=r[l][1],q=(f._data(m,"events")||{})[c.type]&&f._data(m,"handle"),q&&q.apply(m,d),q=o&&m[o],q&&f.acceptData(m)&&q.apply(m,d)===!1&&c.preventDefault()
}c.type=h,!g&&!c.isDefaultPrevented()&&(!p._default||p._default.apply(e.ownerDocument,d)===!1)&&(h!=="click"||!f.nodeName(e,"a"))&&f.acceptData(e)&&o&&e[h]&&(h!=="focus"&&h!=="blur"||c.target.offsetWidth!==0)&&!f.isWindow(e)&&(n=e[o],n&&(e[o]=null),f.event.triggered=h,e[h](),f.event.triggered=b,n&&(e[o]=n));
return c.result}},dispatch:function(c){c=f.event.fix(c||a.event);var d=(f._data(this,"events")||{})[c.type]||[],e=d.delegateCount,g=[].slice.call(arguments,0),h=!c.exclusive&&!c.namespace,i=f.event.special[c.type]||{},j=[],k,l,m,n,o,p,q,r,s,t,u;
g[0]=c,c.delegateTarget=this;if(!i.preDispatch||i.preDispatch.call(this,c)!==!1){if(e&&(!c.button||c.type!=="click")){n=f(this),n.context=this.ownerDocument||this;
for(m=c.target;m!=this;m=m.parentNode||this){if(m.disabled!==!0){p={},r=[],n[0]=m;for(k=0;k<e;k++){s=d[k],t=s.selector,p[t]===b&&(p[t]=s.quick?H(m,s.quick):n.is(t)),p[t]&&r.push(s)
}r.length&&j.push({elem:m,matches:r})}}}d.length>e&&j.push({elem:this,matches:d.slice(e)});for(k=0;k<j.length&&!c.isPropagationStopped();
k++){q=j[k],c.currentTarget=q.elem;for(l=0;l<q.matches.length&&!c.isImmediatePropagationStopped();l++){s=q.matches[l];
if(h||!c.namespace&&!s.namespace||c.namespace_re&&c.namespace_re.test(s.namespace)){c.data=s.data,c.handleObj=s,o=((f.event.special[s.origType]||{}).handle||s.handler).apply(q.elem,g),o!==b&&(c.result=o,o===!1&&(c.preventDefault(),c.stopPropagation()))
}}}i.postDispatch&&i.postDispatch.call(this,c);return c.result}},props:"attrChange attrName relatedNode srcElement altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(a,b){a.which==null&&(a.which=b.charCode!=null?b.charCode:b.keyCode);
return a}},mouseHooks:{props:"button buttons clientX clientY fromElement offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(a,d){var e,f,g,h=d.button,i=d.fromElement;
a.pageX==null&&d.clientX!=null&&(e=a.target.ownerDocument||c,f=e.documentElement,g=e.body,a.pageX=d.clientX+(f&&f.scrollLeft||g&&g.scrollLeft||0)-(f&&f.clientLeft||g&&g.clientLeft||0),a.pageY=d.clientY+(f&&f.scrollTop||g&&g.scrollTop||0)-(f&&f.clientTop||g&&g.clientTop||0)),!a.relatedTarget&&i&&(a.relatedTarget=i===a.target?d.toElement:i),!a.which&&h!==b&&(a.which=h&1?1:h&2?3:h&4?2:0);
return a}},fix:function(a){if(a[f.expando]){return a}var d,e,g=a,h=f.event.fixHooks[a.type]||{},i=h.props?this.props.concat(h.props):this.props;
a=f.Event(g);for(d=i.length;d;){e=i[--d],a[e]=g[e]}a.target||(a.target=g.srcElement||c),a.target.nodeType===3&&(a.target=a.target.parentNode),a.metaKey===b&&(a.metaKey=a.ctrlKey);
return h.filter?h.filter(a,g):a},special:{ready:{setup:f.bindReady},load:{noBubble:!0},focus:{delegateType:"focusin"},blur:{delegateType:"focusout"},beforeunload:{setup:function(a,b,c){f.isWindow(this)&&(this.onbeforeunload=c)
},teardown:function(a,b){this.onbeforeunload===b&&(this.onbeforeunload=null)}}},simulate:function(a,b,c,d){var e=f.extend(new f.Event,c,{type:a,isSimulated:!0,originalEvent:{}});
d?f.event.trigger(e,null,b):f.event.dispatch.call(b,e),e.isDefaultPrevented()&&c.preventDefault()}},f.event.handle=f.event.dispatch,f.removeEvent=c.removeEventListener?function(a,b,c){a.removeEventListener&&a.removeEventListener(b,c,!1)
}:function(a,b,c){a.detachEvent&&a.detachEvent("on"+b,c)},f.Event=function(a,b){if(!(this instanceof f.Event)){return new f.Event(a,b)
}a&&a.type?(this.originalEvent=a,this.type=a.type,this.isDefaultPrevented=a.defaultPrevented||a.returnValue===!1||a.getPreventDefault&&a.getPreventDefault()?K:J):this.type=a,b&&f.extend(this,b),this.timeStamp=a&&a.timeStamp||f.now(),this[f.expando]=!0
},f.Event.prototype={preventDefault:function(){this.isDefaultPrevented=K;var a=this.originalEvent;!a||(a.preventDefault?a.preventDefault():a.returnValue=!1)
},stopPropagation:function(){this.isPropagationStopped=K;var a=this.originalEvent;!a||(a.stopPropagation&&a.stopPropagation(),a.cancelBubble=!0)
},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=K,this.stopPropagation()},isDefaultPrevented:J,isPropagationStopped:J,isImmediatePropagationStopped:J},f.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(a,b){f.event.special[a]={delegateType:b,bindType:b,handle:function(a){var c=this,d=a.relatedTarget,e=a.handleObj,g=e.selector,h;
if(!d||d!==c&&!f.contains(c,d)){a.type=e.origType,h=e.handler.apply(this,arguments),a.type=b}return h
}}}),f.support.submitBubbles||(f.event.special.submit={setup:function(){if(f.nodeName(this,"form")){return !1
}f.event.add(this,"click._submit keypress._submit",function(a){var c=a.target,d=f.nodeName(c,"input")||f.nodeName(c,"button")?c.form:b;
d&&!d._submit_attached&&(f.event.add(d,"submit._submit",function(a){a._submit_bubble=!0}),d._submit_attached=!0)
})},postDispatch:function(a){a._submit_bubble&&(delete a._submit_bubble,this.parentNode&&!a.isTrigger&&f.event.simulate("submit",this.parentNode,a,!0))
},teardown:function(){if(f.nodeName(this,"form")){return !1}f.event.remove(this,"._submit")}}),f.support.changeBubbles||(f.event.special.change={setup:function(){if(z.test(this.nodeName)){if(this.type==="checkbox"||this.type==="radio"){f.event.add(this,"propertychange._change",function(a){a.originalEvent.propertyName==="checked"&&(this._just_changed=!0)
}),f.event.add(this,"click._change",function(a){this._just_changed&&!a.isTrigger&&(this._just_changed=!1,f.event.simulate("change",this,a,!0))
})}return !1}f.event.add(this,"beforeactivate._change",function(a){var b=a.target;z.test(b.nodeName)&&!b._change_attached&&(f.event.add(b,"change._change",function(a){this.parentNode&&!a.isSimulated&&!a.isTrigger&&f.event.simulate("change",this.parentNode,a,!0)
}),b._change_attached=!0)})},handle:function(a){var b=a.target;if(this!==b||a.isSimulated||a.isTrigger||b.type!=="radio"&&b.type!=="checkbox"){return a.handleObj.handler.apply(this,arguments)
}},teardown:function(){f.event.remove(this,"._change");return z.test(this.nodeName)}}),f.support.focusinBubbles||f.each({focus:"focusin",blur:"focusout"},function(a,b){var d=0,e=function(a){f.event.simulate(b,a.target,f.event.fix(a),!0)
};f.event.special[b]={setup:function(){d++===0&&c.addEventListener(a,e,!0)},teardown:function(){--d===0&&c.removeEventListener(a,e,!0)
}}}),f.fn.extend({on:function(a,c,d,e,g){var h,i;if(typeof a=="object"){typeof c!="string"&&(d=d||c,c=b);
for(i in a){this.on(i,c,d,a[i],g)}return this}d==null&&e==null?(e=c,d=c=b):e==null&&(typeof c=="string"?(e=d,d=b):(e=d,d=c,c=b));
if(e===!1){e=J}else{if(!e){return this}}g===1&&(h=e,e=function(a){f().off(a);return h.apply(this,arguments)
},e.guid=h.guid||(h.guid=f.guid++));return this.each(function(){f.event.add(this,a,e,d,c)})},one:function(a,b,c,d){return this.on(a,b,c,d,1)
},off:function(a,c,d){if(a&&a.preventDefault&&a.handleObj){var e=a.handleObj;f(a.delegateTarget).off(e.namespace?e.origType+"."+e.namespace:e.origType,e.selector,e.handler);
return this}if(typeof a=="object"){for(var g in a){this.off(g,c,a[g])}return this}if(c===!1||typeof c=="function"){d=c,c=b
}d===!1&&(d=J);return this.each(function(){f.event.remove(this,a,d,c)})},bind:function(a,b,c){return this.on(a,null,b,c)
},unbind:function(a,b){return this.off(a,null,b)},live:function(a,b,c){f(this.context).on(a,this.selector,b,c);
return this},die:function(a,b){f(this.context).off(a,this.selector||"**",b);return this},delegate:function(a,b,c,d){return this.on(b,a,c,d)
},undelegate:function(a,b,c){return arguments.length==1?this.off(a,"**"):this.off(b,a,c)},trigger:function(a,b){return this.each(function(){f.event.trigger(a,b,this)
})},triggerHandler:function(a,b){if(this[0]){return f.event.trigger(a,b,this[0],!0)}},toggle:function(a){var b=arguments,c=a.guid||f.guid++,d=0,e=function(c){var e=(f._data(this,"lastToggle"+a.guid)||0)%d;
f._data(this,"lastToggle"+a.guid,e+1),c.preventDefault();return b[e].apply(this,arguments)||!1};e.guid=c;
while(d<b.length){b[d++].guid=c}return this.click(e)},hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)
}}),f.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(a,b){f.fn[b]=function(a,c){c==null&&(c=a,a=null);
return arguments.length>0?this.on(b,null,a,c):this.trigger(b)},f.attrFn&&(f.attrFn[b]=!0),C.test(b)&&(f.event.fixHooks[b]=f.event.keyHooks),D.test(b)&&(f.event.fixHooks[b]=f.event.mouseHooks)
}),function(){function x(a,b,c,e,f,g){for(var h=0,i=e.length;h<i;h++){var j=e[h];if(j){var k=!1;j=j[a];
while(j){if(j[d]===c){k=e[j.sizset];break}if(j.nodeType===1){g||(j[d]=c,j.sizset=h);if(typeof b!="string"){if(j===b){k=!0;
break}}else{if(m.filter(b,[j]).length>0){k=j;break}}}j=j[a]}e[h]=k}}}function w(a,b,c,e,f,g){for(var h=0,i=e.length;
h<i;h++){var j=e[h];if(j){var k=!1;j=j[a];while(j){if(j[d]===c){k=e[j.sizset];break}j.nodeType===1&&!g&&(j[d]=c,j.sizset=h);
if(j.nodeName.toLowerCase()===b){k=j;break}j=j[a]}e[h]=k}}}var a=/((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^\[\]]*\]|['"][^'"]*['"]|[^\[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?((?:.|\r|\n)*)/g,d="sizcache"+(Math.random()+"").replace(".",""),e=0,g=Object.prototype.toString,h=!1,i=!0,j=/\\/g,k=/\r\n/g,l=/\W/;
[0,0].sort(function(){i=!1;return 0});var m=function(b,d,e,f){e=e||[],d=d||c;var h=d;if(d.nodeType!==1&&d.nodeType!==9){return[]
}if(!b||typeof b!="string"){return e}var i,j,k,l,n,q,r,t,u=!0,v=m.isXML(d),w=[],x=b;do{a.exec(""),i=a.exec(x);
if(i){x=i[3],w.push(i[1]);if(i[2]){l=i[3];break}}}while(i);if(w.length>1&&p.exec(b)){if(w.length===2&&o.relative[w[0]]){j=y(w[0]+w[1],d,f)
}else{j=o.relative[w[0]]?[d]:m(w.shift(),d);while(w.length){b=w.shift(),o.relative[b]&&(b+=w.shift()),j=y(b,j,f)
}}}else{!f&&w.length>1&&d.nodeType===9&&!v&&o.match.ID.test(w[0])&&!o.match.ID.test(w[w.length-1])&&(n=m.find(w.shift(),d,v),d=n.expr?m.filter(n.expr,n.set)[0]:n.set[0]);
if(d){n=f?{expr:w.pop(),set:s(f)}:m.find(w.pop(),w.length===1&&(w[0]==="~"||w[0]==="+")&&d.parentNode?d.parentNode:d,v),j=n.expr?m.filter(n.expr,n.set):n.set,w.length>0?k=s(j):u=!1;
while(w.length){q=w.pop(),r=q,o.relative[q]?r=w.pop():q="",r==null&&(r=d),o.relative[q](k,r,v)}}else{k=w=[]
}}k||(k=j),k||m.error(q||b);if(g.call(k)==="[object Array]"){if(!u){e.push.apply(e,k)}else{if(d&&d.nodeType===1){for(t=0;
k[t]!=null;t++){k[t]&&(k[t]===!0||k[t].nodeType===1&&m.contains(d,k[t]))&&e.push(j[t])}}else{for(t=0;
k[t]!=null;t++){k[t]&&k[t].nodeType===1&&e.push(j[t])}}}}else{s(k,e)}l&&(m(l,h,e,f),m.uniqueSort(e));
return e};m.uniqueSort=function(a){if(u){h=i,a.sort(u);if(h){for(var b=1;b<a.length;b++){a[b]===a[b-1]&&a.splice(b--,1)
}}}return a},m.matches=function(a,b){return m(a,null,null,b)},m.matchesSelector=function(a,b){return m(b,null,null,[a]).length>0
},m.find=function(a,b,c){var d,e,f,g,h,i;if(!a){return[]}for(e=0,f=o.order.length;e<f;e++){h=o.order[e];
if(g=o.leftMatch[h].exec(a)){i=g[1],g.splice(1,1);if(i.substr(i.length-1)!=="\\"){g[1]=(g[1]||"").replace(j,""),d=o.find[h](g,b,c);
if(d!=null){a=a.replace(o.match[h],"");break}}}}d||(d=typeof b.getElementsByTagName!="undefined"?b.getElementsByTagName("*"):[]);
return{set:d,expr:a}},m.filter=function(a,c,d,e){var f,g,h,i,j,k,l,n,p,q=a,r=[],s=c,t=c&&c[0]&&m.isXML(c[0]);
while(a&&c.length){for(h in o.filter){if((f=o.leftMatch[h].exec(a))!=null&&f[2]){k=o.filter[h],l=f[1],g=!1,f.splice(1,1);
if(l.substr(l.length-1)==="\\"){continue}s===r&&(r=[]);if(o.preFilter[h]){f=o.preFilter[h](f,s,d,r,e,t);
if(!f){g=i=!0}else{if(f===!0){continue}}}if(f){for(n=0;(j=s[n])!=null;n++){j&&(i=k(j,f,n,s),p=e^i,d&&i!=null?p?g=!0:s[n]=!1:p&&(r.push(j),g=!0))
}}if(i!==b){d||(s=r),a=a.replace(o.match[h],"");if(!g){return[]}break}}}if(a===q){if(g==null){m.error(a)
}else{break}}q=a}return s},m.error=function(a){throw new Error("Syntax error, unrecognized expression: "+a)
};var n=m.getText=function(a){var b,c,d=a.nodeType,e="";if(d){if(d===1||d===9||d===11){if(typeof a.textContent=="string"){return a.textContent
}if(typeof a.innerText=="string"){return a.innerText.replace(k,"")}for(a=a.firstChild;a;a=a.nextSibling){e+=n(a)
}}else{if(d===3||d===4){return a.nodeValue}}}else{for(b=0;c=a[b];b++){c.nodeType!==8&&(e+=n(c))}}return e
},o=m.selectors={order:["ID","NAME","TAG"],match:{ID:/#((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,CLASS:/\.((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,NAME:/\[name=['"]*((?:[\w\u00c0-\uFFFF\-]|\\.)+)['"]*\]/,ATTR:/\[\s*((?:[\w\u00c0-\uFFFF\-]|\\.)+)\s*(?:(\S?=)\s*(?:(['"])(.*?)\3|(#?(?:[\w\u00c0-\uFFFF\-]|\\.)*)|)|)\s*\]/,TAG:/^((?:[\w\u00c0-\uFFFF\*\-]|\\.)+)/,CHILD:/:(only|nth|last|first)-child(?:\(\s*(even|odd|(?:[+\-]?\d+|(?:[+\-]?\d*)?n\s*(?:[+\-]\s*\d+)?))\s*\))?/,POS:/:(nth|eq|gt|lt|first|last|even|odd)(?:\((\d*)\))?(?=[^\-]|$)/,PSEUDO:/:((?:[\w\u00c0-\uFFFF\-]|\\.)+)(?:\((['"]?)((?:\([^\)]+\)|[^\(\)]*)+)\2\))?/},leftMatch:{},attrMap:{"class":"className","for":"htmlFor"},attrHandle:{href:function(a){return a.getAttribute("href")
},type:function(a){return a.getAttribute("type")}},relative:{"+":function(a,b){var c=typeof b=="string",d=c&&!l.test(b),e=c&&!d;
d&&(b=b.toLowerCase());for(var f=0,g=a.length,h;f<g;f++){if(h=a[f]){while((h=h.previousSibling)&&h.nodeType!==1){}a[f]=e||h&&h.nodeName.toLowerCase()===b?h||!1:h===b
}}e&&m.filter(b,a,!0)},">":function(a,b){var c,d=typeof b=="string",e=0,f=a.length;if(d&&!l.test(b)){b=b.toLowerCase();
for(;e<f;e++){c=a[e];if(c){var g=c.parentNode;a[e]=g.nodeName.toLowerCase()===b?g:!1}}}else{for(;e<f;
e++){c=a[e],c&&(a[e]=d?c.parentNode:c.parentNode===b)}d&&m.filter(b,a,!0)}},"":function(a,b,c){var d,f=e++,g=x;
typeof b=="string"&&!l.test(b)&&(b=b.toLowerCase(),d=b,g=w),g("parentNode",b,f,a,d,c)},"~":function(a,b,c){var d,f=e++,g=x;
typeof b=="string"&&!l.test(b)&&(b=b.toLowerCase(),d=b,g=w),g("previousSibling",b,f,a,d,c)}},find:{ID:function(a,b,c){if(typeof b.getElementById!="undefined"&&!c){var d=b.getElementById(a[1]);
return d&&d.parentNode?[d]:[]}},NAME:function(a,b){if(typeof b.getElementsByName!="undefined"){var c=[],d=b.getElementsByName(a[1]);
for(var e=0,f=d.length;e<f;e++){d[e].getAttribute("name")===a[1]&&c.push(d[e])}return c.length===0?null:c
}},TAG:function(a,b){if(typeof b.getElementsByTagName!="undefined"){return b.getElementsByTagName(a[1])
}}},preFilter:{CLASS:function(a,b,c,d,e,f){a=" "+a[1].replace(j,"")+" ";if(f){return a}for(var g=0,h;
(h=b[g])!=null;g++){h&&(e^(h.className&&(" "+h.className+" ").replace(/[\t\n\r]/g," ").indexOf(a)>=0)?c||d.push(h):c&&(b[g]=!1))
}return !1},ID:function(a){return a[1].replace(j,"")},TAG:function(a,b){return a[1].replace(j,"").toLowerCase()
},CHILD:function(a){if(a[1]==="nth"){a[2]||m.error(a[0]),a[2]=a[2].replace(/^\+|\s*/g,"");var b=/(-?)(\d*)(?:n([+\-]?\d*))?/.exec(a[2]==="even"&&"2n"||a[2]==="odd"&&"2n+1"||!/\D/.test(a[2])&&"0n+"+a[2]||a[2]);
a[2]=b[1]+(b[2]||1)-0,a[3]=b[3]-0}else{a[2]&&m.error(a[0])}a[0]=e++;return a},ATTR:function(a,b,c,d,e,f){var g=a[1]=a[1].replace(j,"");
!f&&o.attrMap[g]&&(a[1]=o.attrMap[g]),a[4]=(a[4]||a[5]||"").replace(j,""),a[2]==="~="&&(a[4]=" "+a[4]+" ");
return a},PSEUDO:function(b,c,d,e,f){if(b[1]==="not"){if((a.exec(b[3])||"").length>1||/^\w/.test(b[3])){b[3]=m(b[3],null,null,c)
}else{var g=m.filter(b[3],c,d,!0^f);d||e.push.apply(e,g);return !1}}else{if(o.match.POS.test(b[0])||o.match.CHILD.test(b[0])){return !0
}}return b},POS:function(a){a.unshift(!0);return a}},filters:{enabled:function(a){return a.disabled===!1&&a.type!=="hidden"
},disabled:function(a){return a.disabled===!0},checked:function(a){return a.checked===!0},selected:function(a){a.parentNode&&a.parentNode.selectedIndex;
return a.selected===!0},parent:function(a){return !!a.firstChild},empty:function(a){return !a.firstChild
},has:function(a,b,c){return !!m(c[3],a).length},header:function(a){return/h\d/i.test(a.nodeName)},text:function(a){var b=a.getAttribute("type"),c=a.type;
return a.nodeName.toLowerCase()==="input"&&"text"===c&&(b===c||b===null)},radio:function(a){return a.nodeName.toLowerCase()==="input"&&"radio"===a.type
},checkbox:function(a){return a.nodeName.toLowerCase()==="input"&&"checkbox"===a.type},file:function(a){return a.nodeName.toLowerCase()==="input"&&"file"===a.type
},password:function(a){return a.nodeName.toLowerCase()==="input"&&"password"===a.type},submit:function(a){var b=a.nodeName.toLowerCase();
return(b==="input"||b==="button")&&"submit"===a.type},image:function(a){return a.nodeName.toLowerCase()==="input"&&"image"===a.type
},reset:function(a){var b=a.nodeName.toLowerCase();return(b==="input"||b==="button")&&"reset"===a.type
},button:function(a){var b=a.nodeName.toLowerCase();return b==="input"&&"button"===a.type||b==="button"
},input:function(a){return/input|select|textarea|button/i.test(a.nodeName)},focus:function(a){return a===a.ownerDocument.activeElement
}},setFilters:{first:function(a,b){return b===0},last:function(a,b,c,d){return b===d.length-1},even:function(a,b){return b%2===0
},odd:function(a,b){return b%2===1},lt:function(a,b,c){return b<c[3]-0},gt:function(a,b,c){return b>c[3]-0
},nth:function(a,b,c){return c[3]-0===b},eq:function(a,b,c){return c[3]-0===b}},filter:{PSEUDO:function(a,b,c,d){var e=b[1],f=o.filters[e];
if(f){return f(a,c,b,d)}if(e==="contains"){return(a.textContent||a.innerText||n([a])||"").indexOf(b[3])>=0
}if(e==="not"){var g=b[3];for(var h=0,i=g.length;h<i;h++){if(g[h]===a){return !1}}return !0}m.error(e)
},CHILD:function(a,b){var c,e,f,g,h,i,j,k=b[1],l=a;switch(k){case"only":case"first":while(l=l.previousSibling){if(l.nodeType===1){return !1
}}if(k==="first"){return !0}l=a;case"last":while(l=l.nextSibling){if(l.nodeType===1){return !1}}return !0;
case"nth":c=b[2],e=b[3];if(c===1&&e===0){return !0}f=b[0],g=a.parentNode;if(g&&(g[d]!==f||!a.nodeIndex)){i=0;
for(l=g.firstChild;l;l=l.nextSibling){l.nodeType===1&&(l.nodeIndex=++i)}g[d]=f}j=a.nodeIndex-e;return c===0?j===0:j%c===0&&j/c>=0
}},ID:function(a,b){return a.nodeType===1&&a.getAttribute("id")===b},TAG:function(a,b){return b==="*"&&a.nodeType===1||!!a.nodeName&&a.nodeName.toLowerCase()===b
},CLASS:function(a,b){return(" "+(a.className||a.getAttribute("class"))+" ").indexOf(b)>-1},ATTR:function(a,b){var c=b[1],d=m.attr?m.attr(a,c):o.attrHandle[c]?o.attrHandle[c](a):a[c]!=null?a[c]:a.getAttribute(c),e=d+"",f=b[2],g=b[4];
return d==null?f==="!=":!f&&m.attr?d!=null:f==="="?e===g:f==="*="?e.indexOf(g)>=0:f==="~="?(" "+e+" ").indexOf(g)>=0:g?f==="!="?e!==g:f==="^="?e.indexOf(g)===0:f==="$="?e.substr(e.length-g.length)===g:f==="|="?e===g||e.substr(0,g.length+1)===g+"-":!1:e&&d!==!1
},POS:function(a,b,c,d){var e=b[2],f=o.setFilters[e];if(f){return f(a,c,b,d)}}}},p=o.match.POS,q=function(a,b){return"\\"+(b-0+1)
};for(var r in o.match){o.match[r]=new RegExp(o.match[r].source+/(?![^\[]*\])(?![^\(]*\))/.source),o.leftMatch[r]=new RegExp(/(^(?:.|\r|\n)*?)/.source+o.match[r].source.replace(/\\(\d+)/g,q))
}o.match.globalPOS=p;var s=function(a,b){a=Array.prototype.slice.call(a,0);if(b){b.push.apply(b,a);return b
}return a};try{Array.prototype.slice.call(c.documentElement.childNodes,0)[0].nodeType}catch(t){s=function(a,b){var c=0,d=b||[];
if(g.call(a)==="[object Array]"){Array.prototype.push.apply(d,a)}else{if(typeof a.length=="number"){for(var e=a.length;
c<e;c++){d.push(a[c])}}else{for(;a[c];c++){d.push(a[c])}}}return d}}var u,v;c.documentElement.compareDocumentPosition?u=function(a,b){if(a===b){h=!0;
return 0}if(!a.compareDocumentPosition||!b.compareDocumentPosition){return a.compareDocumentPosition?-1:1
}return a.compareDocumentPosition(b)&4?-1:1}:(u=function(a,b){if(a===b){h=!0;return 0}if(a.sourceIndex&&b.sourceIndex){return a.sourceIndex-b.sourceIndex
}var c,d,e=[],f=[],g=a.parentNode,i=b.parentNode,j=g;if(g===i){return v(a,b)}if(!g){return -1}if(!i){return 1
}while(j){e.unshift(j),j=j.parentNode}j=i;while(j){f.unshift(j),j=j.parentNode}c=e.length,d=f.length;
for(var k=0;k<c&&k<d;k++){if(e[k]!==f[k]){return v(e[k],f[k])}}return k===c?v(a,f[k],-1):v(e[k],b,1)},v=function(a,b,c){if(a===b){return c
}var d=a.nextSibling;while(d){if(d===b){return -1}d=d.nextSibling}return 1}),function(){var a=c.createElement("div"),d="script"+(new Date).getTime(),e=c.documentElement;
a.innerHTML="<a name='"+d+"'/>",e.insertBefore(a,e.firstChild),c.getElementById(d)&&(o.find.ID=function(a,c,d){if(typeof c.getElementById!="undefined"&&!d){var e=c.getElementById(a[1]);
return e?e.id===a[1]||typeof e.getAttributeNode!="undefined"&&e.getAttributeNode("id").nodeValue===a[1]?[e]:b:[]
}},o.filter.ID=function(a,b){var c=typeof a.getAttributeNode!="undefined"&&a.getAttributeNode("id");return a.nodeType===1&&c&&c.nodeValue===b
}),e.removeChild(a),e=a=null}(),function(){var a=c.createElement("div");a.appendChild(c.createComment("")),a.getElementsByTagName("*").length>0&&(o.find.TAG=function(a,b){var c=b.getElementsByTagName(a[1]);
if(a[1]==="*"){var d=[];for(var e=0;c[e];e++){c[e].nodeType===1&&d.push(c[e])}c=d}return c}),a.innerHTML="<a href='#'></a>",a.firstChild&&typeof a.firstChild.getAttribute!="undefined"&&a.firstChild.getAttribute("href")!=="#"&&(o.attrHandle.href=function(a){return a.getAttribute("href",2)
}),a=null}(),c.querySelectorAll&&function(){var a=m,b=c.createElement("div"),d="__sizzle__";b.innerHTML="<p class='TEST'></p>";
if(!b.querySelectorAll||b.querySelectorAll(".TEST").length!==0){m=function(b,e,f,g){e=e||c;if(!g&&!m.isXML(e)){var h=/^(\w+$)|^\.([\w\-]+$)|^#([\w\-]+$)/.exec(b);
if(h&&(e.nodeType===1||e.nodeType===9)){if(h[1]){return s(e.getElementsByTagName(b),f)}if(h[2]&&o.find.CLASS&&e.getElementsByClassName){return s(e.getElementsByClassName(h[2]),f)
}}if(e.nodeType===9){if(b==="body"&&e.body){return s([e.body],f)}if(h&&h[3]){var i=e.getElementById(h[3]);
if(!i||!i.parentNode){return s([],f)}if(i.id===h[3]){return s([i],f)}}try{return s(e.querySelectorAll(b),f)
}catch(j){}}else{if(e.nodeType===1&&e.nodeName.toLowerCase()!=="object"){var k=e,l=e.getAttribute("id"),n=l||d,p=e.parentNode,q=/^\s*[+~]/.test(b);
l?n=n.replace(/'/g,"\\$&"):e.setAttribute("id",n),q&&p&&(e=e.parentNode);try{if(!q||p){return s(e.querySelectorAll("[id='"+n+"'] "+b),f)
}}catch(r){}finally{l||k.removeAttribute("id")}}}}return a(b,e,f,g)};for(var e in a){m[e]=a[e]}b=null
}}(),function(){var a=c.documentElement,b=a.matchesSelector||a.mozMatchesSelector||a.webkitMatchesSelector||a.msMatchesSelector;
if(b){var d=!b.call(c.createElement("div"),"div"),e=!1;try{b.call(c.documentElement,"[test!='']:sizzle")
}catch(f){e=!0}m.matchesSelector=function(a,c){c=c.replace(/\=\s*([^'"\]]*)\s*\]/g,"='$1']");if(!m.isXML(a)){try{if(e||!o.match.PSEUDO.test(c)&&!/!=/.test(c)){var f=b.call(a,c);
if(f||!d||a.document&&a.document.nodeType!==11){return f}}}catch(g){}}return m(c,null,null,[a]).length>0
}}}(),function(){var a=c.createElement("div");a.innerHTML="<div class='test e'></div><div class='test'></div>";
if(!!a.getElementsByClassName&&a.getElementsByClassName("e").length!==0){a.lastChild.className="e";if(a.getElementsByClassName("e").length===1){return
}o.order.splice(1,0,"CLASS"),o.find.CLASS=function(a,b,c){if(typeof b.getElementsByClassName!="undefined"&&!c){return b.getElementsByClassName(a[1])
}},a=null}}(),c.documentElement.contains?m.contains=function(a,b){return a!==b&&(a.contains?a.contains(b):!0)
}:c.documentElement.compareDocumentPosition?m.contains=function(a,b){return !!(a.compareDocumentPosition(b)&16)
}:m.contains=function(){return !1},m.isXML=function(a){var b=(a?a.ownerDocument||a:0).documentElement;
return b?b.nodeName!=="HTML":!1};var y=function(a,b,c){var d,e=[],f="",g=b.nodeType?[b]:b;while(d=o.match.PSEUDO.exec(a)){f+=d[0],a=a.replace(o.match.PSEUDO,"")
}a=o.relative[a]?a+"*":a;for(var h=0,i=g.length;h<i;h++){m(a,g[h],e,c)}return m.filter(f,e)};m.attr=f.attr,m.selectors.attrMap={},f.find=m,f.expr=m.selectors,f.expr[":"]=f.expr.filters,f.unique=m.uniqueSort,f.text=m.getText,f.isXMLDoc=m.isXML,f.contains=m.contains
}();var L=/Until$/,M=/^(?:parents|prevUntil|prevAll)/,N=/,/,O=/^.[^:#\[\.,]*$/,P=Array.prototype.slice,Q=f.expr.match.globalPOS,R={children:!0,contents:!0,next:!0,prev:!0};
f.fn.extend({find:function(a){var b=this,c,d;if(typeof a!="string"){return f(a).filter(function(){for(c=0,d=b.length;
c<d;c++){if(f.contains(b[c],this)){return !0}}})}var e=this.pushStack("","find",a),g,h,i;for(c=0,d=this.length;
c<d;c++){g=e.length,f.find(a,this[c],e);if(c>0){for(h=g;h<e.length;h++){for(i=0;i<g;i++){if(e[i]===e[h]){e.splice(h--,1);
break}}}}}return e},has:function(a){var b=f(a);return this.filter(function(){for(var a=0,c=b.length;a<c;
a++){if(f.contains(this,b[a])){return !0}}})},not:function(a){return this.pushStack(T(this,a,!1),"not",a)
},filter:function(a){return this.pushStack(T(this,a,!0),"filter",a)},is:function(a){return !!a&&(typeof a=="string"?Q.test(a)?f(a,this.context).index(this[0])>=0:f.filter(a,this).length>0:this.filter(a).length>0)
},closest:function(a,b){var c=[],d,e,g=this[0];if(f.isArray(a)){var h=1;while(g&&g.ownerDocument&&g!==b){for(d=0;
d<a.length;d++){f(g).is(a[d])&&c.push({selector:a[d],elem:g,level:h})}g=g.parentNode,h++}return c}var i=Q.test(a)||typeof a!="string"?f(a,b||this.context):0;
for(d=0,e=this.length;d<e;d++){g=this[d];while(g){if(i?i.index(g)>-1:f.find.matchesSelector(g,a)){c.push(g);
break}g=g.parentNode;if(!g||!g.ownerDocument||g===b||g.nodeType===11){break}}}c=c.length>1?f.unique(c):c;
return this.pushStack(c,"closest",a)},index:function(a){if(!a){return this[0]&&this[0].parentNode?this.prevAll().length:-1
}if(typeof a=="string"){return f.inArray(this[0],f(a))}return f.inArray(a.jquery?a[0]:a,this)},add:function(a,b){var c=typeof a=="string"?f(a,b):f.makeArray(a&&a.nodeType?[a]:a),d=f.merge(this.get(),c);
return this.pushStack(S(c[0])||S(d[0])?d:f.unique(d))},andSelf:function(){return this.add(this.prevObject)
}}),f.each({parent:function(a){var b=a.parentNode;return b&&b.nodeType!==11?b:null},parents:function(a){return f.dir(a,"parentNode")
},parentsUntil:function(a,b,c){return f.dir(a,"parentNode",c)},next:function(a){return f.nth(a,2,"nextSibling")
},prev:function(a){return f.nth(a,2,"previousSibling")},nextAll:function(a){return f.dir(a,"nextSibling")
},prevAll:function(a){return f.dir(a,"previousSibling")},nextUntil:function(a,b,c){return f.dir(a,"nextSibling",c)
},prevUntil:function(a,b,c){return f.dir(a,"previousSibling",c)},siblings:function(a){return f.sibling((a.parentNode||{}).firstChild,a)
},children:function(a){return f.sibling(a.firstChild)},contents:function(a){return f.nodeName(a,"iframe")?a.contentDocument||a.contentWindow.document:f.makeArray(a.childNodes)
}},function(a,b){f.fn[a]=function(c,d){var e=f.map(this,b,c);L.test(a)||(d=c),d&&typeof d=="string"&&(e=f.filter(d,e)),e=this.length>1&&!R[a]?f.unique(e):e,(this.length>1||N.test(d))&&M.test(a)&&(e=e.reverse());
return this.pushStack(e,a,P.call(arguments).join(","))}}),f.extend({filter:function(a,b,c){c&&(a=":not("+a+")");
return b.length===1?f.find.matchesSelector(b[0],a)?[b[0]]:[]:f.find.matches(a,b)},dir:function(a,c,d){var e=[],g=a[c];
while(g&&g.nodeType!==9&&(d===b||g.nodeType!==1||!f(g).is(d))){g.nodeType===1&&e.push(g),g=g[c]}return e
},nth:function(a,b,c,d){b=b||1;var e=0;for(;a;a=a[c]){if(a.nodeType===1&&++e===b){break}}return a},sibling:function(a,b){var c=[];
for(;a;a=a.nextSibling){a.nodeType===1&&a!==b&&c.push(a)}return c}});var V="abbr|article|aside|audio|bdi|canvas|data|datalist|details|figcaption|figure|footer|header|hgroup|mark|meter|nav|output|progress|section|summary|time|video",W=/ jQuery\d+="(?:\d+|null)"/g,X=/^\s+/,Y=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/ig,Z=/<([\w:]+)/,$=/<tbody/i,_=/<|&#?\w+;/,ba=/<(?:script|style)/i,bb=/<(?:script|object|embed|option|style)/i,bc=new RegExp("<(?:"+V+")[\\s/>]","i"),bd=/checked\s*(?:[^=]|=\s*.checked.)/i,be=/\/(java|ecma)script/i,bf=/^\s*<!(?:\[CDATA\[|\-\-)/,bg={option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],area:[1,"<map>","</map>"],_default:[0,"",""]},bh=U(c);
bg.optgroup=bg.option,bg.tbody=bg.tfoot=bg.colgroup=bg.caption=bg.thead,bg.th=bg.td,f.support.htmlSerialize||(bg._default=[1,"div<div>","</div>"]),f.fn.extend({text:function(a){return f.access(this,function(a){return a===b?f.text(this):this.empty().append((this[0]&&this[0].ownerDocument||c).createTextNode(a))
},null,a,arguments.length)},wrapAll:function(a){if(f.isFunction(a)){return this.each(function(b){f(this).wrapAll(a.call(this,b))
})}if(this[0]){var b=f(a,this[0].ownerDocument).eq(0).clone(!0);this[0].parentNode&&b.insertBefore(this[0]),b.map(function(){var a=this;
while(a.firstChild&&a.firstChild.nodeType===1){a=a.firstChild}return a}).append(this)}return this},wrapInner:function(a){if(f.isFunction(a)){return this.each(function(b){f(this).wrapInner(a.call(this,b))
})}return this.each(function(){var b=f(this),c=b.contents();c.length?c.wrapAll(a):b.append(a)})},wrap:function(a){var b=f.isFunction(a);
return this.each(function(c){f(this).wrapAll(b?a.call(this,c):a)})},unwrap:function(){return this.parent().each(function(){f.nodeName(this,"body")||f(this).replaceWith(this.childNodes)
}).end()},append:function(){return this.domManip(arguments,!0,function(a){this.nodeType===1&&this.appendChild(a)
})},prepend:function(){return this.domManip(arguments,!0,function(a){this.nodeType===1&&this.insertBefore(a,this.firstChild)
})},before:function(){if(this[0]&&this[0].parentNode){return this.domManip(arguments,!1,function(a){this.parentNode.insertBefore(a,this)
})}if(arguments.length){var a=f.clean(arguments);a.push.apply(a,this.toArray());return this.pushStack(a,"before",arguments)
}},after:function(){if(this[0]&&this[0].parentNode){return this.domManip(arguments,!1,function(a){this.parentNode.insertBefore(a,this.nextSibling)
})}if(arguments.length){var a=this.pushStack(this,"after",arguments);a.push.apply(a,f.clean(arguments));
return a}},remove:function(a,b){for(var c=0,d;(d=this[c])!=null;c++){if(!a||f.filter(a,[d]).length){!b&&d.nodeType===1&&(f.cleanData(d.getElementsByTagName("*")),f.cleanData([d])),d.parentNode&&d.parentNode.removeChild(d)
}}return this},empty:function(){for(var a=0,b;(b=this[a])!=null;a++){b.nodeType===1&&f.cleanData(b.getElementsByTagName("*"));
while(b.firstChild){b.removeChild(b.firstChild)}}return this},clone:function(a,b){a=a==null?!1:a,b=b==null?a:b;
return this.map(function(){return f.clone(this,a,b)})},html:function(a){return f.access(this,function(a){var c=this[0]||{},d=0,e=this.length;
if(a===b){return c.nodeType===1?c.innerHTML.replace(W,""):null}if(typeof a=="string"&&!ba.test(a)&&(f.support.leadingWhitespace||!X.test(a))&&!bg[(Z.exec(a)||["",""])[1].toLowerCase()]){a=a.replace(Y,"<$1></$2>");
try{for(;d<e;d++){c=this[d]||{},c.nodeType===1&&(f.cleanData(c.getElementsByTagName("*")),c.innerHTML=a)
}c=0}catch(g){}}c&&this.empty().append(a)},null,a,arguments.length)},replaceWith:function(a){if(this[0]&&this[0].parentNode){if(f.isFunction(a)){return this.each(function(b){var c=f(this),d=c.html();
c.replaceWith(a.call(this,b,d))})}typeof a!="string"&&(a=f(a).detach());return this.each(function(){var b=this.nextSibling,c=this.parentNode;
f(this).remove(),b?f(b).before(a):f(c).append(a)})}return this.length?this.pushStack(f(f.isFunction(a)?a():a),"replaceWith",a):this
},detach:function(a){return this.remove(a,!0)},domManip:function(a,c,d){var e,g,h,i,j=a[0],k=[];if(!f.support.checkClone&&arguments.length===3&&typeof j=="string"&&bd.test(j)){return this.each(function(){f(this).domManip(a,c,d,!0)
})}if(f.isFunction(j)){return this.each(function(e){var g=f(this);a[0]=j.call(this,e,c?g.html():b),g.domManip(a,c,d)
})}if(this[0]){i=j&&j.parentNode,f.support.parentNode&&i&&i.nodeType===11&&i.childNodes.length===this.length?e={fragment:i}:e=f.buildFragment(a,this,k),h=e.fragment,h.childNodes.length===1?g=h=h.firstChild:g=h.firstChild;
if(g){c=c&&f.nodeName(g,"tr");for(var l=0,m=this.length,n=m-1;l<m;l++){d.call(c?bi(this[l],g):this[l],e.cacheable||m>1&&l<n?f.clone(h,!0,!0):h)
}}k.length&&f.each(k,function(a,b){b.src?f.ajax({type:"GET",global:!1,url:b.src,async:!1,dataType:"script"}):f.globalEval((b.text||b.textContent||b.innerHTML||"").replace(bf,"/*$0*/")),b.parentNode&&b.parentNode.removeChild(b)
})}return this}}),f.buildFragment=function(a,b,d){var e,g,h,i,j=a[0];b&&b[0]&&(i=b[0].ownerDocument||b[0]),i.createDocumentFragment||(i=c),a.length===1&&typeof j=="string"&&j.length<512&&i===c&&j.charAt(0)==="<"&&!bb.test(j)&&(f.support.checkClone||!bd.test(j))&&(f.support.html5Clone||!bc.test(j))&&(g=!0,h=f.fragments[j],h&&h!==1&&(e=h)),e||(e=i.createDocumentFragment(),f.clean(a,i,e,d)),g&&(f.fragments[j]=h?e:1);
return{fragment:e,cacheable:g}},f.fragments={},f.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(a,b){f.fn[a]=function(c){var d=[],e=f(c),g=this.length===1&&this[0].parentNode;
if(g&&g.nodeType===11&&g.childNodes.length===1&&e.length===1){e[b](this[0]);return this}for(var h=0,i=e.length;
h<i;h++){var j=(h>0?this.clone(!0):this).get();f(e[h])[b](j),d=d.concat(j)}return this.pushStack(d,a,e.selector)
}}),f.extend({clone:function(a,b,c){var d,e,g,h=f.support.html5Clone||f.isXMLDoc(a)||!bc.test("<"+a.nodeName+">")?a.cloneNode(!0):bo(a);
if((!f.support.noCloneEvent||!f.support.noCloneChecked)&&(a.nodeType===1||a.nodeType===11)&&!f.isXMLDoc(a)){bk(a,h),d=bl(a),e=bl(h);
for(g=0;d[g];++g){e[g]&&bk(d[g],e[g])}}if(b){bj(a,h);if(c){d=bl(a),e=bl(h);for(g=0;d[g];++g){bj(d[g],e[g])
}}}d=e=null;return h},clean:function(a,b,d,e){var g,h,i,j=[];b=b||c,typeof b.createElement=="undefined"&&(b=b.ownerDocument||b[0]&&b[0].ownerDocument||c);
for(var k=0,l;(l=a[k])!=null;k++){typeof l=="number"&&(l+="");if(!l){continue}if(typeof l=="string"){if(!_.test(l)){l=b.createTextNode(l)
}else{l=l.replace(Y,"<$1></$2>");var m=(Z.exec(l)||["",""])[1].toLowerCase(),n=bg[m]||bg._default,o=n[0],p=b.createElement("div"),q=bh.childNodes,r;
b===c?bh.appendChild(p):U(b).appendChild(p),p.innerHTML=n[1]+l+n[2];while(o--){p=p.lastChild}if(!f.support.tbody){var s=$.test(l),t=m==="table"&&!s?p.firstChild&&p.firstChild.childNodes:n[1]==="<table>"&&!s?p.childNodes:[];
for(i=t.length-1;i>=0;--i){f.nodeName(t[i],"tbody")&&!t[i].childNodes.length&&t[i].parentNode.removeChild(t[i])
}}!f.support.leadingWhitespace&&X.test(l)&&p.insertBefore(b.createTextNode(X.exec(l)[0]),p.firstChild),l=p.childNodes,p&&(p.parentNode.removeChild(p),q.length>0&&(r=q[q.length-1],r&&r.parentNode&&r.parentNode.removeChild(r)))
}}var u;if(!f.support.appendChecked){if(l[0]&&typeof(u=l.length)=="number"){for(i=0;i<u;i++){bn(l[i])
}}else{bn(l)}}l.nodeType?j.push(l):j=f.merge(j,l)}if(d){g=function(a){return !a.type||be.test(a.type)
};for(k=0;j[k];k++){h=j[k];if(e&&f.nodeName(h,"script")&&(!h.type||be.test(h.type))){e.push(h.parentNode?h.parentNode.removeChild(h):h)
}else{if(h.nodeType===1){var v=f.grep(h.getElementsByTagName("script"),g);j.splice.apply(j,[k+1,0].concat(v))
}d.appendChild(h)}}}return j},cleanData:function(a){var b,c,d=f.cache,e=f.event.special,g=f.support.deleteExpando;
for(var h=0,i;(i=a[h])!=null;h++){if(i.nodeName&&f.noData[i.nodeName.toLowerCase()]){continue}c=i[f.expando];
if(c){b=d[c];if(b&&b.events){for(var j in b.events){e[j]?f.event.remove(i,j):f.removeEvent(i,j,b.handle)
}b.handle&&(b.handle.elem=null)}g?delete i[f.expando]:i.removeAttribute&&i.removeAttribute(f.expando),delete d[c]
}}}});var bp=/alpha\([^)]*\)/i,bq=/opacity=([^)]*)/,br=/([A-Z]|^ms)/g,bs=/^[\-+]?(?:\d*\.)?\d+$/i,bt=/^-?(?:\d*\.)?\d+(?!px)[^\d\s]+$/i,bu=/^([\-+])=([\-+.\de]+)/,bv=/^margin/,bw={position:"absolute",visibility:"hidden",display:"block"},bx=["Top","Right","Bottom","Left"],by,bz,bA;
f.fn.css=function(a,c){return f.access(this,function(a,c,d){return d!==b?f.style(a,c,d):f.css(a,c)},a,c,arguments.length>1)
},f.extend({cssHooks:{opacity:{get:function(a,b){if(b){var c=by(a,"opacity");return c===""?"1":c}return a.style.opacity
}}},cssNumber:{fillOpacity:!0,fontWeight:!0,lineHeight:!0,opacity:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":f.support.cssFloat?"cssFloat":"styleFloat"},style:function(a,c,d,e){if(!!a&&a.nodeType!==3&&a.nodeType!==8&&!!a.style){var g,h,i=f.camelCase(c),j=a.style,k=f.cssHooks[i];
c=f.cssProps[i]||i;if(d===b){if(k&&"get" in k&&(g=k.get(a,!1,e))!==b){return g}return j[c]}h=typeof d,h==="string"&&(g=bu.exec(d))&&(d=+(g[1]+1)*+g[2]+parseFloat(f.css(a,c)),h="number");
if(d==null||h==="number"&&isNaN(d)){return}h==="number"&&!f.cssNumber[i]&&(d+="px");if(!k||!("set" in k)||(d=k.set(a,d))!==b){try{j[c]=d
}catch(l){}}}},css:function(a,c,d){var e,g;c=f.camelCase(c),g=f.cssHooks[c],c=f.cssProps[c]||c,c==="cssFloat"&&(c="float");
if(g&&"get" in g&&(e=g.get(a,!0,d))!==b){return e}if(by){return by(a,c)}},swap:function(a,b,c){var d={},e,f;
for(f in b){d[f]=a.style[f],a.style[f]=b[f]}e=c.call(a);for(f in b){a.style[f]=d[f]}return e}}),f.curCSS=f.css,c.defaultView&&c.defaultView.getComputedStyle&&(bz=function(a,b){var c,d,e,g,h=a.style;
b=b.replace(br,"-$1").toLowerCase(),(d=a.ownerDocument.defaultView)&&(e=d.getComputedStyle(a,null))&&(c=e.getPropertyValue(b),c===""&&!f.contains(a.ownerDocument.documentElement,a)&&(c=f.style(a,b))),!f.support.pixelMargin&&e&&bv.test(b)&&bt.test(c)&&(g=h.width,h.width=c,c=e.width,h.width=g);
return c}),c.documentElement.currentStyle&&(bA=function(a,b){var c,d,e,f=a.currentStyle&&a.currentStyle[b],g=a.style;
f==null&&g&&(e=g[b])&&(f=e),bt.test(f)&&(c=g.left,d=a.runtimeStyle&&a.runtimeStyle.left,d&&(a.runtimeStyle.left=a.currentStyle.left),g.left=b==="fontSize"?"1em":f,f=g.pixelLeft+"px",g.left=c,d&&(a.runtimeStyle.left=d));
return f===""?"auto":f}),by=bz||bA,f.each(["height","width"],function(a,b){f.cssHooks[b]={get:function(a,c,d){if(c){return a.offsetWidth!==0?bB(a,b,d):f.swap(a,bw,function(){return bB(a,b,d)
})}},set:function(a,b){return bs.test(b)?b+"px":b}}}),f.support.opacity||(f.cssHooks.opacity={get:function(a,b){return bq.test((b&&a.currentStyle?a.currentStyle.filter:a.style.filter)||"")?parseFloat(RegExp.$1)/100+"":b?"1":""
},set:function(a,b){var c=a.style,d=a.currentStyle,e=f.isNumeric(b)?"alpha(opacity="+b*100+")":"",g=d&&d.filter||c.filter||"";
c.zoom=1;if(b>=1&&f.trim(g.replace(bp,""))===""){c.removeAttribute("filter");if(d&&!d.filter){return}}c.filter=bp.test(g)?g.replace(bp,e):g+" "+e
}}),f(function(){f.support.reliableMarginRight||(f.cssHooks.marginRight={get:function(a,b){return f.swap(a,{display:"inline-block"},function(){return b?by(a,"margin-right"):a.style.marginRight
})}})}),f.expr&&f.expr.filters&&(f.expr.filters.hidden=function(a){var b=a.offsetWidth,c=a.offsetHeight;
return b===0&&c===0||!f.support.reliableHiddenOffsets&&(a.style&&a.style.display||f.css(a,"display"))==="none"
},f.expr.filters.visible=function(a){return !f.expr.filters.hidden(a)}),f.each({margin:"",padding:"",border:"Width"},function(a,b){f.cssHooks[a+b]={expand:function(c){var d,e=typeof c=="string"?c.split(" "):[c],f={};
for(d=0;d<4;d++){f[a+bx[d]+b]=e[d]||e[d-2]||e[0]}return f}}});var bC=/%20/g,bD=/\[\]$/,bE=/\r?\n/g,bF=/#.*$/,bG=/^(.*?):[ \t]*([^\r\n]*)\r?$/mg,bH=/^(?:color|date|datetime|datetime-local|email|hidden|month|number|password|range|search|tel|text|time|url|week)$/i,bI=/^(?:about|app|app\-storage|.+\-extension|file|res|widget):$/,bJ=/^(?:GET|HEAD)$/,bK=/^\/\//,bL=/\?/,bM=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,bN=/^(?:select|textarea)/i,bO=/\s+/,bP=/([?&])_=[^&]*/,bQ=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/,bR=f.fn.load,bS={},bT={},bU,bV,bW=["*/"]+["*"];
try{bU=e.href}catch(bX){bU=c.createElement("a"),bU.href="",bU=bU.href}bV=bQ.exec(bU.toLowerCase())||[],f.fn.extend({load:function(a,c,d){if(typeof a!="string"&&bR){return bR.apply(this,arguments)
}if(!this.length){return this}var e=a.indexOf(" ");if(e>=0){var g=a.slice(e,a.length);a=a.slice(0,e)}var h="GET";
c&&(f.isFunction(c)?(d=c,c=b):typeof c=="object"&&(c=f.param(c,f.ajaxSettings.traditional),h="POST"));
var i=this;f.ajax({url:a,type:h,dataType:"html",data:c,complete:function(a,b,c){c=a.responseText,a.isResolved()&&(a.done(function(a){c=a
}),i.html(g?f("<div>").append(c.replace(bM,"")).find(g):c)),d&&i.each(d,[c,b,a])}});return this},serialize:function(){return f.param(this.serializeArray())
},serializeArray:function(){return this.map(function(){return this.elements?f.makeArray(this.elements):this
}).filter(function(){return this.name&&!this.disabled&&(this.checked||bN.test(this.nodeName)||bH.test(this.type))
}).map(function(a,b){var c=f(this).val();return c==null?null:f.isArray(c)?f.map(c,function(a,c){return{name:b.name,value:a.replace(bE,"\r\n")}
}):{name:b.name,value:c.replace(bE,"\r\n")}}).get()}}),f.each("ajaxStart ajaxStop ajaxComplete ajaxError ajaxSuccess ajaxSend".split(" "),function(a,b){f.fn[b]=function(a){return this.on(b,a)
}}),f.each(["get","post"],function(a,c){f[c]=function(a,d,e,g){f.isFunction(d)&&(g=g||e,e=d,d=b);return f.ajax({type:c,url:a,data:d,success:e,dataType:g})
}}),f.extend({getScript:function(a,c){return f.get(a,b,c,"script")},getJSON:function(a,b,c){return f.get(a,b,c,"json")
},ajaxSetup:function(a,b){b?b$(a,f.ajaxSettings):(b=a,a=f.ajaxSettings),b$(a,b);return a},ajaxSettings:{url:bU,isLocal:bI.test(bV[1]),global:!0,type:"GET",contentType:"application/x-www-form-urlencoded; charset=UTF-8",processData:!0,async:!0,accepts:{xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript","*":bW},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText"},converters:{"* text":a.String,"text html":!0,"text json":f.parseJSON,"text xml":f.parseXML},flatOptions:{context:!0,url:!0}},ajaxPrefilter:bY(bS),ajaxTransport:bY(bT),ajax:function(a,c){function w(a,c,l,m){if(s!==2){s=2,q&&clearTimeout(q),p=b,n=m||"",v.readyState=a>0?4:0;
var o,r,u,w=c,x=l?ca(d,v,l):b,y,z;if(a>=200&&a<300||a===304){if(d.ifModified){if(y=v.getResponseHeader("Last-Modified")){f.lastModified[k]=y
}if(z=v.getResponseHeader("Etag")){f.etag[k]=z}}if(a===304){w="notmodified",o=!0}else{try{r=cb(d,x),w="success",o=!0
}catch(A){w="parsererror",u=A}}}else{u=w;if(!w||a){w="error",a<0&&(a=0)}}v.status=a,v.statusText=""+(c||w),o?h.resolveWith(e,[r,w,v]):h.rejectWith(e,[v,w,u]),v.statusCode(j),j=b,t&&g.trigger("ajax"+(o?"Success":"Error"),[v,d,o?r:u]),i.fireWith(e,[v,w]),t&&(g.trigger("ajaxComplete",[v,d]),--f.active||f.event.trigger("ajaxStop"))
}}typeof a=="object"&&(c=a,a=b),c=c||{};var d=f.ajaxSetup({},c),e=d.context||d,g=e!==d&&(e.nodeType||e instanceof f)?f(e):f.event,h=f.Deferred(),i=f.Callbacks("once memory"),j=d.statusCode||{},k,l={},m={},n,o,p,q,r,s=0,t,u,v={readyState:0,setRequestHeader:function(a,b){if(!s){var c=a.toLowerCase();
a=m[c]=m[c]||a,l[a]=b}return this},getAllResponseHeaders:function(){return s===2?n:null},getResponseHeader:function(a){var c;
if(s===2){if(!o){o={};while(c=bG.exec(n)){o[c[1].toLowerCase()]=c[2]}}c=o[a.toLowerCase()]}return c===b?null:c
},overrideMimeType:function(a){s||(d.mimeType=a);return this},abort:function(a){a=a||"abort",p&&p.abort(a),w(0,a);
return this}};h.promise(v),v.success=v.done,v.error=v.fail,v.complete=i.add,v.statusCode=function(a){if(a){var b;
if(s<2){for(b in a){j[b]=[j[b],a[b]]}}else{b=a[v.status],v.then(b,b)}}return this},d.url=((a||d.url)+"").replace(bF,"").replace(bK,bV[1]+"//"),d.dataTypes=f.trim(d.dataType||"*").toLowerCase().split(bO),d.crossDomain==null&&(r=bQ.exec(d.url.toLowerCase()),d.crossDomain=!(!r||r[1]==bV[1]&&r[2]==bV[2]&&(r[3]||(r[1]==="http:"?80:443))==(bV[3]||(bV[1]==="http:"?80:443)))),d.data&&d.processData&&typeof d.data!="string"&&(d.data=f.param(d.data,d.traditional)),bZ(bS,d,c,v);
if(s===2){return !1}t=d.global,d.type=d.type.toUpperCase(),d.hasContent=!bJ.test(d.type),t&&f.active++===0&&f.event.trigger("ajaxStart");
if(!d.hasContent){d.data&&(d.url+=(bL.test(d.url)?"&":"?")+d.data,delete d.data),k=d.url;if(d.cache===!1){var x=f.now(),y=d.url.replace(bP,"$1_="+x);
d.url=y+(y===d.url?(bL.test(d.url)?"&":"?")+"_="+x:"")}}(d.data&&d.hasContent&&d.contentType!==!1||c.contentType)&&v.setRequestHeader("Content-Type",d.contentType),d.ifModified&&(k=k||d.url,f.lastModified[k]&&v.setRequestHeader("If-Modified-Since",f.lastModified[k]),f.etag[k]&&v.setRequestHeader("If-None-Match",f.etag[k])),v.setRequestHeader("Accept",d.dataTypes[0]&&d.accepts[d.dataTypes[0]]?d.accepts[d.dataTypes[0]]+(d.dataTypes[0]!=="*"?", "+bW+"; q=0.01":""):d.accepts["*"]);
for(u in d.headers){v.setRequestHeader(u,d.headers[u])}if(d.beforeSend&&(d.beforeSend.call(e,v,d)===!1||s===2)){v.abort();
return !1}for(u in {success:1,error:1,complete:1}){v[u](d[u])}p=bZ(bT,d,c,v);if(!p){w(-1,"No Transport")
}else{v.readyState=1,t&&g.trigger("ajaxSend",[v,d]),d.async&&d.timeout>0&&(q=setTimeout(function(){v.abort("timeout")
},d.timeout));try{s=1,p.send(l,w)}catch(z){if(s<2){w(-1,z)}else{throw z}}}return v},param:function(a,c){var d=[],e=function(a,b){b=f.isFunction(b)?b():b,d[d.length]=encodeURIComponent(a)+"="+encodeURIComponent(b)
};c===b&&(c=f.ajaxSettings.traditional);if(f.isArray(a)||a.jquery&&!f.isPlainObject(a)){f.each(a,function(){e(this.name,this.value)
})}else{for(var g in a){b_(g,a[g],c,e)}}return d.join("&").replace(bC,"+")}}),f.extend({active:0,lastModified:{},etag:{}});
var cc=f.now(),cd=/(\=)\?(&|$)|\?\?/i;f.ajaxSetup({jsonp:"callback",jsonpCallback:function(){return f.expando+"_"+cc++
}}),f.ajaxPrefilter("json jsonp",function(b,c,d){var e=typeof b.data=="string"&&/^application\/x\-www\-form\-urlencoded/.test(b.contentType);
if(b.dataTypes[0]==="jsonp"||b.jsonp!==!1&&(cd.test(b.url)||e&&cd.test(b.data))){var g,h=b.jsonpCallback=f.isFunction(b.jsonpCallback)?b.jsonpCallback():b.jsonpCallback,i=a[h],j=b.url,k=b.data,l="$1"+h+"$2";
b.jsonp!==!1&&(j=j.replace(cd,l),b.url===j&&(e&&(k=k.replace(cd,l)),b.data===k&&(j+=(/\?/.test(j)?"&":"?")+b.jsonp+"="+h))),b.url=j,b.data=k,a[h]=function(a){g=[a]
},d.always(function(){a[h]=i,g&&f.isFunction(i)&&a[h](g[0])}),b.converters["script json"]=function(){g||f.error(h+" was not called");
return g[0]},b.dataTypes[0]="json";return"script"}}),f.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/javascript|ecmascript/},converters:{"text script":function(a){f.globalEval(a);
return a}}}),f.ajaxPrefilter("script",function(a){a.cache===b&&(a.cache=!1),a.crossDomain&&(a.type="GET",a.global=!1)
}),f.ajaxTransport("script",function(a){if(a.crossDomain){var d,e=c.head||c.getElementsByTagName("head")[0]||c.documentElement;
return{send:function(f,g){d=c.createElement("script"),d.async="async",a.scriptCharset&&(d.charset=a.scriptCharset),d.src=a.url,d.onload=d.onreadystatechange=function(a,c){if(c||!d.readyState||/loaded|complete/.test(d.readyState)){d.onload=d.onreadystatechange=null,e&&d.parentNode&&e.removeChild(d),d=b,c||g(200,"success")
}},e.insertBefore(d,e.firstChild)},abort:function(){d&&d.onload(0,1)}}}});var ce=a.ActiveXObject?function(){for(var a in cg){cg[a](0,1)
}}:!1,cf=0,cg;f.ajaxSettings.xhr=a.ActiveXObject?function(){return !this.isLocal&&ch()||ci()}:ch,function(a){f.extend(f.support,{ajax:!!a,cors:!!a&&"withCredentials" in a})
}(f.ajaxSettings.xhr()),f.support.ajax&&f.ajaxTransport(function(c){if(!c.crossDomain||f.support.cors){var d;
return{send:function(e,g){var h=c.xhr(),i,j;c.username?h.open(c.type,c.url,c.async,c.username,c.password):h.open(c.type,c.url,c.async);
if(c.xhrFields){for(j in c.xhrFields){h[j]=c.xhrFields[j]}}c.mimeType&&h.overrideMimeType&&h.overrideMimeType(c.mimeType),!c.crossDomain&&!e["X-Requested-With"]&&(e["X-Requested-With"]="XMLHttpRequest");
try{for(j in e){h.setRequestHeader(j,e[j])}}catch(k){}h.send(c.hasContent&&c.data||null),d=function(a,e){var j,k,l,m,n;
try{if(d&&(e||h.readyState===4)){d=b,i&&(h.onreadystatechange=f.noop,ce&&delete cg[i]);if(e){h.readyState!==4&&h.abort()
}else{j=h.status,l=h.getAllResponseHeaders(),m={},n=h.responseXML,n&&n.documentElement&&(m.xml=n);try{m.text=h.responseText
}catch(a){}try{k=h.statusText}catch(o){k=""}!j&&c.isLocal&&!c.crossDomain?j=m.text?200:404:j===1223&&(j=204)
}}}catch(p){e||g(-1,p)}m&&g(j,k,m,l)},!c.async||h.readyState===4?d():(i=++cf,ce&&(cg||(cg={},f(a).unload(ce)),cg[i]=d),h.onreadystatechange=d)
},abort:function(){d&&d(0,1)}}}});var cj={},ck,cl,cm=/^(?:toggle|show|hide)$/,cn=/^([+\-]=)?([\d+.\-]+)([a-z%]*)$/i,co,cp=[["height","marginTop","marginBottom","paddingTop","paddingBottom"],["width","marginLeft","marginRight","paddingLeft","paddingRight"],["opacity"]],cq;
f.fn.extend({show:function(a,b,c){var d,e;if(a||a===0){return this.animate(ct("show",3),a,b,c)}for(var g=0,h=this.length;
g<h;g++){d=this[g],d.style&&(e=d.style.display,!f._data(d,"olddisplay")&&e==="none"&&(e=d.style.display=""),(e===""&&f.css(d,"display")==="none"||!f.contains(d.ownerDocument.documentElement,d))&&f._data(d,"olddisplay",cu(d.nodeName)))
}for(g=0;g<h;g++){d=this[g];if(d.style){e=d.style.display;if(e===""||e==="none"){d.style.display=f._data(d,"olddisplay")||""
}}}return this},hide:function(a,b,c){if(a||a===0){return this.animate(ct("hide",3),a,b,c)}var d,e,g=0,h=this.length;
for(;g<h;g++){d=this[g],d.style&&(e=f.css(d,"display"),e!=="none"&&!f._data(d,"olddisplay")&&f._data(d,"olddisplay",e))
}for(g=0;g<h;g++){this[g].style&&(this[g].style.display="none")}return this},_toggle:f.fn.toggle,toggle:function(a,b,c){var d=typeof a=="boolean";
f.isFunction(a)&&f.isFunction(b)?this._toggle.apply(this,arguments):a==null||d?this.each(function(){var b=d?a:f(this).is(":hidden");
f(this)[b?"show":"hide"]()}):this.animate(ct("toggle",3),a,b,c);return this},fadeTo:function(a,b,c,d){return this.filter(":hidden").css("opacity",0).show().end().animate({opacity:b},a,c,d)
},animate:function(a,b,c,d){function g(){e.queue===!1&&f._mark(this);var b=f.extend({},e),c=this.nodeType===1,d=c&&f(this).is(":hidden"),g,h,i,j,k,l,m,n,o,p,q;
b.animatedProperties={};for(i in a){g=f.camelCase(i),i!==g&&(a[g]=a[i],delete a[i]);if((k=f.cssHooks[g])&&"expand" in k){l=k.expand(a[g]),delete a[g];
for(i in l){i in a||(a[i]=l[i])}}}for(g in a){h=a[g],f.isArray(h)?(b.animatedProperties[g]=h[1],h=a[g]=h[0]):b.animatedProperties[g]=b.specialEasing&&b.specialEasing[g]||b.easing||"swing";
if(h==="hide"&&d||h==="show"&&!d){return b.complete.call(this)}c&&(g==="height"||g==="width")&&(b.overflow=[this.style.overflow,this.style.overflowX,this.style.overflowY],f.css(this,"display")==="inline"&&f.css(this,"float")==="none"&&(!f.support.inlineBlockNeedsLayout||cu(this.nodeName)==="inline"?this.style.display="inline-block":this.style.zoom=1))
}b.overflow!=null&&(this.style.overflow="hidden");for(i in a){j=new f.fx(this,b,i),h=a[i],cm.test(h)?(q=f._data(this,"toggle"+i)||(h==="toggle"?d?"show":"hide":0),q?(f._data(this,"toggle"+i,q==="show"?"hide":"show"),j[q]()):j[h]()):(m=cn.exec(h),n=j.cur(),m?(o=parseFloat(m[2]),p=m[3]||(f.cssNumber[i]?"":"px"),p!=="px"&&(f.style(this,i,(o||1)+p),n=(o||1)/j.cur()*n,f.style(this,i,n+p)),m[1]&&(o=(m[1]==="-="?-1:1)*o+n),j.custom(n,o,p)):j.custom(n,h,""))
}return !0}var e=f.speed(b,c,d);if(f.isEmptyObject(a)){return this.each(e.complete,[!1])}a=f.extend({},a);
return e.queue===!1?this.each(g):this.queue(e.queue,g)},stop:function(a,c,d){typeof a!="string"&&(d=c,c=a,a=b),c&&a!==!1&&this.queue(a||"fx",[]);
return this.each(function(){function h(a,b,c){var e=b[c];f.removeData(a,c,!0),e.stop(d)}var b,c=!1,e=f.timers,g=f._data(this);
d||f._unmark(!0,this);if(a==null){for(b in g){g[b]&&g[b].stop&&b.indexOf(".run")===b.length-4&&h(this,g,b)
}}else{g[b=a+".run"]&&g[b].stop&&h(this,g,b)}for(b=e.length;b--;){e[b].elem===this&&(a==null||e[b].queue===a)&&(d?e[b](!0):e[b].saveState(),c=!0,e.splice(b,1))
}(!d||!c)&&f.dequeue(this,a)})}}),f.each({slideDown:ct("show",1),slideUp:ct("hide",1),slideToggle:ct("toggle",1),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(a,b){f.fn[a]=function(a,c,d){return this.animate(b,a,c,d)
}}),f.extend({speed:function(a,b,c){var d=a&&typeof a=="object"?f.extend({},a):{complete:c||!c&&b||f.isFunction(a)&&a,duration:a,easing:c&&b||b&&!f.isFunction(b)&&b};
d.duration=f.fx.off?0:typeof d.duration=="number"?d.duration:d.duration in f.fx.speeds?f.fx.speeds[d.duration]:f.fx.speeds._default;
if(d.queue==null||d.queue===!0){d.queue="fx"}d.old=d.complete,d.complete=function(a){f.isFunction(d.old)&&d.old.call(this),d.queue?f.dequeue(this,d.queue):a!==!1&&f._unmark(this)
};return d},easing:{linear:function(a){return a},swing:function(a){return -Math.cos(a*Math.PI)/2+0.5}},timers:[],fx:function(a,b,c){this.options=b,this.elem=a,this.prop=c,b.orig=b.orig||{}
}}),f.fx.prototype={update:function(){this.options.step&&this.options.step.call(this.elem,this.now,this),(f.fx.step[this.prop]||f.fx.step._default)(this)
},cur:function(){if(this.elem[this.prop]!=null&&(!this.elem.style||this.elem.style[this.prop]==null)){return this.elem[this.prop]
}var a,b=f.css(this.elem,this.prop);return isNaN(a=parseFloat(b))?!b||b==="auto"?0:b:a},custom:function(a,c,d){function h(a){return e.step(a)
}var e=this,g=f.fx;this.startTime=cq||cr(),this.end=c,this.now=this.start=a,this.pos=this.state=0,this.unit=d||this.unit||(f.cssNumber[this.prop]?"":"px"),h.queue=this.options.queue,h.elem=this.elem,h.saveState=function(){f._data(e.elem,"fxshow"+e.prop)===b&&(e.options.hide?f._data(e.elem,"fxshow"+e.prop,e.start):e.options.show&&f._data(e.elem,"fxshow"+e.prop,e.end))
},h()&&f.timers.push(h)&&!co&&(co=setInterval(g.tick,g.interval))},show:function(){var a=f._data(this.elem,"fxshow"+this.prop);
this.options.orig[this.prop]=a||f.style(this.elem,this.prop),this.options.show=!0,a!==b?this.custom(this.cur(),a):this.custom(this.prop==="width"||this.prop==="height"?1:0,this.cur()),f(this.elem).show()
},hide:function(){this.options.orig[this.prop]=f._data(this.elem,"fxshow"+this.prop)||f.style(this.elem,this.prop),this.options.hide=!0,this.custom(this.cur(),0)
},step:function(a){var b,c,d,e=cq||cr(),g=!0,h=this.elem,i=this.options;if(a||e>=i.duration+this.startTime){this.now=this.end,this.pos=this.state=1,this.update(),i.animatedProperties[this.prop]=!0;
for(b in i.animatedProperties){i.animatedProperties[b]!==!0&&(g=!1)}if(g){i.overflow!=null&&!f.support.shrinkWrapBlocks&&f.each(["","X","Y"],function(a,b){h.style["overflow"+b]=i.overflow[a]
}),i.hide&&f(h).hide();if(i.hide||i.show){for(b in i.animatedProperties){f.style(h,b,i.orig[b]),f.removeData(h,"fxshow"+b,!0),f.removeData(h,"toggle"+b,!0)
}}d=i.complete,d&&(i.complete=!1,d.call(h))}return !1}i.duration==Infinity?this.now=e:(c=e-this.startTime,this.state=c/i.duration,this.pos=f.easing[i.animatedProperties[this.prop]](this.state,c,0,1,i.duration),this.now=this.start+(this.end-this.start)*this.pos),this.update();
return !0}},f.extend(f.fx,{tick:function(){var a,b=f.timers,c=0;for(;c<b.length;c++){a=b[c],!a()&&b[c]===a&&b.splice(c--,1)
}b.length||f.fx.stop()},interval:13,stop:function(){clearInterval(co),co=null},speeds:{slow:600,fast:200,_default:400},step:{opacity:function(a){f.style(a.elem,"opacity",a.now)
},_default:function(a){a.elem.style&&a.elem.style[a.prop]!=null?a.elem.style[a.prop]=a.now+a.unit:a.elem[a.prop]=a.now
}}}),f.each(cp.concat.apply([],cp),function(a,b){b.indexOf("margin")&&(f.fx.step[b]=function(a){f.style(a.elem,b,Math.max(0,a.now)+a.unit)
})}),f.expr&&f.expr.filters&&(f.expr.filters.animated=function(a){return f.grep(f.timers,function(b){return a===b.elem
}).length});var cv,cw=/^t(?:able|d|h)$/i,cx=/^(?:body|html)$/i;"getBoundingClientRect" in c.documentElement?cv=function(a,b,c,d){try{d=a.getBoundingClientRect()
}catch(e){}if(!d||!f.contains(c,a)){return d?{top:d.top,left:d.left}:{top:0,left:0}}var g=b.body,h=cy(b),i=c.clientTop||g.clientTop||0,j=c.clientLeft||g.clientLeft||0,k=h.pageYOffset||f.support.boxModel&&c.scrollTop||g.scrollTop,l=h.pageXOffset||f.support.boxModel&&c.scrollLeft||g.scrollLeft,m=d.top+k-i,n=d.left+l-j;
return{top:m,left:n}}:cv=function(a,b,c){var d,e=a.offsetParent,g=a,h=b.body,i=b.defaultView,j=i?i.getComputedStyle(a,null):a.currentStyle,k=a.offsetTop,l=a.offsetLeft;
while((a=a.parentNode)&&a!==h&&a!==c){if(f.support.fixedPosition&&j.position==="fixed"){break}d=i?i.getComputedStyle(a,null):a.currentStyle,k-=a.scrollTop,l-=a.scrollLeft,a===e&&(k+=a.offsetTop,l+=a.offsetLeft,f.support.doesNotAddBorder&&(!f.support.doesAddBorderForTableAndCells||!cw.test(a.nodeName))&&(k+=parseFloat(d.borderTopWidth)||0,l+=parseFloat(d.borderLeftWidth)||0),g=e,e=a.offsetParent),f.support.subtractsBorderForOverflowNotVisible&&d.overflow!=="visible"&&(k+=parseFloat(d.borderTopWidth)||0,l+=parseFloat(d.borderLeftWidth)||0),j=d
}if(j.position==="relative"||j.position==="static"){k+=h.offsetTop,l+=h.offsetLeft}f.support.fixedPosition&&j.position==="fixed"&&(k+=Math.max(c.scrollTop,h.scrollTop),l+=Math.max(c.scrollLeft,h.scrollLeft));
return{top:k,left:l}},f.fn.offset=function(a){if(arguments.length){return a===b?this:this.each(function(b){f.offset.setOffset(this,a,b)
})}var c=this[0],d=c&&c.ownerDocument;if(!d){return null}if(c===d.body){return f.offset.bodyOffset(c)
}return cv(c,d,d.documentElement)},f.offset={bodyOffset:function(a){var b=a.offsetTop,c=a.offsetLeft;
f.support.doesNotIncludeMarginInBodyOffset&&(b+=parseFloat(f.css(a,"marginTop"))||0,c+=parseFloat(f.css(a,"marginLeft"))||0);
return{top:b,left:c}},setOffset:function(a,b,c){var d=f.css(a,"position");d==="static"&&(a.style.position="relative");
var e=f(a),g=e.offset(),h=f.css(a,"top"),i=f.css(a,"left"),j=(d==="absolute"||d==="fixed")&&f.inArray("auto",[h,i])>-1,k={},l={},m,n;
j?(l=e.position(),m=l.top,n=l.left):(m=parseFloat(h)||0,n=parseFloat(i)||0),f.isFunction(b)&&(b=b.call(a,c,g)),b.top!=null&&(k.top=b.top-g.top+m),b.left!=null&&(k.left=b.left-g.left+n),"using" in b?b.using.call(a,k):e.css(k)
}},f.fn.extend({position:function(){if(!this[0]){return null}var a=this[0],b=this.offsetParent(),c=this.offset(),d=cx.test(b[0].nodeName)?{top:0,left:0}:b.offset();
c.top-=parseFloat(f.css(a,"marginTop"))||0,c.left-=parseFloat(f.css(a,"marginLeft"))||0,d.top+=parseFloat(f.css(b[0],"borderTopWidth"))||0,d.left+=parseFloat(f.css(b[0],"borderLeftWidth"))||0;
return{top:c.top-d.top,left:c.left-d.left}},offsetParent:function(){return this.map(function(){var a=this.offsetParent||c.body;
while(a&&!cx.test(a.nodeName)&&f.css(a,"position")==="static"){a=a.offsetParent}return a})}}),f.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(a,c){var d=/Y/.test(c);
f.fn[a]=function(e){return f.access(this,function(a,e,g){var h=cy(a);if(g===b){return h?c in h?h[c]:f.support.boxModel&&h.document.documentElement[e]||h.document.body[e]:a[e]
}h?h.scrollTo(d?f(h).scrollLeft():g,d?g:f(h).scrollTop()):a[e]=g},a,e,arguments.length,null)}}),f.each({Height:"height",Width:"width"},function(a,c){var d="client"+a,e="scroll"+a,g="offset"+a;
f.fn["inner"+a]=function(){var a=this[0];return a?a.style?parseFloat(f.css(a,c,"padding")):this[c]():null
},f.fn["outer"+a]=function(a){var b=this[0];return b?b.style?parseFloat(f.css(b,c,a?"margin":"border")):this[c]():null
},f.fn[c]=function(a){return f.access(this,function(a,c,h){var i,j,k,l;if(f.isWindow(a)){i=a.document,j=i.documentElement[d];
return f.support.boxModel&&j||i.body&&i.body[d]||j}if(a.nodeType===9){i=a.documentElement;if(i[d]>=i[e]){return i[d]
}return Math.max(a.body[e],i[e],a.body[g],i[g])}if(h===b){k=f.css(a,c),l=parseFloat(k);return f.isNumeric(l)?l:k
}f(a).css(c,h)},c,a,arguments.length,null)}}),a.jQuery=a.$=f,typeof define=="function"&&define.amd&&define.amd.jQuery&&define("jquery",[],function(){return f
})})(window);(function($,h,c){var a=$([]),e=$.resize=$.extend($.resize,{}),i,k="setTimeout",j="resize",d=j+"-special-event",b="delay",f="throttleWindow";
e[b]=250;e[f]=true;$.event.special[j]={setup:function(){if(!e[f]&&this[k]){return false}var l=$(this);
a=a.add(l);$.data(this,d,{w:l.width(),h:l.height()});if(a.length===1){g()}},teardown:function(){if(!e[f]&&this[k]){return false
}var l=$(this);a=a.not(l);l.removeData(d);if(!a.length){clearTimeout(i)}},add:function(l){if(!e[f]&&this[k]){return false
}var n;function m(s,o,p){var q=$(this),r=$.data(this,d);r.w=o!==c?o:q.width();r.h=p!==c?p:q.height();
n.apply(this,arguments)}if($.isFunction(l)){n=l;return m}else{n=l.handler;l.handler=m}}};function g(){i=h[k](function(){a.each(function(){var n=$(this),m=n.width(),l=n.height(),o=$.data(this,d);
if(m!==o.w||l!==o.h){n.trigger(j,[o.w=m,o.h=l])}});g()},e[b])}})(jQuery,this);
/*! jQuery UI - v1.9.2 - 2013-04-03
* http://jqueryui.com
* Includes: jquery.ui.core.js, jquery.ui.widget.js, jquery.ui.mouse.js, jquery.ui.position.js, jquery.ui.draggable.js, jquery.ui.droppable.js, jquery.ui.resizable.js, jquery.ui.selectable.js, jquery.ui.sortable.js, jquery.ui.autocomplete.js, jquery.ui.button.js, jquery.ui.datepicker.js, jquery.ui.menu.js, jquery.ui.progressbar.js, jquery.ui.slider.js, jquery.ui.effect.js, jquery.ui.effect-bounce.js, jquery.ui.effect-drop.js, jquery.ui.effect-fade.js, jquery.ui.effect-pulsate.js, jquery.ui.effect-shake.js, jquery.ui.effect-slide.js, jquery.ui.effect-transfer.js
* Copyright 2013 jQuery Foundation and other contributors Licensed MIT */
(function(e,t){function i(t,n){var r,i,o,u=t.nodeName.toLowerCase();
return"area"===u?(r=t.parentNode,i=r.name,!t.href||!i||r.nodeName.toLowerCase()!=="map"?!1:(o=e("img[usemap=#"+i+"]")[0],!!o&&s(o))):(/input|select|textarea|button|object/.test(u)?!t.disabled:"a"===u?t.href||n:n)&&s(t)
}function s(t){return e.expr.filters.visible(t)&&!e(t).parents().andSelf().filter(function(){return e.css(this,"visibility")==="hidden"
}).length}var n=0,r=/^ui-id-\d+$/;e.ui=e.ui||{};if(e.ui.version){return}e.extend(e.ui,{version:"1.9.2",keyCode:{BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38}}),e.fn.extend({_focus:e.fn.focus,focus:function(t,n){return typeof t=="number"?this.each(function(){var r=this;
setTimeout(function(){e(r).focus(),n&&n.call(r)},t)}):this._focus.apply(this,arguments)},scrollParent:function(){var t;
return e.ui.ie&&/(static|relative)/.test(this.css("position"))||/absolute/.test(this.css("position"))?t=this.parents().filter(function(){return/(relative|absolute|fixed)/.test(e.css(this,"position"))&&/(auto|scroll)/.test(e.css(this,"overflow")+e.css(this,"overflow-y")+e.css(this,"overflow-x"))
}).eq(0):t=this.parents().filter(function(){return/(auto|scroll)/.test(e.css(this,"overflow")+e.css(this,"overflow-y")+e.css(this,"overflow-x"))
}).eq(0),/fixed/.test(this.css("position"))||!t.length?e(document):t},zIndex:function(n){if(n!==t){return this.css("zIndex",n)
}if(this.length){var r=e(this[0]),i,s;while(r.length&&r[0]!==document){i=r.css("position");if(i==="absolute"||i==="relative"||i==="fixed"){s=parseInt(r.css("zIndex"),10);
if(!isNaN(s)&&s!==0){return s}}r=r.parent()}}return 0},uniqueId:function(){return this.each(function(){this.id||(this.id="ui-id-"+ ++n)
})},removeUniqueId:function(){return this.each(function(){r.test(this.id)&&e(this).removeAttr("id")})
}}),e.extend(e.expr[":"],{data:e.expr.createPseudo?e.expr.createPseudo(function(t){return function(n){return !!e.data(n,t)
}}):function(t,n,r){return !!e.data(t,r[3])},focusable:function(t){return i(t,!isNaN(e.attr(t,"tabindex")))
},tabbable:function(t){var n=e.attr(t,"tabindex"),r=isNaN(n);return(r||n>=0)&&i(t,!r)}}),e(function(){var t=document.body,n=t.appendChild(n=document.createElement("div"));
n.offsetHeight,e.extend(n.style,{minHeight:"100px",height:"auto",padding:0,borderWidth:0}),e.support.minHeight=n.offsetHeight===100,e.support.selectstart="onselectstart" in n,t.removeChild(n).style.display="none"
}),e("<a>").outerWidth(1).jquery||e.each(["Width","Height"],function(n,r){function u(t,n,r,s){return e.each(i,function(){n-=parseFloat(e.css(t,"padding"+this))||0,r&&(n-=parseFloat(e.css(t,"border"+this+"Width"))||0),s&&(n-=parseFloat(e.css(t,"margin"+this))||0)
}),n}var i=r==="Width"?["Left","Right"]:["Top","Bottom"],s=r.toLowerCase(),o={innerWidth:e.fn.innerWidth,innerHeight:e.fn.innerHeight,outerWidth:e.fn.outerWidth,outerHeight:e.fn.outerHeight};
e.fn["inner"+r]=function(n){return n===t?o["inner"+r].call(this):this.each(function(){e(this).css(s,u(this,n)+"px")
})},e.fn["outer"+r]=function(t,n){return typeof t!="number"?o["outer"+r].call(this,t):this.each(function(){e(this).css(s,u(this,t,!0,n)+"px")
})}}),e("<a>").data("a-b","a").removeData("a-b").data("a-b")&&(e.fn.removeData=function(t){return function(n){return arguments.length?t.call(this,e.camelCase(n)):t.call(this)
}}(e.fn.removeData)),function(){var t=/msie ([\w.]+)/.exec(navigator.userAgent.toLowerCase())||[];e.ui.ie=t.length?!0:!1,e.ui.ie6=parseFloat(t[1],10)===6
}(),e.fn.extend({disableSelection:function(){return this.bind((e.support.selectstart?"selectstart":"mousedown")+".ui-disableSelection",function(e){e.preventDefault()
})},enableSelection:function(){return this.unbind(".ui-disableSelection")}}),e.extend(e.ui,{plugin:{add:function(t,n,r){var i,s=e.ui[t].prototype;
for(i in r){s.plugins[i]=s.plugins[i]||[],s.plugins[i].push([n,r[i]])}},call:function(e,t,n){var r,i=e.plugins[t];
if(!i||!e.element[0].parentNode||e.element[0].parentNode.nodeType===11){return}for(r=0;r<i.length;r++){e.options[i[r][0]]&&i[r][1].apply(e.element,n)
}}},contains:e.contains,hasScroll:function(t,n){if(e(t).css("overflow")==="hidden"){return !1}var r=n&&n==="left"?"scrollLeft":"scrollTop",i=!1;
return t[r]>0?!0:(t[r]=1,i=t[r]>0,t[r]=0,i)},isOverAxis:function(e,t,n){return e>t&&e<t+n},isOver:function(t,n,r,i,s,o){return e.ui.isOverAxis(t,r,s)&&e.ui.isOverAxis(n,i,o)
}})})(jQuery);(function(e,t){var n=0,r=Array.prototype.slice,i=e.cleanData;e.cleanData=function(t){for(var n=0,r;
(r=t[n])!=null;n++){try{e(r).triggerHandler("remove")}catch(s){}}i(t)},e.widget=function(t,n,r){var i,s,o,u,a=t.split(".")[0];
t=t.split(".")[1],i=a+"-"+t,r||(r=n,n=e.Widget),e.expr[":"][i.toLowerCase()]=function(t){return !!e.data(t,i)
},e[a]=e[a]||{},s=e[a][t],o=e[a][t]=function(e,t){if(!this._createWidget){return new o(e,t)}arguments.length&&this._createWidget(e,t)
},e.extend(o,s,{version:r.version,_proto:e.extend({},r),_childConstructors:[]}),u=new n,u.options=e.widget.extend({},u.options),e.each(r,function(t,i){e.isFunction(i)&&(r[t]=function(){var e=function(){return n.prototype[t].apply(this,arguments)
},r=function(e){return n.prototype[t].apply(this,e)};return function(){var t=this._super,n=this._superApply,s;
return this._super=e,this._superApply=r,s=i.apply(this,arguments),this._super=t,this._superApply=n,s}
}())}),o.prototype=e.widget.extend(u,{widgetEventPrefix:s?u.widgetEventPrefix:t},r,{constructor:o,namespace:a,widgetName:t,widgetBaseClass:i,widgetFullName:i}),s?(e.each(s._childConstructors,function(t,n){var r=n.prototype;
e.widget(r.namespace+"."+r.widgetName,o,n._proto)}),delete s._childConstructors):n._childConstructors.push(o),e.widget.bridge(t,o)
},e.widget.extend=function(n){var i=r.call(arguments,1),s=0,o=i.length,u,a;for(;s<o;s++){for(u in i[s]){a=i[s][u],i[s].hasOwnProperty(u)&&a!==t&&(e.isPlainObject(a)?n[u]=e.isPlainObject(n[u])?e.widget.extend({},n[u],a):e.widget.extend({},a):n[u]=a)
}}return n},e.widget.bridge=function(n,i){var s=i.prototype.widgetFullName||n;e.fn[n]=function(o){var u=typeof o=="string",a=r.call(arguments,1),f=this;
return o=!u&&a.length?e.widget.extend.apply(null,[o].concat(a)):o,u?this.each(function(){var r,i=e.data(this,s);
if(!i){return e.error("cannot call methods on "+n+" prior to initialization; "+"attempted to call method '"+o+"'")
}if(!e.isFunction(i[o])||o.charAt(0)==="_"){return e.error("no such method '"+o+"' for "+n+" widget instance")
}r=i[o].apply(i,a);if(r!==i&&r!==t){return f=r&&r.jquery?f.pushStack(r.get()):r,!1}}):this.each(function(){var t=e.data(this,s);
t?t.option(o||{})._init():e.data(this,s,new i(o,this))}),f}},e.Widget=function(){},e.Widget._childConstructors=[],e.Widget.prototype={widgetName:"widget",widgetEventPrefix:"",defaultElement:"<div>",options:{disabled:!1,create:null},_createWidget:function(t,r){r=e(r||this.defaultElement||this)[0],this.element=e(r),this.uuid=n++,this.eventNamespace="."+this.widgetName+this.uuid,this.options=e.widget.extend({},this.options,this._getCreateOptions(),t),this.bindings=e(),this.hoverable=e(),this.focusable=e(),r!==this&&(e.data(r,this.widgetName,this),e.data(r,this.widgetFullName,this),this._on(!0,this.element,{remove:function(e){e.target===r&&this.destroy()
}}),this.document=e(r.style?r.ownerDocument:r.document||r),this.window=e(this.document[0].defaultView||this.document[0].parentWindow)),this._create(),this._trigger("create",null,this._getCreateEventData()),this._init()
},_getCreateOptions:e.noop,_getCreateEventData:e.noop,_create:e.noop,_init:e.noop,destroy:function(){this._destroy(),this.element.unbind(this.eventNamespace).removeData(this.widgetName).removeData(this.widgetFullName).removeData(e.camelCase(this.widgetFullName)),this.widget().unbind(this.eventNamespace).removeAttr("aria-disabled").removeClass(this.widgetFullName+"-disabled "+"ui-state-disabled"),this.bindings.unbind(this.eventNamespace),this.hoverable.removeClass("ui-state-hover"),this.focusable.removeClass("ui-state-focus")
},_destroy:e.noop,widget:function(){return this.element},option:function(n,r){var i=n,s,o,u;if(arguments.length===0){return e.widget.extend({},this.options)
}if(typeof n=="string"){i={},s=n.split("."),n=s.shift();if(s.length){o=i[n]=e.widget.extend({},this.options[n]);
for(u=0;u<s.length-1;u++){o[s[u]]=o[s[u]]||{},o=o[s[u]]}n=s.pop();if(r===t){return o[n]===t?null:o[n]
}o[n]=r}else{if(r===t){return this.options[n]===t?null:this.options[n]}i[n]=r}}return this._setOptions(i),this
},_setOptions:function(e){var t;for(t in e){this._setOption(t,e[t])}return this},_setOption:function(e,t){return this.options[e]=t,e==="disabled"&&(this.widget().toggleClass(this.widgetFullName+"-disabled ui-state-disabled",!!t).attr("aria-disabled",t),this.hoverable.removeClass("ui-state-hover"),this.focusable.removeClass("ui-state-focus")),this
},enable:function(){return this._setOption("disabled",!1)},disable:function(){return this._setOption("disabled",!0)
},_on:function(t,n,r){var i,s=this;typeof t!="boolean"&&(r=n,n=t,t=!1),r?(n=i=e(n),this.bindings=this.bindings.add(n)):(r=n,n=this.element,i=this.widget()),e.each(r,function(r,o){function u(){if(!t&&(s.options.disabled===!0||e(this).hasClass("ui-state-disabled"))){return
}return(typeof o=="string"?s[o]:o).apply(s,arguments)}typeof o!="string"&&(u.guid=o.guid=o.guid||u.guid||e.guid++);
var a=r.match(/^(\w+)\s*(.*)$/),f=a[1]+s.eventNamespace,l=a[2];l?i.delegate(l,f,u):n.bind(f,u)})},_off:function(e,t){t=(t||"").split(" ").join(this.eventNamespace+" ")+this.eventNamespace,e.unbind(t).undelegate(t)
},_delay:function(e,t){function n(){return(typeof e=="string"?r[e]:e).apply(r,arguments)}var r=this;return setTimeout(n,t||0)
},_hoverable:function(t){this.hoverable=this.hoverable.add(t),this._on(t,{mouseenter:function(t){e(t.currentTarget).addClass("ui-state-hover")
},mouseleave:function(t){e(t.currentTarget).removeClass("ui-state-hover")}})},_focusable:function(t){this.focusable=this.focusable.add(t),this._on(t,{focusin:function(t){e(t.currentTarget).addClass("ui-state-focus")
},focusout:function(t){e(t.currentTarget).removeClass("ui-state-focus")}})},_trigger:function(t,n,r){var i,s,o=this.options[t];
r=r||{},n=e.Event(n),n.type=(t===this.widgetEventPrefix?t:this.widgetEventPrefix+t).toLowerCase(),n.target=this.element[0],s=n.originalEvent;
if(s){for(i in s){i in n||(n[i]=s[i])}}return this.element.trigger(n,r),!(e.isFunction(o)&&o.apply(this.element[0],[n].concat(r))===!1||n.isDefaultPrevented())
}},e.each({show:"fadeIn",hide:"fadeOut"},function(t,n){e.Widget.prototype["_"+t]=function(r,i,s){typeof i=="string"&&(i={effect:i});
var o,u=i?i===!0||typeof i=="number"?n:i.effect||n:t;i=i||{},typeof i=="number"&&(i={duration:i}),o=!e.isEmptyObject(i),i.complete=s,i.delay&&r.delay(i.delay),o&&e.effects&&(e.effects.effect[u]||e.uiBackCompat!==!1&&e.effects[u])?r[t](i):u!==t&&r[u]?r[u](i.duration,i.easing,s):r.queue(function(n){e(this)[t](),s&&s.call(r[0]),n()
})}}),e.uiBackCompat!==!1&&(e.Widget.prototype._getCreateOptions=function(){return e.metadata&&e.metadata.get(this.element[0])[this.widgetName]
})})(jQuery);(function(e,t){var n=!1;e(document).mouseup(function(e){n=!1}),e.widget("ui.mouse",{version:"1.9.2",options:{cancel:"input,textarea,button,select,option",distance:1,delay:0},_mouseInit:function(){var t=this;
this.element.bind("mousedown."+this.widgetName,function(e){return t._mouseDown(e)}).bind("click."+this.widgetName,function(n){if(!0===e.data(n.target,t.widgetName+".preventClickEvent")){return e.removeData(n.target,t.widgetName+".preventClickEvent"),n.stopImmediatePropagation(),!1
}}),this.started=!1},_mouseDestroy:function(){this.element.unbind("."+this.widgetName),this._mouseMoveDelegate&&e(document).unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate)
},_mouseDown:function(t){if(n){return}this._mouseStarted&&this._mouseUp(t),this._mouseDownEvent=t;var r=this,i=t.which===1,s=typeof this.options.cancel=="string"&&t.target.nodeName?e(t.target).closest(this.options.cancel).length:!1;
if(!i||s||!this._mouseCapture(t)){return !0}this.mouseDelayMet=!this.options.delay,this.mouseDelayMet||(this._mouseDelayTimer=setTimeout(function(){r.mouseDelayMet=!0
},this.options.delay));if(this._mouseDistanceMet(t)&&this._mouseDelayMet(t)){this._mouseStarted=this._mouseStart(t)!==!1;
if(!this._mouseStarted){return t.preventDefault(),!0}}return !0===e.data(t.target,this.widgetName+".preventClickEvent")&&e.removeData(t.target,this.widgetName+".preventClickEvent"),this._mouseMoveDelegate=function(e){return r._mouseMove(e)
},this._mouseUpDelegate=function(e){return r._mouseUp(e)},e(document).bind("mousemove."+this.widgetName,this._mouseMoveDelegate).bind("mouseup."+this.widgetName,this._mouseUpDelegate),t.preventDefault(),n=!0,!0
},_mouseMove:function(t){return !e.ui.ie||document.documentMode>=9||!!t.button?this._mouseStarted?(this._mouseDrag(t),t.preventDefault()):(this._mouseDistanceMet(t)&&this._mouseDelayMet(t)&&(this._mouseStarted=this._mouseStart(this._mouseDownEvent,t)!==!1,this._mouseStarted?this._mouseDrag(t):this._mouseUp(t)),!this._mouseStarted):this._mouseUp(t)
},_mouseUp:function(t){return e(document).unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate),this._mouseStarted&&(this._mouseStarted=!1,t.target===this._mouseDownEvent.target&&e.data(t.target,this.widgetName+".preventClickEvent",!0),this._mouseStop(t)),!1
},_mouseDistanceMet:function(e){return Math.max(Math.abs(this._mouseDownEvent.pageX-e.pageX),Math.abs(this._mouseDownEvent.pageY-e.pageY))>=this.options.distance
},_mouseDelayMet:function(e){return this.mouseDelayMet},_mouseStart:function(e){},_mouseDrag:function(e){},_mouseStop:function(e){},_mouseCapture:function(e){return !0
}})})(jQuery);(function(e,t){function h(e,t,n){return[parseInt(e[0],10)*(l.test(e[0])?t/100:1),parseInt(e[1],10)*(l.test(e[1])?n/100:1)]
}function p(t,n){return parseInt(e.css(t,n),10)||0}e.ui=e.ui||{};var n,r=Math.max,i=Math.abs,s=Math.round,o=/left|center|right/,u=/top|center|bottom/,a=/[\+\-]\d+%?/,f=/^\w+/,l=/%$/,c=e.fn.position;
e.position={scrollbarWidth:function(){if(n!==t){return n}var r,i,s=e("<div style='display:block;width:50px;height:50px;overflow:hidden;'><div style='height:100px;width:auto;'></div></div>"),o=s.children()[0];
return e("body").append(s),r=o.offsetWidth,s.css("overflow","scroll"),i=o.offsetWidth,r===i&&(i=s[0].clientWidth),s.remove(),n=r-i
},getScrollInfo:function(t){var n=t.isWindow?"":t.element.css("overflow-x"),r=t.isWindow?"":t.element.css("overflow-y"),i=n==="scroll"||n==="auto"&&t.width<t.element[0].scrollWidth,s=r==="scroll"||r==="auto"&&t.height<t.element[0].scrollHeight;
return{width:i?e.position.scrollbarWidth():0,height:s?e.position.scrollbarWidth():0}},getWithinInfo:function(t){var n=e(t||window),r=e.isWindow(n[0]);
return{element:n,isWindow:r,offset:n.offset()||{left:0,top:0},scrollLeft:n.scrollLeft(),scrollTop:n.scrollTop(),width:r?n.width():n.outerWidth(),height:r?n.height():n.outerHeight()}
}},e.fn.position=function(t){if(!t||!t.of){return c.apply(this,arguments)}t=e.extend({},t);var n,l,d,v,m,g=e(t.of),y=e.position.getWithinInfo(t.within),b=e.position.getScrollInfo(y),w=g[0],E=(t.collision||"flip").split(" "),S={};
return w.nodeType===9?(l=g.width(),d=g.height(),v={top:0,left:0}):e.isWindow(w)?(l=g.width(),d=g.height(),v={top:g.scrollTop(),left:g.scrollLeft()}):w.preventDefault?(t.at="left top",l=d=0,v={top:w.pageY,left:w.pageX}):(l=g.outerWidth(),d=g.outerHeight(),v=g.offset()),m=e.extend({},v),e.each(["my","at"],function(){var e=(t[this]||"").split(" "),n,r;
e.length===1&&(e=o.test(e[0])?e.concat(["center"]):u.test(e[0])?["center"].concat(e):["center","center"]),e[0]=o.test(e[0])?e[0]:"center",e[1]=u.test(e[1])?e[1]:"center",n=a.exec(e[0]),r=a.exec(e[1]),S[this]=[n?n[0]:0,r?r[0]:0],t[this]=[f.exec(e[0])[0],f.exec(e[1])[0]]
}),E.length===1&&(E[1]=E[0]),t.at[0]==="right"?m.left+=l:t.at[0]==="center"&&(m.left+=l/2),t.at[1]==="bottom"?m.top+=d:t.at[1]==="center"&&(m.top+=d/2),n=h(S.at,l,d),m.left+=n[0],m.top+=n[1],this.each(function(){var o,u,a=e(this),f=a.outerWidth(),c=a.outerHeight(),w=p(this,"marginLeft"),x=p(this,"marginTop"),T=f+w+p(this,"marginRight")+b.width,N=c+x+p(this,"marginBottom")+b.height,C=e.extend({},m),k=h(S.my,a.outerWidth(),a.outerHeight());
t.my[0]==="right"?C.left-=f:t.my[0]==="center"&&(C.left-=f/2),t.my[1]==="bottom"?C.top-=c:t.my[1]==="center"&&(C.top-=c/2),C.left+=k[0],C.top+=k[1],e.support.offsetFractions||(C.left=s(C.left),C.top=s(C.top)),o={marginLeft:w,marginTop:x},e.each(["left","top"],function(r,i){e.ui.position[E[r]]&&e.ui.position[E[r]][i](C,{targetWidth:l,targetHeight:d,elemWidth:f,elemHeight:c,collisionPosition:o,collisionWidth:T,collisionHeight:N,offset:[n[0]+k[0],n[1]+k[1]],my:t.my,at:t.at,within:y,elem:a})
}),e.fn.bgiframe&&a.bgiframe(),t.using&&(u=function(e){var n=v.left-C.left,s=n+l-f,o=v.top-C.top,u=o+d-c,h={target:{element:g,left:v.left,top:v.top,width:l,height:d},element:{element:a,left:C.left,top:C.top,width:f,height:c},horizontal:s<0?"left":n>0?"right":"center",vertical:u<0?"top":o>0?"bottom":"middle"};
l<f&&i(n+s)<l&&(h.horizontal="center"),d<c&&i(o+u)<d&&(h.vertical="middle"),r(i(n),i(s))>r(i(o),i(u))?h.important="horizontal":h.important="vertical",t.using.call(this,e,h)
}),a.offset(e.extend(C,{using:u}))})},e.ui.position={fit:{left:function(e,t){var n=t.within,i=n.isWindow?n.scrollLeft:n.offset.left,s=n.width,o=e.left-t.collisionPosition.marginLeft,u=i-o,a=o+t.collisionWidth-s-i,f;
t.collisionWidth>s?u>0&&a<=0?(f=e.left+u+t.collisionWidth-s-i,e.left+=u-f):a>0&&u<=0?e.left=i:u>a?e.left=i+s-t.collisionWidth:e.left=i:u>0?e.left+=u:a>0?e.left-=a:e.left=r(e.left-o,e.left)
},top:function(e,t){var n=t.within,i=n.isWindow?n.scrollTop:n.offset.top,s=t.within.height,o=e.top-t.collisionPosition.marginTop,u=i-o,a=o+t.collisionHeight-s-i,f;
t.collisionHeight>s?u>0&&a<=0?(f=e.top+u+t.collisionHeight-s-i,e.top+=u-f):a>0&&u<=0?e.top=i:u>a?e.top=i+s-t.collisionHeight:e.top=i:u>0?e.top+=u:a>0?e.top-=a:e.top=r(e.top-o,e.top)
}},flip:{left:function(e,t){var n=t.within,r=n.offset.left+n.scrollLeft,s=n.width,o=n.isWindow?n.scrollLeft:n.offset.left,u=e.left-t.collisionPosition.marginLeft,a=u-o,f=u+t.collisionWidth-s-o,l=t.my[0]==="left"?-t.elemWidth:t.my[0]==="right"?t.elemWidth:0,c=t.at[0]==="left"?t.targetWidth:t.at[0]==="right"?-t.targetWidth:0,h=-2*t.offset[0],p,d;
if(a<0){p=e.left+l+c+h+t.collisionWidth-s-r;if(p<0||p<i(a)){e.left+=l+c+h}}else{if(f>0){d=e.left-t.collisionPosition.marginLeft+l+c+h-o;
if(d>0||i(d)<f){e.left+=l+c+h}}}},top:function(e,t){var n=t.within,r=n.offset.top+n.scrollTop,s=n.height,o=n.isWindow?n.scrollTop:n.offset.top,u=e.top-t.collisionPosition.marginTop,a=u-o,f=u+t.collisionHeight-s-o,l=t.my[1]==="top",c=l?-t.elemHeight:t.my[1]==="bottom"?t.elemHeight:0,h=t.at[1]==="top"?t.targetHeight:t.at[1]==="bottom"?-t.targetHeight:0,p=-2*t.offset[1],d,v;
a<0?(v=e.top+c+h+p+t.collisionHeight-s-r,e.top+c+h+p>a&&(v<0||v<i(a))&&(e.top+=c+h+p)):f>0&&(d=e.top-t.collisionPosition.marginTop+c+h+p-o,e.top+c+h+p>f&&(d>0||i(d)<f)&&(e.top+=c+h+p))
}},flipfit:{left:function(){e.ui.position.flip.left.apply(this,arguments),e.ui.position.fit.left.apply(this,arguments)
},top:function(){e.ui.position.flip.top.apply(this,arguments),e.ui.position.fit.top.apply(this,arguments)
}}},function(){var t,n,r,i,s,o=document.getElementsByTagName("body")[0],u=document.createElement("div");
t=document.createElement(o?"div":"body"),r={visibility:"hidden",width:0,height:0,border:0,margin:0,background:"none"},o&&e.extend(r,{position:"absolute",left:"-1000px",top:"-1000px"});
for(s in r){t.style[s]=r[s]}t.appendChild(u),n=o||document.documentElement,n.insertBefore(t,n.firstChild),u.style.cssText="position: absolute; left: 10.7432222px;",i=e(u).offset().left,e.support.offsetFractions=i>10&&i<11,t.innerHTML="",n.removeChild(t)
}(),e.uiBackCompat!==!1&&function(e){var n=e.fn.position;e.fn.position=function(r){if(!r||!r.offset){return n.call(this,r)
}var i=r.offset.split(" "),s=r.at.split(" ");return i.length===1&&(i[1]=i[0]),/^\d/.test(i[0])&&(i[0]="+"+i[0]),/^\d/.test(i[1])&&(i[1]="+"+i[1]),s.length===1&&(/left|center|right/.test(s[0])?s[1]="center":(s[1]=s[0],s[0]="center")),n.call(this,e.extend(r,{at:s[0]+i[0]+" "+s[1]+i[1],offset:t}))
}}(jQuery)})(jQuery);(function(e,t){e.widget("ui.draggable",e.ui.mouse,{version:"1.9.2",widgetEventPrefix:"drag",options:{addClasses:!0,appendTo:"parent",axis:!1,connectToSortable:!1,containment:!1,cursor:"auto",cursorAt:!1,grid:!1,handle:!1,helper:"original",iframeFix:!1,opacity:!1,refreshPositions:!1,revert:!1,revertDuration:500,scope:"default",scroll:!0,scrollSensitivity:20,scrollSpeed:20,snap:!1,snapMode:"both",snapTolerance:20,stack:!1,zIndex:!1},_create:function(){this.options.helper=="original"&&!/^(?:r|a|f)/.test(this.element.css("position"))&&(this.element[0].style.position="relative"),this.options.addClasses&&this.element.addClass("ui-draggable"),this.options.disabled&&this.element.addClass("ui-draggable-disabled"),this._mouseInit()
},_destroy:function(){this.element.removeClass("ui-draggable ui-draggable-dragging ui-draggable-disabled"),this._mouseDestroy()
},_mouseCapture:function(t){var n=this.options;return this.helper||n.disabled||e(t.target).is(".ui-resizable-handle")?!1:(this.handle=this._getHandle(t),this.handle?(e(n.iframeFix===!0?"iframe":n.iframeFix).each(function(){e('<div class="ui-draggable-iframeFix" style="background: #fff;"></div>').css({width:this.offsetWidth+"px",height:this.offsetHeight+"px",position:"absolute",opacity:"0.001",zIndex:1000}).css(e(this).offset()).appendTo("body")
}),!0):!1)},_mouseStart:function(t){var n=this.options;return this.helper=this._createHelper(t),this.helper.addClass("ui-draggable-dragging"),this._cacheHelperProportions(),e.ui.ddmanager&&(e.ui.ddmanager.current=this),this._cacheMargins(),this.cssPosition=this.helper.css("position"),this.scrollParent=this.helper.scrollParent(),this.offset=this.positionAbs=this.element.offset(),this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left},e.extend(this.offset,{click:{left:t.pageX-this.offset.left,top:t.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()}),this.originalPosition=this.position=this._generatePosition(t),this.originalPageX=t.pageX,this.originalPageY=t.pageY,n.cursorAt&&this._adjustOffsetFromHelper(n.cursorAt),n.containment&&this._setContainment(),this._trigger("start",t)===!1?(this._clear(),!1):(this._cacheHelperProportions(),e.ui.ddmanager&&!n.dropBehaviour&&e.ui.ddmanager.prepareOffsets(this,t),this._mouseDrag(t,!0),e.ui.ddmanager&&e.ui.ddmanager.dragStart(this,t),!0)
},_mouseDrag:function(t,n){this.position=this._generatePosition(t),this.positionAbs=this._convertPositionTo("absolute");
if(!n){var r=this._uiHash();if(this._trigger("drag",t,r)===!1){return this._mouseUp({}),!1}this.position=r.position
}if(!this.options.axis||this.options.axis!="y"){this.helper[0].style.left=this.position.left+"px"}if(!this.options.axis||this.options.axis!="x"){this.helper[0].style.top=this.position.top+"px"
}return e.ui.ddmanager&&e.ui.ddmanager.drag(this,t),!1},_mouseStop:function(t){var n=!1;e.ui.ddmanager&&!this.options.dropBehaviour&&(n=e.ui.ddmanager.drop(this,t)),this.dropped&&(n=this.dropped,this.dropped=!1);
var r=this.element[0],i=!1;while(r&&(r=r.parentNode)){r==document&&(i=!0)}if(!i&&this.options.helper==="original"){return !1
}if(this.options.revert=="invalid"&&!n||this.options.revert=="valid"&&n||this.options.revert===!0||e.isFunction(this.options.revert)&&this.options.revert.call(this.element,n)){var s=this;
e(this.helper).animate(this.originalPosition,parseInt(this.options.revertDuration,10),function(){s._trigger("stop",t)!==!1&&s._clear()
})}else{this._trigger("stop",t)!==!1&&this._clear()}return !1},_mouseUp:function(t){return e("div.ui-draggable-iframeFix").each(function(){this.parentNode.removeChild(this)
}),e.ui.ddmanager&&e.ui.ddmanager.dragStop(this,t),e.ui.mouse.prototype._mouseUp.call(this,t)},cancel:function(){return this.helper.is(".ui-draggable-dragging")?this._mouseUp({}):this._clear(),this
},_getHandle:function(t){var n=!this.options.handle||!e(this.options.handle,this.element).length?!0:!1;
return e(this.options.handle,this.element).find("*").andSelf().each(function(){this==t.target&&(n=!0)
}),n},_createHelper:function(t){var n=this.options,r=e.isFunction(n.helper)?e(n.helper.apply(this.element[0],[t])):n.helper=="clone"?this.element.clone().removeAttr("id"):this.element;
return r.parents("body").length||r.appendTo(n.appendTo=="parent"?this.element[0].parentNode:n.appendTo),r[0]!=this.element[0]&&!/(fixed|absolute)/.test(r.css("position"))&&r.css("position","absolute"),r
},_adjustOffsetFromHelper:function(t){typeof t=="string"&&(t=t.split(" ")),e.isArray(t)&&(t={left:+t[0],top:+t[1]||0}),"left" in t&&(this.offset.click.left=t.left+this.margins.left),"right" in t&&(this.offset.click.left=this.helperProportions.width-t.right+this.margins.left),"top" in t&&(this.offset.click.top=t.top+this.margins.top),"bottom" in t&&(this.offset.click.top=this.helperProportions.height-t.bottom+this.margins.top)
},_getParentOffset:function(){this.offsetParent=this.helper.offsetParent();var t=this.offsetParent.offset();
this.cssPosition=="absolute"&&this.scrollParent[0]!=document&&e.contains(this.scrollParent[0],this.offsetParent[0])&&(t.left+=this.scrollParent.scrollLeft(),t.top+=this.scrollParent.scrollTop());
if(this.offsetParent[0]==document.body||this.offsetParent[0].tagName&&this.offsetParent[0].tagName.toLowerCase()=="html"&&e.ui.ie){t={top:0,left:0}
}return{top:t.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:t.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}
},_getRelativeOffset:function(){if(this.cssPosition=="relative"){var e=this.element.position();return{top:e.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:e.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()}
}return{top:0,left:0}},_cacheMargins:function(){this.margins={left:parseInt(this.element.css("marginLeft"),10)||0,top:parseInt(this.element.css("marginTop"),10)||0,right:parseInt(this.element.css("marginRight"),10)||0,bottom:parseInt(this.element.css("marginBottom"),10)||0}
},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}
},_setContainment:function(){var t=this.options;t.containment=="parent"&&(t.containment=this.helper[0].parentNode);
if(t.containment=="document"||t.containment=="window"){this.containment=[t.containment=="document"?0:e(window).scrollLeft()-this.offset.relative.left-this.offset.parent.left,t.containment=="document"?0:e(window).scrollTop()-this.offset.relative.top-this.offset.parent.top,(t.containment=="document"?0:e(window).scrollLeft())+e(t.containment=="document"?document:window).width()-this.helperProportions.width-this.margins.left,(t.containment=="document"?0:e(window).scrollTop())+(e(t.containment=="document"?document:window).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]
}if(!/^(document|window|parent)$/.test(t.containment)&&t.containment.constructor!=Array){var n=e(t.containment),r=n[0];
if(!r){return}var i=n.offset(),s=e(r).css("overflow")!="hidden";this.containment=[(parseInt(e(r).css("borderLeftWidth"),10)||0)+(parseInt(e(r).css("paddingLeft"),10)||0),(parseInt(e(r).css("borderTopWidth"),10)||0)+(parseInt(e(r).css("paddingTop"),10)||0),(s?Math.max(r.scrollWidth,r.offsetWidth):r.offsetWidth)-(parseInt(e(r).css("borderLeftWidth"),10)||0)-(parseInt(e(r).css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left-this.margins.right,(s?Math.max(r.scrollHeight,r.offsetHeight):r.offsetHeight)-(parseInt(e(r).css("borderTopWidth"),10)||0)-(parseInt(e(r).css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top-this.margins.bottom],this.relative_container=n
}else{t.containment.constructor==Array&&(this.containment=t.containment)}},_convertPositionTo:function(t,n){n||(n=this.position);
var r=t=="absolute"?1:-1,i=this.options,s=this.cssPosition!="absolute"||this.scrollParent[0]!=document&&!!e.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,o=/(html|body)/i.test(s[0].tagName);
return{top:n.top+this.offset.relative.top*r+this.offset.parent.top*r-(this.cssPosition=="fixed"?-this.scrollParent.scrollTop():o?0:s.scrollTop())*r,left:n.left+this.offset.relative.left*r+this.offset.parent.left*r-(this.cssPosition=="fixed"?-this.scrollParent.scrollLeft():o?0:s.scrollLeft())*r}
},_generatePosition:function(t){var n=this.options,r=this.cssPosition!="absolute"||this.scrollParent[0]!=document&&!!e.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,i=/(html|body)/i.test(r[0].tagName),s=t.pageX,o=t.pageY;
if(this.originalPosition){var u;if(this.containment){if(this.relative_container){var a=this.relative_container.offset();
u=[this.containment[0]+a.left,this.containment[1]+a.top,this.containment[2]+a.left,this.containment[3]+a.top]
}else{u=this.containment}t.pageX-this.offset.click.left<u[0]&&(s=u[0]+this.offset.click.left),t.pageY-this.offset.click.top<u[1]&&(o=u[1]+this.offset.click.top),t.pageX-this.offset.click.left>u[2]&&(s=u[2]+this.offset.click.left),t.pageY-this.offset.click.top>u[3]&&(o=u[3]+this.offset.click.top)
}if(n.grid){var f=n.grid[1]?this.originalPageY+Math.round((o-this.originalPageY)/n.grid[1])*n.grid[1]:this.originalPageY;
o=u?f-this.offset.click.top<u[1]||f-this.offset.click.top>u[3]?f-this.offset.click.top<u[1]?f+n.grid[1]:f-n.grid[1]:f:f;
var l=n.grid[0]?this.originalPageX+Math.round((s-this.originalPageX)/n.grid[0])*n.grid[0]:this.originalPageX;
s=u?l-this.offset.click.left<u[0]||l-this.offset.click.left>u[2]?l-this.offset.click.left<u[0]?l+n.grid[0]:l-n.grid[0]:l:l
}}return{top:o-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+(this.cssPosition=="fixed"?-this.scrollParent.scrollTop():i?0:r.scrollTop()),left:s-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+(this.cssPosition=="fixed"?-this.scrollParent.scrollLeft():i?0:r.scrollLeft())}
},_clear:function(){this.helper.removeClass("ui-draggable-dragging"),this.helper[0]!=this.element[0]&&!this.cancelHelperRemoval&&this.helper.remove(),this.helper=null,this.cancelHelperRemoval=!1
},_trigger:function(t,n,r){return r=r||this._uiHash(),e.ui.plugin.call(this,t,[n,r]),t=="drag"&&(this.positionAbs=this._convertPositionTo("absolute")),e.Widget.prototype._trigger.call(this,t,n,r)
},plugins:{},_uiHash:function(e){return{helper:this.helper,position:this.position,originalPosition:this.originalPosition,offset:this.positionAbs}
}}),e.ui.plugin.add("draggable","connectToSortable",{start:function(t,n){var r=e(this).data("draggable"),i=r.options,s=e.extend({},n,{item:r.element});
r.sortables=[],e(i.connectToSortable).each(function(){var n=e.data(this,"sortable");n&&!n.options.disabled&&(r.sortables.push({instance:n,shouldRevert:n.options.revert}),n.refreshPositions(),n._trigger("activate",t,s))
})},stop:function(t,n){var r=e(this).data("draggable"),i=e.extend({},n,{item:r.element});e.each(r.sortables,function(){this.instance.isOver?(this.instance.isOver=0,r.cancelHelperRemoval=!0,this.instance.cancelHelperRemoval=!1,this.shouldRevert&&(this.instance.options.revert=!0),this.instance._mouseStop(t),this.instance.options.helper=this.instance.options._helper,r.options.helper=="original"&&this.instance.currentItem.css({top:"auto",left:"auto"})):(this.instance.cancelHelperRemoval=!1,this.instance._trigger("deactivate",t,i))
})},drag:function(t,n){var r=e(this).data("draggable"),i=this,s=function(t){var n=this.offset.click.top,r=this.offset.click.left,i=this.positionAbs.top,s=this.positionAbs.left,o=t.height,u=t.width,a=t.top,f=t.left;
return e.ui.isOver(i+n,s+r,a,f,o,u)};e.each(r.sortables,function(s){var o=!1,u=this;this.instance.positionAbs=r.positionAbs,this.instance.helperProportions=r.helperProportions,this.instance.offset.click=r.offset.click,this.instance._intersectsWith(this.instance.containerCache)&&(o=!0,e.each(r.sortables,function(){return this.instance.positionAbs=r.positionAbs,this.instance.helperProportions=r.helperProportions,this.instance.offset.click=r.offset.click,this!=u&&this.instance._intersectsWith(this.instance.containerCache)&&e.ui.contains(u.instance.element[0],this.instance.element[0])&&(o=!1),o
})),o?(this.instance.isOver||(this.instance.isOver=1,this.instance.currentItem=e(i).clone().removeAttr("id").appendTo(this.instance.element).data("sortable-item",!0),this.instance.options._helper=this.instance.options.helper,this.instance.options.helper=function(){return n.helper[0]
},t.target=this.instance.currentItem[0],this.instance._mouseCapture(t,!0),this.instance._mouseStart(t,!0,!0),this.instance.offset.click.top=r.offset.click.top,this.instance.offset.click.left=r.offset.click.left,this.instance.offset.parent.left-=r.offset.parent.left-this.instance.offset.parent.left,this.instance.offset.parent.top-=r.offset.parent.top-this.instance.offset.parent.top,r._trigger("toSortable",t),r.dropped=this.instance.element,r.currentItem=r.element,this.instance.fromOutside=r),this.instance.currentItem&&this.instance._mouseDrag(t)):this.instance.isOver&&(this.instance.isOver=0,this.instance.cancelHelperRemoval=!0,this.instance.options.revert=!1,this.instance._trigger("out",t,this.instance._uiHash(this.instance)),this.instance._mouseStop(t,!0),this.instance.options.helper=this.instance.options._helper,this.instance.currentItem.remove(),this.instance.placeholder&&this.instance.placeholder.remove(),r._trigger("fromSortable",t),r.dropped=!1)
})}}),e.ui.plugin.add("draggable","cursor",{start:function(t,n){var r=e("body"),i=e(this).data("draggable").options;
r.css("cursor")&&(i._cursor=r.css("cursor")),r.css("cursor",i.cursor)},stop:function(t,n){var r=e(this).data("draggable").options;
r._cursor&&e("body").css("cursor",r._cursor)}}),e.ui.plugin.add("draggable","opacity",{start:function(t,n){var r=e(n.helper),i=e(this).data("draggable").options;
r.css("opacity")&&(i._opacity=r.css("opacity")),r.css("opacity",i.opacity)},stop:function(t,n){var r=e(this).data("draggable").options;
r._opacity&&e(n.helper).css("opacity",r._opacity)}}),e.ui.plugin.add("draggable","scroll",{start:function(t,n){var r=e(this).data("draggable");
r.scrollParent[0]!=document&&r.scrollParent[0].tagName!="HTML"&&(r.overflowOffset=r.scrollParent.offset())
},drag:function(t,n){var r=e(this).data("draggable"),i=r.options,s=!1;if(r.scrollParent[0]!=document&&r.scrollParent[0].tagName!="HTML"){if(!i.axis||i.axis!="x"){r.overflowOffset.top+r.scrollParent[0].offsetHeight-t.pageY<i.scrollSensitivity?r.scrollParent[0].scrollTop=s=r.scrollParent[0].scrollTop+i.scrollSpeed:t.pageY-r.overflowOffset.top<i.scrollSensitivity&&(r.scrollParent[0].scrollTop=s=r.scrollParent[0].scrollTop-i.scrollSpeed)
}if(!i.axis||i.axis!="y"){r.overflowOffset.left+r.scrollParent[0].offsetWidth-t.pageX<i.scrollSensitivity?r.scrollParent[0].scrollLeft=s=r.scrollParent[0].scrollLeft+i.scrollSpeed:t.pageX-r.overflowOffset.left<i.scrollSensitivity&&(r.scrollParent[0].scrollLeft=s=r.scrollParent[0].scrollLeft-i.scrollSpeed)
}}else{if(!i.axis||i.axis!="x"){t.pageY-e(document).scrollTop()<i.scrollSensitivity?s=e(document).scrollTop(e(document).scrollTop()-i.scrollSpeed):e(window).height()-(t.pageY-e(document).scrollTop())<i.scrollSensitivity&&(s=e(document).scrollTop(e(document).scrollTop()+i.scrollSpeed))
}if(!i.axis||i.axis!="y"){t.pageX-e(document).scrollLeft()<i.scrollSensitivity?s=e(document).scrollLeft(e(document).scrollLeft()-i.scrollSpeed):e(window).width()-(t.pageX-e(document).scrollLeft())<i.scrollSensitivity&&(s=e(document).scrollLeft(e(document).scrollLeft()+i.scrollSpeed))
}}s!==!1&&e.ui.ddmanager&&!i.dropBehaviour&&e.ui.ddmanager.prepareOffsets(r,t)}}),e.ui.plugin.add("draggable","snap",{start:function(t,n){var r=e(this).data("draggable"),i=r.options;
r.snapElements=[],e(i.snap.constructor!=String?i.snap.items||":data(draggable)":i.snap).each(function(){var t=e(this),n=t.offset();
this!=r.element[0]&&r.snapElements.push({item:this,width:t.outerWidth(),height:t.outerHeight(),top:n.top,left:n.left})
})},drag:function(t,n){var r=e(this).data("draggable"),i=r.options,s=i.snapTolerance,o=n.offset.left,u=o+r.helperProportions.width,a=n.offset.top,f=a+r.helperProportions.height;
for(var l=r.snapElements.length-1;l>=0;l--){var c=r.snapElements[l].left,h=c+r.snapElements[l].width,p=r.snapElements[l].top,d=p+r.snapElements[l].height;
if(!(c-s<o&&o<h+s&&p-s<a&&a<d+s||c-s<o&&o<h+s&&p-s<f&&f<d+s||c-s<u&&u<h+s&&p-s<a&&a<d+s||c-s<u&&u<h+s&&p-s<f&&f<d+s)){r.snapElements[l].snapping&&r.options.snap.release&&r.options.snap.release.call(r.element,t,e.extend(r._uiHash(),{snapItem:r.snapElements[l].item})),r.snapElements[l].snapping=!1;
continue}if(i.snapMode!="inner"){var v=Math.abs(p-f)<=s,m=Math.abs(d-a)<=s,g=Math.abs(c-u)<=s,y=Math.abs(h-o)<=s;
v&&(n.position.top=r._convertPositionTo("relative",{top:p-r.helperProportions.height,left:0}).top-r.margins.top),m&&(n.position.top=r._convertPositionTo("relative",{top:d,left:0}).top-r.margins.top),g&&(n.position.left=r._convertPositionTo("relative",{top:0,left:c-r.helperProportions.width}).left-r.margins.left),y&&(n.position.left=r._convertPositionTo("relative",{top:0,left:h}).left-r.margins.left)
}var b=v||m||g||y;if(i.snapMode!="outer"){var v=Math.abs(p-a)<=s,m=Math.abs(d-f)<=s,g=Math.abs(c-o)<=s,y=Math.abs(h-u)<=s;
v&&(n.position.top=r._convertPositionTo("relative",{top:p,left:0}).top-r.margins.top),m&&(n.position.top=r._convertPositionTo("relative",{top:d-r.helperProportions.height,left:0}).top-r.margins.top),g&&(n.position.left=r._convertPositionTo("relative",{top:0,left:c}).left-r.margins.left),y&&(n.position.left=r._convertPositionTo("relative",{top:0,left:h-r.helperProportions.width}).left-r.margins.left)
}!r.snapElements[l].snapping&&(v||m||g||y||b)&&r.options.snap.snap&&r.options.snap.snap.call(r.element,t,e.extend(r._uiHash(),{snapItem:r.snapElements[l].item})),r.snapElements[l].snapping=v||m||g||y||b
}}}),e.ui.plugin.add("draggable","stack",{start:function(t,n){var r=e(this).data("draggable").options,i=e.makeArray(e(r.stack)).sort(function(t,n){return(parseInt(e(t).css("zIndex"),10)||0)-(parseInt(e(n).css("zIndex"),10)||0)
});if(!i.length){return}var s=parseInt(i[0].style.zIndex)||0;e(i).each(function(e){this.style.zIndex=s+e
}),this[0].style.zIndex=s+i.length}}),e.ui.plugin.add("draggable","zIndex",{start:function(t,n){var r=e(n.helper),i=e(this).data("draggable").options;
r.css("zIndex")&&(i._zIndex=r.css("zIndex")),r.css("zIndex",i.zIndex)},stop:function(t,n){var r=e(this).data("draggable").options;
r._zIndex&&e(n.helper).css("zIndex",r._zIndex)}})})(jQuery);(function(e,t){e.widget("ui.droppable",{version:"1.9.2",widgetEventPrefix:"drop",options:{accept:"*",activeClass:!1,addClasses:!0,greedy:!1,hoverClass:!1,scope:"default",tolerance:"intersect"},_create:function(){var t=this.options,n=t.accept;
this.isover=0,this.isout=1,this.accept=e.isFunction(n)?n:function(e){return e.is(n)},this.proportions={width:this.element[0].offsetWidth,height:this.element[0].offsetHeight},e.ui.ddmanager.droppables[t.scope]=e.ui.ddmanager.droppables[t.scope]||[],e.ui.ddmanager.droppables[t.scope].push(this),t.addClasses&&this.element.addClass("ui-droppable")
},_destroy:function(){var t=e.ui.ddmanager.droppables[this.options.scope];for(var n=0;n<t.length;n++){t[n]==this&&t.splice(n,1)
}this.element.removeClass("ui-droppable ui-droppable-disabled")},_setOption:function(t,n){t=="accept"&&(this.accept=e.isFunction(n)?n:function(e){return e.is(n)
}),e.Widget.prototype._setOption.apply(this,arguments)},_activate:function(t){var n=e.ui.ddmanager.current;
this.options.activeClass&&this.element.addClass(this.options.activeClass),n&&this._trigger("activate",t,this.ui(n))
},_deactivate:function(t){var n=e.ui.ddmanager.current;this.options.activeClass&&this.element.removeClass(this.options.activeClass),n&&this._trigger("deactivate",t,this.ui(n))
},_over:function(t){var n=e.ui.ddmanager.current;if(!n||(n.currentItem||n.element)[0]==this.element[0]){return
}this.accept.call(this.element[0],n.currentItem||n.element)&&(this.options.hoverClass&&this.element.addClass(this.options.hoverClass),this._trigger("over",t,this.ui(n)))
},_out:function(t){var n=e.ui.ddmanager.current;if(!n||(n.currentItem||n.element)[0]==this.element[0]){return
}this.accept.call(this.element[0],n.currentItem||n.element)&&(this.options.hoverClass&&this.element.removeClass(this.options.hoverClass),this._trigger("out",t,this.ui(n)))
},_drop:function(t,n){var r=n||e.ui.ddmanager.current;if(!r||(r.currentItem||r.element)[0]==this.element[0]){return !1
}var i=!1;return this.element.find(":data(droppable)").not(".ui-draggable-dragging").each(function(){var t=e.data(this,"droppable");
if(t.options.greedy&&!t.options.disabled&&t.options.scope==r.options.scope&&t.accept.call(t.element[0],r.currentItem||r.element)&&e.ui.intersect(r,e.extend(t,{offset:t.element.offset()}),t.options.tolerance)){return i=!0,!1
}}),i?!1:this.accept.call(this.element[0],r.currentItem||r.element)?(this.options.activeClass&&this.element.removeClass(this.options.activeClass),this.options.hoverClass&&this.element.removeClass(this.options.hoverClass),this._trigger("drop",t,this.ui(r)),this.element):!1
},ui:function(e){return{draggable:e.currentItem||e.element,helper:e.helper,position:e.position,offset:e.positionAbs}
}}),e.ui.intersect=function(t,n,r){if(!n.offset){return !1}var i=(t.positionAbs||t.position.absolute).left,s=i+t.helperProportions.width,o=(t.positionAbs||t.position.absolute).top,u=o+t.helperProportions.height,a=n.offset.left,f=a+n.proportions.width,l=n.offset.top,c=l+n.proportions.height;
switch(r){case"fit":return a<=i&&s<=f&&l<=o&&u<=c;case"intersect":return a<i+t.helperProportions.width/2&&s-t.helperProportions.width/2<f&&l<o+t.helperProportions.height/2&&u-t.helperProportions.height/2<c;
case"pointer":var h=(t.positionAbs||t.position.absolute).left+(t.clickOffset||t.offset.click).left,p=(t.positionAbs||t.position.absolute).top+(t.clickOffset||t.offset.click).top,d=e.ui.isOver(p,h,l,a,n.proportions.height,n.proportions.width);
return d;case"touch":return(o>=l&&o<=c||u>=l&&u<=c||o<l&&u>c)&&(i>=a&&i<=f||s>=a&&s<=f||i<a&&s>f);default:return !1
}},e.ui.ddmanager={current:null,droppables:{"default":[]},prepareOffsets:function(t,n){var r=e.ui.ddmanager.droppables[t.options.scope]||[],i=n?n.type:null,s=(t.currentItem||t.element).find(":data(droppable)").andSelf();
e:for(var o=0;o<r.length;o++){if(r[o].options.disabled||t&&!r[o].accept.call(r[o].element[0],t.currentItem||t.element)){continue
}for(var u=0;u<s.length;u++){if(s[u]==r[o].element[0]){r[o].proportions.height=0;continue e}}r[o].visible=r[o].element.css("display")!="none";
if(!r[o].visible){continue}i=="mousedown"&&r[o]._activate.call(r[o],n),r[o].offset=r[o].element.offset(),r[o].proportions={width:r[o].element[0].offsetWidth,height:r[o].element[0].offsetHeight}
}},drop:function(t,n){var r=!1;return e.each(e.ui.ddmanager.droppables[t.options.scope]||[],function(){if(!this.options){return
}!this.options.disabled&&this.visible&&e.ui.intersect(t,this,this.options.tolerance)&&(r=this._drop.call(this,n)||r),!this.options.disabled&&this.visible&&this.accept.call(this.element[0],t.currentItem||t.element)&&(this.isout=1,this.isover=0,this._deactivate.call(this,n))
}),r},dragStart:function(t,n){t.element.parentsUntil("body").bind("scroll.droppable",function(){t.options.refreshPositions||e.ui.ddmanager.prepareOffsets(t,n)
})},drag:function(t,n){t.options.refreshPositions&&e.ui.ddmanager.prepareOffsets(t,n),e.each(e.ui.ddmanager.droppables[t.options.scope]||[],function(){if(this.options.disabled||this.greedyChild||!this.visible){return
}var r=e.ui.intersect(t,this,this.options.tolerance),i=!r&&this.isover==1?"isout":r&&this.isover==0?"isover":null;
if(!i){return}var s;if(this.options.greedy){var o=this.options.scope,u=this.element.parents(":data(droppable)").filter(function(){return e.data(this,"droppable").options.scope===o
});u.length&&(s=e.data(u[0],"droppable"),s.greedyChild=i=="isover"?1:0)}s&&i=="isover"&&(s.isover=0,s.isout=1,s._out.call(s,n)),this[i]=1,this[i=="isout"?"isover":"isout"]=0,this[i=="isover"?"_over":"_out"].call(this,n),s&&i=="isout"&&(s.isout=0,s.isover=1,s._over.call(s,n))
})},dragStop:function(t,n){t.element.parentsUntil("body").unbind("scroll.droppable"),t.options.refreshPositions||e.ui.ddmanager.prepareOffsets(t,n)
}}})(jQuery);(function(e,t){e.widget("ui.resizable",e.ui.mouse,{version:"1.9.2",widgetEventPrefix:"resize",options:{alsoResize:!1,animate:!1,animateDuration:"slow",animateEasing:"swing",aspectRatio:!1,autoHide:!1,containment:!1,ghost:!1,grid:!1,handles:"e,s,se",helper:!1,maxHeight:null,maxWidth:null,minHeight:10,minWidth:10,zIndex:1000},_create:function(){var t=this,n=this.options;
this.element.addClass("ui-resizable"),e.extend(this,{_aspectRatio:!!n.aspectRatio,aspectRatio:n.aspectRatio,originalElement:this.element,_proportionallyResizeElements:[],_helper:n.helper||n.ghost||n.animate?n.helper||"ui-resizable-helper":null}),this.element[0].nodeName.match(/canvas|textarea|input|select|button|img/i)&&(this.element.wrap(e('<div class="ui-wrapper" style="overflow: hidden;"></div>').css({position:this.element.css("position"),width:this.element.outerWidth(),height:this.element.outerHeight(),top:this.element.css("top"),left:this.element.css("left")})),this.element=this.element.parent().data("resizable",this.element.data("resizable")),this.elementIsWrapper=!0,this.element.css({marginLeft:this.originalElement.css("marginLeft"),marginTop:this.originalElement.css("marginTop"),marginRight:this.originalElement.css("marginRight"),marginBottom:this.originalElement.css("marginBottom")}),this.originalElement.css({marginLeft:0,marginTop:0,marginRight:0,marginBottom:0}),this.originalResizeStyle=this.originalElement.css("resize"),this.originalElement.css("resize","none"),this._proportionallyResizeElements.push(this.originalElement.css({position:"static",zoom:1,display:"block"})),this.originalElement.css({margin:this.originalElement.css("margin")}),this._proportionallyResize()),this.handles=n.handles||(e(".ui-resizable-handle",this.element).length?{n:".ui-resizable-n",e:".ui-resizable-e",s:".ui-resizable-s",w:".ui-resizable-w",se:".ui-resizable-se",sw:".ui-resizable-sw",ne:".ui-resizable-ne",nw:".ui-resizable-nw"}:"e,s,se");
if(this.handles.constructor==String){this.handles=="all"&&(this.handles="n,e,s,w,se,sw,ne,nw");var r=this.handles.split(",");
this.handles={};for(var i=0;i<r.length;i++){var s=e.trim(r[i]),o="ui-resizable-"+s,u=e('<div class="ui-resizable-handle '+o+'"></div>');
u.css({zIndex:n.zIndex}),"se"==s&&u.addClass("ui-icon ui-icon-gripsmall-diagonal-se"),this.handles[s]=".ui-resizable-"+s,this.element.append(u)
}}this._renderAxis=function(t){t=t||this.element;for(var n in this.handles){this.handles[n].constructor==String&&(this.handles[n]=e(this.handles[n],this.element).show());
if(this.elementIsWrapper&&this.originalElement[0].nodeName.match(/textarea|input|select|button/i)){var r=e(this.handles[n],this.element),i=0;
i=/sw|ne|nw|se|n|s/.test(n)?r.outerHeight():r.outerWidth();var s=["padding",/ne|nw|n/.test(n)?"Top":/se|sw|s/.test(n)?"Bottom":/^e$/.test(n)?"Right":"Left"].join("");
t.css(s,i),this._proportionallyResize()}if(!e(this.handles[n]).length){continue}}},this._renderAxis(this.element),this._handles=e(".ui-resizable-handle",this.element).disableSelection(),this._handles.mouseover(function(){if(!t.resizing){if(this.className){var e=this.className.match(/ui-resizable-(se|sw|ne|nw|n|e|s|w)/i)
}t.axis=e&&e[1]?e[1]:"se"}}),n.autoHide&&(this._handles.hide(),e(this.element).addClass("ui-resizable-autohide").mouseenter(function(){if(n.disabled){return
}e(this).removeClass("ui-resizable-autohide"),t._handles.show()}).mouseleave(function(){if(n.disabled){return
}t.resizing||(e(this).addClass("ui-resizable-autohide"),t._handles.hide())})),this._mouseInit()},_destroy:function(){this._mouseDestroy();
var t=function(t){e(t).removeClass("ui-resizable ui-resizable-disabled ui-resizable-resizing").removeData("resizable").removeData("ui-resizable").unbind(".resizable").find(".ui-resizable-handle").remove()
};if(this.elementIsWrapper){t(this.element);var n=this.element;this.originalElement.css({position:n.css("position"),width:n.outerWidth(),height:n.outerHeight(),top:n.css("top"),left:n.css("left")}).insertAfter(n),n.remove()
}return this.originalElement.css("resize",this.originalResizeStyle),t(this.originalElement),this},_mouseCapture:function(t){var n=!1;
for(var r in this.handles){e(this.handles[r])[0]==t.target&&(n=!0)}return !this.options.disabled&&n},_mouseStart:function(t){var r=this.options,i=this.element.position(),s=this.element;
this.resizing=!0,this.documentScroll={top:e(document).scrollTop(),left:e(document).scrollLeft()},(s.is(".ui-draggable")||/absolute/.test(s.css("position")))&&s.css({position:"absolute",top:i.top,left:i.left}),this._renderProxy();
var o=n(this.helper.css("left")),u=n(this.helper.css("top"));r.containment&&(o+=e(r.containment).scrollLeft()||0,u+=e(r.containment).scrollTop()||0),this.offset=this.helper.offset(),this.position={left:o,top:u},this.size=this._helper?{width:s.outerWidth(),height:s.outerHeight()}:{width:s.width(),height:s.height()},this.originalSize=this._helper?{width:s.outerWidth(),height:s.outerHeight()}:{width:s.width(),height:s.height()},this.originalPosition={left:o,top:u},this.sizeDiff={width:s.outerWidth()-s.width(),height:s.outerHeight()-s.height()},this.originalMousePosition={left:t.pageX,top:t.pageY},this.aspectRatio=typeof r.aspectRatio=="number"?r.aspectRatio:this.originalSize.width/this.originalSize.height||1;
var a=e(".ui-resizable-"+this.axis).css("cursor");return e("body").css("cursor",a=="auto"?this.axis+"-resize":a),s.addClass("ui-resizable-resizing"),this._propagate("start",t),!0
},_mouseDrag:function(e){var t=this.helper,n=this.options,r={},i=this,s=this.originalMousePosition,o=this.axis,u=e.pageX-s.left||0,a=e.pageY-s.top||0,f=this._change[o];
if(!f){return !1}var l=f.apply(this,[e,u,a]);this._updateVirtualBoundaries(e.shiftKey);if(this._aspectRatio||e.shiftKey){l=this._updateRatio(l,e)
}return l=this._respectSize(l,e),this._propagate("resize",e),t.css({top:this.position.top+"px",left:this.position.left+"px",width:this.size.width+"px",height:this.size.height+"px"}),!this._helper&&this._proportionallyResizeElements.length&&this._proportionallyResize(),this._updateCache(l),this._trigger("resize",e,this.ui()),!1
},_mouseStop:function(t){this.resizing=!1;var n=this.options,r=this;if(this._helper){var i=this._proportionallyResizeElements,s=i.length&&/textarea/i.test(i[0].nodeName),o=s&&e.ui.hasScroll(i[0],"left")?0:r.sizeDiff.height,u=s?0:r.sizeDiff.width,a={width:r.helper.width()-u,height:r.helper.height()-o},f=parseInt(r.element.css("left"),10)+(r.position.left-r.originalPosition.left)||null,l=parseInt(r.element.css("top"),10)+(r.position.top-r.originalPosition.top)||null;
n.animate||this.element.css(e.extend(a,{top:l,left:f})),r.helper.height(r.size.height),r.helper.width(r.size.width),this._helper&&!n.animate&&this._proportionallyResize()
}return e("body").css("cursor","auto"),this.element.removeClass("ui-resizable-resizing"),this._propagate("stop",t),this._helper&&this.helper.remove(),!1
},_updateVirtualBoundaries:function(e){var t=this.options,n,i,s,o,u;u={minWidth:r(t.minWidth)?t.minWidth:0,maxWidth:r(t.maxWidth)?t.maxWidth:Infinity,minHeight:r(t.minHeight)?t.minHeight:0,maxHeight:r(t.maxHeight)?t.maxHeight:Infinity};
if(this._aspectRatio||e){n=u.minHeight*this.aspectRatio,s=u.minWidth/this.aspectRatio,i=u.maxHeight*this.aspectRatio,o=u.maxWidth/this.aspectRatio,n>u.minWidth&&(u.minWidth=n),s>u.minHeight&&(u.minHeight=s),i<u.maxWidth&&(u.maxWidth=i),o<u.maxHeight&&(u.maxHeight=o)
}this._vBoundaries=u},_updateCache:function(e){var t=this.options;this.offset=this.helper.offset(),r(e.left)&&(this.position.left=e.left),r(e.top)&&(this.position.top=e.top),r(e.height)&&(this.size.height=e.height),r(e.width)&&(this.size.width=e.width)
},_updateRatio:function(e,t){var n=this.options,i=this.position,s=this.size,o=this.axis;return r(e.height)?e.width=e.height*this.aspectRatio:r(e.width)&&(e.height=e.width/this.aspectRatio),o=="sw"&&(e.left=i.left+(s.width-e.width),e.top=null),o=="nw"&&(e.top=i.top+(s.height-e.height),e.left=i.left+(s.width-e.width)),e
},_respectSize:function(e,t){var n=this.helper,i=this._vBoundaries,s=this._aspectRatio||t.shiftKey,o=this.axis,u=r(e.width)&&i.maxWidth&&i.maxWidth<e.width,a=r(e.height)&&i.maxHeight&&i.maxHeight<e.height,f=r(e.width)&&i.minWidth&&i.minWidth>e.width,l=r(e.height)&&i.minHeight&&i.minHeight>e.height;
f&&(e.width=i.minWidth),l&&(e.height=i.minHeight),u&&(e.width=i.maxWidth),a&&(e.height=i.maxHeight);var c=this.originalPosition.left+this.originalSize.width,h=this.position.top+this.size.height,p=/sw|nw|w/.test(o),d=/nw|ne|n/.test(o);
f&&p&&(e.left=c-i.minWidth),u&&p&&(e.left=c-i.maxWidth),l&&d&&(e.top=h-i.minHeight),a&&d&&(e.top=h-i.maxHeight);
var v=!e.width&&!e.height;return v&&!e.left&&e.top?e.top=null:v&&!e.top&&e.left&&(e.left=null),e},_proportionallyResize:function(){var t=this.options;
if(!this._proportionallyResizeElements.length){return}var n=this.helper||this.element;for(var r=0;r<this._proportionallyResizeElements.length;
r++){var i=this._proportionallyResizeElements[r];if(!this.borderDif){var s=[i.css("borderTopWidth"),i.css("borderRightWidth"),i.css("borderBottomWidth"),i.css("borderLeftWidth")],o=[i.css("paddingTop"),i.css("paddingRight"),i.css("paddingBottom"),i.css("paddingLeft")];
this.borderDif=e.map(s,function(e,t){var n=parseInt(e,10)||0,r=parseInt(o[t],10)||0;return n+r})}i.css({height:n.height()-this.borderDif[0]-this.borderDif[2]||0,width:n.width()-this.borderDif[1]-this.borderDif[3]||0})
}},_renderProxy:function(){var t=this.element,n=this.options;this.elementOffset=t.offset();if(this._helper){this.helper=this.helper||e('<div style="overflow:hidden;"></div>');
var r=e.ui.ie6?1:0,i=e.ui.ie6?2:-1;this.helper.addClass(this._helper).css({width:this.element.outerWidth()+i,height:this.element.outerHeight()+i,position:"absolute",left:this.elementOffset.left-r+"px",top:this.elementOffset.top-r+"px",zIndex:++n.zIndex}),this.helper.appendTo("body").disableSelection()
}else{this.helper=this.element}},_change:{e:function(e,t,n){return{width:this.originalSize.width+t}},w:function(e,t,n){var r=this.options,i=this.originalSize,s=this.originalPosition;
return{left:s.left+t,width:i.width-t}},n:function(e,t,n){var r=this.options,i=this.originalSize,s=this.originalPosition;
return{top:s.top+n,height:i.height-n}},s:function(e,t,n){return{height:this.originalSize.height+n}},se:function(t,n,r){return e.extend(this._change.s.apply(this,arguments),this._change.e.apply(this,[t,n,r]))
},sw:function(t,n,r){return e.extend(this._change.s.apply(this,arguments),this._change.w.apply(this,[t,n,r]))
},ne:function(t,n,r){return e.extend(this._change.n.apply(this,arguments),this._change.e.apply(this,[t,n,r]))
},nw:function(t,n,r){return e.extend(this._change.n.apply(this,arguments),this._change.w.apply(this,[t,n,r]))
}},_propagate:function(t,n){e.ui.plugin.call(this,t,[n,this.ui()]),t!="resize"&&this._trigger(t,n,this.ui())
},plugins:{},ui:function(){return{originalElement:this.originalElement,element:this.element,helper:this.helper,position:this.position,size:this.size,originalSize:this.originalSize,originalPosition:this.originalPosition}
}}),e.ui.plugin.add("resizable","alsoResize",{start:function(t,n){var r=e(this).data("resizable"),i=r.options,s=function(t){e(t).each(function(){var t=e(this);
t.data("resizable-alsoresize",{width:parseInt(t.width(),10),height:parseInt(t.height(),10),left:parseInt(t.css("left"),10),top:parseInt(t.css("top"),10)})
})};typeof i.alsoResize=="object"&&!i.alsoResize.parentNode?i.alsoResize.length?(i.alsoResize=i.alsoResize[0],s(i.alsoResize)):e.each(i.alsoResize,function(e){s(e)
}):s(i.alsoResize)},resize:function(t,n){var r=e(this).data("resizable"),i=r.options,s=r.originalSize,o=r.originalPosition,u={height:r.size.height-s.height||0,width:r.size.width-s.width||0,top:r.position.top-o.top||0,left:r.position.left-o.left||0},a=function(t,r){e(t).each(function(){var t=e(this),i=e(this).data("resizable-alsoresize"),s={},o=r&&r.length?r:t.parents(n.originalElement[0]).length?["width","height"]:["width","height","top","left"];
e.each(o,function(e,t){var n=(i[t]||0)+(u[t]||0);n&&n>=0&&(s[t]=n||null)}),t.css(s)})};typeof i.alsoResize=="object"&&!i.alsoResize.nodeType?e.each(i.alsoResize,function(e,t){a(e,t)
}):a(i.alsoResize)},stop:function(t,n){e(this).removeData("resizable-alsoresize")}}),e.ui.plugin.add("resizable","animate",{stop:function(t,n){var r=e(this).data("resizable"),i=r.options,s=r._proportionallyResizeElements,o=s.length&&/textarea/i.test(s[0].nodeName),u=o&&e.ui.hasScroll(s[0],"left")?0:r.sizeDiff.height,a=o?0:r.sizeDiff.width,f={width:r.size.width-a,height:r.size.height-u},l=parseInt(r.element.css("left"),10)+(r.position.left-r.originalPosition.left)||null,c=parseInt(r.element.css("top"),10)+(r.position.top-r.originalPosition.top)||null;
r.element.animate(e.extend(f,c&&l?{top:c,left:l}:{}),{duration:i.animateDuration,easing:i.animateEasing,step:function(){var n={width:parseInt(r.element.css("width"),10),height:parseInt(r.element.css("height"),10),top:parseInt(r.element.css("top"),10),left:parseInt(r.element.css("left"),10)};
s&&s.length&&e(s[0]).css({width:n.width,height:n.height}),r._updateCache(n),r._propagate("resize",t)}})
}}),e.ui.plugin.add("resizable","containment",{start:function(t,r){var i=e(this).data("resizable"),s=i.options,o=i.element,u=s.containment,a=u instanceof e?u.get(0):/parent/.test(u)?o.parent().get(0):u;
if(!a){return}i.containerElement=e(a);if(/document/.test(u)||u==document){i.containerOffset={left:0,top:0},i.containerPosition={left:0,top:0},i.parentData={element:e(document),left:0,top:0,width:e(document).width(),height:e(document).height()||document.body.parentNode.scrollHeight}
}else{var f=e(a),l=[];e(["Top","Right","Left","Bottom"]).each(function(e,t){l[e]=n(f.css("padding"+t))
}),i.containerOffset=f.offset(),i.containerPosition=f.position(),i.containerSize={height:f.innerHeight()-l[3],width:f.innerWidth()-l[1]};
var c=i.containerOffset,h=i.containerSize.height,p=i.containerSize.width,d=e.ui.hasScroll(a,"left")?a.scrollWidth:p,v=e.ui.hasScroll(a)?a.scrollHeight:h;
i.parentData={element:a,left:c.left,top:c.top,width:d,height:v}}},resize:function(t,n){var r=e(this).data("resizable"),i=r.options,s=r.containerSize,o=r.containerOffset,u=r.size,a=r.position,f=r._aspectRatio||t.shiftKey,l={top:0,left:0},c=r.containerElement;
c[0]!=document&&/static/.test(c.css("position"))&&(l=o),a.left<(r._helper?o.left:0)&&(r.size.width=r.size.width+(r._helper?r.position.left-o.left:r.position.left-l.left),f&&(r.size.height=r.size.width/r.aspectRatio),r.position.left=i.helper?o.left:0),a.top<(r._helper?o.top:0)&&(r.size.height=r.size.height+(r._helper?r.position.top-o.top:r.position.top),f&&(r.size.width=r.size.height*r.aspectRatio),r.position.top=r._helper?o.top:0),r.offset.left=r.parentData.left+r.position.left,r.offset.top=r.parentData.top+r.position.top;
var h=Math.abs((r._helper?r.offset.left-l.left:r.offset.left-l.left)+r.sizeDiff.width),p=Math.abs((r._helper?r.offset.top-l.top:r.offset.top-o.top)+r.sizeDiff.height),d=r.containerElement.get(0)==r.element.parent().get(0),v=/relative|absolute/.test(r.containerElement.css("position"));
d&&v&&(h-=r.parentData.left),h+r.size.width>=r.parentData.width&&(r.size.width=r.parentData.width-h,f&&(r.size.height=r.size.width/r.aspectRatio)),p+r.size.height>=r.parentData.height&&(r.size.height=r.parentData.height-p,f&&(r.size.width=r.size.height*r.aspectRatio))
},stop:function(t,n){var r=e(this).data("resizable"),i=r.options,s=r.position,o=r.containerOffset,u=r.containerPosition,a=r.containerElement,f=e(r.helper),l=f.offset(),c=f.outerWidth()-r.sizeDiff.width,h=f.outerHeight()-r.sizeDiff.height;
r._helper&&!i.animate&&/relative/.test(a.css("position"))&&e(this).css({left:l.left-u.left-o.left,width:c,height:h}),r._helper&&!i.animate&&/static/.test(a.css("position"))&&e(this).css({left:l.left-u.left-o.left,width:c,height:h})
}}),e.ui.plugin.add("resizable","ghost",{start:function(t,n){var r=e(this).data("resizable"),i=r.options,s=r.size;
r.ghost=r.originalElement.clone(),r.ghost.css({opacity:0.25,display:"block",position:"relative",height:s.height,width:s.width,margin:0,left:0,top:0}).addClass("ui-resizable-ghost").addClass(typeof i.ghost=="string"?i.ghost:""),r.ghost.appendTo(r.helper)
},resize:function(t,n){var r=e(this).data("resizable"),i=r.options;r.ghost&&r.ghost.css({position:"relative",height:r.size.height,width:r.size.width})
},stop:function(t,n){var r=e(this).data("resizable"),i=r.options;r.ghost&&r.helper&&r.helper.get(0).removeChild(r.ghost.get(0))
}}),e.ui.plugin.add("resizable","grid",{resize:function(t,n){var r=e(this).data("resizable"),i=r.options,s=r.size,o=r.originalSize,u=r.originalPosition,a=r.axis,f=i._aspectRatio||t.shiftKey;
i.grid=typeof i.grid=="number"?[i.grid,i.grid]:i.grid;var l=Math.round((s.width-o.width)/(i.grid[0]||1))*(i.grid[0]||1),c=Math.round((s.height-o.height)/(i.grid[1]||1))*(i.grid[1]||1);
/^(se|s|e)$/.test(a)?(r.size.width=o.width+l,r.size.height=o.height+c):/^(ne)$/.test(a)?(r.size.width=o.width+l,r.size.height=o.height+c,r.position.top=u.top-c):/^(sw)$/.test(a)?(r.size.width=o.width+l,r.size.height=o.height+c,r.position.left=u.left-l):(r.size.width=o.width+l,r.size.height=o.height+c,r.position.top=u.top-c,r.position.left=u.left-l)
}});var n=function(e){return parseInt(e,10)||0},r=function(e){return !isNaN(parseInt(e,10))}})(jQuery);
(function(e,t){e.widget("ui.selectable",e.ui.mouse,{version:"1.9.2",options:{appendTo:"body",autoRefresh:!0,distance:0,filter:"*",tolerance:"touch"},_create:function(){var t=this;
this.element.addClass("ui-selectable"),this.dragged=!1;var n;this.refresh=function(){n=e(t.options.filter,t.element[0]),n.addClass("ui-selectee"),n.each(function(){var t=e(this),n=t.offset();
e.data(this,"selectable-item",{element:this,$element:t,left:n.left,top:n.top,right:n.left+t.outerWidth(),bottom:n.top+t.outerHeight(),startselected:!1,selected:t.hasClass("ui-selected"),selecting:t.hasClass("ui-selecting"),unselecting:t.hasClass("ui-unselecting")})
})},this.refresh(),this.selectees=n.addClass("ui-selectee"),this._mouseInit(),this.helper=e("<div class='ui-selectable-helper'></div>")
},_destroy:function(){this.selectees.removeClass("ui-selectee").removeData("selectable-item"),this.element.removeClass("ui-selectable ui-selectable-disabled"),this._mouseDestroy()
},_mouseStart:function(t){var n=this;this.opos=[t.pageX,t.pageY];if(this.options.disabled){return}var r=this.options;
this.selectees=e(r.filter,this.element[0]),this._trigger("start",t),e(r.appendTo).append(this.helper),this.helper.css({left:t.clientX,top:t.clientY,width:0,height:0}),r.autoRefresh&&this.refresh(),this.selectees.filter(".ui-selected").each(function(){var r=e.data(this,"selectable-item");
r.startselected=!0,!t.metaKey&&!t.ctrlKey&&(r.$element.removeClass("ui-selected"),r.selected=!1,r.$element.addClass("ui-unselecting"),r.unselecting=!0,n._trigger("unselecting",t,{unselecting:r.element}))
}),e(t.target).parents().andSelf().each(function(){var r=e.data(this,"selectable-item");if(r){var i=!t.metaKey&&!t.ctrlKey||!r.$element.hasClass("ui-selected");
return r.$element.removeClass(i?"ui-unselecting":"ui-selected").addClass(i?"ui-selecting":"ui-unselecting"),r.unselecting=!i,r.selecting=i,r.selected=i,i?n._trigger("selecting",t,{selecting:r.element}):n._trigger("unselecting",t,{unselecting:r.element}),!1
}})},_mouseDrag:function(t){var n=this;this.dragged=!0;if(this.options.disabled){return}var r=this.options,i=this.opos[0],s=this.opos[1],o=t.pageX,u=t.pageY;
if(i>o){var a=o;o=i,i=a}if(s>u){var a=u;u=s,s=a}return this.helper.css({left:i,top:s,width:o-i,height:u-s}),this.selectees.each(function(){var a=e.data(this,"selectable-item");
if(!a||a.element==n.element[0]){return}var f=!1;r.tolerance=="touch"?f=!(a.left>o||a.right<i||a.top>u||a.bottom<s):r.tolerance=="fit"&&(f=a.left>i&&a.right<o&&a.top>s&&a.bottom<u),f?(a.selected&&(a.$element.removeClass("ui-selected"),a.selected=!1),a.unselecting&&(a.$element.removeClass("ui-unselecting"),a.unselecting=!1),a.selecting||(a.$element.addClass("ui-selecting"),a.selecting=!0,n._trigger("selecting",t,{selecting:a.element}))):(a.selecting&&((t.metaKey||t.ctrlKey)&&a.startselected?(a.$element.removeClass("ui-selecting"),a.selecting=!1,a.$element.addClass("ui-selected"),a.selected=!0):(a.$element.removeClass("ui-selecting"),a.selecting=!1,a.startselected&&(a.$element.addClass("ui-unselecting"),a.unselecting=!0),n._trigger("unselecting",t,{unselecting:a.element}))),a.selected&&!t.metaKey&&!t.ctrlKey&&!a.startselected&&(a.$element.removeClass("ui-selected"),a.selected=!1,a.$element.addClass("ui-unselecting"),a.unselecting=!0,n._trigger("unselecting",t,{unselecting:a.element})))
}),!1},_mouseStop:function(t){var n=this;this.dragged=!1;var r=this.options;return e(".ui-unselecting",this.element[0]).each(function(){var r=e.data(this,"selectable-item");
r.$element.removeClass("ui-unselecting"),r.unselecting=!1,r.startselected=!1,n._trigger("unselected",t,{unselected:r.element})
}),e(".ui-selecting",this.element[0]).each(function(){var r=e.data(this,"selectable-item");r.$element.removeClass("ui-selecting").addClass("ui-selected"),r.selecting=!1,r.selected=!0,r.startselected=!0,n._trigger("selected",t,{selected:r.element})
}),this._trigger("stop",t),this.helper.remove(),!1}})})(jQuery);(function(e,t){e.widget("ui.sortable",e.ui.mouse,{version:"1.9.2",widgetEventPrefix:"sort",ready:!1,options:{appendTo:"parent",axis:!1,connectWith:!1,containment:!1,cursor:"auto",cursorAt:!1,dropOnEmpty:!0,forcePlaceholderSize:!1,forceHelperSize:!1,grid:!1,handle:!1,helper:"original",items:"> *",opacity:!1,placeholder:!1,revert:!1,scroll:!0,scrollSensitivity:20,scrollSpeed:20,scope:"default",tolerance:"intersect",zIndex:1000},_create:function(){var e=this.options;
this.containerCache={},this.element.addClass("ui-sortable"),this.refresh(),this.floating=this.items.length?e.axis==="x"||/left|right/.test(this.items[0].item.css("float"))||/inline|table-cell/.test(this.items[0].item.css("display")):!1,this.offset=this.element.offset(),this._mouseInit(),this.ready=!0
},_destroy:function(){this.element.removeClass("ui-sortable ui-sortable-disabled"),this._mouseDestroy();
for(var e=this.items.length-1;e>=0;e--){this.items[e].item.removeData(this.widgetName+"-item")}return this
},_setOption:function(t,n){t==="disabled"?(this.options[t]=n,this.widget().toggleClass("ui-sortable-disabled",!!n)):e.Widget.prototype._setOption.apply(this,arguments)
},_mouseCapture:function(t,n){var r=this;if(this.reverting){return !1}if(this.options.disabled||this.options.type=="static"){return !1
}this._refreshItems(t);var i=null,s=e(t.target).parents().each(function(){if(e.data(this,r.widgetName+"-item")==r){return i=e(this),!1
}});e.data(t.target,r.widgetName+"-item")==r&&(i=e(t.target));if(!i){return !1}if(this.options.handle&&!n){var o=!1;
e(this.options.handle,i).find("*").andSelf().each(function(){this==t.target&&(o=!0)});if(!o){return !1
}}return this.currentItem=i,this._removeCurrentsFromItems(),!0},_mouseStart:function(t,n,r){var i=this.options;
this.currentContainer=this,this.refreshPositions(),this.helper=this._createHelper(t),this._cacheHelperProportions(),this._cacheMargins(),this.scrollParent=this.helper.scrollParent(),this.offset=this.currentItem.offset(),this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left},e.extend(this.offset,{click:{left:t.pageX-this.offset.left,top:t.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()}),this.helper.css("position","absolute"),this.cssPosition=this.helper.css("position"),this.originalPosition=this._generatePosition(t),this.originalPageX=t.pageX,this.originalPageY=t.pageY,i.cursorAt&&this._adjustOffsetFromHelper(i.cursorAt),this.domPosition={prev:this.currentItem.prev()[0],parent:this.currentItem.parent()[0]},this.helper[0]!=this.currentItem[0]&&this.currentItem.hide(),this._createPlaceholder(),i.containment&&this._setContainment(),i.cursor&&(e("body").css("cursor")&&(this._storedCursor=e("body").css("cursor")),e("body").css("cursor",i.cursor)),i.opacity&&(this.helper.css("opacity")&&(this._storedOpacity=this.helper.css("opacity")),this.helper.css("opacity",i.opacity)),i.zIndex&&(this.helper.css("zIndex")&&(this._storedZIndex=this.helper.css("zIndex")),this.helper.css("zIndex",i.zIndex)),this.scrollParent[0]!=document&&this.scrollParent[0].tagName!="HTML"&&(this.overflowOffset=this.scrollParent.offset()),this._trigger("start",t,this._uiHash()),this._preserveHelperProportions||this._cacheHelperProportions();
if(!r){for(var s=this.containers.length-1;s>=0;s--){this.containers[s]._trigger("activate",t,this._uiHash(this))
}}return e.ui.ddmanager&&(e.ui.ddmanager.current=this),e.ui.ddmanager&&!i.dropBehaviour&&e.ui.ddmanager.prepareOffsets(this,t),this.dragging=!0,this.helper.addClass("ui-sortable-helper"),this._mouseDrag(t),!0
},_mouseDrag:function(t){this.position=this._generatePosition(t),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs);
if(this.options.scroll){var n=this.options,r=!1;this.scrollParent[0]!=document&&this.scrollParent[0].tagName!="HTML"?(this.overflowOffset.top+this.scrollParent[0].offsetHeight-t.pageY<n.scrollSensitivity?this.scrollParent[0].scrollTop=r=this.scrollParent[0].scrollTop+n.scrollSpeed:t.pageY-this.overflowOffset.top<n.scrollSensitivity&&(this.scrollParent[0].scrollTop=r=this.scrollParent[0].scrollTop-n.scrollSpeed),this.overflowOffset.left+this.scrollParent[0].offsetWidth-t.pageX<n.scrollSensitivity?this.scrollParent[0].scrollLeft=r=this.scrollParent[0].scrollLeft+n.scrollSpeed:t.pageX-this.overflowOffset.left<n.scrollSensitivity&&(this.scrollParent[0].scrollLeft=r=this.scrollParent[0].scrollLeft-n.scrollSpeed)):(t.pageY-e(document).scrollTop()<n.scrollSensitivity?r=e(document).scrollTop(e(document).scrollTop()-n.scrollSpeed):e(window).height()-(t.pageY-e(document).scrollTop())<n.scrollSensitivity&&(r=e(document).scrollTop(e(document).scrollTop()+n.scrollSpeed)),t.pageX-e(document).scrollLeft()<n.scrollSensitivity?r=e(document).scrollLeft(e(document).scrollLeft()-n.scrollSpeed):e(window).width()-(t.pageX-e(document).scrollLeft())<n.scrollSensitivity&&(r=e(document).scrollLeft(e(document).scrollLeft()+n.scrollSpeed))),r!==!1&&e.ui.ddmanager&&!n.dropBehaviour&&e.ui.ddmanager.prepareOffsets(this,t)
}this.positionAbs=this._convertPositionTo("absolute");if(!this.options.axis||this.options.axis!="y"){this.helper[0].style.left=this.position.left+"px"
}if(!this.options.axis||this.options.axis!="x"){this.helper[0].style.top=this.position.top+"px"}for(var i=this.items.length-1;
i>=0;i--){var s=this.items[i],o=s.item[0],u=this._intersectsWithPointer(s);if(!u){continue}if(s.instance!==this.currentContainer){continue
}if(o!=this.currentItem[0]&&this.placeholder[u==1?"next":"prev"]()[0]!=o&&!e.contains(this.placeholder[0],o)&&(this.options.type=="semi-dynamic"?!e.contains(this.element[0],o):!0)){this.direction=u==1?"down":"up";
if(this.options.tolerance!="pointer"&&!this._intersectsWithSides(s)){break}this._rearrange(t,s),this._trigger("change",t,this._uiHash());
break}}return this._contactContainers(t),e.ui.ddmanager&&e.ui.ddmanager.drag(this,t),this._trigger("sort",t,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1
},_mouseStop:function(t,n){if(!t){return}e.ui.ddmanager&&!this.options.dropBehaviour&&e.ui.ddmanager.drop(this,t);
if(this.options.revert){var r=this,i=this.placeholder.offset();this.reverting=!0,e(this.helper).animate({left:i.left-this.offset.parent.left-this.margins.left+(this.offsetParent[0]==document.body?0:this.offsetParent[0].scrollLeft),top:i.top-this.offset.parent.top-this.margins.top+(this.offsetParent[0]==document.body?0:this.offsetParent[0].scrollTop)},parseInt(this.options.revert,10)||500,function(){r._clear(t)
})}else{this._clear(t,n)}return !1},cancel:function(){if(this.dragging){this._mouseUp({target:null}),this.options.helper=="original"?this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper"):this.currentItem.show();
for(var t=this.containers.length-1;t>=0;t--){this.containers[t]._trigger("deactivate",null,this._uiHash(this)),this.containers[t].containerCache.over&&(this.containers[t]._trigger("out",null,this._uiHash(this)),this.containers[t].containerCache.over=0)
}}return this.placeholder&&(this.placeholder[0].parentNode&&this.placeholder[0].parentNode.removeChild(this.placeholder[0]),this.options.helper!="original"&&this.helper&&this.helper[0].parentNode&&this.helper.remove(),e.extend(this,{helper:null,dragging:!1,reverting:!1,_noFinalSort:null}),this.domPosition.prev?e(this.domPosition.prev).after(this.currentItem):e(this.domPosition.parent).prepend(this.currentItem)),this
},serialize:function(t){var n=this._getItemsAsjQuery(t&&t.connected),r=[];return t=t||{},e(n).each(function(){var n=(e(t.item||this).attr(t.attribute||"id")||"").match(t.expression||/(.+)[-=_](.+)/);
n&&r.push((t.key||n[1]+"[]")+"="+(t.key&&t.expression?n[1]:n[2]))}),!r.length&&t.key&&r.push(t.key+"="),r.join("&")
},toArray:function(t){var n=this._getItemsAsjQuery(t&&t.connected),r=[];return t=t||{},n.each(function(){r.push(e(t.item||this).attr(t.attribute||"id")||"")
}),r},_intersectsWith:function(e){var t=this.positionAbs.left,n=t+this.helperProportions.width,r=this.positionAbs.top,i=r+this.helperProportions.height,s=e.left,o=s+e.width,u=e.top,a=u+e.height,f=this.offset.click.top,l=this.offset.click.left,c=r+f>u&&r+f<a&&t+l>s&&t+l<o;
return this.options.tolerance=="pointer"||this.options.forcePointerForContainers||this.options.tolerance!="pointer"&&this.helperProportions[this.floating?"width":"height"]>e[this.floating?"width":"height"]?c:s<t+this.helperProportions.width/2&&n-this.helperProportions.width/2<o&&u<r+this.helperProportions.height/2&&i-this.helperProportions.height/2<a
},_intersectsWithPointer:function(t){var n=this.options.axis==="x"||e.ui.isOverAxis(this.positionAbs.top+this.offset.click.top,t.top,t.height),r=this.options.axis==="y"||e.ui.isOverAxis(this.positionAbs.left+this.offset.click.left,t.left,t.width),i=n&&r,s=this._getDragVerticalDirection(),o=this._getDragHorizontalDirection();
return i?this.floating?o&&o=="right"||s=="down"?2:1:s&&(s=="down"?2:1):!1},_intersectsWithSides:function(t){var n=e.ui.isOverAxis(this.positionAbs.top+this.offset.click.top,t.top+t.height/2,t.height),r=e.ui.isOverAxis(this.positionAbs.left+this.offset.click.left,t.left+t.width/2,t.width),i=this._getDragVerticalDirection(),s=this._getDragHorizontalDirection();
return this.floating&&s?s=="right"&&r||s=="left"&&!r:i&&(i=="down"&&n||i=="up"&&!n)},_getDragVerticalDirection:function(){var e=this.positionAbs.top-this.lastPositionAbs.top;
return e!=0&&(e>0?"down":"up")},_getDragHorizontalDirection:function(){var e=this.positionAbs.left-this.lastPositionAbs.left;
return e!=0&&(e>0?"right":"left")},refresh:function(e){return this._refreshItems(e),this.refreshPositions(),this
},_connectWith:function(){var e=this.options;return e.connectWith.constructor==String?[e.connectWith]:e.connectWith
},_getItemsAsjQuery:function(t){var n=[],r=[],i=this._connectWith();if(i&&t){for(var s=i.length-1;s>=0;
s--){var o=e(i[s]);for(var u=o.length-1;u>=0;u--){var a=e.data(o[u],this.widgetName);a&&a!=this&&!a.options.disabled&&r.push([e.isFunction(a.options.items)?a.options.items.call(a.element):e(a.options.items,a.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),a])
}}}r.push([e.isFunction(this.options.items)?this.options.items.call(this.element,null,{options:this.options,item:this.currentItem}):e(this.options.items,this.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),this]);
for(var s=r.length-1;s>=0;s--){r[s][0].each(function(){n.push(this)})}return e(n)},_removeCurrentsFromItems:function(){var t=this.currentItem.find(":data("+this.widgetName+"-item)");
this.items=e.grep(this.items,function(e){for(var n=0;n<t.length;n++){if(t[n]==e.item[0]){return !1}}return !0
})},_refreshItems:function(t){this.items=[],this.containers=[this];var n=this.items,r=[[e.isFunction(this.options.items)?this.options.items.call(this.element[0],t,{item:this.currentItem}):e(this.options.items,this.element),this]],i=this._connectWith();
if(i&&this.ready){for(var s=i.length-1;s>=0;s--){var o=e(i[s]);for(var u=o.length-1;u>=0;u--){var a=e.data(o[u],this.widgetName);
a&&a!=this&&!a.options.disabled&&(r.push([e.isFunction(a.options.items)?a.options.items.call(a.element[0],t,{item:this.currentItem}):e(a.options.items,a.element),a]),this.containers.push(a))
}}}for(var s=r.length-1;s>=0;s--){var f=r[s][1],l=r[s][0];for(var u=0,c=l.length;u<c;u++){var h=e(l[u]);
h.data(this.widgetName+"-item",f),n.push({item:h,instance:f,width:0,height:0,left:0,top:0})}}},refreshPositions:function(t){this.offsetParent&&this.helper&&(this.offset.parent=this._getParentOffset());
for(var n=this.items.length-1;n>=0;n--){var r=this.items[n];if(r.instance!=this.currentContainer&&this.currentContainer&&r.item[0]!=this.currentItem[0]){continue
}var i=this.options.toleranceElement?e(this.options.toleranceElement,r.item):r.item;t||(r.width=i.outerWidth(),r.height=i.outerHeight());
var s=i.offset();r.left=s.left,r.top=s.top}if(this.options.custom&&this.options.custom.refreshContainers){this.options.custom.refreshContainers.call(this)
}else{for(var n=this.containers.length-1;n>=0;n--){var s=this.containers[n].element.offset();this.containers[n].containerCache.left=s.left,this.containers[n].containerCache.top=s.top,this.containers[n].containerCache.width=this.containers[n].element.outerWidth(),this.containers[n].containerCache.height=this.containers[n].element.outerHeight()
}}return this},_createPlaceholder:function(t){t=t||this;var n=t.options;if(!n.placeholder||n.placeholder.constructor==String){var r=n.placeholder;
n.placeholder={element:function(){var n=e(document.createElement(t.currentItem[0].nodeName)).addClass(r||t.currentItem[0].className+" ui-sortable-placeholder").removeClass("ui-sortable-helper")[0];
return r||(n.style.visibility="hidden"),n},update:function(e,i){if(r&&!n.forcePlaceholderSize){return
}i.height()||i.height(t.currentItem.innerHeight()-parseInt(t.currentItem.css("paddingTop")||0,10)-parseInt(t.currentItem.css("paddingBottom")||0,10)),i.width()||i.width(t.currentItem.innerWidth()-parseInt(t.currentItem.css("paddingLeft")||0,10)-parseInt(t.currentItem.css("paddingRight")||0,10))
}}}t.placeholder=e(n.placeholder.element.call(t.element,t.currentItem)),t.currentItem.after(t.placeholder),n.placeholder.update(t,t.placeholder)
},_contactContainers:function(t){var n=null,r=null;for(var i=this.containers.length-1;i>=0;i--){if(e.contains(this.currentItem[0],this.containers[i].element[0])){continue
}if(this._intersectsWith(this.containers[i].containerCache)){if(n&&e.contains(this.containers[i].element[0],n.element[0])){continue
}n=this.containers[i],r=i}else{this.containers[i].containerCache.over&&(this.containers[i]._trigger("out",t,this._uiHash(this)),this.containers[i].containerCache.over=0)
}}if(!n){return}if(this.containers.length===1){this.containers[r]._trigger("over",t,this._uiHash(this)),this.containers[r].containerCache.over=1
}else{var s=10000,o=null,u=this.containers[r].floating?"left":"top",a=this.containers[r].floating?"width":"height",f=this.positionAbs[u]+this.offset.click[u];
for(var l=this.items.length-1;l>=0;l--){if(!e.contains(this.containers[r].element[0],this.items[l].item[0])){continue
}if(this.items[l].item[0]==this.currentItem[0]){continue}var c=this.items[l].item.offset()[u],h=!1;Math.abs(c-f)>Math.abs(c+this.items[l][a]-f)&&(h=!0,c+=this.items[l][a]),Math.abs(c-f)<s&&(s=Math.abs(c-f),o=this.items[l],this.direction=h?"up":"down")
}if(!o&&!this.options.dropOnEmpty){return}this.currentContainer=this.containers[r],o?this._rearrange(t,o,null,!0):this._rearrange(t,null,this.containers[r].element,!0),this._trigger("change",t,this._uiHash()),this.containers[r]._trigger("change",t,this._uiHash(this)),this.options.placeholder.update(this.currentContainer,this.placeholder),this.containers[r]._trigger("over",t,this._uiHash(this)),this.containers[r].containerCache.over=1
}},_createHelper:function(t){var n=this.options,r=e.isFunction(n.helper)?e(n.helper.apply(this.element[0],[t,this.currentItem])):n.helper=="clone"?this.currentItem.clone():this.currentItem;
return r.parents("body").length||e(n.appendTo!="parent"?n.appendTo:this.currentItem[0].parentNode)[0].appendChild(r[0]),r[0]==this.currentItem[0]&&(this._storedCSS={width:this.currentItem[0].style.width,height:this.currentItem[0].style.height,position:this.currentItem.css("position"),top:this.currentItem.css("top"),left:this.currentItem.css("left")}),(r[0].style.width==""||n.forceHelperSize)&&r.width(this.currentItem.width()),(r[0].style.height==""||n.forceHelperSize)&&r.height(this.currentItem.height()),r
},_adjustOffsetFromHelper:function(t){typeof t=="string"&&(t=t.split(" ")),e.isArray(t)&&(t={left:+t[0],top:+t[1]||0}),"left" in t&&(this.offset.click.left=t.left+this.margins.left),"right" in t&&(this.offset.click.left=this.helperProportions.width-t.right+this.margins.left),"top" in t&&(this.offset.click.top=t.top+this.margins.top),"bottom" in t&&(this.offset.click.top=this.helperProportions.height-t.bottom+this.margins.top)
},_getParentOffset:function(){this.offsetParent=this.helper.offsetParent();var t=this.offsetParent.offset();
this.cssPosition=="absolute"&&this.scrollParent[0]!=document&&e.contains(this.scrollParent[0],this.offsetParent[0])&&(t.left+=this.scrollParent.scrollLeft(),t.top+=this.scrollParent.scrollTop());
if(this.offsetParent[0]==document.body||this.offsetParent[0].tagName&&this.offsetParent[0].tagName.toLowerCase()=="html"&&e.ui.ie){t={top:0,left:0}
}return{top:t.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:t.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}
},_getRelativeOffset:function(){if(this.cssPosition=="relative"){var e=this.currentItem.position();return{top:e.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:e.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()}
}return{top:0,left:0}},_cacheMargins:function(){this.margins={left:parseInt(this.currentItem.css("marginLeft"),10)||0,top:parseInt(this.currentItem.css("marginTop"),10)||0}
},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}
},_setContainment:function(){var t=this.options;t.containment=="parent"&&(t.containment=this.helper[0].parentNode);
if(t.containment=="document"||t.containment=="window"){this.containment=[0-this.offset.relative.left-this.offset.parent.left,0-this.offset.relative.top-this.offset.parent.top,e(t.containment=="document"?document:window).width()-this.helperProportions.width-this.margins.left,(e(t.containment=="document"?document:window).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]
}if(!/^(document|window|parent)$/.test(t.containment)){var n=e(t.containment)[0],r=e(t.containment).offset(),i=e(n).css("overflow")!="hidden";
this.containment=[r.left+(parseInt(e(n).css("borderLeftWidth"),10)||0)+(parseInt(e(n).css("paddingLeft"),10)||0)-this.margins.left,r.top+(parseInt(e(n).css("borderTopWidth"),10)||0)+(parseInt(e(n).css("paddingTop"),10)||0)-this.margins.top,r.left+(i?Math.max(n.scrollWidth,n.offsetWidth):n.offsetWidth)-(parseInt(e(n).css("borderLeftWidth"),10)||0)-(parseInt(e(n).css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left,r.top+(i?Math.max(n.scrollHeight,n.offsetHeight):n.offsetHeight)-(parseInt(e(n).css("borderTopWidth"),10)||0)-(parseInt(e(n).css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top]
}},_convertPositionTo:function(t,n){n||(n=this.position);var r=t=="absolute"?1:-1,i=this.options,s=this.cssPosition!="absolute"||this.scrollParent[0]!=document&&!!e.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,o=/(html|body)/i.test(s[0].tagName);
return{top:n.top+this.offset.relative.top*r+this.offset.parent.top*r-(this.cssPosition=="fixed"?-this.scrollParent.scrollTop():o?0:s.scrollTop())*r,left:n.left+this.offset.relative.left*r+this.offset.parent.left*r-(this.cssPosition=="fixed"?-this.scrollParent.scrollLeft():o?0:s.scrollLeft())*r}
},_generatePosition:function(t){var n=this.options,r=this.cssPosition!="absolute"||this.scrollParent[0]!=document&&!!e.contains(this.scrollParent[0],this.offsetParent[0])?this.scrollParent:this.offsetParent,i=/(html|body)/i.test(r[0].tagName);
this.cssPosition=="relative"&&(this.scrollParent[0]==document||this.scrollParent[0]==this.offsetParent[0])&&(this.offset.relative=this._getRelativeOffset());
var s=t.pageX,o=t.pageY;if(this.originalPosition){this.containment&&(t.pageX-this.offset.click.left<this.containment[0]&&(s=this.containment[0]+this.offset.click.left),t.pageY-this.offset.click.top<this.containment[1]&&(o=this.containment[1]+this.offset.click.top),t.pageX-this.offset.click.left>this.containment[2]&&(s=this.containment[2]+this.offset.click.left),t.pageY-this.offset.click.top>this.containment[3]&&(o=this.containment[3]+this.offset.click.top));
if(n.grid){var u=this.originalPageY+Math.round((o-this.originalPageY)/n.grid[1])*n.grid[1];o=this.containment?u-this.offset.click.top<this.containment[1]||u-this.offset.click.top>this.containment[3]?u-this.offset.click.top<this.containment[1]?u+n.grid[1]:u-n.grid[1]:u:u;
var a=this.originalPageX+Math.round((s-this.originalPageX)/n.grid[0])*n.grid[0];s=this.containment?a-this.offset.click.left<this.containment[0]||a-this.offset.click.left>this.containment[2]?a-this.offset.click.left<this.containment[0]?a+n.grid[0]:a-n.grid[0]:a:a
}}return{top:o-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+(this.cssPosition=="fixed"?-this.scrollParent.scrollTop():i?0:r.scrollTop()),left:s-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+(this.cssPosition=="fixed"?-this.scrollParent.scrollLeft():i?0:r.scrollLeft())}
},_rearrange:function(e,t,n,r){n?n[0].appendChild(this.placeholder[0]):t.item[0].parentNode.insertBefore(this.placeholder[0],this.direction=="down"?t.item[0]:t.item[0].nextSibling),this.counter=this.counter?++this.counter:1;
var i=this.counter;this._delay(function(){i==this.counter&&this.refreshPositions(!r)})},_clear:function(t,n){this.reverting=!1;
var r=[];!this._noFinalSort&&this.currentItem.parent().length&&this.placeholder.before(this.currentItem),this._noFinalSort=null;
if(this.helper[0]==this.currentItem[0]){for(var i in this._storedCSS){if(this._storedCSS[i]=="auto"||this._storedCSS[i]=="static"){this._storedCSS[i]=""
}}this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper")}else{this.currentItem.show()
}this.fromOutside&&!n&&r.push(function(e){this._trigger("receive",e,this._uiHash(this.fromOutside))}),(this.fromOutside||this.domPosition.prev!=this.currentItem.prev().not(".ui-sortable-helper")[0]||this.domPosition.parent!=this.currentItem.parent()[0])&&!n&&r.push(function(e){this._trigger("update",e,this._uiHash())
}),this!==this.currentContainer&&(n||(r.push(function(e){this._trigger("remove",e,this._uiHash())}),r.push(function(e){return function(t){e._trigger("receive",t,this._uiHash(this))
}}.call(this,this.currentContainer)),r.push(function(e){return function(t){e._trigger("update",t,this._uiHash(this))
}}.call(this,this.currentContainer))));for(var i=this.containers.length-1;i>=0;i--){n||r.push(function(e){return function(t){e._trigger("deactivate",t,this._uiHash(this))
}}.call(this,this.containers[i])),this.containers[i].containerCache.over&&(r.push(function(e){return function(t){e._trigger("out",t,this._uiHash(this))
}}.call(this,this.containers[i])),this.containers[i].containerCache.over=0)}this._storedCursor&&e("body").css("cursor",this._storedCursor),this._storedOpacity&&this.helper.css("opacity",this._storedOpacity),this._storedZIndex&&this.helper.css("zIndex",this._storedZIndex=="auto"?"":this._storedZIndex),this.dragging=!1;
if(this.cancelHelperRemoval){if(!n){this._trigger("beforeStop",t,this._uiHash());for(var i=0;i<r.length;
i++){r[i].call(this,t)}this._trigger("stop",t,this._uiHash())}return this.fromOutside=!1,!1}n||this._trigger("beforeStop",t,this._uiHash()),this.placeholder[0].parentNode.removeChild(this.placeholder[0]),this.helper[0]!=this.currentItem[0]&&this.helper.remove(),this.helper=null;
if(!n){for(var i=0;i<r.length;i++){r[i].call(this,t)}this._trigger("stop",t,this._uiHash())}return this.fromOutside=!1,!0
},_trigger:function(){e.Widget.prototype._trigger.apply(this,arguments)===!1&&this.cancel()},_uiHash:function(t){var n=t||this;
return{helper:n.helper,placeholder:n.placeholder||e([]),position:n.position,originalPosition:n.originalPosition,offset:n.positionAbs,item:n.currentItem,sender:t?t.element:null}
}})})(jQuery);(function(e,t){var n=0;e.widget("ui.autocomplete",{version:"1.9.2",defaultElement:"<input>",options:{appendTo:"body",autoFocus:!1,delay:300,minLength:1,position:{my:"left top",at:"left bottom",collision:"none"},source:null,change:null,close:null,focus:null,open:null,response:null,search:null,select:null},pending:0,_create:function(){var t,n,r;
this.isMultiLine=this._isMultiLine(),this.valueMethod=this.element[this.element.is("input,textarea")?"val":"text"],this.isNewMenu=!0,this.element.addClass("ui-autocomplete-input").attr("autocomplete","off"),this._on(this.element,{keydown:function(i){if(this.element.prop("readOnly")){t=!0,r=!0,n=!0;
return}t=!1,r=!1,n=!1;var s=e.ui.keyCode;switch(i.keyCode){case s.PAGE_UP:t=!0,this._move("previousPage",i);
break;case s.PAGE_DOWN:t=!0,this._move("nextPage",i);break;case s.UP:t=!0,this._keyEvent("previous",i);
break;case s.DOWN:t=!0,this._keyEvent("next",i);break;case s.ENTER:case s.NUMPAD_ENTER:this.menu.active&&(t=!0,i.preventDefault(),this.menu.select(i));
break;case s.TAB:this.menu.active&&this.menu.select(i);break;case s.ESCAPE:this.menu.element.is(":visible")&&(this._value(this.term),this.close(i),i.preventDefault());
break;default:n=!0,this._searchTimeout(i)}},keypress:function(r){if(t){t=!1,r.preventDefault();return
}if(n){return}var i=e.ui.keyCode;switch(r.keyCode){case i.PAGE_UP:this._move("previousPage",r);break;
case i.PAGE_DOWN:this._move("nextPage",r);break;case i.UP:this._keyEvent("previous",r);break;case i.DOWN:this._keyEvent("next",r)
}},input:function(e){if(r){r=!1,e.preventDefault();return}this._searchTimeout(e)},focus:function(){this.selectedItem=null,this.previous=this._value()
},blur:function(e){if(this.cancelBlur){delete this.cancelBlur;return}clearTimeout(this.searching),this.close(e),this._change(e)
}}),this._initSource(),this.menu=e("<ul>").addClass("ui-autocomplete").appendTo(this.document.find(this.options.appendTo||"body")[0]).menu({input:e(),role:null}).zIndex(this.element.zIndex()+1).hide().data("menu"),this._on(this.menu.element,{mousedown:function(t){t.preventDefault(),this.cancelBlur=!0,this._delay(function(){delete this.cancelBlur
});var n=this.menu.element[0];e(t.target).closest(".ui-menu-item").length||this._delay(function(){var t=this;
this.document.one("mousedown",function(r){r.target!==t.element[0]&&r.target!==n&&!e.contains(n,r.target)&&t.close()
})})},menufocus:function(t,n){if(this.isNewMenu){this.isNewMenu=!1;if(t.originalEvent&&/^mouse/.test(t.originalEvent.type)){this.menu.blur(),this.document.one("mousemove",function(){e(t.target).trigger(t.originalEvent)
});return}}var r=n.item.data("ui-autocomplete-item")||n.item.data("item.autocomplete");!1!==this._trigger("focus",t,{item:r})?t.originalEvent&&/^key/.test(t.originalEvent.type)&&this._value(r.value):this.liveRegion.text(r.value)
},menuselect:function(e,t){var n=t.item.data("ui-autocomplete-item")||t.item.data("item.autocomplete"),r=this.previous;
this.element[0]!==this.document[0].activeElement&&(this.element.focus(),this.previous=r,this._delay(function(){this.previous=r,this.selectedItem=n
})),!1!==this._trigger("select",e,{item:n})&&this._value(n.value),this.term=this._value(),this.close(e),this.selectedItem=n
}}),this.liveRegion=e("<span>",{role:"status","aria-live":"polite"}).addClass("ui-helper-hidden-accessible").insertAfter(this.element),e.fn.bgiframe&&this.menu.element.bgiframe(),this._on(this.window,{beforeunload:function(){this.element.removeAttr("autocomplete")
}})},_destroy:function(){clearTimeout(this.searching),this.element.removeClass("ui-autocomplete-input").removeAttr("autocomplete"),this.menu.element.remove(),this.liveRegion.remove()
},_setOption:function(e,t){this._super(e,t),e==="source"&&this._initSource(),e==="appendTo"&&this.menu.element.appendTo(this.document.find(t||"body")[0]),e==="disabled"&&t&&this.xhr&&this.xhr.abort()
},_isMultiLine:function(){return this.element.is("textarea")?!0:this.element.is("input")?!1:this.element.prop("isContentEditable")
},_initSource:function(){var t,n,r=this;e.isArray(this.options.source)?(t=this.options.source,this.source=function(n,r){r(e.ui.autocomplete.filter(t,n.term))
}):typeof this.options.source=="string"?(n=this.options.source,this.source=function(t,i){r.xhr&&r.xhr.abort(),r.xhr=e.ajax({url:n,data:t,dataType:"json",success:function(e){i(e)
},error:function(){i([])}})}):this.source=this.options.source},_searchTimeout:function(e){clearTimeout(this.searching),this.searching=this._delay(function(){this.term!==this._value()&&(this.selectedItem=null,this.search(null,e))
},this.options.delay)},search:function(e,t){e=e!=null?e:this._value(),this.term=this._value();if(e.length<this.options.minLength){return this.close(t)
}if(this._trigger("search",t)===!1){return}return this._search(e)},_search:function(e){this.pending++,this.element.addClass("ui-autocomplete-loading"),this.cancelSearch=!1,this.source({term:e},this._response())
},_response:function(){var e=this,t=++n;return function(r){t===n&&e.__response(r),e.pending--,e.pending||e.element.removeClass("ui-autocomplete-loading")
}},__response:function(e){e&&(e=this._normalize(e)),this._trigger("response",null,{content:e}),!this.options.disabled&&e&&e.length&&!this.cancelSearch?(this._suggest(e),this._trigger("open")):this._close()
},close:function(e){this.cancelSearch=!0,this._close(e)},_close:function(e){this.menu.element.is(":visible")&&(this.menu.element.hide(),this.menu.blur(),this.isNewMenu=!0,this._trigger("close",e))
},_change:function(e){this.previous!==this._value()&&this._trigger("change",e,{item:this.selectedItem})
},_normalize:function(t){return t.length&&t[0].label&&t[0].value?t:e.map(t,function(t){return typeof t=="string"?{label:t,value:t}:e.extend({label:t.label||t.value,value:t.value||t.label},t)
})},_suggest:function(t){var n=this.menu.element.empty().zIndex(this.element.zIndex()+1);this._renderMenu(n,t),this.menu.refresh(),n.show(),this._resizeMenu(),n.position(e.extend({of:this.element},this.options.position)),this.options.autoFocus&&this.menu.next()
},_resizeMenu:function(){var e=this.menu.element;e.outerWidth(Math.max(e.width("").outerWidth()+1,this.element.outerWidth()))
},_renderMenu:function(t,n){var r=this;e.each(n,function(e,n){r._renderItemData(t,n)})},_renderItemData:function(e,t){return this._renderItem(e,t).data("ui-autocomplete-item",t)
},_renderItem:function(t,n){return e("<li>").append(e("<a>").text(n.label)).appendTo(t)},_move:function(e,t){if(!this.menu.element.is(":visible")){this.search(null,t);
return}if(this.menu.isFirstItem()&&/^previous/.test(e)||this.menu.isLastItem()&&/^next/.test(e)){this._value(this.term),this.menu.blur();
return}this.menu[e](t)},widget:function(){return this.menu.element},_value:function(){return this.valueMethod.apply(this.element,arguments)
},_keyEvent:function(e,t){if(!this.isMultiLine||this.menu.element.is(":visible")){this._move(e,t),t.preventDefault()
}}}),e.extend(e.ui.autocomplete,{escapeRegex:function(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")
},filter:function(t,n){var r=new RegExp(e.ui.autocomplete.escapeRegex(n),"i");return e.grep(t,function(e){return r.test(e.label||e.value||e)
})}}),e.widget("ui.autocomplete",e.ui.autocomplete,{options:{messages:{noResults:"No search results.",results:function(e){return e+(e>1?" results are":" result is")+" available, use up and down arrow keys to navigate."
}}},__response:function(e){var t;this._superApply(arguments);if(this.options.disabled||this.cancelSearch){return
}e&&e.length?t=this.options.messages.results(e.length):t=this.options.messages.noResults,this.liveRegion.text(t)
}})})(jQuery);(function(e,t){var n,r,i,s,o="ui-button ui-widget ui-state-default ui-corner-all",u="ui-state-hover ui-state-active ",a="ui-button-icons-only ui-button-icon-only ui-button-text-icons ui-button-text-icon-primary ui-button-text-icon-secondary ui-button-text-only",f=function(){var t=e(this).find(":ui-button");
setTimeout(function(){t.button("refresh")},1)},l=function(t){var n=t.name,r=t.form,i=e([]);return n&&(r?i=e(r).find("[name='"+n+"']"):i=e("[name='"+n+"']",t.ownerDocument).filter(function(){return !this.form
})),i};e.widget("ui.button",{version:"1.9.2",defaultElement:"<button>",options:{disabled:null,text:!0,label:null,icons:{primary:null,secondary:null}},_create:function(){this.element.closest("form").unbind("reset"+this.eventNamespace).bind("reset"+this.eventNamespace,f),typeof this.options.disabled!="boolean"?this.options.disabled=!!this.element.prop("disabled"):this.element.prop("disabled",this.options.disabled),this._determineButtonType(),this.hasTitle=!!this.buttonElement.attr("title");
var t=this,u=this.options,a=this.type==="checkbox"||this.type==="radio",c=a?"":"ui-state-active",h="ui-state-focus";
u.label===null&&(u.label=this.type==="input"?this.buttonElement.val():this.buttonElement.html()),this._hoverable(this.buttonElement),this.buttonElement.addClass(o).attr("role","button").bind("mouseenter"+this.eventNamespace,function(){if(u.disabled){return
}this===n&&e(this).addClass("ui-state-active")}).bind("mouseleave"+this.eventNamespace,function(){if(u.disabled){return
}e(this).removeClass(c)}).bind("click"+this.eventNamespace,function(e){u.disabled&&(e.preventDefault(),e.stopImmediatePropagation())
}),this.element.bind("focus"+this.eventNamespace,function(){t.buttonElement.addClass(h)}).bind("blur"+this.eventNamespace,function(){t.buttonElement.removeClass(h)
}),a&&(this.element.bind("change"+this.eventNamespace,function(){if(s){return}t.refresh()}),this.buttonElement.bind("mousedown"+this.eventNamespace,function(e){if(u.disabled){return
}s=!1,r=e.pageX,i=e.pageY}).bind("mouseup"+this.eventNamespace,function(e){if(u.disabled){return}if(r!==e.pageX||i!==e.pageY){s=!0
}})),this.type==="checkbox"?this.buttonElement.bind("click"+this.eventNamespace,function(){if(u.disabled||s){return !1
}e(this).toggleClass("ui-state-active"),t.buttonElement.attr("aria-pressed",t.element[0].checked)}):this.type==="radio"?this.buttonElement.bind("click"+this.eventNamespace,function(){if(u.disabled||s){return !1
}e(this).addClass("ui-state-active"),t.buttonElement.attr("aria-pressed","true");var n=t.element[0];l(n).not(n).map(function(){return e(this).button("widget")[0]
}).removeClass("ui-state-active").attr("aria-pressed","false")}):(this.buttonElement.bind("mousedown"+this.eventNamespace,function(){if(u.disabled){return !1
}e(this).addClass("ui-state-active"),n=this,t.document.one("mouseup",function(){n=null})}).bind("mouseup"+this.eventNamespace,function(){if(u.disabled){return !1
}e(this).removeClass("ui-state-active")}).bind("keydown"+this.eventNamespace,function(t){if(u.disabled){return !1
}(t.keyCode===e.ui.keyCode.SPACE||t.keyCode===e.ui.keyCode.ENTER)&&e(this).addClass("ui-state-active")
}).bind("keyup"+this.eventNamespace,function(){e(this).removeClass("ui-state-active")}),this.buttonElement.is("a")&&this.buttonElement.keyup(function(t){t.keyCode===e.ui.keyCode.SPACE&&e(this).click()
})),this._setOption("disabled",u.disabled),this._resetButton()},_determineButtonType:function(){var e,t,n;
this.element.is("[type=checkbox]")?this.type="checkbox":this.element.is("[type=radio]")?this.type="radio":this.element.is("input")?this.type="input":this.type="button",this.type==="checkbox"||this.type==="radio"?(e=this.element.parents().last(),t="label[for='"+this.element.attr("id")+"']",this.buttonElement=e.find(t),this.buttonElement.length||(e=e.length?e.siblings():this.element.siblings(),this.buttonElement=e.filter(t),this.buttonElement.length||(this.buttonElement=e.find(t))),this.element.addClass("ui-helper-hidden-accessible"),n=this.element.is(":checked"),n&&this.buttonElement.addClass("ui-state-active"),this.buttonElement.prop("aria-pressed",n)):this.buttonElement=this.element
},widget:function(){return this.buttonElement},_destroy:function(){this.element.removeClass("ui-helper-hidden-accessible"),this.buttonElement.removeClass(o+" "+u+" "+a).removeAttr("role").removeAttr("aria-pressed").html(this.buttonElement.find(".ui-button-text").html()),this.hasTitle||this.buttonElement.removeAttr("title")
},_setOption:function(e,t){this._super(e,t);if(e==="disabled"){t?this.element.prop("disabled",!0):this.element.prop("disabled",!1);
return}this._resetButton()},refresh:function(){var t=this.element.is("input, button")?this.element.is(":disabled"):this.element.hasClass("ui-button-disabled");
t!==this.options.disabled&&this._setOption("disabled",t),this.type==="radio"?l(this.element[0]).each(function(){e(this).is(":checked")?e(this).button("widget").addClass("ui-state-active").attr("aria-pressed","true"):e(this).button("widget").removeClass("ui-state-active").attr("aria-pressed","false")
}):this.type==="checkbox"&&(this.element.is(":checked")?this.buttonElement.addClass("ui-state-active").attr("aria-pressed","true"):this.buttonElement.removeClass("ui-state-active").attr("aria-pressed","false"))
},_resetButton:function(){if(this.type==="input"){this.options.label&&this.element.val(this.options.label);
return}var t=this.buttonElement.removeClass(a),n=e("<span></span>",this.document[0]).addClass("ui-button-text").html(this.options.label).appendTo(t.empty()).text(),r=this.options.icons,i=r.primary&&r.secondary,s=[];
r.primary||r.secondary?(this.options.text&&s.push("ui-button-text-icon"+(i?"s":r.primary?"-primary":"-secondary")),r.primary&&t.prepend("<span class='ui-button-icon-primary ui-icon "+r.primary+"'></span>"),r.secondary&&t.append("<span class='ui-button-icon-secondary ui-icon "+r.secondary+"'></span>"),this.options.text||(s.push(i?"ui-button-icons-only":"ui-button-icon-only"),this.hasTitle||t.attr("title",e.trim(n)))):s.push("ui-button-text-only"),t.addClass(s.join(" "))
}}),e.widget("ui.buttonset",{version:"1.9.2",options:{items:"button, input[type=button], input[type=submit], input[type=reset], input[type=checkbox], input[type=radio], a, :data(button)"},_create:function(){this.element.addClass("ui-buttonset")
},_init:function(){this.refresh()},_setOption:function(e,t){e==="disabled"&&this.buttons.button("option",e,t),this._super(e,t)
},refresh:function(){var t=this.element.css("direction")==="rtl";this.buttons=this.element.find(this.options.items).filter(":ui-button").button("refresh").end().not(":ui-button").button().end().map(function(){return e(this).button("widget")[0]
}).removeClass("ui-corner-all ui-corner-left ui-corner-right").filter(":first").addClass(t?"ui-corner-right":"ui-corner-left").end().filter(":last").addClass(t?"ui-corner-left":"ui-corner-right").end().end()
},_destroy:function(){this.element.removeClass("ui-buttonset"),this.buttons.map(function(){return e(this).button("widget")[0]
}).removeClass("ui-corner-left ui-corner-right").end().button("destroy")}})})(jQuery);(function($,undefined){function Datepicker(){this.debug=!1,this._curInst=null,this._keyEvent=!1,this._disabledInputs=[],this._datepickerShowing=!1,this._inDialog=!1,this._mainDivId="ui-datepicker-div",this._inlineClass="ui-datepicker-inline",this._appendClass="ui-datepicker-append",this._triggerClass="ui-datepicker-trigger",this._dialogClass="ui-datepicker-dialog",this._disableClass="ui-datepicker-disabled",this._unselectableClass="ui-datepicker-unselectable",this._currentClass="ui-datepicker-current-day",this._dayOverClass="ui-datepicker-days-cell-over",this.regional=[],this.regional[""]={closeText:"Done",prevText:"Prev",nextText:"Next",currentText:"Today",monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],monthNamesShort:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],dayNamesShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],dayNamesMin:["Su","Mo","Tu","We","Th","Fr","Sa"],weekHeader:"Wk",dateFormat:"mm/dd/yy",firstDay:0,isRTL:!1,showMonthAfterYear:!1,yearSuffix:""},this._defaults={showOn:"focus",showAnim:"fadeIn",showOptions:{},defaultDate:null,appendText:"",buttonText:"...",buttonImage:"",buttonImageOnly:!1,hideIfNoPrevNext:!1,navigationAsDateFormat:!1,gotoCurrent:!1,changeMonth:!1,changeYear:!1,yearRange:"c-10:c+10",showOtherMonths:!1,selectOtherMonths:!1,showWeek:!1,calculateWeek:this.iso8601Week,shortYearCutoff:"+10",minDate:null,maxDate:null,duration:"fast",beforeShowDay:null,beforeShow:null,onSelect:null,onChangeMonthYear:null,onClose:null,numberOfMonths:1,showCurrentAtPos:0,stepMonths:1,stepBigMonths:12,altField:"",altFormat:"",constrainInput:!0,showButtonPanel:!1,autoSize:!1,disabled:!1},$.extend(this._defaults,this.regional[""]),this.dpDiv=bindHover($('<div id="'+this._mainDivId+'" class="ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all"></div>'))
}function bindHover(e){var t="button, .ui-datepicker-prev, .ui-datepicker-next, .ui-datepicker-calendar td a";
return e.delegate(t,"mouseout",function(){$(this).removeClass("ui-state-hover"),this.className.indexOf("ui-datepicker-prev")!=-1&&$(this).removeClass("ui-datepicker-prev-hover"),this.className.indexOf("ui-datepicker-next")!=-1&&$(this).removeClass("ui-datepicker-next-hover")
}).delegate(t,"mouseover",function(){$.datepicker._isDisabledDatepicker(instActive.inline?e.parent()[0]:instActive.input[0])||($(this).parents(".ui-datepicker-calendar").find("a").removeClass("ui-state-hover"),$(this).addClass("ui-state-hover"),this.className.indexOf("ui-datepicker-prev")!=-1&&$(this).addClass("ui-datepicker-prev-hover"),this.className.indexOf("ui-datepicker-next")!=-1&&$(this).addClass("ui-datepicker-next-hover"))
})}function extendRemove(e,t){$.extend(e,t);for(var n in t){if(t[n]==null||t[n]==undefined){e[n]=t[n]
}}return e}$.extend($.ui,{datepicker:{version:"1.9.2"}});var PROP_NAME="datepicker",dpuuid=(new Date).getTime(),instActive;
$.extend(Datepicker.prototype,{markerClassName:"hasDatepicker",maxRows:4,log:function(){this.debug&&console.log.apply("",arguments)
},_widgetDatepicker:function(){return this.dpDiv},setDefaults:function(e){return extendRemove(this._defaults,e||{}),this
},_attachDatepicker:function(target,settings){var inlineSettings=null;for(var attrName in this._defaults){var attrValue=target.getAttribute("date:"+attrName);
if(attrValue){inlineSettings=inlineSettings||{};try{inlineSettings[attrName]=eval(attrValue)}catch(err){inlineSettings[attrName]=attrValue
}}}var nodeName=target.nodeName.toLowerCase(),inline=nodeName=="div"||nodeName=="span";target.id||(this.uuid+=1,target.id="dp"+this.uuid);
var inst=this._newInst($(target),inline);inst.settings=$.extend({},settings||{},inlineSettings||{}),nodeName=="input"?this._connectDatepicker(target,inst):inline&&this._inlineDatepicker(target,inst)
},_newInst:function(e,t){var n=e[0].id.replace(/([^A-Za-z0-9_-])/g,"\\\\$1");return{id:n,input:e,selectedDay:0,selectedMonth:0,selectedYear:0,drawMonth:0,drawYear:0,inline:t,dpDiv:t?bindHover($('<div class="'+this._inlineClass+' ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all"></div>')):this.dpDiv}
},_connectDatepicker:function(e,t){var n=$(e);t.append=$([]),t.trigger=$([]);if(n.hasClass(this.markerClassName)){return
}this._attachments(n,t),n.addClass(this.markerClassName).keydown(this._doKeyDown).keypress(this._doKeyPress).keyup(this._doKeyUp).bind("setData.datepicker",function(e,n,r){t.settings[n]=r
}).bind("getData.datepicker",function(e,n){return this._get(t,n)}),this._autoSize(t),$.data(e,PROP_NAME,t),t.settings.disabled&&this._disableDatepicker(e)
},_attachments:function(e,t){var n=this._get(t,"appendText"),r=this._get(t,"isRTL");t.append&&t.append.remove(),n&&(t.append=$('<span class="'+this._appendClass+'">'+n+"</span>"),e[r?"before":"after"](t.append)),e.unbind("focus",this._showDatepicker),t.trigger&&t.trigger.remove();
var i=this._get(t,"showOn");(i=="focus"||i=="both")&&e.focus(this._showDatepicker);if(i=="button"||i=="both"){var s=this._get(t,"buttonText"),o=this._get(t,"buttonImage");
t.trigger=$(this._get(t,"buttonImageOnly")?$("<img/>").addClass(this._triggerClass).attr({src:o,alt:s,title:s}):$('<button type="button"></button>').addClass(this._triggerClass).html(o==""?s:$("<img/>").attr({src:o,alt:s,title:s}))),e[r?"before":"after"](t.trigger),t.trigger.click(function(){return $.datepicker._datepickerShowing&&$.datepicker._lastInput==e[0]?$.datepicker._hideDatepicker():$.datepicker._datepickerShowing&&$.datepicker._lastInput!=e[0]?($.datepicker._hideDatepicker(),$.datepicker._showDatepicker(e[0])):$.datepicker._showDatepicker(e[0]),!1
})}},_autoSize:function(e){if(this._get(e,"autoSize")&&!e.inline){var t=new Date(2009,11,20),n=this._get(e,"dateFormat");
if(n.match(/[DM]/)){var r=function(e){var t=0,n=0;for(var r=0;r<e.length;r++){e[r].length>t&&(t=e[r].length,n=r)
}return n};t.setMonth(r(this._get(e,n.match(/MM/)?"monthNames":"monthNamesShort"))),t.setDate(r(this._get(e,n.match(/DD/)?"dayNames":"dayNamesShort"))+20-t.getDay())
}e.input.attr("size",this._formatDate(e,t).length)}},_inlineDatepicker:function(e,t){var n=$(e);if(n.hasClass(this.markerClassName)){return
}n.addClass(this.markerClassName).append(t.dpDiv).bind("setData.datepicker",function(e,n,r){t.settings[n]=r
}).bind("getData.datepicker",function(e,n){return this._get(t,n)}),$.data(e,PROP_NAME,t),this._setDate(t,this._getDefaultDate(t),!0),this._updateDatepicker(t),this._updateAlternate(t),t.settings.disabled&&this._disableDatepicker(e),t.dpDiv.css("display","block")
},_dialogDatepicker:function(e,t,n,r,i){var s=this._dialogInst;if(!s){this.uuid+=1;var o="dp"+this.uuid;
this._dialogInput=$('<input type="text" id="'+o+'" style="position: absolute; top: -100px; width: 0px;"/>'),this._dialogInput.keydown(this._doKeyDown),$("body").append(this._dialogInput),s=this._dialogInst=this._newInst(this._dialogInput,!1),s.settings={},$.data(this._dialogInput[0],PROP_NAME,s)
}extendRemove(s.settings,r||{}),t=t&&t.constructor==Date?this._formatDate(s,t):t,this._dialogInput.val(t),this._pos=i?i.length?i:[i.pageX,i.pageY]:null;
if(!this._pos){var u=document.documentElement.clientWidth,a=document.documentElement.clientHeight,f=document.documentElement.scrollLeft||document.body.scrollLeft,l=document.documentElement.scrollTop||document.body.scrollTop;
this._pos=[u/2-100+f,a/2-150+l]}return this._dialogInput.css("left",this._pos[0]+20+"px").css("top",this._pos[1]+"px"),s.settings.onSelect=n,this._inDialog=!0,this.dpDiv.addClass(this._dialogClass),this._showDatepicker(this._dialogInput[0]),$.blockUI&&$.blockUI(this.dpDiv),$.data(this._dialogInput[0],PROP_NAME,s),this
},_destroyDatepicker:function(e){var t=$(e),n=$.data(e,PROP_NAME);if(!t.hasClass(this.markerClassName)){return
}var r=e.nodeName.toLowerCase();$.removeData(e,PROP_NAME),r=="input"?(n.append.remove(),n.trigger.remove(),t.removeClass(this.markerClassName).unbind("focus",this._showDatepicker).unbind("keydown",this._doKeyDown).unbind("keypress",this._doKeyPress).unbind("keyup",this._doKeyUp)):(r=="div"||r=="span")&&t.removeClass(this.markerClassName).empty()
},_enableDatepicker:function(e){var t=$(e),n=$.data(e,PROP_NAME);if(!t.hasClass(this.markerClassName)){return
}var r=e.nodeName.toLowerCase();if(r=="input"){e.disabled=!1,n.trigger.filter("button").each(function(){this.disabled=!1
}).end().filter("img").css({opacity:"1.0",cursor:""})}else{if(r=="div"||r=="span"){var i=t.children("."+this._inlineClass);
i.children().removeClass("ui-state-disabled"),i.find("select.ui-datepicker-month, select.ui-datepicker-year").prop("disabled",!1)
}}this._disabledInputs=$.map(this._disabledInputs,function(t){return t==e?null:t})},_disableDatepicker:function(e){var t=$(e),n=$.data(e,PROP_NAME);
if(!t.hasClass(this.markerClassName)){return}var r=e.nodeName.toLowerCase();if(r=="input"){e.disabled=!0,n.trigger.filter("button").each(function(){this.disabled=!0
}).end().filter("img").css({opacity:"0.5",cursor:"default"})}else{if(r=="div"||r=="span"){var i=t.children("."+this._inlineClass);
i.children().addClass("ui-state-disabled"),i.find("select.ui-datepicker-month, select.ui-datepicker-year").prop("disabled",!0)
}}this._disabledInputs=$.map(this._disabledInputs,function(t){return t==e?null:t}),this._disabledInputs[this._disabledInputs.length]=e
},_isDisabledDatepicker:function(e){if(!e){return !1}for(var t=0;t<this._disabledInputs.length;t++){if(this._disabledInputs[t]==e){return !0
}}return !1},_getInst:function(e){try{return $.data(e,PROP_NAME)}catch(t){throw"Missing instance data for this datepicker"
}},_optionDatepicker:function(e,t,n){var r=this._getInst(e);if(arguments.length==2&&typeof t=="string"){return t=="defaults"?$.extend({},$.datepicker._defaults):r?t=="all"?$.extend({},r.settings):this._get(r,t):null
}var i=t||{};typeof t=="string"&&(i={},i[t]=n);if(r){this._curInst==r&&this._hideDatepicker();var s=this._getDateDatepicker(e,!0),o=this._getMinMaxDate(r,"min"),u=this._getMinMaxDate(r,"max");
extendRemove(r.settings,i),o!==null&&i.dateFormat!==undefined&&i.minDate===undefined&&(r.settings.minDate=this._formatDate(r,o)),u!==null&&i.dateFormat!==undefined&&i.maxDate===undefined&&(r.settings.maxDate=this._formatDate(r,u)),this._attachments($(e),r),this._autoSize(r),this._setDate(r,s),this._updateAlternate(r),this._updateDatepicker(r)
}},_changeDatepicker:function(e,t,n){this._optionDatepicker(e,t,n)},_refreshDatepicker:function(e){var t=this._getInst(e);
t&&this._updateDatepicker(t)},_setDateDatepicker:function(e,t){var n=this._getInst(e);n&&(this._setDate(n,t),this._updateDatepicker(n),this._updateAlternate(n))
},_getDateDatepicker:function(e,t){var n=this._getInst(e);return n&&!n.inline&&this._setDateFromField(n,t),n?this._getDate(n):null
},_doKeyDown:function(e){var t=$.datepicker._getInst(e.target),n=!0,r=t.dpDiv.is(".ui-datepicker-rtl");
t._keyEvent=!0;if($.datepicker._datepickerShowing){switch(e.keyCode){case 9:$.datepicker._hideDatepicker(),n=!1;
break;case 13:var i=$("td."+$.datepicker._dayOverClass+":not(."+$.datepicker._currentClass+")",t.dpDiv);
i[0]&&$.datepicker._selectDay(e.target,t.selectedMonth,t.selectedYear,i[0]);var s=$.datepicker._get(t,"onSelect");
if(s){var o=$.datepicker._formatDate(t);s.apply(t.input?t.input[0]:null,[o,t])}else{$.datepicker._hideDatepicker()
}return !1;case 27:$.datepicker._hideDatepicker();break;case 33:$.datepicker._adjustDate(e.target,e.ctrlKey?-$.datepicker._get(t,"stepBigMonths"):-$.datepicker._get(t,"stepMonths"),"M");
break;case 34:$.datepicker._adjustDate(e.target,e.ctrlKey?+$.datepicker._get(t,"stepBigMonths"):+$.datepicker._get(t,"stepMonths"),"M");
break;case 35:(e.ctrlKey||e.metaKey)&&$.datepicker._clearDate(e.target),n=e.ctrlKey||e.metaKey;break;
case 36:(e.ctrlKey||e.metaKey)&&$.datepicker._gotoToday(e.target),n=e.ctrlKey||e.metaKey;break;case 37:(e.ctrlKey||e.metaKey)&&$.datepicker._adjustDate(e.target,r?1:-1,"D"),n=e.ctrlKey||e.metaKey,e.originalEvent.altKey&&$.datepicker._adjustDate(e.target,e.ctrlKey?-$.datepicker._get(t,"stepBigMonths"):-$.datepicker._get(t,"stepMonths"),"M");
break;case 38:(e.ctrlKey||e.metaKey)&&$.datepicker._adjustDate(e.target,-7,"D"),n=e.ctrlKey||e.metaKey;
break;case 39:(e.ctrlKey||e.metaKey)&&$.datepicker._adjustDate(e.target,r?-1:1,"D"),n=e.ctrlKey||e.metaKey,e.originalEvent.altKey&&$.datepicker._adjustDate(e.target,e.ctrlKey?+$.datepicker._get(t,"stepBigMonths"):+$.datepicker._get(t,"stepMonths"),"M");
break;case 40:(e.ctrlKey||e.metaKey)&&$.datepicker._adjustDate(e.target,7,"D"),n=e.ctrlKey||e.metaKey;
break;default:n=!1}}else{e.keyCode==36&&e.ctrlKey?$.datepicker._showDatepicker(this):n=!1}n&&(e.preventDefault(),e.stopPropagation())
},_doKeyPress:function(e){var t=$.datepicker._getInst(e.target);if($.datepicker._get(t,"constrainInput")){var n=$.datepicker._possibleChars($.datepicker._get(t,"dateFormat")),r=String.fromCharCode(e.charCode==undefined?e.keyCode:e.charCode);
return e.ctrlKey||e.metaKey||r<" "||!n||n.indexOf(r)>-1}},_doKeyUp:function(e){var t=$.datepicker._getInst(e.target);
if(t.input.val()!=t.lastVal){try{var n=$.datepicker.parseDate($.datepicker._get(t,"dateFormat"),t.input?t.input.val():null,$.datepicker._getFormatConfig(t));
n&&($.datepicker._setDateFromField(t),$.datepicker._updateAlternate(t),$.datepicker._updateDatepicker(t))
}catch(r){$.datepicker.log(r)}}return !0},_showDatepicker:function(e){e=e.target||e,e.nodeName.toLowerCase()!="input"&&(e=$("input",e.parentNode)[0]);
if($.datepicker._isDisabledDatepicker(e)||$.datepicker._lastInput==e){return}var t=$.datepicker._getInst(e);
$.datepicker._curInst&&$.datepicker._curInst!=t&&($.datepicker._curInst.dpDiv.stop(!0,!0),t&&$.datepicker._datepickerShowing&&$.datepicker._hideDatepicker($.datepicker._curInst.input[0]));
var n=$.datepicker._get(t,"beforeShow"),r=n?n.apply(e,[e,t]):{};if(r===!1){return}extendRemove(t.settings,r),t.lastVal=null,$.datepicker._lastInput=e,$.datepicker._setDateFromField(t),$.datepicker._inDialog&&(e.value=""),$.datepicker._pos||($.datepicker._pos=$.datepicker._findPos(e),$.datepicker._pos[1]+=e.offsetHeight);
var i=!1;$(e).parents().each(function(){return i|=$(this).css("position")=="fixed",!i});var s={left:$.datepicker._pos[0],top:$.datepicker._pos[1]};
$.datepicker._pos=null,t.dpDiv.empty(),t.dpDiv.css({position:"absolute",display:"block",top:"-1000px"}),$.datepicker._updateDatepicker(t),s=$.datepicker._checkOffset(t,s,i),t.dpDiv.css({position:$.datepicker._inDialog&&$.blockUI?"static":i?"fixed":"absolute",display:"none",left:s.left+"px",top:s.top+"px"});
if(!t.inline){var o=$.datepicker._get(t,"showAnim"),u=$.datepicker._get(t,"duration"),a=function(){var e=t.dpDiv.find("iframe.ui-datepicker-cover");
if(!!e.length){var n=$.datepicker._getBorders(t.dpDiv);e.css({left:-n[0],top:-n[1],width:t.dpDiv.outerWidth(),height:t.dpDiv.outerHeight()})
}};t.dpDiv.zIndex($(e).zIndex()+1),$.datepicker._datepickerShowing=!0,$.effects&&($.effects.effect[o]||$.effects[o])?t.dpDiv.show(o,$.datepicker._get(t,"showOptions"),u,a):t.dpDiv[o||"show"](o?u:null,a),(!o||!u)&&a(),t.input.is(":visible")&&!t.input.is(":disabled")&&t.input.focus(),$.datepicker._curInst=t
}},_updateDatepicker:function(e){this.maxRows=4;var t=$.datepicker._getBorders(e.dpDiv);instActive=e,e.dpDiv.empty().append(this._generateHTML(e)),this._attachHandlers(e);
var n=e.dpDiv.find("iframe.ui-datepicker-cover");!n.length||n.css({left:-t[0],top:-t[1],width:e.dpDiv.outerWidth(),height:e.dpDiv.outerHeight()}),e.dpDiv.find("."+this._dayOverClass+" a").mouseover();
var r=this._getNumberOfMonths(e),i=r[1],s=17;e.dpDiv.removeClass("ui-datepicker-multi-2 ui-datepicker-multi-3 ui-datepicker-multi-4").width(""),i>1&&e.dpDiv.addClass("ui-datepicker-multi-"+i).css("width",s*i+"em"),e.dpDiv[(r[0]!=1||r[1]!=1?"add":"remove")+"Class"]("ui-datepicker-multi"),e.dpDiv[(this._get(e,"isRTL")?"add":"remove")+"Class"]("ui-datepicker-rtl"),e==$.datepicker._curInst&&$.datepicker._datepickerShowing&&e.input&&e.input.is(":visible")&&!e.input.is(":disabled")&&e.input[0]!=document.activeElement&&e.input.focus();
if(e.yearshtml){var o=e.yearshtml;setTimeout(function(){o===e.yearshtml&&e.yearshtml&&e.dpDiv.find("select.ui-datepicker-year:first").replaceWith(e.yearshtml),o=e.yearshtml=null
},0)}},_getBorders:function(e){var t=function(e){return{thin:1,medium:2,thick:3}[e]||e};return[parseFloat(t(e.css("border-left-width"))),parseFloat(t(e.css("border-top-width")))]
},_checkOffset:function(e,t,n){var r=e.dpDiv.outerWidth(),i=e.dpDiv.outerHeight(),s=e.input?e.input.outerWidth():0,o=e.input?e.input.outerHeight():0,u=document.documentElement.clientWidth+(n?0:$(document).scrollLeft()),a=document.documentElement.clientHeight+(n?0:$(document).scrollTop());
return t.left-=this._get(e,"isRTL")?r-s:0,t.left-=n&&t.left==e.input.offset().left?$(document).scrollLeft():0,t.top-=n&&t.top==e.input.offset().top+o?$(document).scrollTop():0,t.left-=Math.min(t.left,t.left+r>u&&u>r?Math.abs(t.left+r-u):0),t.top-=Math.min(t.top,t.top+i>a&&a>i?Math.abs(i+o):0),t
},_findPos:function(e){var t=this._getInst(e),n=this._get(t,"isRTL");while(e&&(e.type=="hidden"||e.nodeType!=1||$.expr.filters.hidden(e))){e=e[n?"previousSibling":"nextSibling"]
}var r=$(e).offset();return[r.left,r.top]},_hideDatepicker:function(e){var t=this._curInst;if(!t||e&&t!=$.data(e,PROP_NAME)){return
}if(this._datepickerShowing){var n=this._get(t,"showAnim"),r=this._get(t,"duration"),i=function(){$.datepicker._tidyDialog(t)
};$.effects&&($.effects.effect[n]||$.effects[n])?t.dpDiv.hide(n,$.datepicker._get(t,"showOptions"),r,i):t.dpDiv[n=="slideDown"?"slideUp":n=="fadeIn"?"fadeOut":"hide"](n?r:null,i),n||i(),this._datepickerShowing=!1;
var s=this._get(t,"onClose");s&&s.apply(t.input?t.input[0]:null,[t.input?t.input.val():"",t]),this._lastInput=null,this._inDialog&&(this._dialogInput.css({position:"absolute",left:"0",top:"-100px"}),$.blockUI&&($.unblockUI(),$("body").append(this.dpDiv))),this._inDialog=!1
}},_tidyDialog:function(e){e.dpDiv.removeClass(this._dialogClass).unbind(".ui-datepicker-calendar")},_checkExternalClick:function(e){if(!$.datepicker._curInst){return
}var t=$(e.target),n=$.datepicker._getInst(t[0]);(t[0].id!=$.datepicker._mainDivId&&t.parents("#"+$.datepicker._mainDivId).length==0&&!t.hasClass($.datepicker.markerClassName)&&!t.closest("."+$.datepicker._triggerClass).length&&$.datepicker._datepickerShowing&&(!$.datepicker._inDialog||!$.blockUI)||t.hasClass($.datepicker.markerClassName)&&$.datepicker._curInst!=n)&&$.datepicker._hideDatepicker()
},_adjustDate:function(e,t,n){var r=$(e),i=this._getInst(r[0]);if(this._isDisabledDatepicker(r[0])){return
}this._adjustInstDate(i,t+(n=="M"?this._get(i,"showCurrentAtPos"):0),n),this._updateDatepicker(i)},_gotoToday:function(e){var t=$(e),n=this._getInst(t[0]);
if(this._get(n,"gotoCurrent")&&n.currentDay){n.selectedDay=n.currentDay,n.drawMonth=n.selectedMonth=n.currentMonth,n.drawYear=n.selectedYear=n.currentYear
}else{var r=new Date;n.selectedDay=r.getDate(),n.drawMonth=n.selectedMonth=r.getMonth(),n.drawYear=n.selectedYear=r.getFullYear()
}this._notifyChange(n),this._adjustDate(t)},_selectMonthYear:function(e,t,n){var r=$(e),i=this._getInst(r[0]);
i["selected"+(n=="M"?"Month":"Year")]=i["draw"+(n=="M"?"Month":"Year")]=parseInt(t.options[t.selectedIndex].value,10),this._notifyChange(i),this._adjustDate(r)
},_selectDay:function(e,t,n,r){var i=$(e);if($(r).hasClass(this._unselectableClass)||this._isDisabledDatepicker(i[0])){return
}var s=this._getInst(i[0]);s.selectedDay=s.currentDay=$("a",r).html(),s.selectedMonth=s.currentMonth=t,s.selectedYear=s.currentYear=n,this._selectDate(e,this._formatDate(s,s.currentDay,s.currentMonth,s.currentYear))
},_clearDate:function(e){var t=$(e),n=this._getInst(t[0]);this._selectDate(t,"")},_selectDate:function(e,t){var n=$(e),r=this._getInst(n[0]);
t=t!=null?t:this._formatDate(r),r.input&&r.input.val(t),this._updateAlternate(r);var i=this._get(r,"onSelect");
i?i.apply(r.input?r.input[0]:null,[t,r]):r.input&&r.input.trigger("change"),r.inline?this._updateDatepicker(r):(this._hideDatepicker(),this._lastInput=r.input[0],typeof r.input[0]!="object"&&r.input.focus(),this._lastInput=null)
},_updateAlternate:function(e){var t=this._get(e,"altField");if(t){var n=this._get(e,"altFormat")||this._get(e,"dateFormat"),r=this._getDate(e),i=this.formatDate(n,r,this._getFormatConfig(e));
$(t).each(function(){$(this).val(i)})}},noWeekends:function(e){var t=e.getDay();return[t>0&&t<6,""]},iso8601Week:function(e){var t=new Date(e.getTime());
t.setDate(t.getDate()+4-(t.getDay()||7));var n=t.getTime();return t.setMonth(0),t.setDate(1),Math.floor(Math.round((n-t)/86400000)/7)+1
},parseDate:function(e,t,n){if(e==null||t==null){throw"Invalid arguments"}t=typeof t=="object"?t.toString():t+"";
if(t==""){return null}var r=(n?n.shortYearCutoff:null)||this._defaults.shortYearCutoff;r=typeof r!="string"?r:(new Date).getFullYear()%100+parseInt(r,10);
var i=(n?n.dayNamesShort:null)||this._defaults.dayNamesShort,s=(n?n.dayNames:null)||this._defaults.dayNames,o=(n?n.monthNamesShort:null)||this._defaults.monthNamesShort,u=(n?n.monthNames:null)||this._defaults.monthNames,a=-1,f=-1,l=-1,c=-1,h=!1,p=function(t){var n=y+1<e.length&&e.charAt(y+1)==t;
return n&&y++,n},d=function(e){var n=p(e),r=e=="@"?14:e=="!"?20:e=="y"&&n?4:e=="o"?3:2,i=new RegExp("^\\d{1,"+r+"}"),s=t.substring(g).match(i);
if(!s){throw"Missing number at position "+g}return g+=s[0].length,parseInt(s[0],10)},v=function(e,n,r){var i=$.map(p(e)?r:n,function(e,t){return[[t,e]]
}).sort(function(e,t){return -(e[1].length-t[1].length)}),s=-1;$.each(i,function(e,n){var r=n[1];if(t.substr(g,r.length).toLowerCase()==r.toLowerCase()){return s=n[0],g+=r.length,!1
}});if(s!=-1){return s+1}throw"Unknown name at position "+g},m=function(){if(t.charAt(g)!=e.charAt(y)){throw"Unexpected literal at position "+g
}g++},g=0;for(var y=0;y<e.length;y++){if(h){e.charAt(y)=="'"&&!p("'")?h=!1:m()}else{switch(e.charAt(y)){case"d":l=d("d");
break;case"D":v("D",i,s);break;case"o":c=d("o");break;case"m":f=d("m");break;case"M":f=v("M",o,u);break;
case"y":a=d("y");break;case"@":var b=new Date(d("@"));a=b.getFullYear(),f=b.getMonth()+1,l=b.getDate();
break;case"!":var b=new Date((d("!")-this._ticksTo1970)/10000);a=b.getFullYear(),f=b.getMonth()+1,l=b.getDate();
break;case"'":p("'")?m():h=!0;break;default:m()}}}if(g<t.length){var w=t.substr(g);if(!/^\s+/.test(w)){throw"Extra/unparsed characters found in date: "+w
}}a==-1?a=(new Date).getFullYear():a<100&&(a+=(new Date).getFullYear()-(new Date).getFullYear()%100+(a<=r?0:-100));
if(c>-1){f=1,l=c;do{var E=this._getDaysInMonth(a,f-1);if(l<=E){break}f++,l-=E}while(!0)}var b=this._daylightSavingAdjust(new Date(a,f-1,l));
if(b.getFullYear()!=a||b.getMonth()+1!=f||b.getDate()!=l){throw"Invalid date"}return b},ATOM:"yy-mm-dd",COOKIE:"D, dd M yy",ISO_8601:"yy-mm-dd",RFC_822:"D, d M y",RFC_850:"DD, dd-M-y",RFC_1036:"D, d M y",RFC_1123:"D, d M yy",RFC_2822:"D, d M yy",RSS:"D, d M y",TICKS:"!",TIMESTAMP:"@",W3C:"yy-mm-dd",_ticksTo1970:(718685+Math.floor(492.5)-Math.floor(19.7)+Math.floor(4.925))*24*60*60*10000000,formatDate:function(e,t,n){if(!t){return""
}var r=(n?n.dayNamesShort:null)||this._defaults.dayNamesShort,i=(n?n.dayNames:null)||this._defaults.dayNames,s=(n?n.monthNamesShort:null)||this._defaults.monthNamesShort,o=(n?n.monthNames:null)||this._defaults.monthNames,u=function(t){var n=h+1<e.length&&e.charAt(h+1)==t;
return n&&h++,n},a=function(e,t,n){var r=""+t;if(u(e)){while(r.length<n){r="0"+r}}return r},f=function(e,t,n,r){return u(e)?r[t]:n[t]
},l="",c=!1;if(t){for(var h=0;h<e.length;h++){if(c){e.charAt(h)=="'"&&!u("'")?c=!1:l+=e.charAt(h)}else{switch(e.charAt(h)){case"d":l+=a("d",t.getDate(),2);
break;case"D":l+=f("D",t.getDay(),r,i);break;case"o":l+=a("o",Math.round(((new Date(t.getFullYear(),t.getMonth(),t.getDate())).getTime()-(new Date(t.getFullYear(),0,0)).getTime())/86400000),3);
break;case"m":l+=a("m",t.getMonth()+1,2);break;case"M":l+=f("M",t.getMonth(),s,o);break;case"y":l+=u("y")?t.getFullYear():(t.getYear()%100<10?"0":"")+t.getYear()%100;
break;case"@":l+=t.getTime();break;case"!":l+=t.getTime()*10000+this._ticksTo1970;break;case"'":u("'")?l+="'":c=!0;
break;default:l+=e.charAt(h)}}}}return l},_possibleChars:function(e){var t="",n=!1,r=function(t){var n=i+1<e.length&&e.charAt(i+1)==t;
return n&&i++,n};for(var i=0;i<e.length;i++){if(n){e.charAt(i)=="'"&&!r("'")?n=!1:t+=e.charAt(i)}else{switch(e.charAt(i)){case"d":case"m":case"y":case"@":t+="0123456789";
break;case"D":case"M":return null;case"'":r("'")?t+="'":n=!0;break;default:t+=e.charAt(i)}}}return t},_get:function(e,t){return e.settings[t]!==undefined?e.settings[t]:this._defaults[t]
},_setDateFromField:function(e,t){if(e.input.val()==e.lastVal){return}var n=this._get(e,"dateFormat"),r=e.lastVal=e.input?e.input.val():null,i,s;
i=s=this._getDefaultDate(e);var o=this._getFormatConfig(e);try{i=this.parseDate(n,r,o)||s}catch(u){this.log(u),r=t?"":r
}e.selectedDay=i.getDate(),e.drawMonth=e.selectedMonth=i.getMonth(),e.drawYear=e.selectedYear=i.getFullYear(),e.currentDay=r?i.getDate():0,e.currentMonth=r?i.getMonth():0,e.currentYear=r?i.getFullYear():0,this._adjustInstDate(e)
},_getDefaultDate:function(e){return this._restrictMinMax(e,this._determineDate(e,this._get(e,"defaultDate"),new Date))
},_determineDate:function(e,t,n){var r=function(e){var t=new Date;return t.setDate(t.getDate()+e),t},i=function(t){try{return $.datepicker.parseDate($.datepicker._get(e,"dateFormat"),t,$.datepicker._getFormatConfig(e))
}catch(n){}var r=(t.toLowerCase().match(/^c/)?$.datepicker._getDate(e):null)||new Date,i=r.getFullYear(),s=r.getMonth(),o=r.getDate(),u=/([+-]?[0-9]+)\s*(d|D|w|W|m|M|y|Y)?/g,a=u.exec(t);
while(a){switch(a[2]||"d"){case"d":case"D":o+=parseInt(a[1],10);break;case"w":case"W":o+=parseInt(a[1],10)*7;
break;case"m":case"M":s+=parseInt(a[1],10),o=Math.min(o,$.datepicker._getDaysInMonth(i,s));break;case"y":case"Y":i+=parseInt(a[1],10),o=Math.min(o,$.datepicker._getDaysInMonth(i,s))
}a=u.exec(t)}return new Date(i,s,o)},s=t==null||t===""?n:typeof t=="string"?i(t):typeof t=="number"?isNaN(t)?n:r(t):new Date(t.getTime());
return s=s&&s.toString()=="Invalid Date"?n:s,s&&(s.setHours(0),s.setMinutes(0),s.setSeconds(0),s.setMilliseconds(0)),this._daylightSavingAdjust(s)
},_daylightSavingAdjust:function(e){return e?(e.setHours(e.getHours()>12?e.getHours()+2:0),e):null},_setDate:function(e,t,n){var r=!t,i=e.selectedMonth,s=e.selectedYear,o=this._restrictMinMax(e,this._determineDate(e,t,new Date));
e.selectedDay=e.currentDay=o.getDate(),e.drawMonth=e.selectedMonth=e.currentMonth=o.getMonth(),e.drawYear=e.selectedYear=e.currentYear=o.getFullYear(),(i!=e.selectedMonth||s!=e.selectedYear)&&!n&&this._notifyChange(e),this._adjustInstDate(e),e.input&&e.input.val(r?"":this._formatDate(e))
},_getDate:function(e){var t=!e.currentYear||e.input&&e.input.val()==""?null:this._daylightSavingAdjust(new Date(e.currentYear,e.currentMonth,e.currentDay));
return t},_attachHandlers:function(e){var t=this._get(e,"stepMonths"),n="#"+e.id.replace(/\\\\/g,"\\");
e.dpDiv.find("[data-handler]").map(function(){var e={prev:function(){window["DP_jQuery_"+dpuuid].datepicker._adjustDate(n,-t,"M")
},next:function(){window["DP_jQuery_"+dpuuid].datepicker._adjustDate(n,+t,"M")},hide:function(){window["DP_jQuery_"+dpuuid].datepicker._hideDatepicker()
},today:function(){window["DP_jQuery_"+dpuuid].datepicker._gotoToday(n)},selectDay:function(){return window["DP_jQuery_"+dpuuid].datepicker._selectDay(n,+this.getAttribute("data-month"),+this.getAttribute("data-year"),this),!1
},selectMonth:function(){return window["DP_jQuery_"+dpuuid].datepicker._selectMonthYear(n,this,"M"),!1
},selectYear:function(){return window["DP_jQuery_"+dpuuid].datepicker._selectMonthYear(n,this,"Y"),!1
}};$(this).bind(this.getAttribute("data-event"),e[this.getAttribute("data-handler")])})},_generateHTML:function(e){var t=new Date;
t=this._daylightSavingAdjust(new Date(t.getFullYear(),t.getMonth(),t.getDate()));var n=this._get(e,"isRTL"),r=this._get(e,"showButtonPanel"),i=this._get(e,"hideIfNoPrevNext"),s=this._get(e,"navigationAsDateFormat"),o=this._getNumberOfMonths(e),u=this._get(e,"showCurrentAtPos"),a=this._get(e,"stepMonths"),f=o[0]!=1||o[1]!=1,l=this._daylightSavingAdjust(e.currentDay?new Date(e.currentYear,e.currentMonth,e.currentDay):new Date(9999,9,9)),c=this._getMinMaxDate(e,"min"),h=this._getMinMaxDate(e,"max"),p=e.drawMonth-u,d=e.drawYear;
p<0&&(p+=12,d--);if(h){var v=this._daylightSavingAdjust(new Date(h.getFullYear(),h.getMonth()-o[0]*o[1]+1,h.getDate()));
v=c&&v<c?c:v;while(this._daylightSavingAdjust(new Date(d,p,1))>v){p--,p<0&&(p=11,d--)}}e.drawMonth=p,e.drawYear=d;
var m=this._get(e,"prevText");m=s?this.formatDate(m,this._daylightSavingAdjust(new Date(d,p-a,1)),this._getFormatConfig(e)):m;
var g=this._canAdjustMonth(e,-1,d,p)?'<a class="ui-datepicker-prev ui-corner-all" data-handler="prev" data-event="click" title="'+m+'"><span class="ui-icon ui-icon-circle-triangle-'+(n?"e":"w")+'">'+m+"</span></a>":i?"":'<a class="ui-datepicker-prev ui-corner-all ui-state-disabled" title="'+m+'"><span class="ui-icon ui-icon-circle-triangle-'+(n?"e":"w")+'">'+m+"</span></a>",y=this._get(e,"nextText");
y=s?this.formatDate(y,this._daylightSavingAdjust(new Date(d,p+a,1)),this._getFormatConfig(e)):y;var b=this._canAdjustMonth(e,1,d,p)?'<a class="ui-datepicker-next ui-corner-all" data-handler="next" data-event="click" title="'+y+'"><span class="ui-icon ui-icon-circle-triangle-'+(n?"w":"e")+'">'+y+"</span></a>":i?"":'<a class="ui-datepicker-next ui-corner-all ui-state-disabled" title="'+y+'"><span class="ui-icon ui-icon-circle-triangle-'+(n?"w":"e")+'">'+y+"</span></a>",w=this._get(e,"currentText"),E=this._get(e,"gotoCurrent")&&e.currentDay?l:t;
w=s?this.formatDate(w,E,this._getFormatConfig(e)):w;var S=e.inline?"":'<button type="button" class="ui-datepicker-close ui-state-default ui-priority-primary ui-corner-all" data-handler="hide" data-event="click">'+this._get(e,"closeText")+"</button>",x=r?'<div class="ui-datepicker-buttonpane ui-widget-content">'+(n?S:"")+(this._isInRange(e,E)?'<button type="button" class="ui-datepicker-current ui-state-default ui-priority-secondary ui-corner-all" data-handler="today" data-event="click">'+w+"</button>":"")+(n?"":S)+"</div>":"",T=parseInt(this._get(e,"firstDay"),10);
T=isNaN(T)?0:T;var N=this._get(e,"showWeek"),C=this._get(e,"dayNames"),k=this._get(e,"dayNamesShort"),L=this._get(e,"dayNamesMin"),A=this._get(e,"monthNames"),O=this._get(e,"monthNamesShort"),M=this._get(e,"beforeShowDay"),_=this._get(e,"showOtherMonths"),D=this._get(e,"selectOtherMonths"),P=this._get(e,"calculateWeek")||this.iso8601Week,H=this._getDefaultDate(e),B="";
for(var j=0;j<o[0];j++){var F="";this.maxRows=4;for(var I=0;I<o[1];I++){var q=this._daylightSavingAdjust(new Date(d,p,e.selectedDay)),R=" ui-corner-all",U="";
if(f){U+='<div class="ui-datepicker-group';if(o[1]>1){switch(I){case 0:U+=" ui-datepicker-group-first",R=" ui-corner-"+(n?"right":"left");
break;case o[1]-1:U+=" ui-datepicker-group-last",R=" ui-corner-"+(n?"left":"right");break;default:U+=" ui-datepicker-group-middle",R=""
}}U+='">'}U+='<div class="ui-datepicker-header ui-widget-header ui-helper-clearfix'+R+'">'+(/all|left/.test(R)&&j==0?n?b:g:"")+(/all|right/.test(R)&&j==0?n?g:b:"")+this._generateMonthYearHeader(e,p,d,c,h,j>0||I>0,A,O)+'</div><table class="ui-datepicker-calendar"><thead>'+"<tr>";
var z=N?'<th class="ui-datepicker-week-col">'+this._get(e,"weekHeader")+"</th>":"";for(var W=0;W<7;W++){var X=(W+T)%7;
z+="<th"+((W+T+6)%7>=5?' class="ui-datepicker-week-end"':"")+">"+'<span title="'+C[X]+'">'+L[X]+"</span></th>"
}U+=z+"</tr></thead><tbody>";var V=this._getDaysInMonth(d,p);d==e.selectedYear&&p==e.selectedMonth&&(e.selectedDay=Math.min(e.selectedDay,V));
var J=(this._getFirstDayOfMonth(d,p)-T+7)%7,K=Math.ceil((J+V)/7),Q=f?this.maxRows>K?this.maxRows:K:K;
this.maxRows=Q;var G=this._daylightSavingAdjust(new Date(d,p,1-J));for(var Y=0;Y<Q;Y++){U+="<tr>";var Z=N?'<td class="ui-datepicker-week-col">'+this._get(e,"calculateWeek")(G)+"</td>":"";
for(var W=0;W<7;W++){var et=M?M.apply(e.input?e.input[0]:null,[G]):[!0,""],tt=G.getMonth()!=p,nt=tt&&!D||!et[0]||c&&G<c||h&&G>h;
Z+='<td class="'+((W+T+6)%7>=5?" ui-datepicker-week-end":"")+(tt?" ui-datepicker-other-month":"")+(G.getTime()==q.getTime()&&p==e.selectedMonth&&e._keyEvent||H.getTime()==G.getTime()&&H.getTime()==q.getTime()?" "+this._dayOverClass:"")+(nt?" "+this._unselectableClass+" ui-state-disabled":"")+(tt&&!_?"":" "+et[1]+(G.getTime()==l.getTime()?" "+this._currentClass:"")+(G.getTime()==t.getTime()?" ui-datepicker-today":""))+'"'+((!tt||_)&&et[2]?' title="'+et[2]+'"':"")+(nt?"":' data-handler="selectDay" data-event="click" data-month="'+G.getMonth()+'" data-year="'+G.getFullYear()+'"')+">"+(tt&&!_?"&#xa0;":nt?'<span class="ui-state-default">'+G.getDate()+"</span>":'<a class="ui-state-default'+(G.getTime()==t.getTime()?" ui-state-highlight":"")+(G.getTime()==l.getTime()?" ui-state-active":"")+(tt?" ui-priority-secondary":"")+'" href="#">'+G.getDate()+"</a>")+"</td>",G.setDate(G.getDate()+1),G=this._daylightSavingAdjust(G)
}U+=Z+"</tr>"}p++,p>11&&(p=0,d++),U+="</tbody></table>"+(f?"</div>"+(o[0]>0&&I==o[1]-1?'<div class="ui-datepicker-row-break"></div>':""):""),F+=U
}B+=F}return B+=x+($.ui.ie6&&!e.inline?'<iframe src="javascript:false;" class="ui-datepicker-cover" frameborder="0"></iframe>':""),e._keyEvent=!1,B
},_generateMonthYearHeader:function(e,t,n,r,i,s,o,u){var a=this._get(e,"changeMonth"),f=this._get(e,"changeYear"),l=this._get(e,"showMonthAfterYear"),c='<div class="ui-datepicker-title">',h="";
if(s||!a){h+='<span class="ui-datepicker-month">'+o[t]+"</span>"}else{var p=r&&r.getFullYear()==n,d=i&&i.getFullYear()==n;
h+='<select class="ui-datepicker-month" data-handler="selectMonth" data-event="change">';for(var v=0;
v<12;v++){(!p||v>=r.getMonth())&&(!d||v<=i.getMonth())&&(h+='<option value="'+v+'"'+(v==t?' selected="selected"':"")+">"+u[v]+"</option>")
}h+="</select>"}l||(c+=h+(s||!a||!f?"&#xa0;":""));if(!e.yearshtml){e.yearshtml="";if(s||!f){c+='<span class="ui-datepicker-year">'+n+"</span>"
}else{var m=this._get(e,"yearRange").split(":"),g=(new Date).getFullYear(),y=function(e){var t=e.match(/c[+-].*/)?n+parseInt(e.substring(1),10):e.match(/[+-].*/)?g+parseInt(e,10):parseInt(e,10);
return isNaN(t)?g:t},b=y(m[0]),w=Math.max(b,y(m[1]||""));b=r?Math.max(b,r.getFullYear()):b,w=i?Math.min(w,i.getFullYear()):w,e.yearshtml+='<select class="ui-datepicker-year" data-handler="selectYear" data-event="change">';
for(;b<=w;b++){e.yearshtml+='<option value="'+b+'"'+(b==n?' selected="selected"':"")+">"+b+"</option>"
}e.yearshtml+="</select>",c+=e.yearshtml,e.yearshtml=null}}return c+=this._get(e,"yearSuffix"),l&&(c+=(s||!a||!f?"&#xa0;":"")+h),c+="</div>",c
},_adjustInstDate:function(e,t,n){var r=e.drawYear+(n=="Y"?t:0),i=e.drawMonth+(n=="M"?t:0),s=Math.min(e.selectedDay,this._getDaysInMonth(r,i))+(n=="D"?t:0),o=this._restrictMinMax(e,this._daylightSavingAdjust(new Date(r,i,s)));
e.selectedDay=o.getDate(),e.drawMonth=e.selectedMonth=o.getMonth(),e.drawYear=e.selectedYear=o.getFullYear(),(n=="M"||n=="Y")&&this._notifyChange(e)
},_restrictMinMax:function(e,t){var n=this._getMinMaxDate(e,"min"),r=this._getMinMaxDate(e,"max"),i=n&&t<n?n:t;
return i=r&&i>r?r:i,i},_notifyChange:function(e){var t=this._get(e,"onChangeMonthYear");t&&t.apply(e.input?e.input[0]:null,[e.selectedYear,e.selectedMonth+1,e])
},_getNumberOfMonths:function(e){var t=this._get(e,"numberOfMonths");return t==null?[1,1]:typeof t=="number"?[1,t]:t
},_getMinMaxDate:function(e,t){return this._determineDate(e,this._get(e,t+"Date"),null)},_getDaysInMonth:function(e,t){return 32-this._daylightSavingAdjust(new Date(e,t,32)).getDate()
},_getFirstDayOfMonth:function(e,t){return(new Date(e,t,1)).getDay()},_canAdjustMonth:function(e,t,n,r){var i=this._getNumberOfMonths(e),s=this._daylightSavingAdjust(new Date(n,r+(t<0?t:i[0]*i[1]),1));
return t<0&&s.setDate(this._getDaysInMonth(s.getFullYear(),s.getMonth())),this._isInRange(e,s)},_isInRange:function(e,t){var n=this._getMinMaxDate(e,"min"),r=this._getMinMaxDate(e,"max");
return(!n||t.getTime()>=n.getTime())&&(!r||t.getTime()<=r.getTime())},_getFormatConfig:function(e){var t=this._get(e,"shortYearCutoff");
return t=typeof t!="string"?t:(new Date).getFullYear()%100+parseInt(t,10),{shortYearCutoff:t,dayNamesShort:this._get(e,"dayNamesShort"),dayNames:this._get(e,"dayNames"),monthNamesShort:this._get(e,"monthNamesShort"),monthNames:this._get(e,"monthNames")}
},_formatDate:function(e,t,n,r){t||(e.currentDay=e.selectedDay,e.currentMonth=e.selectedMonth,e.currentYear=e.selectedYear);
var i=t?typeof t=="object"?t:this._daylightSavingAdjust(new Date(r,n,t)):this._daylightSavingAdjust(new Date(e.currentYear,e.currentMonth,e.currentDay));
return this.formatDate(this._get(e,"dateFormat"),i,this._getFormatConfig(e))}}),$.fn.datepicker=function(e){if(!this.length){return this
}$.datepicker.initialized||($(document).mousedown($.datepicker._checkExternalClick).find(document.body).append($.datepicker.dpDiv),$.datepicker.initialized=!0);
var t=Array.prototype.slice.call(arguments,1);return typeof e!="string"||e!="isDisabled"&&e!="getDate"&&e!="widget"?e=="option"&&arguments.length==2&&typeof arguments[1]=="string"?$.datepicker["_"+e+"Datepicker"].apply($.datepicker,[this[0]].concat(t)):this.each(function(){typeof e=="string"?$.datepicker["_"+e+"Datepicker"].apply($.datepicker,[this].concat(t)):$.datepicker._attachDatepicker(this,e)
}):$.datepicker["_"+e+"Datepicker"].apply($.datepicker,[this[0]].concat(t))},$.datepicker=new Datepicker,$.datepicker.initialized=!1,$.datepicker.uuid=(new Date).getTime(),$.datepicker.version="1.9.2",window["DP_jQuery_"+dpuuid]=$
})(jQuery);(function(e,t){var n=!1;e.widget("ui.menu",{version:"1.9.2",defaultElement:"<ul>",delay:300,options:{icons:{submenu:"ui-icon-carat-1-e"},menus:"ul",position:{my:"left top",at:"right top"},role:"menu",blur:null,focus:null,select:null},_create:function(){this.activeMenu=this.element,this.element.uniqueId().addClass("ui-menu ui-widget ui-widget-content ui-corner-all").toggleClass("ui-menu-icons",!!this.element.find(".ui-icon").length).attr({role:this.options.role,tabIndex:0}).bind("click"+this.eventNamespace,e.proxy(function(e){this.options.disabled&&e.preventDefault()
},this)),this.options.disabled&&this.element.addClass("ui-state-disabled").attr("aria-disabled","true"),this._on({"mousedown .ui-menu-item > a":function(e){e.preventDefault()
},"click .ui-state-disabled > a":function(e){e.preventDefault()},"click .ui-menu-item:has(a)":function(t){var r=e(t.target).closest(".ui-menu-item");
!n&&r.not(".ui-state-disabled").length&&(n=!0,this.select(t),r.has(".ui-menu").length?this.expand(t):this.element.is(":focus")||(this.element.trigger("focus",[!0]),this.active&&this.active.parents(".ui-menu").length===1&&clearTimeout(this.timer)))
},"mouseenter .ui-menu-item":function(t){var n=e(t.currentTarget);n.siblings().children(".ui-state-active").removeClass("ui-state-active"),this.focus(t,n)
},mouseleave:"collapseAll","mouseleave .ui-menu":"collapseAll",focus:function(e,t){var n=this.active||this.element.children(".ui-menu-item").eq(0);
t||this.focus(e,n)},blur:function(t){this._delay(function(){e.contains(this.element[0],this.document[0].activeElement)||this.collapseAll(t)
})},keydown:"_keydown"}),this.refresh(),this._on(this.document,{click:function(t){e(t.target).closest(".ui-menu").length||this.collapseAll(t),n=!1
}})},_destroy:function(){this.element.removeAttr("aria-activedescendant").find(".ui-menu").andSelf().removeClass("ui-menu ui-widget ui-widget-content ui-corner-all ui-menu-icons").removeAttr("role").removeAttr("tabIndex").removeAttr("aria-labelledby").removeAttr("aria-expanded").removeAttr("aria-hidden").removeAttr("aria-disabled").removeUniqueId().show(),this.element.find(".ui-menu-item").removeClass("ui-menu-item").removeAttr("role").removeAttr("aria-disabled").children("a").removeUniqueId().removeClass("ui-corner-all ui-state-hover").removeAttr("tabIndex").removeAttr("role").removeAttr("aria-haspopup").children().each(function(){var t=e(this);
t.data("ui-menu-submenu-carat")&&t.remove()}),this.element.find(".ui-menu-divider").removeClass("ui-menu-divider ui-widget-content")
},_keydown:function(t){function a(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}var n,r,i,s,o,u=!0;
switch(t.keyCode){case e.ui.keyCode.PAGE_UP:this.previousPage(t);break;case e.ui.keyCode.PAGE_DOWN:this.nextPage(t);
break;case e.ui.keyCode.HOME:this._move("first","first",t);break;case e.ui.keyCode.END:this._move("last","last",t);
break;case e.ui.keyCode.UP:this.previous(t);break;case e.ui.keyCode.DOWN:this.next(t);break;case e.ui.keyCode.LEFT:this.collapse(t);
break;case e.ui.keyCode.RIGHT:this.active&&!this.active.is(".ui-state-disabled")&&this.expand(t);break;
case e.ui.keyCode.ENTER:case e.ui.keyCode.SPACE:this._activate(t);break;case e.ui.keyCode.ESCAPE:this.collapse(t);
break;default:u=!1,r=this.previousFilter||"",i=String.fromCharCode(t.keyCode),s=!1,clearTimeout(this.filterTimer),i===r?s=!0:i=r+i,o=new RegExp("^"+a(i),"i"),n=this.activeMenu.children(".ui-menu-item").filter(function(){return o.test(e(this).children("a").text())
}),n=s&&n.index(this.active.next())!==-1?this.active.nextAll(".ui-menu-item"):n,n.length||(i=String.fromCharCode(t.keyCode),o=new RegExp("^"+a(i),"i"),n=this.activeMenu.children(".ui-menu-item").filter(function(){return o.test(e(this).children("a").text())
})),n.length?(this.focus(t,n),n.length>1?(this.previousFilter=i,this.filterTimer=this._delay(function(){delete this.previousFilter
},1000)):delete this.previousFilter):delete this.previousFilter}u&&t.preventDefault()},_activate:function(e){this.active.is(".ui-state-disabled")||(this.active.children("a[aria-haspopup='true']").length?this.expand(e):this.select(e))
},refresh:function(){var t,n=this.options.icons.submenu,r=this.element.find(this.options.menus);r.filter(":not(.ui-menu)").addClass("ui-menu ui-widget ui-widget-content ui-corner-all").hide().attr({role:this.options.role,"aria-hidden":"true","aria-expanded":"false"}).each(function(){var t=e(this),r=t.prev("a"),i=e("<span>").addClass("ui-menu-icon ui-icon "+n).data("ui-menu-submenu-carat",!0);
r.attr("aria-haspopup","true").prepend(i),t.attr("aria-labelledby",r.attr("id"))}),t=r.add(this.element),t.children(":not(.ui-menu-item):has(a)").addClass("ui-menu-item").attr("role","presentation").children("a").uniqueId().addClass("ui-corner-all").attr({tabIndex:-1,role:this._itemRole()}),t.children(":not(.ui-menu-item)").each(function(){var t=e(this);
/[^\-ââ\s]/.test(t.text())||t.addClass("ui-widget-content ui-menu-divider")}),t.children(".ui-state-disabled").attr("aria-disabled","true"),this.active&&!e.contains(this.element[0],this.active[0])&&this.blur()
},_itemRole:function(){return{menu:"menuitem",listbox:"option"}[this.options.role]},focus:function(e,t){var n,r;
this.blur(e,e&&e.type==="focus"),this._scrollIntoView(t),this.active=t.first(),r=this.active.children("a").addClass("ui-state-focus"),this.options.role&&this.element.attr("aria-activedescendant",r.attr("id")),this.active.parent().closest(".ui-menu-item").children("a:first").addClass("ui-state-active"),e&&e.type==="keydown"?this._close():this.timer=this._delay(function(){this._close()
},this.delay),n=t.children(".ui-menu"),n.length&&/^mouse/.test(e.type)&&this._startOpening(n),this.activeMenu=t.parent(),this._trigger("focus",e,{item:t})
},_scrollIntoView:function(t){var n,r,i,s,o,u;this._hasScroll()&&(n=parseFloat(e.css(this.activeMenu[0],"borderTopWidth"))||0,r=parseFloat(e.css(this.activeMenu[0],"paddingTop"))||0,i=t.offset().top-this.activeMenu.offset().top-n-r,s=this.activeMenu.scrollTop(),o=this.activeMenu.height(),u=t.height(),i<0?this.activeMenu.scrollTop(s+i):i+u>o&&this.activeMenu.scrollTop(s+i-o+u))
},blur:function(e,t){t||clearTimeout(this.timer);if(!this.active){return}this.active.children("a").removeClass("ui-state-focus"),this.active=null,this._trigger("blur",e,{item:this.active})
},_startOpening:function(e){clearTimeout(this.timer);if(e.attr("aria-hidden")!=="true"){return}this.timer=this._delay(function(){this._close(),this._open(e)
},this.delay)},_open:function(t){var n=e.extend({of:this.active},this.options.position);clearTimeout(this.timer),this.element.find(".ui-menu").not(t.parents(".ui-menu")).hide().attr("aria-hidden","true"),t.show().removeAttr("aria-hidden").attr("aria-expanded","true").position(n)
},collapseAll:function(t,n){clearTimeout(this.timer),this.timer=this._delay(function(){var r=n?this.element:e(t&&t.target).closest(this.element.find(".ui-menu"));
r.length||(r=this.element),this._close(r),this.blur(t),this.activeMenu=r},this.delay)},_close:function(e){e||(e=this.active?this.active.parent():this.element),e.find(".ui-menu").hide().attr("aria-hidden","true").attr("aria-expanded","false").end().find("a.ui-state-active").removeClass("ui-state-active")
},collapse:function(e){var t=this.active&&this.active.parent().closest(".ui-menu-item",this.element);
t&&t.length&&(this._close(),this.focus(e,t))},expand:function(e){var t=this.active&&this.active.children(".ui-menu ").children(".ui-menu-item").first();
t&&t.length&&(this._open(t.parent()),this._delay(function(){this.focus(e,t)}))},next:function(e){this._move("next","first",e)
},previous:function(e){this._move("prev","last",e)},isFirstItem:function(){return this.active&&!this.active.prevAll(".ui-menu-item").length
},isLastItem:function(){return this.active&&!this.active.nextAll(".ui-menu-item").length},_move:function(e,t,n){var r;
this.active&&(e==="first"||e==="last"?r=this.active[e==="first"?"prevAll":"nextAll"](".ui-menu-item").eq(-1):r=this.active[e+"All"](".ui-menu-item").eq(0));
if(!r||!r.length||!this.active){r=this.activeMenu.children(".ui-menu-item")[t]()}this.focus(n,r)},nextPage:function(t){var n,r,i;
if(!this.active){this.next(t);return}if(this.isLastItem()){return}this._hasScroll()?(r=this.active.offset().top,i=this.element.height(),this.active.nextAll(".ui-menu-item").each(function(){return n=e(this),n.offset().top-r-i<0
}),this.focus(t,n)):this.focus(t,this.activeMenu.children(".ui-menu-item")[this.active?"last":"first"]())
},previousPage:function(t){var n,r,i;if(!this.active){this.next(t);return}if(this.isFirstItem()){return
}this._hasScroll()?(r=this.active.offset().top,i=this.element.height(),this.active.prevAll(".ui-menu-item").each(function(){return n=e(this),n.offset().top-r+i>0
}),this.focus(t,n)):this.focus(t,this.activeMenu.children(".ui-menu-item").first())},_hasScroll:function(){return this.element.outerHeight()<this.element.prop("scrollHeight")
},select:function(t){this.active=this.active||e(t.target).closest(".ui-menu-item");var n={item:this.active};
this.active.has(".ui-menu").length||this.collapseAll(t,!0),this._trigger("select",t,n)}})})(jQuery);(function(e,t){e.widget("ui.progressbar",{version:"1.9.2",options:{value:0,max:100},min:0,_create:function(){this.element.addClass("ui-progressbar ui-widget ui-widget-content ui-corner-all").attr({role:"progressbar","aria-valuemin":this.min,"aria-valuemax":this.options.max,"aria-valuenow":this._value()}),this.valueDiv=e("<div class='ui-progressbar-value ui-widget-header ui-corner-left'></div>").appendTo(this.element),this.oldValue=this._value(),this._refreshValue()
},_destroy:function(){this.element.removeClass("ui-progressbar ui-widget ui-widget-content ui-corner-all").removeAttr("role").removeAttr("aria-valuemin").removeAttr("aria-valuemax").removeAttr("aria-valuenow"),this.valueDiv.remove()
},value:function(e){return e===t?this._value():(this._setOption("value",e),this)},_setOption:function(e,t){e==="value"&&(this.options.value=t,this._refreshValue(),this._value()===this.options.max&&this._trigger("complete")),this._super(e,t)
},_value:function(){var e=this.options.value;return typeof e!="number"&&(e=0),Math.min(this.options.max,Math.max(this.min,e))
},_percentage:function(){return 100*this._value()/this.options.max},_refreshValue:function(){var e=this.value(),t=this._percentage();
this.oldValue!==e&&(this.oldValue=e,this._trigger("change")),this.valueDiv.toggle(e>this.min).toggleClass("ui-corner-right",e===this.options.max).width(t.toFixed(0)+"%"),this.element.attr("aria-valuenow",e)
}})})(jQuery);(function(e,t){var n=5;e.widget("ui.slider",e.ui.mouse,{version:"1.9.2",widgetEventPrefix:"slide",options:{animate:!1,distance:0,max:100,min:0,orientation:"horizontal",range:!1,step:1,value:0,values:null},_create:function(){var t,r,i=this.options,s=this.element.find(".ui-slider-handle").addClass("ui-state-default ui-corner-all"),o="<a class='ui-slider-handle ui-state-default ui-corner-all' href='#'></a>",u=[];
this._keySliding=!1,this._mouseSliding=!1,this._animateOff=!0,this._handleIndex=null,this._detectOrientation(),this._mouseInit(),this.element.addClass("ui-slider ui-slider-"+this.orientation+" ui-widget"+" ui-widget-content"+" ui-corner-all"+(i.disabled?" ui-slider-disabled ui-disabled":"")),this.range=e([]),i.range&&(i.range===!0&&(i.values||(i.values=[this._valueMin(),this._valueMin()]),i.values.length&&i.values.length!==2&&(i.values=[i.values[0],i.values[0]])),this.range=e("<div></div>").appendTo(this.element).addClass("ui-slider-range ui-widget-header"+(i.range==="min"||i.range==="max"?" ui-slider-range-"+i.range:""))),r=i.values&&i.values.length||1;
for(t=s.length;t<r;t++){u.push(o)}this.handles=s.add(e(u.join("")).appendTo(this.element)),this.handle=this.handles.eq(0),this.handles.add(this.range).filter("a").click(function(e){e.preventDefault()
}).mouseenter(function(){i.disabled||e(this).addClass("ui-state-hover")}).mouseleave(function(){e(this).removeClass("ui-state-hover")
}).focus(function(){i.disabled?e(this).blur():(e(".ui-slider .ui-state-focus").removeClass("ui-state-focus"),e(this).addClass("ui-state-focus"))
}).blur(function(){e(this).removeClass("ui-state-focus")}),this.handles.each(function(t){e(this).data("ui-slider-handle-index",t)
}),this._on(this.handles,{keydown:function(t){var r,i,s,o,u=e(t.target).data("ui-slider-handle-index");
switch(t.keyCode){case e.ui.keyCode.HOME:case e.ui.keyCode.END:case e.ui.keyCode.PAGE_UP:case e.ui.keyCode.PAGE_DOWN:case e.ui.keyCode.UP:case e.ui.keyCode.RIGHT:case e.ui.keyCode.DOWN:case e.ui.keyCode.LEFT:t.preventDefault();
if(!this._keySliding){this._keySliding=!0,e(t.target).addClass("ui-state-active"),r=this._start(t,u);
if(r===!1){return}}}o=this.options.step,this.options.values&&this.options.values.length?i=s=this.values(u):i=s=this.value();
switch(t.keyCode){case e.ui.keyCode.HOME:s=this._valueMin();break;case e.ui.keyCode.END:s=this._valueMax();
break;case e.ui.keyCode.PAGE_UP:s=this._trimAlignValue(i+(this._valueMax()-this._valueMin())/n);break;
case e.ui.keyCode.PAGE_DOWN:s=this._trimAlignValue(i-(this._valueMax()-this._valueMin())/n);break;case e.ui.keyCode.UP:case e.ui.keyCode.RIGHT:if(i===this._valueMax()){return
}s=this._trimAlignValue(i+o);break;case e.ui.keyCode.DOWN:case e.ui.keyCode.LEFT:if(i===this._valueMin()){return
}s=this._trimAlignValue(i-o)}this._slide(t,u,s)},keyup:function(t){var n=e(t.target).data("ui-slider-handle-index");
this._keySliding&&(this._keySliding=!1,this._stop(t,n),this._change(t,n),e(t.target).removeClass("ui-state-active"))
}}),this._refreshValue(),this._animateOff=!1},_destroy:function(){this.handles.remove(),this.range.remove(),this.element.removeClass("ui-slider ui-slider-horizontal ui-slider-vertical ui-slider-disabled ui-widget ui-widget-content ui-corner-all"),this._mouseDestroy()
},_mouseCapture:function(t){var n,r,i,s,o,u,a,f,l=this,c=this.options;return c.disabled?!1:(this.elementSize={width:this.element.outerWidth(),height:this.element.outerHeight()},this.elementOffset=this.element.offset(),n={x:t.pageX,y:t.pageY},r=this._normValueFromMouse(n),i=this._valueMax()-this._valueMin()+1,this.handles.each(function(t){var n=Math.abs(r-l.values(t));
i>n&&(i=n,s=e(this),o=t)}),c.range===!0&&this.values(1)===c.min&&(o+=1,s=e(this.handles[o])),u=this._start(t,o),u===!1?!1:(this._mouseSliding=!0,this._handleIndex=o,s.addClass("ui-state-active").focus(),a=s.offset(),f=!e(t.target).parents().andSelf().is(".ui-slider-handle"),this._clickOffset=f?{left:0,top:0}:{left:t.pageX-a.left-s.width()/2,top:t.pageY-a.top-s.height()/2-(parseInt(s.css("borderTopWidth"),10)||0)-(parseInt(s.css("borderBottomWidth"),10)||0)+(parseInt(s.css("marginTop"),10)||0)},this.handles.hasClass("ui-state-hover")||this._slide(t,o,r),this._animateOff=!0,!0))
},_mouseStart:function(){return !0},_mouseDrag:function(e){var t={x:e.pageX,y:e.pageY},n=this._normValueFromMouse(t);
return this._slide(e,this._handleIndex,n),!1},_mouseStop:function(e){return this.handles.removeClass("ui-state-active"),this._mouseSliding=!1,this._stop(e,this._handleIndex),this._change(e,this._handleIndex),this._handleIndex=null,this._clickOffset=null,this._animateOff=!1,!1
},_detectOrientation:function(){this.orientation=this.options.orientation==="vertical"?"vertical":"horizontal"
},_normValueFromMouse:function(e){var t,n,r,i,s;return this.orientation==="horizontal"?(t=this.elementSize.width,n=e.x-this.elementOffset.left-(this._clickOffset?this._clickOffset.left:0)):(t=this.elementSize.height,n=e.y-this.elementOffset.top-(this._clickOffset?this._clickOffset.top:0)),r=n/t,r>1&&(r=1),r<0&&(r=0),this.orientation==="vertical"&&(r=1-r),i=this._valueMax()-this._valueMin(),s=this._valueMin()+r*i,this._trimAlignValue(s)
},_start:function(e,t){var n={handle:this.handles[t],value:this.value()};return this.options.values&&this.options.values.length&&(n.value=this.values(t),n.values=this.values()),this._trigger("start",e,n)
},_slide:function(e,t,n){var r,i,s;this.options.values&&this.options.values.length?(r=this.values(t?0:1),this.options.values.length===2&&this.options.range===!0&&(t===0&&n>r||t===1&&n<r)&&(n=r),n!==this.values(t)&&(i=this.values(),i[t]=n,s=this._trigger("slide",e,{handle:this.handles[t],value:n,values:i}),r=this.values(t?0:1),s!==!1&&this.values(t,n,!0))):n!==this.value()&&(s=this._trigger("slide",e,{handle:this.handles[t],value:n}),s!==!1&&this.value(n))
},_stop:function(e,t){var n={handle:this.handles[t],value:this.value()};this.options.values&&this.options.values.length&&(n.value=this.values(t),n.values=this.values()),this._trigger("stop",e,n)
},_change:function(e,t){if(!this._keySliding&&!this._mouseSliding){var n={handle:this.handles[t],value:this.value()};
this.options.values&&this.options.values.length&&(n.value=this.values(t),n.values=this.values()),this._trigger("change",e,n)
}},value:function(e){if(arguments.length){this.options.value=this._trimAlignValue(e),this._refreshValue(),this._change(null,0);
return}return this._value()},values:function(t,n){var r,i,s;if(arguments.length>1){this.options.values[t]=this._trimAlignValue(n),this._refreshValue(),this._change(null,t);
return}if(!arguments.length){return this._values()}if(!e.isArray(arguments[0])){return this.options.values&&this.options.values.length?this._values(t):this.value()
}r=this.options.values,i=arguments[0];for(s=0;s<r.length;s+=1){r[s]=this._trimAlignValue(i[s]),this._change(null,s)
}this._refreshValue()},_setOption:function(t,n){var r,i=0;e.isArray(this.options.values)&&(i=this.options.values.length),e.Widget.prototype._setOption.apply(this,arguments);
switch(t){case"disabled":n?(this.handles.filter(".ui-state-focus").blur(),this.handles.removeClass("ui-state-hover"),this.handles.prop("disabled",!0),this.element.addClass("ui-disabled")):(this.handles.prop("disabled",!1),this.element.removeClass("ui-disabled"));
break;case"orientation":this._detectOrientation(),this.element.removeClass("ui-slider-horizontal ui-slider-vertical").addClass("ui-slider-"+this.orientation),this._refreshValue();
break;case"value":this._animateOff=!0,this._refreshValue(),this._change(null,0),this._animateOff=!1;break;
case"values":this._animateOff=!0,this._refreshValue();for(r=0;r<i;r+=1){this._change(null,r)}this._animateOff=!1;
break;case"min":case"max":this._animateOff=!0,this._refreshValue(),this._animateOff=!1}},_value:function(){var e=this.options.value;
return e=this._trimAlignValue(e),e},_values:function(e){var t,n,r;if(arguments.length){return t=this.options.values[e],t=this._trimAlignValue(t),t
}n=this.options.values.slice();for(r=0;r<n.length;r+=1){n[r]=this._trimAlignValue(n[r])}return n},_trimAlignValue:function(e){if(e<=this._valueMin()){return this._valueMin()
}if(e>=this._valueMax()){return this._valueMax()}var t=this.options.step>0?this.options.step:1,n=(e-this._valueMin())%t,r=e-n;
return Math.abs(n)*2>=t&&(r+=n>0?t:-t),parseFloat(r.toFixed(5))},_valueMin:function(){return this.options.min
},_valueMax:function(){return this.options.max},_refreshValue:function(){var t,n,r,i,s,o=this.options.range,u=this.options,a=this,f=this._animateOff?!1:u.animate,l={};
this.options.values&&this.options.values.length?this.handles.each(function(r){n=(a.values(r)-a._valueMin())/(a._valueMax()-a._valueMin())*100,l[a.orientation==="horizontal"?"left":"bottom"]=n+"%",e(this).stop(1,1)[f?"animate":"css"](l,u.animate),a.options.range===!0&&(a.orientation==="horizontal"?(r===0&&a.range.stop(1,1)[f?"animate":"css"]({left:n+"%"},u.animate),r===1&&a.range[f?"animate":"css"]({width:n-t+"%"},{queue:!1,duration:u.animate})):(r===0&&a.range.stop(1,1)[f?"animate":"css"]({bottom:n+"%"},u.animate),r===1&&a.range[f?"animate":"css"]({height:n-t+"%"},{queue:!1,duration:u.animate}))),t=n
}):(r=this.value(),i=this._valueMin(),s=this._valueMax(),n=s!==i?(r-i)/(s-i)*100:0,l[this.orientation==="horizontal"?"left":"bottom"]=n+"%",this.handle.stop(1,1)[f?"animate":"css"](l,u.animate),o==="min"&&this.orientation==="horizontal"&&this.range.stop(1,1)[f?"animate":"css"]({width:n+"%"},u.animate),o==="max"&&this.orientation==="horizontal"&&this.range[f?"animate":"css"]({width:100-n+"%"},{queue:!1,duration:u.animate}),o==="min"&&this.orientation==="vertical"&&this.range.stop(1,1)[f?"animate":"css"]({height:n+"%"},u.animate),o==="max"&&this.orientation==="vertical"&&this.range[f?"animate":"css"]({height:100-n+"%"},{queue:!1,duration:u.animate}))
}})})(jQuery);jQuery.effects||function(e,t){var n=e.uiBackCompat!==!1,r="ui-effects-";e.effects={effect:{}},function(t,n){function p(e,t,n){var r=a[t.type]||{};
return e==null?n||!t.def?null:t.def:(e=r.floor?~~e:parseFloat(e),isNaN(e)?t.def:r.mod?(e+r.mod)%r.mod:0>e?0:r.max<e?r.max:e)
}function d(e){var n=o(),r=n._rgba=[];return e=e.toLowerCase(),h(s,function(t,i){var s,o=i.re.exec(e),a=o&&i.parse(o),f=i.space||"rgba";
if(a){return s=n[f](a),n[u[f].cache]=s[u[f].cache],r=n._rgba=s._rgba,!1}}),r.length?(r.join()==="0,0,0,0"&&t.extend(r,c.transparent),n):c[e]
}function v(e,t,n){return n=(n+1)%1,n*6<1?e+(t-e)*n*6:n*2<1?t:n*3<2?e+(t-e)*(2/3-n)*6:e}var r="backgroundColor borderBottomColor borderLeftColor borderRightColor borderTopColor color columnRuleColor outlineColor textDecorationColor textEmphasisColor".split(" "),i=/^([\-+])=\s*(\d+\.?\d*)/,s=[{re:/rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(e){return[e[1],e[2],e[3],e[4]]
}},{re:/rgba?\(\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(e){return[e[1]*2.55,e[2]*2.55,e[3]*2.55,e[4]]
}},{re:/#([a-f0-9]{2})([a-f0-9]{2})([a-f0-9]{2})/,parse:function(e){return[parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16)]
}},{re:/#([a-f0-9])([a-f0-9])([a-f0-9])/,parse:function(e){return[parseInt(e[1]+e[1],16),parseInt(e[2]+e[2],16),parseInt(e[3]+e[3],16)]
}},{re:/hsla?\(\s*(\d+(?:\.\d+)?)\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,space:"hsla",parse:function(e){return[e[1],e[2]/100,e[3]/100,e[4]]
}}],o=t.Color=function(e,n,r,i){return new t.Color.fn.parse(e,n,r,i)},u={rgba:{props:{red:{idx:0,type:"byte"},green:{idx:1,type:"byte"},blue:{idx:2,type:"byte"}}},hsla:{props:{hue:{idx:0,type:"degrees"},saturation:{idx:1,type:"percent"},lightness:{idx:2,type:"percent"}}}},a={"byte":{floor:!0,max:255},percent:{max:1},degrees:{mod:360,floor:!0}},f=o.support={},l=t("<p>")[0],c,h=t.each;
l.style.cssText="background-color:rgba(1,1,1,.5)",f.rgba=l.style.backgroundColor.indexOf("rgba")>-1,h(u,function(e,t){t.cache="_"+e,t.props.alpha={idx:3,type:"percent",def:1}
}),o.fn=t.extend(o.prototype,{parse:function(r,i,s,a){if(r===n){return this._rgba=[null,null,null,null],this
}if(r.jquery||r.nodeType){r=t(r).css(i),i=n}var f=this,l=t.type(r),v=this._rgba=[];i!==n&&(r=[r,i,s,a],l="array");
if(l==="string"){return this.parse(d(r)||c._default)}if(l==="array"){return h(u.rgba.props,function(e,t){v[t.idx]=p(r[t.idx],t)
}),this}if(l==="object"){return r instanceof o?h(u,function(e,t){r[t.cache]&&(f[t.cache]=r[t.cache].slice())
}):h(u,function(t,n){var i=n.cache;h(n.props,function(e,t){if(!f[i]&&n.to){if(e==="alpha"||r[e]==null){return
}f[i]=n.to(f._rgba)}f[i][t.idx]=p(r[e],t,!0)}),f[i]&&e.inArray(null,f[i].slice(0,3))<0&&(f[i][3]=1,n.from&&(f._rgba=n.from(f[i])))
}),this}},is:function(e){var t=o(e),n=!0,r=this;return h(u,function(e,i){var s,o=t[i.cache];return o&&(s=r[i.cache]||i.to&&i.to(r._rgba)||[],h(i.props,function(e,t){if(o[t.idx]!=null){return n=o[t.idx]===s[t.idx],n
}})),n}),n},_space:function(){var e=[],t=this;return h(u,function(n,r){t[r.cache]&&e.push(n)}),e.pop()
},transition:function(e,t){var n=o(e),r=n._space(),i=u[r],s=this.alpha()===0?o("transparent"):this,f=s[i.cache]||i.to(s._rgba),l=f.slice();
return n=n[i.cache],h(i.props,function(e,r){var i=r.idx,s=f[i],o=n[i],u=a[r.type]||{};if(o===null){return
}s===null?l[i]=o:(u.mod&&(o-s>u.mod/2?s+=u.mod:s-o>u.mod/2&&(s-=u.mod)),l[i]=p((o-s)*t+s,r))}),this[r](l)
},blend:function(e){if(this._rgba[3]===1){return this}var n=this._rgba.slice(),r=n.pop(),i=o(e)._rgba;
return o(t.map(n,function(e,t){return(1-r)*i[t]+r*e}))},toRgbaString:function(){var e="rgba(",n=t.map(this._rgba,function(e,t){return e==null?t>2?1:0:e
});return n[3]===1&&(n.pop(),e="rgb("),e+n.join()+")"},toHslaString:function(){var e="hsla(",n=t.map(this.hsla(),function(e,t){return e==null&&(e=t>2?1:0),t&&t<3&&(e=Math.round(e*100)+"%"),e
});return n[3]===1&&(n.pop(),e="hsl("),e+n.join()+")"},toHexString:function(e){var n=this._rgba.slice(),r=n.pop();
return e&&n.push(~~(r*255)),"#"+t.map(n,function(e){return e=(e||0).toString(16),e.length===1?"0"+e:e
}).join("")},toString:function(){return this._rgba[3]===0?"transparent":this.toRgbaString()}}),o.fn.parse.prototype=o.fn,u.hsla.to=function(e){if(e[0]==null||e[1]==null||e[2]==null){return[null,null,null,e[3]]
}var t=e[0]/255,n=e[1]/255,r=e[2]/255,i=e[3],s=Math.max(t,n,r),o=Math.min(t,n,r),u=s-o,a=s+o,f=a*0.5,l,c;
return o===s?l=0:t===s?l=60*(n-r)/u+360:n===s?l=60*(r-t)/u+120:l=60*(t-n)/u+240,f===0||f===1?c=f:f<=0.5?c=u/a:c=u/(2-a),[Math.round(l)%360,c,f,i==null?1:i]
},u.hsla.from=function(e){if(e[0]==null||e[1]==null||e[2]==null){return[null,null,null,e[3]]}var t=e[0]/360,n=e[1],r=e[2],i=e[3],s=r<=0.5?r*(1+n):r+n-r*n,o=2*r-s;
return[Math.round(v(o,s,t+1/3)*255),Math.round(v(o,s,t)*255),Math.round(v(o,s,t-1/3)*255),i]},h(u,function(e,r){var s=r.props,u=r.cache,a=r.to,f=r.from;
o.fn[e]=function(e){a&&!this[u]&&(this[u]=a(this._rgba));if(e===n){return this[u].slice()}var r,i=t.type(e),l=i==="array"||i==="object"?e:arguments,c=this[u].slice();
return h(s,function(e,t){var n=l[i==="object"?e:t.idx];n==null&&(n=c[t.idx]),c[t.idx]=p(n,t)}),f?(r=o(f(c)),r[u]=c,r):o(c)
},h(s,function(n,r){if(o.fn[n]){return}o.fn[n]=function(s){var o=t.type(s),u=n==="alpha"?this._hsla?"hsla":"rgba":e,a=this[u](),f=a[r.idx],l;
return o==="undefined"?f:(o==="function"&&(s=s.call(this,f),o=t.type(s)),s==null&&r.empty?this:(o==="string"&&(l=i.exec(s),l&&(s=f+parseFloat(l[2])*(l[1]==="+"?1:-1))),a[r.idx]=s,this[u](a)))
}})}),h(r,function(e,n){t.cssHooks[n]={set:function(e,r){var i,s,u="";if(t.type(r)!=="string"||(i=d(r))){r=o(i||r);
if(!f.rgba&&r._rgba[3]!==1){s=n==="backgroundColor"?e.parentNode:e;while((u===""||u==="transparent")&&s&&s.style){try{u=t.css(s,"backgroundColor"),s=s.parentNode
}catch(a){}}r=r.blend(u&&u!=="transparent"?u:"_default")}r=r.toRgbaString()}try{e.style[n]=r}catch(l){}}},t.fx.step[n]=function(e){e.colorInit||(e.start=o(e.elem,n),e.end=o(e.end),e.colorInit=!0),t.cssHooks[n].set(e.elem,e.start.transition(e.end,e.pos))
}}),t.cssHooks.borderColor={expand:function(e){var t={};return h(["Top","Right","Bottom","Left"],function(n,r){t["border"+r+"Color"]=e
}),t}},c=t.Color.names={aqua:"#00ffff",black:"#000000",blue:"#0000ff",fuchsia:"#ff00ff",gray:"#808080",green:"#008000",lime:"#00ff00",maroon:"#800000",navy:"#000080",olive:"#808000",purple:"#800080",red:"#ff0000",silver:"#c0c0c0",teal:"#008080",white:"#ffffff",yellow:"#ffff00",transparent:[null,null,null,0],_default:"#ffffff"}
}(jQuery),function(){function i(){var t=this.ownerDocument.defaultView?this.ownerDocument.defaultView.getComputedStyle(this,null):this.currentStyle,n={},r,i;
if(t&&t.length&&t[0]&&t[t[0]]){i=t.length;while(i--){r=t[i],typeof t[r]=="string"&&(n[e.camelCase(r)]=t[r])
}}else{for(r in t){typeof t[r]=="string"&&(n[r]=t[r])}}return n}function s(t,n){var i={},s,o;for(s in n){o=n[s],t[s]!==o&&!r[s]&&(e.fx.step[s]||!isNaN(parseFloat(o)))&&(i[s]=o)
}return i}var n=["add","remove","toggle"],r={border:1,borderBottom:1,borderColor:1,borderLeft:1,borderRight:1,borderTop:1,borderWidth:1,margin:1,padding:1};
e.each(["borderLeftStyle","borderRightStyle","borderBottomStyle","borderTopStyle"],function(t,n){e.fx.step[n]=function(e){if(e.end!=="none"&&!e.setAttr||e.pos===1&&!e.setAttr){jQuery.style(e.elem,n,e.end),e.setAttr=!0
}}}),e.effects.animateClass=function(t,r,o,u){var a=e.speed(r,o,u);return this.queue(function(){var r=e(this),o=r.attr("class")||"",u,f=a.children?r.find("*").andSelf():r;
f=f.map(function(){var t=e(this);return{el:t,start:i.call(this)}}),u=function(){e.each(n,function(e,n){t[n]&&r[n+"Class"](t[n])
})},u(),f=f.map(function(){return this.end=i.call(this.el[0]),this.diff=s(this.start,this.end),this}),r.attr("class",o),f=f.map(function(){var t=this,n=e.Deferred(),r=jQuery.extend({},a,{queue:!1,complete:function(){n.resolve(t)
}});return this.el.animate(this.diff,r),n.promise()}),e.when.apply(e,f.get()).done(function(){u(),e.each(arguments,function(){var t=this.el;
e.each(this.diff,function(e){t.css(e,"")})}),a.complete.call(r[0])})})},e.fn.extend({_addClass:e.fn.addClass,addClass:function(t,n,r,i){return n?e.effects.animateClass.call(this,{add:t},n,r,i):this._addClass(t)
},_removeClass:e.fn.removeClass,removeClass:function(t,n,r,i){return n?e.effects.animateClass.call(this,{remove:t},n,r,i):this._removeClass(t)
},_toggleClass:e.fn.toggleClass,toggleClass:function(n,r,i,s,o){return typeof r=="boolean"||r===t?i?e.effects.animateClass.call(this,r?{add:n}:{remove:n},i,s,o):this._toggleClass(n,r):e.effects.animateClass.call(this,{toggle:n},r,i,s)
},switchClass:function(t,n,r,i,s){return e.effects.animateClass.call(this,{add:n,remove:t},r,i,s)}})}(),function(){function i(t,n,r,i){e.isPlainObject(t)&&(n=t,t=t.effect),t={effect:t},n==null&&(n={}),e.isFunction(n)&&(i=n,r=null,n={});
if(typeof n=="number"||e.fx.speeds[n]){i=r,r=n,n={}}return e.isFunction(r)&&(i=r,r=null),n&&e.extend(t,n),r=r||n.duration,t.duration=e.fx.off?0:typeof r=="number"?r:r in e.fx.speeds?e.fx.speeds[r]:e.fx.speeds._default,t.complete=i||n.complete,t
}function s(t){return !t||typeof t=="number"||e.fx.speeds[t]?!0:typeof t=="string"&&!e.effects.effect[t]?n&&e.effects[t]?!1:!0:!1
}e.extend(e.effects,{version:"1.9.2",save:function(e,t){for(var n=0;n<t.length;n++){t[n]!==null&&e.data(r+t[n],e[0].style[t[n]])
}},restore:function(e,n){var i,s;for(s=0;s<n.length;s++){n[s]!==null&&(i=e.data(r+n[s]),i===t&&(i=""),e.css(n[s],i))
}},setMode:function(e,t){return t==="toggle"&&(t=e.is(":hidden")?"show":"hide"),t},getBaseline:function(e,t){var n,r;
switch(e[0]){case"top":n=0;break;case"middle":n=0.5;break;case"bottom":n=1;break;default:n=e[0]/t.height
}switch(e[1]){case"left":r=0;break;case"center":r=0.5;break;case"right":r=1;break;default:r=e[1]/t.width
}return{x:r,y:n}},createWrapper:function(t){if(t.parent().is(".ui-effects-wrapper")){return t.parent()
}var n={width:t.outerWidth(!0),height:t.outerHeight(!0),"float":t.css("float")},r=e("<div></div>").addClass("ui-effects-wrapper").css({fontSize:"100%",background:"transparent",border:"none",margin:0,padding:0}),i={width:t.width(),height:t.height()},s=document.activeElement;
try{s.id}catch(o){s=document.body}return t.wrap(r),(t[0]===s||e.contains(t[0],s))&&e(s).focus(),r=t.parent(),t.css("position")==="static"?(r.css({position:"relative"}),t.css({position:"relative"})):(e.extend(n,{position:t.css("position"),zIndex:t.css("z-index")}),e.each(["top","left","bottom","right"],function(e,r){n[r]=t.css(r),isNaN(parseInt(n[r],10))&&(n[r]="auto")
}),t.css({position:"relative",top:0,left:0,right:"auto",bottom:"auto"})),t.css(i),r.css(n).show()},removeWrapper:function(t){var n=document.activeElement;
return t.parent().is(".ui-effects-wrapper")&&(t.parent().replaceWith(t),(t[0]===n||e.contains(t[0],n))&&e(n).focus()),t
},setTransition:function(t,n,r,i){return i=i||{},e.each(n,function(e,n){var s=t.cssUnit(n);s[0]>0&&(i[n]=s[0]*r+s[1])
}),i}}),e.fn.extend({effect:function(){function a(n){function u(){e.isFunction(i)&&i.call(r[0]),e.isFunction(n)&&n()
}var r=e(this),i=t.complete,s=t.mode;(r.is(":hidden")?s==="hide":s==="show")?u():o.call(r[0],t,u)}var t=i.apply(this,arguments),r=t.mode,s=t.queue,o=e.effects.effect[t.effect],u=!o&&n&&e.effects[t.effect];
return e.fx.off||!o&&!u?r?this[r](t.duration,t.complete):this.each(function(){t.complete&&t.complete.call(this)
}):o?s===!1?this.each(a):this.queue(s||"fx",a):u.call(this,{options:t,duration:t.duration,callback:t.complete,mode:t.mode})
},_show:e.fn.show,show:function(e){if(s(e)){return this._show.apply(this,arguments)}var t=i.apply(this,arguments);
return t.mode="show",this.effect.call(this,t)},_hide:e.fn.hide,hide:function(e){if(s(e)){return this._hide.apply(this,arguments)
}var t=i.apply(this,arguments);return t.mode="hide",this.effect.call(this,t)},__toggle:e.fn.toggle,toggle:function(t){if(s(t)||typeof t=="boolean"||e.isFunction(t)){return this.__toggle.apply(this,arguments)
}var n=i.apply(this,arguments);return n.mode="toggle",this.effect.call(this,n)},cssUnit:function(t){var n=this.css(t),r=[];
return e.each(["em","px","%","pt"],function(e,t){n.indexOf(t)>0&&(r=[parseFloat(n),t])}),r}})}(),function(){var t={};
e.each(["Quad","Cubic","Quart","Quint","Expo"],function(e,n){t[n]=function(t){return Math.pow(t,e+2)}
}),e.extend(t,{Sine:function(e){return 1-Math.cos(e*Math.PI/2)},Circ:function(e){return 1-Math.sqrt(1-e*e)
},Elastic:function(e){return e===0||e===1?e:-Math.pow(2,8*(e-1))*Math.sin(((e-1)*80-7.5)*Math.PI/15)},Back:function(e){return e*e*(3*e-2)
},Bounce:function(e){var t,n=4;while(e<((t=Math.pow(2,--n))-1)/11){}return 1/Math.pow(4,3-n)-7.5625*Math.pow((t*3-2)/22-e,2)
}}),e.each(t,function(t,n){e.easing["easeIn"+t]=n,e.easing["easeOut"+t]=function(e){return 1-n(1-e)},e.easing["easeInOut"+t]=function(e){return e<0.5?n(e*2)/2:1-n(e*-2+2)/2
}})}()}(jQuery);(function(e,t){e.effects.effect.bounce=function(t,n){var r=e(this),i=["position","top","bottom","left","right","height","width"],s=e.effects.setMode(r,t.mode||"effect"),o=s==="hide",u=s==="show",a=t.direction||"up",f=t.distance,l=t.times||5,c=l*2+(u||o?1:0),h=t.duration/c,p=t.easing,d=a==="up"||a==="down"?"top":"left",v=a==="up"||a==="left",m,g,y,b=r.queue(),w=b.length;
(u||o)&&i.push("opacity"),e.effects.save(r,i),r.show(),e.effects.createWrapper(r),f||(f=r[d==="top"?"outerHeight":"outerWidth"]()/3),u&&(y={opacity:1},y[d]=0,r.css("opacity",0).css(d,v?-f*2:f*2).animate(y,h,p)),o&&(f/=Math.pow(2,l-1)),y={},y[d]=0;
for(m=0;m<l;m++){g={},g[d]=(v?"-=":"+=")+f,r.animate(g,h,p).animate(y,h,p),f=o?f*2:f/2}o&&(g={opacity:0},g[d]=(v?"-=":"+=")+f,r.animate(g,h,p)),r.queue(function(){o&&r.hide(),e.effects.restore(r,i),e.effects.removeWrapper(r),n()
}),w>1&&b.splice.apply(b,[1,0].concat(b.splice(w,c+1))),r.dequeue()}})(jQuery);(function(e,t){e.effects.effect.drop=function(t,n){var r=e(this),i=["position","top","bottom","left","right","opacity","height","width"],s=e.effects.setMode(r,t.mode||"hide"),o=s==="show",u=t.direction||"left",a=u==="up"||u==="down"?"top":"left",f=u==="up"||u==="left"?"pos":"neg",l={opacity:o?1:0},c;
e.effects.save(r,i),r.show(),e.effects.createWrapper(r),c=t.distance||r[a==="top"?"outerHeight":"outerWidth"](!0)/2,o&&r.css("opacity",0).css(a,f==="pos"?-c:c),l[a]=(o?f==="pos"?"+=":"-=":f==="pos"?"-=":"+=")+c,r.animate(l,{queue:!1,duration:t.duration,easing:t.easing,complete:function(){s==="hide"&&r.hide(),e.effects.restore(r,i),e.effects.removeWrapper(r),n()
}})}})(jQuery);(function(e,t){e.effects.effect.fade=function(t,n){var r=e(this),i=e.effects.setMode(r,t.mode||"toggle");
r.animate({opacity:i},{queue:!1,duration:t.duration,easing:t.easing,complete:n})}})(jQuery);(function(e,t){e.effects.effect.pulsate=function(t,n){var r=e(this),i=e.effects.setMode(r,t.mode||"show"),s=i==="show",o=i==="hide",u=s||i==="hide",a=(t.times||5)*2+(u?1:0),f=t.duration/a,l=0,c=r.queue(),h=c.length,p;
if(s||!r.is(":visible")){r.css("opacity",0).show(),l=1}for(p=1;p<a;p++){r.animate({opacity:l},f,t.easing),l=1-l
}r.animate({opacity:l},f,t.easing),r.queue(function(){o&&r.hide(),n()}),h>1&&c.splice.apply(c,[1,0].concat(c.splice(h,a+1))),r.dequeue()
}})(jQuery);(function(e,t){e.effects.effect.shake=function(t,n){var r=e(this),i=["position","top","bottom","left","right","height","width"],s=e.effects.setMode(r,t.mode||"effect"),o=t.direction||"left",u=t.distance||20,a=t.times||3,f=a*2+1,l=Math.round(t.duration/f),c=o==="up"||o==="down"?"top":"left",h=o==="up"||o==="left",p={},d={},v={},m,g=r.queue(),y=g.length;
e.effects.save(r,i),r.show(),e.effects.createWrapper(r),p[c]=(h?"-=":"+=")+u,d[c]=(h?"+=":"-=")+u*2,v[c]=(h?"-=":"+=")+u*2,r.animate(p,l,t.easing);
for(m=1;m<a;m++){r.animate(d,l,t.easing).animate(v,l,t.easing)}r.animate(d,l,t.easing).animate(p,l/2,t.easing).queue(function(){s==="hide"&&r.hide(),e.effects.restore(r,i),e.effects.removeWrapper(r),n()
}),y>1&&g.splice.apply(g,[1,0].concat(g.splice(y,f+1))),r.dequeue()}})(jQuery);(function(e,t){e.effects.effect.slide=function(t,n){var r=e(this),i=["position","top","bottom","left","right","width","height"],s=e.effects.setMode(r,t.mode||"show"),o=s==="show",u=t.direction||"left",a=u==="up"||u==="down"?"top":"left",f=u==="up"||u==="left",l,c={};
e.effects.save(r,i),r.show(),l=t.distance||r[a==="top"?"outerHeight":"outerWidth"](!0),e.effects.createWrapper(r).css({overflow:"hidden"}),o&&r.css(a,f?isNaN(l)?"-"+l:-l:l),c[a]=(o?f?"+=":"-=":f?"-=":"+=")+l,r.animate(c,{queue:!1,duration:t.duration,easing:t.easing,complete:function(){s==="hide"&&r.hide(),e.effects.restore(r,i),e.effects.removeWrapper(r),n()
}})}})(jQuery);(function(e,t){e.effects.effect.transfer=function(t,n){var r=e(this),i=e(t.to),s=i.css("position")==="fixed",o=e("body"),u=s?o.scrollTop():0,a=s?o.scrollLeft():0,f=i.offset(),l={top:f.top-u,left:f.left-a,height:i.innerHeight(),width:i.innerWidth()},c=r.offset(),h=e('<div class="ui-effects-transfer"></div>').appendTo(document.body).addClass(t.className).css({top:c.top-u,left:c.left-a,height:r.innerHeight(),width:r.innerWidth(),position:s?"fixed":"absolute"}).animate(l,t.duration,t.easing,function(){h.remove(),n()
})}})(jQuery);(function(a){var r=a.fn.domManip,d="_tmplitem",q=/^[^<]*(<[\w\W]+>)[^>]*$|\{\{\! /,b={},f={},e,p={key:0,data:{}},h=0,c=0,l=[];
function g(e,d,g,i){var c={data:i||(d?d.data:{}),_wrap:d?d._wrap:null,tmpl:null,parent:d||null,nodes:[],calls:u,nest:w,wrap:x,html:v,update:t};
e&&a.extend(c,e,{nodes:[],parent:d});if(g){c.tmpl=g;c._ctnt=c._ctnt||c.tmpl(a,c);c.key=++h;(l.length?f:b)[h]=c
}return c}a.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(f,d){a.fn[f]=function(n){var g=[],i=a(n),k,h,m,l,j=this.length===1&&this[0].parentNode;
e=b||{};if(j&&j.nodeType===11&&j.childNodes.length===1&&i.length===1){i[d](this[0]);g=this}else{for(h=0,m=i.length;
h<m;h++){c=h;k=(h>0?this.clone(true):this).get();a.fn[d].apply(a(i[h]),k);g=g.concat(k)}c=0;g=this.pushStack(g,f,i.selector)
}l=e;e=null;a.tmpl.complete(l);return g}});a.fn.extend({tmpl:function(d,c,b){return a.tmpl(this[0],d,c,b)
},tmplItem:function(){return a.tmplItem(this[0])},template:function(b){return a.template(b,this[0])},domManip:function(d,l,j){if(d[0]&&d[0].nodeType){var f=a.makeArray(arguments),g=d.length,i=0,h;
while(i<g&&!(h=a.data(d[i++],"tmplItem"))){}if(g>1){f[0]=[a.makeArray(d)]}if(h&&c){f[2]=function(b){a.tmpl.afterManip(this,b,j)
}}r.apply(this,f)}else{r.apply(this,arguments)}c=0;!e&&a.tmpl.complete(b);return this}});a.extend({tmpl:function(d,h,e,c){var j,k=!c;
if(k){c=p;d=a.template[d]||a.template(null,d);f={}}else{if(!d){d=c.tmpl;b[c.key]=c;c.nodes=[];c.wrapped&&n(c,c.wrapped);
return a(i(c,null,c.tmpl(a,c)))}}if(!d){return[]}if(typeof h==="function"){h=h.call(c||{})}e&&e.wrapped&&n(e,e.wrapped);
j=a.isArray(h)?a.map(h,function(a){return a?g(e,c,d,a):null}):[g(e,c,d,h)];return k?a(i(c,null,j)):j},tmplItem:function(b){var c;
if(b instanceof a){b=b[0]}while(b&&b.nodeType===1&&!(c=a.data(b,"tmplItem"))&&(b=b.parentNode)){}return c||p
},template:function(c,b){if(b){if(typeof b==="string"){b=o(b)}else{if(b instanceof a){b=b[0]||{}}}if(b.nodeType){b=a.data(b,"tmpl")||a.data(b,"tmpl",o(b.innerHTML))
}return typeof c==="string"?(a.template[c]=b):b}return c?typeof c!=="string"?a.template(null,c):a.template[c]||a.template(null,q.test(c)?c:a(c)):null
},encode:function(a){return(""+a).split("<").join("&lt;").split(">").join("&gt;").split('"').join("&#34;").split("'").join("&#39;")
}});a.extend(a.tmpl,{tag:{tmpl:{_default:{$2:"null"},open:"if($notnull_1){_=_.concat($item.nest($1,$2));}"},wrap:{_default:{$2:"null"},open:"$item.calls(_,$1,$2);_=[];",close:"call=$item.calls();_=call._.concat($item.wrap(call,_));"},each:{_default:{$2:"$index, $value"},open:"if($notnull_1){$.each($1a,function($2){with(this){",close:"}});}"},"if":{open:"if(($notnull_1) && $1a){",close:"}"},"else":{_default:{$1:"true"},open:"}else if(($notnull_1) && $1a){"},html:{open:"if($notnull_1){_.push($1a);}"},"=":{_default:{$1:"$data"},open:"if($notnull_1){_.push($.encode($1a));}"},"!":{open:""}},complete:function(){b={}
},afterManip:function(f,b,d){var e=b.nodeType===11?a.makeArray(b.childNodes):b.nodeType===1?[b]:[];d.call(f,b);
m(e);c++}});function i(e,g,f){var b,c=f?a.map(f,function(a){return typeof a==="string"?e.key?a.replace(/(<\w+)(?=[\s>])(?![^>]*_tmplitem)([^>]*)/g,"$1 "+d+'="'+e.key+'" $2'):a:i(a,e,a._ctnt)
}):e;if(g){return c}c=c.join("");c.replace(/^\s*([^<\s][^<]*)?(<[\w\W]+>)([^>]*[^>\s])?\s*$/,function(f,c,e,d){b=a(e).get();
m(b);if(c){b=j(c).concat(b)}if(d){b=b.concat(j(d))}});return b?b:j(c)}function j(c){var b=document.createElement("div");
b.innerHTML=c;return a.makeArray(b.childNodes)}function o(b){return new Function("jQuery","$item","var $=jQuery,call,_=[],$data=$item.data;with($data){_.push('"+a.trim(b).replace(/([\\'])/g,"\\$1").replace(/[\r\t\n]/g," ").replace(/\$\{([^\}]*)\}/g,"{{= $1}}").replace(/\{\{(\/?)(\w+|.)(?:\(((?:[^\}]|\}(?!\}))*?)?\))?(?:\s+(.*?)?)?(\(((?:[^\}]|\}(?!\}))*?)\))?\s*\}\}/g,function(m,l,j,d,b,c,e){var i=a.tmpl.tag[j],h,f,g;
if(!i){throw"Template command not found: "+j}h=i._default||[];if(c&&!/\w$/.test(b)){b+=c;c=""}if(b){b=k(b);
e=e?","+k(e)+")":c?")":"";f=c?b.indexOf(".")>-1?b+c:"("+b+").call($item"+e:b;g=c?f:"(typeof("+b+")==='function'?("+b+").call($item):("+b+"))"
}else{g=f=h.$1||"null"}d=k(d);return"');"+i[l?"close":"open"].split("$notnull_1").join(b?"typeof("+b+")!=='undefined' && ("+b+")!=null":"true").split("$1a").join(g).split("$1").join(f).split("$2").join(d?d.replace(/\s*([^\(]+)\s*(\((.*?)\))?/g,function(d,c,b,a){a=a?","+a+")":b?")":"";
return a?"("+c+").call($item"+a:d}):h.$2||"")+"_.push('"})+"');}return _;")}function n(c,b){c._wrap=i(c,true,a.isArray(b)?b:[q.test(b)?b:a(b).html()]).join("")
}function k(a){return a?a.replace(/\\'/g,"'").replace(/\\\\/g,"\\"):null}function s(b){var a=document.createElement("div");
a.appendChild(b.cloneNode(true));return a.innerHTML}function m(o){var n="_"+c,k,j,l={},e,p,i;for(e=0,p=o.length;
e<p;e++){if((k=o[e]).nodeType!==1){continue}j=k.getElementsByTagName("*");for(i=j.length-1;i>=0;i--){m(j[i])
}m(k)}function m(j){var p,i=j,k,e,m;if(m=j.getAttribute(d)){while(i.parentNode&&(i=i.parentNode).nodeType===1&&!(p=i.getAttribute(d))){}if(p!==m){i=i.parentNode?i.nodeType===11?0:i.getAttribute(d)||0:0;
if(!(e=b[m])){e=f[m];e=g(e,b[i]||f[i],null,true);e.key=++h;b[h]=e}c&&o(m)}j.removeAttribute(d)}else{if(c&&(e=a.data(j,"tmplItem"))){o(e.key);
b[e.key]=e;i=a.data(j.parentNode,"tmplItem");i=i?i.key:0}}if(e){k=e;while(k&&k.key!=i){k.nodes.push(j);
k=k.parent}delete e._ctnt;delete e._wrap;a.data(j,"tmplItem",e)}function o(a){a=a+n;e=l[a]=l[a]||g(e,b[e.parent.key+n]||e.parent,null,true)
}}}function u(a,d,c,b){if(!a){return l.pop()}l.push({_:a,tmpl:d,item:this,data:c,options:b})}function w(d,c,b){return a.tmpl(a.template(d),c,b,this)
}function x(b,d){var c=b.options||{};c.wrapped=d;return a.tmpl(a.template(b.tmpl),b.data,c,b.item)}function v(d,c){var b=this._wrap;
return a.map(a(a.isArray(b)?b.join(""):b).filter(d||"*"),function(a){return c?a.innerText||a.textContent:a.outerHTML||s(a)
})}function t(){var b=this.nodes;a.tmpl(null,null,null,this).insertBefore(b[0]);a(b).remove()}})(jQuery);
jQuery.cookie=function(key,value,options){if(arguments.length>1&&(value===null||typeof value!=="object")){options=jQuery.extend({},options);
if(value===null){options.expires=-1}if(typeof options.expires==="number"){var days=options.expires,t=options.expires=new Date();
t.setDate(t.getDate()+days)}return(document.cookie=[encodeURIComponent(key),"=",options.raw?String(value):encodeURIComponent(String(value)),options.expires?"; expires="+options.expires.toUTCString():"",options.path?"; path="+options.path:"",options.domain?"; domain="+options.domain:"",options.secure?"; secure":""].join(""))
}options=value||{};var result,decode=options.raw?function(s){return s}:decodeURIComponent;return(result=new RegExp("(?:^|; )"+encodeURIComponent(key)+"=([^;]*)").exec(document.cookie))?decode(result[1]):null
};(function($){var locationWrapper={put:function(hash,win){(win||window).location.hash=this.encoder(hash)
},get:function(win){var hash=((win||window).location.hash).replace(/^#/,"");try{return $.browser.mozilla?hash:decodeURIComponent(hash)
}catch(error){return hash}},encoder:encodeURIComponent};var iframeWrapper={id:"__jQuery_history",init:function(){var html='<iframe id="'+this.id+'" style="display:none" src="javascript:false;" />';
$("body").prepend(html);return this},_document:function(){return $("#"+this.id)[0].contentWindow.document
},put:function(hash){var doc=this._document();doc.open();doc.close();locationWrapper.put(hash,doc)},get:function(){return locationWrapper.get(this._document())
}};function initObjects(options){options=$.extend({unescape:false},options||{});locationWrapper.encoder=encoder(options.unescape);
function encoder(unescape_){if(unescape_===true){return function(hash){return hash}}if(typeof unescape_=="string"&&(unescape_=partialDecoder(unescape_.split("")))||typeof unescape_=="function"){return function(hash){return unescape_(encodeURIComponent(hash))
}}return encodeURIComponent}function partialDecoder(chars){var re=new RegExp($.map(chars,encodeURIComponent).join("|"),"ig");
return function(enc){return enc.replace(re,decodeURIComponent)}}}var implementations={};implementations.base={callback:undefined,type:undefined,check:function(){},load:function(hash){},init:function(callback,options){initObjects(options);
self.callback=callback;self._options=options;self._init()},_init:function(){},_options:{}};implementations.timer={_appState:undefined,_init:function(){var current_hash=locationWrapper.get();
self._appState=current_hash;self.callback(current_hash);setInterval(self.check,100)},check:function(){var current_hash=locationWrapper.get();
if(current_hash!=self._appState){self._appState=current_hash;self.callback(current_hash)}},load:function(hash){if(hash!=self._appState){locationWrapper.put(hash);
self._appState=hash;self.callback(hash)}}};implementations.iframeTimer={_appState:undefined,_init:function(){var current_hash=locationWrapper.get();
self._appState=current_hash;iframeWrapper.init();window.setTimeout(function(){iframeWrapper.put(current_hash);
self.callback(current_hash);setInterval(self.check,100)},180)},check:function(){var iframe_hash=iframeWrapper.get(),location_hash=locationWrapper.get();
if(location_hash!=iframe_hash){if(location_hash==self._appState){self._appState=iframe_hash;locationWrapper.put(iframe_hash);
self.callback(iframe_hash)}else{self._appState=location_hash;iframeWrapper.put(location_hash);self.callback(location_hash)
}}},load:function(hash){if(hash!=self._appState){locationWrapper.put(hash);iframeWrapper.put(hash);self._appState=hash;
self.callback(hash)}}};implementations.hashchangeEvent={_init:function(){self.callback(locationWrapper.get());
$(window).bind("hashchange",self.check)},check:function(){self.callback(locationWrapper.get())},load:function(hash){locationWrapper.put(hash)
}};var self=$.extend({},implementations.base);if($.browser.msie&&($.browser.version<8||document.documentMode<8)){self.type="iframeTimer"
}else{if("onhashchange" in window){self.type="hashchangeEvent"}else{self.type="timer"}}$.extend(self,implementations[self.type]);
$.history=self})(jQuery);(function(a){var b=function(a,c){var d=/[^\w\-\.:]/.test(a)?new Function(b.arg+",tmpl","var _e=tmpl.encode"+b.helper+",_s='"+a.replace(b.regexp,b.func)+"';return _s;"):b.cache[a]=b.cache[a]||b(b.load(a));
return c?d(c,b):function(a){return d(a,b)}};b.cache={},b.load=function(a){return document.getElementById(a).innerHTML
},b.regexp=/([\s'\\])(?![^%]*%\})|(?:\{%(=|#)([\s\S]+?)%\})|(\{%)|(%\})/g,b.func=function(a,b,c,d,e,f){if(b){return{"\n":"\\n","\r":"\\r","\t":"\\t"," ":" "}[a]||"\\"+a
}if(c){return c==="="?"'+_e("+d+")+'":"'+("+d+"||'')+'"}if(e){return"';"}if(f){return"_s+='"}},b.encReg=/[<>&"'\x00]/g,b.encMap={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&#39;"},b.encode=function(a){return String(a||"").replace(b.encReg,function(a){return b.encMap[a]||""
})},b.arg="o",b.helper=",print=function(s,e){_s+=e&&(s||'')||_e(s);},include=function(s,d){_s+=tmpl(s,d);}",typeof define=="function"&&define.amd?define(function(){return b
}):a.tmpl=b})(this);(function($){var URI=location.href.replace(/#.*/,"");var $localScroll=$.localScroll=function(settings){$("body").localScroll(settings)
};$localScroll.defaults={duration:1000,axis:"y",event:"click",stop:true};$localScroll.hash=function(settings){settings=$.extend({},$localScroll.defaults,settings);
settings.hash=false;if(location.hash){setTimeout(function(){scroll(0,location,settings)},0)}};$.fn.localScroll=function(settings){settings=$.extend({},$localScroll.defaults,settings);
return(settings.persistent||settings.lazy)?this.bind(settings.event,function(e){var a=$([e.target,e.target.parentNode]).filter(filter)[0];
a&&scroll(e,a,settings)}):this.find("a,area").filter(filter).bind(settings.event,function(e){scroll(e,this,settings)
}).end().end();function filter(){return !!this.href&&!!this.hash&&this.href.replace(this.hash,"")==URI&&(!settings.filter||$(this).is(settings.filter))
}};function scroll(e,link,settings){var id=link.hash.slice(1),elem=document.getElementById(id)||document.getElementsByName(id)[0];
if(elem){e&&e.preventDefault();var $target=$(settings.target||$.scrollTo.window());if(settings.lock&&$target.is(":animated")||settings.onBefore&&settings.onBefore.call(link,e,elem,$target)===false){return
}if(settings.stop){$target.queue("fx",[]).stop()}$target.scrollTo(elem,settings).trigger("notify.serialScroll",[elem]);
if(settings.hash){$target.queue(function(){location=link.hash;$(this).dequeue()})}}}})(jQuery);
/*! Copyright (c) 2010 Brandon Aaron (http://brandonaaron.net)
 * Licensed under the MIT License (LICENSE.txt).
 *
 * Thanks to: http://adomas.org/javascript-mouse-wheel/ for some pointers.
 * Thanks to: Mathias Bank(http://www.mathias-bank.de) for a scope bug fix.
 * Thanks to: Seamus Leahy for adding deltaX and deltaY
 *
 * Version: 3.0.4
 * 
 * Requires: 1.2.2+
 */
(function($){var types=["DOMMouseScroll","mousewheel"];
$.event.special.mousewheel={setup:function(){if(this.addEventListener){for(var i=types.length;i;){this.addEventListener(types[--i],handler,false)
}}else{this.onmousewheel=handler}},teardown:function(){if(this.removeEventListener){for(var i=types.length;
i;){this.removeEventListener(types[--i],handler,false)}}else{this.onmousewheel=null}}};$.fn.extend({mousewheel:function(fn){return fn?this.bind("mousewheel",fn):this.trigger("mousewheel")
},unmousewheel:function(fn){return this.unbind("mousewheel",fn)}});function handler(event){var orgEvent=event||window.event,args=[].slice.call(arguments,1),delta=0,returnValue=true,deltaX=0,deltaY=0;
event=$.event.fix(orgEvent);event.type="mousewheel";if(event.wheelDelta){delta=event.wheelDelta/120}if(event.detail){delta=-event.detail/3
}deltaY=delta;if(orgEvent.axis!==undefined&&orgEvent.axis===orgEvent.HORIZONTAL_AXIS){deltaY=0;deltaX=-1*delta
}if(orgEvent.wheelDeltaY!==undefined){deltaY=orgEvent.wheelDeltaY/120}if(orgEvent.wheelDeltaX!==undefined){deltaX=-1*orgEvent.wheelDeltaX/120
}args.unshift(event,delta,deltaX,deltaY);return $.event.handle.apply(this,args)}})(jQuery);(function($){var $scrollTo=$.scrollTo=function(target,duration,settings){$scrollTo.window().scrollTo(target,duration,settings)
};$scrollTo.defaults={axis:"y",duration:1};$scrollTo.window=function(){return $($.browser.safari?"body":"html")
};$.fn.scrollTo=function(target,duration,settings){if(typeof duration=="object"){settings=duration;duration=0
}settings=$.extend({},$scrollTo.defaults,settings);duration=duration||settings.speed||settings.duration;
settings.queue=settings.queue&&settings.axis.length>1;if(settings.queue){duration/=2}settings.offset=both(settings.offset);
settings.over=both(settings.over);return this.each(function(){var elem=this,$elem=$(elem),t=target,toff,attr={},win=$elem.is("html,body");
switch(typeof t){case"number":case"string":if(/^([+-]=)?\d+(px)?$/.test(t)){t=both(t);break}t=$(t,this);
case"object":if(t.is||t.style){toff=(t=$(t)).offset()}}$.each(settings.axis.split(""),function(i,axis){var Pos=axis=="x"?"Left":"Top",pos=Pos.toLowerCase(),key="scroll"+Pos,act=elem[key],Dim=axis=="x"?"Width":"Height",dim=Dim.toLowerCase();
if(toff){attr[key]=toff[pos]+(win?0:act-$elem.offset()[pos]);if(settings.margin){attr[key]-=parseInt(t.css("margin"+Pos))||0;
attr[key]-=parseInt(t.css("border"+Pos+"Width"))||0}attr[key]+=settings.offset[pos]||0;if(settings.over[pos]){attr[key]+=t[dim]()*settings.over[pos]
}}else{attr[key]=t[pos]}if(/^\d+$/.test(attr[key])){attr[key]=attr[key]<=0?0:Math.min(attr[key],max(Dim))
}if(!i&&settings.queue){if(act!=attr[key]){animate(settings.onAfterFirst)}delete attr[key]}});animate(settings.onAfter);
function animate(callback){$elem.animate(attr,duration,settings.easing,callback&&function(){callback.call(this,target)
})}function max(Dim){var el=win?$.browser.opera?document.body:document.documentElement:elem;return el["scroll"+Dim]-el["client"+Dim]
}})};function both(val){return typeof val=="object"?val:{top:val,left:val}}})(jQuery);(function(b){var a=function(c){return parseInt(c,10)||0
};b.each(["min","max"],function(d,c){b.fn[c+"Size"]=function(g){var f,e;if(g){if(g.width!==undefined){this.css(c+"-width",g.width)
}if(g.height!==undefined){this.css(c+"-height",g.height)}return this}else{f=this.css(c+"-width");e=this.css(c+"-height");
return{width:(c==="max"&&(f===undefined||f==="none"||a(f)===-1)&&Number.MAX_VALUE)||a(f),height:(c==="max"&&(e===undefined||e==="none"||a(e)===-1)&&Number.MAX_VALUE)||a(e)}
}}});b.fn.isVisible=function(){return this.is(":visible")};b.each(["border","margin","padding"],function(d,c){b.fn[c]=function(e){if(e){if(e.top!==undefined){this.css(c+"-top"+(c==="border"?"-width":""),e.top)
}if(e.bottom!==undefined){this.css(c+"-bottom"+(c==="border"?"-width":""),e.bottom)}if(e.left!==undefined){this.css(c+"-left"+(c==="border"?"-width":""),e.left)
}if(e.right!==undefined){this.css(c+"-right"+(c==="border"?"-width":""),e.right)}return this}else{return{top:a(this.css(c+"-top"+(c==="border"?"-width":""))),bottom:a(this.css(c+"-bottom"+(c==="border"?"-width":""))),left:a(this.css(c+"-left"+(c==="border"?"-width":""))),right:a(this.css(c+"-right"+(c==="border"?"-width":"")))}
}}})})(jQuery);
/*!
 * Tiny Scrollbar 1.43
 * http://www.baijs.nl/tinyscrollbar/
 *
 * Copyright 2010, Maarten Baijs
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.opensource.org/licenses/gpl-2.0.php
 *
 * Date: 02 / 24 / 2011
 * Depends on library: jQuery
 */
if(typeof Modernizr!="undefined"&&Modernizr.ipad){(function($){$.fn.tinyscrollbar=function(options){var defaults={axis:"y",wheel:40,scroll:true,size:"auto",sizethumb:"auto"};
var options=$.extend(defaults,options);var oWrapper=$(this);if(oWrapper.is(".scroll-content")&&!oWrapper.parent().is(".scroll-viewport")){var parentWrapper=oWrapper.parent();
oWrapper.wrap('<div class="scroll-viewport" />');$('<div class="scrollbar disable"><div class="track"><div class="thumb"><div class="end"></div></div></div></div>').insertBefore(oWrapper);
parentWrapper.addClass("with-scrollbar");return parentWrapper.tinyscrollbar(options)}if(oWrapper.is(".scroll-setup")){return oWrapper
}oWrapper.addClass("scroll-setup with-scrollbar");oWrapper.on("goscrolltop",function(){oThumb.obj.css(sDirection,0);
oContent.obj.css(sDirection,0);iScroll=0;iMouse["start"]=oThumb.obj.offset()[sDirection];oWrapper.data("dp-scroll-pos",0);
oWrapper.trigger("dp_scroll")});oWrapper.on("scrollupdate",function(){});oWrapper.on("goscrollto",function(ev,scrollTo){iScroll=scrollTo;
iScroll=Math.min((oContent[options.axis]-oViewport[options.axis]),Math.max(0,iScroll));iScroll+=10;oThumb.obj.css(sDirection,iScroll/oScrollbar.ratio);
oContent.obj.css(sDirection,-iScroll);oWrapper.data("dp-scroll-pos",iScroll);oWrapper.trigger("dp_scroll")
});oWrapper.on("goscrollbottom",function(){if(oScrollbar.obj.hasClass("disable")){return}iScroll=100000;
iScroll=Math.min((oContent[options.axis]-oViewport[options.axis]),Math.max(0,iScroll));iScroll+10;oThumb.obj.css(sDirection,iScroll/oScrollbar.ratio);
oContent.obj.css(sDirection,-iScroll);oWrapper.data("dp-scroll-pos",iScroll);oWrapper.trigger("dp_scroll")
});oWrapper.on("restorescroll",function(){});var oViewport={obj:$(".scroll-viewport",oWrapper).first()};
var oContent={obj:$(".scroll-content",oWrapper).first()};var oScrollbar={obj:$(".scrollbar",oWrapper).first()};
var oTrack={obj:$(".track",oScrollbar.obj)};var oThumb={obj:$(".thumb",oScrollbar.obj)};var sAxis=options.axis=="x",sDirection=sAxis?"left":"top",sSize=sAxis?"Width":"Height";
var iScroll,iPosition={start:0,now:0},iMouse={};var wheelStopTimeout=null;var mouseoverTimeout=null;if(this.length>1){this.each(function(){$(this).tinyscrollbar(options)
});return this}this.initialize=function(){};this.tinyscrollbar_update=function(sScroll){};this.tinyscrollbar_destroy=function(){};
function setSize(){}function setEvents(){}function start(oEvent){return false}function wheel(oEvent){}function end(oEvent){}function drag(oEvent){}return this.initialize()
}})(jQuery)}else{(function($){$.fn.tinyscrollbar=function(options){var defaults={axis:"y",wheel:130,scroll:true,size:"auto",sizethumb:"auto"};
var options=$.extend(defaults,options);var oWrapper=$(this);var timeout=null;var touchEvents="ontouchstart" in document.documentElement;
var msTouchEvents=!!window.navigator.msMaxTouchPoints;var fns=[];var isTouchEvent=false;if(oWrapper.is(".scroll-content")&&!oWrapper.parent().is(".scroll-viewport")){var parentWrapper=oWrapper.parent();
oWrapper.wrap('<div class="scroll-viewport" />');$('<div class="scrollbar disable"><div class="track"><div class="thumb"><div class="end"></div></div></div></div>').insertBefore(oWrapper);
parentWrapper.addClass("with-scrollbar");return parentWrapper.tinyscrollbar(options)}if(oWrapper.is(".scroll-setup")){return oWrapper
}function goscrollto(ev,scrollTo){iScroll=scrollTo;iScroll=Math.min((oContent[options.axis]-oViewport[options.axis]),Math.max(0,iScroll));
oThumb.obj.css(sDirection,iScroll/oScrollbar.ratio);oContent.obj.css(sDirection,-iScroll);oWrapper.data("dp-scroll-pos",iScroll)
}function goscrollbottom(){if(oScrollbar.obj.hasClass("disable")){return}iScroll=oContent[options.axis]-oViewport[options.axis];
oThumb.obj.css(sDirection,iScroll/oScrollbar.ratio);oContent.obj.css(sDirection,-iScroll);oWrapper.data("dp-scroll-pos",iScroll);
oScrollbar.obj.addClass("stuck-btm")}function goscrollbottom_stick(){if(oScrollbar.obj.hasClass("disable")||!oScrollbar.obj.hasClass("stuck-btm")){return
}goscrollbottom()}function restorescroll(){iScroll=parseInt(oWrapper.data("dp-scroll-pos"));if(!iScroll){return
}oThumb.obj.css(sDirection,iScroll/oScrollbar.ratio);oContent.obj.css(sDirection,-iScroll);oWrapper.data("dp-scroll-pos",iScroll)
}function _update(){scrollbarUpdate();oWrapper.addClass("scroll-draw")}function scrollbarUpdate(sScroll){if(!sScroll){sScroll="relative"
}if(!oViewport.obj[0]){return}var newViewportS=oViewport.obj[0]["offset"+sSize];var newContentS=oContent.obj[0]["scroll"+sSize];
if(newViewportS==oViewport[options.axis]&&newContentS==oContent[options.axis]){return}oViewport[options.axis]=newViewportS;
oContent[options.axis]=newContentS;oWrapper.data("dp-scroll-height",newContentS);oWrapper.data("dp-scroll-viewport",newViewportS);
oContent.ratio=oViewport[options.axis]/oContent[options.axis];if(oContent.ratio>=1){oScrollbar.obj.addClass("disable");
oViewport.obj.addClass("scroll-disabled")}else{oScrollbar.obj.removeClass("disable");oViewport.obj.removeClass("scroll-disabled")
}oTrack[options.axis]=options.size=="auto"?oViewport[options.axis]:options.size;oThumb[options.axis]=Math.min(oTrack[options.axis],Math.max(0,(options.sizethumb=="auto"?(oTrack[options.axis]*oContent.ratio):options.sizethumb)));
if(oThumb[options.axis]<30){oThumb[options.axis]=30;options.sizethumb=30}oScrollbar.ratio=options.sizethumb=="auto"?(oContent[options.axis]/oTrack[options.axis]):(oContent[options.axis]-oViewport[options.axis])/(oTrack[options.axis]-oThumb[options.axis]);
if(sScroll=="relative"&&oContent.ratio<=1){iScroll=Math.min((oContent[options.axis]-oViewport[options.axis]),Math.max(0,iScroll))
}if(!iScroll){iScroll=0}if(oViewport[options.axis]>=oContent[options.axis]){iScroll=0}setSize();oWrapper.trigger("dp_resize")
}oWrapper.addClass("scroll-setup with-scrollbar");oWrapper.on("goscrolltop",function(){oThumb.obj.css(sDirection,0);
oContent.obj.css(sDirection,0);iScroll=0;iMouse["start"]=oThumb.obj.offset()[sDirection];oWrapper.data("dp-scroll-pos",0);
oWrapper.removeClass("stuck")});oWrapper.on("goscrollto",goscrollto);oWrapper.on("scrollupdate",scrollbarUpdate);
oWrapper.on("goscrollbottom",goscrollbottom);oWrapper.on("goscrollbottom_stick",goscrollbottom_stick);
oWrapper.on("restorescroll",restorescroll);var oViewport={obj:$(".scroll-viewport",oWrapper).first()};
var oContent={obj:$(".scroll-content",oWrapper).first()};var oScrollbar={obj:$(".scrollbar",oWrapper).first()};
var oTrack={obj:$(".track",oScrollbar.obj)};var oThumb={obj:$(".thumb",oScrollbar.obj)};var sAxis=options.axis=="x",sDirection=sAxis?"left":"top",sSize=sAxis?"Width":"Height";
var iScroll,iPosition={start:0,now:0},iMouse={};var wheelStopTimeout=null;var mouseoverTimeout=null;oViewport.obj.on("scroll",function(ev){oViewport.obj.scrollTop(0)
});if(this.length>1){this.each(function(){$(this).tinyscrollbar(options)});return this}this.initialize=function(){setEvents();
timeout=window.setTimeout(_update,250)};this.tinyscrollbar_destroy=function(){if(timeout){window.clearTimeout(timeout);
timeout=null}};this.tinyscrollbar_update=function(sScroll){scrollbarUpdate(sScroll)};function setSize(){oThumb.obj.css(sDirection,iScroll/oScrollbar.ratio);
oContent.obj.css(sDirection,-iScroll);iMouse["start"]=oThumb.obj.offset()[sDirection];var sCssSize=sSize.toLowerCase();
oScrollbar.obj.css(sCssSize,oTrack[options.axis]);oTrack.obj.css(sCssSize,oTrack[options.axis]);oThumb.obj.css(sCssSize,oThumb[options.axis])
}function setEvents(){if(touchEvents){oViewport.obj[0].ontouchstart=function(event){if(1===event.touches.length){start(event.touches[0]);
event.stopPropagation()}}}else{if(msTouchEvents){var fn=function(event){isTouchEvent=true;start(event);
event.stopPropagation()};fns.push(fn);oViewport.obj[0].addEventListener("MSPointerDown",fn,false);oThumb.obj.bind("mousedown",start);
oTrack.obj.bind("mouseup",drag)}else{oThumb.obj.bind("mousedown",start);oTrack.obj.bind("mouseup",drag)
}}if(options.scroll&&this.addEventListener){oWrapper[0].addEventListener("DOMMouseScroll",wheel,false);
oWrapper[0].addEventListener("mousewheel",wheel,false)}else{if(options.scroll){oWrapper[0].onmousewheel=wheel
}}}function start(oEvent){iMouse.start=sAxis?oEvent.pageX:oEvent.pageY;var oThumbDir=parseInt(oThumb.obj.css(sDirection));
iPosition.start=oThumbDir=="auto"?0:oThumbDir;if(touchEvents){document.ontouchmove=function(event){event.preventDefault();
drag(event.touches[0])};document.ontouchend=end}else{if(msTouchEvents&&oEvent.pointerType&&oEvent.pointerType==oEvent.MSPOINTER_TYPE_TOUCH){var fn=function(event){isTouchEvent=true;
event.preventDefault();drag(event)};fns.push(fn);document.addEventListener("MSPointerMove",fn,false);
document.addEventListener("MSPointerUp",end,false)}else{$(document).bind("mousemove",drag);$(document).bind("mouseup",end);
oThumb.obj.bind("mouseup",end);oTrack.obj.addClass("dragging")}}return false}function wheel(oEvent){oWrapper.removeClass("stuck");
var redactor=null;if(oEvent&&oEvent.explicitOriginalTarget){redactor=$(oEvent.explicitOriginalTarget).closest(".redactor_editor");
if(redactor[0]){var maxH=parseInt(redactor.css("max-height"));var h=parseInt(redactor.height());if(h>=maxH){return
}}}if(!(oContent.ratio>=1)){var oEvent=oEvent||window.event;var iDelta=oEvent.wheelDelta?oEvent.wheelDelta/120:-oEvent.detail/3;
iScroll-=iDelta*options.wheel;iScroll=Math.min((oContent[options.axis]-oViewport[options.axis]),Math.max(0,iScroll));
oThumb.obj.css(sDirection,iScroll/oScrollbar.ratio);oContent.obj.css(sDirection,-iScroll);oWrapper.data("dp-scroll-pos",iScroll);
if(iScroll==oContent[options.axis]-oViewport[options.axis]){oScrollbar.obj.addClass("stuck-btm")}else{oScrollbar.obj.removeClass("stuck-btm")
}oEvent=$.event.fix(oEvent);oEvent.preventDefault();if(!oScrollbar.obj.is(".disable")){oEvent.stopPropagation()
}oWrapper.trigger("dp_scroll")}}function end(oEvent){oWrapper.removeClass("stuck");$(document).unbind("mousemove",drag);
$(document).unbind("mouseup",end);oThumb.obj.unbind("mouseup",end);oTrack.obj.removeClass("dragging");
if(iScroll==oContent[options.axis]-oViewport[options.axis]){oScrollbar.obj.addClass("stuck-btm")}else{oScrollbar.obj.removeClass("stuck-btm")
}if(fns&&fns.length){for(var i=0;i<fns.length;i++){document.removeEventListener("MSPointerMove",fns[i]);
document.removeEventListener("MSPointerUp",fns[i])}fns=[]}isTouchEvent=false;return false}function drag(oEvent){oWrapper.removeClass("stuck");
if(!(oContent.ratio>=1)){if(isTouchEvent){iPosition.now=Math.min((oTrack[options.axis]-oThumb[options.axis]),Math.max(0,(iPosition.start-((sAxis?oEvent.pageX:oEvent.pageY)-iMouse.start))))
}else{iPosition.now=Math.min((oTrack[options.axis]-oThumb[options.axis]),Math.max(0,(iPosition.start+((sAxis?oEvent.pageX:oEvent.pageY)-iMouse.start))))
}iScroll=iPosition.now*oScrollbar.ratio;oContent.obj.css(sDirection,-iScroll);oThumb.obj.css(sDirection,iPosition.now);
oWrapper.data("dp-scroll-pos",iScroll);if(iScroll>=oContent[options.axis]-oViewport[options.axis]){oScrollbar.obj.addClass("stuck-btm")
}else{oScrollbar.obj.removeClass("stuck-btm")}oWrapper.trigger("dp_scroll")}return false}return this.initialize()
}})(jQuery)}(function(jQuery){jQuery.hotkeys={version:"0.8",specialKeys:{8:"backspace",9:"tab",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",191:"/",224:"meta"},shiftNums:{"`":"~","1":"!","2":"@","3":"#","4":"$","5":"%","6":"^","7":"&","8":"*","9":"(","0":")","-":"_","=":"+",";":": ","'":'"',",":"<",".":">","/":"?","\\":"|"}};
function keyHandler(handleObj){if(typeof handleObj.data!=="string"){return}var origHandler=handleObj.handler,keys=handleObj.data.toLowerCase().split(" ");
handleObj.handler=function(event){if(this!==event.target&&(/textarea|select/i.test(event.target.nodeName)||event.target.type==="text")||event.target.type==="password"){return
}var special=event.type!=="keypress"&&jQuery.hotkeys.specialKeys[event.which],character=String.fromCharCode(event.which).toLowerCase(),key,modif="",possible={};
if(event.altKey&&special!=="alt"){modif+="alt+"}if(event.ctrlKey&&special!=="ctrl"){modif+="ctrl+"}if(event.metaKey&&!event.ctrlKey&&special!=="meta"){modif+="meta+"
}if(event.shiftKey&&special!=="shift"){modif+="shift+"}if(special){possible[modif+special]=true}else{possible[modif+character]=true;
possible[modif+jQuery.hotkeys.shiftNums[character]]=true;if(modif==="shift+"){possible[jQuery.hotkeys.shiftNums[character]]=true
}}for(var i=0,l=keys.length;i<l;i++){if(possible[keys[i]]){return origHandler.apply(this,arguments)}}}
}jQuery.each(["keydown","keyup","keypress"],function(){jQuery.event.special[this]={add:keyHandler}})})(jQuery);
(function($){$.fn.TextAreaExpander=function(settings){var config={classmodifier:"tae"};if(settings){$.extend(config,settings)
}function update(element){var $elem=$(element);var offset=($elem.css("box-sizing")=="border-box"||$elem.css("-moz-box-sizing")=="border-box")?$elem.outerHeight()-$elem.height():0;
var height=$elem.height(),current=height;var max=$elem.data("expander-max-height")||1000;var min=$elem.data("expander-min-height")||50;
while(element.clientHeight<element.scrollHeight||element.clientHeight+offset<min){height+=5;$elem.height(height);
if(height+offset>max){break}}var last=height;while(element.clientHeight>=element.scrollHeight){last=height;
height-=5;$elem.height(height+offset);if(height+offset<min){break}}$elem.height(last+offset);if(height+offset>max&&current+offset<max){$elem.css("overflow","auto")
}else{if(height+offset<max&&current+offset>max){$elem.css("overflow","hidden")}}}return this.each(function(){$(this).addClass(config.classmodifier).css({overflow:"hidden"});
if(!$(this).data("expander-min-height")){$(this).data("expander-min-height",$(this).height())}$(this).bind("textareaexpander_fire",function(){update(this);
$(this).trigger("textareaexpander_expanded")});$(this).bind("keyup",function(){update(this);$(this).trigger("textareaexpander_expanded")
})})}})(jQuery);(function(){var $,BorderDropHint,DragAndDropHandler,DragElement,FolderElement,GhostDropHint,JqTreeWidget,KeyHandler,MouseWidget,Node,NodeElement,Position,SaveStateHandler,ScrollHandler,SelectNodeHandler,SimpleWidget,html_escape,indexOf,json_escapable,json_meta,json_quote,json_str,_indexOf,_ref,_ref1,_ref2,__slice=[].slice,__hasProp={}.hasOwnProperty,__extends=function(child,parent){for(var key in parent){if(__hasProp.call(parent,key)){child[key]=parent[key]
}}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;
return child};$=this.jQuery;SimpleWidget=(function(){SimpleWidget.prototype.defaults={};function SimpleWidget(el,options){this.$el=$(el);
this.options=$.extend({},this.defaults,options)}SimpleWidget.prototype.destroy=function(){return this._deinit()
};SimpleWidget.prototype._init=function(){return null};SimpleWidget.prototype._deinit=function(){return null
};SimpleWidget.register=function(widget_class,widget_name){var callFunction,createWidget,destroyWidget,getDataKey;
getDataKey=function(){return"simple_widget_"+widget_name};createWidget=function($el,options){var data_key,el,widget,_i,_len;
data_key=getDataKey();for(_i=0,_len=$el.length;_i<_len;_i++){el=$el[_i];widget=new widget_class(el,options);
if(!$.data(el,data_key)){$.data(el,data_key,widget)}widget._init()}return $el};destroyWidget=function($el){var data_key,el,widget,_i,_len,_results;
data_key=getDataKey();_results=[];for(_i=0,_len=$el.length;_i<_len;_i++){el=$el[_i];widget=$.data(el,data_key);
if(widget&&(widget instanceof SimpleWidget)){widget.destroy()}_results.push($.removeData(el,data_key))
}return _results};callFunction=function($el,function_name,args){var el,result,widget,widget_function,_i,_len;
result=null;for(_i=0,_len=$el.length;_i<_len;_i++){el=$el[_i];widget=$.data(el,getDataKey());if(widget&&(widget instanceof SimpleWidget)){widget_function=widget[function_name];
if(widget_function&&(typeof widget_function==="function")){result=widget_function.apply(widget,args)}}}return result
};return $.fn[widget_name]=function(){var $el,args,argument1,function_name,options;argument1=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[];
$el=this;if(argument1===void 0||typeof argument1==="object"){options=argument1;return createWidget($el,options)
}else{if(typeof argument1==="string"&&argument1[0]!=="_"){function_name=argument1;if(function_name==="destroy"){return destroyWidget($el)
}else{return callFunction($el,function_name,args)}}}}};return SimpleWidget})();this.SimpleWidget=SimpleWidget;
MouseWidget=(function(_super){__extends(MouseWidget,_super);function MouseWidget(){_ref=MouseWidget.__super__.constructor.apply(this,arguments);
return _ref}MouseWidget.is_mouse_handled=false;MouseWidget.prototype._init=function(){this.$el.bind("mousedown.mousewidget",$.proxy(this._mouseDown,this));
this.$el.bind("touchstart.mousewidget",$.proxy(this._touchStart,this));this.is_mouse_started=false;this.mouse_delay=0;
this._mouse_delay_timer=null;this._is_mouse_delay_met=true;return this.mouse_down_info=null};MouseWidget.prototype._deinit=function(){var $document;
this.$el.unbind("mousedown.mousewidget");this.$el.unbind("touchstart.mousewidget");$document=$(document);
$document.unbind("mousemove.mousewidget");return $document.unbind("mouseup.mousewidget")};MouseWidget.prototype._mouseDown=function(e){var result;
if(e.which!==1){return}result=this._handleMouseDown(e,this._getPositionInfo(e));if(result){e.preventDefault()
}return result};MouseWidget.prototype._handleMouseDown=function(e,position_info){if(MouseWidget.is_mouse_handled){return
}if(this.is_mouse_started){this._handleMouseUp(position_info)}this.mouse_down_info=position_info;if(!this._mouseCapture(position_info)){return
}this._handleStartMouse();this.is_mouse_handled=true;return true};MouseWidget.prototype._handleStartMouse=function(){var $document;
$document=$(document);$document.bind("mousemove.mousewidget",$.proxy(this._mouseMove,this));$document.bind("touchmove.mousewidget",$.proxy(this._touchMove,this));
$document.bind("mouseup.mousewidget",$.proxy(this._mouseUp,this));$document.bind("touchend.mousewidget",$.proxy(this._touchEnd,this));
if(this.mouse_delay){return this._startMouseDelayTimer()}};MouseWidget.prototype._startMouseDelayTimer=function(){var _this=this;
if(this._mouse_delay_timer){clearTimeout(this._mouse_delay_timer)}this._mouse_delay_timer=setTimeout(function(){return _this._is_mouse_delay_met=true
},this.mouse_delay);return this._is_mouse_delay_met=false};MouseWidget.prototype._mouseMove=function(e){return this._handleMouseMove(e,this._getPositionInfo(e))
};MouseWidget.prototype._handleMouseMove=function(e,position_info){if(this.is_mouse_started){this._mouseDrag(position_info);
return e.preventDefault()}if(this.mouse_delay&&!this._is_mouse_delay_met){return true}this.is_mouse_started=this._mouseStart(this.mouse_down_info)!==false;
if(this.is_mouse_started){this._mouseDrag(position_info)}else{this._handleMouseUp(position_info)}return !this.is_mouse_started
};MouseWidget.prototype._getPositionInfo=function(e){return{page_x:e.pageX,page_y:e.pageY,target:e.target,original_event:e}
};MouseWidget.prototype._mouseUp=function(e){return this._handleMouseUp(this._getPositionInfo(e))};MouseWidget.prototype._handleMouseUp=function(position_info){var $document;
$document=$(document);$document.unbind("mousemove.mousewidget");$document.unbind("touchmove.mousewidget");
$document.unbind("mouseup.mousewidget");$document.unbind("touchend.mousewidget");if(this.is_mouse_started){this.is_mouse_started=false;
this._mouseStop(position_info)}};MouseWidget.prototype._mouseCapture=function(position_info){return true
};MouseWidget.prototype._mouseStart=function(position_info){return null};MouseWidget.prototype._mouseDrag=function(position_info){return null
};MouseWidget.prototype._mouseStop=function(position_info){return null};MouseWidget.prototype.setMouseDelay=function(mouse_delay){return this.mouse_delay=mouse_delay
};MouseWidget.prototype._touchStart=function(e){var touch;if(e.originalEvent.touches.length>1){return
}touch=e.originalEvent.changedTouches[0];return this._handleMouseDown(e,this._getPositionInfo(touch))
};MouseWidget.prototype._touchMove=function(e){var touch;if(e.originalEvent.touches.length>1){return}touch=e.originalEvent.changedTouches[0];
return this._handleMouseMove(e,this._getPositionInfo(touch))};MouseWidget.prototype._touchEnd=function(e){var touch;
if(e.originalEvent.touches.length>1){return}touch=e.originalEvent.changedTouches[0];return this._handleMouseUp(this._getPositionInfo(touch))
};return MouseWidget})(SimpleWidget);this.Tree={};$=this.jQuery;Position={getName:function(position){return Position.strings[position-1]
},nameToIndex:function(name){var i,_i,_ref1;for(i=_i=1,_ref1=Position.strings.length;1<=_ref1?_i<=_ref1:_i>=_ref1;
i=1<=_ref1?++_i:--_i){if(Position.strings[i-1]===name){return i}}return 0}};Position.BEFORE=1;Position.AFTER=2;
Position.INSIDE=3;Position.NONE=4;Position.strings=["before","after","inside","none"];this.Tree.Position=Position;
Node=(function(){function Node(o,is_root,node_class){if(is_root==null){is_root=false}if(node_class==null){node_class=Node
}this.setData(o);this.children=[];this.parent=null;if(is_root){this.id_mapping={};this.tree=this;this.node_class=node_class
}}Node.prototype.setData=function(o){var key,value,_results;if(typeof o!=="object"){return this.name=o
}else{_results=[];for(key in o){value=o[key];if(key==="label"){_results.push(this.name=value)}else{_results.push(this[key]=value)
}}return _results}};Node.prototype.initFromData=function(data){var addChildren,addNode,_this=this;addNode=function(node_data){_this.setData(node_data);
if(node_data.children){return addChildren(node_data.children)}};addChildren=function(children_data){var child,node,_i,_len;
for(_i=0,_len=children_data.length;_i<_len;_i++){child=children_data[_i];node=new _this.tree.node_class("");
node.initFromData(child);_this.addChild(node)}return null};addNode(data);return null};Node.prototype.loadFromData=function(data){var node,o,_i,_len;
this.removeChildren();for(_i=0,_len=data.length;_i<_len;_i++){o=data[_i];node=new this.tree.node_class(o);
this.addChild(node);if(typeof o==="object"&&o.children){node.loadFromData(o.children)}}return null};Node.prototype.addChild=function(node){this.children.push(node);
return node._setParent(this)};Node.prototype.addChildAtPosition=function(node,index){this.children.splice(index,0,node);
return node._setParent(this)};Node.prototype._setParent=function(parent){this.parent=parent;this.tree=parent.tree;
return this.tree.addNodeToIndex(this)};Node.prototype.removeChild=function(node){node.removeChildren();
return this._removeChild(node)};Node.prototype._removeChild=function(node){this.children.splice(this.getChildIndex(node),1);
return this.tree.removeNodeFromIndex(node)};Node.prototype.getChildIndex=function(node){return $.inArray(node,this.children)
};Node.prototype.hasChildren=function(){return this.children.length!==0};Node.prototype.isFolder=function(){return this.hasChildren()||this.load_on_demand
};Node.prototype.iterate=function(callback){var _iterate,_this=this;_iterate=function(node,level){var child,result,_i,_len,_ref1;
if(node.children){_ref1=node.children;for(_i=0,_len=_ref1.length;_i<_len;_i++){child=_ref1[_i];result=callback(child,level);
if(_this.hasChildren()&&result){_iterate(child,level+1)}}return null}};_iterate(this,0);return null};
Node.prototype.moveNode=function(moved_node,target_node,position){if(moved_node.isParentOf(target_node)){return
}moved_node.parent._removeChild(moved_node);if(position===Position.AFTER){return target_node.parent.addChildAtPosition(moved_node,target_node.parent.getChildIndex(target_node)+1)
}else{if(position===Position.BEFORE){return target_node.parent.addChildAtPosition(moved_node,target_node.parent.getChildIndex(target_node))
}else{if(position===Position.INSIDE){return target_node.addChildAtPosition(moved_node,0)}}}};Node.prototype.getData=function(){var getDataFromNodes,_this=this;
getDataFromNodes=function(nodes){var data,k,node,tmp_node,v,_i,_len;data=[];for(_i=0,_len=nodes.length;
_i<_len;_i++){node=nodes[_i];tmp_node={};for(k in node){v=node[k];if((k!=="parent"&&k!=="children"&&k!=="element"&&k!=="tree")&&Object.prototype.hasOwnProperty.call(node,k)){tmp_node[k]=v
}}if(node.hasChildren()){tmp_node.children=getDataFromNodes(node.children)}data.push(tmp_node)}return data
};return getDataFromNodes(this.children)};Node.prototype.getNodeByName=function(name){var result;result=null;
this.iterate(function(node){if(node.name===name){result=node;return false}else{return true}});return result
};Node.prototype.addAfter=function(node_info){var child_index,node;if(!this.parent){return null}else{node=new this.tree.node_class(node_info);
child_index=this.parent.getChildIndex(this);this.parent.addChildAtPosition(node,child_index+1);return node
}};Node.prototype.addBefore=function(node_info){var child_index,node;if(!this.parent){return null}else{node=new this.tree.node_class(node_info);
child_index=this.parent.getChildIndex(this);this.parent.addChildAtPosition(node,child_index);return node
}};Node.prototype.addParent=function(node_info){var child,new_parent,original_parent,_i,_len,_ref1;if(!this.parent){return null
}else{new_parent=new this.tree.node_class(node_info);new_parent._setParent(this.tree);original_parent=this.parent;
_ref1=original_parent.children;for(_i=0,_len=_ref1.length;_i<_len;_i++){child=_ref1[_i];new_parent.addChild(child)
}original_parent.children=[];original_parent.addChild(new_parent);return new_parent}};Node.prototype.remove=function(){if(this.parent){this.parent.removeChild(this);
return this.parent=null}};Node.prototype.append=function(node_info){var node;node=new this.tree.node_class(node_info);
this.addChild(node);return node};Node.prototype.prepend=function(node_info){var node;node=new this.tree.node_class(node_info);
this.addChildAtPosition(node,0);return node};Node.prototype.isParentOf=function(node){var parent;parent=node.parent;
while(parent){if(parent===this){return true}parent=parent.parent}return false};Node.prototype.getLevel=function(){var level,node;
level=0;node=this;while(node.parent){level+=1;node=node.parent}return level};Node.prototype.getNodeById=function(node_id){return this.id_mapping[node_id]
};Node.prototype.addNodeToIndex=function(node){if(node.id){return this.id_mapping[node.id]=node}};Node.prototype.removeNodeFromIndex=function(node){if(node.id){return delete this.id_mapping[node.id]
}};Node.prototype.removeChildren=function(){var _this=this;this.iterate(function(child){_this.tree.removeNodeFromIndex(child);
return true});return this.children=[]};Node.prototype.getPreviousSibling=function(){var previous_index;
if(!this.parent){return null}else{previous_index=this.parent.getChildIndex(this)-1;if(previous_index>=0){return this.parent.children[previous_index]
}else{return null}}};Node.prototype.getNextSibling=function(){var next_index;if(!this.parent){return null
}else{next_index=this.parent.getChildIndex(this)+1;if(next_index<this.parent.children.length){return this.parent.children[next_index]
}else{return null}}};return Node})();this.Tree.Node=Node;JqTreeWidget=(function(_super){__extends(JqTreeWidget,_super);
function JqTreeWidget(){_ref1=JqTreeWidget.__super__.constructor.apply(this,arguments);return _ref1}JqTreeWidget.prototype.defaults={autoOpen:false,saveState:false,dragAndDrop:false,selectable:true,useContextMenu:true,onCanSelectNode:null,onSetStateFromStorage:null,onGetStateFromStorage:null,onCreateLi:null,onIsMoveHandle:null,onCanMove:null,onCanMoveTo:null,onLoadFailed:null,autoEscape:true,dataUrl:null,closedIcon:"&#x25ba;",openedIcon:"&#x25bc;",slide:true,nodeClass:Node};
JqTreeWidget.prototype.toggle=function(node,slide){if(slide==null){slide=true}if(node.is_open){return this.closeNode(node,slide)
}else{return this.openNode(node,slide)}};JqTreeWidget.prototype.getTree=function(){return this.tree};
JqTreeWidget.prototype.selectNode=function(node){return this._selectNode(node,true)};JqTreeWidget.prototype._selectNode=function(node,must_toggle){var canSelect,openParents,saveState,_this=this;
if(must_toggle==null){must_toggle=false}if(!this.select_node_handler){return}canSelect=function(){if(_this.options.onCanSelectNode){return _this.options.selectable&&_this.options.onCanSelectNode(node)
}else{return _this.options.selectable}};openParents=function(){var parent;parent=node.parent;if(parent&&parent.parent&&!parent.is_open){return _this.openNode(parent,false)
}};saveState=function(){if(_this.options.saveState){return _this.save_state_handler.saveState()}};if(!node){this._deselectCurrentNode();
saveState();return}if(!canSelect()){return}if(this.select_node_handler.isNodeSelected(node)){if(must_toggle){this._deselectCurrentNode();
this._triggerEvent("tree.select",{node:null,previous_node:node})}}else{this._deselectCurrentNode();this.addToSelection(node);
this._triggerEvent("tree.select",{node:node});openParents()}return saveState()};JqTreeWidget.prototype.getSelectedNode=function(){return this.select_node_handler.getSelectedNode()
};JqTreeWidget.prototype.toJson=function(){return JSON.stringify(this.tree.getData())};JqTreeWidget.prototype.loadData=function(data,parent_node){return this._loadData(data,parent_node)
};JqTreeWidget.prototype.loadDataFromUrl=function(url,parent_node,on_finished){if($.type(url)!=="string"){on_finished=parent_node;
parent_node=url;url=null}return this._loadDataFromUrl(url,parent_node,on_finished)};JqTreeWidget.prototype._loadDataFromUrl=function(url_info,parent_node,on_finished){var $el,addLoadingClass,parseUrlInfo,removeLoadingClass,_this=this;
$el=null;addLoadingClass=function(){var folder_element;if(!parent_node){$el=_this.element}else{folder_element=new FolderElement(parent_node,_this);
$el=folder_element.getLi()}return $el.addClass("jqtree-loading")};removeLoadingClass=function(){if($el){return $el.removeClass("jqtree-loading")
}};parseUrlInfo=function(){if($.type(url_info)==="string"){url_info={url:url_info}}if(!url_info.method){return url_info.method="get"
}};addLoadingClass();if(!url_info){url_info=this._getDataUrlInfo(parent_node)}parseUrlInfo();return $.ajax({url:url_info.url,data:url_info.data,type:url_info.method.toUpperCase(),cache:false,dataType:"json",success:function(response){var data;
if($.isArray(response)||typeof response==="object"){data=response}else{data=$.parseJSON(response)}removeLoadingClass();
_this._loadData(data,parent_node);if(on_finished&&$.isFunction(on_finished)){return on_finished()}},error:function(response){removeLoadingClass();
if(_this.options.onLoadFailed){return _this.options.onLoadFailed(response)}}})};JqTreeWidget.prototype._loadData=function(data,parent_node){var n,selected_nodes_under_parent,_i,_len;
this._triggerEvent("tree.load_data",{tree_data:data});if(!parent_node){this._initTree(data)}else{selected_nodes_under_parent=this.select_node_handler.getSelectedNodes(parent_node);
for(_i=0,_len=selected_nodes_under_parent.length;_i<_len;_i++){n=selected_nodes_under_parent[_i];this.select_node_handler.removeFromSelection(n)
}parent_node.loadFromData(data);parent_node.load_on_demand=false;this._refreshElements(parent_node.parent)
}if(this.is_dragging){return this.dnd_handler.refreshHitAreas()}};JqTreeWidget.prototype.getNodeById=function(node_id){return this.tree.getNodeById(node_id)
};JqTreeWidget.prototype.getNodeByName=function(name){return this.tree.getNodeByName(name)};JqTreeWidget.prototype.openNode=function(node,slide){if(slide==null){slide=true
}return this._openNode(node,slide)};JqTreeWidget.prototype._openNode=function(node,slide,on_finished){var doOpenNode,parent,_this=this;
if(slide==null){slide=true}doOpenNode=function(_node,_slide,_on_finished){var folder_element;folder_element=new FolderElement(_node,_this);
return folder_element.open(_on_finished,_slide)};if(node.isFolder()){if(node.load_on_demand){return this._loadFolderOnDemand(node,slide,on_finished)
}else{parent=node.parent;while(parent&&!parent.is_open){if(parent.parent){doOpenNode(parent,false,null)
}parent=parent.parent}doOpenNode(node,slide,on_finished);return this._saveState()}}};JqTreeWidget.prototype._loadFolderOnDemand=function(node,slide,on_finished){var _this=this;
if(slide==null){slide=true}return this._loadDataFromUrl(null,node,function(){return _this._openNode(node,slide,on_finished)
})};JqTreeWidget.prototype.closeNode=function(node,slide){if(slide==null){slide=true}if(node.isFolder()){new FolderElement(node,this).close(slide);
return this._saveState()}};JqTreeWidget.prototype.isDragging=function(){return this.is_dragging};JqTreeWidget.prototype.refreshHitAreas=function(){return this.dnd_handler.refreshHitAreas()
};JqTreeWidget.prototype.addNodeAfter=function(new_node_info,existing_node){var new_node;new_node=existing_node.addAfter(new_node_info);
this._refreshElements(existing_node.parent);return new_node};JqTreeWidget.prototype.addNodeBefore=function(new_node_info,existing_node){var new_node;
new_node=existing_node.addBefore(new_node_info);this._refreshElements(existing_node.parent);return new_node
};JqTreeWidget.prototype.addParentNode=function(new_node_info,existing_node){var new_node;new_node=existing_node.addParent(new_node_info);
this._refreshElements(new_node.parent);return new_node};JqTreeWidget.prototype.removeNode=function(node){var parent;
parent=node.parent;if(parent){this.select_node_handler.removeFromSelection(node,true);node.remove();return this._refreshElements(parent.parent)
}};JqTreeWidget.prototype.appendNode=function(new_node_info,parent_node){var is_already_root_node,node;
if(!parent_node){parent_node=this.tree}is_already_root_node=parent_node.isFolder();node=parent_node.append(new_node_info);
if(is_already_root_node){this._refreshElements(parent_node)}else{this._refreshElements(parent_node.parent)
}return node};JqTreeWidget.prototype.prependNode=function(new_node_info,parent_node){var node;if(!parent_node){parent_node=this.tree
}node=parent_node.prepend(new_node_info);this._refreshElements(parent_node);return node};JqTreeWidget.prototype.updateNode=function(node,data){var id_is_changed;
id_is_changed=data.id&&data.id!==node.id;if(id_is_changed){this.tree.removeNodeFromIndex(node)}node.setData(data);
if(id_is_changed){this.tree.addNodeToIndex(node)}this._refreshElements(node.parent);return this._selectCurrentNode()
};JqTreeWidget.prototype.moveNode=function(node,target_node,position){var position_index;position_index=Position.nameToIndex(position);
this.tree.moveNode(node,target_node,position_index);return this._refreshElements()};JqTreeWidget.prototype.getStateFromStorage=function(){return this.save_state_handler.getStateFromStorage()
};JqTreeWidget.prototype.addToSelection=function(node){this.select_node_handler.addToSelection(node);
return this._getNodeElementForNode(node).select()};JqTreeWidget.prototype.getSelectedNodes=function(){return this.select_node_handler.getSelectedNodes()
};JqTreeWidget.prototype.isNodeSelected=function(node){return this.select_node_handler.isNodeSelected(node)
};JqTreeWidget.prototype.removeFromSelection=function(node){this.select_node_handler.removeFromSelection(node);
return this._getNodeElementForNode(node).deselect()};JqTreeWidget.prototype.scrollToNode=function(node){var $element,top;
$element=$(node.element);top=$element.offset().top-this.$el.offset().top;return this.scroll_handler.scrollTo(top)
};JqTreeWidget.prototype.getState=function(){return this.save_state_handler.getState()};JqTreeWidget.prototype.setState=function(state){this.save_state_handler.setState(state);
return this._refreshElements()};JqTreeWidget.prototype._init=function(){JqTreeWidget.__super__._init.call(this);
this.element=this.$el;this.mouse_delay=300;this.is_initialized=false;if(typeof SaveStateHandler!=="undefined"&&SaveStateHandler!==null){this.save_state_handler=new SaveStateHandler(this)
}else{this.options.saveState=false}if(typeof SelectNodeHandler!=="undefined"&&SelectNodeHandler!==null){this.select_node_handler=new SelectNodeHandler(this)
}if(typeof DragAndDropHandler!=="undefined"&&DragAndDropHandler!==null){this.dnd_handler=new DragAndDropHandler(this)
}else{this.options.dragAndDrop=false}if(typeof ScrollHandler!=="undefined"&&ScrollHandler!==null){this.scroll_handler=new ScrollHandler(this)
}if((typeof KeyHandler!=="undefined"&&KeyHandler!==null)&&(typeof SelectNodeHandler!=="undefined"&&SelectNodeHandler!==null)){this.key_handler=new KeyHandler(this)
}this._initData();this.element.click($.proxy(this._click,this));if(this.options.useContextMenu){return this.element.bind("contextmenu",$.proxy(this._contextmenu,this))
}};JqTreeWidget.prototype._deinit=function(){this.element.empty();this.element.unbind();this.key_handler.deinit();
this.tree=null;return JqTreeWidget.__super__._deinit.call(this)};JqTreeWidget.prototype._initData=function(){if(this.options.data){return this._loadData(this.options.data)
}else{return this._loadDataFromUrl(this._getDataUrlInfo())}};JqTreeWidget.prototype._getDataUrlInfo=function(node){var data,data_url,url_info;
data_url=this.options.dataUrl||this.element.data("url");if($.isFunction(data_url)){return data_url(node)
}else{if($.type(data_url)==="string"){url_info={url:data_url};if(node&&node.id){data={node:node.id};url_info["data"]=data
}return url_info}else{return data_url}}};JqTreeWidget.prototype._initTree=function(data){this.tree=new this.options.nodeClass(null,true,this.options.nodeClass);
if(this.select_node_handler){this.select_node_handler.clear()}this.tree.loadFromData(data);this._openNodes();
this._refreshElements();if(!this.is_initialized){this.is_initialized=true;return this._triggerEvent("tree.init")
}};JqTreeWidget.prototype._openNodes=function(){var max_level;if(this.options.saveState){if(this.save_state_handler.restoreState()){return
}}if(this.options.autoOpen===false){return}else{if(this.options.autoOpen===true){max_level=-1}else{max_level=parseInt(this.options.autoOpen)
}}return this.tree.iterate(function(node,level){if(node.hasChildren()){node.is_open=true}return level!==max_level
})};JqTreeWidget.prototype._refreshElements=function(from_node){var $element,createFolderLi,createLi,createNodeLi,createUl,doCreateDomElements,escapeIfNecessary,is_root_node,node_element,_this=this;
if(from_node==null){from_node=null}escapeIfNecessary=function(value){if(_this.options.autoEscape){return html_escape(value)
}else{return value}};createUl=function(is_root_node){var class_string;if(is_root_node){class_string="jqtree-tree"
}else{class_string=""}return $('<ul class="jqtree_common '+class_string+'"></ul>')};createLi=function(node){var $li;
if(node.isFolder()){$li=createFolderLi(node)}else{$li=createNodeLi(node)}if(_this.options.onCreateLi){_this.options.onCreateLi(node,$li)
}return $li};createNodeLi=function(node){var class_string,escaped_name,li_classes;li_classes=["jqtree_common"];
if(_this.select_node_handler&&_this.select_node_handler.isNodeSelected(node)){li_classes.push("jqtree-selected")
}class_string=li_classes.join(" ");escaped_name=escapeIfNecessary(node.name);return $('<li class="'+class_string+'"><div class="jqtree-element jqtree_common"><span class="jqtree-title jqtree_common">'+escaped_name+"</span></div></li>")
};createFolderLi=function(node){var button_char,button_classes,escaped_name,folder_classes,getButtonClasses,getFolderClasses;
getButtonClasses=function(){var classes;classes=["jqtree-toggler"];if(!node.is_open){classes.push("jqtree-closed")
}return classes.join(" ")};getFolderClasses=function(){var classes;classes=["jqtree-folder"];if(!node.is_open){classes.push("jqtree-closed")
}if(_this.select_node_handler&&_this.select_node_handler.isNodeSelected(node)){classes.push("jqtree-selected")
}return classes.join(" ")};button_classes=getButtonClasses();folder_classes=getFolderClasses();escaped_name=escapeIfNecessary(node.name);
if(node.is_open){button_char=_this.options.openedIcon}else{button_char=_this.options.closedIcon}return $('<li class="jqtree_common '+folder_classes+'"><div class="jqtree-element jqtree_common"><a class="jqtree_common '+button_classes+'">'+button_char+'</a><span class="jqtree_common jqtree-title">'+escaped_name+"</span></div></li>")
};doCreateDomElements=function($element,children,is_root_node,is_open){var $li,$ul,child,_i,_len;$ul=createUl(is_root_node);
$element.append($ul);for(_i=0,_len=children.length;_i<_len;_i++){child=children[_i];$li=createLi(child);
$ul.append($li);child.element=$li[0];$li.data("node",child);if(child.hasChildren()){doCreateDomElements($li,child.children,false,child.is_open)
}}return null};if(from_node&&from_node.parent){is_root_node=false;node_element=this._getNodeElementForNode(from_node);
node_element.getUl().remove();$element=node_element.$element}else{from_node=this.tree;$element=this.element;
$element.empty();is_root_node=true}doCreateDomElements($element,from_node.children,is_root_node,is_root_node);
return this._triggerEvent("tree.refresh")};JqTreeWidget.prototype._click=function(e){var $button,$el,$target,event,node;
$target=$(e.target);$button=$target.closest(".jqtree-toggler");if($button.length){node=this._getNode($button);
if(node){this.toggle(node,this.options.slide);e.preventDefault();return e.stopPropagation()}}else{$el=$target.closest(".jqtree-element");
if($el.length){node=this._getNode($el);if(node){event=this._triggerEvent("tree.click",{node:node});if(!event.isDefaultPrevented()){return this._selectNode(node,true)
}}}}};JqTreeWidget.prototype._getNode=function($element){var $li;$li=$element.closest("li");if($li.length===0){return null
}else{return $li.data("node")}};JqTreeWidget.prototype._getNodeElementForNode=function(node){if(node.isFolder()){return new FolderElement(node,this)
}else{return new NodeElement(node,this)}};JqTreeWidget.prototype._getNodeElement=function($element){var node;
node=this._getNode($element);if(node){return this._getNodeElementForNode(node)}else{return null}};JqTreeWidget.prototype._contextmenu=function(e){var $div,node;
$div=$(e.target).closest("ul.jqtree-tree .jqtree-element");if($div.length){node=this._getNode($div);if(node){e.preventDefault();
e.stopPropagation();this._triggerEvent("tree.contextmenu",{node:node,click_event:e});return false}}};
JqTreeWidget.prototype._saveState=function(){if(this.options.saveState){return this.save_state_handler.saveState()
}};JqTreeWidget.prototype._mouseCapture=function(position_info){if(this.options.dragAndDrop){return this.dnd_handler.mouseCapture(position_info)
}else{return false}};JqTreeWidget.prototype._mouseStart=function(position_info){if(this.options.dragAndDrop){return this.dnd_handler.mouseStart(position_info)
}else{return false}};JqTreeWidget.prototype._mouseDrag=function(position_info){var result;if(this.options.dragAndDrop){result=this.dnd_handler.mouseDrag(position_info);
if(this.scroll_handler){this.scroll_handler.checkScrolling()}return result}else{return false}};JqTreeWidget.prototype._mouseStop=function(position_info){if(this.options.dragAndDrop){return this.dnd_handler.mouseStop(position_info)
}else{return false}};JqTreeWidget.prototype._triggerEvent=function(event_name,values){var event;event=$.Event(event_name);
$.extend(event,values);this.element.trigger(event);return event};JqTreeWidget.prototype.testGenerateHitAreas=function(moving_node){this.dnd_handler.current_item=this._getNodeElementForNode(moving_node);
this.dnd_handler.generateHitAreas();return this.dnd_handler.hit_areas};JqTreeWidget.prototype._selectCurrentNode=function(){var node,node_element;
node=this.getSelectedNode();if(node){node_element=this._getNodeElementForNode(node);if(node_element){return node_element.select()
}}};JqTreeWidget.prototype._deselectCurrentNode=function(){var node;node=this.getSelectedNode();if(node){return this.removeFromSelection(node)
}};return JqTreeWidget})(MouseWidget);SimpleWidget.register(JqTreeWidget,"tree");NodeElement=(function(){function NodeElement(node,tree_widget){this.init(node,tree_widget)
}NodeElement.prototype.init=function(node,tree_widget){this.node=node;this.tree_widget=tree_widget;return this.$element=$(node.element)
};NodeElement.prototype.getUl=function(){return this.$element.children("ul:first")};NodeElement.prototype.getSpan=function(){return this.$element.children(".jqtree-element").find("span.jqtree-title")
};NodeElement.prototype.getLi=function(){return this.$element};NodeElement.prototype.addDropHint=function(position){if(position===Position.INSIDE){return new BorderDropHint(this.$element)
}else{return new GhostDropHint(this.node,this.$element,position)}};NodeElement.prototype.select=function(){return this.getLi().addClass("jqtree-selected")
};NodeElement.prototype.deselect=function(){return this.getLi().removeClass("jqtree-selected")};return NodeElement
})();FolderElement=(function(_super){__extends(FolderElement,_super);function FolderElement(){_ref2=FolderElement.__super__.constructor.apply(this,arguments);
return _ref2}FolderElement.prototype.open=function(on_finished,slide){var $button,doOpen,_this=this;if(slide==null){slide=true
}if(!this.node.is_open){this.node.is_open=true;$button=this.getButton();$button.removeClass("jqtree-closed");
$button.html(this.tree_widget.options.openedIcon);doOpen=function(){_this.getLi().removeClass("jqtree-closed");
if(on_finished){on_finished()}return _this.tree_widget._triggerEvent("tree.open",{node:_this.node})};
if(slide){return this.getUl().slideDown("fast",doOpen)}else{this.getUl().show();return doOpen()}}};FolderElement.prototype.close=function(slide){var $button,doClose,_this=this;
if(slide==null){slide=true}if(this.node.is_open){this.node.is_open=false;$button=this.getButton();$button.addClass("jqtree-closed");
$button.html(this.tree_widget.options.closedIcon);doClose=function(){_this.getLi().addClass("jqtree-closed");
return _this.tree_widget._triggerEvent("tree.close",{node:_this.node})};if(slide){return this.getUl().slideUp("fast",doClose)
}else{this.getUl().hide();return doClose()}}};FolderElement.prototype.getButton=function(){return this.$element.children(".jqtree-element").find("a.jqtree-toggler")
};FolderElement.prototype.addDropHint=function(position){if(!this.node.is_open&&position===Position.INSIDE){return new BorderDropHint(this.$element)
}else{return new GhostDropHint(this.node,this.$element,position)}};return FolderElement})(NodeElement);
html_escape=function(string){return(""+string).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")
};_indexOf=function(array,item){var i,value,_i,_len;for(i=_i=0,_len=array.length;_i<_len;i=++_i){value=array[i];
if(value===item){return i}}return -1};indexOf=function(array,item){if(array.indexOf){return array.indexOf(item)
}else{return _indexOf(array,item)}};this.Tree.indexOf=indexOf;this.Tree._indexOf=_indexOf;if(!((this.JSON!=null)&&(this.JSON.stringify!=null)&&typeof this.JSON.stringify==="function")){json_escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;
json_meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};json_quote=function(string){json_escapable.lastIndex=0;
if(json_escapable.test(string)){return'"'+string.replace(json_escapable,function(a){var c;c=json_meta[a];
return(typeof c==="string"?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4))})+'"'}else{return'"'+string+'"'
}};json_str=function(key,holder){var i,k,partial,v,value,_i,_len;value=holder[key];switch(typeof value){case"string":return json_quote(value);
case"number":if(isFinite(value)){return String(value)}else{return"null"}case"boolean":case"null":return String(value);
case"object":if(!value){return"null"}partial=[];if(Object.prototype.toString.apply(value)==="[object Array]"){for(i=_i=0,_len=value.length;
_i<_len;i=++_i){v=value[i];partial[i]=json_str(i,value)||"null"}return(partial.length===0?"[]":"["+partial.join(",")+"]")
}for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=json_str(k,value);if(v){partial.push(json_quote(k)+":"+v)
}}}return(partial.length===0?"{}":"{"+partial.join(",")+"}")}};if(this.JSON==null){this.JSON={}}this.JSON.stringify=function(value){return json_str("",{"":value})
}}SaveStateHandler=(function(){function SaveStateHandler(tree_widget){this.tree_widget=tree_widget}SaveStateHandler.prototype.saveState=function(){var state;
state=JSON.stringify(this.getState());if(this.tree_widget.options.onSetStateFromStorage){return this.tree_widget.options.onSetStateFromStorage(state)
}else{if(typeof localStorage!=="undefined"&&localStorage!==null){return localStorage.setItem(this.getCookieName(),state)
}else{if($.cookie){$.cookie.raw=true;return $.cookie(this.getCookieName(),state,{path:"/"})}}}};SaveStateHandler.prototype.restoreState=function(){var state;
state=this.getStateFromStorage();if(state){this.setState($.parseJSON(state));return true}else{return false
}};SaveStateHandler.prototype.getStateFromStorage=function(){if(this.tree_widget.options.onGetStateFromStorage){return this.tree_widget.options.onGetStateFromStorage()
}else{if(typeof localStorage!=="undefined"&&localStorage!==null){return localStorage.getItem(this.getCookieName())
}else{if($.cookie){$.cookie.raw=true;return $.cookie(this.getCookieName())}else{return null}}}};SaveStateHandler.prototype.getState=function(){var open_nodes,selected_node,selected_node_id,_this=this;
open_nodes=[];this.tree_widget.tree.iterate(function(node){if(node.is_open&&node.id&&node.hasChildren()){open_nodes.push(node.id)
}return true});selected_node=this.tree_widget.getSelectedNode();if(selected_node){selected_node_id=selected_node.id
}else{selected_node_id=""}return{open_nodes:open_nodes,selected_node:selected_node_id}};SaveStateHandler.prototype.setState=function(state){var open_nodes,selected_node,selected_node_id,_this=this;
if(state){open_nodes=state.open_nodes;selected_node_id=state.selected_node;this.tree_widget.tree.iterate(function(node){node.is_open=node.id&&node.hasChildren()&&(indexOf(open_nodes,node.id)>=0);
return true});if(selected_node_id&&this.tree_widget.select_node_handler){this.tree_widget.select_node_handler.clear();
selected_node=this.tree_widget.getNodeById(selected_node_id);if(selected_node){return this.tree_widget.select_node_handler.addToSelection(selected_node)
}}}};SaveStateHandler.prototype.getCookieName=function(){if(typeof this.tree_widget.options.saveState==="string"){return this.tree_widget.options.saveState
}else{return"tree"}};return SaveStateHandler})();SelectNodeHandler=(function(){function SelectNodeHandler(tree_widget){this.tree_widget=tree_widget;
this.clear()}SelectNodeHandler.prototype.getSelectedNode=function(){var selected_nodes;selected_nodes=this.getSelectedNodes();
if(selected_nodes.length){return selected_nodes[0]}else{return false}};SelectNodeHandler.prototype.getSelectedNodes=function(){var id,node,selected_nodes;
if(this.selected_single_node){return[this.selected_single_node]}else{selected_nodes=[];for(id in this.selected_nodes){node=this.tree_widget.getNodeById(id);
if(node){selected_nodes.push(node)}}return selected_nodes}};SelectNodeHandler.prototype.isNodeSelected=function(node){if(node.id){return this.selected_nodes[node.id]
}else{if(this.selected_single_node){return this.selected_single_node.element===node.element}else{return false
}}};SelectNodeHandler.prototype.clear=function(){this.selected_nodes={};return this.selected_single_node=null
};SelectNodeHandler.prototype.removeFromSelection=function(node,include_children){var _this=this;if(include_children==null){include_children=false
}if(!node.id){if(node.element===this.selected_single_node.element){return this.selected_single_node=null
}}else{delete this.selected_nodes[node.id];if(include_children){return node.iterate(function(n){delete _this.selected_nodes[node.id];
return true})}}};SelectNodeHandler.prototype.addToSelection=function(node){if(node.id){return this.selected_nodes[node.id]=true
}else{return this.selected_single_node=node}};return SelectNodeHandler})();DragAndDropHandler=(function(){function DragAndDropHandler(tree_widget){this.tree_widget=tree_widget;
this.hovered_area=null;this.$ghost=null;this.hit_areas=[];this.is_dragging=false}DragAndDropHandler.prototype.mouseCapture=function(position_info){var $element,node_element;
$element=$(position_info.target);if(this.tree_widget.options.onIsMoveHandle&&!this.tree_widget.options.onIsMoveHandle($element)){return null
}node_element=this.tree_widget._getNodeElement($element);if(node_element&&this.tree_widget.options.onCanMove){if(!this.tree_widget.options.onCanMove(node_element.node)){node_element=null
}}this.current_item=node_element;return this.current_item!==null};DragAndDropHandler.prototype.mouseStart=function(position_info){var offset;
this.refreshHitAreas();offset=$(position_info.target).offset();this.drag_element=new DragElement(this.current_item.node,position_info.page_x-offset.left,position_info.page_y-offset.top,this.tree_widget.element);
this.is_dragging=true;this.current_item.$element.addClass("jqtree-moving");return true};DragAndDropHandler.prototype.mouseDrag=function(position_info){var area,can_move_to;
this.drag_element.move(position_info.page_x,position_info.page_y);area=this.findHoveredArea(position_info.page_x,position_info.page_y);
can_move_to=this.canMoveToArea(area);if(area){if(this.hovered_area!==area){this.hovered_area=area;if(this.mustOpenFolderTimer(area)){this.startOpenFolderTimer(area.node)
}if(can_move_to){this.updateDropHint()}}}else{this.removeHover();this.removeDropHint();this.stopOpenFolderTimer()
}return true};DragAndDropHandler.prototype.canMoveToArea=function(area){var position_name;if(!area){return false
}else{if(this.tree_widget.options.onCanMoveTo){position_name=Position.getName(area.position);return this.tree_widget.options.onCanMoveTo(this.current_item.node,area.node,position_name)
}else{return true}}};DragAndDropHandler.prototype.mouseStop=function(position_info){this.moveItem(position_info);
this.clear();this.removeHover();this.removeDropHint();this.removeHitAreas();if(this.current_item){this.current_item.$element.removeClass("jqtree-moving")
}this.is_dragging=false;return false};DragAndDropHandler.prototype.refreshHitAreas=function(){this.removeHitAreas();
return this.generateHitAreas()};DragAndDropHandler.prototype.removeHitAreas=function(){return this.hit_areas=[]
};DragAndDropHandler.prototype.clear=function(){this.drag_element.remove();return this.drag_element=null
};DragAndDropHandler.prototype.removeDropHint=function(){if(this.previous_ghost){return this.previous_ghost.remove()
}};DragAndDropHandler.prototype.removeHover=function(){return this.hovered_area=null};DragAndDropHandler.prototype.generateHitAreas=function(){var addPosition,getTop,groupPositions,handleAfterOpenFolder,handleClosedFolder,handleFirstNode,handleNode,handleOpenFolder,hit_areas,last_top,positions,_this=this;
positions=[];last_top=0;getTop=function($element){return $element.offset().top};addPosition=function(node,position,top){positions.push({top:top,node:node,position:position});
return last_top=top};groupPositions=function(handle_group){var group,position,previous_top,_i,_len;previous_top=-1;
group=[];for(_i=0,_len=positions.length;_i<_len;_i++){position=positions[_i];if(position.top!==previous_top){if(group.length){handle_group(group,previous_top,position.top)
}previous_top=position.top;group=[]}group.push(position)}return handle_group(group,previous_top,_this.tree_widget.element.offset().top+_this.tree_widget.element.height())
};handleNode=function(node,next_node,$element){var top;top=getTop($element);if(node===_this.current_item.node){addPosition(node,Position.NONE,top)
}else{addPosition(node,Position.INSIDE,top)}if(next_node===_this.current_item.node||node===_this.current_item.node){return addPosition(node,Position.NONE,top)
}else{return addPosition(node,Position.AFTER,top)}};handleOpenFolder=function(node,$element){if(node===_this.current_item.node){return false
}if(node.children[0]!==_this.current_item.node){addPosition(node,Position.INSIDE,getTop($element))}return true
};handleAfterOpenFolder=function(node,next_node,$element){if(node===_this.current_item.node||next_node===_this.current_item.node){return addPosition(node,Position.NONE,last_top)
}else{return addPosition(node,Position.AFTER,last_top)}};handleClosedFolder=function(node,next_node,$element){var top;
top=getTop($element);if(node===_this.current_item.node){return addPosition(node,Position.NONE,top)}else{addPosition(node,Position.INSIDE,top);
if(next_node!==_this.current_item.node){return addPosition(node,Position.AFTER,top)}}};handleFirstNode=function(node,$element){if(node!==_this.current_item.node){return addPosition(node,Position.BEFORE,getTop($(node.element)))
}};this.iterateVisibleNodes(handleNode,handleOpenFolder,handleClosedFolder,handleAfterOpenFolder,handleFirstNode);
hit_areas=[];groupPositions(function(positions_in_group,top,bottom){var area_height,area_top,position,_i,_len;
area_height=(bottom-top)/positions_in_group.length;area_top=top;for(_i=0,_len=positions_in_group.length;
_i<_len;_i++){position=positions_in_group[_i];hit_areas.push({top:area_top,bottom:area_top+area_height,node:position.node,position:position.position});
area_top+=area_height}return null});return this.hit_areas=hit_areas};DragAndDropHandler.prototype.iterateVisibleNodes=function(handle_node,handle_open_folder,handle_closed_folder,handle_after_open_folder,handle_first_node){var is_first_node,iterate,_this=this;
is_first_node=true;iterate=function(node,next_node){var $element,child,children_length,i,must_iterate_inside,_i,_len,_ref3;
must_iterate_inside=(node.is_open||!node.element)&&node.hasChildren();if(node.element){$element=$(node.element);
if(!$element.is(":visible")){return}if(is_first_node){handle_first_node(node,$element);is_first_node=false
}if(!node.hasChildren()){handle_node(node,next_node,$element)}else{if(node.is_open){if(!handle_open_folder(node,$element)){must_iterate_inside=false
}}else{handle_closed_folder(node,next_node,$element)}}}if(must_iterate_inside){children_length=node.children.length;
_ref3=node.children;for(i=_i=0,_len=_ref3.length;_i<_len;i=++_i){child=_ref3[i];if(i===(children_length-1)){iterate(node.children[i],null)
}else{iterate(node.children[i],node.children[i+1])}}if(node.is_open){return handle_after_open_folder(node,next_node,$element)
}}};return iterate(this.tree_widget.tree)};DragAndDropHandler.prototype.findHoveredArea=function(x,y){var area,high,low,mid,tree_offset;
tree_offset=this.tree_widget.element.offset();if(x<tree_offset.left||y<tree_offset.top||x>(tree_offset.left+this.tree_widget.element.width())||y>(tree_offset.top+this.tree_widget.element.height())){return null
}low=0;high=this.hit_areas.length;while(low<high){mid=(low+high)>>1;area=this.hit_areas[mid];if(y<area.top){high=mid
}else{if(y>area.bottom){low=mid+1}else{return area}}}return null};DragAndDropHandler.prototype.mustOpenFolderTimer=function(area){var node;
node=area.node;return node.isFolder()&&!node.is_open&&area.position===Position.INSIDE};DragAndDropHandler.prototype.updateDropHint=function(){var node_element;
if(!this.hovered_area){return}this.removeDropHint();node_element=this.tree_widget._getNodeElementForNode(this.hovered_area.node);
return this.previous_ghost=node_element.addDropHint(this.hovered_area.position)};DragAndDropHandler.prototype.startOpenFolderTimer=function(folder){var openFolder,_this=this;
openFolder=function(){return _this.tree_widget._openNode(folder,_this.tree_widget.options.slide,function(){_this.refreshHitAreas();
return _this.updateDropHint()})};return this.open_folder_timer=setTimeout(openFolder,500)};DragAndDropHandler.prototype.stopOpenFolderTimer=function(){if(this.open_folder_timer){clearTimeout(this.open_folder_timer);
return this.open_folder_timer=null}};DragAndDropHandler.prototype.moveItem=function(position_info){var doMove,event,moved_node,position,previous_parent,target_node,_this=this;
if(this.hovered_area&&this.hovered_area.position!==Position.NONE&&this.canMoveToArea(this.hovered_area)){moved_node=this.current_item.node;
target_node=this.hovered_area.node;position=this.hovered_area.position;previous_parent=moved_node.parent;
if(position===Position.INSIDE){this.hovered_area.node.is_open=true}doMove=function(){_this.tree_widget.tree.moveNode(moved_node,target_node,position);
_this.tree_widget.element.empty();return _this.tree_widget._refreshElements()};event=this.tree_widget._triggerEvent("tree.move",{move_info:{moved_node:moved_node,target_node:target_node,position:Position.getName(position),previous_parent:previous_parent,do_move:doMove,original_event:position_info.original_event}});
if(!event.isDefaultPrevented()){return doMove()}}};return DragAndDropHandler})();DragElement=(function(){function DragElement(node,offset_x,offset_y,$tree){this.offset_x=offset_x;
this.offset_y=offset_y;this.$element=$('<span class="jqtree-title jqtree-dragging">'+node.name+"</span>");
this.$element.css("position","absolute");$tree.append(this.$element)}DragElement.prototype.move=function(page_x,page_y){return this.$element.offset({left:page_x-this.offset_x,top:page_y-this.offset_y})
};DragElement.prototype.remove=function(){return this.$element.remove()};return DragElement})();GhostDropHint=(function(){function GhostDropHint(node,$element,position){this.$element=$element;
this.node=node;this.$ghost=$('<li class="jqtree_common jqtree-ghost"><span class="jqtree_common jqtree-circle"></span><span class="jqtree_common jqtree-line"></span></li>');
if(position===Position.AFTER){this.moveAfter()}else{if(position===Position.BEFORE){this.moveBefore()}else{if(position===Position.INSIDE){if(node.isFolder()&&node.is_open){this.moveInsideOpenFolder()
}else{this.moveInside()}}}}}GhostDropHint.prototype.remove=function(){return this.$ghost.remove()};GhostDropHint.prototype.moveAfter=function(){return this.$element.after(this.$ghost)
};GhostDropHint.prototype.moveBefore=function(){return this.$element.before(this.$ghost)};GhostDropHint.prototype.moveInsideOpenFolder=function(){return $(this.node.children[0].element).before(this.$ghost)
};GhostDropHint.prototype.moveInside=function(){this.$element.after(this.$ghost);return this.$ghost.addClass("jqtree-inside")
};return GhostDropHint})();BorderDropHint=(function(){function BorderDropHint($element){var $div,width;
$div=$element.children(".jqtree-element");width=$element.width()-4;this.$hint=$('<span class="jqtree-border"></span>');
$div.append(this.$hint);this.$hint.css({width:width,height:$div.height()-4})}BorderDropHint.prototype.remove=function(){return this.$hint.remove()
};return BorderDropHint})();ScrollHandler=(function(){function ScrollHandler(tree_widget){this.tree_widget=tree_widget;
this.previous_top=-1;this._initScrollParent()}ScrollHandler.prototype._initScrollParent=function(){var $scroll_parent,getParentWithOverflow,setDocumentAsScrollParent,_this=this;
getParentWithOverflow=function(){var css_value,css_values,parent,scroll_parent,_i,_j,_len,_len1,_ref3,_ref4;
css_values=["overflow","overflow-y"];scroll_parent=null;_ref3=_this.tree_widget.$el.parents();for(_i=0,_len=_ref3.length;
_i<_len;_i++){parent=_ref3[_i];for(_j=0,_len1=css_values.length;_j<_len1;_j++){css_value=css_values[_j];
if((_ref4=$.css(parent,css_value))==="auto"||_ref4==="scroll"){return $(parent)}}}return null};setDocumentAsScrollParent=function(){_this.scroll_parent_top=0;
return _this.$scroll_parent=null};if(this.tree_widget.$el.css("position")==="fixed"){setDocumentAsScrollParent()
}$scroll_parent=getParentWithOverflow();if($scroll_parent&&$scroll_parent.length&&$scroll_parent[0].tagName!=="HTML"){this.$scroll_parent=$scroll_parent;
return this.scroll_parent_top=this.$scroll_parent.offset().top}else{return setDocumentAsScrollParent()
}};ScrollHandler.prototype.checkScrolling=function(){var hovered_area;hovered_area=this.tree_widget.dnd_handler.hovered_area;
if(hovered_area&&hovered_area.top!==this.previous_top){this.previous_top=hovered_area.top;if(this.$scroll_parent){return this._handleScrollingWithScrollParent(hovered_area)
}else{return this._handleScrollingWithDocument(hovered_area)}}};ScrollHandler.prototype._handleScrollingWithScrollParent=function(area){var distance_bottom;
distance_bottom=this.scroll_parent_top+this.$scroll_parent[0].offsetHeight-area.bottom;if(distance_bottom<20){this.$scroll_parent[0].scrollTop+=20;
this.tree_widget.refreshHitAreas();return this.previous_top=-1}else{if((area.top-this.scroll_parent_top)<20){this.$scroll_parent[0].scrollTop-=20;
this.tree_widget.refreshHitAreas();return this.previous_top=-1}}};ScrollHandler.prototype._handleScrollingWithDocument=function(area){var distance_top;
distance_top=area.top-$(document).scrollTop();if(distance_top<20){return $(document).scrollTop($(document).scrollTop()-20)
}else{if($(window).height()-(area.bottom-$(document).scrollTop())<20){return $(document).scrollTop($(document).scrollTop()+20)
}}};ScrollHandler.prototype.scrollTo=function(top){var tree_top;if(this.$scroll_parent){return this.$scroll_parent[0].scrollTop=top
}else{tree_top=this.tree_widget.$el.offset().top;return $(document).scrollTop(top+tree_top)}};ScrollHandler.prototype.isScrolledIntoView=function(element){var $element,element_bottom,element_top,view_bottom,view_top;
$element=$(element);if(this.$scroll_parent){view_top=0;view_bottom=this.$scroll_parent.height();element_top=$element.offset().top-this.scroll_parent_top;
element_bottom=element_top+$element.height()}else{view_top=$(window).scrollTop();view_bottom=view_top+$(window).height();
element_top=$element.offset().top;element_bottom=element_top+$element.height()}return(element_bottom<=view_bottom)&&(element_top>=view_top)
};return ScrollHandler})();KeyHandler=(function(){var DOWN,LEFT,RIGHT,UP;LEFT=37;UP=38;RIGHT=39;DOWN=40;
function KeyHandler(tree_widget){this.tree_widget=tree_widget;$(document).bind("keydown.jqtree",$.proxy(this.handleKeyDown,this))
}KeyHandler.prototype.deinit=function(){return $(document).unbind("keydown.jqtree")};KeyHandler.prototype.handleKeyDown=function(e){var current_node,key,moveDown,moveLeft,moveRight,moveUp,selectNode,_this=this;
current_node=this.tree_widget.getSelectedNode();selectNode=function(node){if(node){_this.tree_widget.selectNode(node);
if(_this.tree_widget.scroll_handler&&(!_this.tree_widget.scroll_handler.isScrolledIntoView($(node.element).find(".jqtree-element")))){_this.tree_widget.scrollToNode(node)
}return false}else{return true}};moveDown=function(){return selectNode(_this.getNextNode(current_node))
};moveUp=function(){return selectNode(_this.getPreviousNode(current_node))};moveRight=function(){if(current_node.hasChildren()&&!current_node.is_open){_this.tree_widget.openNode(current_node);
return false}else{return true}};moveLeft=function(){if(current_node.hasChildren()&&current_node.is_open){_this.tree_widget.closeNode(current_node);
return false}else{return true}};if(!current_node){return true}else{key=e.which;switch(key){case DOWN:return moveDown();
case UP:return moveUp();case RIGHT:return moveRight();case LEFT:return moveLeft()}}};KeyHandler.prototype.getNextNode=function(node,include_children){var next_sibling;
if(include_children==null){include_children=true}if(include_children&&node.hasChildren()&&node.is_open){return node.children[0]
}else{if(!node.parent){return null}else{next_sibling=node.getNextSibling();if(next_sibling){return next_sibling
}else{return this.getNextNode(node.parent,false)}}}};KeyHandler.prototype.getPreviousNode=function(node){var previous_sibling;
if(!node.parent){return null}else{previous_sibling=node.getPreviousSibling();if(previous_sibling){if(!previous_sibling.hasChildren()||!previous_sibling.is_open){return previous_sibling
}else{return this.getLastChild(previous_sibling)}}else{if(node.parent.parent){return node.parent}else{return null
}}}};KeyHandler.prototype.getLastChild=function(node){var last_child;if(!node.hasChildren()){return null
}else{last_child=node.children[node.children.length-1];if(!last_child.hasChildren()||!last_child.is_open){return last_child
}else{return this.getLastChild(last_child)}}};return KeyHandler})()}).call(this);(function($){var CB=function(e){if(!e){var e=window.event
}e.cancelBubble=true;if(e.stopPropagation){e.stopPropagation()}};$.fn.checkbox=function(options){try{document.execCommand("BackgroundImageCache",false,true)
}catch(e){}var settings={cls:"jquery-checkbox",empty:"empty.png"};settings=$.extend(settings,options||{});
var addEvents=function(object){var checked=object.checked;var disabled=object.disabled;var $object=$(object);
if(object.stateInterval){clearInterval(object.stateInterval)}object.stateInterval=setInterval(function(){if(object.disabled!=disabled){$object.trigger((disabled=!!object.disabled)?"disable":"enable")
}if(object.checked!=checked){$object.trigger((checked=!!object.checked)?"check":"uncheck")}},10);return $object
};return this.each(function(){var ch=this;var $ch=addEvents(ch);if(ch.wrapper){ch.wrapper.remove()}var phrase_on=(window.DESKPRO_LANG?DESKPRO_LANG["agent.general.on"]:false)||"ON";
var phrase_off=(window.DESKPRO_LANG?DESKPRO_LANG["agent.general.off"]:false)||"OFF";ch.wrapper=$('<span class="'+settings.cls+'"><span class="dp-on-text">'+phrase_on+'</span><span class="dp-off-text">'+phrase_off+'</span><span class="mark"><img src="'+settings.empty+'" /></span></span>');
ch.wrapperInner=ch.wrapper.children("span:eq(0)");ch.wrapper.hover(function(e){ch.wrapperInner.addClass(settings.cls+"-hover");
CB(e)},function(e){ch.wrapperInner.removeClass(settings.cls+"-hover");CB(e)});$ch.css({position:"absolute",zIndex:-1,visibility:"hidden"}).after(ch.wrapper);
var label=false;if($ch.attr("id")){label=$("label[for="+$ch.attr("id")+"]");if(!label.length){label=false
}}if(!label){label=$ch.closest?$ch.closest("label"):$ch.parents("label:eq(0)");if(!label.length){label=false
}}if(label){label.hover(function(e){ch.wrapper.trigger("mouseover",[e])},function(e){ch.wrapper.trigger("mouseout",[e])
});label.click(function(e){$ch.trigger("click",[e]);CB(e);return false})}ch.wrapper.click(function(e){$ch.trigger("click",[e]);
CB(e);return false});$ch.click(function(e){CB(e)});$ch.bind("disable",function(){ch.wrapperInner.addClass(settings.cls+"-disabled")
}).bind("enable",function(){ch.wrapperInner.removeClass(settings.cls+"-disabled")});$ch.bind("check",function(){ch.wrapper.addClass(settings.cls+"-checked")
}).bind("uncheck",function(){ch.wrapper.removeClass(settings.cls+"-checked")});$("img",ch.wrapper).bind("dragstart",function(){return false
}).bind("mousedown",function(){return false});if(window.getSelection){ch.wrapper.css("MozUserSelect","none")
}if(ch.checked){ch.wrapper.addClass(settings.cls+"-checked")}if(ch.disabled){ch.wrapperInner.addClass(settings.cls+"-disabled")
}})}})(jQuery);(function(c){var b,e,a=[],d=window;c.fn.tinymce=function(j){var p=this,g,k,h,m,i,l="",n="";
if(!p.length){return p}if(!j){return tinyMCE.get(p[0].id)}p.css("visibility","hidden");function o(){var r=[],q=0;
if(f){f();f=null}p.each(function(t,u){var s,w=u.id,v=j.oninit;if(!w){u.id=w=tinymce.DOM.uniqueId()}s=new tinymce.Editor(w,j);
r.push(s);s.onInit.add(function(){var x,y=v;p.css("visibility","");if(v){if(++q==r.length){if(tinymce.is(y,"string")){x=(y.indexOf(".")===-1)?null:tinymce.resolve(y.replace(/\.\w+$/,""));
y=tinymce.resolve(y)}y.apply(x||tinymce,r)}}})});c.each(r,function(t,s){s.render()})}if(!d.tinymce&&!e&&(g=j.script_url)){e=1;
h=g.substring(0,g.lastIndexOf("/"));if(/_(src|dev)\.js/g.test(g)){n="_src"}m=g.lastIndexOf("?");if(m!=-1){l=g.substring(m+1)
}d.tinyMCEPreInit=d.tinyMCEPreInit||{base:h,suffix:n,query:l};if(g.indexOf("gzip")!=-1){i=j.language||"en";
g=g+(/\?/.test(g)?"&":"?")+"js=true&core=true&suffix="+escape(n)+"&themes="+escape(j.theme)+"&plugins="+escape(j.plugins)+"&languages="+i;
if(!d.tinyMCE_GZ){tinyMCE_GZ={start:function(){tinymce.suffix=n;function q(r){tinymce.ScriptLoader.markDone(tinyMCE.baseURI.toAbsolute(r))
}q("langs/"+i+".js");q("themes/"+j.theme+"/editor_template"+n+".js");q("themes/"+j.theme+"/langs/"+i+".js");
c.each(j.plugins.split(","),function(s,r){if(r){q("plugins/"+r+"/editor_plugin"+n+".js");q("plugins/"+r+"/langs/"+i+".js")
}})},end:function(){}}}}c.ajax({type:"GET",url:g,dataType:"script",cache:true,success:function(){tinymce.dom.Event.domLoaded=1;
e=2;if(j.script_loaded){j.script_loaded()}o();c.each(a,function(q,r){r()})}})}else{if(e===1){a.push(o)
}else{o()}}return p};c.extend(c.expr[":"],{tinymce:function(g){return !!(g.id&&"tinyMCE" in window&&tinyMCE.get(g.id))
}});function f(){function i(l){if(l==="remove"){this.each(function(n,o){var m=h(o);if(m){m.remove()}})
}this.find("span.mceEditor,div.mceEditor").each(function(n,o){var m=tinyMCE.get(o.id.replace(/_parent$/,""));
if(m){m.remove()}})}function k(n){var m=this,l;if(n!==b){i.call(m);m.each(function(p,q){var o;if(o=tinyMCE.get(q.id)){o.setContent(n)
}})}else{if(m.length>0){if(l=tinyMCE.get(m[0].id)){return l.getContent()}}}}function h(m){var l=null;
(m)&&(m.id)&&(d.tinymce)&&(l=tinyMCE.get(m.id));return l}function g(l){return !!((l)&&(l.length)&&(d.tinymce)&&(l.is(":tinymce")))
}var j={};c.each(["text","html","val"],function(n,l){var o=j[l]=c.fn[l],m=(l==="text");c.fn[l]=function(s){var p=this;
if(!g(p)){return o.apply(p,arguments)}if(s!==b){k.call(p.filter(":tinymce"),s);o.apply(p.not(":tinymce"),arguments);
return p}else{var r="";var q=arguments;(m?p:p.eq(0)).each(function(u,v){var t=h(v);r+=t?(m?t.getContent().replace(/<(?:"[^"]*"|'[^']*'|[^'">])*>/g,""):t.getContent({save:true})):o.apply(c(v),q)
});return r}}});c.each(["append","prepend"],function(n,m){var o=j[m]=c.fn[m],l=(m==="prepend");c.fn[m]=function(q){var p=this;
if(!g(p)){return o.apply(p,arguments)}if(q!==b){p.filter(":tinymce").each(function(s,t){var r=h(t);r&&r.setContent(l?q+r.getContent():r.getContent()+q)
});o.apply(p.not(":tinymce"),arguments);return p}}});c.each(["remove","replaceWith","replaceAll","empty"],function(m,l){var n=j[l]=c.fn[l];
c.fn[l]=function(){i.call(this,l);return n.apply(this,arguments)}});j.attr=c.fn.attr;c.fn.attr=function(o,q){var m=this,n=arguments;
if((!o)||(o!=="value")||(!g(m))){if(q!==b){return j.attr.apply(m,n)}else{return j.attr.apply(m,n)}}if(q!==b){k.call(m.filter(":tinymce"),q);
j.attr.apply(m.not(":tinymce"),n);return m}else{var p=m[0],l=h(p);return l?l.getContent({save:true}):j.attr.apply(c(p),n)
}}}})(jQuery);var rwindow,rdocument;if(typeof RELANG==="undefined"){var RELANG={}}var RLANG={html:"HTML",video:"Insert Video",image:"Insert Image",table:"Table",link:"Link",link_insert:"Insert link",unlink:"Unlink",formatting:"Formatting",paragraph:"Paragraph",quote:"Quote",code:"Code",header1:"Header 1",header2:"Header 2",header3:"Header 3",header4:"Header 4",bold:"Bold",italic:"Italic",fontcolor:"Font Color",backcolor:"Back Color",unorderedlist:"Unordered List",orderedlist:"Ordered List",outdent:"Outdent",indent:"Indent",cancel:"Cancel",insert:"Insert",save:"Save",_delete:"Delete",insert_table:"Insert Table",insert_row_above:"Add Row Above",insert_row_below:"Add Row Below",insert_column_left:"Add Column Left",insert_column_right:"Add Column Right",delete_column:"Delete Column",delete_row:"Delete Row",delete_table:"Delete Table",rows:"Rows",columns:"Columns",add_head:"Add Head",delete_head:"Delete Head",title:"Title",image_position:"Position",none:"None",left:"Left",right:"Right",image_web_link:"Image Web Link",text:"Text",mailto:"Email",web:"URL",video_html_code:"Video Embed Code",file:"Insert File",upload:"Upload",download:"Download",choose:"Choose",or_choose:"Or choose",drop_file_here:"Drop file here",align_left:"Align text to the left",align_center:"Center text",align_right:"Align text to the right",align_justify:"Justify text",horizontalrule:"Insert Horizontal Rule",deleted:"Deleted",anchor:"Anchor",link_new_tab:"Open link in new tab",underline:"Underline",alignment:"Alignment"};
(function($){jQuery.fn.redactor=function(option){return this.each(function(){var $obj=$(this);var data=$obj.data("redactor");
if(!data){$obj.data("redactor",(data=new Redactor(this,option)))}})};var Redactor=function(element,options){this.$el=$(element);
if(typeof options!=="undefined"&&typeof options.lang!=="undefined"&&options.lang!=="en"&&typeof RELANG[options.lang]!=="undefined"){RLANG=RELANG[options.lang]
}this.opts=$.extend({iframe:false,css:false,lang:"en",direction:"ltr",callback:false,keyupCallback:false,keydownCallback:false,execCommandCallback:false,plugins:false,cleanup:true,focus:false,tabindex:false,autoresize:true,minHeight:false,fixed:false,fixedTop:0,fixedBox:false,source:true,shortcuts:true,mobile:true,air:false,wym:false,convertLinks:true,convertDivs:true,protocol:"http://",autosave:false,autosaveCallback:false,interval:60,imageGetJson:false,imageUpload:false,imageUploadCallback:false,imageUploadErrorCallback:false,fileUpload:false,fileUploadCallback:false,fileUploadErrorCallback:false,uploadCrossDomain:false,uploadFields:false,observeImages:true,overlay:true,allowedTags:["form","input","button","select","option","datalist","output","textarea","fieldset","legend","section","header","hgroup","aside","footer","article","details","nav","progress","time","canvas","code","span","div","label","a","br","p","b","i","del","strike","u","img","video","source","track","audio","iframe","object","embed","param","blockquote","mark","cite","small","ul","ol","li","hr","dl","dt","dd","sup","sub","big","pre","code","figure","figcaption","strong","em","table","tr","td","th","tbody","thead","tfoot","h1","h2","h3","h4","h5","h6"],toolbarExternal:false,buttonsCustom:{},buttonsAdd:[],buttons:["html","|","formatting","|","bold","italic","deleted","|","unorderedlist","orderedlist","outdent","indent","|","image","video","file","table","link","|","fontcolor","backcolor","|","alignment","|","horizontalrule"],airButtons:["formatting","|","bold","italic","deleted","|","unorderedlist","orderedlist","outdent","indent","|","fontcolor","backcolor"],formattingTags:["p","blockquote","pre","h1","h2","h3","h4"],activeButtons:["deleted","italic","bold","underline","unorderedlist","orderedlist"],activeButtonsStates:{b:"bold",strong:"bold",i:"italic",em:"italic",del:"deleted",strike:"deleted",ul:"unorderedlist",ol:"orderedlist",u:"underline"},colors:["#ffffff","#000000","#eeece1","#1f497d","#4f81bd","#c0504d","#9bbb59","#8064a2","#4bacc6","#f79646","#ffff00","#f2f2f2","#7f7f7f","#ddd9c3","#c6d9f0","#dbe5f1","#f2dcdb","#ebf1dd","#e5e0ec","#dbeef3","#fdeada","#fff2ca","#d8d8d8","#595959","#c4bd97","#8db3e2","#b8cce4","#e5b9b7","#d7e3bc","#ccc1d9","#b7dde8","#fbd5b5","#ffe694","#bfbfbf","#3f3f3f","#938953","#548dd4","#95b3d7","#d99694","#c3d69b","#b2a2c7","#b7dde8","#fac08f","#f2c314","#a5a5a5","#262626","#494429","#17365d","#366092","#953734","#76923c","#5f497a","#92cddc","#e36c09","#c09100","#7f7f7f","#0c0c0c","#1d1b10","#0f243e","#244061","#632423","#4f6128","#3f3151","#31859b","#974806","#7f6000"],emptyHtml:"<p><br /></p>",buffer:false,visual:true,modal_file:String()+'<div id="redactor_modal_content">'+'<form id="redactorUploadFileForm" method="post" action="" enctype="multipart/form-data">'+"<label>Name (optional)</label>"+'<input type="text" id="redactor_filename" class="redactor_input" />'+'<div style="margin-top: 7px;">'+'<input type="file" id="redactor_file" name="file" />'+"</div>"+"</form><br>"+"</div>",modal_image_edit:String()+'<div id="redactor_modal_content">'+"<label>"+RLANG.title+"</label>"+'<input id="redactor_file_alt" class="redactor_input" />'+"<label>"+RLANG.link+"</label>"+'<input id="redactor_file_link" class="redactor_input" />'+"<label>"+RLANG.image_position+"</label>"+'<select id="redactor_form_image_align">'+'<option value="none">'+RLANG.none+"</option>"+'<option value="left">'+RLANG.left+"</option>"+'<option value="right">'+RLANG.right+"</option>"+"</select>"+"</div>"+'<div id="redactor_modal_footer">'+'<a href="javascript:void(null);" id="redactor_image_delete_btn" class="redactor_modal_btn">'+RLANG._delete+"</a>&nbsp;&nbsp;&nbsp;"+'<a href="javascript:void(null);" class="redactor_modal_btn redactor_btn_modal_close">'+RLANG.cancel+"</a>"+'<input type="button" name="save" class="redactor_modal_btn" id="redactorSaveBtn" value="'+RLANG.save+'" />'+"</div>",modal_image:String()+'<div id="redactor_modal_content">'+'<div id="redactor_tabs">'+'<a href="javascript:void(null);" class="redactor_tabs_act">'+RLANG.upload+"</a>"+'<a href="javascript:void(null);">'+RLANG.choose+"</a>"+'<a href="javascript:void(null);">'+RLANG.link+"</a>"+"</div>"+'<form id="redactorInsertImageForm" method="post" action="" enctype="multipart/form-data">'+'<div id="redactor_tab1" class="redactor_tab">'+'<input type="file" id="redactor_file" name="file" />'+"</div>"+'<div id="redactor_tab2" class="redactor_tab" style="display: none;">'+'<div id="redactor_image_box"></div>'+"</div>"+"</form>"+'<div id="redactor_tab3" class="redactor_tab" style="display: none;">'+"<label>"+RLANG.image_web_link+"</label>"+'<input type="text" name="redactor_file_link" id="redactor_file_link" class="redactor_input"  />'+"</div>"+"</div>"+'<div id="redactor_modal_footer">'+'<a href="javascript:void(null);" class="redactor_modal_btn redactor_btn_modal_close">'+RLANG.cancel+"</a>"+'<input type="button" name="upload" class="redactor_modal_btn" id="redactor_upload_btn" value="'+RLANG.insert+'" />'+"</div>",modal_link:String()+'<div id="redactor_modal_content">'+'<form id="redactorInsertLinkForm" method="post" action="">'+'<div id="redactor_tabs">'+'<a href="javascript:void(null);" class="redactor_tabs_act">URL</a>'+'<a href="javascript:void(null);">Email</a>'+'<a href="javascript:void(null);">'+RLANG.anchor+"</a>"+"</div>"+'<input type="hidden" id="redactor_tab_selected" value="1" />'+'<div class="redactor_tab" id="redactor_tab1">'+'<label>URL</label><input type="text" id="redactor_link_url" class="redactor_input"  />'+"<label>"+RLANG.text+'</label><input type="text" class="redactor_input redactor_link_text" id="redactor_link_url_text" />'+'<label><input type="checkbox" id="redactor_link_blank"> '+RLANG.link_new_tab+"</label>"+"</div>"+'<div class="redactor_tab" id="redactor_tab2" style="display: none;">'+'<label>Email</label><input type="text" id="redactor_link_mailto" class="redactor_input" />'+"<label>"+RLANG.text+'</label><input type="text" class="redactor_input redactor_link_text" id="redactor_link_mailto_text" />'+"</div>"+'<div class="redactor_tab" id="redactor_tab3" style="display: none;">'+"<label>"+RLANG.anchor+'</label><input type="text" class="redactor_input" id="redactor_link_anchor"  />'+"<label>"+RLANG.text+'</label><input type="text" class="redactor_input redactor_link_text" id="redactor_link_anchor_text" />'+"</div>"+"</form>"+"</div>"+'<div id="redactor_modal_footer">'+'<a href="javascript:void(null);" class="redactor_modal_btn redactor_btn_modal_close">'+RLANG.cancel+"</a>"+'<input type="button" class="redactor_modal_btn" id="redactor_insert_link_btn" value="'+RLANG.insert+'" />'+"</div>",modal_table:String()+'<div id="redactor_modal_content">'+"<label>"+RLANG.rows+"</label>"+'<input type="text" size="5" value="2" id="redactor_table_rows" />'+"<label>"+RLANG.columns+"</label>"+'<input type="text" size="5" value="3" id="redactor_table_columns" />'+"</div>"+'<div id="redactor_modal_footer">'+'<a href="javascript:void(null);" class="redactor_modal_btn redactor_btn_modal_close">'+RLANG.cancel+"</a>"+'<input type="button" name="upload" class="redactor_modal_btn" id="redactor_insert_table_btn" value="'+RLANG.insert+'" />'+"</div>",modal_video:String()+'<div id="redactor_modal_content">'+'<form id="redactorInsertVideoForm">'+"<label>"+RLANG.video_html_code+"</label>"+'<textarea id="redactor_insert_video_area" style="width: 99%; height: 160px;"></textarea>'+"</form>"+"</div>"+'<div id="redactor_modal_footer">'+'<a href="javascript:void(null);" class="redactor_modal_btn redactor_btn_modal_close">'+RLANG.cancel+"</a>"+'<input type="button" class="redactor_modal_btn" id="redactor_insert_video_btn" value="'+RLANG.insert+'" />'+"</div>",toolbar:{html:{title:RLANG.html,func:"toggle"},formatting:{title:RLANG.formatting,func:"show",dropdown:{p:{title:RLANG.paragraph,exec:"formatblock"},blockquote:{title:RLANG.quote,exec:"formatblock",className:"redactor_format_blockquote"},pre:{title:RLANG.code,exec:"formatblock",className:"redactor_format_pre"},h1:{title:RLANG.header1,exec:"formatblock",className:"redactor_format_h1"},h2:{title:RLANG.header2,exec:"formatblock",className:"redactor_format_h2"},h3:{title:RLANG.header3,exec:"formatblock",className:"redactor_format_h3"},h4:{title:RLANG.header4,exec:"formatblock",className:"redactor_format_h4"}}},bold:{title:RLANG.bold,exec:"bold"},italic:{title:RLANG.italic,exec:"italic"},deleted:{title:RLANG.deleted,exec:"strikethrough"},underline:{title:RLANG.underline,exec:"underline"},unorderedlist:{title:"&bull; "+RLANG.unorderedlist,exec:"insertunorderedlist"},orderedlist:{title:"1. "+RLANG.orderedlist,exec:"insertorderedlist"},outdent:{title:"< "+RLANG.outdent,exec:"outdent"},indent:{title:"> "+RLANG.indent,exec:"indent"},image:{title:RLANG.image,func:"showImage"},video:{title:RLANG.video,func:"showVideo"},file:{title:RLANG.file,func:"showFile"},table:{title:RLANG.table,func:"show",dropdown:{insert_table:{title:RLANG.insert_table,func:"showTable"},separator_drop1:{name:"separator"},insert_row_above:{title:RLANG.insert_row_above,func:"insertRowAbove"},insert_row_below:{title:RLANG.insert_row_below,func:"insertRowBelow"},insert_column_left:{title:RLANG.insert_column_left,func:"insertColumnLeft"},insert_column_right:{title:RLANG.insert_column_right,func:"insertColumnRight"},separator_drop2:{name:"separator"},add_head:{title:RLANG.add_head,func:"addHead"},delete_head:{title:RLANG.delete_head,func:"deleteHead"},separator_drop3:{name:"separator"},delete_column:{title:RLANG.delete_column,func:"deleteColumn"},delete_row:{title:RLANG.delete_row,func:"deleteRow"},delete_table:{title:RLANG.delete_table,func:"deleteTable"}}},link:{title:RLANG.link,func:"show",dropdown:{link:{title:RLANG.link_insert,func:"showLink"},unlink:{title:RLANG.unlink,exec:"unlink"}}},fontcolor:{title:RLANG.fontcolor,func:"show"},backcolor:{title:RLANG.backcolor,func:"show"},alignment:{title:RLANG.alignment,func:"show",dropdown:{alignleft:{title:RLANG.align_left,exec:"JustifyLeft"},aligncenter:{title:RLANG.align_center,exec:"JustifyCenter"},alignright:{title:RLANG.align_right,exec:"JustifyRight"},justify:{title:RLANG.align_justify,exec:"JustifyFull"}}},alignleft:{exec:"JustifyLeft",title:RLANG.align_left},aligncenter:{exec:"JustifyCenter",title:RLANG.align_center},alignright:{exec:"JustifyRight",title:RLANG.align_right},justify:{exec:"JustifyFull",title:RLANG.align_justify},horizontalrule:{exec:"inserthorizontalrule",title:RLANG.horizontalrule}}},options,this.$el.data());
this.dropdowns=[];this.init()};Redactor.prototype={init:function(){this.height=this.$el.css("height");
this.width=this.$el.css("width");rdocument=this.document=document;rwindow=this.window=window;if(this.opts.mobile===false&&this.isMobile()){this.build(true);
return false}if(this.opts.iframe){this.opts.autoresize=false}if(this.opts.air){$.extend(this.opts.toolbar,this.opts.buttonsCustom);
this.opts.buttons=this.opts.airButtons}else{if(this.opts.toolbar!==false){if(this.opts.source===false){var index=this.opts.buttons.indexOf("html");
var next=this.opts.buttons[index+1];this.opts.buttons.splice(index,1);if(typeof next!=="undefined"&&next==="|"){this.opts.buttons.splice(index,1)
}}$.extend(this.opts.toolbar,this.opts.buttonsCustom);$.each(this.opts.buttonsAdd,$.proxy(function(i,s){this.opts.buttons.push(s)
},this))}}if(this.opts.toolbar!==false){$.each(this.opts.toolbar.formatting.dropdown,$.proxy(function(i,s){if($.inArray(i,this.opts.formattingTags)=="-1"){delete this.opts.toolbar.formatting.dropdown[i]
}},this))}function afterBuild(){this.enableAir();this.buildToolbar();if(typeof this.opts.plugins==="object"){$.each(this.opts.plugins,$.proxy(function(i,s){if(typeof RedactorPlugins[s]!=="undefined"){$.extend(this,RedactorPlugins[s]);
if(typeof RedactorPlugins[s].init!=="undefined"){this.init()}}},this))}if(this.opts.activeButtons!==false&&this.opts.toolbar!==false){var observeFormatting=$.proxy(function(){this.observeFormatting()
},this);this.$editor.click(observeFormatting).keyup(observeFormatting)}var oldsafari=false;if(this.browser("webkit")&&navigator.userAgent.indexOf("Chrome")===-1){var arr=this.browser("version").split(".");
if(arr[0]<536){oldsafari=true}}if(this.isMobile(true)===false&&oldsafari===false&&this.browser("opera")===false){this.$editor.bind("paste",$.proxy(function(e){if(this.opts.cleanup===false){return true
}this.pasteRunning=true;this.setBuffer();if(this.opts.autoresize===true){this.saveScroll=this.document.body.scrollTop
}else{this.saveScroll=this.$editor.scrollTop()}var frag=this.extractContent();setTimeout($.proxy(function(){var pastedFrag=this.extractContent();
this.$editor.append(frag);this.restoreSelection();var html=this.getFragmentHtml(pastedFrag);this.pasteCleanUp(html);
this.pasteRunning=false},this),1)},this))}this.keyup();this.keydown();if(this.opts.autosave!==false){this.autoSave()
}setTimeout($.proxy(function(){this.observeImages();this.observeTables()},this),1);if(this.browser("mozilla")){this.$editor.click($.proxy(function(){this.saveSelection()
},this));try{this.document.execCommand("enableObjectResizing",false,false);this.document.execCommand("enableInlineTableEditing",false,false)
}catch(e){}}if(this.opts.focus){setTimeout($.proxy(function(){this.$editor.focus()},this),1)}if(this.opts.fixed){this.observeScroll();
$(document).scroll($.proxy(this.observeScroll,this))}if(typeof this.opts.callback==="function"){this.opts.callback(this)
}if(this.opts.toolbar!==false){this.$toolbar.find("a").attr("tabindex","-1")}}this.build(false,afterBuild)
},shortcuts:function(e,cmd){e.preventDefault();this.execCommand(cmd,false)},keyup:function(){this.$editor.keyup($.proxy(function(e){var key=e.keyCode||e.which;
if(this.browser("mozilla")&&!this.pasteRunning){this.saveSelection()}if(typeof this.opts.keyupCallback==="function"){this.opts.keyupCallback(this,e)
}if(key===8||key===46){this.observeImages();return this.formatEmpty(e)}if(key===13&&!e.shiftKey&&!e.ctrlKey&&!e.metaKey){if(this.browser("webkit")){this.formatNewLine(e)
}if(this.opts.convertLinks){this.$editor.linkify()}}this.syncCode()},this))},keydown:function(){this.$editor.keydown($.proxy(function(e){var key=e.keyCode||e.which;
var parent=this.getParentNode();var current=this.getCurrentNode();var pre=false;var ctrl=e.ctrlKey||e.metaKey;
if((parent||current)&&($(parent).get(0).tagName==="PRE"||$(current).get(0).tagName==="PRE")){pre=true
}if(typeof this.opts.keydownCallback==="function"){this.opts.keydownCallback(this,e)}if(ctrl&&this.opts.shortcuts){if(key===90){if(this.opts.buffer!==false){e.preventDefault();
this.getBuffer()}else{if(e.shiftKey){this.shortcuts(e,"redo")}else{this.shortcuts(e,"undo")}}}else{if(key===77){this.shortcuts(e,"removeFormat")
}else{if(key===66){this.shortcuts(e,"bold")}else{if(key===73){this.shortcuts(e,"italic")}else{if(key===74){this.shortcuts(e,"insertunorderedlist")
}else{if(key===75){this.shortcuts(e,"insertorderedlist")}else{if(key===76){this.shortcuts(e,"superscript")
}else{if(key===72){this.shortcuts(e,"subscript")}}}}}}}}}if(!ctrl&&key!==90){this.opts.buffer=false}if(pre===true&&key===13){e.preventDefault();
var html=$(current).parent().text();this.insertNodeAtCaret(this.document.createTextNode("\r\n"));if(html.search(/\s$/)==-1){this.insertNodeAtCaret(this.document.createTextNode("\r\n"))
}this.syncCode();return false}if(this.opts.shortcuts&&!e.shiftKey&&key===9){if(pre===false){this.shortcuts(e,"indent")
}else{e.preventDefault();this.insertNodeAtCaret(this.document.createTextNode("\t"));this.syncCode();return false
}}else{if(this.opts.shortcuts&&e.shiftKey&&key===9){this.shortcuts(e,"outdent")}}if(this.browser("webkit")&&navigator.userAgent.indexOf("Chrome")===-1){return this.safariShiftKeyEnter(e,key)
}},this))},build:function(mobile,whendone){if(mobile!==true){this.$box=$('<div class="redactor_box"></div>');
if(this.opts.air){this.air=$('<div class="redactor_air" style="display: none;"></div>')}this.$content=null;
function initFrame(){this.$editor=this.$content.contents().find("body").attr("contenteditable",true).attr("dir",this.opts.direction);
rdocument=this.document=this.$editor[0].ownerDocument;rwindow=this.window=this.document.defaultView||window;
if(this.opts.css!==false){this.$content.contents().find("head").append('<link rel="stylesheet" href="'+this.opts.css+'" />')
}this.$editor.html(html);if(whendone){whendone.call(this);whendone=null}}this.textareamode=true;if(this.$el.get(0).tagName==="TEXTAREA"){if(this.opts.iframe){var me=this;
this.$content=$('<iframe style="width: 100%;" frameborder="0"></iframe>').load(function(){initFrame.call(me)
})}else{this.$content=this.$editor=$("<div></div>")}var classlist=this.$el.get(0).className.split(/\s+/);
$.each(classlist,$.proxy(function(i,s){this.$content.addClass("redactor_"+s)},this))}else{this.textareamode=false;
this.$content=this.$editor=this.$el;this.$el=$('<textarea name="'+this.$editor.attr("id")+'"></textarea>').css("height",this.height)
}if(this.$editor){this.$editor.addClass("redactor_editor").attr("contenteditable",true).attr("dir",this.opts.direction)
}if(this.opts.tabindex!==false){this.$content.attr("tabindex",this.opts.tabindex)}if(this.opts.minHeight!==false){this.$content.css("min-height",this.opts.minHeight+"px")
}if(this.opts.wym===true){this.$content.addClass("redactor_editor_wym")}if(this.opts.autoresize===false){this.$content.css("height",this.height)
}this.$el.hide();var html="";if(this.textareamode){html=this.$el.val();html=this.savePreCode(html);this.$box.insertAfter(this.$el).append(this.$content).append(this.$el)
}else{html=this.$editor.html();html=this.savePreCode(html);this.$box.insertAfter(this.$content).append(this.$el).append(this.$editor)
}html=this.paragraphy(html);if(this.$editor){this.$editor.html(html)}if(this.textareamode===false){this.syncCode()
}}else{if(this.$el.get(0).tagName!=="TEXTAREA"){var html=this.$el.val();var textarea=$('<textarea name="'+this.$editor.attr("id")+'"></textarea>').css("height",this.height).val(html);
this.$el.hide();this.$el.after(textarea)}}if(whendone&&this.$editor){whendone.call(this)}},enableAir:function(){if(this.opts.air===false){return false
}this.air.hide();this.$editor.bind("textselect",$.proxy(function(e){this.showAir(e)},this));this.$editor.bind("textunselect",$.proxy(function(){this.air.hide()
},this))},showAir:function(e){$(".redactor_air").hide();var width=this.air.innerWidth();var left=e.clientX;
if($(this.document).width()<(left+width)){left=left-width}var top=e.clientY+$(document).scrollTop()+14;
if(this.opts.iframe===true){top=top+this.$box.position().top;left=left+this.$box.position().left}this.air.css({left:left+"px",top:top+"px"}).show()
},syncCode:function(){this.$el.val(this.$editor.html())},setCode:function(html){html=this.stripTags(html);
this.$editor.html(html).focus();this.syncCode()},getCode:function(){var html="";if(this.opts.visual){html=this.$editor.html()
}else{html=this.$el.val()}return this.stripTags(html)},insertHtml:function(html){this.$editor.focus();
this.pasteHtmlAtCaret(html);this.observeImages();this.syncCode()},pasteHtmlAtCaret:function(html){var sel,range;
if(this.document.getSelection){sel=this.window.getSelection();if(sel.getRangeAt&&sel.rangeCount){range=sel.getRangeAt(0);
range.deleteContents();var el=this.document.createElement("div");el.innerHTML=html;var frag=this.document.createDocumentFragment(),node,lastNode;
while(node=el.firstChild){lastNode=frag.appendChild(node)}range.insertNode(frag);if(lastNode){range=range.cloneRange();
range.setStartAfter(lastNode);range.collapse(true);sel.removeAllRanges();sel.addRange(range)}}}else{if(this.document.selection&&this.document.selection.type!="Control"){this.document.selection.createRange().pasteHTML(html)
}}},destroy:function(){var html=this.getCode();if(this.textareamode){this.$box.after(this.$el);this.$box.remove();
this.$el.height(this.height).val(html).show()}else{this.$box.after(this.$editor);this.$box.remove();this.$editor.removeClass("redactor_editor").removeClass("redactor_editor_wym").attr("contenteditable",false).html(html).show()
}if(this.opts.toolbarExternal){$(this.opts.toolbarExternal).empty()}$(".redactor_air").remove();for(var i=0;
i<this.dropdowns.length;i++){this.dropdowns[i].remove();delete (this.dropdowns[i])}if(this.opts.autosave!==false){clearInterval(this.autosaveInterval)
}},observeFormatting:function(){var parent=this.getCurrentNode();this.inactiveAllButtons();$.each(this.opts.activeButtonsStates,$.proxy(function(i,s){if($(parent).closest(i,this.$editor.get()[0]).length!=0){this.setBtnActive(s)
}},this));var tag=$(parent).closest(["p","div","h1","h2","h3","h4","h5","h6","blockquote","td"]);if(typeof tag[0]!=="undefined"&&typeof tag[0].elem!=="undefined"&&$(tag[0].elem).size()!=0){var align=$(tag[0].elem).css("text-align");
switch(align){case"right":this.setBtnActive("alignright");break;case"center":this.setBtnActive("aligncenter");
break;case"justify":this.setBtnActive("justify");break;default:this.setBtnActive("alignleft");break}}},observeImages:function(){if(this.opts.observeImages===false){return false
}this.$editor.find("img").each($.proxy(function(i,s){if(this.browser("msie")){$(s).attr("unselectable","on")
}this.resizeImage(s)},this))},observeTables:function(){this.$editor.find("table").click($.proxy(this.tableObserver,this))
},observeScroll:function(){var scrolltop=$(this.document).scrollTop();var boxtop=this.$box.offset().top;
var left=0;if(scrolltop>boxtop){var width="100%";if(this.opts.fixedBox){left=this.$box.offset().left;
width=this.$box.innerWidth()}this.fixed=true;this.$toolbar.css({position:"fixed",width:width,zIndex:1005,top:this.opts.fixedTop+"px",left:left})
}else{this.fixed=false;this.$toolbar.css({position:"relative",width:"auto",zIndex:1,top:0,left:left})
}},setBuffer:function(){this.saveSelection();this.opts.buffer=this.$editor.html()},getBuffer:function(){if(this.opts.buffer===false){return false
}this.$editor.html(this.opts.buffer);if(!this.browser("msie")){this.restoreSelection()}this.opts.buffer=false
},execCommand:function(cmd,param){if(this.opts.visual==false){this.$el.focus();return false}try{var parent;
if(cmd==="inserthtml"){if(this.browser("msie")){this.$editor.focus();this.document.selection.createRange().pasteHTML(param)
}else{this.pasteHtmlAtCaret(param)}this.observeImages()}else{if(cmd==="unlink"){parent=this.getParentNode();
if($(parent).get(0).tagName==="A"){$(parent).replaceWith($(parent).text())}else{this.execRun(cmd,param)
}}else{if(cmd==="JustifyLeft"||cmd==="JustifyCenter"||cmd==="JustifyRight"||cmd==="JustifyFull"){parent=this.getCurrentNode();
var tag=$(parent).get(0).tagName;if(this.opts.iframe===false&&$(parent).parents(".redactor_editor").size()==0){return false
}var tagsArray=["P","DIV","H1","H2","H3","H4","H5","H6","BLOCKQUOTE","TD"];if($.inArray(tag,tagsArray)!=-1){var align=false;
if(cmd==="JustifyCenter"){align="center"}else{if(cmd==="JustifyRight"){align="right"}else{if(cmd==="JustifyFull"){align="justify"
}}}if(align===false){$(parent).css("text-align","")}else{$(parent).css("text-align",align)}}else{this.execRun(cmd,param)
}}else{if(cmd==="formatblock"&&param==="blockquote"){parent=this.getCurrentNode();if($(parent).get(0).tagName==="BLOCKQUOTE"){if(this.browser("msie")){var node=$("<p>"+$(parent).html()+"</p>");
$(parent).replaceWith(node)}else{this.execRun(cmd,"p")}}else{if($(parent).get(0).tagName==="P"){var parent2=$(parent).parent();
if($(parent2).get(0).tagName==="BLOCKQUOTE"){var node=$("<p>"+$(parent).html()+"</p>");$(parent2).replaceWith(node);
this.setSelection(node[0],0,node[0],0)}else{if(this.browser("msie")){var node=$("<blockquote>"+$(parent).html()+"</blockquote>");
$(parent).replaceWith(node)}else{this.execRun(cmd,param)}}}else{this.execRun(cmd,param)}}}else{if(cmd==="formatblock"&&(param==="pre"||param==="p")){parent=this.getParentNode();
if($(parent).get(0).tagName==="PRE"){$(parent).replaceWith("<p>"+this.encodeEntities($(parent).text())+"</p>")
}else{this.execRun(cmd,param)}}else{if(cmd==="inserthorizontalrule"&&this.browser("msie")){this.$editor.focus()
}if(cmd==="formatblock"&&this.browser("mozilla")){this.$editor.focus()}this.execRun(cmd,param)}}}}}if(cmd==="inserthorizontalrule"){this.$editor.find("hr").removeAttr("id")
}this.syncCode();if(this.oldIE()){this.$editor.focus()}if(typeof this.opts.execCommandCallback==="function"){this.opts.execCommandCallback(this,cmd)
}if(this.opts.air){this.air.hide()}}catch(e){}},execRun:function(cmd,param){if(cmd==="formatblock"&&this.browser("msie")){param="<"+param+">"
}this.document.execCommand(cmd,false,param)},formatNewLine:function(e){var parent=this.getParentNode();
if(parent.nodeName==="DIV"&&parent.className==="redactor_editor"){var element=$(this.getCurrentNode());
if(element.get(0).tagName==="DIV"&&(element.html()===""||element.html()==="<br>")){var newElement=$("<p>").append(element.clone().get(0).childNodes);
element.replaceWith(newElement);newElement.html("<br />");this.setSelection(newElement[0],0,newElement[0],0)
}}},safariShiftKeyEnter:function(e,key){if(e.shiftKey&&key===13){e.preventDefault();this.insertNodeAtCaret($("<span><br /></span>").get(0));
this.syncCode();return false}else{return true}},formatEmpty:function(e){var html=$.trim(this.$editor.html());
html=html.replace(/<br\s?\/?>/i,"");var thtml=html.replace(/<p>\s?<\/p>/gi,"");if(html===""||thtml===""){e.preventDefault();
var node=$(this.opts.emptyHtml).get(0);this.$editor.html(node);this.setSelection(node,0,node,0);this.syncCode();
return false}else{this.syncCode()}},paragraphy:function(str){str=$.trim(str);if(str===""||str==="<p></p>"){return this.opts.emptyHtml
}if(this.opts.convertDivs){str=str.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"<p>$2</p>")}var X=function(x,a,b){return x.replace(new RegExp(a,"g"),b)
};var R=function(a,b){return X(str,a,b)};var blocks="(table|thead|tfoot|caption|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|form|blockquote|address|math|style|script|object|input|param|p|h[1-6])";
str+="\n";R("<br />\\s*<br />","\n\n");R("(<"+blocks+"[^>]*>)","\n$1");R("(</"+blocks+">)","$1\n\n");
R("\r\n|\r","\n");R("\n\n+","\n\n");R("\n?((.|\n)+?)$","<p>$1</p>\n");R("<p>\\s*?</p>","");R("<p>(<div[^>]*>\\s*)","$1<p>");
R("<p>([^<]+)\\s*?(</(div|address|form)[^>]*>)","<p>$1</p>$2");R("<p>\\s*(</?"+blocks+"[^>]*>)\\s*</p>","$1");
R("<p>(<li.+?)</p>","$1");R("<p>\\s*(</?"+blocks+"[^>]*>)","$1");R("(</?"+blocks+"[^>]*>)\\s*</p>","$1");
R("(</?"+blocks+"[^>]*>)\\s*<br />","$1");R("<br />(\\s*</?(p|li|div|dl|dd|dt|th|pre|td|ul|ol)[^>]*>)","$1");
if(str.indexOf("<pre")!=-1){R("(<pre(.|\n)*?>)((.|\n)*?)</pre>",function(m0,m1,m2,m3){return X(m1,"\\\\(['\"\\\\])","$1")+X(X(X(m3,"<p>","\n"),"</p>|<br />",""),"\\\\(['\"\\\\])","$1")+"</pre>"
})}return R("\n</p>$","</p>")},stripTags:function(html){var allowed=this.opts.allowedTags;var tags=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi;
return html.replace(tags,function($0,$1){return $.inArray($1.toLowerCase(),allowed)>"-1"?$0:""})},savePreCode:function(html){var pre=html.match(/<pre(.*?)>([\w\W]*?)<\/pre>/gi);
if(pre!==null){$.each(pre,$.proxy(function(i,s){var arr=s.match(/<pre(.*?)>([\w\W]*?)<\/pre>/i);arr[2]=this.encodeEntities(arr[2]);
html=html.replace(s,"<pre"+arr[1]+">"+arr[2]+"</pre>")},this))}return html},encodeEntities:function(str){str=String(str).replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"');
return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")
},cleanupPre:function(s){s=s.replace(/<br>/gi,"\n");s=s.replace(/<\/p>/gi,"\n");s=s.replace(/<\/div>/gi,"\n");
var tmp=this.document.createElement("div");tmp.innerHTML=s;return tmp.textContent||tmp.innerText},pasteCleanUp:function(html){var parent=this.getParentNode();
if($(parent).get(0).tagName==="PRE"){html=this.cleanupPre(html);this.pasteCleanUpInsert(html);return true
}html=html.replace(/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi,"");html=html.replace(/(&nbsp;){2,}/gi,"&nbsp;");
html=html.replace(/<b\sid="internal-source-marker(.*?)">([\w\W]*?)<\/b>/gi,"$2");html=this.stripTags(html);
html=html.replace(/<td><\/td>/gi,"[td]");html=html.replace(/<td>&nbsp;<\/td>/gi,"[td]");html=html.replace(/<td><br><\/td>/gi,"[td]");
html=html.replace(/<a(.*?)href="(.*?)"(.*?)>([\w\W]*?)<\/a>/gi,'[a href="$2"]$4[/a]');html=html.replace(/<iframe(.*?)>([\w\W]*?)<\/iframe>/gi,"[iframe$1]$2[/iframe]");
html=html.replace(/<video(.*?)>([\w\W]*?)<\/video>/gi,"[video$1]$2[/video]");html=html.replace(/<audio(.*?)>([\w\W]*?)<\/audio>/gi,"[audio$1]$2[/audio]");
html=html.replace(/<embed(.*?)>([\w\W]*?)<\/embed>/gi,"[embed$1]$2[/embed]");html=html.replace(/<object(.*?)>([\w\W]*?)<\/object>/gi,"[object$1]$2[/object]");
html=html.replace(/<param(.*?)>/gi,"[param$1]");html=html.replace(/<img(.*?)style="(.*?)"(.*?)>/gi,"[img$1$3]");
html=html.replace(/<(\w+)([\w\W]*?)>/gi,"<$1>");html=html.replace(/<[^\/>][^>]*>(\s*|\t*|\n*|&nbsp;|<br>)<\/[^>]+>/gi,"");
html=html.replace(/<[^\/>][^>]*>(\s*|\t*|\n*|&nbsp;|<br>)<\/[^>]+>/gi,"");html=html.replace(/\[td\]/gi,"<td>&nbsp;</td>");
html=html.replace(/\[a href="(.*?)"\]([\w\W]*?)\[\/a\]/gi,'<a href="$1">$2</a>');html=html.replace(/\[iframe(.*?)\]([\w\W]*?)\[\/iframe\]/gi,"<iframe$1>$2</iframe>");
html=html.replace(/\[video(.*?)\]([\w\W]*?)\[\/video\]/gi,"<video$1>$2</video>");html=html.replace(/\[audio(.*?)\]([\w\W]*?)\[\/audio\]/gi,"<audio$1>$2</audio>");
html=html.replace(/\[embed(.*?)\]([\w\W]*?)\[\/embed\]/gi,"<embed$1>$2</embed>");html=html.replace(/\[object(.*?)\]([\w\W]*?)\[\/object\]/gi,"<object$1>$2</object>");
html=html.replace(/\[param(.*?)\]/gi,"<param$1>");html=html.replace(/\[img(.*?)\]/gi,"<img$1>");if(this.opts.convertDivs){html=html.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi,"<p>$2</p>")
}html=html.replace(/<span>([\w\W]*?)<\/span>/gi,"$1");html=html.replace(/\n{3,}/gi,"\n");html=html.replace(/<p><p>/gi,"<p>");
html=html.replace(/<\/p><\/p>/gi,"</p>");if(this.browser("mozilla")){html=html.replace(/<br>$/gi,"")}this.pasteCleanUpInsert(html)
},pasteCleanUpInsert:function(html){this.execCommand("inserthtml",html);if(this.opts.autoresize===true){$(this.document.body).scrollTop(this.saveScroll)
}else{this.$editor.scrollTop(this.saveScroll)}},formattingRemove:function(html){var prebuffer=[];var pre=html.match(/<pre(.*?)>([\w\W]*?)<\/pre>/gi);
if(pre!==null){$.each(pre,function(i,s){html=html.replace(s,"prebuffer_"+i);prebuffer.push(s)})}html=html.replace(/\s{2,}/g," ");
html=html.replace(/\n/g," ");html=html.replace(/[\t]*/g,"");html=html.replace(/\n\s*\n/g,"\n");html=html.replace(/^[\s\n]*/g,"");
html=html.replace(/[\s\n]*$/g,"");html=html.replace(/>\s+</g,"><");if(prebuffer){$.each(prebuffer,function(i,s){html=html.replace("prebuffer_"+i,s)
});prebuffer=[]}return html},formattingIndenting:function(html){html=html.replace(/<li/g,"\t<li");html=html.replace(/<tr/g,"\t<tr");
html=html.replace(/<td/g,"\t\t<td");html=html.replace(/<\/tr>/g,"\t</tr>");return html},formattingEmptyTags:function(html){var etags=["<pre></pre>","<blockquote>\\s*</blockquote>","<em>\\s*</em>","<ul></ul>","<ol></ol>","<li></li>","<table></table>","<tr></tr>","<span>\\s*<span>","<span>&nbsp;<span>","<b>\\s*</b>","<b>&nbsp;</b>","<p>\\s*</p>","<p>&nbsp;</p>","<p>\\s*<br>\\s*</p>","<div>\\s*</div>","<div>\\s*<br>\\s*</div>"];
for(var i=0;i<etags.length;++i){var bbb=etags[i];html=html.replace(new RegExp(bbb,"gi"),"")}return html
},formattingAddBefore:function(html){var lb="\r\n";var btags=["<p","<form","</ul>","</ol>","<fieldset","<legend","<object","<embed","<select","<option","<input","<textarea","<pre","<blockquote","<ul","<ol","<li","<dl","<dt","<dd","<table","<thead","<tbody","<caption","</caption>","<th","<tr","<td","<figure"];
for(var i=0;i<btags.length;++i){var eee=btags[i];html=html.replace(new RegExp(eee,"gi"),lb+eee)}return html
},formattingAddAfter:function(html){var lb="\r\n";var atags=["</p>","</div>","</h1>","</h2>","</h3>","</h4>","</h5>","</h6>","<br>","<br />","</dl>","</dt>","</dd>","</form>","</blockquote>","</pre>","</legend>","</fieldset>","</object>","</embed>","</textarea>","</select>","</option>","</table>","</thead>","</tbody>","</tr>","</td>","</th>","</figure>"];
for(var i=0;i<atags.length;++i){var aaa=atags[i];html=html.replace(new RegExp(aaa,"gi"),aaa+lb)}return html
},formatting:function(html){html=this.formattingRemove(html);html=this.formattingEmptyTags(html);html=this.formattingAddBefore(html);
html=this.formattingAddAfter(html);html=this.formattingIndenting(html);return html},toggle:function(){var html;
if(this.opts.visual){var height=this.$editor.innerHeight();this.$editor.hide();this.$content.hide();html=this.$editor.html();
this.$el.height(height).val(html).show().focus();this.setBtnActive("html");this.opts.visual=false}else{this.$el.hide();
var html=this.$el.val();this.$editor.html(html).show();this.$content.show();if(this.$editor.html()===""){this.setCode(this.opts.emptyHtml)
}this.$editor.focus();this.setBtnInactive("html");this.opts.visual=true;this.observeImages();this.observeTables()
}},autoSave:function(){this.autosaveInterval=setInterval($.proxy(function(){$.ajax({url:this.opts.autosave,type:"post",data:this.$el.attr("name")+"="+escape(encodeURIComponent(this.getCode())),success:$.proxy(function(data){if(typeof this.opts.autosaveCallback==="function"){this.opts.autosaveCallback(data,this)
}},this)})},this),this.opts.interval*1000)},buildToolbar:function(){if(this.opts.toolbar===false){return false
}this.$toolbar=$("<ul>").addClass("redactor_toolbar");if(this.opts.air){$(this.air).append(this.$toolbar);
$("body").append(this.air)}else{if(this.opts.toolbarExternal===false){this.$box.prepend(this.$toolbar)
}else{$(this.opts.toolbarExternal).html(this.$toolbar)}}$.each(this.opts.buttons,$.proxy(function(i,key){if(key!=="|"&&typeof this.opts.toolbar[key]!=="undefined"){var s=this.opts.toolbar[key];
if(this.opts.fileUpload===false&&key==="file"){return true}this.$toolbar.append($("<li>").append(this.buildButton(key,s)))
}if(key==="|"){this.$toolbar.append($('<li class="redactor_separator"></li>'))}},this))},buildButton:function(key,s){var button=$('<a href="javascript:void(null);" title="'+s.title+'" class="redactor_btn_'+key+'"></a>');
if(typeof s.func==="undefined"){button.click($.proxy(function(){if($.inArray(key,this.opts.activeButtons)!=-1){this.inactiveAllButtons();
this.setBtnActive(key)}if(this.browser("mozilla")){this.$editor.focus()}this.execCommand(s.exec,key)},this))
}else{if(s.func!=="show"){button.click($.proxy(function(e){this[s.func](e)},this))}}if(typeof s.callback!=="undefined"&&s.callback!==false){button.click($.proxy(function(e){s.callback(this,e,key)
},this))}if(key==="backcolor"||key==="fontcolor"||typeof(s.dropdown)!=="undefined"){var dropdown=$('<div class="redactor_dropdown" style="display: none;">');
if(key==="backcolor"||key==="fontcolor"){dropdown=this.buildColorPicker(dropdown,key)}else{dropdown=this.buildDropdown(dropdown,s.dropdown)
}this.dropdowns.push(dropdown.appendTo($(document.body)));this.hdlShowDropDown=$.proxy(function(e){this.showDropDown(e,dropdown,key)
},this);button.click(this.hdlShowDropDown)}return button},buildDropdown:function(dropdown,obj){$.each(obj,$.proxy(function(x,d){if(typeof(d.className)==="undefined"){d.className=""
}var drop_a;if(typeof d.name!=="undefined"&&d.name==="separator"){drop_a=$('<a class="redactor_separator_drop">')
}else{drop_a=$('<a href="javascript:void(null);" class="'+d.className+'">'+d.title+"</a>");if(typeof(d.callback)==="function"){$(drop_a).click($.proxy(function(e){d.callback(this,e,x)
},this))}else{if(typeof(d.func)==="undefined"){$(drop_a).click($.proxy(function(){this.execCommand(d.exec,x)
},this))}else{$(drop_a).click($.proxy(function(e){this[d.func](e)},this))}}}$(dropdown).append(drop_a)
},this));return dropdown},buildColorPicker:function(dropdown,key){var mode;if(key==="backcolor"){if(this.browser("msie")){mode="BackColor"
}else{mode="hilitecolor"}}else{mode="forecolor"}$(dropdown).width(210);var len=this.opts.colors.length;
for(var i=0;i<len;++i){var color=this.opts.colors[i];var swatch=$('<a rel="'+color+'" href="javascript:void(null);" class="redactor_color_link"></a>').css({"backgroundColor":color});
$(dropdown).append(swatch);var _self=this;$(swatch).click(function(){_self.execCommand(mode,$(this).attr("rel"));
if(mode==="forecolor"){_self.$editor.find("font").replaceWith(function(){return $('<span style="color: '+$(this).attr("color")+';">'+$(this).html()+"</span>")
})}if(_self.browser("msie")&&mode==="BackColor"){_self.$editor.find("font").replaceWith(function(){return $('<span style="'+$(this).attr("style")+'">'+$(this).html()+"</span>")
})}})}var elnone=$('<a href="javascript:void(null);" class="redactor_color_none"></a>').html(RLANG.none);
if(key==="backcolor"){elnone.click($.proxy(this.setBackgroundNone,this))}else{elnone.click($.proxy(this.setColorNone,this))
}$(dropdown).append(elnone);return dropdown},setBackgroundNone:function(){$(this.getParentNode()).css("background-color","transparent");
this.syncCode()},setColorNone:function(){$(this.getParentNode()).attr("color","").css("color","");this.syncCode()
},showDropDown:function(e,dropdown,key){if(this.getBtn(key).hasClass("dropact")){this.hideAllDropDown()
}else{this.hideAllDropDown();this.setBtnActive(key);this.getBtn(key).addClass("dropact");var left=this.getBtn(key).offset().left;
if(this.opts.air){var air_top=this.air.offset().top;$(dropdown).css({position:"absolute",left:left+"px",top:air_top+30+"px"}).show()
}else{if(this.opts.fixed&&this.fixed){$(dropdown).css({position:"fixed",left:left+"px",top:"30px"}).show()
}else{var top=this.$toolbar.offset().top+30;$(dropdown).css({position:"absolute",left:left+"px",top:top+"px"}).show()
}}}var hdlHideDropDown=$.proxy(function(e){this.hideDropDown(e,dropdown,key)},this);$(document).one("click",hdlHideDropDown);
this.$editor.one("click",hdlHideDropDown);this.$content.one("click",hdlHideDropDown);e.stopPropagation()
},hideAllDropDown:function(){this.$toolbar.find("a.dropact").removeClass("redactor_act").removeClass("dropact");
$(".redactor_dropdown").hide()},hideDropDown:function(e,dropdown,key){if(!$(e.target).hasClass("dropact")){$(dropdown).removeClass("dropact");
this.showedDropDown=false;this.hideAllDropDown()}},getBtn:function(key){if(this.opts.toolbar===false){return false
}return $(this.$toolbar.find("a.redactor_btn_"+key))},setBtnActive:function(key){this.getBtn(key).addClass("redactor_act")
},setBtnInactive:function(key){this.getBtn(key).removeClass("redactor_act")},inactiveAllButtons:function(){$.each(this.opts.activeButtons,$.proxy(function(i,s){this.setBtnInactive(s)
},this))},changeBtnIcon:function(key,classname){this.getBtn(key).addClass("redactor_btn_"+classname)},removeBtnIcon:function(key,classname){this.getBtn(key).removeClass("redactor_btn_"+classname)
},addBtnSeparator:function(){this.$toolbar.append($('<li class="redactor_separator"></li>'))},addBtnSeparatorAfter:function(key){var $btn=this.getBtn(key);
$btn.parent().after($('<li class="redactor_separator"></li>'))},addBtnSeparatorBefore:function(key){var $btn=this.getBtn(key);
$btn.parent().before($('<li class="redactor_separator"></li>'))},removeBtnSeparatorAfter:function(key){var $btn=this.getBtn(key);
$btn.parent().next().remove()},removeBtnSeparatorBefore:function(key){var $btn=this.getBtn(key);$btn.parent().prev().remove()
},setBtnRight:function(key){if(this.opts.toolbar===false){return false}this.getBtn(key).parent().addClass("redactor_btn_right")
},setBtnLeft:function(key){if(this.opts.toolbar===false){return false}this.getBtn(key).parent().removeClass("redactor_btn_right")
},addBtn:function(key,title,callback,dropdown){if(this.opts.toolbar===false){return false}var btn=this.buildButton(key,{title:title,callback:callback,dropdown:dropdown});
this.$toolbar.append($("<li>").append(btn))},addBtnFirst:function(key,title,callback,dropdown){if(this.opts.toolbar===false){return false
}var btn=this.buildButton(key,{title:title,callback:callback,dropdown:dropdown});this.$toolbar.prepend($("<li>").append(btn))
},addBtnAfter:function(afterkey,key,title,callback,dropdown){if(this.opts.toolbar===false){return false
}var btn=this.buildButton(key,{title:title,callback:callback,dropdown:dropdown});var $btn=this.getBtn(afterkey);
$btn.parent().after($("<li>").append(btn))},addBtnBefore:function(beforekey,key,title,callback,dropdown){if(this.opts.toolbar===false){return false
}var btn=this.buildButton(key,{title:title,callback:callback,dropdown:dropdown});var $btn=this.getBtn(beforekey);
$btn.parent().before($("<li>").append(btn))},removeBtn:function(key,separator){var $btn=this.getBtn(key);
if(separator===true){$btn.parent().next().remove()}$btn.parent().removeClass("redactor_btn_right");$btn.remove()
},getFragmentHtml:function(fragment){var cloned=fragment.cloneNode(true);var div=this.document.createElement("div");
div.appendChild(cloned);return div.innerHTML},extractContent:function(){var node=this.$editor.get(0);
var frag=this.document.createDocumentFragment(),child;while((child=node.firstChild)){frag.appendChild(child)
}return frag},saveSelection:function(){this.$editor.focus();this.savedSel=this.getOrigin();this.savedSelObj=this.getFocus()
},restoreSelection:function(){if(typeof this.savedSel!=="undefined"&&this.savedSel!==null&&this.savedSelObj!==null&&this.savedSel[0].tagName!=="BODY"){if(this.opts.iframe===false&&$(this.savedSel[0]).closest(".redactor_editor").size()==0){this.$editor.focus()
}else{if(this.browser("opera")){this.$editor.focus()}this.setSelection(this.savedSel[0],this.savedSel[1],this.savedSelObj[0],this.savedSelObj[1]);
if(this.browser("mozilla")){this.$editor.focus()}}}else{this.$editor.focus()}},getSelection:function(){var doc=this.document;
if(this.window.getSelection){return this.window.getSelection()}else{if(doc.getSelection){return doc.getSelection()
}else{return doc.selection.createRange()}}return false},hasSelection:function(){if(!this.oldIE()){var sel;
return(sel=this.getSelection())&&(sel.focusNode!=null)&&(sel.anchorNode!=null)}else{var node=this.$editor.get(0);
var range;node.focus();if(!node.document.selection){return false}range=node.document.selection.createRange();
return range&&range.parentElement().document===node.document}},getOrigin:function(){if(!this.oldIE()){var sel;
if(!((sel=this.getSelection())&&(sel.anchorNode!=null))){return null}return[sel.anchorNode,sel.anchorOffset]
}else{var node=this.$editor.get(0);var range;node.focus();if(!this.hasSelection()){return null}range=node.document.selection.createRange();
return this._getBoundary(node.document,range,true)}},getFocus:function(){if(!this.oldIE()){var sel;if(!((sel=this.getSelection())&&(sel.focusNode!=null))){return null
}return[sel.focusNode,sel.focusOffset]}else{var node=this.$editor.get(0);var range;node.focus();if(!this.hasSelection()){return null
}range=node.document.selection.createRange();return this._getBoundary(node.document,range,false)}},setSelection:function(orgn,orgo,focn,foco){if(focn==null){focn=orgn
}if(foco==null){foco=orgo}if(!this.oldIE()){var sel=this.getSelection();if(!sel){return}if(sel.collapse&&sel.extend){try{sel.collapse(orgn,orgo);
sel.extend(focn,foco)}catch(e){}}else{r=this.document.createRange();r.setStart(orgn,orgo);r.setEnd(focn,foco);
try{sel.removeAllRanges()}catch(e){}sel.addRange(r)}}else{var node=this.$editor.get(0);var range=node.document.body.createTextRange();
if(!range||!range.select){return}this._moveBoundary(node.document,range,false,focn,foco);this._moveBoundary(node.document,range,true,orgn,orgo);
if(!range||!range.select){return}try{return range.select()}catch(e){return}}},getCurrentNode:function(){if(typeof this.window.getSelection!=="undefined"){return this.getSelectedNode().parentNode
}else{if(typeof this.document.selection!=="undefined"){return this.getSelection().parentElement()}}},getParentNode:function(){return $(this.getCurrentNode()).parent()[0]
},getSelectedNode:function(){if(this.oldIE()){return this.getSelection().parentElement()}else{if(typeof this.window.getSelection!=="undefined"){var s=this.window.getSelection();
if(s.rangeCount>0){return this.getSelection().getRangeAt(0).commonAncestorContainer}else{return false
}}else{if(typeof this.document.selection!=="undefined"){return this.getSelection()}}}},_getBoundary:function(doc,textRange,bStart){var cursor,cursorNode,node,offset,parent;
cursorNode=doc.createElement("a");cursor=textRange.duplicate();cursor.collapse(bStart);parent=cursor.parentElement();
while(true){parent.insertBefore(cursorNode,cursorNode.previousSibling);cursor.moveToElementText(cursorNode);
if(!(cursor.compareEndPoints((bStart?"StartToStart":"StartToEnd"),textRange)>0&&(cursorNode.previousSibling!=null))){break
}}if(cursor.compareEndPoints((bStart?"StartToStart":"StartToEnd"),textRange)===-1&&cursorNode.nextSibling){cursor.setEndPoint((bStart?"EndToStart":"EndToEnd"),textRange);
node=cursorNode.nextSibling;offset=cursor.text.length}else{node=cursorNode.parentNode;offset=this._getChildIndex(cursorNode)
}cursorNode.parentNode.removeChild(cursorNode);return[node,offset]},_moveBoundary:function(doc,textRange,bStart,node,offset){var anchorNode,anchorParent,cursor,cursorNode,textOffset;
textOffset=0;anchorNode=this._isText(node)?node:node.childNodes[offset];anchorParent=this._isText(node)?node.parentNode:node;
if(this._isText(node)){textOffset=offset}cursorNode=doc.createElement("a");anchorParent.insertBefore(cursorNode,anchorNode||null);
cursor=doc.body.createTextRange();cursor.moveToElementText(cursorNode);cursorNode.parentNode.removeChild(cursorNode);
textRange.setEndPoint((bStart?"StartToStart":"EndToEnd"),cursor);return textRange[bStart?"moveStart":"moveEnd"]("character",textOffset)
},_isText:function(d){return(d!=null?d.nodeType==3:false)},_getChildIndex:function(e){var k=0;while(e=e.previousSibling){k++
}return k},insertNodeAfterCaret:function(node){this.saveSelection();this.insertNodeAtCaret(node);this.restoreSelection()
},insertNodeAtCaret:function(node){if(this.window.getSelection){var sel=this.getSelection();if(sel.rangeCount){var range=sel.getRangeAt(0);
range.collapse(false);range.insertNode(node);range=range.cloneRange();range.selectNodeContents(node);
range.collapse(false);sel.removeAllRanges();sel.addRange(range)}}else{if(this.document.selection){var html=(node.nodeType===1)?node.outerHTML:node.data;
var id="marker_"+(""+Math.random()).slice(2);html+='<span id="'+id+'"></span>';var textRange=this.getSelection();
textRange.collapse(false);textRange.pasteHTML(html);var markerSpan=this.document.getElementById(id);textRange.moveToElementText(markerSpan);
textRange.select();markerSpan.parentNode.removeChild(markerSpan)}}},getSelectedHtml:function(){var html="";
if(this.window.getSelection){var sel=this.window.getSelection();if(sel.rangeCount){var container=this.document.createElement("div");
for(var i=0,len=sel.rangeCount;i<len;++i){container.appendChild(sel.getRangeAt(i).cloneContents())}html=container.innerHTML
}}else{if(this.document.selection){if(this.document.selection.type==="Text"){html=this.document.selection.createRange().htmlText
}}}return html},resizeImage:function(resize){var clicked=false;var clicker=false;var start_x;var start_y;
var ratio=$(resize).width()/$(resize).height();var min_w=10;var min_h=10;$(resize).off("hover mousedown mouseup click mousemove");
$(resize).hover(function(){$(resize).css("cursor","nw-resize")},function(){$(resize).css("cursor","");
clicked=false});$(resize).mousedown(function(e){e.preventDefault();ratio=$(resize).width()/$(resize).height();
clicked=true;clicker=true;start_x=Math.round(e.pageX-$(resize).eq(0).offset().left);start_y=Math.round(e.pageY-$(resize).eq(0).offset().top)
});$(resize).mouseup($.proxy(function(e){clicked=false;$(resize).css("cursor","");this.syncCode()},this));
$(resize).click($.proxy(function(e){if(clicker){this.imageEdit(e)}},this));$(resize).mousemove(function(e){if(clicked){clicker=false;
var mouse_x=Math.round(e.pageX-$(this).eq(0).offset().left)-start_x;var mouse_y=Math.round(e.pageY-$(this).eq(0).offset().top)-start_y;
var div_h=$(resize).height();var new_h=parseInt(div_h,10)+mouse_y;var new_w=new_h*ratio;if(new_w>min_w){$(resize).width(new_w)
}if(new_h>min_h){$(resize).height(new_h)}start_x=Math.round(e.pageX-$(this).eq(0).offset().left);start_y=Math.round(e.pageY-$(this).eq(0).offset().top)
}})},showTable:function(){this.saveSelection();this.modalInit(RLANG.table,this.opts.modal_table,300,$.proxy(function(){$("#redactor_insert_table_btn").click($.proxy(this.insertTable,this));
setTimeout(function(){$("#redactor_table_rows").focus()},200)},this))},insertTable:function(){var rows=$("#redactor_table_rows").val();
var columns=$("#redactor_table_columns").val();var table_box=$("<div></div>");var tableid=Math.floor(Math.random()*99999);
var table=$('<table id="table'+tableid+'"><tbody></tbody></table>');for(var i=0;i<rows;i++){var row=$("<tr></tr>");
for(var z=0;z<columns;z++){var column=$("<td><br></td>");$(row).append(column)}$(table).append(row)}$(table_box).append(table);
var html=$(table_box).html()+"<p></p>";this.restoreSelection();this.execCommand("inserthtml",html);this.modalClose();
this.observeTables()},tableObserver:function(e){this.$table=$(e.target).closest("table");this.$table_tr=this.$table.find("tr");
this.$table_td=this.$table.find("td");this.$tbody=$(e.target).closest("tbody");this.$thead=$(this.$table).find("thead");
this.$current_td=$(e.target);this.$current_tr=$(e.target).closest("tr")},deleteTable:function(){$(this.$table).remove();
this.$table=false;this.syncCode()},deleteRow:function(){$(this.$current_tr).remove();this.syncCode()},deleteColumn:function(){var index=$(this.$current_td).get(0).cellIndex;
$(this.$table).find("tr").each(function(){$(this).find("td").eq(index).remove()});this.syncCode()},addHead:function(){if($(this.$table).find("thead").size()!==0){this.deleteHead()
}else{var tr=$(this.$table).find("tr").first().clone();tr.find("td").html("&nbsp;");this.$thead=$("<thead></thead>");
this.$thead.append(tr);$(this.$table).prepend(this.$thead);this.syncCode()}},deleteHead:function(){$(this.$thead).remove();
this.$thead=false;this.syncCode()},insertRowAbove:function(){this.insertRow("before")},insertRowBelow:function(){this.insertRow("after")
},insertColumnLeft:function(){this.insertColumn("before")},insertColumnRight:function(){this.insertColumn("after")
},insertRow:function(type){var new_tr=$(this.$current_tr).clone();new_tr.find("td").html("&nbsp;");if(type==="after"){$(this.$current_tr).after(new_tr)
}else{$(this.$current_tr).before(new_tr)}this.syncCode()},insertColumn:function(type){var index=0;this.$current_tr.find("td").each($.proxy(function(i,s){if($(s)[0]===this.$current_td[0]){index=i
}},this));this.$table_tr.each(function(i,s){var current=$(s).find("td").eq(index);var td=current.clone();
td.html("&nbsp;");if(type==="after"){$(current).after(td)}else{$(current).before(td)}});this.syncCode()
},showVideo:function(){this.saveSelection();this.modalInit(RLANG.video,this.opts.modal_video,600,$.proxy(function(){$("#redactor_insert_video_btn").click($.proxy(this.insertVideo,this));
setTimeout(function(){$("#redactor_insert_video_area").focus()},200)},this))},insertVideo:function(){var data=$("#redactor_insert_video_area").val();
data=this.stripTags(data);this.restoreSelection();this.execCommand("inserthtml",data);this.modalClose()
},imageEdit:function(e){var $el=$(e.target);var parent=$el.parent();var callback=$.proxy(function(){$("#redactor_file_alt").val($el.attr("alt"));
$("#redactor_image_edit_src").attr("href",$el.attr("src"));$("#redactor_form_image_align").val($el.css("float"));
if($(parent).get(0).tagName==="A"){$("#redactor_file_link").val($(parent).attr("href"))}$("#redactor_image_delete_btn").click($.proxy(function(){this.imageDelete($el)
},this));$("#redactorSaveBtn").click($.proxy(function(){this.imageSave($el)},this))},this);this.modalInit(RLANG.image,this.opts.modal_image_edit,380,callback)
},imageDelete:function(el){var parent=$(el).parent();if(parent.size()!=0&&parent[0].tagName=="A"){parent.remove()
}else{$(el).remove()}this.modalClose();this.syncCode()},imageSave:function(el){var parent=$(el).parent();
$(el).attr("alt",$("#redactor_file_alt").val());var floating=$("#redactor_form_image_align").val();if(floating==="left"){$(el).css({"float":"left",margin:"0 10px 10px 0"})
}else{if(floating==="right"){$(el).css({"float":"right",margin:"0 0 10px 10px"})}else{$(el).css({"float":"none",margin:"0"})
}}var link=$.trim($("#redactor_file_link").val());if(link!==""){if($(parent).get(0).tagName!=="A"){$(el).replaceWith('<a href="'+link+'">'+this.outerHTML(el)+"</a>")
}else{$(parent).attr("href",link)}}else{if($(parent).get(0).tagName==="A"){$(parent).replaceWith(this.outerHTML(el))
}}this.modalClose();this.observeImages();this.syncCode()},showImage:function(){this.saveSelection();var callback=$.proxy(function(){if(this.opts.imageGetJson!==false){$.getJSON(this.opts.imageGetJson,$.proxy(function(data){var folders={};
var z=0;$.each(data,$.proxy(function(key,val){if(typeof val.folder!=="undefined"){z++;folders[val.folder]=z
}},this));var folderclass=false;$.each(data,$.proxy(function(key,val){var thumbtitle="";if(typeof val.title!=="undefined"){thumbtitle=val.title
}var folderkey=0;if(!$.isEmptyObject(folders)&&typeof val.folder!=="undefined"){folderkey=folders[val.folder];
if(folderclass===false){folderclass=".redactorfolder"+folderkey}}var img=$('<img src="'+val.thumb+'" class="redactorfolder redactorfolder'+folderkey+'" rel="'+val.image+'" title="'+thumbtitle+'" />');
$("#redactor_image_box").append(img);$(img).click($.proxy(this.imageSetThumb,this))},this));if(!$.isEmptyObject(folders)){$(".redactorfolder").hide();
$(folderclass).show();var onchangeFunc=function(e){$(".redactorfolder").hide();$(".redactorfolder"+$(e.target).val()).show()
};var select=$('<select id="redactor_image_box_select">');$.each(folders,function(k,v){select.append($('<option value="'+v+'">'+k+"</option>"))
});$("#redactor_image_box").before(select);select.change(onchangeFunc)}},this))}else{$("#redactor_tabs a").eq(1).remove()
}if(this.opts.imageUpload!==false){if(this.opts.uploadCrossDomain===false&&this.isMobile()===false){if($("#redactor_file").size()!==0){$("#redactor_file").dragupload({url:this.opts.imageUpload,uploadFields:this.opts.uploadFields,success:$.proxy(this.imageUploadCallback,this),error:$.proxy(this.opts.imageUploadErrorCallback,this)})
}}this.uploadInit("redactor_file",{auto:true,url:this.opts.imageUpload,success:$.proxy(this.imageUploadCallback,this),error:$.proxy(this.opts.imageUploadErrorCallback,this)})
}else{$(".redactor_tab").hide();if(this.opts.imageGetJson===false){$("#redactor_tabs").remove();$("#redactor_tab3").show()
}else{var tabs=$("#redactor_tabs a");tabs.eq(0).remove();tabs.eq(1).addClass("redactor_tabs_act");$("#redactor_tab2").show()
}}$("#redactor_upload_btn").click($.proxy(this.imageUploadCallbackLink,this));if(this.opts.imageUpload===false&&this.opts.imageGetJson===false){setTimeout(function(){$("#redactor_file_link").focus()
},200)}},this);this.modalInit(RLANG.image,this.opts.modal_image,610,callback)},imageSetThumb:function(e){this._imageSet('<img src="'+$(e.target).attr("rel")+'" alt="'+$(e.target).attr("title")+'" />',true)
},imageUploadCallbackLink:function(){if($("#redactor_file_link").val()!==""){var data='<img src="'+$("#redactor_file_link").val()+'" />';
this._imageSet(data,true)}else{this.modalClose()}},imageUploadCallback:function(data){this._imageSet(data)
},_imageSet:function(json,link){this.restoreSelection();if(json!==false){var html="";if(link!==true){html='<p><img src="'+json.filelink+'" /></p>'
}else{html=json}this.execCommand("inserthtml",html);if(link!==true&&typeof this.opts.imageUploadCallback==="function"){this.opts.imageUploadCallback(this,json)
}}this.modalClose();this.observeImages()},showLink:function(){this.saveSelection();var callback=$.proxy(function(){this.insert_link_node=false;
var sel=this.getSelection();var url="",text="",target="";if(this.browser("msie")){var parent=this.getParentNode();
if(parent.nodeName==="A"){this.insert_link_node=$(parent);text=this.insert_link_node.text();url=this.insert_link_node.attr("href");
target=this.insert_link_node.attr("target")}else{if(this.oldIE()){text=sel.text}else{text=sel.toString()
}}}else{if(sel&&sel.anchorNode&&sel.anchorNode.parentNode.tagName==="A"){url=sel.anchorNode.parentNode.href;
text=sel.anchorNode.parentNode.text;target=sel.anchorNode.parentNode.target;if(sel.toString()===""){this.insert_link_node=sel.anchorNode.parentNode
}}else{text=sel.toString()}}$(".redactor_link_text").val(text);var thref=self.location.href.replace(/\/$/i,"");
var turl=url.replace(thref,"");if(url.search("mailto:")===0){this.setModalTab(2);$("#redactor_tab_selected").val(2);
$("#redactor_link_mailto").val(url.replace("mailto:",""))}else{if(turl.search(/^#/gi)===0){this.setModalTab(3);
$("#redactor_tab_selected").val(3);$("#redactor_link_anchor").val(turl.replace(/^#/gi,""))}else{$("#redactor_link_url").val(turl)
}}if(target==="_blank"){$("#redactor_link_blank").attr("checked",true)}$("#redactor_insert_link_btn").click($.proxy(this.insertLink,this));
setTimeout(function(){$("#redactor_link_url").focus()},200)},this);this.modalInit(RLANG.link,this.opts.modal_link,460,callback)
},insertLink:function(){var tab_selected=$("#redactor_tab_selected").val();var link="",text="",targettext="",target="";
if(tab_selected==="1"){link=$("#redactor_link_url").val();text=$("#redactor_link_url_text").val();if($("#redactor_link_blank").prop("checked")){targettext=' target="_blank"';
target="_blank"}var pattern="/(w+:{0,1}w*@)?(S+)(:[0-9]+)?(/|/([w#!:.?+=&%@!-/]))?/";var re=new RegExp("^(http|ftp|https)://"+pattern,"i");
var re2=new RegExp("^"+pattern,"i");if(link.search(re)==-1&&link.search(re2)==0&&this.opts.protocol!==false){link=this.opts.protocol+link
}}else{if(tab_selected==="2"){link="mailto:"+$("#redactor_link_mailto").val();text=$("#redactor_link_mailto_text").val()
}else{if(tab_selected==="3"){link="#"+$("#redactor_link_anchor").val();text=$("#redactor_link_anchor_text").val()
}}}this._insertLink('<a href="'+link+'"'+targettext+">"+text+"</a>",$.trim(text),link,target)},_insertLink:function(a,text,link,target){this.$editor.focus();
this.restoreSelection();if(text!==""){if(this.insert_link_node){$(this.insert_link_node).text(text);$(this.insert_link_node).attr("href",link);
if(target!==""){$(this.insert_link_node).attr("target",target)}else{$(this.insert_link_node).removeAttr("target")
}this.syncCode()}else{this.execCommand("inserthtml",a)}}this.modalClose()},showFile:function(){this.saveSelection();
var callback=$.proxy(function(){var sel=this.getSelection();var text="";if(this.oldIE()){text=sel.text
}else{text=sel.toString()}$("#redactor_filename").val(text);if(this.opts.uploadCrossDomain===false&&this.isMobile()===false){$("#redactor_file").dragupload({url:this.opts.fileUpload,uploadFields:this.opts.uploadFields,success:$.proxy(this.fileUploadCallback,this),error:$.proxy(this.opts.fileUploadErrorCallback,this)})
}this.uploadInit("redactor_file",{auto:true,url:this.opts.fileUpload,success:$.proxy(this.fileUploadCallback,this),error:$.proxy(this.opts.fileUploadErrorCallback,this)})
},this);this.modalInit(RLANG.file,this.opts.modal_file,500,callback)},fileUploadCallback:function(json){this.restoreSelection();
if(json!==false){var text=$("#redactor_filename").val();if(text===""){text=json.filename}var link='<a href="'+json.filelink+'">'+text+"</a>";
if(this.browser("webkit")&&!!this.window.chrome){link=link+"&nbsp;"}this.execCommand("inserthtml",link);
if(typeof this.opts.fileUploadCallback==="function"){this.opts.fileUploadCallback(this,json)}}this.modalClose()
},modalInit:function(title,content,width,callback){if($("#redactor_modal_overlay").size()===0){this.overlay=$('<div id="redactor_modal_overlay" style="display: none;"></div>');
$("body").prepend(this.overlay)}if(this.opts.overlay){$("#redactor_modal_overlay").show();$("#redactor_modal_overlay").click($.proxy(this.modalClose,this))
}if($("#redactor_modal").size()===0){this.modal=$('<div id="redactor_modal" style="display: none;"><div id="redactor_modal_close">&times;</div><div id="redactor_modal_header"></div><div id="redactor_modal_inner"></div></div>');
$("body").append(this.modal)}$("#redactor_modal_close").click($.proxy(this.modalClose,this));this.hdlModalClose=$.proxy(function(e){if(e.keyCode===27){this.modalClose();
return false}},this);$(document).keyup(this.hdlModalClose);this.$editor.keyup(this.hdlModalClose);if(content.indexOf("#")==0){$("#redactor_modal_inner").empty().append($(content).html())
}else{$("#redactor_modal_inner").empty().append(content)}$("#redactor_modal_header").html(title);if(typeof $.fn.draggable!=="undefined"){$("#redactor_modal").draggable({handle:"#redactor_modal_header"});
$("#redactor_modal_header").css("cursor","move")}if($("#redactor_tabs").size()!==0){var that=this;$("#redactor_tabs a").each(function(i,s){i++;
$(s).click(function(){$("#redactor_tabs a").removeClass("redactor_tabs_act");$(this).addClass("redactor_tabs_act");
$(".redactor_tab").hide();$("#redactor_tab"+i).show();$("#redactor_tab_selected").val(i);if(that.isMobile()===false){var height=$("#redactor_modal").outerHeight();
$("#redactor_modal").css("margin-top","-"+(height+10)/2+"px")}})})}$("#redactor_modal .redactor_btn_modal_close").click($.proxy(this.modalClose,this));
if(this.isMobile()===false){$("#redactor_modal").css({position:"fixed",top:"-2000px",left:"50%",width:width+"px",marginLeft:"-"+(width+60)/2+"px"}).show();
this.modalSaveBodyOveflow=$(document.body).css("overflow");$(document.body).css("overflow","hidden")}else{$("#redactor_modal").css({position:"fixed",width:"100%",height:"100%",top:"0",left:"0",margin:"0",minHeight:"300px"}).show()
}if(typeof callback==="function"){callback()}if(this.isMobile()===false){setTimeout(function(){var height=$("#redactor_modal").outerHeight();
$("#redactor_modal").css({top:"50%",height:"auto",minHeight:"auto",marginTop:"-"+(height+10)/2+"px"})
},20)}},modalClose:function(){$("#redactor_modal_close").unbind("click",this.modalClose);$("#redactor_modal").fadeOut("fast",$.proxy(function(){$("#redactor_modal_inner").html("");
if(this.opts.overlay){$("#redactor_modal_overlay").hide();$("#redactor_modal_overlay").unbind("click",this.modalClose)
}$(document).unbind("keyup",this.hdlModalClose);this.$editor.unbind("keyup",this.hdlModalClose)},this));
if(this.isMobile()===false){$(document.body).css("overflow",this.modalSaveBodyOveflow?this.modalSaveBodyOveflow:"visible")
}return false},setModalTab:function(num){$(".redactor_tab").hide();var tabs=$("#redactor_tabs a");tabs.removeClass("redactor_tabs_act");
tabs.eq(num-1).addClass("redactor_tabs_act");$("#redactor_tab"+num).show()},uploadInit:function(element,options){this.uploadOptions={url:false,success:false,error:false,start:false,trigger:false,auto:false,input:false};
$.extend(this.uploadOptions,options);if($("#"+element).size()!==0&&$("#"+element).get(0).tagName==="INPUT"){this.uploadOptions.input=$("#"+element);
this.element=$($("#"+element).get(0).form)}else{this.element=$("#"+element)}this.element_action=this.element.attr("action");
if(this.uploadOptions.auto){$(this.uploadOptions.input).change($.proxy(function(){this.element.submit(function(e){return false
});this.uploadSubmit()},this))}else{if(this.uploadOptions.trigger){$("#"+this.uploadOptions.trigger).click($.proxy(this.uploadSubmit,this))
}}},uploadSubmit:function(){this.uploadForm(this.element,this.uploadFrame())},uploadFrame:function(){this.id="f"+Math.floor(Math.random()*99999);
var d=this.document.createElement("div");var iframe='<iframe style="display:none" id="'+this.id+'" name="'+this.id+'"></iframe>';
d.innerHTML=iframe;$(d).appendTo("body");if(this.uploadOptions.start){this.uploadOptions.start()}$("#"+this.id).load($.proxy(this.uploadLoaded,this));
return this.id},uploadForm:function(f,name){if(this.uploadOptions.input){var formId="redactorUploadForm"+this.id;
var fileId="redactorUploadFile"+this.id;this.form=$('<form  action="'+this.uploadOptions.url+'" method="POST" target="'+name+'" name="'+formId+'" id="'+formId+'" enctype="multipart/form-data"></form>');
if(this.opts.uploadFields!==false&&typeof this.opts.uploadFields==="object"){$.each(this.opts.uploadFields,$.proxy(function(k,v){if(v.toString().indexOf("#")===0){v=$(v).val()
}var hidden=$("<input/>",{"type":"hidden","name":k,"value":v});$(this.form).append(hidden)},this))}var oldElement=this.uploadOptions.input;
var newElement=$(oldElement).clone();$(oldElement).attr("id",fileId);$(oldElement).before(newElement);
$(oldElement).appendTo(this.form);$(this.form).css("position","absolute");$(this.form).css("top","-2000px");
$(this.form).css("left","-2000px");$(this.form).appendTo("body");this.form.submit()}else{f.attr("target",name);
f.attr("method","POST");f.attr("enctype","multipart/form-data");f.attr("action",this.uploadOptions.url);
this.element.submit()}},uploadLoaded:function(){var i=$("#"+this.id)[0];var d;if(i.contentDocument){d=i.contentDocument
}else{if(i.contentWindow){d=i.contentWindow.document}else{d=window.frames[this.id].document}}if(this.uploadOptions.success){if(typeof d!=="undefined"&&d.body&&d.body.innerHTML){var rawString=d.body.innerHTML;
var jsonString=rawString.match(/\{(.|\n)*\}/)[0];var json=$.parseJSON(jsonString);if(typeof json.error=="undefined"){this.uploadOptions.success(json)
}else{this.uploadOptions.error(this,json);this.modalClose()}}else{alert("Upload failed!");this.modalClose()
}}this.element.attr("action",this.element_action);this.element.attr("target","")},browser:function(browser){var ua=navigator.userAgent.toLowerCase();
var match=/(chrome)[ \/]([\w.]+)/.exec(ua)||/(webkit)[ \/]([\w.]+)/.exec(ua)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(ua)||/(msie) ([\w.]+)/.exec(ua)||ua.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(ua)||[];
if(browser=="version"){return match[2]}if(browser=="webkit"){return(match[1]=="chrome"||match[1]=="webkit")
}return match[1]==browser},oldIE:function(){if(this.browser("msie")&&parseInt(this.browser("version"),10)<9){return true
}return false},outerHTML:function(s){return $("<p>").append($(s).eq(0).clone()).html()},normalize:function(str){return parseInt(str.replace("px",""),10)
},isMobile:function(ipad){if(ipad===true&&/(iPhone|iPod|iPad|BlackBerry|Android)/.test(navigator.userAgent)){return true
}else{if(/(iPhone|iPod|BlackBerry|Android)/.test(navigator.userAgent)){return true}else{return false}}}};
$.fn.getObject=function(){return this.data("redactor")};$.fn.getEditor=function(){return this.data("redactor").$editor
};$.fn.getCode=function(){return $.trim(this.data("redactor").getCode())};$.fn.getText=function(){return this.data("redactor").$editor.text()
};$.fn.getSelected=function(){return this.data("redactor").getSelectedHtml()};$.fn.setCode=function(html){this.data("redactor").setCode(html)
};$.fn.insertHtml=function(html){this.data("redactor").insertHtml(html)};$.fn.destroyEditor=function(){this.each(function(){if(typeof $(this).data("redactor")!="undefined"){$(this).data("redactor").destroy();
$(this).removeData("redactor")}})};$.fn.setFocus=function(){this.data("redactor").$editor.focus()};$.fn.execCommand=function(cmd,param){this.data("redactor").execCommand(cmd,param)
}})(jQuery);(function($){$.fn.dragupload=function(options){return this.each(function(){var obj=new Construct(this,options);
obj.init()})};function Construct(el,options){this.opts=$.extend({url:false,success:false,error:false,preview:false,uploadFields:false,text:RLANG.drop_file_here,atext:RLANG.or_choose},options);
this.$el=$(el)}Construct.prototype={init:function(){if(navigator.userAgent.search("MSIE")===-1){this.droparea=$('<div class="redactor_droparea"></div>');
this.dropareabox=$('<div class="redactor_dropareabox">'+this.opts.text+"</div>");this.dropalternative=$('<div class="redactor_dropalternative">'+this.opts.atext+"</div>");
this.droparea.append(this.dropareabox);this.$el.before(this.droparea);this.$el.before(this.dropalternative);
this.dropareabox.bind("dragover",$.proxy(function(){return this.ondrag()},this));this.dropareabox.bind("dragleave",$.proxy(function(){return this.ondragleave()
},this));var uploadProgress=$.proxy(function(e){var percent=parseInt(e.loaded/e.total*100,10);this.dropareabox.text("Loading "+percent+"%")
},this);var xhr=jQuery.ajaxSettings.xhr();if(xhr.upload){xhr.upload.addEventListener("progress",uploadProgress,false)
}var provider=function(){return xhr};this.dropareabox.get(0).ondrop=$.proxy(function(event){event.preventDefault();
this.dropareabox.removeClass("hover").addClass("drop");var file=event.dataTransfer.files[0];var fd=new FormData();
if(this.opts.uploadFields!==false&&typeof this.opts.uploadFields==="object"){$.each(this.opts.uploadFields,$.proxy(function(k,v){if(v.toString().indexOf("#")===0){v=$(v).val()
}fd.append(k,v)},this))}fd.append("file",file);$.ajax({url:this.opts.url,dataType:"html",data:fd,xhr:provider,cache:false,contentType:false,processData:false,type:"POST",success:$.proxy(function(data){var json=$.parseJSON(data);
if(typeof json.error=="undefined"){this.opts.success(json)}else{this.opts.error(this,json);this.opts.success(false)
}},this)})},this)}},ondrag:function(){this.dropareabox.addClass("hover");return false},ondragleave:function(){this.dropareabox.removeClass("hover");
return false}}})(jQuery);(function($){var protocol="http://";var url1=/(^|&lt;|\s)(www\..+?\..+?)(\s|&gt;|$)/g,url2=/(^|&lt;|\s)(((https?|ftp):\/\/|mailto:).+?)(\s|&gt;|$)/g,linkifyThis=function(){var childNodes=this.childNodes,i=childNodes.length;
while(i--){var n=childNodes[i];if(n.nodeType===3){var html=n.nodeValue,newHtml;if(html){newHtml=html.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(url1,'$1<a href="'+protocol+'$2">$2</a>$3').replace(url2,'$1<a href="$2">$2</a>$5');
if(newHtml!=html&&newHtml!=html.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")){$(n).after(newHtml).remove()
}}}else{if(n.nodeType===1&&!/^(a|button|textarea)$/i.test(n.tagName)){linkifyThis.call(n)}}}};$.fn.linkify=function(){this.each(linkifyThis)
}})(jQuery);(function($){$.event.special.textselect={setup:function(data,namespaces){$(this).data("textselected",false);
$(this).data("ttt",data);$(this).on("mouseup",$.event.special.textselect.handler)},teardown:function(data){$(this).off("mouseup",$.event.special.textselect.handler)
},handler:function(event){var data=$(this).data("ttt");var text=$.event.special.textselect.getSelectedText(data).toString();
if(text!=""){$(this).data("textselected",true);event.type="textselect";event.text=text;$.event.dispatch.apply(this,arguments)
}},getSelectedText:function(data){var text="";if(rwindow.getSelection){text=rwindow.getSelection()}else{if(rdocument.getSelection){text=rdocument.getSelection()
}else{if(rdocument.selection){text=rdocument.selection.createRange().text}}}return text}};$.event.special.textunselect={setup:function(data,namespaces){$(this).data("rttt",data);
$(this).data("textselected",false);$(this).on("mouseup",$.event.special.textunselect.handler);$(this).on("keyup",$.event.special.textunselect.handlerKey)
},teardown:function(data){$(this).unbind("mouseup",$.event.special.textunselect.handler)},handler:function(event){if($(this).data("textselected")){var data=$(this).data("rttt");
var text=$.event.special.textselect.getSelectedText(data).toString();if(text==""){$(this).data("textselected",false);
event.type="textunselect";$.event.dispatch.apply(this,arguments)}}},handlerKey:function(event){if($(this).data("textselected")){var data=$(this).data("rttt");
var text=$.event.special.textselect.getSelectedText(data).toString();if((event.keyCode=27)&&(text=="")){$(this).data("textselected",false);
event.type="textunselect";$.event.dispatch.apply(this,arguments)}}}}})(jQuery);(function(b,ib){var t="none",M="LoadedContent",c=false,v="resize.",o="y",q="auto",e=true,L="nofollow",m="x";
function f(a,c){a=a?' id="'+i+a+'"':"";c=c?' style="'+c+'"':"";return b("<div"+a+c+"/>")}function p(a,b){b=b===m?n.width():n.height();
return typeof a==="string"?Math.round(/%/.test(a)?b/100*parseInt(a,10):parseInt(a,10)):a}function U(b){return a.photo||/\.(gif|png|jpg|jpeg|bmp)(?:\?([^#]*))?(?:#(\.*))?$/i.test(b)
}function cb(a){for(var c in a){if(b.isFunction(a[c])&&c.substring(0,2)!=="on"){a[c]=a[c].call(l)}}a.rel=a.rel||l.rel||L;
a.href=a.href||b(l).attr("href");a.title=a.title||l.title;return a}function w(c,a){a&&a.call(l);b.event.trigger(c)
}function jb(){var b,e=i+"Slideshow_",c="click."+i,f,k;if(a.slideshow&&h[1]){f=function(){F.text(a.slideshowStop).unbind(c).bind(V,function(){if(g<h.length-1||a.loop){b=setTimeout(d.next,a.slideshowSpeed)
}}).bind(W,function(){clearTimeout(b)}).one(c+" "+N,k);j.removeClass(e+"off").addClass(e+"on");b=setTimeout(d.next,a.slideshowSpeed)
};k=function(){clearTimeout(b);F.text(a.slideshowStart).unbind([V,W,N,c].join(" ")).one(c,f);j.removeClass(e+"on").addClass(e+"off")
};a.slideshowAuto?f():k()}}function db(c){if(!O){l=c;a=cb(b.extend({},b.data(l,r)));h=b(l);g=0;if(a.rel!==L){h=b("."+G).filter(function(){return(b.data(this,r).rel||this.rel)===a.rel
});g=h.index(l);if(g===-1){h=h.add(l);g=h.length-1}}if(!u){u=D=e;j.show();if(a.returnFocus){try{l.blur();
b(l).one(eb,function(){try{this.focus()}catch(a){}})}catch(f){}}x.css({opacity:+a.opacity,cursor:a.overlayClose?"pointer":q}).show();
a.w=p(a.initialWidth,m);a.h=p(a.initialHeight,o);d.position(0);X&&n.bind(v+P+" scroll."+P,function(){x.css({width:n.width(),height:n.height(),top:n.scrollTop(),left:n.scrollLeft()})
}).trigger("scroll."+P);w(fb,a.onOpen);Y.add(H).add(I).add(F).add(Z).hide();ab.html(a.close).show()}d.load(e)
}}var gb={transition:"elastic",speed:300,width:c,initialWidth:"600",innerWidth:c,maxWidth:c,height:c,initialHeight:"450",innerHeight:c,maxHeight:c,scalePhotos:e,scrolling:e,inline:c,html:c,iframe:c,photo:c,href:c,title:c,rel:c,opacity:0.9,preloading:e,current:"image {current} of {total}",previous:"previous",next:"next",close:"close",open:c,returnFocus:e,loop:e,slideshow:c,slideshowAuto:e,slideshowSpeed:2500,slideshowStart:"start slideshow",slideshowStop:"stop slideshow",onOpen:c,onLoad:c,onComplete:c,onCleanup:c,onClosed:c,overlayClose:e,escKey:e,arrowKey:e},r="colorbox",i="cbox",fb=i+"_open",W=i+"_load",V=i+"_complete",N=i+"_cleanup",eb=i+"_closed",Q=i+"_purge",hb=i+"_loaded",E=b.browser.msie&&!b.support.opacity,X=E&&b.browser.version<7,P=i+"_IE6",x,j,A,s,bb,T,R,S,h,n,k,J,K,Z,Y,F,I,H,ab,B,C,y,z,l,g,a,u,D,O=c,d,G=i+"Element";
d=b.fn[r]=b[r]=function(c,f){var a=this,d;if(!a[0]&&a.selector){return a}c=c||{};if(f){c.onComplete=f
}if(!a[0]||a.selector===undefined){a=b("<a/>");c.open=e}a.each(function(){b.data(this,r,b.extend({},b.data(this,r)||gb,c));
b(this).addClass(G)});d=c.open;if(b.isFunction(d)){d=d.call(a)}d&&db(a[0]);return a};d.init=function(){var l="hover",m="clear:left";
n=b(ib);j=f().attr({id:r,"class":E?i+"IE":""});x=f("Overlay",X?"position:absolute":"").hide();A=f("Wrapper");
s=f("Content").append(k=f(M,"width:0; height:0; overflow:hidden"),K=f("LoadingOverlay").add(f("LoadingGraphic")),Z=f("Title"),Y=f("Current"),I=f("Next"),H=f("Previous"),F=f("Slideshow").bind(fb,jb),ab=f("Close"));
A.append(f().append(f("TopLeft"),bb=f("TopCenter"),f("TopRight")),f(c,m).append(T=f("MiddleLeft"),s,R=f("MiddleRight")),f(c,m).append(f("BottomLeft"),S=f("BottomCenter"),f("BottomRight"))).children().children().css({"float":"left"});
J=f(c,"position:absolute; width:9999px; visibility:hidden; display:none");b("body").prepend(x,j.append(A,J));
s.children().hover(function(){b(this).addClass(l)},function(){b(this).removeClass(l)}).addClass(l);B=bb.height()+S.height()+s.outerHeight(e)-s.height();
C=T.width()+R.width()+s.outerWidth(e)-s.width();y=k.outerHeight(e);z=k.outerWidth(e);j.css({"padding-bottom":B,"padding-right":C}).hide();
I.click(d.next);H.click(d.prev);ab.click(d.close);s.children().removeClass(l);b("."+G).live("click",function(a){if(!(a.button!==0&&typeof a.button!=="undefined"||a.ctrlKey||a.shiftKey||a.altKey)){a.preventDefault();
db(this)}});x.click(function(){a.overlayClose&&d.close()});b(document).bind("keydown",function(b){if(u&&a.escKey&&b.keyCode===27){b.preventDefault();
d.close()}if(u&&a.arrowKey&&!D&&h[1]){if(b.keyCode===37&&(g||a.loop)){b.preventDefault();H.click()}else{if(b.keyCode===39&&(g<h.length-1||a.loop)){b.preventDefault();
I.click()}}}})};d.remove=function(){j.add(x).remove();b("."+G).die("click").removeData(r).removeClass(G)
};d.position=function(f,d){function b(a){bb[0].style.width=S[0].style.width=s[0].style.width=a.style.width;
K[0].style.height=K[1].style.height=s[0].style.height=T[0].style.height=R[0].style.height=a.style.height
}var e,h=Math.max(document.documentElement.clientHeight-a.h-y-B,0)/2+n.scrollTop(),g=Math.max(n.width()-a.w-z-C,0)/2+n.scrollLeft();
e=j.width()===a.w+z&&j.height()===a.h+y?0:f;A[0].style.width=A[0].style.height="9999px";j.dequeue().animate({width:a.w+z,height:a.h+y,top:h,left:g},{duration:e,complete:function(){b(this);
D=c;A[0].style.width=a.w+z+C+"px";A[0].style.height=a.h+y+B+"px";d&&d()},step:function(){b(this)}})};
d.resize=function(b){if(u){b=b||{};if(b.width){a.w=p(b.width,m)-z-C}if(b.innerWidth){a.w=p(b.innerWidth,m)
}k.css({width:a.w});if(b.height){a.h=p(b.height,o)-y-B}if(b.innerHeight){a.h=p(b.innerHeight,o)}if(!b.innerHeight&&!b.height){b=k.wrapInner("<div style='overflow:auto'></div>").children();
a.h=b.height();b.replaceWith(b.children())}k.css({height:a.h});d.position(a.transition===t?0:a.speed)
}};d.prep=function(m){var c="hidden";function l(s){var p,f,m,c,l=h.length,q=a.loop;d.position(s,function(){function s(){E&&j[0].style.removeAttribute("filter")
}if(u){E&&o&&k.fadeIn(100);k.show();w(hb);Z.show().html(a.title);if(l>1){typeof a.current==="string"&&Y.html(a.current.replace(/\{current\}/,g+1).replace(/\{total\}/,l)).show();
I[q||g<l-1?"show":"hide"]().html(a.next);H[q||g?"show":"hide"]().html(a.previous);p=g?h[g-1]:h[l-1];m=g<l-1?h[g+1]:h[0];
a.slideshow&&F.show();if(a.preloading){c=b.data(m,r).href||m.href;f=b.data(p,r).href||p.href;c=b.isFunction(c)?c.call(m):c;
f=b.isFunction(f)?f.call(p):f;if(U(c)){b("<img/>")[0].src=c}if(U(f)){b("<img/>")[0].src=f}}}K.hide();
a.transition==="fade"?j.fadeTo(e,1,function(){s()}):s();n.bind(v+i,function(){d.position(0)});w(V,a.onComplete)
}})}if(u){var o,e=a.transition===t?0:a.speed;n.unbind(v+i);k.remove();k=f(M).html(m);k.hide().appendTo(J.show()).css({width:function(){a.w=a.w||k.width();
a.w=a.mw&&a.mw<a.w?a.mw:a.w;return a.w}(),overflow:a.scrolling?q:c}).css({height:function(){a.h=a.h||k.height();
a.h=a.mh&&a.mh<a.h?a.mh:a.h;return a.h}()}).prependTo(s);J.hide();b("#"+i+"Photo").css({cssFloat:t,marginLeft:q,marginRight:q});
X&&b("select").not(j.find("select")).filter(function(){return this.style.visibility!==c}).css({visibility:c}).one(N,function(){this.style.visibility="inherit"
});a.transition==="fade"?j.fadeTo(e,0,function(){l(0)}):l(e)}};d.load=function(u){var n,c,s,q=d.prep;
D=e;l=h[g];u||(a=cb(b.extend({},b.data(l,r))));w(Q);w(W,a.onLoad);a.h=a.height?p(a.height,o)-y-B:a.innerHeight&&p(a.innerHeight,o);
a.w=a.width?p(a.width,m)-z-C:a.innerWidth&&p(a.innerWidth,m);a.mw=a.w;a.mh=a.h;if(a.maxWidth){a.mw=p(a.maxWidth,m)-z-C;
a.mw=a.w&&a.w<a.mw?a.w:a.mw}if(a.maxHeight){a.mh=p(a.maxHeight,o)-y-B;a.mh=a.h&&a.h<a.mh?a.h:a.mh}n=a.href;
K.show();if(a.inline){f().hide().insertBefore(b(n)[0]).one(Q,function(){b(this).replaceWith(k.children())
});q(b(n))}else{if(a.iframe){j.one(hb,function(){var c=b("<iframe frameborder='0' style='width:100%; height:100%; border:0; display:block'/>")[0];
c.name=i+ +new Date;c.src=a.href;if(!a.scrolling){c.scrolling="no"}if(E){c.allowtransparency="true"}b(c).appendTo(k).one(Q,function(){c.src="//about:blank"
})});q(" ")}else{if(a.html){q(a.html)}else{if(U(n)){c=new Image;c.onload=function(){var e;c.onload=null;
c.id=i+"Photo";b(c).css({border:t,display:"block",cssFloat:"left"});if(a.scalePhotos){s=function(){c.height-=c.height*e;
c.width-=c.width*e};if(a.mw&&c.width>a.mw){e=(c.width-a.mw)/c.width;s()}if(a.mh&&c.height>a.mh){e=(c.height-a.mh)/c.height;
s()}}if(a.h){c.style.marginTop=Math.max(a.h-c.height,0)/2+"px"}h[1]&&(g<h.length-1||a.loop)&&b(c).css({cursor:"pointer"}).click(d.next);
if(E){c.style.msInterpolationMode="bicubic"}setTimeout(function(){q(c)},1)};setTimeout(function(){c.src=n
},1)}else{n&&J.load(n,function(d,c,a){q(c==="error"?"Request unsuccessful: "+a.statusText:b(this).children())
})}}}}};d.next=function(){if(!D){g=g<h.length-1?g+1:0;d.load()}};d.prev=function(){if(!D){g=g?g-1:h.length-1;
d.load()}};d.close=function(){if(u&&!O){O=e;u=c;w(N,a.onCleanup);n.unbind("."+i+" ."+P);x.fadeTo("fast",0);
j.stop().fadeTo("fast",0,function(){w(Q);k.remove();j.add(x).css({opacity:1,cursor:q}).hide();setTimeout(function(){O=c;
w(eb,a.onClosed)},1)})}};d.element=function(){return b(l)};d.settings=gb;b(d.init)})(jQuery,this);(function(factory){if(typeof define==="function"&&define.amd){define(["jquery","jquery.ui.widget"],factory)
}else{factory(window.jQuery)}}(function($){$.support.xhrFileUpload=!!(window.XMLHttpRequestUpload&&window.FileReader);
$.support.xhrFormDataFileUpload=!!window.FormData;$.widget("blueimp.fileupload",{options:{dropZone:$(document),pasteZone:$(document),fileInput:undefined,replaceFileInput:true,paramName:undefined,singleFileUploads:true,limitMultiFileUploads:undefined,sequentialUploads:false,limitConcurrentUploads:undefined,forceIframeTransport:false,redirect:undefined,redirectParamName:undefined,postMessage:undefined,multipart:true,maxChunkSize:undefined,uploadedBytes:undefined,recalculateProgress:true,progressInterval:100,bitrateInterval:500,autoUpload:true,formData:function(form){return form.serializeArray()
},add:function(e,data){if(data.autoUpload||(data.autoUpload!==false&&($(this).data("blueimp-fileupload")||$(this).data("fileupload")).options.autoUpload)){data.submit()
}},processData:false,contentType:false,cache:false},_refreshOptionsList:["fileInput","dropZone","pasteZone","multipart","forceIframeTransport"],_BitrateTimer:function(){this.timestamp=+(new Date());
this.loaded=0;this.bitrate=0;this.getBitrate=function(now,loaded,interval){var timeDiff=now-this.timestamp;
if(!this.bitrate||!interval||timeDiff>interval){this.bitrate=(loaded-this.loaded)*(1000/timeDiff)*8;this.loaded=loaded;
this.timestamp=now}return this.bitrate}},_isXHRUpload:function(options){return !options.forceIframeTransport&&((!options.multipart&&$.support.xhrFileUpload)||$.support.xhrFormDataFileUpload)
},_getFormData:function(options){var formData;if(typeof options.formData==="function"){return options.formData(options.form)
}if($.isArray(options.formData)){return options.formData}if(options.formData){formData=[];$.each(options.formData,function(name,value){formData.push({name:name,value:value})
});return formData}return[]},_getTotal:function(files){var total=0;$.each(files,function(index,file){total+=file.size||1
});return total},_initProgressObject:function(obj){obj._progress={loaded:0,total:0,bitrate:0}},_onProgress:function(e,data){if(e.lengthComputable){var now=+(new Date()),loaded;
if(data._time&&data.progressInterval&&(now-data._time<data.progressInterval)&&e.loaded!==e.total){return
}data._time=now;loaded=Math.floor(e.loaded/e.total*(data.chunkSize||data._progress.total))+(data.uploadedBytes||0);
this._progress.loaded+=(loaded-data._progress.loaded);this._progress.bitrate=this._bitrateTimer.getBitrate(now,this._progress.loaded,data.bitrateInterval);
data._progress.loaded=data.loaded=loaded;data._progress.bitrate=data.bitrate=data._bitrateTimer.getBitrate(now,loaded,data.bitrateInterval);
this._trigger("progress",e,data);this._trigger("progressall",e,this._progress)}},_initProgressListener:function(options){var that=this,xhr=options.xhr?options.xhr():$.ajaxSettings.xhr();
if(xhr.upload){$(xhr.upload).bind("progress",function(e){var oe=e.originalEvent;e.lengthComputable=oe.lengthComputable;
e.loaded=oe.loaded;e.total=oe.total;that._onProgress(e,options)});options.xhr=function(){return xhr}}},_initXHRData:function(options){var formData,file=options.files[0],multipart=options.multipart||!$.support.xhrFileUpload,paramName=options.paramName[0];
options.headers=options.headers||{};if(options.contentRange){options.headers["Content-Range"]=options.contentRange
}if(!multipart){options.headers["Content-Disposition"]='attachment; filename="'+encodeURI(file.name)+'"';
options.contentType=file.type;options.data=options.blob||file}else{if($.support.xhrFormDataFileUpload){if(options.postMessage){formData=this._getFormData(options);
if(options.blob){formData.push({name:paramName,value:options.blob})}else{$.each(options.files,function(index,file){formData.push({name:options.paramName[index]||paramName,value:file})
})}}else{if(options.formData instanceof FormData){formData=options.formData}else{formData=new FormData();
$.each(this._getFormData(options),function(index,field){formData.append(field.name,field.value)})}if(options.blob){options.headers["Content-Disposition"]='attachment; filename="'+encodeURI(file.name)+'"';
formData.append(paramName,options.blob,file.name)}else{$.each(options.files,function(index,file){if((window.Blob&&file instanceof Blob)||(window.File&&file instanceof File)){formData.append(options.paramName[index]||paramName,file,file.name)
}})}}options.data=formData}}options.blob=null},_initIframeSettings:function(options){options.dataType="iframe "+(options.dataType||"");
options.formData=this._getFormData(options);if(options.redirect&&$("<a></a>").prop("href",options.url).prop("host")!==location.host){options.formData.push({name:options.redirectParamName||"redirect",value:options.redirect})
}},_initDataSettings:function(options){if(this._isXHRUpload(options)){if(!this._chunkedUpload(options,true)){if(!options.data){this._initXHRData(options)
}this._initProgressListener(options)}if(options.postMessage){options.dataType="postmessage "+(options.dataType||"")
}}else{this._initIframeSettings(options,"iframe")}},_getParamName:function(options){var fileInput=$(options.fileInput),paramName=options.paramName;
if(!paramName){paramName=[];fileInput.each(function(){var input=$(this),name=input.prop("name")||"files[]",i=(input.prop("files")||[1]).length;
while(i){paramName.push(name);i-=1}});if(!paramName.length){paramName=[fileInput.prop("name")||"files[]"]
}}else{if(!$.isArray(paramName)){paramName=[paramName]}}return paramName},_initFormSettings:function(options){if(!options.form||!options.form.length){options.form=$(options.fileInput.prop("form"));
if(!options.form.length){options.form=$(this.options.fileInput.prop("form"))}}options.paramName=this._getParamName(options);
if(!options.url){options.url=options.form.prop("action")||location.href}options.type=(options.type||options.form.prop("method")||"").toUpperCase();
if(options.type!=="POST"&&options.type!=="PUT"&&options.type!=="PATCH"){options.type="POST"}if(!options.formAcceptCharset){options.formAcceptCharset=options.form.attr("accept-charset")
}},_getAJAXSettings:function(data){var options=$.extend({},this.options,data);this._initFormSettings(options);
this._initDataSettings(options);return options},_getDeferredState:function(deferred){if(deferred.state){return deferred.state()
}if(deferred.isResolved()){return"resolved"}if(deferred.isRejected()){return"rejected"}return"pending"
},_enhancePromise:function(promise){promise.success=promise.done;promise.error=promise.fail;promise.complete=promise.always;
return promise},_getXHRPromise:function(resolveOrReject,context,args){var dfd=$.Deferred(),promise=dfd.promise();
context=context||this.options.context||promise;if(resolveOrReject===true){dfd.resolveWith(context,args)
}else{if(resolveOrReject===false){dfd.rejectWith(context,args)}}promise.abort=dfd.promise;return this._enhancePromise(promise)
},_addConvenienceMethods:function(e,data){var that=this;data.submit=function(){if(this.state()!=="pending"){data.jqXHR=this.jqXHR=(that._trigger("submit",e,this)!==false)&&that._onSend(e,this)
}return this.jqXHR||that._getXHRPromise()};data.abort=function(){if(this.jqXHR){return this.jqXHR.abort()
}return this._getXHRPromise()};data.state=function(){if(this.jqXHR){return that._getDeferredState(this.jqXHR)
}};data.progress=function(){return this._progress}},_getUploadedBytes:function(jqXHR){var range=jqXHR.getResponseHeader("Range"),parts=range&&range.split("-"),upperBytesPos=parts&&parts.length>1&&parseInt(parts[1],10);
return upperBytesPos&&upperBytesPos+1},_chunkedUpload:function(options,testOnly){var that=this,file=options.files[0],fs=file.size,ub=options.uploadedBytes=options.uploadedBytes||0,mcs=options.maxChunkSize||fs,slice=file.slice||file.webkitSlice||file.mozSlice,dfd=$.Deferred(),promise=dfd.promise(),jqXHR,upload;
if(!(this._isXHRUpload(options)&&slice&&(ub||mcs<fs))||options.data){return false}if(testOnly){return true
}if(ub>=fs){file.error="Uploaded bytes exceed file size";return this._getXHRPromise(false,options.context,[null,"error",file.error])
}upload=function(){var o=$.extend({},options),currentLoaded=o._progress.loaded;o.blob=slice.call(file,ub,ub+mcs,file.type);
o.chunkSize=o.blob.size;o.contentRange="bytes "+ub+"-"+(ub+o.chunkSize-1)+"/"+fs;that._initXHRData(o);
that._initProgressListener(o);jqXHR=((that._trigger("chunksend",null,o)!==false&&$.ajax(o))||that._getXHRPromise(false,o.context)).done(function(result,textStatus,jqXHR){ub=that._getUploadedBytes(jqXHR)||(ub+o.chunkSize);
if(o._progress.loaded===currentLoaded){that._onProgress($.Event("progress",{lengthComputable:true,loaded:ub-o.uploadedBytes,total:ub-o.uploadedBytes}),o)
}options.uploadedBytes=o.uploadedBytes=ub;o.result=result;o.textStatus=textStatus;o.jqXHR=jqXHR;that._trigger("chunkdone",null,o);
that._trigger("chunkalways",null,o);if(ub<fs){upload()}else{dfd.resolveWith(o.context,[result,textStatus,jqXHR])
}}).fail(function(jqXHR,textStatus,errorThrown){o.jqXHR=jqXHR;o.textStatus=textStatus;o.errorThrown=errorThrown;
that._trigger("chunkfail",null,o);that._trigger("chunkalways",null,o);dfd.rejectWith(o.context,[jqXHR,textStatus,errorThrown])
})};this._enhancePromise(promise);promise.abort=function(){return jqXHR.abort()};upload();return promise
},_beforeSend:function(e,data){if(this._active===0){this._trigger("start");this._bitrateTimer=new this._BitrateTimer();
this._progress.loaded=this._progress.total=0;this._progress.bitrate=0}if(!data._progress){data._progress={}
}data._progress.loaded=data.loaded=data.uploadedBytes||0;data._progress.total=data.total=this._getTotal(data.files)||1;
data._progress.bitrate=data.bitrate=0;this._active+=1;this._progress.loaded+=data.loaded;this._progress.total+=data.total
},_onDone:function(result,textStatus,jqXHR,options){var total=options._progress.total;if(options._progress.loaded<total){this._onProgress($.Event("progress",{lengthComputable:true,loaded:total,total:total}),options)
}options.result=result;options.textStatus=textStatus;options.jqXHR=jqXHR;this._trigger("done",null,options)
},_onFail:function(jqXHR,textStatus,errorThrown,options){options.jqXHR=jqXHR;options.textStatus=textStatus;
options.errorThrown=errorThrown;this._trigger("fail",null,options);if(options.recalculateProgress){this._progress.loaded-=options._progress.loaded;
this._progress.total-=options._progress.total}},_onAlways:function(jqXHRorResult,textStatus,jqXHRorError,options){this._active-=1;
this._trigger("always",null,options);if(this._active===0){this._trigger("stop")}},_onSend:function(e,data){if(!data.submit){this._addConvenienceMethods(e,data)
}var that=this,jqXHR,aborted,slot,pipe,options=that._getAJAXSettings(data),send=function(){that._sending+=1;
options._bitrateTimer=new that._BitrateTimer();jqXHR=jqXHR||(((aborted||that._trigger("send",e,options)===false)&&that._getXHRPromise(false,options.context,aborted))||that._chunkedUpload(options)||$.ajax(options)).done(function(result,textStatus,jqXHR){that._onDone(result,textStatus,jqXHR,options)
}).fail(function(jqXHR,textStatus,errorThrown){that._onFail(jqXHR,textStatus,errorThrown,options)}).always(function(jqXHRorResult,textStatus,jqXHRorError){that._sending-=1;
that._onAlways(jqXHRorResult,textStatus,jqXHRorError,options);if(options.limitConcurrentUploads&&options.limitConcurrentUploads>that._sending){var nextSlot=that._slots.shift();
while(nextSlot){if(that._getDeferredState(nextSlot)==="pending"){nextSlot.resolve();break}nextSlot=that._slots.shift()
}}});return jqXHR};this._beforeSend(e,options);if(this.options.sequentialUploads||(this.options.limitConcurrentUploads&&this.options.limitConcurrentUploads<=this._sending)){if(this.options.limitConcurrentUploads>1){slot=$.Deferred();
this._slots.push(slot);pipe=slot.pipe(send)}else{pipe=(this._sequence=this._sequence.pipe(send,send))
}pipe.abort=function(){aborted=[undefined,"abort","abort"];if(!jqXHR){if(slot){slot.rejectWith(options.context,aborted)
}return send()}return jqXHR.abort()};return this._enhancePromise(pipe)}return send()},_onAdd:function(e,data){var that=this,result=true,options=$.extend({},this.options,data),limit=options.limitMultiFileUploads,paramName=this._getParamName(options),paramNameSet,paramNameSlice,fileSet,i;
if(!(options.singleFileUploads||limit)||!this._isXHRUpload(options)){fileSet=[data.files];paramNameSet=[paramName]
}else{if(!options.singleFileUploads&&limit){fileSet=[];paramNameSet=[];for(i=0;i<data.files.length;i+=limit){fileSet.push(data.files.slice(i,i+limit));
paramNameSlice=paramName.slice(i,i+limit);if(!paramNameSlice.length){paramNameSlice=paramName}paramNameSet.push(paramNameSlice)
}}else{paramNameSet=paramName}}data.originalFiles=data.files;$.each(fileSet||data.files,function(index,element){var newData=$.extend({},data);
newData.files=fileSet?element:[element];newData.paramName=paramNameSet[index];that._initProgressObject(newData);
that._addConvenienceMethods(e,newData);result=that._trigger("add",e,newData);return result});return result
},_replaceFileInput:function(input){var inputClone=input.clone(true);$("<form></form>").append(inputClone)[0].reset();
input.after(inputClone).detach();$.cleanData(input.unbind("remove"));this.options.fileInput=this.options.fileInput.map(function(i,el){if(el===input[0]){return inputClone[0]
}return el});if(input[0]===this.element[0]){this.element=inputClone}},_handleFileTreeEntry:function(entry,path){var that=this,dfd=$.Deferred(),errorHandler=function(e){if(e&&!e.entry){e.entry=entry
}dfd.resolve([e])},dirReader;path=path||"";if(entry.isFile){if(entry._file){entry._file.relativePath=path;
dfd.resolve(entry._file)}else{entry.file(function(file){file.relativePath=path;dfd.resolve(file)},errorHandler)
}}else{if(entry.isDirectory){dirReader=entry.createReader();dirReader.readEntries(function(entries){that._handleFileTreeEntries(entries,path+entry.name+"/").done(function(files){dfd.resolve(files)
}).fail(errorHandler)},errorHandler)}else{dfd.resolve([])}}return dfd.promise()},_handleFileTreeEntries:function(entries,path){var that=this;
return $.when.apply($,$.map(entries,function(entry){return that._handleFileTreeEntry(entry,path)})).pipe(function(){return Array.prototype.concat.apply([],arguments)
})},_getDroppedFiles:function(dataTransfer){dataTransfer=dataTransfer||{};var items=dataTransfer.items;
if(items&&items.length&&(items[0].webkitGetAsEntry||items[0].getAsEntry)){return this._handleFileTreeEntries($.map(items,function(item){var entry;
if(item.webkitGetAsEntry){entry=item.webkitGetAsEntry();if(entry){entry._file=item.getAsFile()}return entry
}return item.getAsEntry()}))}return $.Deferred().resolve($.makeArray(dataTransfer.files)).promise()},_getSingleFileInputFiles:function(fileInput){fileInput=$(fileInput);
var entries=fileInput.prop("webkitEntries")||fileInput.prop("entries"),files,value;if(entries&&entries.length){return this._handleFileTreeEntries(entries)
}files=$.makeArray(fileInput.prop("files"));if(!files.length){value=fileInput.prop("value");if(!value){return $.Deferred().resolve([]).promise()
}files=[{name:value.replace(/^.*\\/,"")}]}else{if(files[0].name===undefined&&files[0].fileName){$.each(files,function(index,file){file.name=file.fileName;
file.size=file.fileSize})}}return $.Deferred().resolve(files).promise()},_getFileInputFiles:function(fileInput){if(!(fileInput instanceof $)||fileInput.length===1){return this._getSingleFileInputFiles(fileInput)
}return $.when.apply($,$.map(fileInput,this._getSingleFileInputFiles)).pipe(function(){return Array.prototype.concat.apply([],arguments)
})},_onChange:function(e){var that=this,data={fileInput:$(e.target),form:$(e.target.form)};this._getFileInputFiles(data.fileInput).always(function(files){data.files=files;
if(that.options.replaceFileInput){that._replaceFileInput(data.fileInput)}if(that._trigger("change",e,data)!==false){that._onAdd(e,data)
}})},_onPaste:function(e){var cbd=e.originalEvent.clipboardData,items=(cbd&&cbd.items)||[],data={files:[]};
$.each(items,function(index,item){var file=item.getAsFile&&item.getAsFile();if(file){data.files.push(file)
}});if(this._trigger("paste",e,data)===false||this._onAdd(e,data)===false){return false}},_onDrop:function(e){var that=this,dataTransfer=e.dataTransfer=e.originalEvent.dataTransfer,data={};
if(dataTransfer&&dataTransfer.files&&dataTransfer.files.length){e.preventDefault()}this._getDroppedFiles(dataTransfer).always(function(files){data.files=files;
if(that._trigger("drop",e,data)!==false){that._onAdd(e,data)}})},_onDragOver:function(e){var dataTransfer=e.dataTransfer=e.originalEvent.dataTransfer;
if(this._trigger("dragover",e)===false){return false}if(dataTransfer&&$.inArray("Files",dataTransfer.types)!==-1){dataTransfer.dropEffect="copy";
e.preventDefault()}},_initEventHandlers:function(){if(this._isXHRUpload(this.options)){this._on(this.options.dropZone,{dragover:this._onDragOver,drop:this._onDrop});
this._on(this.options.pasteZone,{paste:this._onPaste})}this._on(this.options.fileInput,{change:this._onChange})
},_destroyEventHandlers:function(){this._off(this.options.dropZone,"dragover drop");this._off(this.options.pasteZone,"paste");
this._off(this.options.fileInput,"change")},_setOption:function(key,value){var refresh=$.inArray(key,this._refreshOptionsList)!==-1;
if(refresh){this._destroyEventHandlers()}this._super(key,value);if(refresh){this._initSpecialOptions();
this._initEventHandlers()}},_initSpecialOptions:function(){var options=this.options;if(options.fileInput===undefined){options.fileInput=this.element.is('input[type="file"]')?this.element:this.element.find('input[type="file"]')
}else{if(!(options.fileInput instanceof $)){options.fileInput=$(options.fileInput)}}if(!(options.dropZone instanceof $)){options.dropZone=$(options.dropZone)
}if(!(options.pasteZone instanceof $)){options.pasteZone=$(options.pasteZone)}},_create:function(){var options=this.options;
$.extend(options,$(this.element[0].cloneNode(false)).data());this._initSpecialOptions();this._slots=[];
this._sequence=this._getXHRPromise(true);this._sending=this._active=0;this._initProgressObject(this);
this._initEventHandlers()},progress:function(){return this._progress},add:function(data){var that=this;
if(!data||this.options.disabled){return}if(data.fileInput&&!data.files){this._getFileInputFiles(data.fileInput).always(function(files){data.files=files;
that._onAdd(null,data)})}else{data.files=$.makeArray(data.files);this._onAdd(null,data)}},send:function(data){if(data&&!this.options.disabled){if(data.fileInput&&!data.files){var that=this,dfd=$.Deferred(),promise=dfd.promise(),jqXHR,aborted;
promise.abort=function(){aborted=true;if(jqXHR){return jqXHR.abort()}dfd.reject(null,"abort","abort");
return promise};this._getFileInputFiles(data.fileInput).always(function(files){if(aborted){return}data.files=files;
jqXHR=that._onSend(null,data).then(function(result,textStatus,jqXHR){dfd.resolve(result,textStatus,jqXHR)
},function(jqXHR,textStatus,errorThrown){dfd.reject(jqXHR,textStatus,errorThrown)})});return this._enhancePromise(promise)
}data.files=$.makeArray(data.files);if(data.files.length){return this._onSend(null,data)}}return this._getXHRPromise(false,data&&data.context)
}})}));(function(factory){if(typeof define==="function"&&define.amd){define(["jquery","tmpl","load-image","./jquery.fileupload-fp"],factory)
}else{factory(window.jQuery,window.tmpl,window.loadImage)}}(function($,tmpl,loadImage){$.widget("blueimp.fileupload",$.blueimp.fileupload,{options:{autoUpload:false,maxNumberOfFiles:undefined,maxFileSize:undefined,minFileSize:undefined,acceptFileTypes:/.+$/i,previewSourceFileTypes:/^image\/(gif|jpeg|png)$/,previewSourceMaxFileSize:5000000,previewMaxWidth:80,previewMaxHeight:80,previewAsCanvas:true,uploadTemplateId:"template-upload",downloadTemplateId:"template-download",filesContainer:undefined,prependFiles:false,dataType:"json",add:function(e,data){var that=$(this).data("blueimp-fileupload")||$(this).data("fileupload"),options=that.options,files=data.files;
$(this).fileupload("process",data).done(function(){that._adjustMaxNumberOfFiles(-files.length);data.maxNumberOfFilesAdjusted=true;
data.files.valid=data.isValidated=that._validate(files);data.context=that._renderUpload(files).data("data",data);
options.filesContainer[options.prependFiles?"prepend":"append"](data.context);that._renderPreviews(data);
that._forceReflow(data.context);that._transition(data.context).done(function(){if((that._trigger("added",e,data)!==false)&&(options.autoUpload||data.autoUpload)&&data.autoUpload!==false&&data.isValidated){data.submit()
}})})},send:function(e,data){var that=$(this).data("blueimp-fileupload")||$(this).data("fileupload");
if(!data.isValidated){if(!data.maxNumberOfFilesAdjusted){that._adjustMaxNumberOfFiles(-data.files.length);
data.maxNumberOfFilesAdjusted=true}if(!that._validate(data.files)){return false}}if(data.context&&data.dataType&&data.dataType.substr(0,6)==="iframe"){data.context.find(".progress").addClass(!$.support.transition&&"progress-animated").attr("aria-valuenow",100).find(".bar").css("width","100%")
}return that._trigger("sent",e,data)},done:function(e,data){var that=$(this).data("fileupload"),template,preview;
if(!that){return}if(data.context){data.context.each(function(index){var file=($.isArray(data.result)&&data.result[index])||{error:"emptyResult"};
if(file.error&&that._adjustMaxNumberOfFiles){that._adjustMaxNumberOfFiles(1)}that._transition($(this)).done(function(){var node=$(this);
template=that._renderDownload([file]).css("height",node.height()).replaceAll(node);that._forceReflow(template);
that._transition(template).done(function(){data.context=$(this);that._trigger("completed",e,data)})})
})}else{template=that._renderDownload(data.result).appendTo(that.options.filesContainer);that._forceReflow(template);
that._transition(template).done(function(){data.context=$(this);that._trigger("completed",e,data)})}},fail:function(e,data){var that=$(this).data("blueimp-fileupload")||$(this).data("fileupload"),template,deferred;
if(data.maxNumberOfFilesAdjusted){that._adjustMaxNumberOfFiles(data.files.length)}if(data.context){data.context.each(function(index){if(data.errorThrown!=="abort"){var file=data.files[index];
file.error=file.error||data.errorThrown||true;deferred=that._addFinishedDeferreds();that._transition($(this)).done(function(){var node=$(this);
template=that._renderDownload([file]).replaceAll(node);that._forceReflow(template);that._transition(template).done(function(){data.context=$(this);
that._trigger("failed",e,data);that._trigger("finished",e,data);deferred.resolve()})})}else{deferred=that._addFinishedDeferreds();
that._transition($(this)).done(function(){$(this).remove();that._trigger("failed",e,data);that._trigger("finished",e,data);
deferred.resolve()})}})}else{if(data.errorThrown!=="abort"){data.context=that._renderUpload(data.files).appendTo(that.options.filesContainer).data("data",data);
that._forceReflow(data.context);deferred=that._addFinishedDeferreds();that._transition(data.context).done(function(){data.context=$(this);
that._trigger("failed",e,data);that._trigger("finished",e,data);deferred.resolve()})}else{that._trigger("failed",e,data);
that._trigger("finished",e,data);that._addFinishedDeferreds().resolve()}}},progress:function(e,data){if(data.context){var progress=Math.floor(data.loaded/data.total*100);
data.context.find(".progress").attr("aria-valuenow",progress).find(".bar").css("width",progress+"%")}},progressall:function(e,data){var $this=$(this),progress=Math.floor(data.loaded/data.total*100),globalProgressNode=$this.find(".fileupload-progress"),extendedProgressNode=globalProgressNode.find(".progress-extended");
if(extendedProgressNode.length){extendedProgressNode.html(($this.data("blueimp-fileupload")||$this.data("fileupload"))._renderExtendedProgress(data))
}globalProgressNode.find(".progress").attr("aria-valuenow",progress).find(".bar").css("width",progress+"%")
},start:function(e){var that=$(this).data("blueimp-fileupload")||$(this).data("fileupload");that._resetFinishedDeferreds();
that._transition($(this).find(".fileupload-progress")).done(function(){that._trigger("started",e)})},stop:function(e){var that=$(this).data("blueimp-fileupload")||$(this).data("fileupload"),deferred=that._addFinishedDeferreds();
$.when.apply($,that._getFinishedDeferreds()).done(function(){that._trigger("stopped",e)});that._transition($(this).find(".fileupload-progress")).done(function(){$(this).find(".progress").attr("aria-valuenow","0").find(".bar").css("width","0%");
$(this).find(".progress-extended").html("&nbsp;");deferred.resolve()})},destroy:function(e,data){var that=$(this).data("blueimp-fileupload")||$(this).data("fileupload");
if(data.url){$.ajax(data);that._adjustMaxNumberOfFiles(1)}that._transition(data.context).done(function(){$(this).remove();
that._trigger("destroyed",e,data)})}},_resetFinishedDeferreds:function(){this._finishedUploads=[]},_addFinishedDeferreds:function(deferred){if(!deferred){deferred=$.Deferred()
}this._finishedUploads.push(deferred);return deferred},_getFinishedDeferreds:function(){return this._finishedUploads
},_getFilesFromResponse:function(data){if(data.result&&$.isArray(data.result.files)){return data.result.files
}return[]},_enableDragToDesktop:function(){var link=$(this),url=link.prop("href"),name=link.prop("download"),type="application/octet-stream";
link.bind("dragstart",function(e){try{e.originalEvent.dataTransfer.setData("DownloadURL",[type,name,url].join(":"))
}catch(err){}})},_adjustMaxNumberOfFiles:function(operand){if(typeof this.options.maxNumberOfFiles==="number"){this.options.maxNumberOfFiles+=operand;
if(this.options.maxNumberOfFiles<1){this._disableFileInputButton()}else{this._enableFileInputButton()
}}},_formatFileSize:function(bytes){if(typeof bytes!=="number"){return""}if(bytes>=1000000000){return(bytes/1000000000).toFixed(2)+" GB"
}if(bytes>=1000000){return(bytes/1000000).toFixed(2)+" MB"}return(bytes/1000).toFixed(2)+" KB"},_formatBitrate:function(bits){if(typeof bits!=="number"){return""
}if(bits>=1000000000){return(bits/1000000000).toFixed(2)+" Gbit/s"}if(bits>=1000000){return(bits/1000000).toFixed(2)+" Mbit/s"
}if(bits>=1000){return(bits/1000).toFixed(2)+" kbit/s"}return bits.toFixed(2)+" bit/s"},_formatTime:function(seconds){var date=new Date(seconds*1000),days=Math.floor(seconds/86400);
days=days?days+"d ":"";return days+("0"+date.getUTCHours()).slice(-2)+":"+("0"+date.getUTCMinutes()).slice(-2)+":"+("0"+date.getUTCSeconds()).slice(-2)
},_formatPercentage:function(floatValue){return(floatValue*100).toFixed(2)+" %"},_renderExtendedProgress:function(data){return this._formatBitrate(data.bitrate)+" | "+this._formatTime((data.total-data.loaded)*8/data.bitrate)+" | "+this._formatPercentage(data.loaded/data.total)+" | "+this._formatFileSize(data.loaded)+" / "+this._formatFileSize(data.total)
},_hasError:function(file){if(file.error){return file.error}if(this.options.maxNumberOfFiles<0){return"Maximum number of files exceeded"
}if(!(this.options.acceptFileTypes.test(file.type)||this.options.acceptFileTypes.test(file.name))){return"Filetype not allowed"
}if(this.options.maxFileSize&&file.size>this.options.maxFileSize){return"File is too big"}if(typeof file.size==="number"&&file.size<this.options.minFileSize){return"File is too small"
}return null},_validate:function(files){var that=this,valid=!!files.length;$.each(files,function(index,file){file.error=that._hasError(file);
if(file.error){valid=false}});return valid},_renderTemplate:function(func,files){if(!func){return $()
}var result=func({files:files,formatFileSize:this._formatFileSize,options:this.options});if(result instanceof $){return result
}return $(this.options.templatesContainer).html(result).children()},_renderPreview:function(file,node){var that=this,options=this.options,dfd=$.Deferred();
return((loadImage&&loadImage(file,function(img){node.append(img);that._forceReflow(node);that._transition(node).done(function(){dfd.resolveWith(node)
});if(!$.contains(that.document[0].body,node[0])){dfd.resolveWith(node)}node.on("remove",function(){dfd.resolveWith(node)
})},{maxWidth:options.previewMaxWidth,maxHeight:options.previewMaxHeight,canvas:options.previewAsCanvas}))||dfd.resolveWith(node))&&dfd
},_renderPreviews:function(data){var that=this,options=this.options;data.context.find(".preview span").each(function(index,element){var file=data.files[index];
if(options.previewSourceFileTypes.test(file.type)&&($.type(options.previewSourceMaxFileSize)!=="number"||file.size<options.previewSourceMaxFileSize)){that._processingQueue=that._processingQueue.pipe(function(){var dfd=$.Deferred(),ev=$.Event("previewdone",{target:element});
that._renderPreview(file,$(element)).done(function(){that._trigger(ev.type,ev,data);dfd.resolveWith(that)
});return dfd.promise()})}});return this._processingQueue},_renderUpload:function(files){return this._renderTemplate(this.options.uploadTemplate,files)
},_renderDownload:function(files){return this._renderTemplate(this.options.downloadTemplate,files).find("a[download]").each(this._enableDragToDesktop).end()
},_startHandler:function(e){e.preventDefault();var button=$(e.currentTarget),template=button.closest(".template-upload"),data=template.data("data");
if(data&&data.submit&&!data.jqXHR&&data.submit()){button.prop("disabled",true)}},_cancelHandler:function(e){e.preventDefault();
var template=$(e.currentTarget).closest(".template-upload"),data=template.data("data")||{};if(!data.jqXHR){data.errorThrown="abort";
this._trigger("fail",e,data)}else{data.jqXHR.abort()}},_deleteHandler:function(e){e.preventDefault();
var button=$(e.currentTarget);this._trigger("destroy",e,$.extend({context:button.closest(".template-download"),type:"DELETE",dataType:this.options.dataType},button.data()))
},_forceReflow:function(node){return $.support.transition&&node.length&&node[0].offsetWidth},_transition:function(node){var dfd=$.Deferred();
if($.support.transition&&node.hasClass("fade")&&node.is(":visible")){node.bind($.support.transition.end,function(e){if(e.target===node[0]){node.unbind($.support.transition.end);
dfd.resolveWith(node)}}).toggleClass("in")}else{node.toggleClass("in");dfd.resolveWith(node)}return dfd
},_initButtonBarEventHandlers:function(){var fileUploadButtonBar=this.element.find(".fileupload-buttonbar"),filesList=this.options.filesContainer;
this._on(fileUploadButtonBar.find(".start"),{click:function(e){e.preventDefault();filesList.find(".start").click()
}});this._on(fileUploadButtonBar.find(".cancel"),{click:function(e){e.preventDefault();filesList.find(".cancel").click()
}});this._on(fileUploadButtonBar.find(".delete"),{click:function(e){e.preventDefault();filesList.find(".toggle:checked").closest(".template-download").find(".delete").click();
fileUploadButtonBar.find(".toggle").prop("checked",false)}});this._on(fileUploadButtonBar.find(".toggle"),{change:function(e){filesList.find(".toggle").prop("checked",$(e.currentTarget).is(":checked"))
}})},_destroyButtonBarEventHandlers:function(){this._off(this.element.find(".fileupload-buttonbar").find(".start, .cancel, .delete"),"click");
this._off(this.element.find(".fileupload-buttonbar .toggle"),"change.")},_initEventHandlers:function(){this._super();
this._on(this.options.filesContainer,{"click .start":this._startHandler,"click .cancel":this._cancelHandler,"click .delete":this._deleteHandler});
this._initButtonBarEventHandlers()},_destroyEventHandlers:function(){this._destroyButtonBarEventHandlers();
this._off(this.options.filesContainer,"click");this._super()},_enableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",false).parent().removeClass("disabled")
},_disableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",true).parent().addClass("disabled")
},_initTemplates:function(){var options=this.options;options.templatesContainer=this.document[0].createElement(options.filesContainer.prop("nodeName"));
if(tmpl){if(options.uploadTemplateId){options.uploadTemplate=tmpl(options.uploadTemplateId)}if(options.downloadTemplateId){options.downloadTemplate=tmpl(options.downloadTemplateId)
}}},_initFilesContainer:function(){var options=this.options;if(options.filesContainer===undefined){options.filesContainer=this.element.find(".files")
}else{if(!(options.filesContainer instanceof $)){options.filesContainer=$(options.filesContainer)}}},_stringToRegExp:function(str){var parts=str.split("/"),modifiers=parts.pop();
parts.shift();return new RegExp(parts.join("/"),modifiers)},_initRegExpOptions:function(){var options=this.options;
if($.type(options.acceptFileTypes)==="string"){options.acceptFileTypes=this._stringToRegExp(options.acceptFileTypes)
}if($.type(options.previewSourceFileTypes)==="string"){options.previewSourceFileTypes=this._stringToRegExp(options.previewSourceFileTypes)
}},_initSpecialOptions:function(){this._super();this._initFilesContainer();this._initTemplates();this._initRegExpOptions()
},_setOption:function(key,value){this._super(key,value);if(key==="maxNumberOfFiles"){this._adjustMaxNumberOfFiles(0)
}},_create:function(){this._super();this._refreshOptionsList.push("filesContainer","uploadTemplateId","downloadTemplateId");
if(!this._processingQueue){this._processingQueue=$.Deferred().resolveWith(this).promise();this.process=function(){return this._processingQueue
}}this._resetFinishedDeferreds()},enable:function(){var wasDisabled=false;if(this.options.disabled){wasDisabled=true
}this._super();if(wasDisabled){this.element.find("input, button").prop("disabled",false);this._enableFileInputButton()
}},disable:function(){if(!this.options.disabled){this.element.find("input, button").prop("disabled",true);
this._disableFileInputButton()}this._super()}})}));(function(factory){if(typeof define==="function"&&define.amd){define(["jquery"],factory)
}else{factory(window.jQuery)}}(function($){var counter=0;$.ajaxTransport("iframe",function(options){if(options.async){var form,iframe,addParamChar;
return{send:function(_,completeCallback){form=$('<form style="display:none;"></form>');form.attr("accept-charset",options.formAcceptCharset);
addParamChar=/\?/.test(options.url)?"&":"?";if(options.type==="DELETE"){options.url=options.url+addParamChar+"_method=DELETE";
options.type="POST"}else{if(options.type==="PUT"){options.url=options.url+addParamChar+"_method=PUT";
options.type="POST"}else{if(options.type==="PATCH"){options.url=options.url+addParamChar+"_method=PATCH";
options.type="POST"}}}iframe=$('<iframe src="javascript:false;" name="iframe-transport-'+(counter+=1)+'"></iframe>').bind("load",function(){var fileInputClones,paramNames=$.isArray(options.paramName)?options.paramName:[options.paramName];
iframe.unbind("load").bind("load",function(){var response;try{response=iframe.contents();if(!response.length||!response[0].firstChild){throw new Error()
}}catch(e){response=undefined}completeCallback(200,"success",{"iframe":response});$('<iframe src="javascript:false;"></iframe>').appendTo(form);
form.remove()});form.prop("target",iframe.prop("name")).prop("action",options.url).prop("method",options.type);
if(options.formData){$.each(options.formData,function(index,field){$('<input type="hidden"/>').prop("name",field.name).val(field.value).appendTo(form)
})}if(options.fileInput&&options.fileInput.length&&options.type==="POST"){fileInputClones=options.fileInput.clone();
options.fileInput.after(function(index){return fileInputClones[index]});if(options.paramName){options.fileInput.each(function(index){$(this).prop("name",paramNames[index]||options.paramName)
})}form.append(options.fileInput).prop("enctype","multipart/form-data").prop("encoding","multipart/form-data")
}form.submit();if(fileInputClones&&fileInputClones.length){options.fileInput.each(function(index,input){var clone=$(fileInputClones[index]);
$(input).prop("name",clone.prop("name"));clone.replaceWith(input)})}});form.append(iframe).appendTo(document.body)
},abort:function(){if(iframe){iframe.unbind("load").prop("src","javascript".concat(":false;"))}if(form){form.remove()
}}}}});$.ajaxSetup({converters:{"iframe text":function(iframe){return iframe&&$(iframe[0].body).text()
},"iframe json":function(iframe){return iframe&&$.parseJSON($(iframe[0].body).text())},"iframe html":function(iframe){return iframe&&$(iframe[0].body).html()
},"iframe script":function(iframe){return iframe&&$.globalEval($(iframe[0].body).text())}}})}));
/*! qTip2  (includes: svg ajax tips modal viewport imagemap ie6 / basic css3) | qtip2.com | Licensed MIT, GPL | Thu May 09 2013 16:46:38 */
(function(a,b,c){(function(a){"use strict",typeof define=="function"&&define.amd?define(["jquery"],a):jQuery&&!jQuery.fn.qtip&&a(jQuery)
})(function(d){function G(c){v={pageX:c.pageX,pageY:c.pageY,type:"mousemove",scrollX:a.pageXOffset||b.body.scrollLeft||b.documentElement.scrollLeft,scrollY:a.pageYOffset||b.body.scrollTop||b.documentElement.scrollTop}
}function H(a){var b=function(a){return a===g||"object"!=typeof a},c=function(a){return !d.isFunction(a)&&(!a&&!a.attr||a.length<1||"object"==typeof a&&!a.jquery&&!a.then)
};if(!a||"object"!=typeof a){return f}b(a.metadata)&&(a.metadata={type:a.metadata});if("content" in a){if(b(a.content)||a.content.jquery){a.content={text:a.content}
}c(a.content.text||f)&&(a.content.text=f),"title" in a.content&&(b(a.content.title)&&(a.content.title={text:a.content.title}),c(a.content.title.text||f)&&(a.content.title.text=f))
}return"position" in a&&b(a.position)&&(a.position={my:a.position,at:a.position}),"show" in a&&b(a.show)&&(a.show=a.show.jquery?{target:a.show}:{event:a.show}),"hide" in a&&b(a.hide)&&(a.hide=a.hide.jquery?{target:a.hide}:{event:a.hide}),"style" in a&&b(a.style)&&(a.style={classes:a.style}),d.each(u,function(){this.sanitize&&this.sanitize(a)
}),a}function I(h,i,j,k){function O(a){var b=0,c,d=i,e=a.split(".");while(d=d[e[b++]]){b<e.length&&(c=d)
}return[c||i,e.pop()]}function P(a){return y.concat("").join(a?"-"+a+" ":" ")}function Q(){var a=i.style.widget,b=J.hasClass(L);
J.removeClass(L),L=a?"ui-state-disabled":"qtip-disabled",J.toggleClass(L,b),J.toggleClass("ui-helper-reset "+P(),a).toggleClass(A,i.style.def&&!a),M.content&&M.content.toggleClass(P("content"),a),M.titlebar&&M.titlebar.toggleClass(P("header"),a),M.button&&M.button.toggleClass(w+"-icon",!a)
}function R(a){M.title&&(M.titlebar.remove(),M.titlebar=M.title=M.button=g,a!==f&&q.reposition())}function S(){var a=i.content.title.button,b=typeof a=="string",c=b?a:"Close tooltip";
M.button&&M.button.remove(),a.jquery?M.button=a:M.button=d("<a />",{"class":"qtip-close "+(i.style.widget?"":w+"-icon"),title:c,"aria-label":c}).prepend(d("<span />",{"class":"ui-icon ui-icon-close",html:"&times;"})),M.button.appendTo(M.titlebar||J).attr("role","button").click(function(a){return J.hasClass(L)||q.hide(a),f
})}function T(){var a=s+"-title";M.titlebar&&R(),M.titlebar=d("<div />",{"class":w+"-titlebar "+(i.style.widget?P("header"):"")}).append(M.title=d("<div />",{id:a,"class":w+"-title","aria-atomic":e})).insertBefore(M.content).delegate(".qtip-close","mousedown keydown mouseup keyup mouseout",function(a){d(this).toggleClass("ui-state-active ui-state-focus",a.type.substr(-4)==="down")
}).delegate(".qtip-close","mouseover mouseout",function(a){d(this).toggleClass("ui-state-hover",a.type==="mouseover")
}),i.content.title.button&&S()}function U(a){var b=M.button;if(!q.rendered){return f}a?S():b.remove()
}function V(a,b){var c=M.title;if(!q.rendered||!a){return f}d.isFunction(a)&&(a=a.call(h,N.event,q));
if(a===f||!a&&a!==""){return R(f)}a.jquery&&a.length>0?c.empty().append(a.css({display:"block"})):c.html(a),b!==f&&q.rendered&&J[0].offsetWidth>0&&q.reposition(N.event)
}function W(a){a&&d.isFunction(a.done)&&a.done(function(a){X(a,null,f)})}function X(a,b,e){function j(a){function i(c){c&&(delete h[c.src],clearTimeout(q.timers.img[c.src]),d(c).unbind(K)),d.isEmptyObject(h)&&(b!==f&&q.reposition(N.event),a())
}var e,h={};if((e=g.find("img[src]:not([height]):not([width])")).length===0){return i()}e.each(function(a,b){if(h[b.src]!==c){return
}var e=0,f=3;(function g(){if(b.height||b.width||e>f){return i(b)}e+=1,q.timers.img[b.src]=setTimeout(g,700)
})(),d(b).bind("error"+K+" load"+K,function(){i(this)}),h[b.src]=b})}var g=M.content;return !q.rendered||!a?f:(d.isFunction(a)&&(a=a.call(h,N.event,q)||""),e!==f&&W(i.content.deferred),a.jquery&&a.length>0?g.empty().append(a.css({display:"block"})):g.html(a),q.rendered<0?J.queue("fx",j):(I=0,j(d.noop)),q)
}function Y(){function m(a){if(J.hasClass(L)){return f}clearTimeout(q.timers.show),clearTimeout(q.timers.hide);
var b=function(){q.toggle(e,a)};i.show.delay>0?q.timers.show=setTimeout(b,i.show.delay):b()}function n(a){if(J.hasClass(L)||D||I){return f
}var b=d(a.relatedTarget||a.target),e=b.closest(z)[0]===J[0],h=b[0]===g.show[0];clearTimeout(q.timers.show),clearTimeout(q.timers.hide);
if(c.target==="mouse"&&e||i.hide.fixed&&/mouse(out|leave|move)/.test(a.type)&&(e||h)){try{a.preventDefault(),a.stopImmediatePropagation()
}catch(j){}return}i.hide.delay>0?q.timers.hide=setTimeout(function(){q.hide(a)},i.hide.delay):q.hide(a)
}function o(a){if(J.hasClass(L)){return f}clearTimeout(q.timers.inactive),q.timers.inactive=setTimeout(function(){q.hide(a)
},i.hide.inactive)}function p(a){q.rendered&&J[0].offsetWidth>0&&q.reposition(a)}var c=i.position,g={show:i.show.target,hide:i.hide.target,viewport:d(c.viewport),document:d(b),body:d(b.body),window:d(a)},k={show:d.trim(""+i.show.event).split(" "),hide:d.trim(""+i.hide.event).split(" ")},l=d.browser.msie&&parseInt(d.browser.version,10)===6;
J.bind("mouseenter"+K+" mouseleave"+K,function(a){var b=a.type==="mouseenter";b&&q.focus(a),J.toggleClass(C,b)
}),/mouse(out|leave)/i.test(i.hide.event)&&i.hide.leave==="window"&&g.window.bind("mouseout"+K+" blur"+K,function(a){!/select|option/.test(a.target.nodeName)&&!a.relatedTarget&&q.hide(a)
}),i.hide.fixed?(g.hide=g.hide.add(J),J.bind("mouseover"+K,function(){J.hasClass(L)||clearTimeout(q.timers.hide)
})):/mouse(over|enter)/i.test(i.show.event)&&g.hide.bind("mouseleave"+K,function(a){clearTimeout(q.timers.show)
}),(""+i.hide.event).indexOf("unfocus")>-1&&c.container.closest("html").bind("mousedown"+K+" touchstart"+K,function(a){var b=d(a.target),c=q.rendered&&!J.hasClass(L)&&J[0].offsetWidth>0,e=b.parents(z).filter(J[0]).length>0;
b[0]!==h[0]&&b[0]!==J[0]&&!e&&!h.has(b[0]).length&&!b.attr("disabled")&&q.hide(a)}),"number"==typeof i.hide.inactive&&(g.show.bind("qtip-"+j+"-inactive",o),d.each(t.inactiveEvents,function(a,b){g.hide.add(M.tooltip).bind(b+K+"-inactive",o)
})),d.each(k.hide,function(a,b){var c=d.inArray(b,k.show),e=d(g.hide);c>-1&&e.add(g.show).length===e.length||b==="unfocus"?(g.show.bind(b+K,function(a){J[0].offsetWidth>0?n(a):m(a)
}),delete k.show[c]):g.hide.bind(b+K,n)}),d.each(k.show,function(a,b){g.show.bind(b+K,m)}),"number"==typeof i.hide.distance&&g.show.add(J).bind("mousemove"+K,function(a){var b=N.origin||{},c=i.hide.distance,d=Math.abs;
(d(a.pageX-b.pageX)>=c||d(a.pageY-b.pageY)>=c)&&q.hide(a)}),c.target==="mouse"&&(g.show.bind("mousemove"+K,G),c.adjust.mouse&&(i.hide.event&&(J.bind("mouseleave"+K,function(a){(a.relatedTarget||a.target)!==g.show[0]&&q.hide(a)
}),M.target.bind("mouseenter"+K+" mouseleave"+K,function(a){N.onTarget=a.type==="mouseenter"})),g.document.bind("mousemove"+K,function(a){q.rendered&&N.onTarget&&!J.hasClass(L)&&J[0].offsetWidth>0&&q.reposition(a||v)
}))),(c.adjust.resize||g.viewport.length)&&(d.event.special.resize?g.viewport:g.window).bind("resize"+K,p),g.window.bind("scroll"+K,p)
}function Z(){var c=[i.show.target[0],i.hide.target[0],q.rendered&&M.tooltip[0],i.position.container[0],i.position.viewport[0],i.position.container.closest("html")[0],a,b];
q.rendered?d([]).pushStack(d.grep(c,function(a){return typeof a=="object"})).unbind(K):i.show.target.unbind(K+"-create")
}var q=this,r=b.body,s=w+"-"+j,D=0,I=0,J=d(),K=".qtip-"+j,L="qtip-disabled",M,N;q.id=j,q.rendered=f,q.destroyed=f,q.elements=M={target:h},q.timers={img:{}},q.options=i,q.checks={},q.plugins={},q.cache=N={event:{},target:d(),disabled:f,attr:k,onTarget:f,lastClass:""},q.checks.builtin={"^id$":function(a,b,c){var g=c===e?t.nextid:c,h=w+"-"+g;
g!==f&&g.length>0&&!d("#"+h).length&&(J[0].id=h,M.content[0].id=h+"-content",M.title[0].id=h+"-title")
},"^content.text$":function(a,b,c){X(i.content.text)},"^content.deferred$":function(a,b,c){W(i.content.deferred)
},"^content.title.text$":function(a,b,c){if(!c){return R()}!M.title&&c&&T(),V(c)},"^content.title.button$":function(a,b,c){U(c)
},"^position.(my|at)$":function(a,b,c){"string"==typeof c&&(a[b]=new u.Corner(c))},"^position.container$":function(a,b,c){q.rendered&&J.appendTo(c)
},"^show.ready$":function(){q.rendered?q.toggle(e):q.render(1)},"^style.classes$":function(a,b,c){J.attr("class",w+" qtip "+c)
},"^style.width|height":function(a,b,c){J.css(b,c)},"^style.widget|content.title":Q,"^events.(render|show|move|hide|focus|blur)$":function(a,b,c){J[(d.isFunction(c)?"":"un")+"bind"]("tooltip"+b,c)
},"^(show|hide|position).(event|target|fixed|inactive|leave|distance|viewport|adjust)":function(){var a=i.position;
J.attr("tracking",a.target==="mouse"&&a.adjust.mouse),Z(),Y()}},d.extend(q,{_triggerEvent:function(a,b,c){var e=d.Event("tooltip"+a);
return e.originalEvent=(c?d.extend({},c):g)||N.event||g,J.trigger(e,[q].concat(b||[])),!e.isDefaultPrevented()
},render:function(a){if(q.rendered){return q}var b=i.content.text,c=i.content.title,g=i.position;return d.attr(h[0],"aria-describedby",s),J=M.tooltip=d("<div/>",{id:s,"class":[w,A,i.style.classes,w+"-pos-"+i.position.my.abbrev()].join(" "),width:i.style.width||"",height:i.style.height||"",tracking:g.target==="mouse"&&g.adjust.mouse,role:"alert","aria-live":"polite","aria-atomic":f,"aria-describedby":s+"-content","aria-hidden":e}).toggleClass(L,N.disabled).data("qtip",q).appendTo(i.position.container).append(M.content=d("<div />",{"class":w+"-content",id:s+"-content","aria-atomic":e})),q.rendered=-1,D=1,c.text?(T(),d.isFunction(c.text)||V(c.text,f)):c.button&&S(),(!d.isFunction(b)||b.then)&&X(b,f),q.rendered=e,Q(),d.each(i.events,function(a,b){d.isFunction(b)&&J.bind(a==="toggle"?"tooltipshow tooltiphide":"tooltip"+a,b)
}),d.each(u,function(){this.initialize==="render"&&this(q)}),Y(),J.queue("fx",function(b){q._triggerEvent("render"),D=0,(i.show.ready||a)&&q.toggle(e,N.event,f),b()
}),q},get:function(a){var b,c;switch(a.toLowerCase()){case"dimensions":b={height:J.outerHeight(f),width:J.outerWidth(f)};
break;case"offset":b=u.offset(J,i.position.container);break;default:c=O(a.toLowerCase()),b=c[0][c[1]],b=b.precedance?b.string():b
}return b},set:function(a,b){function m(a,b){var c,d,e;for(c in k){for(d in k[c]){if(e=(new RegExp(d,"i")).exec(a)){b.push(e),k[c][d].apply(q,b)
}}}}var c=/^position\.(my|at|adjust|target|container)|style|content|show\.ready/i,h=/^content\.(title|attr)|style/i,j=f,k=q.checks,l;
return"string"==typeof a?(l=a,a={},a[l]=b):a=d.extend(e,{},a),d.each(a,function(b,e){var f=O(b.toLowerCase()),g;
g=f[0][f[1]],f[0][f[1]]="object"==typeof e&&e.nodeType?d(e):e,a[b]=[f[0],f[1],e,g],j=c.test(b)||j}),H(i),D=1,d.each(a,m),D=0,q.rendered&&J[0].offsetWidth>0&&j&&q.reposition(i.position.target==="mouse"?g:N.event),q
},toggle:function(a,c){function t(){a?(d.browser.msie&&J[0].style.removeAttribute("filter"),J.css("overflow",""),"string"==typeof h.autofocus&&d(h.autofocus,J).focus(),h.target.trigger("qtip-"+j+"-inactive")):J.css({display:"",visibility:"",opacity:"",left:"",top:""}),q._triggerEvent(a?"visible":"hidden")
}if(c){if(/over|enter/.test(c.type)&&/out|leave/.test(N.event.type)&&i.show.target.add(c.target).length===i.show.target.length&&J.has(c.relatedTarget).length){return q
}N.event=d.extend({},c)}if(!q.rendered){return a?q.render(1):q}var g=a?"show":"hide",h=i[g],k=i[a?"hide":"show"],l=i.position,m=i.content,n=J[0].offsetWidth>0,o=a||h.target.length===1,p=!c||h.target.length<2||N.target[0]===c.target,r,s;
return(typeof a).search("boolean|number")&&(a=!n),!J.is(":animated")&&n===a&&p?q:q._triggerEvent(g,[90])?(d.attr(J[0],"aria-hidden",!a),a?(N.origin=d.extend({},v),q.focus(c),d.isFunction(m.text)&&X(m.text,f),d.isFunction(m.title.text)&&V(m.title.text,f),!F&&l.target==="mouse"&&l.adjust.mouse&&(d(b).bind("mousemove.qtip",G),F=e),q.reposition(c,arguments[2]),!h.solo||d(z,h.solo).not(J).qtip("hide",d.Event("tooltipsolo"))):(clearTimeout(q.timers.show),delete N.origin,F&&!d(z+'[tracking="true"]:visible',h.solo).not(J).length&&(d(b).unbind("mousemove.qtip"),F=f),q.blur(c)),h.effect===f||o===f?(J[g](),t.call(J)):d.isFunction(h.effect)?(J.stop(1,1),h.effect.call(J,q),J.queue("fx",function(a){t(),a()
})):J.fadeTo(90,a?1:0,t),a&&h.target.trigger("qtip-"+j+"-inactive"),q):q},show:function(a){return q.toggle(e,a)
},hide:function(a){return q.toggle(f,a)},focus:function(a){if(!q.rendered){return q}var b=d(z),c=parseInt(J[0].style.zIndex,10),e=t.zindex+b.length,f=d.extend({},a),g;
return J.hasClass(B)||q._triggerEvent("focus",[e],f)&&(c!==e&&(b.each(function(){this.style.zIndex>c&&(this.style.zIndex=this.style.zIndex-1)
}),b.filter("."+B).qtip("blur",f)),J.addClass(B)[0].style.zIndex=e),q},blur:function(a){return J.removeClass(B),q._triggerEvent("blur",[J.css("zIndex")],a),q
},reposition:function(c,e){if(!q.rendered||D){return q}D=1;var g=i.position.target,h=i.position,j=h.my,k=h.at,r=h.adjust,s=r.method.split(" "),t=J.outerWidth(f),w=J.outerHeight(f),x=0,y=0,z=J.css("position"),A=h.viewport,B={left:0,top:0},C=h.container,E=J[0].offsetWidth>0,F=c&&c.type==="scroll",G=d(a),H,I;
if(d.isArray(g)&&g.length===2){k={x:m,y:l},B={left:g[0],top:g[1]}}else{if(g==="mouse"&&(c&&c.pageX||N.event.pageX)){k={x:m,y:l},c=v&&v.pageX&&(r.mouse||!c||!c.pageX)?{pageX:v.pageX,pageY:v.pageY}:(c&&(c.type==="resize"||c.type==="scroll")?N.event:c&&c.pageX&&c.type==="mousemove"?c:!r.mouse&&N.origin&&N.origin.pageX&&i.show.distance?N.origin:c)||c||N.event||v||{},z!=="static"&&(B=C.offset()),B={left:c.pageX-B.left,top:c.pageY-B.top},r.mouse&&F&&(B.left-=v.scrollX-G.scrollLeft(),B.top-=v.scrollY-G.scrollTop())
}else{g==="event"&&c&&c.target&&c.type!=="scroll"&&c.type!=="resize"?N.target=d(c.target):g!=="event"&&(N.target=d(g.jquery?g:M.target)),g=N.target,g=d(g).eq(0);
if(g.length===0){return q}g[0]===b||g[0]===a?(x=u.iOS?a.innerWidth:g.width(),y=u.iOS?a.innerHeight:g.height(),g[0]===a&&(B={top:(A||g).scrollTop(),left:(A||g).scrollLeft()})):u.imagemap&&g.is("area")?H=u.imagemap(q,g,k,u.viewport?s:f):u.svg&&g[0].ownerSVGElement?H=u.svg(q,g,k,u.viewport?s:f):(x=g.outerWidth(f),y=g.outerHeight(f),B=u.offset(g,C)),H&&(x=H.width,y=H.height,I=H.offset,B=H.position);
if(u.iOS>3.1&&u.iOS<4.1||u.iOS>=4.3&&u.iOS<4.33||!u.iOS&&z==="fixed"){B.left-=G.scrollLeft(),B.top-=G.scrollTop()
}B.left+=k.x===o?x:k.x===p?x/2:0,B.top+=k.y===n?y:k.y===p?y/2:0}}return B.left+=r.x+(j.x===o?-t:j.x===p?-t/2:0),B.top+=r.y+(j.y===n?-w:j.y===p?-w/2:0),u.viewport?(B.adjusted=u.viewport(q,B,h,x,y,t,w),I&&B.adjusted.left&&(B.left+=I.left),I&&B.adjusted.top&&(B.top+=I.top)):B.adjusted={left:0,top:0},q._triggerEvent("move",[B,A.elem||A],c)?(delete B.adjusted,e===f||!E||isNaN(B.left)||isNaN(B.top)||g==="mouse"||!d.isFunction(h.effect)?J.css(B):d.isFunction(h.effect)&&(h.effect.call(J,q,d.extend({},B)),J.queue(function(a){d(this).css({opacity:"",height:""}),d.browser.msie&&this.style.removeAttribute("filter"),a()
})),D=0,q):q},disable:function(a){return"boolean"!=typeof a&&(a=!J.hasClass(L)&&!N.disabled),q.rendered?(J.toggleClass(L,a),d.attr(J[0],"aria-disabled",a)):N.disabled=!!a,q
},enable:function(){return q.disable(f)},destroy:function(){var a=h[0],b=d.attr(a,E),c=h.data("qtip");
q.destroyed=e,q.rendered&&(J.stop(1,0).remove(),d.each(q.plugins,function(){this.destroy&&this.destroy()
})),clearTimeout(q.timers.show),clearTimeout(q.timers.hide),Z();if(!c||q===c){d.removeData(a,"qtip"),i.suppress&&b&&(d.attr(a,"title",b),h.removeAttr(E)),h.removeAttr("aria-describedby")
}return h.unbind(".qtip-"+j),delete x[q.id],h}})}function J(a,c){var h,i,j,k,l,m=d(this),n=d(b.body),o=this===b?n:m,p=m.metadata?m.metadata(c.metadata):g,q=c.metadata.type==="html5"&&p?p[c.metadata.name]:g,r=m.data(c.metadata.name||"qtipopts");
try{r=typeof r=="string"?d.parseJSON(r):r}catch(s){}k=d.extend(e,{},t.defaults,c,typeof r=="object"?H(r):g,H(q||p)),i=k.position,k.id=a;
if("boolean"==typeof k.content.text){j=m.attr(k.content.attr);if(k.content.attr!==f&&j){k.content.text=j
}else{return f}}i.container.length||(i.container=n),i.target===f&&(i.target=o),k.show.target===f&&(k.show.target=o),k.show.solo===e&&(k.show.solo=i.container.closest("body")),k.hide.target===f&&(k.hide.target=o),k.position.viewport===e&&(k.position.viewport=i.container),i.container=i.container.eq(0),i.at=new u.Corner(i.at),i.my=new u.Corner(i.my);
if(d.data(this,"qtip")){if(k.overwrite){m.qtip("destroy")}else{if(k.overwrite===f){return f}}}return k.suppress&&(l=d.attr(this,"title"))&&d(this).removeAttr("title").attr(E,l).attr("title",""),h=new I(m,k,a,!!j),d.data(this,"qtip",h),m.bind("remove.qtip-"+a+" removeqtip.qtip-"+a,function(){h.destroy()
}),h}function K(a){var b=this,c=a.elements.tooltip,g=a.options.content.ajax,h=t.defaults.content.ajax,i=".qtip-ajax",j=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,k=e,l=f,m;
a.checks.ajax={"^content.ajax":function(a,d,e){d==="ajax"&&(g=e),d==="once"?b.init():g&&g.url?b.load():c.unbind(i)
}},d.extend(b,{init:function(){return g&&g.url&&c.unbind(i)[g.once?"one":"bind"]("tooltipshow"+i,b.load),b
},load:function(c){function r(){var b;if(a.destroyed){return}k=f,p&&(l=e,a.show(c.originalEvent)),(b=h.complete||g.complete)&&d.isFunction(b)&&b.apply(g.context||a,arguments)
}function s(b,c,e){var f;if(a.destroyed){return}o&&"string"==typeof b&&(b=d("<div/>").append(b.replace(j,"")).find(o)),(f=h.success||g.success)&&d.isFunction(f)?f.call(g.context||a,b,c,e):a.set("content.text",b)
}function t(b,c,d){if(a.destroyed||b.status===0){return}a.set("content.text",c+": "+d)}if(l){l=f;return
}var i=g.url.lastIndexOf(" "),n=g.url,o,p=!g.loading&&k;if(p){try{c.preventDefault()}catch(q){}}else{if(c&&c.isDefaultPrevented()){return b
}}m&&m.abort&&m.abort(),i>-1&&(o=n.substr(i),n=n.substr(0,i)),m=d.ajax(d.extend({error:h.error||t,context:a},g,{url:n,success:s,complete:r}))
},destroy:function(){m&&m.abort&&m.abort(),a.destroyed=e}}),b.init()}function L(a,b,c){var d=Math.ceil(b/2),e=Math.ceil(c/2),f={bottomright:[[0,0],[b,c],[b,0]],bottomleft:[[0,0],[b,0],[0,c]],topright:[[0,c],[b,0],[b,c]],topleft:[[0,0],[0,c],[b,c]],topcenter:[[0,c],[d,0],[b,c]],bottomcenter:[[0,0],[b,0],[d,c]],rightcenter:[[0,0],[b,e],[0,c]],leftcenter:[[b,0],[b,c],[0,e]]};
return f.lefttop=f.bottomright,f.righttop=f.bottomleft,f.leftbottom=f.topright,f.rightbottom=f.topleft,f[a.string()]
}function M(a,b){function D(a){var b=v.is(":visible");v.show(),a(),v.toggle(b)}function E(){x.width=r.height,x.height=r.width
}function F(){x.width=r.width,x.height=r.height}function G(b,d,g,j){if(!t.tip){return}var k=q.corner.clone(),u=g.adjusted,v=a.options.position.adjust.method.split(" "),x=v[0],y=v[1]||v[0],z={left:f,top:f,x:0,y:0},A,B={},C;
q.corner.fixed!==e&&(x===s&&k.precedance===h&&u.left&&k.y!==p?k.precedance=k.precedance===h?i:h:x!==s&&u.left&&(k.x=k.x===p?u.left>0?m:o:k.x===m?o:m),y===s&&k.precedance===i&&u.top&&k.x!==p?k.precedance=k.precedance===i?h:i:y!==s&&u.top&&(k.y=k.y===p?u.top>0?l:n:k.y===l?n:l),k.string()!==w.corner.string()&&(w.top!==u.top||w.left!==u.left)&&q.update(k,f)),A=q.position(k,u),A[k.x]+=I(k,k.x),A[k.y]+=I(k,k.y),A.right!==c&&(A.left=-A.right),A.bottom!==c&&(A.top=-A.bottom),A.user=Math.max(0,r.offset);
if(z.left=x===s&&!!u.left){k.x===p?B["margin-left"]=z.x=A["margin-left"]:(C=A.right!==c?[u.left,-A.left]:[-u.left,A.left],(z.x=Math.max(C[0],C[1]))>C[0]&&(g.left-=u.left,z.left=f),B[A.right!==c?o:m]=z.x)
}if(z.top=y===s&&!!u.top){k.y===p?B["margin-top"]=z.y=A["margin-top"]:(C=A.bottom!==c?[u.top,-A.top]:[-u.top,A.top],(z.y=Math.max(C[0],C[1]))>C[0]&&(g.top-=u.top,z.top=f),B[A.bottom!==c?n:l]=z.y)
}t.tip.css(B).toggle(!(z.x&&z.y||k.x===p&&z.y||k.y===p&&z.x)),g.left-=A.left.charAt?A.user:x!==s||z.top||!z.left&&!z.top?A.left:0,g.top-=A.top.charAt?A.user:y!==s||z.left||!z.left&&!z.top?A.top:0,w.left=u.left,w.top=u.top,w.corner=k.clone()
}function H(){var b=r.corner,c=a.options.position,d=c.at,g=c.my.string?c.my.string():c.my;return b===f||g===f&&d===f?f:(b===e?q.corner=new u.Corner(g):b.string||(q.corner=new u.Corner(b),q.corner.fixed=e),w.corner=new u.Corner(q.corner.string()),q.corner.string()!=="centercenter")
}function I(a,b,c){b=b?b:a[a.precedance];var d=t.titlebar&&a.y===l,e=d?t.titlebar:v,f="border-"+b+"-width",g=function(a){return parseInt(a.css(f),10)
},h;return D(function(){h=(c?g(c):g(t.content)||g(e)||g(v))||0}),h}function J(a){var b=t.titlebar&&a.y===l,c=b?t.titlebar:t.content,e=d.browser.mozilla,f=e?"-moz-":d.browser.webkit?"-webkit-":"",g="border-radius-"+a.y+a.x,h="border-"+a.y+"-"+a.x+"-radius",i=function(a){return parseInt(c.css(a),10)||parseInt(v.css(a),10)
},j;return D(function(){j=i(h)||i(f+h)||i(f+g)||i(g)||0}),j}function K(a){function z(a,b,c){var d=a.css(b)||n;
return c&&d===a.css(c)?f:j.test(d)?f:d}var b,c,g,h=t.tip.css("cssText",""),i=a||q.corner,j=/rgba?\(0, 0, 0(, 0)?\)|transparent|#123456/i,k="border-"+i[i.precedance]+"-color",m="background-color",n="transparent",o=" !important",s=t.titlebar,u=s&&(i.y===l||i.y===p&&h.position().top+x.height/2+r.offset<s.outerHeight(e)),w=u?s:t.content;
D(function(){y.fill=z(h,m)||z(w,m)||z(t.content,m)||z(v,m)||h.css(m),y.border=z(h,k,"color")||z(w,k,"color")||z(t.content,k,"color")||z(v,k,"color")||v.css(k),d("*",h).add(h).css("cssText",m+":"+n+o+";border:0"+o+";")
})}function M(a){var b=a.precedance===i,c=x[b?j:k],d=x[b?k:j],e=a.string().indexOf(p)>-1,f=c*(e?0.5:1),g=Math.pow,h=Math.round,l,m,n,o=Math.sqrt(g(f,2)+g(d,2)),q=[z/f*o,z/d*o];
return q[2]=Math.sqrt(g(q[0],2)-g(z,2)),q[3]=Math.sqrt(g(q[1],2)-g(z,2)),l=o+q[2]+q[3]+(e?0:q[0]),m=l/o,n=[h(m*d),h(m*c)],{height:n[b?0:1],width:n[b?1:0]}
}function N(a,b,c){return"<qvml:"+a+' xmlns="urn:schemas-microsoft.com:vml" class="qtip-vml" '+(b||"")+' style="behavior: url(#default#VML); '+(c||"")+'" />'
}var q=this,r=a.options.style.tip,t=a.elements,v=t.tooltip,w={top:0,left:0},x={width:r.width,height:r.height},y={},z=r.border||0,A=".qtip-tip",B=!!(d("<canvas />")[0]||{}).getContext,C;
q.corner=g,q.mimic=g,q.border=z,q.offset=r.offset,q.size=x,a.checks.tip={"^position.my|style.tip.(corner|mimic|border)$":function(){q.init()||q.destroy(),a.reposition()
},"^style.tip.(height|width)$":function(){x={width:r.width,height:r.height},q.create(),q.update(),a.reposition()
},"^content.title.text|style.(classes|widget)$":function(){t.tip&&t.tip.length&&q.update()}},d.extend(q,{init:function(){var a=H()&&(B||d.browser.msie);
return a&&(q.create(),q.update(),v.unbind(A).bind("tooltipmove"+A,G)),a},create:function(){var a=x.width,b=x.height,c;
t.tip&&t.tip.remove(),t.tip=d("<div />",{"class":"qtip-tip"}).css({width:a,height:b}).prependTo(v),B?d("<canvas />").appendTo(t.tip)[0].getContext("2d").save():(c=N("shape",'coordorigin="0,0"',"position:absolute;"),t.tip.html(c+c),d("*",t.tip).bind("click mousedown",function(a){a.stopPropagation()
}))},update:function(a,b){var c=t.tip,j=c.children(),k=x.width,s=x.height,A=r.mimic,C=Math.round,D,G,H,J,O;
a||(a=w.corner||q.corner),A===f?A=a:(A=new u.Corner(A),A.precedance=a.precedance,A.x==="inherit"?A.x=a.x:A.y==="inherit"?A.y=a.y:A.x===A.y&&(A[a.precedance]=a[a.precedance])),D=A.precedance,a.precedance===h?E():F(),t.tip.css({width:k=x.width,height:s=x.height}),K(a),y.border!=="transparent"?(z=I(a,g),r.border===0&&z>0&&(y.fill=y.border),q.border=z=r.border!==e?r.border:z):q.border=z=0,H=L(A,k,s),q.size=O=M(a),c.css(O).css("line-height",O.height+"px"),a.precedance===i?J=[C(A.x===m?z:A.x===o?O.width-k-z:(O.width-k)/2),C(A.y===l?O.height-s:0)]:J=[C(A.x===m?O.width-k:0),C(A.y===l?z:A.y===n?O.height-s-z:(O.height-s)/2)],B?(j.attr(O),G=j[0].getContext("2d"),G.restore(),G.save(),G.clearRect(0,0,3000,3000),G.fillStyle=y.fill,G.strokeStyle=y.border,G.lineWidth=z*2,G.lineJoin="miter",G.miterLimit=100,G.translate(J[0],J[1]),G.beginPath(),G.moveTo(H[0][0],H[0][1]),G.lineTo(H[1][0],H[1][1]),G.lineTo(H[2][0],H[2][1]),G.closePath(),z&&(v.css("background-clip")==="border-box"&&(G.strokeStyle=y.fill,G.stroke()),G.strokeStyle=y.border,G.stroke()),G.fill()):(H="m"+H[0][0]+","+H[0][1]+" l"+H[1][0]+","+H[1][1]+" "+H[2][0]+","+H[2][1]+" xe",J[2]=z&&/^(r|b)/i.test(a.string())?parseFloat(d.browser.version,10)===8?2:1:0,j.css({coordsize:k+z+" "+(s+z),antialias:""+(A.string().indexOf(p)>-1),left:J[0],top:J[1],width:k+z,height:s+z}).each(function(a){var b=d(this);
b[b.prop?"prop":"attr"]({coordsize:k+z+" "+(s+z),path:H,fillcolor:y.fill,filled:!!a,stroked:!a}).toggle(!!z||!!a),!a&&b.html()===""&&b.html(N("stroke",'weight="'+z*2+'px" color="'+y.border+'" miterlimit="1000" joinstyle="miter"'))
})),b!==f&&q.position(a)},position:function(a){var b=t.tip,c={},e=Math.max(0,r.offset),g,n,o;return r.corner===f||!b?f:(a=a||q.corner,g=a.precedance,n=M(a),o=[a.x,a.y],g===h&&o.reverse(),d.each(o,function(b,d){var f,h,o;
d===p?(f=g===i?m:l,c[f]="50%",c["margin-"+f]=-Math.round(n[g===i?j:k]/2)+e):(f=I(a,d),h=I(a,d,t.content),o=J(a),c[d]=b?h:e+(o>f?o:-f))
}),c[a[g]]-=n[g===h?j:k],b.css({top:"",bottom:"",left:"",right:"",margin:""}).css(c),c)},destroy:function(){t.tip&&t.tip.remove(),t.tip=!1,v.unbind(A)
}}),q.init()}function N(c){function s(){q=d(p,j).not("[disabled]").map(function(){return typeof this.focus=="function"?this:null
})}function t(a){q.length<1&&a.length?a.not("body").blur():q.first().focus()}function v(a){var b=d(a.target),c=b.closest(".qtip"),e;
e=c.length<1?f:parseInt(c[0].style.zIndex,10)>parseInt(j[0].style.zIndex,10),!e&&d(a.target).closest(z)[0]!==j[0]&&t(b)
}var g=this,h=c.options.show.modal,i=c.elements,j=i.tooltip,k="#qtip-overlay",l=".qtipmodal",m=l+c.id,n="is-modal-qtip",o=d(b.body),p=u.modal.focusable.join(","),q={},r;
c.checks.modal={"^show.modal.(on|blur)$":function(){g.init(),i.overlay.toggle(j.is(":visible"))},"^content.text$":function(){s()
}},d.extend(g,{init:function(){return h.on?(r=g.create(),j.attr(n,e).css("z-index",u.modal.zindex+d(z+"["+n+"]").length).unbind(l).unbind(m).bind("tooltipshow"+l+" tooltiphide"+l,function(a,b,c){var e=a.originalEvent;
if(a.target===j[0]){if(e&&a.type==="tooltiphide"&&/mouse(leave|enter)/.test(e.type)&&d(e.relatedTarget).closest(r[0]).length){try{a.preventDefault()
}catch(f){}}else{(!e||e&&!e.solo)&&g[a.type.replace("tooltip","")](a,c)}}}).bind("tooltipfocus"+l,function(a){if(a.isDefaultPrevented()||a.target!==j[0]){return
}var b=d(z).filter("["+n+"]"),c=u.modal.zindex+b.length,e=parseInt(j[0].style.zIndex,10);r[0].style.zIndex=c-2,b.each(function(){this.style.zIndex>e&&(this.style.zIndex-=1)
}),b.end().filter("."+B).qtip("blur",a.originalEvent),j.addClass(B)[0].style.zIndex=c;try{a.preventDefault()
}catch(f){}}).bind("tooltiphide"+l,function(a){a.target===j[0]&&d("["+n+"]").filter(":visible").not(j).last().qtip("focus",a)
}),h.escape&&d(b).unbind(m).bind("keydown"+m,function(a){a.keyCode===27&&j.hasClass(B)&&c.hide(a)}),h.blur&&i.overlay.unbind(m).bind("click"+m,function(a){j.hasClass(B)&&c.hide(a)
}),s(),g):g},create:function(){function e(){r.css({height:c.height(),width:c.width()})}var b=d(k),c=d(a);
return b.length?i.overlay=b.insertAfter(d(z).last()):(r=i.overlay=d("<div />",{id:k.substr(1),html:"<div></div>",mousedown:function(){return f
}}).hide().insertAfter(d(z).last()),c.unbind(l).bind("resize"+l,e),e(),r)},toggle:function(a,b,c){if(a&&a.isDefaultPrevented()){return g
}var i=h.effect,k=b?"show":"hide",l=r.is(":visible"),p=d("["+n+"]").filter(":visible").not(j),q;return r||(r=g.create()),r.is(":animated")&&l===b&&r.data("toggleState")!==f||!b&&p.length?g:(b?(r.css({left:0,top:0}),r.toggleClass("blurs",h.blur),h.stealfocus!==f&&(o.bind("focusin"+m,v),t(d("body :focus")))):o.unbind("focusin"+m),r.stop(e,f).data("toggleState",b),d.isFunction(i)?i.call(r,b):i===f?r[k]():r.fadeTo(parseInt(c,10)||90,b?1:0,function(){b||d(this).hide()
}),b||r.queue(function(a){r.css({left:"",top:""}).removeData("toggleState"),a()}),g)},show:function(a,b){return g.toggle(a,e,b)
},hide:function(a,b){return g.toggle(a,f,b)},destroy:function(){var a=r;return a&&(a=d("["+n+"]").not(j).length<1,a?(i.overlay.remove(),d(b).unbind(l)):i.overlay.unbind(l+c.id),o.unbind("focusin"+m)),j.removeAttr(n).unbind(l)
}}),g.init()}function O(c){var g=this,h=c.elements,i=c.options,l=h.tooltip,m=".ie6-"+c.id,n=d("select, object").length<1,o=0,p=f,q;
c.checks.ie6={"^content|style$":function(a,b,c){redraw()}},d.extend(g,{init:function(){var c=d(a),f;n&&(h.bgiframe=d('<iframe class="qtip-bgiframe" frameborder="0" tabindex="-1" src="javascript:\'\';"  style="display:block; position:absolute; z-index:-1; filter:alpha(opacity=0); -ms-filter:"progid:DXImageTransform.Microsoft.Alpha(Opacity=0)";"></iframe>'),h.bgiframe.appendTo(l),l.bind("tooltipmove"+m,g.adjustBGIFrame)),q=d("<div/>",{id:"qtip-rcontainer"}).appendTo(b.body),g.redraw(),h.overlay&&!p&&(f=function(){h.overlay[0].style.top=c.scrollTop()+"px"
},c.bind("scroll.qtip-ie6, resize.qtip-ie6",f),f(),h.overlay.addClass("qtipmodal-ie6fix"),p=e)},adjustBGIFrame:function(){var a=c.get("dimensions"),b=c.plugins.tip,d=h.tip,e,f;
f=parseInt(l.css("border-left-width"),10)||0,f={left:-f,top:-f},b&&d&&(e=b.corner.precedance==="x"?["width","left"]:["height","top"],f[e[1]]-=d[e[0]]()),h.bgiframe.css(f).css(a)
},redraw:function(){if(c.rendered<1||o){return g}var a=i.style,b=i.position.container,d,e,f,h;return o=1,a.height&&l.css(k,a.height),a.width?l.css(j,a.width):(l.css(j,"").appendTo(q),e=l.width(),e%2<1&&(e+=1),f=l.css("max-width")||"",h=l.css("min-width")||"",d=(f+h).indexOf("%")>-1?b.width()/100:0,f=(f.indexOf("%")>-1?d:1)*parseInt(f,10)||e,h=(h.indexOf("%")>-1?d:1)*parseInt(h,10)||0,e=f+h?Math.min(Math.max(e,h),f):e,l.css(j,Math.round(e)).appendTo(b)),o=0,g
},destroy:function(){n&&h.bgiframe.remove(),l.unbind(m)}}),g.init()}var e=!0,f=!1,g=null,h="x",i="y",j="width",k="height",l="top",m="left",n="bottom",o="right",p="center",q="flip",r="flipinvert",s="shift",t,u,v,w="qtip",x={},y=["ui-widget","ui-tooltip"],z="div.qtip."+w,A=w+"-default",B=w+"-focus",C=w+"-hover",D="_replacedByqTip",E="oldtitle",F;
t=d.fn.qtip=function(a,b,h){var i=(""+a).toLowerCase(),j=g,k=d.makeArray(arguments).slice(1),l=k[k.length-1],m=this[0]?d.data(this[0],"qtip"):g;
if(!arguments.length&&m||i==="api"){return m}if("string"==typeof a){return this.each(function(){var a=d.data(this,"qtip");
if(!a){return e}l&&l.timeStamp&&(a.cache.event=l);if(i!=="option"&&i!=="options"||!b){a[i]&&a[i].apply(a[i],k)
}else{if(d.isPlainObject(b)||h!==c){a.set(b,h)}else{return j=a.get(b),f}}}),j!==g?j:this}if("object"==typeof a||!arguments.length){return m=H(d.extend(e,{},a)),t.bind.call(this,m,l)
}},t.bind=function(a,b){return this.each(function(g){function n(a){function b(){l.render(typeof a=="object"||h.show.ready),i.show.add(i.hide).unbind(k)
}if(l.cache.disabled){return f}l.cache.event=d.extend({},a),l.cache.target=a?d(a.target):[c],h.show.delay>0?(clearTimeout(l.timers.show),l.timers.show=setTimeout(b,h.show.delay),j.show!==j.hide&&i.hide.bind(j.hide,function(){clearTimeout(l.timers.show)
})):b()}var h,i,j,k,l,m;m=d.isArray(a.id)?a.id[g]:a.id,m=!m||m===f||m.length<1||x[m]?t.nextid++:x[m]=m,k=".qtip-"+m+"-create",l=J.call(this,m,a);
if(l===f){return e}h=l.options,d.each(u,function(){this.initialize==="initialize"&&this(l)}),i={show:h.show.target,hide:h.hide.target},j={show:d.trim(""+h.show.event).replace(/ /g,k+" ")+k,hide:d.trim(""+h.hide.event).replace(/ /g,k+" ")+k},/mouse(over|enter)/i.test(j.show)&&!/mouse(out|leave)/i.test(j.hide)&&(j.hide+=" mouseleave"+k),i.show.bind("mousemove"+k,function(a){G(a),l.cache.onTarget=e
}),i.show.bind(j.show,n),(h.show.ready||h.prerender)&&n(b)}).attr("data-hasqtip",e)},u=t.plugins={Corner:function(a){a=(""+a).replace(/([A-Z])/," $1").replace(/middle/gi,p).toLowerCase(),this.x=(a.match(/left|right/i)||a.match(/center/)||["inherit"])[0].toLowerCase(),this.y=(a.match(/top|bottom|center/i)||["inherit"])[0].toLowerCase();
var b=a.charAt(0);this.precedance=b==="t"||b==="b"?i:h,this.string=function(){return this.precedance===i?this.y+this.x:this.x+this.y
},this.abbrev=function(){var a=this.x.substr(0,1),b=this.y.substr(0,1);return a===b?a:this.precedance===i?b+a:a+b
},this.invertx=function(a){this.x=this.x===m?o:this.x===o?m:a||this.x},this.inverty=function(a){this.y=this.y===l?n:this.y===n?l:a||this.y
},this.clone=function(){return{x:this.x,y:this.y,precedance:this.precedance,string:this.string,abbrev:this.abbrev,clone:this.clone,invertx:this.invertx,inverty:this.inverty}
}},offset:function(a,c){function l(a,b){e.left+=b*a.scrollLeft(),e.top+=b*a.scrollTop()}var e=a.offset(),f=a.closest("body"),g=d.browser.msie&&b.compatMode!=="CSS1Compat",h=c,i,j,k;
if(h){do{h.css("position")!=="static"&&(j=h.position(),e.left-=j.left+(parseInt(h.css("borderLeftWidth"),10)||0)+(parseInt(h.css("marginLeft"),10)||0),e.top-=j.top+(parseInt(h.css("borderTopWidth"),10)||0)+(parseInt(h.css("marginTop"),10)||0),!i&&(k=h.css("overflow"))!=="hidden"&&k!=="visible"&&(i=h))
}while((h=d(h[0].offsetParent)).length);(i&&i[0]!==f[0]||g)&&l(i||f,1)}return e},iOS:parseFloat((""+(/CPU.*OS ([0-9_]{1,5})|(CPU like).*AppleWebKit.*Mobile/i.exec(navigator.userAgent)||[0,""])[1]).replace("undefined","3_2").replace("_",".").replace("_",""))||f,fn:{attr:function(a,b){if(this.length){var c=this[0],e="title",f=d.data(c,"qtip");
if(a===e&&f&&"object"==typeof f&&f.options.suppress){return arguments.length<2?d.attr(c,E):(f&&f.options.content.attr===e&&f.cache.attr&&f.set("content.text",b),this.attr(E,b))
}}return d.fn["attr"+D].apply(this,arguments)},clone:function(a){var b=d([]),c="title",e=d.fn["clone"+D].apply(this,arguments);
return a||e.filter("["+E+"]").attr("title",function(){return d.attr(this,E)}).removeAttr(E),e}}},d.each(u.fn,function(a,b){if(!b||d.fn[a+D]){return e
}var c=d.fn[a+D]=d.fn[a];d.fn[a]=function(){return b.apply(this,arguments)||c.apply(this,arguments)}}),d.ui||(d["cleanData"+D]=d.cleanData,d.cleanData=function(a){for(var b=0,e;
(e=a[b])!==c;b++){try{d(e).triggerHandler("removeqtip")}catch(f){}}d["cleanData"+D](a)}),t.version="",t.nextid=0,t.inactiveEvents="click dblclick mousedown mouseup mousemove mouseleave mouseenter".split(" "),t.zindex=15000,t.defaults={prerender:f,id:f,overwrite:e,suppress:e,content:{text:e,attr:"title",deferred:f,title:{text:f,button:f}},position:{my:"top left",at:"bottom right",target:f,container:f,viewport:f,adjust:{x:0,y:0,mouse:e,resize:e,method:"flipinvert flipinvert"},effect:function(a,b,c){d(this).animate(b,{duration:200,queue:f})
}},show:{target:f,event:"mouseenter",effect:e,delay:90,solo:f,ready:f,autofocus:f},hide:{target:f,event:"mouseleave",effect:e,delay:0,fixed:f,inactive:f,leave:"window",distance:f},style:{classes:"",widget:f,width:f,height:f,def:e},events:{render:g,move:g,show:g,hide:g,toggle:g,visible:g,hidden:g,focus:g,blur:g}},u.svg=function(a,c,e,f){var g=d(b),h=c[0],i={width:0,height:0,position:{top:10000000000,left:10000000000}},j,k,l,m,n;
while(!h.getBBox){h=h.parentNode}if(h.getBBox&&h.parentNode){j=h.getBBox(),k=h.getScreenCTM(),l=h.farthestViewportElement||h;
if(!l.createSVGPoint){return i}m=l.createSVGPoint(),m.x=j.x,m.y=j.y,n=m.matrixTransform(k),i.position.left=n.x,i.position.top=n.y,m.x+=j.width,m.y+=j.height,n=m.matrixTransform(k),i.width=n.x-i.position.left,i.height=n.y-i.position.top,i.position.left+=g.scrollLeft(),i.position.top+=g.scrollTop()
}return i},u.ajax=function(a){var b=a.plugins.ajax;return"object"==typeof b?b:a.plugins.ajax=new K(a)
},u.ajax.initialize="render",u.ajax.sanitize=function(a){var b=a.content,c;b&&"ajax" in b&&(c=b.ajax,typeof c!="object"&&(c=a.content.ajax={url:c}),"boolean"!=typeof c.once&&c.once&&(c.once=!!c.once))
},d.extend(e,t.defaults,{content:{ajax:{loading:e,once:e}}}),u.tip=function(a){var b=a.plugins.tip;return"object"==typeof b?b:a.plugins.tip=new M(a)
},u.tip.initialize="render",u.tip.sanitize=function(a){var b=a.style,c;b&&"tip" in b&&(c=a.style.tip,typeof c!="object"&&(a.style.tip={corner:c}),/string|boolean/i.test(typeof c.corner)||(c.corner=e),typeof c.width!="number"&&delete c.width,typeof c.height!="number"&&delete c.height,typeof c.border!="number"&&c.border!==e&&delete c.border,typeof c.offset!="number"&&delete c.offset)
},d.extend(e,t.defaults,{style:{tip:{corner:e,mimic:f,width:6,height:6,border:e,offset:0}}}),u.modal=function(a){var b=a.plugins.modal;
return"object"==typeof b?b:a.plugins.modal=new N(a)},u.modal.initialize="render",u.modal.sanitize=function(a){a.show&&(typeof a.show.modal!="object"?a.show.modal={on:!!a.show.modal}:typeof a.show.modal.on=="undefined"&&(a.show.modal.on=e))
},u.modal.zindex=t.zindex-200,u.modal.focusable=["a[href]","area[href]","input","select","textarea","button","iframe","object","embed","[tabindex]","[contenteditable]"],d.extend(e,t.defaults,{show:{modal:{on:f,effect:e,blur:e,stealfocus:e,escape:e}}}),u.viewport=function(c,d,e,f,g,q,t){function L(a,b,c,e,f,g,h,i,j){var k=d[f],l=x[a],m=y[a],n=c===s,o=-E.offset[f]+D.offset[f]+D["scroll"+f],q=l===f?j:l===g?-j:-j/2,t=m===f?i:m===g?-i:-i/2,u=G&&G.size?G.size[h]||0:0,v=G&&G.corner&&G.corner.precedance===a&&!n?u:0,w=o-k+v,z=k+j-D[h]-o+v,A=q-(x.precedance===a||l===x[b]?t:0)-(m===p?i/2:0);
return n?(v=G&&G.corner&&G.corner.precedance===b?u:0,A=(l===f?1:-1)*q-v,d[f]+=w>0?w:z>0?-z:0,d[f]=Math.max(-E.offset[f]+D.offset[f]+(v&&G.corner[a]===p?G.offset:0),k-A,Math.min(Math.max(-E.offset[f]+D.offset[f]+D[h],k+A),d[f]))):(e*=c===r?2:0,w>0&&(l!==f||z>0)?(d[f]-=A+e,J["invert"+a](f)):z>0&&(l!==g||w>0)&&(d[f]-=(l===p?-A:A)+e,J["invert"+a](g)),d[f]<o&&-d[f]>z&&(d[f]=k,J=x.clone())),d[f]-k
}var u=e.target,v=c.elements.tooltip,x=e.my,y=e.at,z=e.adjust,A=z.method.split(" "),B=A[0],C=A[1]||A[0],D=e.viewport,E=e.container,F=c.cache,G=c.plugins.tip,H={left:0,top:0},I,J,K;
if(!D.jquery||u[0]===a||u[0]===b.body||z.method==="none"){return H}I=v.css("position")==="fixed",D={elem:D,height:D[(D[0]===a?"h":"outerH")+"eight"](),width:D[(D[0]===a?"w":"outerW")+"idth"](),scrollleft:I?0:D.scrollLeft(),scrolltop:I?0:D.scrollTop(),offset:D.offset()||{left:0,top:0}},E={elem:E,scrollLeft:E.scrollLeft(),scrollTop:E.scrollTop(),offset:E.offset()||{left:0,top:0}};
if(B!=="shift"||C!=="shift"){J=x.clone()}return H={left:B!=="none"?L(h,i,B,z.x,m,o,j,f,q):0,top:C!=="none"?L(i,h,C,z.y,l,n,k,g,t):0},J&&F.lastClass!==(K=w+"-pos-"+J.abbrev())&&v.removeClass(c.cache.lastClass).addClass(c.cache.lastClass=K),H
},u.imagemap=function(a,b,c,e){function v(a,b,c){var d=0,e=1,f=1,g=0,h=0,i=a.width,j=a.height;while(i>0&&j>0&&e>0&&f>0){i=Math.floor(i/2),j=Math.floor(j/2),c.x===m?e=i:c.x===o?e=a.width-i:e+=Math.floor(i/2),c.y===l?f=j:c.y===n?f=a.height-j:f+=Math.floor(j/2),d=b.length;
while(d--){if(b.length<2){break}g=b[d][0]-a.position.left,h=b[d][1]-a.position.top,(c.x===m&&g>=e||c.x===o&&g<=e||c.x===p&&(g<e||g>a.width-e)||c.y===l&&h>=f||c.y===n&&h<=f||c.y===p&&(h<f||h>a.height-f))&&b.splice(d,1)
}}return{left:b[0][0],top:b[0][1]}}b.jquery||(b=d(b));var f=a.cache.areas={},g=(b[0].shape||b.attr("shape")).toLowerCase(),h=b[0].coords||b.attr("coords"),i=h.split(","),j=[],k=d('img[usemap="#'+b.parent("map").attr("name")+'"]'),q=k.offset(),r={width:0,height:0,position:{top:10000000000,right:0,bottom:0,left:10000000000}},s=0,t=0,u;
q.left+=Math.ceil((k.outerWidth()-k.width())/2),q.top+=Math.ceil((k.outerHeight()-k.height())/2);if(g==="poly"){s=i.length;
while(s--){t=[parseInt(i[--s],10),parseInt(i[s+1],10)],t[0]>r.position.right&&(r.position.right=t[0]),t[0]<r.position.left&&(r.position.left=t[0]),t[1]>r.position.bottom&&(r.position.bottom=t[1]),t[1]<r.position.top&&(r.position.top=t[1]),j.push(t)
}}else{s=-1;while(s++<i.length){j.push(parseInt(i[s],10))}}switch(g){case"rect":r={width:Math.abs(j[2]-j[0]),height:Math.abs(j[3]-j[1]),position:{left:Math.min(j[0],j[2]),top:Math.min(j[1],j[3])}};
break;case"circle":r={width:j[2]+2,height:j[2]+2,position:{left:j[0],top:j[1]}};break;case"poly":r.width=Math.abs(r.position.right-r.position.left),r.height=Math.abs(r.position.bottom-r.position.top),c.abbrev()==="c"?r.position={left:r.position.left+r.width/2,top:r.position.top+r.height/2}:(f[c+h]||(r.position=v(r,j.slice(),c),e&&(e[0]==="flip"||e[1]==="flip")&&(r.offset=v(r,j.slice(),{x:c.x===m?o:c.x===o?m:p,y:c.y===l?n:c.y===n?l:p}),r.offset.left-=r.position.left,r.offset.top-=r.position.top),f[c+h]=r),r=f[c+h]),r.width=r.height=0
}return r.position.left+=q.left,r.position.top+=q.top,r},u.ie6=function(a){var b=d.browser,c=a.plugins.ie6;
return !b.msie||(""+b.version).charAt(0)!=="6"?f:"object"==typeof c?c:a.plugins.ie6=new O(a)},u.ie6.initialize="render"
})})(window,document);(function(){this.MooTools={version:"1.4.5",build:"ab8ea8824dc3b24b6666867a2c4ed58ebb762cf0"};
var o=this.typeOf=function(i){if(i==null){return"null"}if(i.$family!=null){return i.$family()}if(i.nodeName){if(i.nodeType==1){return"element"
}if(i.nodeType==3){return(/\S/).test(i.nodeValue)?"textnode":"whitespace"}}else{if(typeof i.length=="number"){if(i.callee){return"arguments"
}if("item" in i){return"collection"}}}return typeof i};var j=this.instanceOf=function(t,i){if(t==null){return false
}var s=t.$constructor||t.constructor;while(s){if(s===i){return true}s=s.parent}if(!t.hasOwnProperty){return false
}return t instanceof i};var f=this.Function;var p=true;for(var k in {toString:1}){p=null}if(p){p=["hasOwnProperty","valueOf","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","constructor"]
}f.prototype.overloadSetter=function(s){var i=this;return function(u,t){if(u==null){return this}if(s||typeof u!="string"){for(var v in u){i.call(this,v,u[v])
}if(p){for(var w=p.length;w--;){v=p[w];if(u.hasOwnProperty(v)){i.call(this,v,u[v])}}}}else{i.call(this,u,t)
}return this}};f.prototype.overloadGetter=function(s){var i=this;return function(u){var v,t;if(typeof u!="string"){v=u
}else{if(arguments.length>1){v=arguments}else{if(s){v=[u]}}}if(v){t={};for(var w=0;w<v.length;w++){t[v[w]]=i.call(this,v[w])
}}else{t=i.call(this,u)}return t}};f.prototype.extend=function(i,s){this[i]=s}.overloadSetter();f.prototype.implement=function(i,s){this.prototype[i]=s
}.overloadSetter();var n=Array.prototype.slice;f.from=function(i){return(o(i)=="function")?i:function(){return i
}};Array.from=function(i){if(i==null){return[]}return(a.isEnumerable(i)&&typeof i!="string")?(o(i)=="array")?i:n.call(i):[i]
};Number.from=function(s){var i=parseFloat(s);return isFinite(i)?i:null};String.from=function(i){return i+""
};f.implement({hide:function(){this.$hidden=true;return this},protect:function(){this.$protected=true;
return this}});var a=this.Type=function(u,t){if(u){var s=u.toLowerCase();var i=function(v){return(o(v)==s)
};a["is"+u]=i;if(t!=null){t.prototype.$family=(function(){return s}).hide()}}if(t==null){return null}t.extend(this);
t.$constructor=a;t.prototype.$constructor=t;return t};var e=Object.prototype.toString;a.isEnumerable=function(i){return(i!=null&&typeof i.length=="number"&&e.call(i)!="[object Function]")
};var q={};var r=function(i){var s=o(i.prototype);return q[s]||(q[s]=[])};var b=function(t,x){if(x&&x.$hidden){return
}var s=r(this);for(var u=0;u<s.length;u++){var w=s[u];if(o(w)=="type"){b.call(w,t,x)}else{w.call(this,t,x)
}}var v=this.prototype[t];if(v==null||!v.$protected){this.prototype[t]=x}if(this[t]==null&&o(x)=="function"){m.call(this,t,function(i){return x.apply(i,n.call(arguments,1))
})}};var m=function(i,t){if(t&&t.$hidden){return}var s=this[i];if(s==null||!s.$protected){this[i]=t}};
a.implement({implement:b.overloadSetter(),extend:m.overloadSetter(),alias:function(i,s){b.call(this,i,this.prototype[s])
}.overloadSetter(),mirror:function(i){r(this).push(i);return this}});new a("Type",a);var d=function(s,x,v){var u=(x!=Object),B=x.prototype;
if(u){x=new a(s,x)}for(var y=0,w=v.length;y<w;y++){var C=v[y],A=x[C],z=B[C];if(A){A.protect()}if(u&&z){x.implement(C,z.protect())
}}if(u){var t=B.propertyIsEnumerable(v[0]);x.forEachMethod=function(G){if(!t){for(var F=0,D=v.length;
F<D;F++){G.call(B,B[v[F]],v[F])}}for(var E in B){G.call(B,B[E],E)}}}return d};d("String",String,["charAt","charCodeAt","concat","indexOf","lastIndexOf","match","quote","replace","search","slice","split","substr","substring","trim","toLowerCase","toUpperCase"])("Array",Array,["pop","push","reverse","shift","sort","splice","unshift","concat","join","slice","indexOf","lastIndexOf","filter","forEach","every","map","some","reduce","reduceRight"])("Number",Number,["toExponential","toFixed","toLocaleString","toPrecision"])("Function",f,["apply","call","bind"])("RegExp",RegExp,["exec","test"])("Object",Object,["create","defineProperty","defineProperties","keys","getPrototypeOf","getOwnPropertyDescriptor","getOwnPropertyNames","preventExtensions","isExtensible","seal","isSealed","freeze","isFrozen"])("Date",Date,["now"]);
Object.extend=m.overloadSetter();Date.extend("now",function(){return +(new Date)});new a("Boolean",Boolean);
Number.prototype.$family=function(){return isFinite(this)?"number":"null"}.hide();Number.extend("random",function(s,i){return Math.floor(Math.random()*(i-s+1)+s)
});var g=Object.prototype.hasOwnProperty;Object.extend("forEach",function(i,t,u){for(var s in i){if(g.call(i,s)){t.call(u,i[s],s,i)
}}});Object.each=Object.forEach;Array.implement({forEach:function(u,v){for(var t=0,s=this.length;t<s;
t++){if(t in this){u.call(v,this[t],t,this)}}},each:function(i,s){Array.forEach(this,i,s);return this
}});var l=function(i){switch(o(i)){case"array":return i.clone();case"object":return Object.clone(i);default:return i
}};Array.implement("clone",function(){var s=this.length,t=new Array(s);while(s--){t[s]=l(this[s])}return t
});var h=function(s,i,t){switch(o(t)){case"object":if(o(s[i])=="object"){Object.merge(s[i],t)}else{s[i]=Object.clone(t)
}break;case"array":s[i]=t.clone();break;default:s[i]=t}return s};Object.extend({merge:function(z,u,t){if(o(u)=="string"){return h(z,u,t)
}for(var y=1,s=arguments.length;y<s;y++){var w=arguments[y];for(var x in w){h(z,x,w[x])}}return z},clone:function(i){var t={};
for(var s in i){t[s]=l(i[s])}return t},append:function(w){for(var v=1,t=arguments.length;v<t;v++){var s=arguments[v]||{};
for(var u in s){w[u]=s[u]}}return w}});["Object","WhiteSpace","TextNode","Collection","Arguments"].each(function(i){new a(i)
});var c=Date.now();String.extend("uniqueID",function(){return(c++).toString(36)})})();Array.implement({every:function(c,d){for(var b=0,a=this.length>>>0;
b<a;b++){if((b in this)&&!c.call(d,this[b],b,this)){return false}}return true},filter:function(d,f){var c=[];
for(var e,b=0,a=this.length>>>0;b<a;b++){if(b in this){e=this[b];if(d.call(f,e,b,this)){c.push(e)}}}return c
},indexOf:function(c,d){var b=this.length>>>0;for(var a=(d<0)?Math.max(0,b+d):d||0;a<b;a++){if(this[a]===c){return a
}}return -1},map:function(c,e){var d=this.length>>>0,b=Array(d);for(var a=0;a<d;a++){if(a in this){b[a]=c.call(e,this[a],a,this)
}}return b},some:function(c,d){for(var b=0,a=this.length>>>0;b<a;b++){if((b in this)&&c.call(d,this[b],b,this)){return true
}}return false},clean:function(){return this.filter(function(a){return a!=null})},invoke:function(a){var b=Array.slice(arguments,1);
return this.map(function(c){return c[a].apply(c,b)})},associate:function(c){var d={},b=Math.min(this.length,c.length);
for(var a=0;a<b;a++){d[c[a]]=this[a]}return d},link:function(c){var a={};for(var e=0,b=this.length;e<b;
e++){for(var d in c){if(c[d](this[e])){a[d]=this[e];delete c[d];break}}}return a},contains:function(a,b){return this.indexOf(a,b)!=-1
},append:function(a){this.push.apply(this,a);return this},getLast:function(){return(this.length)?this[this.length-1]:null
},getRandom:function(){return(this.length)?this[Number.random(0,this.length-1)]:null},include:function(a){if(!this.contains(a)){this.push(a)
}return this},combine:function(c){for(var b=0,a=c.length;b<a;b++){this.include(c[b])}return this},erase:function(b){for(var a=this.length;
a--;){if(this[a]===b){this.splice(a,1)}}return this},empty:function(){this.length=0;return this},flatten:function(){var d=[];
for(var b=0,a=this.length;b<a;b++){var c=typeOf(this[b]);if(c=="null"){continue}d=d.concat((c=="array"||c=="collection"||c=="arguments"||instanceOf(this[b],Array))?Array.flatten(this[b]):this[b])
}return d},pick:function(){for(var b=0,a=this.length;b<a;b++){if(this[b]!=null){return this[b]}}return null
},hexToRgb:function(b){if(this.length!=3){return null}var a=this.map(function(c){if(c.length==1){c+=c
}return c.toInt(16)});return(b)?a:"rgb("+a+")"},rgbToHex:function(d){if(this.length<3){return null}if(this.length==4&&this[3]==0&&!d){return"transparent"
}var b=[];for(var a=0;a<3;a++){var c=(this[a]-0).toString(16);b.push((c.length==1)?"0"+c:c)}return(d)?b:"#"+b.join("")
}});String.implement({test:function(a,b){return((typeOf(a)=="regexp")?a:new RegExp(""+a,b)).test(this)
},contains:function(a,b){return(b)?(b+this+b).indexOf(b+a+b)>-1:String(this).indexOf(a)>-1},trim:function(){return String(this).replace(/^\s+|\s+$/g,"")
},clean:function(){return String(this).replace(/\s+/g," ").trim()},camelCase:function(){return String(this).replace(/-\D/g,function(a){return a.charAt(1).toUpperCase()
})},hyphenate:function(){return String(this).replace(/[A-Z]/g,function(a){return("-"+a.charAt(0).toLowerCase())
})},capitalize:function(){return String(this).replace(/\b[a-z]/g,function(a){return a.toUpperCase()})
},escapeRegExp:function(){return String(this).replace(/([-.*+?^${}()|[\]\/\\])/g,"\\$1")},toInt:function(a){return parseInt(this,a||10)
},toFloat:function(){return parseFloat(this)},hexToRgb:function(b){var a=String(this).match(/^#?(\w{1,2})(\w{1,2})(\w{1,2})$/);
return(a)?a.slice(1).hexToRgb(b):null},rgbToHex:function(b){var a=String(this).match(/\d{1,3}/g);return(a)?a.rgbToHex(b):null
},substitute:function(a,b){return String(this).replace(b||(/\\?\{([^{}]+)\}/g),function(d,c){if(d.charAt(0)=="\\"){return d.slice(1)
}return(a[c]!=null)?a[c]:""})}});Number.implement({limit:function(b,a){return Math.min(a,Math.max(b,this))
},round:function(a){a=Math.pow(10,a||0).toFixed(a<0?-a:0);return Math.round(this*a)/a},times:function(b,c){for(var a=0;
a<this;a++){b.call(c,a,this)}},toFloat:function(){return parseFloat(this)},toInt:function(a){return parseInt(this,a||10)
}});Number.alias("each","times");(function(b){var a={};b.each(function(c){if(!Number[c]){a[c]=function(){return Math[c].apply(null,[this].concat(Array.from(arguments)))
}}});Number.implement(a)})(["abs","acos","asin","atan","atan2","ceil","cos","exp","floor","log","max","min","pow","sin","sqrt","tan"]);
Function.extend({attempt:function(){for(var b=0,a=arguments.length;b<a;b++){try{return arguments[b]()
}catch(c){}}return null}});Function.implement({attempt:function(a,c){try{return this.apply(c,Array.from(a))
}catch(b){}return null},bind:function(e){var a=this,b=arguments.length>1?Array.slice(arguments,1):null,d=function(){};
var c=function(){var g=e,h=arguments.length;if(this instanceof c){d.prototype=a.prototype;g=new d}var f=(!b&&!h)?a.call(g):a.apply(g,b&&h?b.concat(Array.slice(arguments)):b||arguments);
return g==e?f:g};return c},pass:function(b,c){var a=this;if(b!=null){b=Array.from(b)}return function(){return a.apply(c,b||arguments)
}},delay:function(b,c,a){return setTimeout(this.pass((a==null?[]:a),c),b)},periodical:function(c,b,a){return setInterval(this.pass((a==null?[]:a),b),c)
}});(function(){var a=Object.prototype.hasOwnProperty;Object.extend({subset:function(d,g){var f={};for(var e=0,b=g.length;
e<b;e++){var c=g[e];if(c in d){f[c]=d[c]}}return f},map:function(b,e,f){var d={};for(var c in b){if(a.call(b,c)){d[c]=e.call(f,b[c],c,b)
}}return d},filter:function(b,e,g){var d={};for(var c in b){var f=b[c];if(a.call(b,c)&&e.call(g,f,c,b)){d[c]=f
}}return d},every:function(b,d,e){for(var c in b){if(a.call(b,c)&&!d.call(e,b[c],c)){return false}}return true
},some:function(b,d,e){for(var c in b){if(a.call(b,c)&&d.call(e,b[c],c)){return true}}return false},keys:function(b){var d=[];
for(var c in b){if(a.call(b,c)){d.push(c)}}return d},values:function(c){var b=[];for(var d in c){if(a.call(c,d)){b.push(c[d])
}}return b},getLength:function(b){return Object.keys(b).length},keyOf:function(b,d){for(var c in b){if(a.call(b,c)&&b[c]===d){return c
}}return null},contains:function(b,c){return Object.keyOf(b,c)!=null},toQueryString:function(b,c){var d=[];
Object.each(b,function(h,g){if(c){g=c+"["+g+"]"}var f;switch(typeOf(h)){case"object":f=Object.toQueryString(h,g);
break;case"array":var e={};h.each(function(k,j){e[j]=k});f=Object.toQueryString(e,g);break;default:f=g+"="+encodeURIComponent(h)
}if(h!=null){d.push(f)}});return d.join("&")}})})();(function(){var j=this.document;var g=j.window=this;
var a=navigator.userAgent.toLowerCase(),b=navigator.platform.toLowerCase(),h=a.match(/(opera|ie|firefox|chrome|version)[\s\/:]([\w\d\.]+)?.*?(safari|version[\s\/:]([\w\d\.]+)|$)/)||[null,"unknown",0],d=h[1]=="ie"&&j.documentMode;
var n=this.Browser={extend:Function.prototype.extend,name:(h[1]=="version")?h[3]:h[1],version:d||parseFloat((h[1]=="opera"&&h[4])?h[4]:h[2]),Platform:{name:a.match(/ip(?:ad|od|hone)/)?"ios":(a.match(/(?:webos|android)/)||b.match(/mac|win|linux/)||["other"])[0]},Features:{xpath:!!(j.evaluate),air:!!(g.runtime),query:!!(j.querySelector),json:!!(g.JSON)},Plugins:{}};
n[n.name]=true;n[n.name+parseInt(n.version,10)]=true;n.Platform[n.Platform.name]=true;n.Request=(function(){var p=function(){return new XMLHttpRequest()
};var o=function(){return new ActiveXObject("MSXML2.XMLHTTP")};var e=function(){return new ActiveXObject("Microsoft.XMLHTTP")
};return Function.attempt(function(){p();return p},function(){o();return o},function(){e();return e})
})();n.Features.xhr=!!(n.Request);var i=(Function.attempt(function(){return navigator.plugins["Shockwave Flash"].description
},function(){return new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")})||"0 r0").match(/\d+/g);
n.Plugins.Flash={version:Number(i[0]||"0."+i[1])||0,build:Number(i[2])||0};n.exec=function(o){if(!o){return o
}if(g.execScript){g.execScript(o)}else{var e=j.createElement("script");e.setAttribute("type","text/javascript");
e.text=o;j.head.appendChild(e);j.head.removeChild(e)}return o};String.implement("stripScripts",function(o){var e="";
var p=this.replace(/<script[^>]*>([\s\S]*?)<\/script>/gi,function(q,r){e+=r+"\n";return""});if(o===true){n.exec(e)
}else{if(typeOf(o)=="function"){o(e,p)}}return p});n.extend({Document:this.Document,Window:this.Window,Element:this.Element,Event:this.Event});
this.Window=this.$constructor=new Type("Window",function(){});this.$family=Function.from("window").hide();
Window.mirror(function(e,o){g[e]=o});this.Document=j.$constructor=new Type("Document",function(){});j.$family=Function.from("document").hide();
Document.mirror(function(e,o){j[e]=o});j.html=j.documentElement;if(!j.head){j.head=j.getElementsByTagName("head")[0]
}if(j.execCommand){try{j.execCommand("BackgroundImageCache",false,true)}catch(f){}}if(this.attachEvent&&!this.addEventListener){var c=function(){this.detachEvent("onunload",c);
j.head=j.html=j.window=null};this.attachEvent("onunload",c)}var l=Array.from;try{l(j.html.childNodes)
}catch(f){Array.from=function(o){if(typeof o!="string"&&Type.isEnumerable(o)&&typeOf(o)!="array"){var e=o.length,p=new Array(e);
while(e--){p[e]=o[e]}return p}return l(o)};var k=Array.prototype,m=k.slice;["pop","push","reverse","shift","sort","splice","unshift","concat","join","slice"].each(function(e){var o=k[e];
Array[e]=function(p){return o.apply(Array.from(p),m.call(arguments,1))}})}})();(function(){var a=this.Class=new Type("Class",function(h){if(instanceOf(h,Function)){h={initialize:h}
}var g=function(){e(this);if(g.$prototyping){return this}this.$caller=null;var i=(this.initialize)?this.initialize.apply(this,arguments):this;
this.$caller=this.caller=null;return i}.extend(this).implement(h);g.$constructor=a;g.prototype.$constructor=g;
g.prototype.parent=c;return g});var c=function(){if(!this.$caller){throw new Error('The method "parent" cannot be called.')
}var g=this.$caller.$name,h=this.$caller.$owner.parent,i=(h)?h.prototype[g]:null;if(!i){throw new Error('The method "'+g+'" has no parent.')
}return i.apply(this,arguments)};var e=function(g){for(var h in g){var j=g[h];switch(typeOf(j)){case"object":var i=function(){};
i.prototype=j;g[h]=e(new i);break;case"array":g[h]=j.clone();break}}return g};var b=function(g,h,j){if(j.$origin){j=j.$origin
}var i=function(){if(j.$protected&&this.$caller==null){throw new Error('The method "'+h+'" cannot be called.')
}var l=this.caller,m=this.$caller;this.caller=m;this.$caller=i;var k=j.apply(this,arguments);this.$caller=m;
this.caller=l;return k}.extend({$owner:g,$origin:j,$name:h});return i};var f=function(h,i,g){if(a.Mutators.hasOwnProperty(h)){i=a.Mutators[h].call(this,i);
if(i==null){return this}}if(typeOf(i)=="function"){if(i.$hidden){return this}this.prototype[h]=(g)?i:b(this,h,i)
}else{Object.merge(this.prototype,h,i)}return this};var d=function(g){g.$prototyping=true;var h=new g;
delete g.$prototyping;return h};a.implement("implement",f.overloadSetter());a.Mutators={Extends:function(g){this.parent=g;
this.prototype=d(g)},Implements:function(g){Array.from(g).each(function(j){var h=new j;for(var i in h){f.call(this,i,h[i],true)
}},this)}}})();(function(){this.Chain=new Class({$chain:[],chain:function(){this.$chain.append(Array.flatten(arguments));
return this},callChain:function(){return(this.$chain.length)?this.$chain.shift().apply(this,arguments):false
},clearChain:function(){this.$chain.empty();return this}});var a=function(b){return b.replace(/^on([A-Z])/,function(c,d){return d.toLowerCase()
})};this.Events=new Class({$events:{},addEvent:function(d,c,b){d=a(d);this.$events[d]=(this.$events[d]||[]).include(c);
if(b){c.internal=true}return this},addEvents:function(b){for(var c in b){this.addEvent(c,b[c])}return this
},fireEvent:function(e,c,b){e=a(e);var d=this.$events[e];if(!d){return this}c=Array.from(c);d.each(function(f){if(b){f.delay(b,this,c)
}else{f.apply(this,c)}},this);return this},removeEvent:function(e,d){e=a(e);var c=this.$events[e];if(c&&!d.internal){var b=c.indexOf(d);
if(b!=-1){delete c[b]}}return this},removeEvents:function(d){var e;if(typeOf(d)=="object"){for(e in d){this.removeEvent(e,d[e])
}return this}if(d){d=a(d)}for(e in this.$events){if(d&&d!=e){continue}var c=this.$events[e];for(var b=c.length;
b--;){if(b in c){this.removeEvent(e,c[b])}}}return this}});this.Options=new Class({setOptions:function(){var b=this.options=Object.merge.apply(null,[{},this.options].append(arguments));
if(this.addEvent){for(var c in b){if(typeOf(b[c])!="function"||!(/^on[A-Z]/).test(c)){continue}this.addEvent(c,b[c]);
delete b[c]}}return this}})})();
/*!
 * Tinycon - A small library for manipulating the Favicon
 * Tom Moor, http://tommoor.com
 * Copyright (c) 2012 Tom Moor
 * MIT Licensed
 * @version 0.5
*/
(function(){var Tinycon={};
var currentFavicon=null;var originalFavicon=null;var originalTitle=document.title;var canvas=null;var options={};
var defaults={width:7,height:9,font:"10px Arial, Verdana, sans-serif",colour:"#ffffff",background:"#F03D25",fallback:true,abbreviate:true};
var ua=(function(){var agent=navigator.userAgent.toLowerCase();return function(browser){return agent.indexOf(browser)!==-1
}}());var browser={ie:ua("msie"),chrome:ua("chrome"),webkit:ua("chrome")||ua("safari"),safari:ua("safari")&&!ua("chrome"),mozilla:ua("mozilla")&&!ua("chrome")&&!ua("safari")};
var getFaviconTag=function(){var links=document.getElementsByTagName("link");for(var i=0,len=links.length;
i<len;i++){if((links[i].getAttribute("rel")||"").match(/\bicon\b/)){return links[i]}}return false};var removeFaviconTag=function(){var links=document.getElementsByTagName("link");
var head=document.getElementsByTagName("head")[0];for(var i=0,len=links.length;i<len;i++){var exists=(typeof(links[i])!=="undefined");
if(exists&&(links[i].getAttribute("rel")||"").match(/\bicon\b/)){head.removeChild(links[i])}}};var getCurrentFavicon=function(){if(!originalFavicon||!currentFavicon){var tag=getFaviconTag();
originalFavicon=currentFavicon=tag?tag.getAttribute("href"):"/favicon.ico"}return currentFavicon};var getCanvas=function(){if(!canvas){canvas=document.createElement("canvas");
canvas.width=16;canvas.height=16}return canvas};var setFaviconTag=function(url){if(!$.browser.webkit){removeFaviconTag()
}var link=document.getElementById("custom_favicon");if(!link){link=document.createElement("link");link.type="image/x-icon";
link.rel="icon";link.id="custom_favicon";document.getElementsByTagName("head")[0].appendChild(link)}link.href=url
};var log=function(message){if(window.console){window.console.log(message)}};var drawFavicon=function(label,colour){if(!getCanvas().getContext||browser.ie||browser.safari||options.fallback==="force"){return updateTitle(label)
}var context=getCanvas().getContext("2d");var colour=colour||"#000000";var src=getCurrentFavicon();var faviconImage=new Image();
faviconImage.onload=function(){context.clearRect(0,0,16,16);context.drawImage(faviconImage,0,0,faviconImage.width,faviconImage.height,0,0,16,16);
if((label+"").length>0){drawBubble(context,label,colour)}refreshFavicon()};if(!src.match(/^data/)){faviconImage.crossOrigin="anonymous"
}faviconImage.src=src};var updateTitle=function(label){if(options.fallback){if((label+"").length>0){document.title="("+label+") "+originalTitle
}else{document.title=originalTitle}}};var drawBubble=function(context,label,colour){if(typeof label=="number"&&label>99&&options.abbreviate){label=abbreviateNumber(label)
}var len=(label+"").length-1;var width=options.width+(6*len);var w=16-width;var h=16-options.height;context.font=(browser.webkit?"bold ":"")+options.font;
context.fillStyle=options.background;context.strokeStyle=options.background;context.lineWidth=1;context.fillRect(w,h,width-1,options.height);
context.beginPath();context.moveTo(w-0.5,h+1);context.lineTo(w-0.5,15);context.stroke();context.beginPath();
context.moveTo(15.5,h+1);context.lineTo(15.5,15);context.stroke();context.beginPath();context.strokeStyle="rgba(0,0,0,0.3)";
context.moveTo(w,16);context.lineTo(15,16);context.stroke();context.fillStyle=options.colour;context.textAlign="right";
context.textBaseline="top";context.fillText(label,15,browser.mozilla?7:6)};var refreshFavicon=function(){if(!getCanvas().getContext){return
}setFaviconTag(getCanvas().toDataURL())};var abbreviateNumber=function(label){var metricPrefixes=[["G",1000000000],["M",1000000],["k",1000]];
for(var i=0;i<metricPrefixes.length;++i){if(label>=metricPrefixes[i][1]){label=round(label/metricPrefixes[i][1])+metricPrefixes[i][0];
break}}return label};var round=function(value,precision){var number=new Number(value);return number.toFixed(precision)
};Tinycon.setOptions=function(custom){options={};for(var key in defaults){options[key]=custom.hasOwnProperty(key)?custom[key]:defaults[key]
}return this};Tinycon.setImage=function(url){currentFavicon=url;refreshFavicon();return this};Tinycon.setBubble=function(label,colour){label=label||"";
drawFavicon(label,colour);return this};Tinycon.reset=function(){setFaviconTag(originalFavicon)};Tinycon.setOptions(defaults);
window.Tinycon=Tinycon})();(function($){if(typeof $.fn.each2=="undefined"){$.fn.extend({each2:function(c){var j=$([0]),i=-1,l=this.length;
while(++i<l&&(j.context=j[0]=this[i])&&c.call(j[0],i,j)!==false){}return this}})}})(jQuery);(function($,undefined){if(window.Select2!==undefined){return
}var KEY,AbstractSelect2,SingleSelect2,MultiSelect2,nextUid,sizer,lastMousePosition,$document,scrollBarDimensions,KEY={TAB:9,ENTER:13,ESC:27,SPACE:32,LEFT:37,UP:38,RIGHT:39,DOWN:40,SHIFT:16,CTRL:17,ALT:18,PAGE_UP:33,PAGE_DOWN:34,HOME:36,END:35,BACKSPACE:8,DELETE:46,isArrow:function(k){k=k.which?k.which:k;
switch(k){case KEY.LEFT:case KEY.RIGHT:case KEY.UP:case KEY.DOWN:return true}return false},isControl:function(e){var k=e.which;
switch(k){case KEY.SHIFT:case KEY.CTRL:case KEY.ALT:return true}if(e.metaKey){return true}return false
},isFunctionKey:function(k){k=k.which?k.which:k;return k>=112&&k<=123}},MEASURE_SCROLLBAR_TEMPLATE="<div class='select2-measure-scrollbar'></div>";
$document=$(document);nextUid=(function(){var counter=1;return function(){return counter++}}());function indexOf(value,array){var i=0,l=array.length;
for(;i<l;i=i+1){if(equal(value,array[i])){return i}}return -1}function measureScrollbar(){var $template=$(MEASURE_SCROLLBAR_TEMPLATE);
$template.appendTo("body");var dim={width:$template.width()-$template[0].clientWidth,height:$template.height()-$template[0].clientHeight};
$template.remove();return dim}function equal(a,b){if(a===b){return true}if(a===undefined||b===undefined){return false
}if(a===null||b===null){return false}if(a.constructor===String){return a+""===b+""}if(b.constructor===String){return b+""===a+""
}return false}function splitVal(string,separator){var val,i,l;if(string===null||string.length<1){return[]
}val=string.split(separator);for(i=0,l=val.length;i<l;i=i+1){val[i]=$.trim(val[i])}return val}function getSideBorderPadding(element){return element.outerWidth(false)-element.width()
}function installKeyUpChangeEvent(element){var key="keyup-change-value";element.on("keydown",function(){if($.data(element,key)===undefined){$.data(element,key,element.val())
}});element.on("keyup",function(){var val=$.data(element,key);if(val!==undefined&&element.val()!==val){$.removeData(element,key);
element.trigger("keyup-change")}})}$document.on("mousemove",function(e){lastMousePosition={x:e.pageX,y:e.pageY}
});function installFilteredMouseMove(element){element.on("mousemove",function(e){var lastpos=lastMousePosition;
if(lastpos===undefined||lastpos.x!==e.pageX||lastpos.y!==e.pageY){$(e.target).trigger("mousemove-filtered",e)
}})}function debounce(quietMillis,fn,ctx){ctx=ctx||undefined;var timeout;return function(){var args=arguments;
window.clearTimeout(timeout);timeout=window.setTimeout(function(){fn.apply(ctx,args)},quietMillis)}}function thunk(formula){var evaluated=false,value;
return function(){if(evaluated===false){value=formula();evaluated=true}return value}}function installDebouncedScroll(threshold,element){var notify=debounce(threshold,function(e){element.trigger("scroll-debounced",e)
});element.on("scroll",function(e){if(indexOf(e.target,element.get())>=0){notify(e)}})}function focus($el){if($el[0]===document.activeElement){return
}window.setTimeout(function(){var el=$el[0],pos=$el.val().length,range;$el.focus();if($el.is(":visible")&&el===document.activeElement){if(el.setSelectionRange){el.setSelectionRange(pos,pos)
}else{if(el.createTextRange){range=el.createTextRange();range.collapse(false);range.select()}}}},0)}function getCursorInfo(el){el=$(el)[0];
var offset=0;var length=0;if("selectionStart" in el){offset=el.selectionStart;length=el.selectionEnd-offset
}else{if("selection" in document){el.focus();var sel=document.selection.createRange();length=document.selection.createRange().text.length;
sel.moveStart("character",-el.value.length);offset=sel.text.length-length}}return{offset:offset,length:length}
}function killEvent(event){event.preventDefault();event.stopPropagation()}function killEventImmediately(event){event.preventDefault();
event.stopImmediatePropagation()}function measureTextWidth(e){if(!sizer){var style=e[0].currentStyle||window.getComputedStyle(e[0],null);
sizer=$(document.createElement("div")).css({position:"absolute",left:"-10000px",top:"-10000px",display:"none",fontSize:style.fontSize,fontFamily:style.fontFamily,fontStyle:style.fontStyle,fontWeight:style.fontWeight,letterSpacing:style.letterSpacing,textTransform:style.textTransform,whiteSpace:"nowrap"});
sizer.attr("class","select2-sizer");$("body").append(sizer)}sizer.text(e.val());return sizer.width()}function syncCssClasses(dest,src,adapter){var classes,replacements=[],adapted;
classes=dest.attr("class");if(classes){classes=""+classes;$(classes.split(" ")).each2(function(){if(this.indexOf("select2-")===0){replacements.push(this)
}})}classes=src.attr("class");if(classes){classes=""+classes;$(classes.split(" ")).each2(function(){if(this.indexOf("select2-")!==0){adapted=adapter(this);
if(adapted){replacements.push(this)}}})}dest.attr("class",replacements.join(" "))}function markMatch(text,term,markup,escapeMarkup){var match=text.toUpperCase().indexOf(term.toUpperCase()),tl=term.length;
if(match<0){markup.push(escapeMarkup(text));return}markup.push(escapeMarkup(text.substring(0,match)));
markup.push("<span class='select2-match'>");markup.push(escapeMarkup(text.substring(match,match+tl)));
markup.push("</span>");markup.push(escapeMarkup(text.substring(match+tl,text.length)))}function ajax(options){var timeout,requestSequence=0,handler=null,quietMillis=options.quietMillis||100,ajaxUrl=options.url,self=this;
return function(query){window.clearTimeout(timeout);timeout=window.setTimeout(function(){requestSequence+=1;
var requestNumber=requestSequence,data=options.data,url=ajaxUrl,transport=options.transport||$.fn.select2.ajaxDefaults.transport,deprecated={type:options.type||"GET",cache:options.cache||false,jsonpCallback:options.jsonpCallback||undefined,dataType:options.dataType||"json"},params=$.extend({},$.fn.select2.ajaxDefaults.params,deprecated);
data=data?data.call(self,query.term,query.page,query.context):null;url=(typeof url==="function")?url.call(self,query.term,query.page,query.context):url;
if(null!==handler){handler.abort()}if(options.params){if($.isFunction(options.params)){$.extend(params,options.params.call(self))
}else{$.extend(params,options.params)}}$.extend(params,{url:url,dataType:options.dataType,data:data,success:function(data){if(requestNumber<requestSequence){return
}var results=options.results(data,query.page);query.callback(results)}});handler=transport.call(self,params)
},quietMillis)}}function local(options){var data=options,dataText,tmp,text=function(item){return""+item.text
};if($.isArray(data)){tmp=data;data={results:tmp}}if($.isFunction(data)===false){tmp=data;data=function(){return tmp
}}var dataItem=data();if(dataItem.text){text=dataItem.text;if(!$.isFunction(text)){dataText=dataItem.text;
text=function(item){return item[dataText]}}}return function(query){var t=query.term,filtered={results:[]},process;
if(t===""){query.callback(data());return}process=function(datum,collection){var group,attr;datum=datum[0];
if(datum.children){group={};for(attr in datum){if(datum.hasOwnProperty(attr)){group[attr]=datum[attr]
}}group.children=[];$(datum.children).each2(function(i,childDatum){process(childDatum,group.children)
});if(group.children.length||query.matcher(t,text(group),datum)){collection.push(group)}}else{if(query.matcher(t,text(datum),datum)){collection.push(datum)
}}};$(data().results).each2(function(i,datum){process(datum,filtered.results)});query.callback(filtered)
}}function tags(data){var isFunc=$.isFunction(data);return function(query){var t=query.term,filtered={results:[]};
$(isFunc?data():data).each(function(){var isObject=this.text!==undefined,text=isObject?this.text:this;
if(t===""||query.matcher(t,text)){filtered.results.push(isObject?this:{id:this,text:this})}});query.callback(filtered)
}}function checkFormatter(formatter,formatterName){if($.isFunction(formatter)){return true}if(!formatter){return false
}throw new Error("formatterName must be a function or a falsy value")}function evaluate(val){return $.isFunction(val)?val():val
}function countResults(results){var count=0;$.each(results,function(i,item){if(item.children){count+=countResults(item.children)
}else{count++}});return count}function defaultTokenizer(input,selection,selectCallback,opts){var original=input,dupe=false,token,index,i,l,separator;
if(!opts.createSearchChoice||!opts.tokenSeparators||opts.tokenSeparators.length<1){return undefined}while(true){index=-1;
for(i=0,l=opts.tokenSeparators.length;i<l;i++){separator=opts.tokenSeparators[i];index=input.indexOf(separator);
if(index>=0){break}}if(index<0){break}token=input.substring(0,index);input=input.substring(index+separator.length);
if(token.length>0){token=opts.createSearchChoice(token,selection);if(token!==undefined&&token!==null&&opts.id(token)!==undefined&&opts.id(token)!==null){dupe=false;
for(i=0,l=selection.length;i<l;i++){if(equal(opts.id(token),opts.id(selection[i]))){dupe=true;break}}if(!dupe){selectCallback(token)
}}}}if(original!==input){return input}}function clazz(SuperClass,methods){var constructor=function(){};
constructor.prototype=new SuperClass;constructor.prototype.constructor=constructor;constructor.prototype.parent=SuperClass.prototype;
constructor.prototype=$.extend(constructor.prototype,methods);return constructor}AbstractSelect2=clazz(Object,{bind:function(func){var self=this;
return function(){func.apply(self,arguments)}},init:function(opts){var results,search,resultsSelector=".select2-results",disabled,readonly;
this.opts=opts=this.prepareOpts(opts);this.id=opts.id;if(opts.element.data("select2")!==undefined&&opts.element.data("select2")!==null){this.destroy()
}this.container=this.createContainer();this.containerId="s2id_"+(opts.element.attr("id")||"autogen"+nextUid());
this.containerSelector="#"+this.containerId.replace(/([;&,\.\+\*\~':"\!\^#$%@\[\]\(\)=>\|])/g,"\\$1");
this.container.attr("id",this.containerId);this.body=thunk(function(){return opts.element.closest("body")
});syncCssClasses(this.container,this.opts.element,this.opts.adaptContainerCssClass);this.container.css(evaluate(opts.containerCss));
this.container.addClass(evaluate(opts.containerCssClass));this.elementTabIndex=this.opts.element.attr("tabindex");
this.opts.element.data("select2",this).attr("tabindex","-1").before(this.container);this.container.data("select2",this);
this.dropdown=this.container.find(".select2-drop");this.dropdown.addClass(evaluate(opts.dropdownCssClass));
this.dropdown.data("select2",this);this.results=results=this.container.find(resultsSelector);this.search=search=this.container.find("input.select2-input");
this.resultsPage=0;this.context=null;this.initContainer();installFilteredMouseMove(this.results);this.dropdown.on("mousemove-filtered touchstart touchmove touchend",resultsSelector,this.bind(this.highlightUnderEvent));
installDebouncedScroll(80,this.results);this.dropdown.on("scroll-debounced",resultsSelector,this.bind(this.loadMoreIfNeeded));
$(this.container).on("change",".select2-input",function(e){e.stopPropagation()});$(this.dropdown).on("change",".select2-input",function(e){e.stopPropagation()
});if($.fn.mousewheel){results.mousewheel(function(e,delta,deltaX,deltaY){var top=results.scrollTop(),height;
if(deltaY>0&&top-deltaY<=0){results.scrollTop(0);killEvent(e)}else{if(deltaY<0&&results.get(0).scrollHeight-results.scrollTop()+deltaY<=results.height()){results.scrollTop(results.get(0).scrollHeight-results.height());
killEvent(e)}}})}installKeyUpChangeEvent(search);search.on("keyup-change input paste",this.bind(this.updateResults));
search.on("focus",function(){search.addClass("select2-focused");if(search.val()===" "){search.val("")
}});search.on("blur",function(){search.removeClass("select2-focused")});this.dropdown.on("mouseup",resultsSelector,this.bind(function(e){if($(e.target).closest(".select2-result-selectable").length>0){this.highlightUnderEvent(e);
this.selectHighlighted(e)}}));this.dropdown.on("click mouseup mousedown",function(e){e.stopPropagation()
});if($.isFunction(this.opts.initSelection)){this.initSelection();this.monitorSource()}if(opts.maximumInputLength!==null){this.search.attr("maxlength",opts.maximumInputLength)
}var disabled=opts.element.prop("disabled");if(disabled===undefined){disabled=false}this.enable(!disabled);
var readonly=opts.element.prop("readonly");if(readonly===undefined){readonly=false}this.readonly(readonly);
scrollBarDimensions=scrollBarDimensions||measureScrollbar();this.autofocus=opts.element.prop("autofocus");
opts.element.prop("autofocus",false);if(this.autofocus){this.focus()}},destroy:function(){var select2=this.opts.element.data("select2");
if(this.propertyObserver){delete this.propertyObserver;this.propertyObserver=null}if(select2!==undefined){select2.container.remove();
select2.dropdown.remove();select2.opts.element.removeClass("select2-offscreen").removeData("select2").off(".select2").attr({"tabindex":this.elementTabIndex}).prop("autofocus",this.autofocus||false).show()
}},optionToData:function(element){if(element.is("option")){return{id:element.prop("value"),text:element.text(),element:element.get(),css:element.attr("class"),disabled:element.prop("disabled"),locked:equal(element.attr("locked"),"locked")}
}else{if(element.is("optgroup")){return{text:element.attr("label"),children:[],element:element.get(),css:element.attr("class")}
}}},prepareOpts:function(opts){var element,select,idKey,ajaxUrl,self=this;element=opts.element;if(element.get(0).tagName.toLowerCase()==="select"){this.select=select=opts.element
}if(select){$.each(["id","multiple","ajax","query","createSearchChoice","initSelection","data","tags"],function(){if(this in opts){throw new Error("Option '"+this+"' is not allowed for Select2 when attached to a <select> element.")
}})}opts=$.extend({},{addResultClass:"",populateResults:function(container,results,query){var populate,data,result,children,id=this.opts.id;
populate=function(results,container,depth){var i,l,result,selectable,disabled,compound,node,label,innerContainer,formatted;
results=opts.sortResults(results,container,query);for(i=0,l=results.length;i<l;i=i+1){result=results[i];
disabled=(result.disabled===true);selectable=(!disabled)&&(id(result)!==undefined);compound=result.children&&result.children.length>0;
node=$("<li></li>");node.addClass("select2-results-dept-"+depth);node.addClass("select2-result");node.addClass(selectable?"select2-result-selectable":"select2-result-unselectable");
if(disabled){node.addClass("select2-disabled")}if(compound){node.addClass("select2-result-with-children")
}node.addClass(self.opts.formatResultCssClass(result));node.addClass(self.opts.addResultClass);label=$(document.createElement("div"));
label.addClass("select2-result-label");formatted=opts.formatResult(result,label,query,self.opts.escapeMarkup);
if(formatted!==undefined){label.html(formatted)}node.append(label);if(compound){innerContainer=$("<ul></ul>");
innerContainer.addClass("select2-result-sub");populate(result.children,innerContainer,depth+1);node.append(innerContainer)
}node.data("select2-data",result);container.append(node)}};populate(results,container,0)}},$.fn.select2.defaults,opts);
if(typeof(opts.id)!=="function"){idKey=opts.id;opts.id=function(e){return e[idKey]}}if($.isArray(opts.element.data("select2Tags"))){if("tags" in opts){throw"tags specified as both an attribute 'data-select2-tags' and in options of Select2 "+opts.element.attr("id")
}opts.tags=opts.element.data("select2Tags")}if(select){opts.query=this.bind(function(query){var data={results:[],more:false},term=query.term,children,firstChild,process;
process=function(element,collection){var group;if(element.is("option")){if(query.matcher(term,element.text(),element)){collection.push(self.optionToData(element))
}}else{if(element.is("optgroup")){group=self.optionToData(element);element.children().each2(function(i,elm){process(elm,group.children)
});if(group.children.length>0){collection.push(group)}}}};children=element.children();if(this.getPlaceholder()!==undefined&&children.length>0){firstChild=children[0];
if($(firstChild).text()===""){children=children.not(firstChild)}}children.each2(function(i,elm){process(elm,data.results)
});query.callback(data)});opts.id=function(e){return e.id};opts.formatResultCssClass=function(data){return data.css
}}else{if(!("query" in opts)){if("ajax" in opts){ajaxUrl=opts.element.data("ajax-url");if(ajaxUrl&&ajaxUrl.length>0){opts.ajax.url=ajaxUrl
}opts.query=ajax.call(opts.element,opts.ajax)}else{if("data" in opts){opts.query=local(opts.data)}else{if("tags" in opts){opts.query=tags(opts.tags);
if(opts.createSearchChoice===undefined){opts.createSearchChoice=function(term){return{id:term,text:term}
}}if(opts.initSelection===undefined){opts.initSelection=function(element,callback){var data=[];$(splitVal(element.val(),opts.separator)).each(function(){var id=this,text=this,tags=opts.tags;
if($.isFunction(tags)){tags=tags()}$(tags).each(function(){if(equal(this.id,id)){text=this.text;return false
}});data.push({id:id,text:text})});callback(data)}}}}}}}if(typeof(opts.query)!=="function"){throw"query function not defined for Select2 "+opts.element.attr("id")
}return opts},monitorSource:function(){var el=this.opts.element,sync;el.on("change.select2",this.bind(function(e){if(this.opts.element.data("select2-change-triggered")!==true){this.initSelection()
}}));sync=this.bind(function(){var enabled,readonly,self=this;var disabled=el.prop("disabled");if(disabled===undefined){disabled=false
}this.enable(!disabled);var readonly=el.prop("readonly");if(readonly===undefined){readonly=false}this.readonly(readonly);
syncCssClasses(this.container,this.opts.element,this.opts.adaptContainerCssClass);this.container.addClass(evaluate(this.opts.containerCssClass));
syncCssClasses(this.dropdown,this.opts.element,this.opts.adaptDropdownCssClass);this.dropdown.addClass(evaluate(this.opts.dropdownCssClass))
});el.on("propertychange.select2 DOMAttrModified.select2",sync);if(this.mutationCallback===undefined){this.mutationCallback=function(mutations){mutations.forEach(sync)
}}if(typeof WebKitMutationObserver!=="undefined"){if(this.propertyObserver){delete this.propertyObserver;
this.propertyObserver=null}this.propertyObserver=new WebKitMutationObserver(this.mutationCallback);this.propertyObserver.observe(el.get(0),{attributes:true,subtree:false})
}},triggerSelect:function(data){var evt=$.Event("select2-selecting",{val:this.id(data),object:data});
this.opts.element.trigger(evt);return !evt.isDefaultPrevented()},triggerChange:function(details){details=details||{};
details=$.extend({},details,{type:"change",val:this.val()});this.opts.element.data("select2-change-triggered",true);
this.opts.element.trigger(details);this.opts.element.data("select2-change-triggered",false);this.opts.element.click();
if(this.opts.blurOnChange){this.opts.element.blur()}},isInterfaceEnabled:function(){return this.enabledInterface===true
},enableInterface:function(){var enabled=this._enabled&&!this._readonly,disabled=!enabled;if(enabled===this.enabledInterface){return false
}this.container.toggleClass("select2-container-disabled",disabled);this.close();this.enabledInterface=enabled;
return true},enable:function(enabled){if(enabled===undefined){enabled=true}if(this._enabled===enabled){return false
}this._enabled=enabled;this.opts.element.prop("disabled",!enabled);this.enableInterface();return true
},readonly:function(enabled){if(enabled===undefined){enabled=false}if(this._readonly===enabled){return false
}this._readonly=enabled;this.opts.element.prop("readonly",enabled);this.enableInterface();return true
},opened:function(){return this.container.hasClass("select2-dropdown-open")},positionDropdown:function(){var $dropdown=this.dropdown,offset=this.container.offset(),height=this.container.outerHeight(false),width=this.container.outerWidth(false),dropHeight=$dropdown.outerHeight(false),viewPortRight=$(window).scrollLeft()+$(window).width(),viewportBottom=$(window).scrollTop()+$(window).height(),dropTop=offset.top+height,dropLeft=offset.left,enoughRoomBelow=dropTop+dropHeight<=viewportBottom,enoughRoomAbove=(offset.top-dropHeight)>=this.body().scrollTop(),dropWidth=$dropdown.outerWidth(false),enoughRoomOnRight=dropLeft+dropWidth<=viewPortRight,aboveNow=$dropdown.hasClass("select2-drop-above"),bodyOffset,above,css,resultsListNode;
if(this.opts.dropdownAutoWidth){resultsListNode=$(".select2-results",$dropdown)[0];$dropdown.addClass("select2-drop-auto-width");
$dropdown.css("width","");dropWidth=$dropdown.outerWidth(false)+(resultsListNode.scrollHeight===resultsListNode.clientHeight?0:scrollBarDimensions.width);
dropWidth>width?width=dropWidth:dropWidth=width;enoughRoomOnRight=dropLeft+dropWidth<=viewPortRight}else{this.container.removeClass("select2-drop-auto-width")
}if(this.body().css("position")!=="static"){bodyOffset=this.body().offset()||{top:0,left:0};dropTop-=bodyOffset.top;
dropLeft-=bodyOffset.left}if(aboveNow){above=true;if(!enoughRoomAbove&&enoughRoomBelow){above=false}}else{above=false;
if(!enoughRoomBelow&&enoughRoomAbove){above=true}}if(!enoughRoomOnRight){dropLeft=offset.left+width-dropWidth
}if(above){dropTop=offset.top-dropHeight;this.container.addClass("select2-drop-above");$dropdown.addClass("select2-drop-above")
}else{this.container.removeClass("select2-drop-above");$dropdown.removeClass("select2-drop-above")}css=$.extend({top:dropTop,left:dropLeft,width:width},evaluate(this.opts.dropdownCss));
$dropdown.css(css)},shouldOpen:function(){var event;if(this.opened()){return false}if(this._enabled===false||this._readonly===true){return false
}event=$.Event("select2-opening");this.opts.element.trigger(event);return !event.isDefaultPrevented()
},clearDropdownAlignmentPreference:function(){this.container.removeClass("select2-drop-above");this.dropdown.removeClass("select2-drop-above")
},open:function(){if(!this.shouldOpen()){return false}this.opening();return true},opening:function(){var cid=this.containerId,scroll="scroll."+cid,resize="resize."+cid,orient="orientationchange."+cid,mask;
this.container.addClass("select2-dropdown-open").addClass("select2-container-active");this.clearDropdownAlignmentPreference();
if(this.dropdown[0]!==this.body().children().last()[0]){this.dropdown.detach().appendTo(this.body())}mask=$("#select2-drop-mask");
if(mask.length==0){mask=$(document.createElement("div"));mask.attr("id","select2-drop-mask").attr("class","select2-drop-mask");
mask.hide();mask.appendTo(this.body());mask.on("mousedown touchstart",function(e){var dropdown=$("#select2-drop"),self;
if(dropdown.length>0){self=dropdown.data("select2");if(self.opts.selectOnBlur){self.selectHighlighted({noFocus:true})
}self.close();e.preventDefault();e.stopPropagation()}})}if(this.dropdown.prev()[0]!==mask[0]){this.dropdown.before(mask)
}$("#select2-drop").removeAttr("id");this.dropdown.attr("id","select2-drop");mask.css(_makeMaskCss());
mask.show();this.dropdown.show();this.positionDropdown();this.dropdown.addClass("select2-drop-active");
this.ensureHighlightVisible();var that=this;this.container.parents().add(window).each(function(){$(this).on(resize+" "+scroll+" "+orient,function(e){$("#select2-drop-mask").css(_makeMaskCss());
that.positionDropdown()})});function _makeMaskCss(){return{width:Math.max(document.documentElement.scrollWidth,$(window).width()),height:Math.max(document.documentElement.scrollHeight,$(window).height())}
}},close:function(){if(!this.opened()){return}var cid=this.containerId,scroll="scroll."+cid,resize="resize."+cid,orient="orientationchange."+cid;
this.container.parents().add(window).each(function(){$(this).off(scroll).off(resize).off(orient)});this.clearDropdownAlignmentPreference();
$("#select2-drop-mask").hide();this.dropdown.removeAttr("id");this.dropdown.hide();this.container.removeClass("select2-dropdown-open");
this.results.empty();this.clearSearch();this.search.removeClass("select2-active");this.opts.element.trigger($.Event("select2-close"))
},clearSearch:function(){},getMaximumSelectionSize:function(){return evaluate(this.opts.maximumSelectionSize)
},ensureHighlightVisible:function(){var results=this.results,children,index,child,hb,rb,y,more;index=this.highlight();
if(index<0){return}if(index==0){results.scrollTop(0);return}children=this.findHighlightableChoices().find(".select2-result-label");
child=$(children[index]);hb=child.offset().top+child.outerHeight(true);if(index===children.length-1){more=results.find("li.select2-more-results");
if(more.length>0){hb=more.offset().top+more.outerHeight(true)}}rb=results.offset().top+results.outerHeight(true);
if(hb>rb){results.scrollTop(results.scrollTop()+(hb-rb))}y=child.offset().top-results.offset().top;if(y<0&&child.css("display")!="none"){results.scrollTop(results.scrollTop()+y)
}},findHighlightableChoices:function(){return this.results.find(".select2-result-selectable:not(.select2-selected):not(.select2-disabled)")
},moveHighlight:function(delta){var choices=this.findHighlightableChoices(),index=this.highlight();while(index>-1&&index<choices.length){index+=delta;
var choice=$(choices[index]);if(choice.hasClass("select2-result-selectable")&&!choice.hasClass("select2-disabled")&&!choice.hasClass("select2-selected")){this.highlight(index);
break}}},highlight:function(index){var choices=this.findHighlightableChoices(),choice,data;if(arguments.length===0){return indexOf(choices.filter(".select2-highlighted")[0],choices.get())
}if(index>=choices.length){index=choices.length-1}if(index<0){index=0}this.results.find(".select2-highlighted").removeClass("select2-highlighted");
choice=$(choices[index]);choice.addClass("select2-highlighted");this.ensureHighlightVisible();data=choice.data("select2-data");
if(data){this.opts.element.trigger({type:"select2-highlight",val:this.id(data),choice:data})}},countSelectableResults:function(){return this.findHighlightableChoices().length
},highlightUnderEvent:function(event){var el=$(event.target).closest(".select2-result-selectable");if(el.length>0&&!el.is(".select2-highlighted")){var choices=this.findHighlightableChoices();
this.highlight(choices.index(el))}else{if(el.length==0){this.results.find(".select2-highlighted").removeClass("select2-highlighted")
}}},loadMoreIfNeeded:function(){var results=this.results,more=results.find("li.select2-more-results"),below,offset=-1,page=this.resultsPage+1,self=this,term=this.search.val(),context=this.context;
if(more.length===0){return}below=more.offset().top-results.offset().top-results.height();if(below<=this.opts.loadMorePadding){more.addClass("select2-active");
this.opts.query({element:this.opts.element,term:term,page:page,context:context,matcher:this.opts.matcher,callback:this.bind(function(data){if(!self.opened()){return
}self.opts.populateResults.call(this,results,data.results,{term:term,page:page,context:context});self.postprocessResults(data,false,false);
if(data.more===true){more.detach().appendTo(results).text(self.opts.formatLoadMore(page+1));window.setTimeout(function(){self.loadMoreIfNeeded()
},10)}else{more.remove()}self.positionDropdown();self.resultsPage=page;self.context=data.context})})}},tokenize:function(){},updateResults:function(initial){var search=this.search,results=this.results,opts=this.opts,data,self=this,input,term=search.val(),lastTerm=$.data(this.container,"select2-last-term");
if(initial!==true&&lastTerm&&equal(term,lastTerm)){return}$.data(this.container,"select2-last-term",term);
if(initial!==true&&(this.showSearchInput===false||!this.opened())){return}function postRender(){results.scrollTop(0);
search.removeClass("select2-active");self.positionDropdown()}function render(html){results.html(html);
postRender()}var maxSelSize=this.getMaximumSelectionSize();if(maxSelSize>=1){data=this.data();if($.isArray(data)&&data.length>=maxSelSize&&checkFormatter(opts.formatSelectionTooBig,"formatSelectionTooBig")){render("<li class='select2-selection-limit'>"+opts.formatSelectionTooBig(maxSelSize)+"</li>");
return}}if(search.val().length<opts.minimumInputLength){if(checkFormatter(opts.formatInputTooShort,"formatInputTooShort")){render("<li class='select2-no-results'>"+opts.formatInputTooShort(search.val(),opts.minimumInputLength)+"</li>")
}else{render("")}if(initial){this.showSearch(true)}return}if(opts.maximumInputLength&&search.val().length>opts.maximumInputLength){if(checkFormatter(opts.formatInputTooLong,"formatInputTooLong")){render("<li class='select2-no-results'>"+opts.formatInputTooLong(search.val(),opts.maximumInputLength)+"</li>")
}else{render("")}return}if(opts.formatSearching&&this.findHighlightableChoices().length===0){render("<li class='select2-searching'>"+opts.formatSearching()+"</li>")
}search.addClass("select2-active");input=this.tokenize();if(input!=undefined&&input!=null){search.val(input)
}this.resultsPage=1;opts.query({element:opts.element,term:search.val(),page:this.resultsPage,context:null,matcher:opts.matcher,callback:this.bind(function(data){var def;
if(!this.opened()){this.search.removeClass("select2-active");return}this.context=(data.context===undefined)?null:data.context;
if(this.opts.createSearchChoice&&search.val()!==""){def=this.opts.createSearchChoice.call(null,search.val(),data.results);
if(def!==undefined&&def!==null&&self.id(def)!==undefined&&self.id(def)!==null){if($(data.results).filter(function(){return equal(self.id(this),self.id(def))
}).length===0){data.results.unshift(def)}}}if(data.results.length===0&&checkFormatter(opts.formatNoMatches,"formatNoMatches")){render("<li class='select2-no-results'>"+opts.formatNoMatches(search.val())+"</li>");
return}results.empty();self.opts.populateResults.call(this,results,data.results,{term:search.val(),page:this.resultsPage,context:null});
if(data.more===true&&checkFormatter(opts.formatLoadMore,"formatLoadMore")){results.append("<li class='select2-more-results'>"+self.opts.escapeMarkup(opts.formatLoadMore(this.resultsPage))+"</li>");
window.setTimeout(function(){self.loadMoreIfNeeded()},10)}this.postprocessResults(data,initial);postRender();
this.opts.element.trigger({type:"select2-loaded",data:data})})})},cancel:function(){this.close()},blur:function(){if(this.opts.selectOnBlur){this.selectHighlighted({noFocus:true})
}this.close();this.container.removeClass("select2-container-active");if(this.search[0]===document.activeElement){this.search.blur()
}this.clearSearch();this.selection.find(".select2-search-choice-focus").removeClass("select2-search-choice-focus")
},focusSearch:function(){focus(this.search)},selectHighlighted:function(options){var index=this.highlight(),highlighted=this.results.find(".select2-highlighted"),data=highlighted.closest(".select2-result").data("select2-data");
if(data){this.highlight(index);this.onSelect(data,options)}},getPlaceholder:function(){return this.opts.element.attr("placeholder")||this.opts.element.attr("data-placeholder")||this.opts.element.data("placeholder")||this.opts.placeholder
},initContainerWidth:function(){function resolveContainerWidth(){var style,attrs,matches,i,l;if(this.opts.width==="off"){return null
}else{if(this.opts.width==="element"){return this.opts.element.outerWidth(false)===0?"auto":this.opts.element.outerWidth(false)+"px"
}else{if(this.opts.width==="copy"||this.opts.width==="resolve"){style=this.opts.element.attr("style");
if(style!==undefined){attrs=style.split(";");for(i=0,l=attrs.length;i<l;i=i+1){matches=attrs[i].replace(/\s/g,"").match(/width:(([-+]?([0-9]*\.)?[0-9]+)(px|em|ex|%|in|cm|mm|pt|pc))/i);
if(matches!==null&&matches.length>=1){return matches[1]}}}style=this.opts.element.css("width");if(style&&style.length>0){return style
}if(this.opts.width==="resolve"){return(this.opts.element.outerWidth(false)===0?"auto":this.opts.element.outerWidth(false)+"px")
}return null}else{if($.isFunction(this.opts.width)){return this.opts.width()}else{return this.opts.width
}}}}}var width=resolveContainerWidth.call(this);if(width!==null){if(this.opts.addWidth){width=parseInt(width)+this.opts.addWidth;
width+="px"}this.container.css("width",width)}}});SingleSelect2=clazz(AbstractSelect2,{createContainer:function(){var container=$(document.createElement("div")).attr({"class":"select2-container"}).html(["<a href='javascript:void(0)' onclick='return false;' class='select2-choice' tabindex='-1'>","   <span>&nbsp;</span><abbr class='select2-search-choice-close'></abbr>","   <div><b></b></div>","</a>","<input class='select2-focusser select2-offscreen' type='text'/>","<div class='select2-drop select2-display-none'>","   <div class='select2-search'>","       <input type='text' autocomplete='off' autocorrect='off' autocapitilize='off' spellcheck='false' class='select2-input'/>","   </div>","   <ul class='select2-results'>","   </ul>","</div>"].join(""));
return container},enableInterface:function(){if(this.parent.enableInterface.apply(this,arguments)){this.focusser.prop("disabled",!this.isInterfaceEnabled())
}},opening:function(){var el,range;this.parent.opening.apply(this,arguments);if(this.showSearchInput!==false){this.search.val(this.focusser.val())
}this.search.focus();el=this.search.get(0);if(el.createTextRange){range=el.createTextRange();range.collapse(false);
range.select()}this.focusser.prop("disabled",true).val("");this.updateResults(true);this.opts.element.trigger($.Event("select2-open"))
},close:function(){if(!this.opened()){return}this.parent.close.apply(this,arguments);this.focusser.removeAttr("disabled");
this.focusser.focus()},focus:function(){if(this.opened()){this.close()}else{this.focusser.removeAttr("disabled");
this.focusser.focus()}},isFocused:function(){return this.container.hasClass("select2-container-active")
},cancel:function(){this.parent.cancel.apply(this,arguments);this.focusser.removeAttr("disabled");this.focusser.focus()
},initContainer:function(){var selection,container=this.container,dropdown=this.dropdown;this.showSearch(false);
this.selection=selection=container.find(".select2-choice");this.focusser=container.find(".select2-focusser");
this.focusser.attr("id","s2id_autogen"+nextUid());$("label[for='"+this.opts.element.attr("id")+"']").attr("for",this.focusser.attr("id"));
this.focusser.attr("tabindex",this.elementTabIndex);this.search.on("keydown",this.bind(function(e){if(!this.isInterfaceEnabled()){return
}if(e.which===KEY.PAGE_UP||e.which===KEY.PAGE_DOWN){killEvent(e);return}switch(e.which){case KEY.UP:case KEY.DOWN:this.moveHighlight((e.which===KEY.UP)?-1:1);
killEvent(e);return;case KEY.ENTER:this.selectHighlighted();killEvent(e);return;case KEY.TAB:this.selectHighlighted({noFocus:true});
return;case KEY.ESC:this.cancel(e);killEvent(e);return}}));this.search.on("blur",this.bind(function(e){if(document.activeElement===this.body().get(0)){window.setTimeout(this.bind(function(){this.search.focus()
}),0)}}));this.focusser.on("keydown",this.bind(function(e){if(!this.isInterfaceEnabled()){return}if(e.which===KEY.TAB||KEY.isControl(e)||KEY.isFunctionKey(e)||e.which===KEY.ESC){return
}if(this.opts.openOnEnter===false&&e.which===KEY.ENTER){killEvent(e);return}if(e.which==KEY.DOWN||e.which==KEY.UP||(e.which==KEY.ENTER&&this.opts.openOnEnter)){this.open();
killEvent(e);return}if(e.which==KEY.DELETE||e.which==KEY.BACKSPACE){if(this.opts.allowClear){this.clear()
}killEvent(e);return}}));installKeyUpChangeEvent(this.focusser);this.focusser.on("keyup-change input",this.bind(function(e){e.stopPropagation();
if(this.opened()){return}this.open()}));selection.on("mousedown","abbr",this.bind(function(e){if(!this.isInterfaceEnabled()){return
}this.clear();killEventImmediately(e);this.close();this.selection.focus()}));selection.on("mousedown",this.bind(function(e){if(!this.container.hasClass("select2-container-active")){this.opts.element.trigger($.Event("select2-focus"))
}if(this.opened()){this.close()}else{if(this.isInterfaceEnabled()){this.open()}}killEvent(e)}));dropdown.on("mousedown",this.bind(function(){this.search.focus()
}));selection.on("focus",this.bind(function(e){killEvent(e)}));this.focusser.on("focus",this.bind(function(){if(!this.container.hasClass("select2-container-active")){this.opts.element.trigger($.Event("select2-focus"))
}this.container.addClass("select2-container-active")})).on("blur",this.bind(function(){if(!this.opened()){this.container.removeClass("select2-container-active");
this.opts.element.trigger($.Event("select2-blur"))}}));this.search.on("focus",this.bind(function(){if(!this.container.hasClass("select2-container-active")){this.opts.element.trigger($.Event("select2-focus"))
}this.container.addClass("select2-container-active")}));this.initContainerWidth();this.opts.element.addClass("select2-offscreen");
this.setPlaceholder()},clear:function(triggerChange){var data=this.selection.data("select2-data");if(data){this.opts.element.val("");
this.selection.find("span").empty();this.selection.removeData("select2-data");this.setPlaceholder();if(triggerChange!==false){this.opts.element.trigger({type:"select2-removed",val:this.id(data),choice:data});
this.triggerChange({removed:data})}}},initSelection:function(){var selected;if(this.opts.element.val()===""&&this.opts.element.text()===""){this.updateSelection([]);
this.close();this.setPlaceholder()}else{var self=this;this.opts.initSelection.call(null,this.opts.element,function(selected){if(selected!==undefined&&selected!==null){self.updateSelection(selected);
self.close();self.setPlaceholder()}})}},prepareOpts:function(){var opts=this.parent.prepareOpts.apply(this,arguments),self=this;
if(opts.element.get(0).tagName.toLowerCase()==="select"){opts.initSelection=function(element,callback){var selected=element.find(":selected");
callback(self.optionToData(selected))}}else{if("data" in opts){opts.initSelection=opts.initSelection||function(element,callback){var id=element.val();
var match=null;opts.query({matcher:function(term,text,el){var is_match=equal(id,opts.id(el));if(is_match){match=el
}return is_match},callback:!$.isFunction(callback)?$.noop:function(){callback(match)}})}}}return opts
},getPlaceholder:function(){if(this.select){if(this.select.find("option").first().text()!==""){return undefined
}}return this.parent.getPlaceholder.apply(this,arguments)},setPlaceholder:function(){var placeholder=this.getPlaceholder();
if(this.opts.element.val()===""&&placeholder!==undefined){if(this.select&&this.select.find("option:first").text()!==""){return
}this.selection.find("span").html(this.opts.escapeMarkup(placeholder));this.selection.addClass("select2-default");
this.container.removeClass("select2-allowclear")}},postprocessResults:function(data,initial,noHighlightUpdate){var selected=0,self=this,showSearchInput=true;
this.findHighlightableChoices().each2(function(i,elm){if(equal(self.id(elm.data("select2-data")),self.opts.element.val())){selected=i;
return false}});if(noHighlightUpdate!==false){this.highlight(selected)}if(initial===true&&this.showSearchInput===false){var min=this.opts.minimumResultsForSearch;
if(min>=0){this.showSearch(countResults(data.results)>=min)}}},showSearch:function(showSearchInput){this.showSearchInput=showSearchInput;
this.dropdown.find(".select2-search").toggleClass("select2-search-hidden",!showSearchInput);this.dropdown.find(".select2-search").toggleClass("select2-offscreen",!showSearchInput);
$(this.dropdown,this.container).toggleClass("select2-with-searchbox",showSearchInput)},onSelect:function(data,options){if(!this.triggerSelect(data)){return
}var old=this.opts.element.val(),oldData=this.data();this.opts.element.val(this.id(data));this.updateSelection(data);
this.opts.element.trigger({type:"select2-selected",val:this.id(data),choice:data});this.close();if(!options||!options.noFocus){this.selection.focus()
}if(!equal(old,this.id(data))){this.triggerChange({added:data,removed:oldData})}},updateSelection:function(data){var container=this.selection.find("span"),formatted;
this.selection.data("select2-data",data);container.empty();formatted=this.opts.formatSelection(data,container);
if(formatted!==undefined){if(formatted.type=="html"){formatted=$(formatted.value)}else{if(formatted.type=="el"){formatted=formatted.value
}else{if(typeof formatted.value!="undefined"){formatted=this.opts.escapeMarkup(formatted.value)}else{formatted=this.opts.escapeMarkup(formatted)
}}}container.append(formatted)}this.selection.removeClass("select2-default");if(this.opts.allowClear&&this.getPlaceholder()!==undefined){this.container.addClass("select2-allowclear")
}},val:function(){var val,triggerChange=false,data=null,self=this,oldData=this.data();if(arguments.length===0){return this.opts.element.val()
}val=arguments[0];if(arguments.length>1){triggerChange=arguments[1]}if(this.select){this.select.val(val).find(":selected").each2(function(i,elm){data=self.optionToData(elm);
return false});this.updateSelection(data);this.setPlaceholder();if(triggerChange){this.triggerChange({added:data,removed:oldData})
}}else{if(this.opts.initSelection===undefined){throw new Error("cannot call val() if initSelection() is not defined")
}if(!val&&val!==0){this.clear(triggerChange);return}this.opts.element.val(val);this.opts.initSelection(this.opts.element,function(data){self.opts.element.val(!data?"":self.id(data));
self.updateSelection(data);self.setPlaceholder();if(triggerChange){self.triggerChange({added:data,removed:oldData})
}})}},clearSearch:function(){this.search.val("");this.focusser.val("")},data:function(value,triggerChange){var data;
if(arguments.length===0){data=this.selection.data("select2-data");if(data==undefined){data=null}return data
}else{if(!value||value===""){this.clear(triggerChange)}else{data=this.data();this.opts.element.val(!value?"":this.id(value));
this.updateSelection(value);if(triggerChange){this.triggerChange({added:value,removed:data})}}}}});MultiSelect2=clazz(AbstractSelect2,{createContainer:function(){var container=$(document.createElement("div")).attr({"class":"select2-container select2-container-multi"}).html(["    <ul class='select2-choices'>","  <li class='select2-search-field'>","    <input type='text' autocomplete='off' autocorrect='off' autocapitilize='off' spellcheck='false' class='select2-input'>","  </li>","</ul>","<div class='select2-drop select2-drop-multi select2-display-none'>","   <ul class='select2-results'>","   </ul>","</div>"].join(""));
return container},prepareOpts:function(){var opts=this.parent.prepareOpts.apply(this,arguments),self=this;
if(opts.element.get(0).tagName.toLowerCase()==="select"){opts.initSelection=function(element,callback){var data=[];
element.find(":selected").each2(function(i,elm){data.push(self.optionToData(elm))});callback(data)}}else{if("data" in opts){opts.initSelection=opts.initSelection||function(element,callback){var ids=splitVal(element.val(),opts.separator);
var matches=[];opts.query({matcher:function(term,text,el){var is_match=$.grep(ids,function(id){return equal(id,opts.id(el))
}).length;if(is_match){matches.push(el)}return is_match},callback:!$.isFunction(callback)?$.noop:function(){var ordered=[];
for(var i=0;i<ids.length;i++){var id=ids[i];for(var j=0;j<matches.length;j++){var match=matches[j];if(equal(id,opts.id(match))){ordered.push(match);
matches.splice(j,1);break}}}callback(ordered)}})}}}return opts},selectChoice:function(choice){var selected=this.container.find(".select2-search-choice-focus");
if(selected.length&&choice&&choice[0]==selected[0]){}else{if(selected.length){this.opts.element.trigger("choice-deselected",selected)
}selected.removeClass("select2-search-choice-focus");if(choice&&choice.length){this.close();choice.addClass("select2-search-choice-focus");
this.opts.element.trigger("choice-selected",choice)}}},initContainer:function(){var selector=".select2-choices",selection;
this.searchContainer=this.container.find(".select2-search-field");this.selection=selection=this.container.find(selector);
var _this=this;this.selection.on("mousedown",".select2-search-choice",function(e){_this.search[0].focus();
_this.selectChoice($(this))});this.search.attr("id","s2id_autogen"+nextUid());$("label[for='"+this.opts.element.attr("id")+"']").attr("for",this.search.attr("id"));
this.search.on("input paste",this.bind(function(){if(!this.isInterfaceEnabled()){return}if(!this.opened()){this.open()
}}));this.search.attr("tabindex",this.elementTabIndex);this.keydowns=0;this.search.on("keydown",this.bind(function(e){if(!this.isInterfaceEnabled()){return
}++this.keydowns;var selected=selection.find(".select2-search-choice-focus");var prev=selected.prev(".select2-search-choice:not(.select2-locked)");
var next=selected.next(".select2-search-choice:not(.select2-locked)");var pos=getCursorInfo(this.search);
if(selected.length&&(e.which==KEY.LEFT||e.which==KEY.RIGHT||e.which==KEY.BACKSPACE||e.which==KEY.DELETE||e.which==KEY.ENTER)){var selectedChoice=selected;
if(e.which==KEY.LEFT&&prev.length){selectedChoice=prev}else{if(e.which==KEY.RIGHT){selectedChoice=next.length?next:null
}else{if(e.which===KEY.BACKSPACE){this.unselect(selected.first());this.search.width(10);selectedChoice=prev.length?prev:next
}else{if(e.which==KEY.DELETE){this.unselect(selected.first());this.search.width(10);selectedChoice=next.length?next:null
}else{if(e.which==KEY.ENTER){selectedChoice=null}}}}}this.selectChoice(selectedChoice);killEvent(e);if(!selectedChoice||!selectedChoice.length){this.open()
}return}else{if(((e.which===KEY.BACKSPACE&&this.keydowns==1)||e.which==KEY.LEFT)&&(pos.offset==0&&!pos.length)){this.selectChoice(selection.find(".select2-search-choice:not(.select2-locked)").last());
killEvent(e);return}else{this.selectChoice(null)}}if(this.opened()){switch(e.which){case KEY.UP:case KEY.DOWN:this.moveHighlight((e.which===KEY.UP)?-1:1);
killEvent(e);return;case KEY.ENTER:this.selectHighlighted();killEvent(e);return;case KEY.TAB:this.selectHighlighted({noFocus:true});
return;case KEY.ESC:this.cancel(e);killEvent(e);return}}if(e.which===KEY.TAB||KEY.isControl(e)||KEY.isFunctionKey(e)||e.which===KEY.BACKSPACE||e.which===KEY.ESC){return
}if(e.which===KEY.ENTER){if(this.opts.openOnEnter===false){return}else{if(e.altKey||e.ctrlKey||e.shiftKey||e.metaKey){return
}}}this.open();if(e.which===KEY.PAGE_UP||e.which===KEY.PAGE_DOWN){killEvent(e)}if(e.which===KEY.ENTER){killEvent(e)
}}));this.search.on("keyup",this.bind(function(e){this.keydowns=0;this.resizeSearch()}));this.search.on("blur",this.bind(function(e){this.container.removeClass("select2-container-active");
this.search.removeClass("select2-focused");this.selectChoice(null);if(!this.opened()){this.clearSearch()
}e.stopImmediatePropagation();this.opts.element.trigger($.Event("select2-blur"))}));this.container.on("mousedown",selector,this.bind(function(e){if(!this.isInterfaceEnabled()){return
}if($(e.target).closest(".select2-search-choice").length>0){return}this.selectChoice(null);this.clearPlaceholder();
this.resizeSearch();if(!this.container.hasClass("select2-container-active")){this.opts.element.trigger($.Event("select2-focus"))
}this.open();this.focusSearch();e.preventDefault()}));this.container.on("focus",selector,this.bind(function(){if(!this.isInterfaceEnabled()){return
}if(!this.container.hasClass("select2-container-active")){this.opts.element.trigger($.Event("select2-focus"))
}this.container.addClass("select2-container-active");this.dropdown.addClass("select2-drop-active");this.clearPlaceholder()
}));this.initContainerWidth();this.opts.element.addClass("select2-offscreen");this.clearSearch()},enableInterface:function(){if(this.parent.enableInterface.apply(this,arguments)){this.search.prop("disabled",!this.isInterfaceEnabled())
}},initSelection:function(){var data;if(this.opts.element.val()===""&&this.opts.element.text()===""){this.updateSelection([]);
this.close();this.clearSearch()}if(this.select||this.opts.element.val()!==""){var self=this;this.opts.initSelection.call(null,this.opts.element,function(data){if(data!==undefined&&data!==null){self.updateSelection(data);
self.close();self.clearSearch()}})}},clearSearch:function(){var placeholder=this.getPlaceholder(),maxWidth=this.getMaxSearchWidth();
if(placeholder!==undefined&&this.getVal().length===0&&this.search.hasClass("select2-focused")===false){this.search.val(placeholder).addClass("select2-default");
this.search.width(maxWidth>0?maxWidth:this.container.css("width"))}else{if(!this.isFocused()){this.search.val("").width(10)
}}},clearPlaceholder:function(){if(this.search.hasClass("select2-default")){this.search.val("").removeClass("select2-default")
}},opening:function(){this.clearPlaceholder();this.resizeSearch();this.parent.opening.apply(this,arguments);
this.focusSearch();this.updateResults(true);this.search.focus();this.opts.element.trigger($.Event("select2-open"))
},close:function(){if(!this.opened()){return}this.parent.close.apply(this,arguments)},focus:function(){this.close();
this.search.focus()},isFocused:function(){return this.search.hasClass("select2-focused")},updateSelection:function(data){var ids=[],filtered=[],self=this;
$(data).each(function(){if(indexOf(self.id(this),ids)<0){ids.push(self.id(this));filtered.push(this)}});
data=filtered;this.selection.find(".select2-search-choice").remove();$(data).each(function(){self.addSelectedChoice(this)
});self.postprocessResults()},tokenize:function(){var input=this.search.val();input=this.opts.tokenizer(input,this.data(),this.bind(this.onSelect),this.opts);
if(input!=null&&input!=undefined){this.search.val(input);if(input.length>0){this.open()}}},onSelect:function(data,options){if(!this.triggerSelect(data)){return
}this.addSelectedChoice(data);this.opts.element.trigger({type:"selected",val:this.id(data),choice:data});
if(this.select||!this.opts.closeOnSelect){this.postprocessResults()}if(this.opts.closeOnSelect){this.close();
this.search.width(10)}else{if(this.countSelectableResults()>0){this.search.width(10);this.resizeSearch();
if(this.getMaximumSelectionSize()>0&&this.val().length>=this.getMaximumSelectionSize()){this.updateResults(true)
}this.positionDropdown()}else{this.close();this.search.width(10)}}this.triggerChange({added:data});if(!options||!options.noFocus){this.focusSearch()
}},cancel:function(){this.close();this.focusSearch()},addSelectedChoice:function(data){if(!data||!data.id||!data.text||(data.id==""&&data.text=="")){return
}var enableChoice=!data.locked,enabledItem=$("<li class='select2-search-choice'>"+"    <div></div>"+"    <a href='#' onclick='return false;' class='select2-search-choice-close' tabindex='-1'></a>"+"</li>"),disabledItem=$("<li class='select2-search-choice select2-locked'>"+"<div></div>"+"</li>");
var choice=enableChoice?enabledItem:disabledItem,id=this.id(data),val=this.getVal(),formatted;formatted=this.opts.formatSelection(data,choice.find("div"));
if(formatted!=undefined){if(formatted.type=="html"){formatted=$(formatted.value)}else{if(formatted.type=="el"){formatted=formatted.value
}else{if(typeof formatted.value!="undefined"){formatted=this.opts.escapeMarkup(formatted.value)}else{formatted=this.opts.escapeMarkup(formatted)
}}}choice.find("div").html(formatted)}if(enableChoice){choice.find(".select2-search-choice-close").on("mousedown",killEvent).on("click dblclick",this.bind(function(e){if(!this.isInterfaceEnabled()){return
}$(e.target).closest(".select2-search-choice").fadeOut("fast",this.bind(function(){this.unselect($(e.target));
this.selection.find(".select2-search-choice-focus").removeClass("select2-search-choice-focus");this.close();
this.focusSearch()})).dequeue();killEvent(e)})).on("focus",this.bind(function(){if(!this.isInterfaceEnabled()){return
}this.container.addClass("select2-container-active");this.dropdown.addClass("select2-drop-active")}))
}choice.data("select2-data",data);choice.insertBefore(this.searchContainer);val.push(id);this.setVal(val);
this.search.val("")},unselect:function(selected){var val=this.getVal(),data,index;selected=selected.closest(".select2-search-choice");
if(selected.length===0){throw"Invalid argument: "+selected+". Must be .select2-search-choice"}data=selected.data("select2-data");
if(!data){return}index=indexOf(this.id(data),val);if(index>=0){val.splice(index,1);this.setVal(val);if(this.select){this.postprocessResults()
}}selected.remove();this.opts.element.trigger({type:"removed",val:this.id(data),choice:data});this.triggerChange({removed:data})
},postprocessResults:function(data,initial,noHighlightUpdate){var val=this.getVal(),choices=this.results.find(".select2-result"),compound=this.results.find(".select2-result-with-children"),self=this;
choices.each2(function(i,choice){var id=self.id(choice.data("select2-data"));if(indexOf(id,val)>=0){choice.addClass("select2-selected");
choice.find(".select2-result-selectable").addClass("select2-selected")}});compound.each2(function(i,choice){if(!choice.is(".select2-result-selectable")&&choice.find(".select2-result-selectable:not(.select2-selected)").length===0){choice.addClass("select2-selected")
}});if(this.highlight()==-1&&noHighlightUpdate!==false){self.highlight(0)}if(!this.opts.createSearchChoice&&!choices.filter(".select2-result:not(.select2-selected)").length>0){this.results.append("<li class='select2-no-results'>"+self.opts.formatNoMatches(self.search.val())+"</li>")
}},getMaxSearchWidth:function(){return this.selection.width()-getSideBorderPadding(this.search)},resizeSearch:function(){var minimumWidth,left,maxWidth,containerLeft,searchWidth,sideBorderPadding=getSideBorderPadding(this.search);
minimumWidth=measureTextWidth(this.search)+10;left=this.search.offset().left;maxWidth=this.selection.width();
containerLeft=this.selection.offset().left;searchWidth=maxWidth-(left-containerLeft)-sideBorderPadding;
if(searchWidth<minimumWidth){searchWidth=maxWidth-sideBorderPadding}if(searchWidth<40){searchWidth=maxWidth-sideBorderPadding
}if(searchWidth<=0){searchWidth=minimumWidth}this.search.width(searchWidth)},getVal:function(){var val;
if(this.select){val=this.select.val();return val===null?[]:val}else{val=this.opts.element.val();return splitVal(val,this.opts.separator)
}},setVal:function(val){var unique;if(this.select){this.select.val(val)}else{unique=[];$(val).each(function(){if(indexOf(this,unique)<0){unique.push(this)
}});this.opts.element.val(unique.length===0?"":unique.join(this.opts.separator))}},buildChangeDetails:function(old,current){var current=current.slice(0),old=old.slice(0);
for(var i=0;i<current.length;i++){for(var j=0;j<old.length;j++){if(equal(this.opts.id(current[i]),this.opts.id(old[j]))){current.splice(i,1);
i--;old.splice(j,1);j--}}}return{added:current,removed:old}},val:function(val,triggerChange){var oldData,self=this,changeDetails;
if(arguments.length===0){return this.getVal()}oldData=this.data();if(!oldData.length){oldData=[]}if(!val&&val!==0){this.opts.element.val("");
this.updateSelection([]);this.clearSearch();if(triggerChange){this.triggerChange({added:this.data(),removed:oldData})
}return}this.setVal(val);if(this.select){this.opts.initSelection(this.select,this.bind(this.updateSelection));
if(triggerChange){this.triggerChange(this.buildChangeDetails(oldData,this.data()))}}else{if(this.opts.initSelection===undefined){throw new Error("val() cannot be called if initSelection() is not defined")
}this.opts.initSelection(this.opts.element,function(data){var ids=$(data).map(self.id);self.setVal(ids);
self.updateSelection(data);self.clearSearch();if(triggerChange){self.triggerChange(this.buildChangeDetails(oldData,this.data()))
}})}this.clearSearch()},onSortStart:function(){if(this.select){throw new Error("Sorting of elements is not supported when attached to <select>. Attach to <input type='hidden'/> instead.")
}this.search.width(0);this.searchContainer.hide()},onSortEnd:function(){var val=[],self=this;this.searchContainer.show();
this.searchContainer.appendTo(this.searchContainer.parent());this.resizeSearch();this.selection.find(".select2-search-choice").each(function(){val.push(self.opts.id($(this).data("select2-data")))
});this.setVal(val);this.triggerChange()},data:function(values,triggerChange){var self=this,ids,old;if(arguments.length===0){return this.selection.find(".select2-search-choice").map(function(){return $(this).data("select2-data")
}).get()}else{old=this.data();if(!values){values=[]}ids=$.map(values,function(e){return self.opts.id(e)
});this.setVal(ids);this.updateSelection(values);this.clearSearch();if(triggerChange){this.triggerChange(this.buildChangeDetails(old,this.data()))
}}}});$.fn.select2=function(){var args=Array.prototype.slice.call(arguments,0),opts,select2,value,multiple,allowedMethods=["val","destroy","opened","open","close","focus","isFocused","container","onSortStart","onSortEnd","enable","readonly","positionDropdown","data"],valueMethods=["val","opened","isFocused","container","data"];
this.each(function(){if(args.length===0||typeof(args[0])==="object"){opts=args.length===0?{}:$.extend({},args[0]);
opts.element=$(this);if(opts.element.get(0).tagName.toLowerCase()==="select"){multiple=opts.element.prop("multiple")
}else{multiple=opts.multiple||false;if("tags" in opts){opts.multiple=multiple=true}}select2=multiple?new MultiSelect2():new SingleSelect2();
select2.init(opts)}else{if(typeof(args[0])==="string"){if(indexOf(args[0],allowedMethods)<0){throw"Unknown method: "+args[0]
}value=undefined;select2=$(this).data("select2");if(select2===undefined){return}if(args[0]==="container"){value=select2.container
}else{value=select2[args[0]].apply(select2,args.slice(1))}if(indexOf(args[0],valueMethods)>=0){return false
}}else{throw"Invalid arguments to select2 plugin: "+args}}});return(value===undefined)?this:value};$.fn.select2.defaults={width:"copy",loadMorePadding:0,closeOnSelect:true,openOnEnter:true,containerCss:{},dropdownCss:{},containerCssClass:"",dropdownCssClass:"",formatResult:function(result,container,query,escapeMarkup){var markup=[];
markMatch(result.text,query.term,markup,escapeMarkup);return markup.join("")},formatSelection:function(data,container){return data?data.text:undefined
},sortResults:function(results,container,query){return results},formatResultCssClass:function(data){return undefined
},formatNoMatches:function(){return"No matches found"},formatInputTooShort:function(input,min){var n=min-input.length;
return"Please enter "+n+" more character"+(n==1?"":"s")},formatInputTooLong:function(input,max){var n=input.length-max;
return"Please delete "+n+" character"+(n==1?"":"s")},formatSelectionTooBig:function(limit){return"You can only select "+limit+" item"+(limit==1?"":"s")
},formatLoadMore:function(pageNumber){return"Loading more results..."},formatSearching:function(){return"Searching..."
},minimumResultsForSearch:0,minimumInputLength:0,maximumInputLength:null,maximumSelectionSize:0,id:function(e){return e.id
},matcher:function(term,text){return(""+text).toUpperCase().indexOf((""+term).toUpperCase())>=0},separator:",",tokenSeparators:[],tokenizer:defaultTokenizer,escapeMarkup:function(markup){var replace_map={"\\":"&#92;","&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#47;"};
return String(markup).replace(/[&<>"'\/\\]/g,function(match){return replace_map[match]})},blurOnChange:false,selectOnBlur:false,adaptContainerCssClass:function(c){return c
},adaptDropdownCssClass:function(c){return null}};$.fn.select2.ajaxDefaults={transport:$.ajax,params:{type:"GET",cache:false,dataType:"json"}};
window.Select2={query:{ajax:ajax,local:local,tags:tags},util:{debounce:debounce,markMatch:markMatch},"class":{"abstract":AbstractSelect2,"single":SingleSelect2,"multi":MultiSelect2}}
}(jQuery));
/*!
 * zeroclipboard
 * The ZeroClipboard library provides an easy way to copy text to the clipboard using an invisible Adobe Flash movie, and a JavaScript interface.
 * Copyright 2013 Jon Rohan, James M. Greene, .
 * Released under the MIT license
 * http://zeroclipboard.github.io/ZeroClipboard/
 * v1.2.0-beta.4
 */
(function(){var a=function(){var a=/\-([a-z])/g,b=function(a,b){return b.toUpperCase()
};return function(c){return c.replace(a,b)}}(),b=function(b,c){var d,e,f,g,h,i;window.getComputedStyle?d=window.getComputedStyle(b,null).getPropertyValue(c):(e=a(c),b.currentStyle?d=b.currentStyle[e]:d=b.style[e]);
if(c==="cursor"){if(!d||d==="auto"){f=b.tagName.toLowerCase(),g=["a"];for(h=0,i=g.length;h<i;h++){if(f===g[h]){return"pointer"
}}}}return d},c=function(a){if(!o.prototype._singleton){return}a||(a=window.event);var b;this!==window?b=this:a.target?b=a.target:a.srcElement&&(b=a.srcElement),o.prototype._singleton.setCurrent(b)
},d=function(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent&&a.attachEvent("on"+b,c)
},e=function(a,b,c){a.removeEventListener?a.removeEventListener(b,c,!1):a.detachEvent&&a.detachEvent("on"+b,c)
},f=function(a,b){if(a.addClass){return a.addClass(b),a}if(b&&typeof b=="string"){var c=(b||"").split(/\s+/);
if(a.nodeType===1){if(!a.className){a.className=b}else{var d=" "+a.className+" ",e=a.className;for(var f=0,g=c.length;
f<g;f++){d.indexOf(" "+c[f]+" ")<0&&(e+=" "+c[f])}a.className=e.replace(/^\s+|\s+$/g,"")}}}return a},g=function(a,b){if(a.removeClass){return a.removeClass(b),a
}if(b&&typeof b=="string"||b===undefined){var c=(b||"").split(/\s+/);if(a.nodeType===1&&a.className){if(b){var d=(" "+a.className+" ").replace(/[\n\t]/g," ");
for(var e=0,f=c.length;e<f;e++){d=d.replace(" "+c[e]+" "," ")}a.className=d.replace(/^\s+|\s+$/g,"")}else{a.className=""
}}}return a},h=function(){var a,b,c,d=1;return typeof document.body.getBoundingClientRect=="function"&&(a=document.body.getBoundingClientRect(),b=a.right-a.left,c=document.body.offsetWidth,d=Math.round(b/c*100)/100),d
},i=function(a){var c={left:0,top:0,width:0,height:0,zIndex:999999999},d=b(a,"z-index");d&&d!=="auto"&&(c.zIndex=parseInt(d,10));
if(a.getBoundingClientRect){var e=a.getBoundingClientRect(),f,g,i;"pageXOffset" in window&&"pageYOffset" in window?(f=window.pageXOffset,g=window.pageYOffset):(i=h(),f=Math.round(document.documentElement.scrollLeft/i),g=Math.round(document.documentElement.scrollTop/i));
var j=document.documentElement.clientLeft||0,k=document.documentElement.clientTop||0;c.left=e.left+f-j,c.top=e.top+g-k,c.width="width" in e?e.width:e.right-e.left,c.height="height" in e?e.height:e.bottom-e.top
}return c},j=function(a){var b=o.prototype._singleton;return b.options.useNoCache?(a.indexOf("?")>=0?"&nocache=":"?nocache=")+(new Date).getTime():""
},k=function(a){var b=[];if(a.trustedDomains){var c;typeof a.trustedDomains=="string"&&a.trustedDomains?c=[a.trustedDomains]:"length" in a.trustedDomains&&(c=a.trustedDomains),b.push("trustedDomain="+encodeURIComponent(c.join(",")))
}return typeof a.amdModuleId=="string"&&a.amdModuleId&&b.push("amdModuleId="+encodeURIComponent(a.amdModuleId)),typeof a.cjsModuleId=="string"&&a.cjsModuleId&&b.push("cjsModuleId="+encodeURIComponent(a.cjsModuleId)),b.join("&")
},l=function(a,b){if(b.indexOf){return b.indexOf(a)}for(var c=0,d=b.length;c<d;c++){if(b[c]===a){return c
}}return -1},m=function(a){if(typeof a=="string"){throw new TypeError("ZeroClipboard doesn't accept query strings.")
}return a.length?a:[a]},n=function(a,b,c,d,e){e?window.setTimeout(function(){a.call(b,c,d)},0):a.call(b,c,d)
},o=function(a,b){a&&(o.prototype._singleton||this).glue(a);if(o.prototype._singleton){return o.prototype._singleton
}o.prototype._singleton=this,this.options={};for(var c in s){this.options[c]=s[c]}for(var d in b){this.options[d]=b[d]
}this.handlers={},o.detectFlashSupport()&&v()},p,q=[];o.prototype.setCurrent=function(a){p=a,this.reposition();
var c=a.getAttribute("title");c&&this.setTitle(c);var d=this.options.forceHandCursor===!0||b(a,"cursor")==="pointer";
r.call(this,d)},o.prototype.setText=function(a){a&&a!==""&&(this.options.text=a,this.ready()&&this.flashBridge.setText(a))
},o.prototype.setTitle=function(a){a&&a!==""&&this.htmlBridge.setAttribute("title",a)},o.prototype.setSize=function(a,b){this.ready()&&this.flashBridge.setSize(a,b)
},o.prototype.setHandCursor=function(a){a=typeof a=="boolean"?a:!!a,r.call(this,a),this.options.forceHandCursor=a
};var r=function(a){this.ready()&&this.flashBridge.setHandCursor(a)};o.version="1.2.0-beta.4";var s={moviePath:"ZeroClipboard.swf",trustedDomains:null,text:null,hoverClass:"zeroclipboard-is-hover",activeClass:"zeroclipboard-is-active",allowScriptAccess:"sameDomain",useNoCache:!0,forceHandCursor:!1};
o.setDefaults=function(a){for(var b in a){s[b]=a[b]}},o.destroy=function(){o.prototype._singleton.unglue(q);
var a=o.prototype._singleton.htmlBridge;a.parentNode.removeChild(a),delete o.prototype._singleton},o.detectFlashSupport=function(){var a=!1;
if(typeof ActiveXObject=="function"){try{new ActiveXObject("ShockwaveFlash.ShockwaveFlash")&&(a=!0)}catch(b){}}return !a&&navigator.mimeTypes["application/x-shockwave-flash"]&&(a=!0),a
};var t=null,u=null,v=function(){var a=o.prototype._singleton,b=document.getElementById("global-zeroclipboard-html-bridge");
if(!b){var c={};for(var d in a.options){c[d]=a.options[d]}c.amdModuleId=t,c.cjsModuleId=u;var e=k(c),f='      <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="global-zeroclipboard-flash-bridge" width="100%" height="100%">         <param name="movie" value="'+a.options.moviePath+j(a.options.moviePath)+'"/>         <param name="allowScriptAccess" value="'+a.options.allowScriptAccess+'"/>         <param name="scale" value="exactfit"/>         <param name="loop" value="false"/>         <param name="menu" value="false"/>         <param name="quality" value="best" />         <param name="bgcolor" value="#ffffff"/>         <param name="wmode" value="transparent"/>         <param name="flashvars" value="'+e+'"/>         <embed src="'+a.options.moviePath+j(a.options.moviePath)+'"           loop="false" menu="false"           quality="best" bgcolor="#ffffff"           width="100%" height="100%"           name="global-zeroclipboard-flash-bridge"           allowScriptAccess="always"           allowFullScreen="false"           type="application/x-shockwave-flash"           wmode="transparent"           pluginspage="http://www.macromedia.com/go/getflashplayer"           flashvars="'+e+'"           scale="exactfit">         </embed>       </object>';
b=document.createElement("div"),b.id="global-zeroclipboard-html-bridge",b.setAttribute("class","global-zeroclipboard-container"),b.setAttribute("data-clipboard-ready",!1),b.style.position="absolute",b.style.left="-9999px",b.style.top="-9999px",b.style.width="15px",b.style.height="15px",b.style.zIndex="9999",b.innerHTML=f,document.body.appendChild(b)
}a.htmlBridge=b,a.flashBridge=document["global-zeroclipboard-flash-bridge"]||b.children[0].lastElementChild
};o.prototype.resetBridge=function(){this.htmlBridge.style.left="-9999px",this.htmlBridge.style.top="-9999px",this.htmlBridge.removeAttribute("title"),this.htmlBridge.removeAttribute("data-clipboard-text"),g(p,this.options.activeClass),p=null,this.options.text=null
},o.prototype.ready=function(){var a=this.htmlBridge.getAttribute("data-clipboard-ready");return a==="true"||a===!0
},o.prototype.reposition=function(){if(!p){return !1}var a=i(p);this.htmlBridge.style.top=a.top+"px",this.htmlBridge.style.left=a.left+"px",this.htmlBridge.style.width=a.width+"px",this.htmlBridge.style.height=a.height+"px",this.htmlBridge.style.zIndex=a.zIndex+1,this.setSize(a.width,a.height)
},o.dispatch=function(a,b){o.prototype._singleton.receiveEvent(a,b)},o.prototype.on=function(a,b){var c=a.toString().split(/\s/g);
for(var d=0;d<c.length;d++){a=c[d].toLowerCase().replace(/^on/,""),this.handlers[a]||(this.handlers[a]=b)
}this.handlers.noflash&&!o.detectFlashSupport()&&this.receiveEvent("onNoFlash",null)},o.prototype.addEventListener=o.prototype.on,o.prototype.off=function(a,b){var c=a.toString().split(/\s/g);
for(var d=0;d<c.length;d++){a=c[d].toLowerCase().replace(/^on/,"");for(var e in this.handlers){e===a&&this.handlers[e]===b&&delete this.handlers[e]
}}},o.prototype.removeEventListener=o.prototype.off,o.prototype.receiveEvent=function(a,b){a=a.toString().toLowerCase().replace(/^on/,"");
var c=p,d=!0;switch(a){case"load":if(b&&parseFloat(b.flashVersion.replace(",",".").replace(/[^0-9\.]/gi,""))<10){this.receiveEvent("onWrongFlash",{flashVersion:b.flashVersion});
return}this.htmlBridge.setAttribute("data-clipboard-ready",!0);break;case"mouseover":f(c,this.options.hoverClass);
break;case"mouseout":g(c,this.options.hoverClass),this.resetBridge();break;case"mousedown":f(c,this.options.activeClass);
break;case"mouseup":g(c,this.options.activeClass);break;case"datarequested":var e=c.getAttribute("data-clipboard-target"),h=e?document.getElementById(e):null;
if(h){var i=h.value||h.textContent||h.innerText;i&&this.setText(i)}else{var j=c.getAttribute("data-clipboard-text");
j&&this.setText(j)}d=!1;break;case"complete":this.options.text=null}if(this.handlers[a]){var k=this.handlers[a];
typeof k=="string"&&typeof window[k]=="function"&&(k=window[k]),typeof k=="function"&&n(k,c,this,b,d)
}},o.prototype.glue=function(a){a=m(a);for(var b=0;b<a.length;b++){l(a[b],q)==-1&&(q.push(a[b]),d(a[b],"mouseover",c))
}},o.prototype.unglue=function(a){a=m(a);for(var b=0;b<a.length;b++){e(a[b],"mouseover",c);var d=l(a[b],q);
d!=-1&&q.splice(d,1)}},typeof define=="function"&&define.amd?define(["require","exports","module"],function(a,b,c){return t=c&&c.id||null,o
}):typeof module!="undefined"&&module?(u=module.id||null,module.exports=o):window.ZeroClipboard=o})();
(function(j,h,i){"function"===typeof define?define(h):"undefined"!==typeof module&&module.exports?module.exports=h():i[j]=h()
})("IDBStore",function(){var j={storeName:"Store",storePrefix:"IDBWrapper-",dbVersion:1,keyPath:"id",autoIncrement:!0,onStoreReady:function(){},onError:function(a){throw a
},indexes:[]},h=function(a,c){for(var b in j){this[b]="undefined"!=typeof a[b]?a[b]:j[b]}this.dbName=this.storePrefix+this.storeName;
this.dbVersion=parseInt(this.dbVersion,10);c&&(this.onStoreReady=c);this.idb=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB;
this.keyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.mozIDBKeyRange;this.consts={READ_ONLY:"readonly",READ_WRITE:"readwrite",VERSION_CHANGE:"versionchange",NEXT:"next",NEXT_NO_DUPLICATE:"nextunique",PREV:"prev",PREV_NO_DUPLICATE:"prevunique"};
this.openDB()};h.prototype={version:"1.1.0",db:null,dbName:null,dbVersion:null,store:null,storeName:null,keyPath:null,autoIncrement:null,indexes:null,features:null,onStoreReady:null,onError:null,_insertIdCount:0,openDB:function(){(this.features={}).hasAutoIncrement=!window.mozIndexedDB;
var a=this.idb.open(this.dbName,this.dbVersion),c=!1;a.onerror=function(a){var c=!1;"error" in a.target?c="VersionError"==a.target.error.name:"errorCode" in a.target&&(c=12==a.target.errorCode);
if(c){this.onError(Error("The version number provided is lower than the existing one."))}else{this.onError(a)
}}.bind(this);a.onsuccess=function(a){if(!c){if(this.db){this.onStoreReady()}else{if(this.db=a.target.result,"string"==typeof this.db.version){this.onError(Error("The IndexedDB implementation in this browser is outdated. Please upgrade your browser."))
}else{if(this.db.objectStoreNames.contains(this.storeName)){this.store=this.db.transaction([this.storeName],this.consts.READ_ONLY).objectStore(this.storeName),this.indexes.forEach(function(a){var b=a.name;
b?(this.normalizeIndexData(a),this.hasIndex(b)?this.indexComplies(this.store.index(b),a)||(c=!0,this.onError(Error('Cannot modify index "'+b+'" for current version. Please bump version number to '+(this.dbVersion+1)+"."))):(c=!0,this.onError(Error('Cannot create new index "'+b+'" for current version. Please bump version number to '+(this.dbVersion+1)+".")))):(c=!0,this.onError(Error("Cannot create index: No index name given.")))
},this),c||this.onStoreReady()}else{this.onError(Error("Something is wrong with the IndexedDB implementation in this browser. Please upgrade your browser."))
}}}}}.bind(this);a.onupgradeneeded=function(a){this.db=a.target.result;this.store=this.db.objectStoreNames.contains(this.storeName)?a.target.transaction.objectStore(this.storeName):this.db.createObjectStore(this.storeName,{keyPath:this.keyPath,autoIncrement:this.autoIncrement});
this.indexes.forEach(function(a){var b=a.name;b||(c=!0,this.onError(Error("Cannot create index: No index name given.")));
this.normalizeIndexData(a);this.hasIndex(b)?this.indexComplies(this.store.index(b),a)||(this.store.deleteIndex(b),this.store.createIndex(b,a.keyPath,{unique:a.unique,multiEntry:a.multiEntry})):this.store.createIndex(b,a.keyPath,{unique:a.unique,multiEntry:a.multiEntry})
},this)}.bind(this)},deleteDatabase:function(){this.idb.deleteDatabase&&this.idb.deleteDatabase(this.dbName)
},put:function(a,c,b){b||(b=function(a){console.error("Could not write data.",a)});c||(c=i);var d=!1,f=null;
"undefined"==typeof a[this.keyPath]&&!this.features.hasAutoIncrement&&(a[this.keyPath]=this._getUID());
var e=this.db.transaction([this.storeName],this.consts.READ_WRITE);e.oncomplete=function(){(d?c:b)(f)
};e.onabort=b;e.onerror=b;a=e.objectStore(this.storeName).put(a);a.onsuccess=function(a){d=!0;f=a.target.result
};a.onerror=b},get:function(a,c,b){b||(b=function(a){console.error("Could not read data.",a)});c||(c=i);
var d=!1,f=null,e=this.db.transaction([this.storeName],this.consts.READ_ONLY);e.oncomplete=function(){(d?c:b)(f)
};e.onabort=b;e.onerror=b;a=e.objectStore(this.storeName).get(a);a.onsuccess=function(a){d=!0;f=a.target.result
};a.onerror=b},remove:function(a,c,b){b||(b=function(a){console.error("Could not remove data.",a)});c||(c=i);
var d=!1,f=null,e=this.db.transaction([this.storeName],this.consts.READ_WRITE);e.oncomplete=function(){(d?c:b)(f)
};e.onabort=b;e.onerror=b;a=e.objectStore(this.storeName)["delete"](a);a.onsuccess=function(a){d=!0;f=a.target.result
};a.onerror=b},batch:function(a,c,b){b||(b=function(a){console.error("Could not apply batch.",a)});c||(c=i);
"[object Array]"!=Object.prototype.toString.call(a)&&b(Error("dataArray argument must be of type Array."));
var d=this.db.transaction([this.storeName],this.consts.READ_WRITE);d.oncomplete=function(){(g?c:b)(g)
};d.onabort=b;d.onerror=b;var f=a.length,e=!1,g=!1,h=function(){f--;0===f&&!e&&(g=e=!0)};a.forEach(function(a){var c=a.type,f=a.key,g=a.value,a=function(a){d.abort();
e||(e=!0,b(a,c,f))};if("remove"==c){g=d.objectStore(this.storeName)["delete"](f),g.onsuccess=h,g.onerror=a
}else{if("put"==c){"undefined"==typeof g[this.keyPath]&&!this.features.hasAutoIncrement&&(g[this.keyPath]=this._getUID()),g=d.objectStore(this.storeName).put(g),g.onsuccess=h,g.onerror=a
}}},this)},getAll:function(a,c){c||(c=function(a){console.error("Could not read data.",a)});a||(a=i);
var b=this.db.transaction([this.storeName],this.consts.READ_ONLY),d=b.objectStore(this.storeName);d.getAll?this._getAllNative(b,d,a,c):this._getAllCursor(b,d,a,c)
},_getAllNative:function(a,c,b,d){var f=!1,e=null;a.oncomplete=function(){(f?b:d)(e)};a.onabort=d;a.onerror=d;
a=c.getAll();a.onsuccess=function(a){f=!0;e=a.target.result};a.onerror=d},_getAllCursor:function(a,c,b,d){var f=[],e=!1,g=null;
a.oncomplete=function(){(e?b:d)(g)};a.onabort=d;a.onerror=d;a=c.openCursor();a.onsuccess=function(a){(a=a.target.result)?(f.push(a.value),a["continue"]()):(e=!0,g=f)
};a.onError=d},clear:function(a,c){c||(c=function(a){console.error("Could not clear store.",a)});a||(a=i);
var b=!1,d=null,f=this.db.transaction([this.storeName],this.consts.READ_WRITE);f.oncomplete=function(){(b?a:c)(d)
};f.onabort=c;f.onerror=c;f=f.objectStore(this.storeName).clear();f.onsuccess=function(a){b=!0;d=a.target.result
};f.onerror=c},_getUID:function(){return this._insertIdCount+++Date.now()},getIndexList:function(){return this.store.indexNames
},hasIndex:function(a){return this.store.indexNames.contains(a)},normalizeIndexData:function(a){a.keyPath=a.keyPath||a.name;
a.unique=!!a.unique;a.multiEntry=!!a.multiEntry},indexComplies:function(a,c){return["keyPath","unique","multiEntry"].every(function(b){return"multiEntry"==b&&void 0===a[b]&&!1===c[b]?!0:c[b]==a[b]
})},iterate:function(a,c){var c=k({index:null,order:"ASC",filterDuplicates:!1,keyRange:null,writeAccess:!1,onEnd:null,onError:function(a){console.error("Could not open cursor.",a)
}},c||{}),b="desc"==c.order.toLowerCase()?"PREV":"NEXT";c.filterDuplicates&&(b+="_NO_DUPLICATE");var d=!1,f=this.db.transaction([this.storeName],this.consts[c.writeAccess?"READ_WRITE":"READ_ONLY"]),e=f.objectStore(this.storeName);
c.index&&(e=e.index(c.index));f.oncomplete=function(){if(d){if(c.onEnd){c.onEnd()}else{a(null)}}else{c.onError(null)
}};f.onabort=c.onError;f.onerror=c.onError;b=e.openCursor(c.keyRange,this.consts[b]);b.onerror=c.onError;
b.onsuccess=function(b){(b=b.target.result)?(a(b.value,b,f),b["continue"]()):d=!0}},query:function(a,c){var b=[],c=c||{};
c.onEnd=function(){a(b)};this.iterate(function(a){b.push(a)},c)},count:function(a,c){var c=k({index:null,keyRange:null},c||{}),b=c.onError||function(a){console.error("Could not open cursor.",a)
},d=!1,f=null,e=this.db.transaction([this.storeName],this.consts.READ_ONLY);e.oncomplete=function(){(d?a:b)(f)
};e.onabort=b;e.onerror=b;e=e.objectStore(this.storeName);c.index&&(e=e.index(c.index));e=e.count(c.keyRange);
e.onsuccess=function(a){d=!0;f=a.target.result};e.onError=b},makeKeyRange:function(a){var c="undefined"!=typeof a.lower,b="undefined"!=typeof a.upper;
switch(!0){case c&&b:a=this.keyRange.bound(a.lower,a.upper,a.excludeLower,a.excludeUpper);break;case c:a=this.keyRange.lowerBound(a.lower,a.excludeLower);
break;case b:a=this.keyRange.upperBound(a.upper,a.excludeUpper);break;default:throw Error('Cannot create KeyRange. Provide one or both of "lower" or "upper" value.')
}return a}};var i=function(){},l={},k=function(a,c){var b,d;for(b in c){d=c[b],d!==l[b]&&d!==a[b]&&(a[b]=d)
}return a};h.version=h.prototype.version;return h},this);var Twig=(function(Twig){Twig.VERSION="0.5.8";
return Twig})(Twig||{});var Twig=(function(Twig){Twig.trace=false;Twig.debug=false;Twig.cache=true;Twig.placeholders={parent:"{{|PARENT|}}"};
Twig.Error=function(message){this.message=message;this.name="TwigException";this.type="TwigException"
};Twig.Error.prototype.toString=function(){return this.name+": "+this.message};Twig.log={trace:function(){if(Twig.trace&&console){console.log(Array.prototype.slice.call(arguments))
}},debug:function(){if(Twig.debug&&console){console.log(Array.prototype.slice.call(arguments))}}};Twig.token={};
Twig.token.type={output:"output",logic:"logic",comment:"comment",raw:"raw"};Twig.token.definitions=[{type:Twig.token.type.raw,open:"{% raw %}",close:"{% endraw %}"},{type:Twig.token.type.output,open:"{{",close:"}}"},{type:Twig.token.type.logic,open:"{%",close:"%}"},{type:Twig.token.type.comment,open:"{#",close:"#}"}];
Twig.token.strings=['"',"'"];Twig.token.findStart=function(template){var output={position:null,def:null},i,token_template,first_key_position;
for(i=0;i<Twig.token.definitions.length;i++){token_template=Twig.token.definitions[i];first_key_position=template.indexOf(token_template.open);
Twig.log.trace("Twig.token.findStart: ","Searching for ",token_template.open," found at ",first_key_position);
if(first_key_position>=0&&(output.position===null||first_key_position<output.position)){output.position=first_key_position;
output.def=token_template}}return output};Twig.token.findEnd=function(template,token_def,start){var end=null,found=false,offset=0,str_pos=null,str_found=null,pos=null,end_offset=null,this_str_pos=null,end_str_pos=null,i,l;
while(!found){str_pos=null;str_found=null;pos=template.indexOf(token_def.close,offset);if(pos>=0){end=pos;
found=true}else{throw new Twig.Error("Unable to find closing bracket '"+token_def.close+"'"+" opened near template position "+start)
}if(token_def.type===Twig.token.type.comment){break}l=Twig.token.strings.length;for(i=0;i<l;i+=1){this_str_pos=template.indexOf(Twig.token.strings[i],offset);
if(this_str_pos>0&&this_str_pos<pos&&(str_pos===null||this_str_pos<str_pos)){str_pos=this_str_pos;str_found=Twig.token.strings[i]
}}if(str_pos!==null){end_offset=str_pos+1;end=null;found=false;while(true){end_str_pos=template.indexOf(str_found,end_offset);
if(end_str_pos<0){throw"Unclosed string in template"}if(template.substr(end_str_pos-1,1)!=="\\"){offset=end_str_pos+1;
break}else{end_offset=end_str_pos+1}}}}return end};Twig.tokenize=function(template){var tokens=[],error_offset=0,found_token=null,end=null;
while(template.length>0){found_token=Twig.token.findStart(template);Twig.log.trace("Twig.tokenize: ","Found token: ",found_token);
if(found_token.position!==null){if(found_token.position>0){tokens.push({type:Twig.token.type.raw,value:template.substring(0,found_token.position)})
}template=template.substr(found_token.position+found_token.def.open.length);error_offset+=found_token.position+found_token.def.open.length;
end=Twig.token.findEnd(template,found_token.def,error_offset);Twig.log.trace("Twig.tokenize: ","Token ends at ",end);
tokens.push({type:found_token.def.type,value:template.substring(0,end).trim()});if(found_token.def.type==="logic"&&template.substr(end+found_token.def.close.length,1)==="\n"){end+=1
}template=template.substr(end+found_token.def.close.length);error_offset+=end+found_token.def.close.length
}else{tokens.push({type:Twig.token.type.raw,value:template});template=""}}return tokens};Twig.compile=function(tokens){var output=[],stack=[],intermediate_output=[],token=null,logic_token=null,unclosed_token=null,prev_token=null,prev_template=null,tok_output=null,type=null,open=null,next=null;
while(tokens.length>0){token=tokens.shift();Twig.log.trace("Compiling token ",token);switch(token.type){case Twig.token.type.raw:if(stack.length>0){intermediate_output.push(token)
}else{output.push(token)}break;case Twig.token.type.logic:logic_token=Twig.logic.compile.apply(this,[token]);
type=logic_token.type;open=Twig.logic.handler[type].open;next=Twig.logic.handler[type].next;Twig.log.trace("Twig.compile: ","Compiled logic token to ",logic_token," next is: ",next," open is : ",open);
if(open!==undefined&&!open){prev_token=stack.pop();prev_template=Twig.logic.handler[prev_token.type];
if(prev_template.next.indexOf(type)<0){throw new Error(type+" not expected after a "+prev_token.type)
}prev_token.output=prev_token.output||[];prev_token.output=prev_token.output.concat(intermediate_output);
intermediate_output=[];tok_output={type:Twig.token.type.logic,token:prev_token};if(stack.length>0){intermediate_output.push(tok_output)
}else{output.push(tok_output)}}if(next!==undefined&&next.length>0){Twig.log.trace("Twig.compile: ","Pushing ",logic_token," to logic stack.");
if(stack.length>0){prev_token=stack.pop();prev_token.output=prev_token.output||[];prev_token.output=prev_token.output.concat(intermediate_output);
stack.push(prev_token);intermediate_output=[]}stack.push(logic_token)}else{if(open!==undefined&&open){tok_output={type:Twig.token.type.logic,token:logic_token};
if(stack.length>0){intermediate_output.push(tok_output)}else{output.push(tok_output)}}}break;case Twig.token.type.comment:break;
case Twig.token.type.output:Twig.expression.compile.apply(this,[token]);if(stack.length>0){intermediate_output.push(token)
}else{output.push(token)}break}Twig.log.trace("Twig.compile: "," Output: ",output," Logic Stack: ",stack," Pending Output: ",intermediate_output)
}if(stack.length>0){unclosed_token=stack.pop();throw new Error("Unable to find an end tag for "+unclosed_token.type+", expecting one of "+unclosed_token.next)
}return output};Twig.parse=function(tokens,context){var output=[],chain=true,that=this;context=context||{};
tokens.forEach(function parseToken(token){Twig.log.debug("Twig.parse: ","Parsing token: ",token);switch(token.type){case Twig.token.type.raw:output.push(token.value);
break;case Twig.token.type.logic:var logic_token=token.token,logic=Twig.logic.parse.apply(that,[logic_token,context,chain]);
if(logic.chain!==undefined){chain=logic.chain}if(logic.context!==undefined){context=logic.context}if(logic.output!==undefined){output.push(logic.output)
}break;case Twig.token.type.comment:break;case Twig.token.type.output:Twig.log.debug("Twig.parse: ","Output token: ",token.stack);
output.push(Twig.expression.parse.apply(that,[token.stack,context]));break}});return output.join("")};
Twig.prepare=function(data){var tokens,raw_tokens;Twig.log.debug("Twig.prepare: ","Tokenizing ",data);
raw_tokens=Twig.tokenize.apply(this,[data]);Twig.log.debug("Twig.prepare: ","Compiling ",raw_tokens);
tokens=Twig.compile.apply(this,[raw_tokens]);Twig.log.debug("Twig.prepare: ","Compiled ",tokens);return tokens
};Twig.Templates={registry:{}};Twig.validateId=function(id){if(id==="prototype"){throw new Twig.Error(id+" is not a valid twig identifier")
}else{if(Twig.Templates.registry.hasOwnProperty(id)){throw new Twig.Error("There is already a template with the ID "+id)
}}return true};Twig.Templates.save=function(template){if(template.id===undefined){throw new Twig.Error("Unable to save template with no id")
}Twig.Templates.registry[template.id]=template};Twig.Templates.load=function(id){if(!Twig.Templates.registry.hasOwnProperty(id)){return null
}return Twig.Templates.registry[id]};Twig.Templates.loadRemote=function(location,params,callback,error_callback){var id=params.id,method=params.method,async=params.async,precompiled=params.precompiled,template=null;
if(async===undefined){async=true}if(id===undefined){id=location}params.id=id;if(Twig.cache&&Twig.Templates.registry.hasOwnProperty(id)){if(callback){callback(Twig.Templates.registry[id])
}return Twig.Templates.registry[id]}if(method=="ajax"){if(typeof XMLHttpRequest=="undefined"){throw new Twig.Error("Unsupported platform: Unable to do remote requests "+"because there is no XMLHTTPRequest implementation")
}var xmlhttp=new XMLHttpRequest();xmlhttp.onreadystatechange=function(){var data=null;if(xmlhttp.readyState==4){if(xmlhttp.status==200){Twig.log.debug("Got template ",xmlhttp.responseText);
if(precompiled===true){data=JSON.parse(xmlhttp.responseText)}else{data=xmlhttp.responseText}params.url=location;
params.data=data;template=new Twig.Template(params);if(callback){callback(template)}}else{if(error_callback){error_callback(xmlhttp)
}}}};xmlhttp.open("GET",location,async);xmlhttp.send()}else{(function(){var fs=require("fs"),path=require("path"),data=null,loadTemplateFn=function(err,data){if(err){if(error_callback){error_callback(err)
}return}if(precompiled===true){data=JSON.parse(data)}params.data=data;params.path=location;template=new Twig.Template(params);
if(callback){callback(template)}};if(async===true){fs.stat(location,function(err,stats){if(err||!stats.isFile()){throw new Twig.Error("Unable to find template file "+location)
}fs.readFile(location,"utf8",loadTemplateFn)})}else{if(!fs.statSync(location).isFile()){throw new Twig.Error("Unable to find template file "+location)
}data=fs.readFileSync(location,"utf8");loadTemplateFn(undefined,data)}})()}if(async===false){return template
}else{return true}};function is(type,obj){var clas=Object.prototype.toString.call(obj).slice(8,-1);return obj!==undefined&&obj!==null&&clas===type
}Twig.Template=function(params){var data=params.data,id=params.id,blocks=params.blocks,base=params.base,path=params.path,url=params.url,options=params.options;
this.id=id;this.base=base;this.path=path;this.url=url;this.options=options;this.reset(blocks);if(is("String",data)){this.tokens=Twig.prepare.apply(this,[data])
}else{this.tokens=data}if(id!==undefined){Twig.Templates.save(this)}};Twig.Template.prototype.reset=function(blocks){Twig.log.debug("Twig.Template.reset","Reseting template "+this.id);
this.blocks={};this.child={blocks:blocks||{}};this.extend=null};Twig.Template.prototype.render=function(context,params){params=params||{};
var output,url;this.context=context||{};this.reset();if(params.blocks){this.blocks=params.blocks}output=Twig.parse.apply(this,[this.tokens,this.context]);
if(this.extend){url=relativePath(this,this.extend);this.parent=Twig.Templates.loadRemote(url,{method:this.url?"ajax":"fs",base:this.base,async:false,id:url,options:this.options});
return this.parent.render(this.context,{blocks:this.blocks})}if(params.output=="blocks"){return this.blocks
}else{return output}};Twig.Template.prototype.importFile=function(file){var url,sub_template;if(!this.url&&!this.path&&this.options.allowInlineIncludes){sub_template=Twig.Templates.load(file);
sub_template.options=this.options;if(sub_template){return sub_template}throw new Twig.Error("Didn't find the inline template by id")
}url=relativePath(this,file);sub_template=Twig.Templates.loadRemote(url,{method:this.url?"ajax":"fs",base:this.base,async:false,options:this.options,id:url});
return sub_template};Twig.Template.prototype.importBlocks=function(file,override){var sub_template=this.importFile(file),context=this.context,that=this,key;
override=override||false;sub_template.render(context);Object.keys(sub_template.blocks).forEach(function(key){if(override||that.blocks[key]===undefined){that.blocks[key]=sub_template.blocks[key]
}})};Twig.Template.prototype.compile=function(options){return Twig.compiler.compile(this,options)};function relativePath(template,file){var base,base_path,sep_chr="/",new_path=[],val;
if(template.url){if(typeof template.base!=="undefined"){base=template.base+((template.base.charAt(template.base.length-1)==="/")?"":"/")
}else{base=template.url}}else{if(template.path){var path=require("path"),sep=path.sep||sep_chr,relative=new RegExp("^\\.{1,2}"+sep.replace("\\","\\\\"));
if(template.base!==undefined&&file.match(relative)==null){file=file.replace(template.base,"");base=template.base+sep
}else{base=template.path}base=base.replace(sep+sep,sep);sep_chr=sep}else{throw new Twig.Error("Cannot extend an inline template.")
}}base_path=base.split(sep_chr);base_path.pop();base_path=base_path.concat(file.split(sep_chr));while(base_path.length>0){val=base_path.shift();
if(val=="."){}else{if(val==".."&&new_path.length>0&&new_path[new_path.length-1]!=".."){new_path.pop()
}else{new_path.push(val)}}}return new_path.join(sep_chr)}return Twig})(Twig||{});(function(){if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")
}}if(!Array.prototype.indexOf){Array.prototype.indexOf=function(searchElement){if(this===void 0||this===null){throw new TypeError()
}var t=Object(this);var len=t.length>>>0;if(len===0){return -1}var n=0;if(arguments.length>0){n=Number(arguments[1]);
if(n!==n){n=0}else{if(n!==0&&n!==Infinity&&n!==-Infinity){n=(n>0||-1)*Math.floor(Math.abs(n))}}}if(n>=len){return -1
}var k=n>=0?n:Math.max(len-Math.abs(n),0);for(;k<len;k++){if(k in t&&t[k]===searchElement){return k}}return -1
}}if(!Array.prototype.forEach){Array.prototype.forEach=function(callback,thisArg){var T,k;if(this==null){throw new TypeError(" this is null or not defined")
}var O=Object(this);var len=O.length>>>0;if({}.toString.call(callback)!="[object Function]"){throw new TypeError(callback+" is not a function")
}if(thisArg){T=thisArg}k=0;while(k<len){var kValue;if(k in O){kValue=O[k];callback.call(T,kValue,k,O)
}k++}}}if(!Object.keys){Object.keys=function(o){if(o!==Object(o)){throw new TypeError("Object.keys called on non-object")
}var ret=[],p;for(p in o){if(Object.prototype.hasOwnProperty.call(o,p)){ret.push(p)}}return ret}}})();
var Twig=(function(Twig){Twig.lib={};var sprintf=(function(){function get_type(variable){return Object.prototype.toString.call(variable).slice(8,-1).toLowerCase()
}function str_repeat(input,multiplier){for(var output=[];multiplier>0;output[--multiplier]=input){}return output.join("")
}var str_format=function(){if(!str_format.cache.hasOwnProperty(arguments[0])){str_format.cache[arguments[0]]=str_format.parse(arguments[0])
}return str_format.format.call(null,str_format.cache[arguments[0]],arguments)};str_format.format=function(parse_tree,argv){var cursor=1,tree_length=parse_tree.length,node_type="",arg,output=[],i,k,match,pad,pad_character,pad_length;
for(i=0;i<tree_length;i++){node_type=get_type(parse_tree[i]);if(node_type==="string"){output.push(parse_tree[i])
}else{if(node_type==="array"){match=parse_tree[i];if(match[2]){arg=argv[cursor];for(k=0;k<match[2].length;
k++){if(!arg.hasOwnProperty(match[2][k])){throw (sprintf('[sprintf] property "%s" does not exist',match[2][k]))
}arg=arg[match[2][k]]}}else{if(match[1]){arg=argv[match[1]]}else{arg=argv[cursor++]}}if(/[^s]/.test(match[8])&&(get_type(arg)!="number")){throw (sprintf("[sprintf] expecting number but found %s",get_type(arg)))
}switch(match[8]){case"b":arg=arg.toString(2);break;case"c":arg=String.fromCharCode(arg);break;case"d":arg=parseInt(arg,10);
break;case"e":arg=match[7]?arg.toExponential(match[7]):arg.toExponential();break;case"f":arg=match[7]?parseFloat(arg).toFixed(match[7]):parseFloat(arg);
break;case"o":arg=arg.toString(8);break;case"s":arg=((arg=String(arg))&&match[7]?arg.substring(0,match[7]):arg);
break;case"u":arg=Math.abs(arg);break;case"x":arg=arg.toString(16);break;case"X":arg=arg.toString(16).toUpperCase();
break}arg=(/[def]/.test(match[8])&&match[3]&&arg>=0?"+"+arg:arg);pad_character=match[4]?match[4]=="0"?"0":match[4].charAt(1):" ";
pad_length=match[6]-String(arg).length;pad=match[6]?str_repeat(pad_character,pad_length):"";output.push(match[5]?arg+pad:pad+arg)
}}}return output.join("")};str_format.cache={};str_format.parse=function(fmt){var _fmt=fmt,match=[],parse_tree=[],arg_names=0;
while(_fmt){if((match=/^[^\x25]+/.exec(_fmt))!==null){parse_tree.push(match[0])}else{if((match=/^\x25{2}/.exec(_fmt))!==null){parse_tree.push("%")
}else{if((match=/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(_fmt))!==null){if(match[2]){arg_names|=1;
var field_list=[],replacement_field=match[2],field_match=[];if((field_match=/^([a-z_][a-z_\d]*)/i.exec(replacement_field))!==null){field_list.push(field_match[1]);
while((replacement_field=replacement_field.substring(field_match[0].length))!==""){if((field_match=/^\.([a-z_][a-z_\d]*)/i.exec(replacement_field))!==null){field_list.push(field_match[1])
}else{if((field_match=/^\[(\d+)\]/.exec(replacement_field))!==null){field_list.push(field_match[1])}else{throw ("[sprintf] huh?")
}}}}else{throw ("[sprintf] huh?")}match[2]=field_list}else{arg_names|=2}if(arg_names===3){throw ("[sprintf] mixing positional and named placeholders is not (yet) supported")
}parse_tree.push(match)}else{throw ("[sprintf] huh?")}}}_fmt=_fmt.substring(match[0].length)}return parse_tree
};return str_format})();var vsprintf=function(fmt,argv){argv.unshift(fmt);return sprintf.apply(null,argv)
};Twig.lib.sprintf=sprintf;Twig.lib.vsprintf=vsprintf;(function(){var shortDays="Sun,Mon,Tue,Wed,Thu,Fri,Sat".split(",");
var fullDays="Sunday,Monday,Tuesday,Wednesday,Thursday,Friday,Saturday".split(",");var shortMonths="Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec".split(",");
var fullMonths="January,February,March,April,May,June,July,August,September,October,November,December".split(",");
function getOrdinalFor(intNum){return(((intNum=Math.abs(intNum)%100)%10==1&&intNum!=11)?"st":(intNum%10==2&&intNum!=12)?"nd":(intNum%10==3&&intNum!=13)?"rd":"th")
}function getISO8601Year(aDate){var d=new Date(aDate.getFullYear()+1,0,4);if((d-aDate)/86400000<7&&(aDate.getDay()+6)%7<(d.getDay()+6)%7){return d.getFullYear()
}if(aDate.getMonth()>0||aDate.getDate()>=4){return aDate.getFullYear()}return aDate.getFullYear()-(((aDate.getDay()+6)%7-aDate.getDate()>2)?1:0)
}function getISO8601Week(aDate){var d=new Date(getISO8601Year(aDate),0,4);d.setDate(d.getDate()-(d.getDay()+6)%7);
return parseInt((aDate-d)/604800000)+1}Twig.lib.formatDate=function(date,format){if(typeof format!=="string"||/^\s*$/.test(format)){return date+""
}var jan1st=new Date(date.getFullYear(),0,1);var me=date;return format.replace(/[dDjlNSwzWFmMntLoYyaABgGhHisu]/g,function(option){switch(option){case"d":return("0"+me.getDate()).replace(/^.+(..)$/,"$1");
case"D":return shortDays[me.getDay()];case"j":return me.getDate();case"l":return fullDays[me.getDay()];
case"N":return(me.getDay()+6)%7+1;case"S":return getOrdinalFor(me.getDate());case"w":return me.getDay();
case"z":return Math.ceil((jan1st-me)/86400000);case"W":return("0"+getISO8601Week(me)).replace(/^.(..)$/,"$1");
case"F":return fullMonths[me.getMonth()];case"m":return("0"+(me.getMonth()+1)).replace(/^.+(..)$/,"$1");
case"M":return shortMonths[me.getMonth()];case"n":return me.getMonth()+1;case"t":return new Date(me.getFullYear(),me.getMonth()+1,-1).getDate();
case"L":return new Date(me.getFullYear(),1,29).getDate()==29?1:0;case"o":return getISO8601Year(me);case"Y":return me.getFullYear();
case"y":return(me.getFullYear()+"").replace(/^.+(..)$/,"$1");case"a":return me.getHours()<12?"am":"pm";
case"A":return me.getHours()<12?"AM":"PM";case"B":return Math.floor((((me.getUTCHours()+1)%24)+me.getUTCMinutes()/60+me.getUTCSeconds()/3600)*1000/24);
case"g":return me.getHours()%12!=0?me.getHours()%12:12;case"G":return me.getHours();case"h":return("0"+(me.getHours()%12!=0?me.getHours()%12:12)).replace(/^.+(..)$/,"$1");
case"H":return("0"+me.getHours()).replace(/^.+(..)$/,"$1");case"i":return("0"+me.getMinutes()).replace(/^.+(..)$/,"$1");
case"s":return("0"+me.getSeconds()).replace(/^.+(..)$/,"$1");case"u":return me.getMilliseconds()}})}})();
Twig.lib.strip_tags=function(input,allowed){allowed=(((allowed||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");
var tags=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,commentsAndPhpTags=/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;
return input.replace(commentsAndPhpTags,"").replace(tags,function($0,$1){return allowed.indexOf("<"+$1.toLowerCase()+">")>-1?$0:""
})};Twig.lib.strtotime=function(str,now){var i,l,match,s,parse="";str=str.replace(/\s{2,}|^\s|\s$/g," ");
str=str.replace(/[\t\r\n]/g,"");if(str==="now"){return now===null||isNaN(now)?new Date().getTime()/1000|0:now|0
}else{if(!isNaN(parse=Date.parse(str))){return parse/1000|0}else{if(now){now=new Date(now*1000)}else{now=new Date()
}}}str=str.toLowerCase();var __is={day:{"sun":0,"mon":1,"tue":2,"wed":3,"thu":4,"fri":5,"sat":6},mon:["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"]};
var process=function(m){var ago=(m[2]&&m[2]==="ago");var num=(num=m[0]==="last"?-1:1)*(ago?-1:1);switch(m[0]){case"last":case"next":switch(m[1].substring(0,3)){case"yea":now.setFullYear(now.getFullYear()+num);
break;case"wee":now.setDate(now.getDate()+(num*7));break;case"day":now.setDate(now.getDate()+num);break;
case"hou":now.setHours(now.getHours()+num);break;case"min":now.setMinutes(now.getMinutes()+num);break;
case"sec":now.setSeconds(now.getSeconds()+num);break;case"mon":if(m[1]==="month"){now.setMonth(now.getMonth()+num);
break}default:var day=__is.day[m[1].substring(0,3)];if(typeof day!=="undefined"){var diff=day-now.getDay();
if(diff===0){diff=7*num}else{if(diff>0){if(m[0]==="last"){diff-=7}}else{if(m[0]==="next"){diff+=7}}}now.setDate(now.getDate()+diff);
now.setHours(0,0,0,0)}}break;default:if(/\d+/.test(m[0])){num*=parseInt(m[0],10);switch(m[1].substring(0,3)){case"yea":now.setFullYear(now.getFullYear()+num);
break;case"mon":now.setMonth(now.getMonth()+num);break;case"wee":now.setDate(now.getDate()+(num*7));break;
case"day":now.setDate(now.getDate()+num);break;case"hou":now.setHours(now.getHours()+num);break;case"min":now.setMinutes(now.getMinutes()+num);
break;case"sec":now.setSeconds(now.getSeconds()+num);break}}else{return false}break}return true};match=str.match(/^(\d{2,4}-\d{2}-\d{2})(?:\s(\d{1,2}:\d{2}(:\d{2})?)?(?:\.(\d+))?)?$/);
if(match!==null){if(!match[2]){match[2]="00:00:00"}else{if(!match[3]){match[2]+=":00"}}s=match[1].split(/-/g);
s[1]=__is.mon[s[1]-1]||s[1];s[0]=+s[0];s[0]=(s[0]>=0&&s[0]<=69)?"20"+(s[0]<10?"0"+s[0]:s[0]+""):(s[0]>=70&&s[0]<=99)?"19"+s[0]:s[0]+"";
return parseInt(this.strtotime(s[2]+" "+s[1]+" "+s[0]+" "+match[2])+(match[4]?match[4]/1000:""),10)}var regex="([+-]?\\d+\\s"+"(years?|months?|weeks?|days?|hours?|min|minutes?|sec|seconds?"+"|sun\\.?|sunday|mon\\.?|monday|tue\\.?|tuesday|wed\\.?|wednesday"+"|thu\\.?|thursday|fri\\.?|friday|sat\\.?|saturday)"+"|(last|next)\\s"+"(years?|months?|weeks?|days?|hours?|min|minutes?|sec|seconds?"+"|sun\\.?|sunday|mon\\.?|monday|tue\\.?|tuesday|wed\\.?|wednesday"+"|thu\\.?|thursday|fri\\.?|friday|sat\\.?|saturday))"+"(\\sago)?";
match=str.match(new RegExp(regex,"gi"));if(match===null){return false}for(i=0,l=match.length;i<l;i++){if(!process(match[i].split(" "))){return false
}}return now.getTime()/1000|0};Twig.lib.is=function(type,obj){var clas=Object.prototype.toString.call(obj).slice(8,-1);
return obj!==undefined&&obj!==null&&clas===type};Twig.lib.copy=function(src){var target={},key;for(key in src){target[key]=src[key]
}return target};Twig.lib.replaceAll=function(string,search,replace){return string.split(search).join(replace)
};return Twig})(Twig||{});var Twig=(function(Twig){Twig.logic={};Twig.logic.type={if_:"Twig.logic.type.if",endif:"Twig.logic.type.endif",for_:"Twig.logic.type.for",endfor:"Twig.logic.type.endfor",else_:"Twig.logic.type.else",elseif:"Twig.logic.type.elseif",set:"Twig.logic.type.set",filter:"Twig.logic.type.filter",endfilter:"Twig.logic.type.endfilter",block:"Twig.logic.type.block",endblock:"Twig.logic.type.endblock",extends_:"Twig.logic.type.extends",use:"Twig.logic.type.use",include:"Twig.logic.type.include",spaceless:"Twig.logic.type.spaceless",endspaceless:"Twig.logic.type.endspaceless"};
Twig.logic.definitions=[{type:Twig.logic.type.if_,regex:/^if\s+([^\s].+)$/,next:[Twig.logic.type.else_,Twig.logic.type.elseif,Twig.logic.type.endif],open:true,compile:function(token){var expression=token.match[1];
token.stack=Twig.expression.compile.apply(this,[{type:Twig.expression.type.expression,value:expression}]).stack;
delete token.match;return token},parse:function(token,context,chain){var output="",result=Twig.expression.parse.apply(this,[token.stack,context]);
chain=true;if(result){chain=false;output=Twig.parse.apply(this,[token.output,context])}return{chain:chain,output:output}
}},{type:Twig.logic.type.elseif,regex:/^elseif\s+([^\s].*)$/,next:[Twig.logic.type.else_,Twig.logic.type.elseif,Twig.logic.type.endif],open:false,compile:function(token){var expression=token.match[1];
token.stack=Twig.expression.compile.apply(this,[{type:Twig.expression.type.expression,value:expression}]).stack;
delete token.match;return token},parse:function(token,context,chain){var output="";if(chain&&Twig.expression.parse.apply(this,[token.stack,context])===true){chain=false;
output=Twig.parse.apply(this,[token.output,context])}return{chain:chain,output:output}}},{type:Twig.logic.type.else_,regex:/^else$/,next:[Twig.logic.type.endif,Twig.logic.type.endfor],open:false,parse:function(token,context,chain){var output="";
if(chain){output=Twig.parse.apply(this,[token.output,context])}return{chain:chain,output:output}}},{type:Twig.logic.type.endif,regex:/^endif$/,next:[],open:false},{type:Twig.logic.type.for_,regex:/^for\s+([a-zA-Z0-9_,\s]+)\s+in\s+([^\s].*?)(?:\s+if\s+([^\s].*))?$/,next:[Twig.logic.type.else_,Twig.logic.type.endfor],open:true,compile:function(token){var key_value=token.match[1],expression=token.match[2],conditional=token.match[3],kv_split=null;
token.key_var=null;token.value_var=null;if(key_value.indexOf(",")>=0){kv_split=key_value.split(",");if(kv_split.length===2){token.key_var=kv_split[0].trim();
token.value_var=kv_split[1].trim()}else{throw new Twig.Error("Invalid expression in for loop: "+key_value)
}}else{token.value_var=key_value}token.expression=Twig.expression.compile.apply(this,[{type:Twig.expression.type.expression,value:expression}]).stack;
if(conditional){token.conditional=Twig.expression.compile.apply(this,[{type:Twig.expression.type.expression,value:conditional}]).stack
}delete token.match;return token},parse:function(token,context,continue_chain){var result=Twig.expression.parse.apply(this,[token.expression,context]),output=[],len,index=0,keyset,that=this,conditional=token.conditional,buildLoop=function(index,len){var isConditional=conditional!==undefined;
return{index:index+1,index0:index,revindex:isConditional?undefined:len-index,revindex0:isConditional?undefined:len-index-1,first:(index===0),last:isConditional?undefined:(index===len-1),length:isConditional?undefined:len,parent:context}
},loop=function(key,value){var inner_context=Twig.lib.copy(context);inner_context[token.value_var]=value;
if(token.key_var){inner_context[token.key_var]=key}inner_context.loop=buildLoop(index,len);if(conditional===undefined||Twig.expression.parse.apply(that,[conditional,inner_context])){output.push(Twig.parse.apply(that,[token.output,inner_context]));
index+=1}};if(result instanceof Array){len=result.length;result.forEach(function(value){var key=index;
loop(key,value)})}else{if(result instanceof Object){if(result._keys!==undefined){keyset=result._keys}else{keyset=Object.keys(result)
}len=keyset.length;keyset.forEach(function(key){if(key==="_keys"){return}loop(key,result[key])})}}continue_chain=(output.length===0);
return{chain:continue_chain,output:output.join("")}}},{type:Twig.logic.type.endfor,regex:/^endfor$/,next:[],open:false},{type:Twig.logic.type.set,regex:/^set\s+([a-zA-Z0-9_,\s]+)\s*=\s*(.+)$/,next:[],open:true,compile:function(token){var key=token.match[1].trim(),expression=token.match[2],expression_stack=Twig.expression.compile.apply(this,[{type:Twig.expression.type.expression,value:expression}]).stack;
token.key=key;token.expression=expression_stack;delete token.match;return token},parse:function(token,context,continue_chain){var value=Twig.expression.parse.apply(this,[token.expression,context]),key=token.key;
this.context[key]=value;context[key]=value;return{chain:continue_chain,context:context}}},{type:Twig.logic.type.filter,regex:/^filter\s+(.+)$/,next:[Twig.logic.type.endfilter],open:true,compile:function(token){var expression="|"+token.match[1].trim();
token.stack=Twig.expression.compile.apply(this,[{type:Twig.expression.type.expression,value:expression}]).stack;
delete token.match;return token},parse:function(token,context,chain){var unfiltered=Twig.parse.apply(this,[token.output,context]),stack=[{type:Twig.expression.type.string,value:unfiltered}].concat(token.stack);
var output=Twig.expression.parse.apply(this,[stack,context]);return{chain:chain,output:output}}},{type:Twig.logic.type.endfilter,regex:/^endfilter$/,next:[],open:false},{type:Twig.logic.type.block,regex:/^block\s+([a-zA-Z0-9_]+)$/,next:[Twig.logic.type.endblock],open:true,compile:function(token){token.block=token.match[1].trim();
delete token.match;return token},parse:function(token,context,chain){var block_output="",output="",hasParent=this.blocks[token.block]&&this.blocks[token.block].indexOf(Twig.placeholders.parent)>-1;
if(this.blocks[token.block]===undefined||hasParent){block_output=Twig.expression.parse.apply(this,[{type:Twig.expression.type.string,value:Twig.parse.apply(this,[token.output,context])},context]);
if(hasParent){this.blocks[token.block]=this.blocks[token.block].replace(Twig.placeholders.parent,block_output)
}else{this.blocks[token.block]=block_output}}if(this.child.blocks[token.block]){output=this.child.blocks[token.block]
}else{output=this.blocks[token.block]}return{chain:chain,output:output}}},{type:Twig.logic.type.endblock,regex:/^endblock$/,next:[],open:false},{type:Twig.logic.type.extends_,regex:/^extends\s+(.+)$/,next:[],open:true,compile:function(token){var expression=token.match[1].trim();
delete token.match;token.stack=Twig.expression.compile.apply(this,[{type:Twig.expression.type.expression,value:expression}]).stack;
return token},parse:function(token,context,chain){var file=Twig.expression.parse.apply(this,[token.stack,context]);
this.extend=file;return{chain:chain,output:""}}},{type:Twig.logic.type.use,regex:/^use\s+(.+)$/,next:[],open:true,compile:function(token){var expression=token.match[1].trim();
delete token.match;token.stack=Twig.expression.compile.apply(this,[{type:Twig.expression.type.expression,value:expression}]).stack;
return token},parse:function(token,context,chain){var file=Twig.expression.parse.apply(this,[token.stack,context]);
this.importBlocks(file);return{chain:chain,output:""}}},{type:Twig.logic.type.include,regex:/^include\s+(ignore missing\s+)?(.+?)\s*(?:with\s+(.+?))?\s*(only)?$/,next:[],open:true,compile:function(token){var match=token.match,includeMissing=match[1]!==undefined,expression=match[2].trim(),withContext=match[3],only=((match[4]!==undefined)&&match[4].length);
delete token.match;token.only=only;token.includeMissing=includeMissing;token.stack=Twig.expression.compile.apply(this,[{type:Twig.expression.type.expression,value:expression}]).stack;
if(withContext!==undefined){token.withStack=Twig.expression.compile.apply(this,[{type:Twig.expression.type.expression,value:withContext.trim()}]).stack
}return token},parse:function(token,context,chain){var innerContext={},withContext,i,template;if(!token.only){for(i in context){if(context.hasOwnProperty(i)){innerContext[i]=context[i]
}}}if(token.withStack!==undefined){withContext=Twig.expression.parse.apply(this,[token.withStack,context]);
for(i in withContext){if(withContext.hasOwnProperty(i)){innerContext[i]=withContext[i]}}}var file=Twig.expression.parse.apply(this,[token.stack,innerContext]);
template=this.importFile(file);return{chain:chain,output:template.render(innerContext)}}},{type:Twig.logic.type.spaceless,regex:/^spaceless$/,next:[Twig.logic.type.endspaceless],open:true,parse:function(token,context,chain){var unfiltered=Twig.parse.apply(this,[token.output,context]),rBetweenTagSpaces=/>\s+</g,output=unfiltered.replace(rBetweenTagSpaces,"><").trim();
return{chain:chain,output:output}}},{type:Twig.logic.type.endspaceless,regex:/^endspaceless$/,next:[],open:false}];
Twig.logic.handler={};Twig.logic.extendType=function(type,value){value=value||("Twig.logic.type"+type);
Twig.logic.type[type]=value};Twig.logic.extend=function(definition){if(!definition.type){throw new Twig.Error("Unable to extend logic definition. No type provided for "+definition)
}if(Twig.logic.type[definition.type]){throw new Twig.Error("Unable to extend logic definitions. Type "+definition.type+" is already defined.")
}else{Twig.logic.extendType(definition.type)}Twig.logic.handler[definition.type]=definition};while(Twig.logic.definitions.length>0){Twig.logic.extend(Twig.logic.definitions.shift())
}Twig.logic.compile=function(raw_token){var expression=raw_token.value.trim(),token=Twig.logic.tokenize.apply(this,[expression]),token_template=Twig.logic.handler[token.type];
if(token_template.compile){token=token_template.compile.apply(this,[token]);Twig.log.trace("Twig.logic.compile: ","Compiled logic token to ",token)
}return token};Twig.logic.tokenize=function(expression){var token={},token_template_type=null,token_type=null,token_regex=null,regex_array=null,regex=null,match=null;
expression=expression.trim();for(token_template_type in Twig.logic.handler){if(Twig.logic.handler.hasOwnProperty(token_template_type)){token_type=Twig.logic.handler[token_template_type].type;
token_regex=Twig.logic.handler[token_template_type].regex;regex_array=[];if(token_regex instanceof Array){regex_array=token_regex
}else{regex_array.push(token_regex)}while(regex_array.length>0){regex=regex_array.shift();match=regex.exec(expression.trim());
if(match!==null){token.type=token_type;token.match=match;Twig.log.trace("Twig.logic.tokenize: ","Matched a ",token_type," regular expression of ",match);
return token}}}}throw new Twig.Error("Unable to parse '"+expression.trim()+"'")};Twig.logic.parse=function(token,context,chain){var output="",token_template;
context=context||{};Twig.log.debug("Twig.logic.parse: ","Parsing logic token ",token);token_template=Twig.logic.handler[token.type];
if(token_template.parse){output=token_template.parse.apply(this,[token,context,chain])}return output};
return Twig})(Twig||{});var Twig=(function(Twig){Twig.expression={};Twig.expression.reservedWords=["true","false","null"];
Twig.expression.type={comma:"Twig.expression.type.comma",operator:{unary:"Twig.expression.type.operator.unary",binary:"Twig.expression.type.operator.binary"},string:"Twig.expression.type.string",bool:"Twig.expression.type.bool",array:{start:"Twig.expression.type.array.start",end:"Twig.expression.type.array.end"},object:{start:"Twig.expression.type.object.start",end:"Twig.expression.type.object.end"},parameter:{start:"Twig.expression.type.parameter.start",end:"Twig.expression.type.parameter.end"},key:{period:"Twig.expression.type.key.period",brackets:"Twig.expression.type.key.brackets"},filter:"Twig.expression.type.filter",_function:"Twig.expression.type._function",variable:"Twig.expression.type.variable",number:"Twig.expression.type.number",_null:"Twig.expression.type.null",test:"Twig.expression.type.test"};
Twig.expression.set={operations:[Twig.expression.type.filter,Twig.expression.type.operator.unary,Twig.expression.type.operator.binary,Twig.expression.type.array.end,Twig.expression.type.object.end,Twig.expression.type.parameter.end,Twig.expression.type.comma,Twig.expression.type.test],expressions:[Twig.expression.type._function,Twig.expression.type.bool,Twig.expression.type.string,Twig.expression.type.variable,Twig.expression.type.number,Twig.expression.type._null,Twig.expression.type.parameter.start,Twig.expression.type.array.start,Twig.expression.type.object.start]};
Twig.expression.set.operations_extended=Twig.expression.set.operations.concat([Twig.expression.type.key.period,Twig.expression.type.key.brackets]);
Twig.expression.fn={compile:{push:function(token,stack,output){output.push(token)},push_both:function(token,stack,output){output.push(token);
stack.push(token)}},parse:{push:function(token,stack,context){stack.push(token)},push_value:function(token,stack,context){stack.push(token.value)
}}};Twig.expression.definitions=[{type:Twig.expression.type.test,regex:/^is\s+(not)?\s*([a-zA-Z_][a-zA-Z0-9_]*)/,next:Twig.expression.set.operations.concat([Twig.expression.type.parameter.start]),compile:function(token,stack,output){token.filter=token.match[2];
token.modifier=token.match[1];delete token.match;delete token.value;output.push(token)},parse:function(token,stack,context){var value=stack.pop(),params=token.params&&Twig.expression.parse.apply(this,[token.params,context]),result=Twig.test(token.filter,value,params);
if(token.modifier=="not"){stack.push(!result)}else{stack.push(result)}}},{type:Twig.expression.type.comma,regex:/^,/,next:Twig.expression.set.expressions,compile:function(token,stack,output){var i=stack.length-1,stack_token;
delete token.match;delete token.value;for(;i>=0;i--){stack_token=stack.pop();if(stack_token.type===Twig.expression.type.object.start||stack_token.type===Twig.expression.type.parameter.start||stack_token.type===Twig.expression.type.array.start){stack.push(stack_token);
break}output.push(stack_token)}output.push(token)}},{type:Twig.expression.type.operator.binary,regex:/(^[\+\-~%\?\:]|^[!=]==?|^[!<>]=?|^\*\*?|^\/\/?|^and\s+|^or\s+|^in\s+|^not in\s+|^\.\.)/,next:Twig.expression.set.expressions.concat([Twig.expression.type.operator.unary]),compile:function(token,stack,output){delete token.match;
token.value=token.value.trim();var value=token.value,operator=Twig.expression.operator.lookup(value,token);
Twig.log.trace("Twig.expression.compile: ","Operator: ",operator," from ",value);while(stack.length>0&&(stack[stack.length-1].type==Twig.expression.type.operator.unary||stack[stack.length-1].type==Twig.expression.type.operator.binary)&&((operator.associativity===Twig.expression.operator.leftToRight&&operator.precidence>=stack[stack.length-1].precidence)||(operator.associativity===Twig.expression.operator.rightToLeft&&operator.precidence>stack[stack.length-1].precidence))){var temp=stack.pop();
output.push(temp)}if(value===":"){if(stack[stack.length-1]&&stack[stack.length-1].value==="?"){}else{var key_token=output.pop();
if(key_token.type===Twig.expression.type.string||key_token.type===Twig.expression.type.variable||key_token.type===Twig.expression.type.number){token.key=key_token.value
}else{throw new Twig.Error("Unexpected value before ':' of "+key_token.type+" = "+key_token.value)}output.push(token);
return}}else{stack.push(operator)}},parse:function(token,stack,context){if(token.key){stack.push(token)
}else{Twig.expression.operator.parse(token.value,stack)}}},{type:Twig.expression.type.operator.unary,regex:/(^not\s+)/,next:Twig.expression.set.expressions,compile:function(token,stack,output){delete token.match;
token.value=token.value.trim();var value=token.value,operator=Twig.expression.operator.lookup(value,token);
Twig.log.trace("Twig.expression.compile: ","Operator: ",operator," from ",value);while(stack.length>0&&(stack[stack.length-1].type==Twig.expression.type.operator.unary||stack[stack.length-1].type==Twig.expression.type.operator.binary)&&((operator.associativity===Twig.expression.operator.leftToRight&&operator.precidence>=stack[stack.length-1].precidence)||(operator.associativity===Twig.expression.operator.rightToLeft&&operator.precidence>stack[stack.length-1].precidence))){var temp=stack.pop();
output.push(temp)}stack.push(operator)},parse:function(token,stack,context){Twig.expression.operator.parse(token.value,stack)
}},{type:Twig.expression.type.string,regex:/^(["'])(?:(?=(\\?))\2.)*?\1/,next:Twig.expression.set.operations,compile:function(token,stack,output){var value=token.value;
delete token.match;if(value.substring(0,1)==='"'){value=value.replace('\\"','"')}else{value=value.replace("\\'","'")
}token.value=value.substring(1,value.length-1).replace(/\\n/g,"\n").replace(/\\r/g,"\r");Twig.log.trace("Twig.expression.compile: ","String value: ",token.value);
output.push(token)},parse:Twig.expression.fn.parse.push_value},{type:Twig.expression.type.parameter.start,regex:/^\(/,next:Twig.expression.set.expressions.concat([Twig.expression.type.parameter.end]),compile:Twig.expression.fn.compile.push_both,parse:Twig.expression.fn.parse.push},{type:Twig.expression.type.parameter.end,regex:/^\)/,next:Twig.expression.set.operations_extended,compile:function(token,stack,output){var stack_token,end_token=token;
stack_token=stack.pop();while(stack.length>0&&stack_token.type!=Twig.expression.type.parameter.start){output.push(stack_token);
stack_token=stack.pop()}var param_stack=[];while(token.type!==Twig.expression.type.parameter.start){param_stack.unshift(token);
token=output.pop()}param_stack.unshift(token);var is_expression=false;token=output[output.length-1];if(token===undefined||(token.type!==Twig.expression.type._function&&token.type!==Twig.expression.type.filter&&token.type!==Twig.expression.type.test&&token.type!==Twig.expression.type.key.brackets&&token.type!==Twig.expression.type.key.period)){end_token.expression=true;
param_stack.pop();param_stack.shift();end_token.params=param_stack;output.push(end_token)}else{end_token.expression=false;
token.params=param_stack}},parse:function(token,stack,context){var new_array=[],array_ended=false,value=null;
if(token.expression){value=Twig.expression.parse.apply(this,[token.params,context]);stack.push(value)
}else{while(stack.length>0){value=stack.pop();if(value&&value.type&&value.type==Twig.expression.type.parameter.start){array_ended=true;
break}new_array.unshift(value)}if(!array_ended){throw new Twig.Error("Expected end of parameter set.")
}stack.push(new_array)}}},{type:Twig.expression.type.array.start,regex:/^\[/,next:Twig.expression.set.expressions.concat([Twig.expression.type.array.end]),compile:Twig.expression.fn.compile.push_both,parse:Twig.expression.fn.parse.push},{type:Twig.expression.type.array.end,regex:/^\]/,next:Twig.expression.set.operations_extended,compile:function(token,stack,output){var i=stack.length-1,stack_token;
for(;i>=0;i--){stack_token=stack.pop();if(stack_token.type===Twig.expression.type.array.start){break}output.push(stack_token)
}output.push(token)},parse:function(token,stack,context){var new_array=[],array_ended=false,value=null;
while(stack.length>0){value=stack.pop();if(value.type&&value.type==Twig.expression.type.array.start){array_ended=true;
break}new_array.unshift(value)}if(!array_ended){throw new Twig.Error("Expected end of array.")}stack.push(new_array)
}},{type:Twig.expression.type.object.start,regex:/^\{/,next:Twig.expression.set.expressions.concat([Twig.expression.type.object.end]),compile:Twig.expression.fn.compile.push_both,parse:Twig.expression.fn.parse.push},{type:Twig.expression.type.object.end,regex:/^\}/,next:Twig.expression.set.operations_extended,compile:function(token,stack,output){var i=stack.length-1,stack_token;
for(;i>=0;i--){stack_token=stack.pop();if(stack_token&&stack_token.type===Twig.expression.type.object.start){break
}output.push(stack_token)}output.push(token)},parse:function(end_token,stack,context){var new_object={},object_ended=false,token=null,token_key=null,has_value=false,value=null;
while(stack.length>0){token=stack.pop();if(token&&token.type&&token.type===Twig.expression.type.object.start){object_ended=true;
break}if(token&&token.type&&(token.type===Twig.expression.type.operator.binary||token.type===Twig.expression.type.operator.unary)&&token.key){if(!has_value){throw new Twig.Error("Missing value for key '"+token.key+"' in object definition.")
}new_object[token.key]=value;if(new_object._keys===undefined){new_object._keys=[]}new_object._keys.unshift(token.key);
value=null;has_value=false}else{has_value=true;value=token}}if(!object_ended){throw new Twig.Error("Unexpected end of object.")
}stack.push(new_object)}},{type:Twig.expression.type.filter,regex:/^\|\s?([a-zA-Z_][a-zA-Z0-9_\-]*)/,next:Twig.expression.set.operations_extended.concat([Twig.expression.type.parameter.start]),compile:function(token,stack,output){token.value=token.match[1];
output.push(token)},parse:function(token,stack,context){var input=stack.pop(),params=token.params&&Twig.expression.parse.apply(this,[token.params,context]);
stack.push(Twig.filter.apply(this,[token.value,input,params]))}},{type:Twig.expression.type._function,regex:/^([a-zA-Z_][a-zA-Z0-9_]*)\s*\(/,next:Twig.expression.type.parameter.start,transform:function(match,tokens){return"("
},compile:function(token,stack,output){var fn=token.match[1];token.fn=fn;delete token.match;delete token.value;
output.push(token)},parse:function(token,stack,context){var params=token.params&&Twig.expression.parse.apply(this,[token.params,context]),fn=token.fn,value;
if(Twig.functions[fn]){value=Twig.functions[fn].apply(this,params)}else{if(typeof context[fn]=="function"){value=context[fn].apply(context,params)
}else{throw new Twig.Error(fn+" function does not exist and is not defined in the context")}}stack.push(value)
}},{type:Twig.expression.type.variable,regex:/^[a-zA-Z_][a-zA-Z0-9_]*/,next:Twig.expression.set.operations_extended.concat([Twig.expression.type.parameter.start]),compile:Twig.expression.fn.compile.push,validate:function(match,tokens){return Twig.expression.reservedWords.indexOf(match[0])==-1
},parse:function(token,stack,context){var value=Twig.expression.resolve(context[token.value],context);
stack.push(value)}},{type:Twig.expression.type.key.period,regex:/^\.([a-zA-Z0-9_]+)/,next:Twig.expression.set.operations_extended.concat([Twig.expression.type.parameter.start]),compile:function(token,stack,output){token.key=token.match[1];
delete token.match;delete token.value;output.push(token)},parse:function(token,stack,context){var params=token.params&&Twig.expression.parse.apply(this,[token.params,context]),key=token.key,object=stack.pop(),value;
if(object===null||object===undefined){if(this.options.strict_variables){throw new Twig.Error("Can't access a key "+key+" on an null or undefined object.")
}else{return null}}var capitalize=function(value){return value.substr(0,1).toUpperCase()+value.substr(1)
};if(typeof object==="object"&&key in object){value=object[key]}else{if(object["get"+capitalize(key)]!==undefined){value=object["get"+capitalize(key)]
}else{if(object["is"+capitalize(key)]!==undefined){value=object["is"+capitalize(key)]}else{value=null
}}}stack.push(Twig.expression.resolve(value,object,params))}},{type:Twig.expression.type.key.brackets,regex:/^\[([^\]]*)\]/,next:Twig.expression.set.operations_extended.concat([Twig.expression.type.parameter.start]),compile:function(token,stack,output){var match=token.match[1];
delete token.value;delete token.match;token.stack=Twig.expression.compile({value:match}).stack;output.push(token)
},parse:function(token,stack,context){var params=token.params&&Twig.expression.parse.apply(this,[token.params,context]),key=Twig.expression.parse.apply(this,[token.stack,context]),object=stack.pop(),value;
if(object===null||object===undefined){if(this.options.strict_variables){throw new Twig.Error("Can't access a key "+key+" on an null or undefined object.")
}else{return null}}if(typeof object==="object"&&key in object){value=object[key]}else{value=null}stack.push(Twig.expression.resolve(value,object,params))
}},{type:Twig.expression.type._null,regex:/^null/,next:Twig.expression.set.operations,compile:function(token,stack,output){delete token.match;
token.value=null;output.push(token)},parse:Twig.expression.fn.parse.push_value},{type:Twig.expression.type.number,regex:/^\-?\d+(\.\d+)?/,next:Twig.expression.set.operations,compile:function(token,stack,output){token.value=Number(token.value);
output.push(token)},parse:Twig.expression.fn.parse.push_value},{type:Twig.expression.type.bool,regex:/^(true|false)/,next:Twig.expression.set.operations,compile:function(token,stack,output){token.value=(token.match[0]=="true");
delete token.match;output.push(token)},parse:Twig.expression.fn.parse.push_value}];Twig.expression.resolve=function(value,context,params){if(typeof value=="function"){return value.apply(context,params||[])
}else{return value}};Twig.expression.handler={};Twig.expression.extendType=function(type){Twig.expression.type[type]="Twig.expression.type."+type
};Twig.expression.extend=function(definition){if(!definition.type){throw new Twig.Error("Unable to extend logic definition. No type provided for "+definition)
}Twig.expression.handler[definition.type]=definition};while(Twig.expression.definitions.length>0){Twig.expression.extend(Twig.expression.definitions.shift())
}Twig.expression.tokenize=function(expression){var tokens=[],exp_offset=0,next=null,type,regex,regex_array,token_next,match_found,invalid_matches=[],match_function;
match_function=function(){var match=Array.prototype.slice.apply(arguments),string=match.pop(),offset=match.pop();
Twig.log.trace("Twig.expression.tokenize","Matched a ",type," regular expression of ",match);if(next&&next.indexOf(type)<0){invalid_matches.push(type+" cannot follow a "+tokens[tokens.length-1].type+" at template:"+exp_offset+" near '"+match[0].substring(0,20)+"...'");
return match[0]}if(Twig.expression.handler[type].validate&&!Twig.expression.handler[type].validate(match,tokens)){return match[0]
}invalid_matches=[];tokens.push({type:type,value:match[0],match:match});match_found=true;next=token_next;
exp_offset+=match[0].length;if(Twig.expression.handler[type].transform){return Twig.expression.handler[type].transform(match,tokens)
}return""};Twig.log.debug("Twig.expression.tokenize","Tokenizing expression ",expression);while(expression.length>0){expression=expression.trim();
for(type in Twig.expression.handler){if(Twig.expression.handler.hasOwnProperty(type)){token_next=Twig.expression.handler[type].next;
regex=Twig.expression.handler[type].regex;if(regex instanceof Array){regex_array=regex}else{regex_array=[regex]
}match_found=false;while(regex_array.length>0){regex=regex_array.pop();expression=expression.replace(regex,match_function)
}if(match_found){break}}}if(!match_found){if(invalid_matches.length>0){throw new Twig.Error(invalid_matches.join(" OR "))
}else{throw new Twig.Error("Unable to parse '"+expression+"' at template position"+exp_offset)}}}Twig.log.trace("Twig.expression.tokenize","Tokenized to ",tokens);
return tokens};Twig.expression.compile=function(raw_token){var expression=raw_token.value,tokens=Twig.expression.tokenize(expression),token=null,output=[],stack=[],token_template=null;
Twig.log.trace("Twig.expression.compile: ","Compiling ",expression);while(tokens.length>0){token=tokens.shift();
token_template=Twig.expression.handler[token.type];Twig.log.trace("Twig.expression.compile: ","Compiling ",token);
token_template.compile&&token_template.compile(token,stack,output);Twig.log.trace("Twig.expression.compile: ","Stack is",stack);
Twig.log.trace("Twig.expression.compile: ","Output is",output)}while(stack.length>0){output.push(stack.pop())
}Twig.log.trace("Twig.expression.compile: ","Final output is",output);raw_token.stack=output;delete raw_token.value;
return raw_token};Twig.expression.parse=function(tokens,context){var that=this;if(!(tokens instanceof Array)){tokens=[tokens]
}var stack=[],token_template=null;tokens.forEach(function(token){token_template=Twig.expression.handler[token.type];
token_template.parse&&token_template.parse.apply(that,[token,stack,context])});return stack.pop()};return Twig
})(Twig||{});var Twig=(function(Twig){Twig.expression.operator={leftToRight:"leftToRight",rightToLeft:"rightToLeft"};
var containment=function(a,b){if(b.indexOf!==undefined){return a===b||a!==""&&b.indexOf(a)>-1}else{var el;
for(el in b){if(b.hasOwnProperty(el)&&b[el]===a){return true}}return false}};Twig.expression.operator.lookup=function(operator,token){switch(operator){case"..":case"not in":case"in":token.precidence=20;
token.associativity=Twig.expression.operator.leftToRight;break;case",":token.precidence=18;token.associativity=Twig.expression.operator.leftToRight;
break;case"?":case":":token.precidence=16;token.associativity=Twig.expression.operator.rightToLeft;break;
case"or":token.precidence=14;token.associativity=Twig.expression.operator.leftToRight;break;case"and":token.precidence=13;
token.associativity=Twig.expression.operator.leftToRight;break;case"==":case"!=":token.precidence=9;token.associativity=Twig.expression.operator.leftToRight;
break;case"<":case"<=":case">":case">=":token.precidence=8;token.associativity=Twig.expression.operator.leftToRight;
break;case"~":case"+":case"-":token.precidence=6;token.associativity=Twig.expression.operator.leftToRight;
break;case"//":case"**":case"*":case"/":case"%":token.precidence=5;token.associativity=Twig.expression.operator.leftToRight;
break;case"not":token.precidence=3;token.associativity=Twig.expression.operator.rightToLeft;break;default:throw new Twig.Error(operator+" is an unknown operator.")
}token.operator=operator;return token};Twig.expression.operator.parse=function(operator,stack){Twig.log.trace("Twig.expression.operator.parse: ","Handling ",operator);
var a,b,c;switch(operator){case":":break;case"?":c=stack.pop();b=stack.pop();a=stack.pop();if(a){stack.push(b)
}else{stack.push(c)}break;case"+":b=parseFloat(stack.pop());a=parseFloat(stack.pop());stack.push(a+b);
break;case"-":b=parseFloat(stack.pop());a=parseFloat(stack.pop());stack.push(a-b);break;case"*":b=parseFloat(stack.pop());
a=parseFloat(stack.pop());stack.push(a*b);break;case"/":b=parseFloat(stack.pop());a=parseFloat(stack.pop());
stack.push(a/b);break;case"//":b=parseFloat(stack.pop());a=parseFloat(stack.pop());stack.push(parseInt(a/b));
break;case"%":b=parseFloat(stack.pop());a=parseFloat(stack.pop());stack.push(a%b);break;case"~":b=stack.pop();
a=stack.pop();stack.push((a!==undefined?a.toString():"")+(b!==undefined?b.toString():""));break;case"not":case"!":stack.push(!stack.pop());
break;case"<":b=stack.pop();a=stack.pop();stack.push(a<b);break;case"<=":b=stack.pop();a=stack.pop();
stack.push(a<=b);break;case">":b=stack.pop();a=stack.pop();stack.push(a>b);break;case">=":b=stack.pop();
a=stack.pop();stack.push(a>=b);break;case"===":b=stack.pop();a=stack.pop();stack.push(a===b);break;case"==":b=stack.pop();
a=stack.pop();stack.push(a==b);break;case"!==":b=stack.pop();a=stack.pop();stack.push(a!==b);break;case"!=":b=stack.pop();
a=stack.pop();stack.push(a!=b);break;case"or":b=stack.pop();a=stack.pop();stack.push(a||b);break;case"and":b=stack.pop();
a=stack.pop();stack.push(a&&b);break;case"**":b=stack.pop();a=stack.pop();stack.push(Math.pow(a,b));break;
case"not in":b=stack.pop();a=stack.pop();stack.push(!containment(a,b));break;case"in":b=stack.pop();a=stack.pop();
stack.push(containment(a,b));break;case"..":b=stack.pop();a=stack.pop();stack.push(Twig.functions.range(a,b));
break;default:throw new Twig.Error(operator+" is an unknown operator.")}};return Twig})(Twig||{});var Twig=(function(Twig){function is(type,obj){var clas=Object.prototype.toString.call(obj).slice(8,-1);
return obj!==undefined&&obj!==null&&clas===type}Twig.filters={upper:function(value){if(typeof value!=="string"){return value
}return value.toUpperCase()},lower:function(value){if(typeof value!=="string"){return value}return value.toLowerCase()
},capitalize:function(value){if(typeof value!=="string"){return value}return value.substr(0,1).toUpperCase()+value.substr(1)
},title:function(value){if(typeof value!=="string"){return value}return value.replace(/(^|\s)([a-z])/g,function(m,p1,p2){return p1+p2.toUpperCase()
})},length:function(value){if(value instanceof Array||typeof value==="string"){return value.length}else{if(value instanceof Object){if(value._keys===undefined){return Object.keys(value).length
}else{return value._keys.length}}else{return 0}}},reverse:function(value){if(is("Array",value)){return value.reverse()
}else{if(is("String",value)){return value.split("").reverse().join("")}else{if(value instanceof Object){var keys=value._keys||Object.keys(value).reverse();
value._keys=keys;return value}}}},sort:function(value){if(is("Array",value)){return value.sort()}else{if(value instanceof Object){delete value._keys;
var keys=Object.keys(value),sorted_keys=keys.sort(function(a,b){return value[a]>value[b]});value._keys=sorted_keys;
return value}}},keys:function(value){if(value===undefined){return}var keyset=value._keys||Object.keys(value),output=[];
keyset.forEach(function(key){if(key==="_keys"){return}if(value.hasOwnProperty(key)){output.push(key)}});
return output},url_encode:function(value){if(value===undefined){return}return encodeURIComponent(value)
},join:function(value,params){if(value===undefined){return}var join_str="",output=[],keyset=null;if(params&&params[0]){join_str=params[0]
}if(value instanceof Array){output=value}else{keyset=value._keys||Object.keys(value);keyset.forEach(function(key){if(key==="_keys"){return
}if(value.hasOwnProperty(key)){output.push(value[key])}})}return output.join(join_str)},"default":function(value,params){if(params===undefined||params.length!==1){throw new Twig.Error("default filter expects one argument")
}if(value===undefined||value===null||value===""){return params[0]}else{return value}},json_encode:function(value){if(value&&value.hasOwnProperty("_keys")){delete value._keys
}if(value===undefined||value===null){return"null"}return JSON.stringify(value)},merge:function(value,params){var obj=[],arr_index=0,keyset=[];
if(!(value instanceof Array)){obj={}}else{params.forEach(function(param){if(!(param instanceof Array)){obj={}
}})}if(!(obj instanceof Array)){obj._keys=[]}if(value instanceof Array){value.forEach(function(val){if(obj._keys){obj._keys.push(arr_index)
}obj[arr_index]=val;arr_index++})}else{keyset=value._keys||Object.keys(value);keyset.forEach(function(key){obj[key]=value[key];
obj._keys.push(key);var int_key=parseInt(key,10);if(!isNaN(int_key)&&int_key>=arr_index){arr_index=int_key+1
}})}params.forEach(function(param){if(param instanceof Array){param.forEach(function(val){if(obj._keys){obj._keys.push(arr_index)
}obj[arr_index]=val;arr_index++})}else{keyset=param._keys||Object.keys(param);keyset.forEach(function(key){if(!obj[key]){obj._keys.push(key)
}obj[key]=param[key];var int_key=parseInt(key,10);if(!isNaN(int_key)&&int_key>=arr_index){arr_index=int_key+1
}})}});if(params.length===0){throw new Twig.Error("Filter merge expects at least one parameter")}return obj
},date:function(value,params){if(value===undefined){return}var date=Twig.functions.date(value);return Twig.lib.formatDate(date,params[0])
},replace:function(value,params){if(value===undefined){return}var pairs=params[0],tag;for(tag in pairs){if(pairs.hasOwnProperty(tag)&&tag!=="_keys"){value=Twig.lib.replaceAll(value,tag,pairs[tag])
}}return value},format:function(value,params){if(value===undefined){return}return Twig.lib.vsprintf(value,params)
},striptags:function(value){if(value===undefined){return}return Twig.lib.strip_tags(value)},escape:function(value){if(value===undefined){return
}return value.toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")
},"e":function(value){return Twig.filters.escape(value)},nl2br:function(value){if(value===undefined){return
}var linebreak_tag="BACKSLASH_n_replace",br="<br />"+linebreak_tag;value=Twig.filters.escape(value).replace(/\r\n/g,br).replace(/\r/g,br).replace(/\n/g,br);
return Twig.lib.replaceAll(value,linebreak_tag,"\n")},number_format:function(value,params){var number=value,decimals=(params&&params[0])?params[0]:undefined,dec=(params&&params[1]!==undefined)?params[1]:".",sep=(params&&params[2]!==undefined)?params[2]:",";
number=(number+"").replace(/[^0-9+\-Ee.]/g,"");var n=!isFinite(+number)?0:+number,prec=!isFinite(+decimals)?0:Math.abs(decimals),s="",toFixedFix=function(n,prec){var k=Math.pow(10,prec);
return""+Math.round(n*k)/k};s=(prec?toFixedFix(n,prec):""+Math.round(n)).split(".");if(s[0].length>3){s[0]=s[0].replace(/\B(?=(?:\d{3})+(?!\d))/g,sep)
}if((s[1]||"").length<prec){s[1]=s[1]||"";s[1]+=new Array(prec-s[1].length+1).join("0")}return s.join(dec)
},trim:function(value,params){if(value===undefined){return}var str=Twig.filters.escape(""+value),whitespace;
if(params&&params[0]){whitespace=""+params[0]}else{whitespace=" \n\r\t\f\x0b\xa0\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u200b\u2028\u2029\u3000"
}for(var i=0;i<str.length;i++){if(whitespace.indexOf(str.charAt(i))===-1){str=str.substring(i);break}}for(i=str.length-1;
i>=0;i--){if(whitespace.indexOf(str.charAt(i))===-1){str=str.substring(0,i+1);break}}return whitespace.indexOf(str.charAt(0))===-1?str:""
}};Twig.filter=function(filter,value,params){if(!Twig.filters[filter]){throw"Unable to find filter "+filter
}return Twig.filters[filter].apply(this,[value,params])};Twig.filter.extend=function(filter,definition){Twig.filters[filter]=definition
};return Twig})(Twig||{});var Twig=(function(Twig){function is(type,obj){var clas=Object.prototype.toString.call(obj).slice(8,-1);
return obj!==undefined&&obj!==null&&clas===type}Twig.functions={range:function(low,high,step){var matrix=[];
var inival,endval,plus;var walker=step||1;var chars=false;if(!isNaN(low)&&!isNaN(high)){inival=parseInt(low,10);
endval=parseInt(high,10)}else{if(isNaN(low)&&isNaN(high)){chars=true;inival=low.charCodeAt(0);endval=high.charCodeAt(0)
}else{inival=(isNaN(low)?0:low);endval=(isNaN(high)?0:high)}}plus=((inival>endval)?false:true);if(plus){while(inival<=endval){matrix.push(((chars)?String.fromCharCode(inival):inival));
inival+=walker}}else{while(inival>=endval){matrix.push(((chars)?String.fromCharCode(inival):inival));
inival-=walker}}return matrix},cycle:function(arr,i){var pos=i%arr.length;return arr[pos]},dump:function(){var EOL="\n",indentChar="  ",indentTimes=0,out="",args=Array.prototype.slice.call(arguments),indent=function(times){var ind="";
while(times>0){times--;ind+=indentChar}return ind},displayVar=function(variable){out+=indent(indentTimes);
if(typeof(variable)==="object"){dumpVar(variable)}else{if(typeof(variable)==="function"){out+="function()"+EOL
}else{if(typeof(variable)==="string"){out+="string("+variable.length+') "'+variable+'"'+EOL}else{if(typeof(variable)==="number"){out+="number("+variable+")"+EOL
}else{if(typeof(variable)==="boolean"){out+="bool("+variable+")"+EOL}}}}}},dumpVar=function(variable){var i;
if(variable===null){out+="NULL"+EOL}else{if(variable===undefined){out+="undefined"+EOL}else{if(typeof variable==="object"){out+=indent(indentTimes)+typeof(variable);
indentTimes++;out+="("+(function(obj){var size=0,key;for(key in obj){if(obj.hasOwnProperty(key)){size++
}}return size})(variable)+") {"+EOL;for(i in variable){out+=indent(indentTimes)+"["+i+"]=> "+EOL;displayVar(variable[i])
}indentTimes--;out+=indent(indentTimes)+"}"+EOL}else{displayVar(variable)}}}};if(args.length==0){args.push(this.context)
}args.forEach(function(variable){dumpVar(variable)});return out},date:function(date,time){var dateObj;
if(date===undefined){dateObj=new Date()}else{if(Twig.lib.is("Date",date)){dateObj=date}else{if(Twig.lib.is("String",date)){dateObj=new Date(Twig.lib.strtotime(date)*1000)
}else{if(Twig.lib.is("Number",date)){dateObj=new Date(date*1000)}else{throw new Twig.Error("Unable to parse date "+date)
}}}}return dateObj},parent:function(){return Twig.placeholders.parent}};Twig._function=function(_function,value,params){if(!Twig.functions[_function]){throw"Unable to find function "+_function
}return Twig.functions[_function](value,params)};Twig._function.extend=function(_function,definition){Twig.functions[_function]=definition
};return Twig})(Twig||{});var Twig=(function(Twig){Twig.tests={empty:function(value){if(value===null||value===undefined){return true
}if(typeof value==="number"){return false}if(value.length&&value.length>0){return false}for(var key in value){if(value.hasOwnProperty(key)){return false
}}return true},odd:function(value){return value%2===1},even:function(value){return value%2===0},divisibleby:function(value,params){return value%params[0]===0
},defined:function(value){return value!==undefined},none:function(value){return value===null},"null":function(value){return this.none(value)
},sameas:function(value,params){return value===params[0]}};Twig.test=function(test,value,params){if(!Twig.tests[test]){throw"Test "+test+" is not defined."
}return Twig.tests[test](value,params)};Twig.test.extend=function(test,definition){Twig.tests[test]=definition
};return Twig})(Twig||{});var Twig=(function(Twig){Twig.exports={VERSION:Twig.VERSION};Twig.exports.twig=function twig(params){var id=params.id,options={strict_variables:params.strict_variables||false,allowInlineIncludes:params.allowInlineIncludes||false};
if(id){Twig.validateId(id)}if(params.debug!==undefined){Twig.debug=params.debug}if(params.trace!==undefined){Twig.trace=params.trace
}if(params.data!==undefined){return new Twig.Template({data:params.data,module:params.module,id:id,options:options})
}else{if(params.ref!==undefined){if(params.id!==undefined){throw new Error("Both ref and id cannot be set on a twig.js template.")
}return Twig.Templates.load(params.ref)}else{if(params.href!==undefined){return Twig.Templates.loadRemote(params.href,{id:id,method:"ajax",base:params.base,module:params.module,precompiled:params.precompiled,async:params.async,options:options},params.load,params.error)
}else{if(params.path!==undefined){return Twig.Templates.loadRemote(params.path,{id:id,method:"fs",base:params.base,module:params.module,precompiled:params.precompiled,async:params.async,options:options},params.load,params.error)
}}}}};Twig.exports.extendFilter=function(filter,definition){Twig.filter.extend(filter,definition)};Twig.exports.extendFunction=function(fn,definition){Twig._function.extend(fn,definition)
};Twig.exports.extendTest=function(test,definition){Twig.test.extend(test,definition)};Twig.exports.extendTag=function(definition){Twig.logic.extend(definition)
};Twig.exports.extend=function(fn){fn(Twig)};Twig.exports.compile=function(markup,options){var id=options.filename,path=options.filename,template;
template=new Twig.Template({data:markup,path:path,id:id,options:options.settings["twig options"]});return function(context){return template.render(context)
}};Twig.exports.renderFile=function(path,options,fn){if("function"==typeof options){fn=options;options={}
}options=options||{};var params={path:path,base:options.settings["views"],load:function(template){fn(null,template.render(options))
}};var view_options=options.settings["twig options"];if(view_options){for(var option in view_options){if(view_options.hasOwnProperty(option)){params[option]=view_options[option]
}}}Twig.exports.twig(params)};Twig.exports.__express=Twig.exports.renderFile;Twig.exports.cache=function(cache){Twig.cache=cache
};return Twig})(Twig||{});var Twig=(function(Twig){Twig.compiler={module:{}};Twig.compiler.compile=function(template,options){var tokens=JSON.stringify(template.tokens),id=template.id,output;
if(options.module){if(Twig.compiler.module[options.module]===undefined){throw new Twig.Error("Unable to find module type "+options.module)
}output=Twig.compiler.module[options.module](id,tokens,options.twig)}else{output=Twig.compiler.wrap(id,tokens)
}return output};Twig.compiler.module={amd:function(id,tokens,pathToTwig){return'define(["'+pathToTwig+'"], function (Twig) {\n\tvar twig, templates;\ntwig = Twig.twig;\ntemplates = '+Twig.compiler.wrap(id,tokens)+"\n\treturn templates;\n});"
},node:function(id,tokens){return'var twig = require("twig").twig;\n'+"exports.template = "+Twig.compiler.wrap(id,tokens)
},cjs2:function(id,tokens,pathToTwig){return'module.declare([{ twig: "'+pathToTwig+'" }], function (require, exports, module) {\n'+'\tvar twig = require("twig").twig;\n'+"\texports.template = "+Twig.compiler.wrap(id,tokens)+"\n});"
}};Twig.compiler.wrap=function(id,tokens){return'twig({id:"'+id.replace('"','\\"')+'", data:'+tokens+", precompiled: true});\n"
};return Twig})(Twig||{});if(typeof module!=="undefined"&&module.declare){module.declare([],function(require,exports,module){for(key in Twig.exports){if(Twig.exports.hasOwnProperty(key)){exports[key]=Twig.exports[key]
}}})}else{if(typeof define=="function"&&define.amd){define(function(){return Twig.exports})}else{if(typeof module!=="undefined"&&module.exports){module.exports=Twig.exports
}else{window.twig=Twig.exports.twig;window.Twig=Twig.exports}}}if(typeof DP_DEBUG=="undefined"||!DP_DEBUG){DP_DEBUG=false
}var DP={console:{error:function(){},log:function(){},warn:function(){},info:function(){},debug:function(){},trace:function(){}},init:function(){if(typeof window.console!="undefined"){DP.console=window.console
}["error","log","warn","info","debug","trace"].each(function(v){if(!DP.console[v]){DP.console[v]=function(){}
}});delete DP.init},rteTextarea:function(field,options){options=options||{};if(!field){return}field=$(field);
if(!field.closest("body")){return}defaultOptions={script_url:ASSETS_BASE_URL+"/vendor/tiny_mce/tiny_mce_src.js",skin:"o2k7",skin_variant:"silver",theme:"advanced",plugins:"fullscreen,table,wordcount",theme_advanced_buttons1:"bold,italic,underline,|,justifyleft,justifycenter,justifyright,|,forecolor,backcolor,|,styleselect,fontselect,fontsizeselect",theme_advanced_buttons2:"bullist,numlist,|,outdent,indent,|,link,unlink,anchor,dp_media,image,|,hr,tablecontrols,|,pasteword,visualaid,code,removeformat,fullscreen",theme_advanced_buttons3:"",theme_advanced_toolbar_location:"top",theme_advanced_toolbar_align:"left",theme_advanced_resizing:true,theme_advanced_statusbar_location:"bottom",theme_advanced_path:false,relative_urls:false,width:"100%",content_css:ASSETS_BASE_URL+"/stylesheets/user/content-editor.css",style_formats:[{title:"Paragraph",block:"p"},{title:"Heading 1",block:"h2"},{title:"Heading 2",block:"h3"},{title:"Heading 3",block:"h4"},{title:"Heading 4",block:"h5"},{title:"Quote",block:"blockquote"},{title:"Code Box",block:"code",classes:"codebox"}]};
var oldsetup=options.setup||function(){};options.setup=function(ed){ed.addButton("dp_media",{title:"Upload Image",image:ASSETS_BASE_URL+"/images/agent/icons/picture_add.png",onclick:function(){MEDIA_MANAGER_WINDOW.bindToEditor(ed);
MEDIA_MANAGER_WINDOW.open()}});oldsetup(ed)};options=Object.merge(defaultOptions,options||{});return field.tinymce(options)
},convertTextToWysiwygHtml:function(text,pOneLine){if(!text.length){return""}text=text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
if(pOneLine){text="<p>"+text.replace(/\r?\n/g,"</p>\n\n<p>")+"</p>"}else{text="<p>"+text.replace(/\r?\n/g,"<br>\n").replace(/<br>\n<br>\n/g,"</p>\n\n<p>")+"</p>"
}if(!$.browser.msie){text=text.replace(/<p><\/p>/g,"<p><br></p>")}return text},drawBox:function(w,h){if(this.lastBox){this.lastBox.remove();
this.lastBox=null}this.lastBox=$('<div style="background-color: #263343; position: absolute; width: '+w+"px; height: "+h+'px; z-index: 99999999;"></div>');
var left=($(window).width()/2)-(w/2);var top=($(window).height()/2)-(h/2);this.lastBox.css({left:left,top:top}).appendTo("body").show();
return this.lastBox},removeDrawnBox:function(){if(this.lastBox){this.lastBox.remove();this.lastBox=null
}},select:function(el,options){if(el.data("select2")){return}if(el.length&&el.length>1){el.each(function(){DP.select($(this),options)
});return}var options=options||{};if(el.data("style-type")){switch(el.data("style-type")){case"icons":var iconSize=el.data("select-icon-size");
if(!iconSize){iconSize=16}iconSize=parseInt(iconSize);var addCss="";var addCssLh="";if(iconSize!=16){addCss="padding-left: "+(iconSize+4)+"px; line-height: "+iconSize+"px";
addCssLh="line-height: "+iconSize+"px"}options.addWidth=iconSize+35;el.addClass("dpe_select-with-icon dpe_select-with-icon-"+iconSize);
options.addResultClass="with-icon";options.formatResult=function(result){if(typeof result.id==="undefined"){return Orb.escapeHtml(result.text)
}var opt=el.find('option[value="'+result.id+'"]');var name=Orb.escapeHtml(opt.text());if(opt.data("icon")){return'<div class="result-icon" style="background-image: url('+opt.data("icon")+");"+addCss+'">'+name+"</div>"
}else{return'<div class="result-icon no-icon" style="'+addCssLh+'">'+name+"</div>"}};options.formatSelection=function(data){var opt=el.find('option[value="'+data.id+'"]');
if(!opt){return""}var name=Orb.escapeHtml(opt.text());if(opt.data("icon")){return{type:"html",value:'<span class="choice-icon" style="background-image: url('+opt.data("icon")+"); padding-left: "+(iconSize+5)+'px">'+name+"</span>"}
}else{return name}};break;case"urgency":options.formatResult=function(data){var name=Orb.escapeHtml(data.text);
if(data.id<=0){return name}return'<span class="urgency urgency-'+data.id+'"><i>'+name+"</i></span>"};
options.formatSelection=function(data){var name=Orb.escapeHtml(data.text);if(data.id<=0){return name}return{type:"html",value:'<span class="urgency urgency-'+data.id+'"><i>'+name+"</i></span>"}
};break}}else{var withFullTitle=el.find("option[data-full-title]");if(withFullTitle[0]){withFullTitle.each(function(){$(this).data("single-title",$(this).text().trim());
$(this).text($(this).data("full-title"))});options.formatSelection=function(data){var n=$("<span/>").text(data.text);
return{type:"el",value:n}};options.formatResult=function(result){var opt=el.find('option[value="'+result.id+'"]');
if(!opt||!opt[0]){return $("<span/>").text(result.text||"")}var name=opt.data("single-title")||result.text;
name=$("<span/>").text(name);return name}}}if(el.data("select-nogrouptitle")){options.noGroupTitle=true
}if(el.data("select-width")=="auto"){var shrink;if(el.data("select-width-shrink")){shrink=parseInt(el.data("select-width-shrink"),10)
}else{shrink=15}if(el.parent().width()){options.width=el.parent().width()-shrink+"px"}else{var path=[];
var shown=[];var testEl=el.parent();while(testEl&&testEl.is(":hidden")){path.push(testEl);testEl=testEl.parent()
}if(testEl){for(var i=path.length-1;i>=0;i--){if(path[i].is(":hidden")){path[i].show();shown.push(path[i])
}}options.width=(el.parent().width()-shrink)+"px";for(var i=0;i<shown.length;i++){shown[i].hide()}}}}else{if(el.data("select-width")){options.width=el.data("select-width")
}else{options.width=function(){var select_el=el;var largest=0,label,charsize=6,tmp;select_el.find("> *").each(function(){var el=$(this);
if(el.is("optgroup")){tmp=$.trim(el.attr("label")).length*charsize;if(tmp>largest){largest=tmp}el.find("option").each(function(){var s_el=$(this);
tmp=($.trim(s_el.text()).length*charsize)+15;if(tmp>largest){largest=tmp}})}else{tmp=($.trim(el.text()).length*charsize);
if(tmp>largest){largest=tmp}}});largest+=35;return largest+"px"}}}if(el.data("select-clear")){options.allowClear=true
}if(el.data("placeholder")){options.placeholder=el.data("placeholder")}if(el.data("autocomplete-url")){options=$.extend(true,{ajax:{url:el.data("autocomplete-url"),dataType:"json",quietMillis:250,data:function(term,page){return{q:term}
},results:function(data,page){if(data.results){data=data.results}var results=[];for(var i=0;i<data.length;
i++){results.push({id:data[i].id,text:data[i].name})}return{more:false,results:results}}},initSelection:function(element,callback){var data=[];
if(element.val().length){$.ajax({url:el.data("autocomplete-url"),method:"get",data:{ids:element.val().split(",")},success:function(json){if(json.results){json=json.results
}var data=[];for(var i=0;i<json.length;i++){data.push({id:json[i].id,text:json[i].name})}callback(data)
},failure:function(){callback([])}})}else{callback([])}callback(data)}},options);if(el.data("multiple")){options.multiple=true
}}el.find("option").each(function(){var opt=$(this);if(!$.trim(opt.text())){opt.html("&nbsp;")}});if(!options.addWidth){options.addWidth=18
}if(el.is("[multiple]")||options.multiple){options.addWidth=null;if(!options.width||options.width){options.width="95%"
}}options.formatNoMatches=function(){return""};if(el.data("invisible-trigger")){options.containerCssClass=(options.containerCssClass||"")+" invisible-trigger";
options.dropdownCssClass=(options.dropdownCssClass||"")+" invisible-trigger"}else{if(el.data("invisible-trigger-right")){options.containerCssClass=(options.containerCssClass||"")+" invisible-trigger right";
options.dropdownCssClass=(options.dropdownCssClass||"")+" invisible-trigger right"}}if(el.data("dropdown-css-class")){options.dropdownCssClass=(options.dropdownCssClass||"")+" "+el.data("dropdown-css-class")
}if(el.data("dropdown-nosearch")){options.dropdownCssClass=(options.dropdownCssClass||"")+" dp-select2-nosearch"
}if(el.data("label-bound")){var boundEl=$(el.data("label-bound"));var updateBoundEl=function(){var text=[];
el.find(":selected").each(function(){text.push($.trim($(this).text()))});boundEl.text(text.join(", "))
};$(el).on("change",updateBoundEl);updateBoundEl()}el.addClass("with-select2");el.select2(options)}};
DP.init();var DpErrorLog={saveUrl:null,hasSentReport:true,logCount:0,init:function(){if(!this.saveUrl){return
}if(window.jQuery&&window.jQuery.cookie){if($.cookie("dp_jse_report")){this.hasSentReport=true}}},logError:function(message,trace,script,line){if(window.DP_LOADED_TIME){var timeUsing=((new Date()).getTime()/1000)-window.DP_LOADED_TIME
}else{var timeUsing=0}if(!message||message=="false"||message.indexOf("Error connecting to extension")!==-1||message.indexOf("flashBridge")!==-1){return
}if(message.indexOf("Automation server")!==-1){return}if(trace&&trace=="?() in :0"){return}if(!line||line==0||line==="0"){return
}if(script&&script.indexOf("resource://")===0){return}if(parseInt(line)==1&&script.indexOf("/agent/")!=-1){return
}if(this.logCount++>5){return}message+=" (timeUsing: "+timeUsing+")";var data={message:message||"",trace:trace||"",script:script||"",line:line||"0"};
if(this.saveUrl){message=message+"";if(ASSETS_BASE_URL){var r=new RegExp(ASSETS_BASE_URL.escapeRegExp(),"g");
message=message.replace(r,"")}if(data.script.indexOf("#app.")!==-1){data.script=data.script.replace(/#.*$/,"")
}$.ajax({url:this.saveUrl,data:data,error:function(){},type:"POST"})}if(message.indexOf("AJAX Error")!==-1){return
}if(window.SEND_FEEDBACK_WINDOW&&!this.hasSentReport){this.hasSentReport=true;if(window.jQuery&&window.jQuery.cookie){$.cookie("dp_jse_report","1",{expires:1})
}window.SEND_FEEDBACK_WINDOW.open("We have detected a browser Javascript error that may prevent the interface from functioning properly. "+"To help us identify and fix the problem, we would appreciate it if you could describe what you were viewing "+"and the actions you were performing just before this notice appeared.","Message: "+data.message+"\nScript: "+data.script+"\nLine:"+data.line+"\nTrace:"+data.trace+"\nUser Agent: "+navigator.userAgent,true)
}},};var Orb={};if(!window.console){window.console={}}["error","log","warn","info","debug","trace"].each(function(v){if(!window.console[v]){window.console[v]=function(){}
}});Orb.createNamespace=function(namespace,obj){var parts=namespace.split(".");var objcheck=window;parts.forEach(function(part){if(!objcheck[part]){objcheck[part]={}
}objcheck=objcheck[part]})};Orb.getNamespacedObject=function(fullname){var obj=window;fullname_parts=fullname.split(".");
var part=null;while(part=fullname_parts.shift()){if(obj[part]===undefined){console.warn("Orb.getNamespacedObject(%s) is an invalid name",fullname);
return null}obj=obj[part]}return obj};Orb.getUniqueId=function(prefix){if(!prefix){prefix=""}var id="";
do{id=prefix+Orb.uuid()}while(document.getElementById(id));return id};Orb.uuid=function(){return"orb_uuid_"+(++Orb.uuid_num)
};Orb.uuid_num=0;Orb.uuidRand=function(){var time=(new Date()).getTime();var rand=Number.random(1,999);
return"uuid_"+(++Orb.uuid_num)+"_"+time+"_"+rand};Orb.getEl=function(el){if(typeOf(el)=="element"){return el
}return document.getElementById(el)};$el=function(el){return Orb.getEl(el)};Orb.sleep=function(ms){var start=new Date().getTime();
for(var i=0;i<10000000;i++){if((new Date().getTime()-start)>ms){break}}};Orb.mouseInElement=function(mouseX,mouseY,el){var pos=el.offset();
var width=el.outerWidth();var height=el.outerHeight();if(mouseX<pos.left||mouseX>pos.left+width){return false
}if(mouseY<pos.top||mouseY>pos.top+height){return false}return true};Orb.findHighestZindex=function(els){if(!els){els=$("body > *")
}var highest=0;els.each(function(){var z=parseInt($(this).css("z-index"));if(z<1000000000&&z>highest){highest=z
}});return highest};Orb.escapeHtml=function(string){string=string||"";if(typeOf(string)=="element"){string=$(string).text()
}else{if(typeOf(string)!="string"){if(string.toString){string=string.toString()}console.error("Invalid type passed to Orb.escapeHtml: %o",string);
console.trace();return(typeof string)+""}}return string.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")
};Orb.nl2br=function(string){return string.replace(/\r\n|\n/g,"<br />\n")};Orb.linkUrls=function(string){string=string||"";
return string.replace(/\b(https?:\/\/|www\.)([^\s]+)\b(.?)/gi,function(match,o1,o2,o3,offset,s){if(o3&&o3=="/"){o2+="/"
}if(o1=="www."){return'<a href="http://www.'+o2+'">'+match+"</a>"}else{return'<a href="'+o1+o2+'">'+match+"</a>"
}})};Orb.appendQueryData=function(url,k,v){var kev=k;if(v!==undefined){kev+="="+encodeURI(v)}if(url.indexOf("?")===-1){url+="?"+kev
}else{url+="&"+kev}return url};Orb.serializeFormElements=function(context,visitedEls){var postData=[];
if(!visitedEls){visitedEls=[]}context.each(function(){$(this).find("input, select, textarea").each(function(){if(visitedEls.indexOf(this)!==-1){return
}visitedEls.push(this);var el=$(this);var name=el.attr("name");if(!name){return}if(el.is(":checkbox, :radio")){if(el.is(":checked")){postData.push({name:name,value:el.val()})
}}else{if(el.is("input, textarea")){postData.push({name:name,value:el.val()})}else{if(el.is("select")){el.find("option").filter(":selected").each(function(){postData.push({name:name,value:$(this).val()})
})}}}})});return postData};Orb.strRepeat=function(str,count){var finalStr=[];while(count-->0){finalStr.push(str)
}return finalStr.join("")};Orb.strEndsWith=function(str,suffix){return str.indexOf(suffix,str.length-suffix.length)!==-1
};Orb.regexQuote=function(strRegex){return strRegex.replace(/([.?*+^$[\]\\(){}-])/g,"\\$1")};Orb.strIsEmail=function(email){if(email.indexOf("@")===-1){return false
}var parts=email.split("@");if(parts.length!=2){return false}var regexName=/^[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*$/i;
var regexDomain=/^(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+(?:[A-Z]{2,15})$/i;var regexIp=/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/i;
if(!regexName.test(parts[0])){return false}if(!regexDomain.test(parts[1])&&!regexIp.test(parts[1])){return false
}return true};Orb.enablePhraseEl=function(phraseId,parentEl){var phraseEl,phraseClass=phraseId.replace(/\./g,"_");
if(parentEl){$(parentEl).find(".dp-phrase-switch").removeClass("dp-phrase-on");$(parentEl).find("."+phraseClass).addClass("dp-phrase-on")
}else{phraseEl=$("."+phraseClass);if(phraseEl[0]){$(phraseEl.parent()).find(".dp-phrase-text").removeClass("dp-phrase-on");
phraseEl.addClass("dp-phrase-on")}}};Orb.phraseTextEl=function(el,vars){if(!DeskPRO_Window.translate){return
}var phraseText=el.data("phrase-text");phraseText=DeskPRO_Window.translate.phraseWithString(phraseText,vars,true);
if(el.data("phrase-html")){el.html(phraseText)}else{el.text(phraseText)}return el};Orb.arrayChunk=function(array,size){var newArray=[],chunk=[],i;
for(i=0;i<array.length;i++){if(chunk.length==size){newArray.push(chunk);chunk=[]}if(chunk.length<size){chunk.push(array[i])
}}if(chunk.length){newArray.push(chunk)}return newArray};Orb.getSelectionCoords=function(sel){var range,rect;
if(sel.rangeCount){range=sel.getRangeAt(0).cloneRange();try{if(range.getClientRects){range.collapse(true);
rect=range.getClientRects()[0];if(rect){return null}return{left:rect.left,top:rect.top}}}catch(e){return null
}}else{if(sel.type&&sel.type!="Control"&&sel.createRange){range=sel.createRange();range.collapse(true);
if(range.boundingLeft&&range.boundingTop){return{left:range.boundingLeft,top:range.boundingTop}}}}return null
};(function(){var cleanupCallbacks=[];var origRemove=jQuery.fn.remove;var origEmpty=jQuery.fn.empty;jQuery.addElementCleanupCallback=function(fn){cleanupCallbacks.push(fn)
};jQuery.fn.empty=function(){var i;if(this.length){for(i=0;i<cleanupCallbacks.length;i++){cleanupCallbacks[i](this,"empty")
}}return origEmpty.apply(this,arguments)};jQuery.fn.remove=function(){var i;if(this.length){for(i=0;i<cleanupCallbacks.length;
i++){cleanupCallbacks[i](this,"remove")}}return origRemove.apply(this,arguments)}})();Orb.cancelEvent=function(ev){ev.stopPropagation();
ev.preventDefault()};Orb.shimClickCallback_shim=null;Orb.shimClickCallback_stack=[];Orb.shimClickCallback=function(callback,zIndex){if(!Orb.shimClickCallback_shim){Orb.shimClickCallback_shim=$("<div/>").hide();
Orb.shimClickCallback_shim.css({position:"absolute",top:0,right:0,left:0,bottom:0,background:"transparent"});
Orb.shimClickCallback_shim.appendTo("body");Orb.shimClickCallback_shim.on("click",function(ev){Orb.cancelEvent(ev);
Orb.shimClickCallbackPop(false,[ev])})}Orb.shimClickCallback_stack.push([callback,zIndex]);if(Orb.shimClickCallback_shim.data("zindex-class")){Orb.shimClickCallback_shim.removeClass(Orb.shimClickCallback_shim.data("zindex-class"))
}Orb.shimClickCallback_shim.addClass(zIndex).data("zindex-class",zIndex);Orb.shimClickCallback_shim.show()
};Orb.shimClickCallbackPop=function(no_callback,args){var lvl=Orb.shimClickCallback_stack.pop();if(lvl&&!no_callback){lvl[0].call(args)
}if(Orb.shimClickCallback_stack.length){if(Orb.shimClickCallback_shim.data("zindex-class")){Orb.shimClickCallback_shim.removeClass(Orb.shimClickCallback_shim.data("zindex-class"))
}Orb.shimClickCallback_shim.addClass(Orb.shimClickCallback_stack[Orb.shimClickCallback_stack.length-1][1]).data("zindex-class",Orb.shimClickCallback_stack[Orb.shimClickCallback_stack.length-1][1]);
Orb.shimClickCallback_shim.show()}else{Orb.shimClickCallback_shim.hide()}};Orb.resourceLoader={batches:{},batchesCallback:{},loadScript:function(src,callback){this.loadBatch([{type:"script",url:src}],callback)
},loadStylesheet:function(url,callback){this.loadBatch([{type:"css",url:url}],callback)},loadBatch:function(resources,callback){var batchId=Orb.uuid();
var head=$("head");this.batches[batchId]=[];this.batchesCallback[batchId]=callback;var res=null;while(res=resources.shift()){var resourceId=Orb.uuid();
var fn=function(){Orb.resourceLoader._resourceDoneLoading(batchId,resourceId)};if(res.type=="script"){var tag=document.createElement("script");
tag.type="text/javascript";tag.src=res.url}else{if(res.type=="stylesheet"){var tag=document.createElement("link");
tag.rel="stylesheet";tag.type="text/css";tag.href=res.url;tag.media="screen";if(res.media!=undefined){tag.media=res.media
}}}tag.onreadystatechange=function(){if(this.readyState=="complete"){fn()}};tag.onload=fn;this.batches[batchId].push(resourceId)
}},_resourceDoneLoading:function(batchId,resourceId){if(this.batches[batchId]==undefined){return false
}this.batches[batchId].erase(resourceId);if(!this.batches[batchId].length){var callback=this.batchesCallback[batchId];
delete this.batches[batchId];delete this.batchesCallback[batchId];callback()}}};Orb.DesktopNotify=(function(){if(window.webkitNotifications){var supported=true
}else{var supported=false}this.isSupported=function(){return supported};if(supported&&window.webkitNotifications.checkPermission()!=0){hasPermission=true
}var hasPermission=this.hasPermission=function(){return(supported&&window.webkitNotifications.checkPermission()!=0)
};this.askPermission=function(callback){if(!supported||hasPermission()){return}callback=callback||function(){};
window.webkitNotifications.requestPermission(callback)};this.show=function(options){if(!supported||!hasPermission()){return
}options=$.extend({},options,{iconUrl:null,title:"",content:"",click:null,show:null,close:null,error:null});
var notif=window.webkitNotifications.createNotification(options.iconUrl,options.title,options.content);
if(options.click){notif.onclick=options.click}if(options.show){notif.onshow=options.show}if(options.close){notif.onclose=options.close
}if(options.error){notif.onerror=options.error}return notif};this.showUrl=function(options){if(typeof options=="string"){options={url:options}
}var notif=window.webkitNotifications.createHTMLNotification(options.url);if(options.click){notif.onclick=options.click
}if(options.show){notif.onshow=options.show}if(options.close){notif.onclose=options.close}if(options.error){notif.onerror=options.error
}return notif};return this})();$.fn.single_double_click=function(single_click_callback,double_click_callback,timeout){timeout=timeout||250;
return this.each(function(){var clicks=0;var self=this;if($.browser.msie){$(this).bind("dblclick",function(event){clicks=2;
double_click_callback.call(self,event)});$(this).bind("click",function(event){setTimeout(function(){if(clicks!=2){single_click_callback.call(self,event)
}clicks=0},timeout)})}else{$(this).bind("click",function(event){clicks++;if(clicks==1){setTimeout(function(){if(clicks==1){single_click_callback.call(self,event)
}else{double_click_callback.call(self,event)}clicks=0},timeout)}})}})};jQuery.fn.extend({insertAtCaret:function(myValue){return this.each(function(i){if(document.selection){this.focus();
sel=document.selection.createRange();sel.text=myValue;this.focus()}else{if(this.selectionStart||this.selectionStart=="0"){var startPos=this.selectionStart;
var endPos=this.selectionEnd;var scrollTop=this.scrollTop;this.value=this.value.substring(0,startPos)+myValue+this.value.substring(endPos,this.value.length);
this.focus();this.selectionStart=startPos+myValue.length;this.selectionEnd=startPos+myValue.length;this.scrollTop=scrollTop
}else{this.value+=myValue;this.focus()}}})},setCaretPosition:function(caretPos){return $.proxy(function(){if(this.createTextRange){var range=this.createTextRange();
range.move("character",caretPos);range.select()}else{if(this.selectionStart){this.focus();this.setSelectionRange(caretPos,caretPos)
}else{this.focus()}}},this.get(0))},getCaretPosition:function(){return $.proxy(function(){if(document.selection&&document.selection.createRange){var range=document.selection.createRange();
var bookmark=range.getBookmark();return bookmark.charCodeAt(2)-2}else{if(this.setSelectionRange){return this.selectionStart
}else{return 0}}},this.get(0))}});function strtotime(str,now){var i,match,s,strTmp="",parse="";strTmp=str;
strTmp=strTmp.replace(/\s{2,}|^\s|\s$/g," ");strTmp=strTmp.replace(/[\t\r\n]/g,"");if(strTmp=="now"){return(new Date()).getTime()/1000
}else{if(!isNaN(parse=Date.parse(strTmp))){return(parse/1000)}else{if(now){now=new Date(now*1000)}else{now=new Date()
}}}strTmp=strTmp.toLowerCase();var __is={day:{"sun":0,"mon":1,"tue":2,"wed":3,"thu":4,"fri":5,"sat":6},mon:{"jan":0,"feb":1,"mar":2,"apr":3,"may":4,"jun":5,"jul":6,"aug":7,"sep":8,"oct":9,"nov":10,"dec":11}};
var process=function(m){var ago=(m[2]&&m[2]=="ago");var num=(num=m[0]=="last"?-1:1)*(ago?-1:1);switch(m[0]){case"last":case"next":switch(m[1].substring(0,3)){case"yea":now.setFullYear(now.getFullYear()+num);
break;case"mon":now.setMonth(now.getMonth()+num);break;case"wee":now.setDate(now.getDate()+(num*7));break;
case"day":now.setDate(now.getDate()+num);break;case"hou":now.setHours(now.getHours()+num);break;case"min":now.setMinutes(now.getMinutes()+num);
break;case"sec":now.setSeconds(now.getSeconds()+num);break;default:var day;if(typeof(day=__is.day[m[1].substring(0,3)])!="undefined"){var diff=day-now.getDay();
if(diff==0){diff=7*num}else{if(diff>0){if(m[0]=="last"){diff-=7}}else{if(m[0]=="next"){diff+=7}}}now.setDate(now.getDate()+diff)
}}break;default:if(/\d+/.test(m[0])){num*=parseInt(m[0],10);switch(m[1].substring(0,3)){case"yea":now.setFullYear(now.getFullYear()+num);
break;case"mon":now.setMonth(now.getMonth()+num);break;case"wee":now.setDate(now.getDate()+(num*7));break;
case"day":now.setDate(now.getDate()+num);break;case"hou":now.setHours(now.getHours()+num);break;case"min":now.setMinutes(now.getMinutes()+num);
break;case"sec":now.setSeconds(now.getSeconds()+num);break}}else{return false}break}return true};match=strTmp.match(/^(\d{2,4}-\d{2}-\d{2})(?:\s(\d{1,2}:\d{2}(:\d{2})?)?(?:\.(\d+))?)?$/);
if(match!=null){if(!match[2]){match[2]="00:00:00"}else{if(!match[3]){match[2]+=":00"}}s=match[1].split(/-/g);
for(i in __is.mon){if(__is.mon[i]==s[1]-1){s[1]=i}}s[0]=parseInt(s[0],10);s[0]=(s[0]>=0&&s[0]<=69)?"20"+(s[0]<10?"0"+s[0]:s[0]+""):(s[0]>=70&&s[0]<=99)?"19"+s[0]:s[0]+"";
return parseInt(this.strtotime(s[2]+" "+s[1]+" "+s[0]+" "+match[2])+(match[4]?match[4]/1000:""),10)}var regex="([+-]?\\d+\\s"+"(years?|months?|weeks?|days?|hours?|min|minutes?|sec|seconds?"+"|sun\\.?|sunday|mon\\.?|monday|tue\\.?|tuesday|wed\\.?|wednesday"+"|thu\\.?|thursday|fri\\.?|friday|sat\\.?|saturday)"+"|(last|next)\\s"+"(years?|months?|weeks?|days?|hours?|min|minutes?|sec|seconds?"+"|sun\\.?|sunday|mon\\.?|monday|tue\\.?|tuesday|wed\\.?|wednesday"+"|thu\\.?|thursday|fri\\.?|friday|sat\\.?|saturday))"+"(\\sago)?";
match=strTmp.match(new RegExp(regex,"gi"));if(match==null){return false}for(i=0;i<match.length;i++){if(!process(match[i].split(" "))){return false
}}return(now.getTime()/1000)}
/*! Copyright (c) 2008 Brandon Aaron (brandon.aaron@gmail.com || http://brandonaaron.net)
 * Dual licensed under the MIT (http://www.opensource.org/licenses/mit-license.php)
 * and GPL (http://www.opensource.org/licenses/gpl-license.php) licenses.
 */
(function($){var scrollbarWidth=0;
$.getScrollbarWidth=function(){if(!scrollbarWidth){if($.browser.msie){var $textarea1=$('<textarea cols="10" rows="2"></textarea>').css({position:"absolute",top:-1000,left:-1000}).appendTo("body"),$textarea2=$('<textarea cols="10" rows="2" style="overflow: hidden;"></textarea>').css({position:"absolute",top:-1000,left:-1000}).appendTo("body");
scrollbarWidth=$textarea1.width()-$textarea2.width();$textarea1.add($textarea2).remove()}else{var $div=$("<div />").css({width:100,height:100,overflow:"auto",position:"absolute",top:-1000,left:-1000}).prependTo("body").append("<div />").find("div").css({width:"100%",height:200});
scrollbarWidth=100-$div.width();$div.parent().remove()}}return scrollbarWidth}})(jQuery);(function($){$.fn.autoGrowInput=function(o){o=$.extend({maxWidth:1000,minWidth:0,comfortZone:10},o);
this.filter("input:text").each(function(){var minWidth=o.minWidth||$(this).width(),val="",input=$(this),testSubject=$("<tester/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:input.css("fontSize"),fontFamily:input.css("fontFamily"),fontWeight:input.css("fontWeight"),letterSpacing:input.css("letterSpacing"),whiteSpace:"nowrap"}),check=function(){if(val===(val=input.val())){return
}var escaped=val.replace(/&/g,"&amp;").replace(/\s/g,"&nbsp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
testSubject.html(escaped);var testerWidth=testSubject.width(),newWidth=(testerWidth+o.comfortZone)>=minWidth?testerWidth+o.comfortZone:minWidth,currentWidth=input.width(),isValidWidthChange=(newWidth<currentWidth&&newWidth>=minWidth)||(newWidth>minWidth&&newWidth<o.maxWidth);
if(isValidWidthChange){input.width(newWidth)}};testSubject.insertAfter(input);$(this).bind("keyup keydown blur update",check);
check()});return this}})(jQuery);if(!Date.prototype.toISOString){Date.prototype.toISOString=function(){function pad(n){return n<10?"0"+n:n
}return this.getUTCFullYear()+"-"+pad(this.getUTCMonth()+1)+"-"+pad(this.getUTCDate())+"T"+pad(this.getUTCHours())+":"+pad(this.getUTCMinutes())+":"+pad(this.getUTCSeconds())+"Z"
}}if(!Orb){var Orb={}}Orb.Class=function(properties){if(properties.DisableParentCall){function checkParentUse(obj){return false
}}else{if(typeof ORB_CLASS_DO_PARENT_DETECT=="undefined"){ORB_CLASS_DO_PARENT_DETECT=(function(){xyz}).toString().indexOf("xyz")!=-1
}function checkParentUse(obj){if(!ORB_CLASS_DO_PARENT_DETECT){return true}return obj.toString().indexOf("this.parent(")!=-1
}}delete properties.DisableParentCall;if(!properties.Extends){properties.Extends=function(){}}var parent_class=properties.Extends;
var parent_proto=parent_class.prototype;parent_class.__is_prototyping=true;var proto=new parent_class;
delete parent_class.__is_prototyping;delete properties.Extends;if(properties.Implements){for(var i=0,n=properties.Implements.length;
i!=n;++i){var mixin=properties.Implements[i];for(var name in mixin){if(!mixin.prototype||mixin.prototype.hasOwnProperty(name)){if(typeof mixin[name]=="function"){proto[name]=mixin[name]
}}}}}delete properties.Implements;var static_props=null;if(properties.ClassVars){static_props=properties.ClassVars;
delete properties.ClassVars}if(properties.destroy){properties.__destroy=properties.destroy;properties.destroy=(function(old){return function(){if(!this.OBJ_DESTROYED){old.apply(this)
}this.OBJ_DESTROYED=true}})(properties.__destroy)}else{properties.destroy=(function(){return function(){this.OBJ_DESTROYED=true
}})()}for(var name in properties){if(properties.prototype&&!properties.prototype.hasOwnProperty(name)){continue
}var value=properties[name];if(typeof value=="function"){if(name!="destroy"&&checkParentUse(value)){value=(function(func,name){return function(){this.parent=parent_proto[name];
return func.apply(this,arguments)}})(value,name)}proto[name]=value}else{console.error("[Orb.Class] Non-function property in class: %o extends %o",this,properties);
throw"Error: Non-function property in class";return}}var newClass;newClass=function(){if(newClass.__is_prototyping){return this
}this.CLASS=newClass;this.SUPER=parent_class;this.OBJ_ID=Orb.uuid();this.OBJ_DESTROYED=false;if(this.initialize){this.initialize.apply(this,arguments)
}return this};if(static_props){for(name in static_props){if(!static_props.prototype||static_props.prototype.hasOwnProperty(name)){newClass[name]=static_props[name]
}}}newClass.prototype=proto;newClass.constructor=newClass;delete properties;delete static_props;delete name;
delete value;delete checkParentUse;return newClass};Orb.createNamespace("Orb.Util");Orb.Util.Options={setOptions:function(setOptions){var options=$.extend(true,{},this.options||{},setOptions);
if(this.addEvent){for(var option in options){if(option=="defaultEventContext"){this.setDefaultEventContext(options[option]);
delete options[option]}else{if(typeof options[option]=="function"&&(/^on[A-Z]/).test(option)){this.addEvent(option,options[option]);
delete options[option]}}}}this.options=options;return this},getOption:function(option,default_value){if(typeof this.options[option]===undefined){return default_value
}return this.options[option]}};Orb.createNamespace("Orb.Util");Orb.Util.Events={__initEventsObj:function(){if(!this.__events){this.__events={};
this.__events_tagged={};this.__preventCleanupTagged=false}},setDefaultEventContext:function(context){this.__events_default_context=context
},normalizeEventName:function(type){return type.toLowerCase().replace(/^on/,"")},addEvent:function(type,fn,context,tags,beginning){this.__initEventsObj();
type=this.normalizeEventName(type);if(!context){context=this.__events_default_context}if(!this.__events[type]){this.__events[type]=[]
}if(beginning&&this.__events[type].length){var newVal=[];newVal.push([fn,context]);for(var i=0;i<this.__events[type].length;
i++){newVal.push(this.__events[type][i])}this.__events[type]=newVal}else{this.__events[type].push([fn,context])
}if(context&&context.OBJ_ID){tags=(tags||[]).push(context.OBJ_ID)}else{if(fn.OBJ_ID){tags=(tags||[]).push(fn.OBJ_ID)
}}if(tags){Array.each(tags,function(tag){if(!this.__events_tagged[tag]){this.__events_tagged[tag]=[]}this.__events_tagged[tag].push([type,fn,context])
},this)}return this},addEvents:function(events,context,tags){for(var type in events){this.addEvent(type,events[type],context,tags)
}return this},fireEvent:function(type,args,delay){this.__initEventsObj();type=this.normalizeEventName(type);
if(!this.__events[type]){return this}var defaultContext=this.__events_default_context||this;args=Array.from(args);
Object.each(this.__events[type],function(fn_info){if(delay){fn_info[0].delay(delay,fn_info[1]||defaultContext,args)
}else{fn_info[0].apply(fn_info[1]||defaultContext,args)}});return this},removeEvent:function(type,fn,context){var newFns=[],hasChange=false;
this.__initEventsObj();type=this.normalizeEventName(type);if(!this.__events[type]){return this}if(!context){context=null
}Array.each(this.__events[type],function(fn_info){if(fn_info[0]==fn&&fn_info[1]==context){hasChange=true
}else{newFns.push(fn_info)}});if(hasChange){this.__events[type]=newFns;if(!this.__preventCleanupTagged){this.__cleanupTaggedEvents()
}}return this},removeEvents:function(events,context){var type;this.__initEventsObj();this.__preventCleanupTagged=true;
for(type in this.__events){if(events&&events!=type){continue}var fns=this.__events[type];for(var i=fns.length;
i--;){if(i in fns){this.removeEvent(type,fns[i],context)}}}this.__preventCleanupTagged=false;this.__cleanupTaggedEvents();
return this},removeTaggedEvents:function(tag){if(!this.__events_tagged[tag]){return}this.__preventCleanupTagged=true;
Array.each(this.__events_tagged[tag],function(x){this.removeEvent(x[0],x[1],x[2])},this);this.__preventCleanupTagged=false;
this.__cleanupTaggedEvents()},__cleanupTaggedEvents:function(){return;Object.each(this.__events_tagged,function(tag_fns,tag){var newTaggedFns=[],hasChange=false;
Array.each(tag_fns,function(tag_fn){if(fn!=tag_fn){newTaggedFns.push(fn)}else{hasChange=true}});if(hasChange){if(newTaggedFns.length){this.__events_tagged[tag]=newTaggedFns
}else{delete this.__events_tagged[tag]}}else{newTaggedFns=null}},this)}};Orb.createNamespace("Orb.Util");
Orb.Util.EventObj=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(options){this.setOptions(options)
}});Orb.createNamespace("Orb.Util");Orb.Util.TimeAgo={_watchTimer:null,refreshPeriod:60000,phrases:{"sec_less":"1 second","sec":"1 second","secs":"{0} seconds","min":"1 minute","mins":"{0} minutes","hour":"1 hour","hours":"{0} hours","day":"1 day","days":"{0} days","week":"1 week","weeks":"{0} weeks","month":"1 month","months":"{0} months","year":"1 year","years":"{0} years","ago":"ago"},get:function(date,ago,relativeCutoff,title){return this.getForMs(this.getDateDiff(date),ago,relativeCutoff,title)
},applyToElements:function(els){var self=this;els.each(function(el){$(el).addClass("timeago-auto-update");
self.refreshElements([el])});if(this._watchTimer===null){this._watchTimer=window.setInterval(this.refreshElements.bind(this),this.refreshPeriod)
}},applyToJquery:function($els){this.applyToElements($els.toArray())},refreshElements:function(els){if(!els){els=$(".timeago-auto-update").toArray()
}var self=this;els.each(function(el){if(!el||!el.parentNode){return}el=$(el);el.addClass("with-timeago");
if(!el.data("timeago")){var isTime=el.get(0).tagName.toLowerCase()=="time";var iso8601=isTime&&el.attr("datetime")?el.attr("datetime"):el.attr("title");
if(!iso8601||typeof iso8601!="string"){return}var s=iso8601.replace(/\.\d\d\d+/,"");s=s.replace(/-/,"/").replace(/-/,"/");
s=s.replace(/T/," ").replace(/Z/," UTC");s=s.replace(/([\+-]\d\d)\:?(\d\d)/," $1$2");var titleText=$.trim(el.text());
if(titleText.length>0){el.attr("title",titleText)}el.data("timeago",{datetime:new Date(s),relativeCutoff:el.data("relative-cutoff")||0,title:titleText})
}var data=el.data("timeago");if(!isNaN(data.datetime)){var ago=true;if(el.data("timeago-no-ago")=="1"){ago=false
}else{if(data.datetime>(new Date())){ago=false}}var text=self.get(data.datetime,ago,data.relativeCutoff,data.title);
el.text(text)}})},getRelativeInfo:function(ms){var secs=0,mins=0,hours=0,days=0,years=0;secs=parseInt(ms/1000);
years=parseInt(secs/29030400);secs-=years*29030400;days=parseInt(secs/86400);secs-=days*86400;hours=parseInt(secs/3600);
secs-=hours*3600;mins=parseInt(secs/60);secs-=mins*60;return{"secs":secs,"mins":mins,"hours":hours,"days":days,"years":years}
},getForMs:function(ms,ago,relativeCutoff,title){var info=this.getRelativeInfo(ms);var total_secs=parseInt(ms/1000);
if(title&&relativeCutoff&&total_secs>relativeCutoff){return title}if(total_secs<60){return this.getPhraseFor("sec",total_secs,ago)
}else{if(total_secs<=7200){return this.getPhraseFor("min",info.mins+(info.hours*60),ago)}else{if(total_secs<=86400){var fraction;
if(info.mins<=15){fraction=""}else{if(info.mins<=30){fraction="Â¼"}else{if(info.mins<=45){fraction="Â½"
}else{if(info.mins<=60){fraction="Â¾"}}}}var phrase_num=info.hours;var phrase_hours=info.hours+"";if(fraction!==""){phrase_num+=1;
phrase_hours=(info.hours||1)+""+fraction}return this.getPhraseFor("hour",phrase_hours,ago,phrase_num)
}else{if(total_secs<=259200){var phrase_days=this.getPhraseFor("day",info.days,ago);if(info.hours>0){phrase_days+=" "+this.getPhraseFor("hour",info.hours,ago)
}return phrase_days}else{if(total_secs<=2419200){return this.getPhraseFor("day",info.days,ago)}else{if(total_secs<=7257600){var weeks=parseInt(info.days/7);
return this.getPhraseFor("week",weeks,ago)}else{if(total_secs<=29030400){var months=parseInt(info.days/30);
return this.getPhraseFor("month",months,ago)}else{if(total_secs<=145152000){var phrase_years=this.getPhraseFor("year",info.years,ago);
if(info.months>0){phrase_years+=" "+this.getPhraseFor("month",info.months,ago)}return phrase_years}else{return this.getPhraseFor("year",info.years,ago)
}}}}}}}}},getDateDiff:function(date,secs){var now_ts=(new Date()).getTime();var date_ts=date.getTime();
var diff;if(now_ts<date_ts){diff=date_ts-now_ts}else{diff=now_ts-date_ts}if(diff<0){return 0}if(secs){diff/=1000
}return diff},getPhraseFor:function(type,num,ago,num_exact){if(!num_exact){num_exact=num}if(window.Orb_Util_TimeAgo_getPhraseFor){if(num<0){num=0
}return window.Orb_Util_TimeAgo_getPhraseFor(type,num,ago)}if(type=="sec"&&num_exact<=0){return this.phrases["sec_less"]
}var k=type;if(num_exact!=1){k+="s"}var phrase=this.phrases[k];if(ago){phrase+=" "+this.phrases["ago"]
}phrase=phrase.replace(/\{0\}/g,num);return phrase}};if(jQuery){jQuery.fn.timeago=function(){Orb.Util.TimeAgo.applyToJquery(this);
return this}}Orb.createNamespace("Orb.Util");Orb.Util.CallQueue=new Orb.Class({initialize:function(options){this.queue=[];
this.length=0;this.hasFiredStart=false;this.startCallback=options.startCallback||null;this.endCallback=options.endCallback||null
},setStartCallback:function(startCallback){this.startCallback=startCallback},setEndCallback:function(endCallback){this.endCallback=endCallback
},addCall:function(fn,bind){this.queue.push([fn,bind||null]);this.length++},call:function(fn,bind){this.queue.push([fn,bind||null]);
this.length++;this.next()},hasNext:function(){return this.queue.length},next:function(){var next=this.queue.shift();
if(!next){this.hasFiredStart=false;if(this.endCallback){this.endCallback()}return}this.length--;if(!this.hasFiredStart){this.hasFiredStart=true;
if(this.startCallback){this.startCallback()}}var fn=next[0];var bind=next[1];if(!bind){bind=fn}return fn.call(bind)
}});Orb.createNamespace("Orb.Compat.WebForms");Orb.Compat.WebForms.isPlaceholderSupported=function(){this.isSupported=null;
if(this.isSupported===null){this.isSupported=("placeholder" in document.createElement("input"))}return this.isSupported
};Orb.Compat.WebForms.placeholder=function(input){if(!input){return null}input_col=$(input);if(!input_col.length){return null
}input_col.each(function(){var input=$(this);if(input.placeholder&&this.isPlaceholderSupported()){return
}var placeholder=input.attr("placeholder");if(!placeholder||!placeholder.length){return}if(input.is(".has-placeholder")){return
}input.addClass("has-placeholder");if(input.val()===""||input.val()==placeholder){input.val(placeholder);
input.addClass("placeholder-visible")}input.focus(function(){if(input.is(".placeholder-visible")){input.val("");
input.removeClass("placeholder-visible")}});input.blur(function(){if(input.val()===""){input.addClass("placeholder-visible");
input.val(placeholder)}else{input.removeClass("placeholder-visible")}});if(input.get(0)&&input.get(0).form){$(input.get(0).form).submit(function(){if(input.is(".placeholder-visible")){input.val("")
}})}})};Orb.createNamespace("DeskPRO");DeskPRO.ElementHandler_Exec=function(context){$("[data-element-handler]",context||document).not(".with-handler").each(function(){var el=$(this);
var className=el.data("element-handler");var classObj=Orb.getNamespacedObject(className);if(!classObj){DP.console.error("Unknown element handler `%s` on element %o",className,this);
return}if(!el.attr("id")){el.attr("id",Orb.getUniqueId("dp_"))}try{var obj=new classObj(el);el.addClass("with-handler")
}catch(e){console.error("Failed created element-handler (%o) : %o",className,e)}})};DeskPRO.ElementHandler=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(el){this.el=el;
this.options={};this.childHandlers={};this.parentHandlerElement=null;this.init();this.el.data("handler",this);
var initNow=true;if(this.el.data("register-handler")){var sel=this.el.data("register-handler");if(sel=="1"||!sel.length||sel=="yes"||sel=="true"){sel=".with-handler"
}var parentHandlerEl=this.el.closest(sel);if(parentHandlerEl.length){if(parentHandlerEl.data("handler")){this.parentHandlerElement=parentHandlerEl;
parentHandlerEl.data("handler")._registerChildHandler(this.el)}else{DP.console.error("Parent handler element %s has no handler object on element %o and handler %o",sel,this.el,this)
}initNow=false}else{DP.console.error("Unknown parent handler element %s on element %o and handler %o",sel,this.el,this)
}}if(initNow){this.initPage()}},init:function(){},initPage:function(){},_registerChildHandler:function(el){this.childHandlers[el.attr("id")]=el;
var ret=this.registerChildHandler(el.data("handler"),el.data("handler").getHandlerName(),el)||{};this.fireEvent("childHandler",[el,ret,this]);
el.data("handler").setParentReturnOptions(ret)},registerChildHandler:function(handler,handlerName,el){return{}
},setParentReturnOptions:function(ret){this.setOptions(ret);this.fireEvent("parentReturn",[ret,this.parentHandlerElement,this]);
this.initPage()},getHandlerName:function(){return"element_handler"}});Orb.createNamespace("DeskPRO.Agent.PageHelper");
DeskPRO.ElementHandler.ListRadio=new Orb.Class({Extends:DeskPRO.ElementHandler,init:function(){var self=this;
this.list=$("ul, ol",this.el).first();this.list.on("click","li",function(){$("li",self.list).removeClass("on");
$(this).addClass("on");self.el.trigger("listradiochange",[$(this).data("value"),$(this),this])})}});Orb.createNamespace("DeskPRO.Agent.PageHelper");
DeskPRO.ElementHandler.SimpleTabs=new Orb.Class({Extends:DeskPRO.ElementHandler,init:function(){var triggerElements,activeClassname="on";
if(this.el.data("trigger-elements")){triggerElements=$(this.el.data("trigger-elements"),this.el)}else{if(this.el.is("ul")){triggerElements=this.el.find("> li")
}else{triggerElements=this.el.find("ul").first().find("> li")}}if(this.el.data("active-classname")){activeClassname=this.el.data("active-classname")
}this.simpleTabs=new DeskPRO.UI.SimpleTabs({triggerElements:triggerElements,activeClassname:activeClassname});
this.el.data("simpletabs",this.simpleTabs)}});Orb.createNamespace("DeskPRO.Agent.PageHelper");DeskPRO.ElementHandler.CheckboxToggle=new Orb.Class({Extends:DeskPRO.ElementHandler,init:function(){var self=this;
var targets=$(this.el.data("targets"));var clearTargets=this.el.data("clear-targets");if(!targets.length){return
}var checkFn=function(){if(self.el.is(":checked")){targets.show()}else{targets.hide();if(clearTargets){targets.find('input[type="text"], input[type="password"], textarea').val("")
}}};this.el.on("click",function(){checkFn()});checkFn()}});Orb.createNamespace("DeskPRO.Agent.PageHelper");
DeskPRO.ElementHandler.CheckboxCallUrl=new Orb.Class({Extends:DeskPRO.ElementHandler,init:function(){var self=this;
var url=this.el.data("url");var prop=this.el.data("state-property");this.el.on("click",function(){$.ajax({url:url,type:"POST",dataType:"json",success:function(data){if(prop){var checked=!!data[prop];
self.el.attr("checked",!!data[prop])}}})})}});Orb.createNamespace("DeskPRO");DeskPRO.MessageBroker=new Orb.Class({Implements:[Orb.Util.Events],sendMessage:function(name,data){this.fireEvent(name,[data,name]);
var nameparts=name.split(".");var cur_name=null;while(nameparts.pop()){cur_name=nameparts.join(".")+".*";
this.fireEvent(cur_name,[data,cur_name])}},addMessageListener:function(name,callback,context,tags){this.addEvent(name,callback,context,tags)
},removeMessageListener:function(name,callback,context){this.removeEvent(name,callback,context)},removeTaggedListeners:function(tag){this.removeTaggedEvents(tag)
}});Orb.createNamespace("DeskPRO");DeskPRO.IntervalCaller=new Orb.Class({Implements:[Orb.Util.Options],initialize:function(options){this.options={touchResets:true,touchRequired:true,resetTimeForce:0,callback:function(){},context:null,timeout:null,autostart:true};
this.setOptions(options);if(this.options.autostart){this.start()}this.touched=false;this.paused=false;
this.lastTime=new Date()},start:function(){if(this.timer){window.clearTimeout(this.timer);this.timer=null
}this.timer=window.setTimeout(this.exec.bind(this),this.options.timeout)},stop:function(){if(this.timer){window.clearTimeout(this.timer);
this.timer=null}},touch:function(){this.touched=true;if(this.options.touchResets){if(this.options.resetTimeForce){var now=new Date();
var diff=now.getTime()-this.lastTime.getTime();if(diff>this.options.resetTimeForce){return}}this.start()
}},exec:function(force){if(!force&&this.options.touchRequired&&!this.touched){this.start();return}this.lastTime=new Date();
this.touched=false;if(this.options.context){this.options.callback.apply(this.options.context)}else{this.options.callback()
}this.start()},execNow:function(){this.exec()},destroy:function(){this.stop();this.options=null;this.lastTime=null
}});Orb.createNamespace("DeskPRO");DeskPRO.TouchCaller=new Orb.Class({Implements:[Orb.Util.Options],initialize:function(options){this.options={timeout:0,callback:function(){},context:null,alwaysChange:false};
this.setOptions(options);this.touched=null;this.lastTouch=null;this.lastTime=new Date();this.timeout=null
},touch:function(touch,force){if(touch===""){touch="(empty)"}if(typeof touch=="undefined"||touch==null){this.lastTouch=null;
touch=true}this.touched=touch;if(!force){if(!this.options.alwaysChange&&(this.lastTouch!==null&&this.lastTouch==touch)){return
}var now=new Date();var diff=now.getTime()-this.lastTime.getTime();if(diff<this.options.timeout){if(!this.timeout){this.timeout=window.setTimeout(this.exec.bind(this),this.options.timeout)
}return}}this.exec()},exec:function(){if(this.timeout){window.clearTimeout(this.timeout);this.timeout=null
}this.lastTouch=this.touched;this.touched=null;this.lastTime=new Date();if(this.options.context){this.options.callback.apply(this.options.context)
}else{this.options.callback()}},destroy:function(){if(this.timeout){window.clearTimeout(this.timeout);
this.timeout=null}this.options=null;this.lastTime=null}});Orb.createNamespace("DeskPRO");DeskPRO.WordHighlighter={highlight:function(node,words,excluseStopwords,onlyFirst){var i,w;
words.sort(function(a,b){if(a.length>b.length){return -1}else{return 1}});if(excluseStopwords){words=words.filter(function(w){return(DeskPRO.WordHighlighter.stopWords.indexOf(w)===-1)
})}if(!words.length){return[]}var text=$(node).text().toLowerCase();var useWords=[];for(i=0;i<words.length;
i++){var w=words[i].toLowerCase();if(!w||!w.length){continue}if(text.indexOf(w)!==-1){useWords.push(w)
}}if(!useWords.length){return[]}var addedNodes=[];this._do(node,useWords,words,addedNodes,onlyFirst,{});
return addedNodes},_do:function(node,words,originalWords,addedNodes,onlyFirst,_doneWords){var i,tmp;var proc_node=[node];
var replaceBits=[];while(node=proc_node.pop()){if(node.nodeType==3){for(i=0;i<words.length;i++){if(onlyFirst&&_doneWords[i]){continue
}var pos=node.data.toLowerCase().indexOf(words[i]);if(pos>=0&&!$(node.parentNode).hasClass("dp-highlight-word")&&!$(node.parentNode).closest(".dp-highlight-word")[0]){_doneWords[i]=true;
var spannode=document.createElement("span");spannode.className="dp-highlight-word";spannode.setAttribute("data-word",originalWords[i]);
addedNodes.push(spannode);var middlebit=node.splitText(pos);var endbit=middlebit.splitText(words[i].length);
var middleclone=middlebit.cloneNode(true);spannode.appendChild(middleclone);middlebit.parentNode.replaceChild(spannode,middlebit);
proc_node.push(endbit)}}}else{if(node.nodeType==1&&node.childNodes&&!/(script|style)/i.test(node.tagName)){var children=$.makeArray(node.childNodes);
for(i=0;i<children.length;i++){proc_node.push(children[i])}}}}},stopWords:["a's","able","about","above","according","accordingly","across","actually","after","afterwards","again","against","ain't","all","allow","allows","almost","alone","along","already","also","although","always","am","among","amongst","an","and","another","any","anybody","anyhow","anyone","anything","anyway","anyways","anywhere","apart","appear","appreciate","appropriate","are","aren't","around","as","aside","ask","asking","associated","at","available","away","awfully","be","became","because","become","becomes","becoming","been","before","beforehand","behind","being","believe","below","beside","besides","best","better","between","beyond","both","brief","but","by","c'mon","c's","came","can","can't","cannot","cant","cause","causes","certain","certainly","changes","clearly","co","com","come","comes","concerning","consequently","consider","considering","contain","containing","contains","corresponding","could","couldn't","course","currently","definitely","described","despite","did","didn't","different","do","does","doesn't","doing","don't","done","down","downwards","during","each","edu","eg","eight","either","else","elsewhere","enough","entirely","especially","et","etc","even","ever","every","everybody","everyone","everything","everywhere","ex","exactly","example","except","far","few","fifth","first","five","followed","following","follows","for","former","formerly","forth","four","from","further","furthermore","get","gets","getting","given","gives","go","goes","going","gone","got","gotten","greetings","had","hadn't","happens","hardly","has","hasn't","have","haven't","having","he","he's","hello","help","hence","her","here","here's","hereafter","hereby","herein","hereupon","hers","herself","hi","him","himself","his","hither","hopefully","how","howbeit","however","i'd","i'll","i'm","i've","ie","if","ignored","immediate","in","inasmuch","inc","indeed","indicate","indicated","indicates","inner","insofar","instead","into","inward","is","isn't","it","it'd","it'll","it's","its","itself","just","keep","keeps","kept","know","knows","known","last","lately","later","latter","latterly","least","less","lest","let","let's","like","liked","likely","little","look","looking","looks","ltd","mainly","many","may","maybe","me","mean","meanwhile","merely","might","more","moreover","most","mostly","much","must","my","myself","name","namely","nd","near","nearly","necessary","need","needs","neither","never","nevertheless","new","next","nine","no","nobody","non","none","noone","nor","normally","not","nothing","novel","now","nowhere","obviously","of","off","often","oh","ok","okay","old","on","once","one","ones","only","onto","or","other","others","otherwise","ought","our","ours","ourselves","out","outside","over","overall","own","particular","particularly","per","perhaps","placed","please","plus","possible","presumably","probably","provides","que","quite","qv","rather","rd","re","really","reasonably","regarding","regardless","regards","relatively","respectively","right","said","same","saw","say","saying","says","second","secondly","see","seeing","seem","seemed","seeming","seems","seen","self","selves","sensible","sent","serious","seriously","seven","several","shall","she","should","shouldn't","since","six","so","some","somebody","somehow","someone","something","sometime","sometimes","somewhat","somewhere","soon","sorry","specified","specify","specifying","still","sub","such","sup","sure","t's","take","taken","tell","tends","th","than","thank","thanks","thanx","that","that's","thats","the","their","theirs","them","themselves","then","thence","there","there's","thereafter","thereby","therefore","therein","theres","thereupon","these","they","they'd","they'll","they're","they've","think","third","this","thorough","thoroughly","those","though","three","through","throughout","thru","thus","to","together","too","took","toward","towards","tried","tries","truly","try","trying","twice","two","un","under","unfortunately","unless","unlikely","until","unto","up","upon","us","use","used","useful","uses","using","usually","value","various","very","via","viz","vs","want","wants","was","wasn't","way","we","we'd","we'll","we're","we've","welcome","well","went","were","weren't","what","what's","whatever","when","whence","whenever","where","where's","whereafter","whereas","whereby","wherein","whereupon","wherever","whether","which","while","whither","who","who's","whoever","whole","whom","whose","why","will","willing","wish","with","within","without","won't","wonder","would","would","wouldn't","yes","yet","you","you'd","you'll","you're","you've","your","yours","yourself","yourselves","zero"]};
Orb.createNamespace("DeskPRO.AjaxPoller");DeskPRO.AjaxPoller.Poller=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(options){this.dataTransformers=[];
this.filterdData=[];this.messageBroker=null;this.maxDelayTimers=[];this.isPaused=false;this.autoSendTimeout=null;
this.options={ajaxUrl:null,interval:6000,alwaysRequest:false,ajaxType:"SMART",postTypes:[]};this.disabled=false;
this.setOptions(options);this.autoSendTimeout=this.send.delay(this.options.interval,this)},pause:function(){this.isPaused=true
},unpause:function(){this.isPaused=false},setInterval:function(interval){this.options.interval=interval
},addDataTransformer:function(name,callback){this.dataTransformers.push(callback)},transformData:function(name,data,options){var nameparts=name.split(".");
var cur_name=null;while(nameparts.pop()){cur_name=nameparts.join(".")+".*";if(this.dataTransformers[cur_name]!==undefined){this.dataTransformers[cur_name].each(function(callback){data=callback(data,options,name)
})}}return data},addData:function(data,name,options){name=name||"default";options=options||{};if(options.addedTime===undefined){options.addedTime=new Date()
}if(options.maxDelay){(function(){this.send()}).delay(options.maxDelay,this)}this.filterdData.push([name,data,options])
},send:function(){this._clearDelays();if(this.isPaused){this.autoSendTimeout=this.send.delay(this.options.interval,this);
return}if(!this.options.alwaysRequest&&!this.filterdData.length){this.autoSendTimeout=this.send.delay(this.options.interval,this);
return}var now=new Date();var send_data=[];var sent_info=[];var hasPostType=false;var filterdData=this.filterdData;
this.filterdData=[];var item=null;while(item=filterdData.shift()){var item_name=item[0];var item_data=item_orig_data=item[1];
var item_opts=item[2];if(item_opts.minDelay&&!(item_opts.minDelayAfterOne&&!item_opts.sentCount)){if(item_opts.minDelay>(now.getTime()-item_opts.addedTime.getTime())){this.addData(item_orig_data,item_name,item_opts);
continue}}if(typeOf(item_data)=="function"){item_data=item_data(item_name,{},item_opts)}item_data=this.transformData(item_name,item_data,item_opts);
sent_info.push([item_orig_data,item_name,item_opts]);if(!item_data){continue}if(!hasPostType&&this.options.postTypes.indexOf(item_name)!==-1){hasPostType=true
}if(typeOf(item_data)=="array"){send_data.append(item_data)}else{Object.each(item_data,function(v,k){send_data.push({name:k,value:v})
})}}if(!this.options.alwaysRequest&&!sent_info.length){this._handleAjaxSuccess({},sent_info);return}type=this.options.ajaxType;
if(type=="SMART"){if(hasPostType){type="POST"}else{type="GET"}}$.ajax({cache:false,type:type,url:this.options.ajaxUrl,context:this,data:send_data,dataType:"json",dpIsPolling:true,success:function(data){this._handleAjaxSuccess(data,sent_info)
},error:function(xhr,textStatus,errorThrown){this._handleAjaxError(sent_info,xhr,textStatus,errorThrown)
}})},_handleAjaxSuccess:function(data,sent_info){if(data&&data.request_token){window.DP_REQUEST_TOKEN=data.request_token
}this.autoSendTimeout=this.send.delay(this.options.interval,this);this.resetSentItems(sent_info);this.fireEvent("ajaxSuccess",data)
},resetSentItems:function(sent_info){var item;while(item=sent_info.shift()){var item_name=item[0];var item_data=item[1];
var item_opts=item[2];if(item_opts.recurring){item_opts.lastSent=new Date();if(item_opts.sentCount===undefined){item_opts.sentCount=0
}item_opts.sentCount++;delete item_opts.addedTime;this.addData(item_name,item_data,item_opts)}}},_handleAjaxError:function(sent_info,xhr,textStatus,errorThrown){this.resetSentItems(sent_info);
this.autoSendTimeout=this.send.delay(this.options.interval,this);DP.console.error("Polling Error %s for %o",textStatus,xhr);
this.fireEvent("ajaxError",[xhr,textStatus,errorThrown])},_clearDelays:function(){this.autoSendTimeout=window.clearTimeout(this.autoSendTimeout);
this.autoSendTimeout=null;var t=null;while(t=this.maxDelayTimers.pop()){window.clearTimeout(t)}}});Orb.createNamespace("DeskPRO.AjaxPoller");
DeskPRO.AjaxPoller.MessagePoller=new Orb.Class({Extends:DeskPRO.AjaxPoller.Poller,initialize:function(messageBroker,options){this.parent(options);
this.messageBroker=messageBroker;this.addEvent("ajaxSuccess",this._sendMessages,this)},getMessageBroker:function(){return this.messageBroker
},_sendMessages:function(data){if(data.messages===undefined||typeOf(data.messages)!="array"){return}var message=null;
while(message=data.messages.shift()){this.messageBroker.sendMessage(message[0],message[1])}}});Orb.createNamespace("DeskPRO.MessageChanneler");
DeskPRO.MessageChanneler.AbstractChanneler=new Orb.Class({Implements:[Orb.Util.Options,Orb.Util.Events],initialize:function(messageBroker,options){this.channels=[];
this.options={};this.messageBroker=messageBroker;if(options){this.setOptions(options)}this._init()},_init:function(){},sendMessage:function(channel,message){if(DeskPRO_Window&&DeskPRO_Window.getDebug("logClientMessages")){DP.console.log("channel(%s): %o",channel,message)
}this.messageBroker.sendMessage(channel,message)}});Orb.createNamespace("DeskPRO.MessageChanneler");DeskPRO.MessageChanneler.AjaxChanneler=new Orb.Class({Extends:DeskPRO.MessageChanneler.AbstractChanneler,_init:function(){this.count=0;
this.hasDoneInitialLoad=false;this.lastMessageId=-1;this.poller=new DeskPRO.AjaxPoller.Poller({ajaxUrl:this.options.ajaxMessagesUrl,interval:this.options.interval,ajaxType:"SMART",postTypes:["dismiss_alerts","recent_tabs"]});
this.poller.addData((function(){if(this.lastMessageId===null){return null}return{"since":this.lastMessageId}
}).bind(this),"since",{recurring:true});this.poller.addData((function(){if(!DeskPRO_Window.dismissAlertQueue.length){return null
}var q=DeskPRO_Window.dismissAlertQueue;DeskPRO_Window.dismissAlertQueue=[];var send=[];Array.each(q,function(item){send.push({name:"dismiss_alerts[]",value:item})
});return send}).bind(this),"dismiss_alerts",{recurring:true});this.poller.addData((function(){return{"count":++this.count}
}).bind(this),"since",{recurring:true});this.poller.addData((function(){if(!(DeskPRO_Window.recentTabs&&DeskPRO_Window.recentTabs.recentPendingSync&&DeskPRO_Window.recentTabs.recentPendingSync.length)){return null
}var recent=[];Array.each(DeskPRO_Window.recentTabs.recentPendingSync,function(item,idx){recent.push([item[0],item[1],item[2],item[3],item[4]])
});DeskPRO_Window.recentTabs.recentPendingSync=[];var recentData=JSON.stringify(recent);return[{name:"recent_tabs",value:recentData}]
}).bind(this),"recent_tabs",{recurring:true});this.poller.addData({is_initial_poll:1},"is_initial_poll");
this.poller.addEvent("ajaxSuccess",this.handleMessageAjax.bind(this));if(this.options.lastMessageId){this.lastMessageId=this.options.lastMessageId
}},handleMessageAjax:function(data){if(!data){console.debug("Data is false");return}var ins_order,i,x,d,messages;
var ordered={};var orders=[];if(data.messages&&data.messages.length){for(x=0;x<data.messages.length;x++){d=data.messages[x];
if(d[0]&&(parseInt(d[0],10)<=this.lastMessageId)&&(!d[3]||!d[3]["offline_messsage"])){console.debug("%o Dropping message older than lastMessageId %d",d,this.lastMessageId);
return}var ins_order=50;if(d[1]=="agent.ticket-updated"){ins_order=55}if(!ordered[ins_order]){ordered[ins_order]=[];
orders.push(ins_order)}ordered[ins_order].push(d);if(d[0]&&d[0]>this.lastMessageId){this.lastMessageId=d[0]
}}}orders.sort(function(a,b){return a-b});for(i=0;i<orders.length;i++){messages=ordered[orders[i]];for(x=0;
x<messages.length;x++){d=messages[x];try{this.sendMessage(d[1],d[2])}catch(err){DpErrorLog.logError("[AjaxChanneler] "+err,err.stack||"",err.fileName||"",err.lineNumber||"")
}}}if(typeof data.last_id!="undefined"&&parseInt(data.last_id)>this.lastMessageId){this.lastMessageId=parseInt(data.last_id)
}this.fireEvent("postMessageSend",[data]);this.hasDoneInitialLoad=true},getLastMessageId:function(){return this.lastMessageId
},setLastMessageId:function(messageId){this.lastMessageId=messageId}});Orb.createNamespace("DeskPRO");
DeskPRO.Translate=new Orb.Class({initialize:function(loader){this.phrases={};this.loader=loader||function(id){return"["+id+"]"
};if(window.DESKPRO_LANG){this.phrases=window.DESKPRO_LANG}},getPhraseText:function(phrase_name){if(typeof this.phrases[phrase_name]=="undefined"){this.phrases[phrase_name]=this.loader(phrase_name)
}if(typeof this.phrases[phrase_name]=="undefined"){return null}return this.phrases[phrase_name]},phrase:function(phrase_name,vars,raw){var text=this.getPhraseText(phrase_name)||"["+phrase_name+"]";
return this.phraseWithString(text,vars,raw)},phraseWithString:function(text,vars,raw){if(vars){if(typeof vars.count!="undefined"){text=this.choosePlural(text,vars.count)
}Object.each(vars,function(value,key){var re=new RegExp("{{s*"+Orb.regexQuote(key)+"s*}}","g");if(raw){text=text.replace(re,value)
}else{text=text.replace(re,Orb.escapeHtml(value))}})}return text},hasPhrase:function(phrase_name){if(this.getPhraseText(phrase_name)===null){return false
}return true},choosePlural:function(text,number){var parts=text.split("|");if(number==0||number!=1){return parts[1]
}else{return parts[0]}},testInterval:function(number,interval){var x=0;var number=parseInt(number);interval=interval.trim();
var leftDelimIndex=1;var leftIndex=2;var rightIndex=3;var rightDelimIndex=4;var intervalRe=/({\s*(\-?\d+[\s*,\s*\-?\d+]*)\s*})|([\[\]])\s*(-Inf|\-?\d+)\s*,\s*(\+?Inf|\-?\d+)\s*([\[\]])/;
var match=interval.exec(intervalRe);if(!match){if(window.console&&window.console.error){console.error("Invalid interval: %s",interval)
}return"invalid interval"}if(matches[1]){var nums=matches[2].split(",");for(x=0;x<nums.length;x++){if(number==parseInt(nums[x])){return true
}}}else{var leftNum=match[leftIndex];var rightNum=match[rightIndex];if(leftNum=="-Inf"){leftNum=Number.NEGATIVE_INFINITY
}else{if(leftNum=="Inf"){leftNum=Number.POSITIVE_INFINITY}}if(rightNum=="-Inf"){rightNum=Number.NEGATIVE_INFINITY
}else{if(rightNum=="Inf"){rightNum=Number.POSITIVE_INFINITY}}var leftDelim=match[leftDelimIndex];var rightDelim=match[rightDelimIndex];
if((("["==leftDelim&&number>=leftNum)||number>leftNum)&&(("]"==rightDelim&&number>=rightNum)||number>rightNum)){return true
}}return false}});Orb.createNamespace("DeskPRO.Agent");DeskPRO.Agent.RteEditor={initRteAgentReply:function(textarea,options){textarea=$(textarea);
options=options||{};if(!options.defaultIsHtml){var val=textarea.val();if(val.length){textarea.val(DP.convertTextToWysiwygHtml(val,true))
}}var inlineHiddenPosition=options.inlineHiddenPosition;var dropZone=textarea.siblings(".drop-file-zone");
if(window.DP_AGENT_RTE_BUTTONS){var b=window.DP_AGENT_RTE_BUTTONS;var buttons=[];if(b.html){buttons.push("html")
}if((b.bold||b.italic||b.underline||b.strike)&&buttons.length){buttons.push("|")}if(b.bold){buttons.push("bold")
}if(b.italic){buttons.push("italic")}if(b.underline){buttons.push("underline")}if(b.strike){buttons.push("deleted")
}if(b.color){if(buttons.length){buttons.push("|")}buttons.push("fontcolor")}if(b.alignment){if(buttons.length){buttons.push("|")
}buttons.push("alignment")}if(b.list){if(buttons.length){buttons.push("|")}buttons.push("unorderedlist");
buttons.push("orderedlist");buttons.push("outdent");buttons.push("indent")}if((b.image||b.link||b.table||b.hr)&&buttons.length){buttons.push("|")
}if(b.image){buttons.push("image")}if(b.link){buttons.push("link")}if(b.table){buttons.push("table")}if(b.hr){buttons.push("horizontalrule")
}}else{var buttons=["html","|","bold","italic","underline","|","unorderedlist","orderedlist","outdent","indent","|","image","link","|","alignment"]
}var defaultOptions={direction:textarea.attr("dir")||"ltr",buttons:buttons,minHeight:150,observeImages:false,cleanup:false,imageUpload:BASE_URL+"agent/misc/accept-redactor-image-upload",uploadFields:{_rt:window.DP_REQUEST_TOKEN},plugins:["clean_text"],imageUploadCallback:function(obj,json){if(inlineHiddenPosition){inlineHiddenPosition.after($('<input type="hidden" name="blob_inline_ids[]" />').val(json.blob_id))
}},imageUploadErrorCallback:function(obj,json){alert(json.error)}};if(options.autosaveContent&&options.autosaveContentId){defaultOptions.autosave=BASE_URL+"agent/misc/redactor-autosave/"+options.autosaveContent+"/"+options.autosaveContentId;
defaultOptions.interval=5}options=Object.merge(defaultOptions,options);var autosaveUrl=options.autosave,autosaveInterval=options.interval||5,preAutosaveCallback=options.preAutosaveCallback;
options.autosave=false;options.cleanup=false;textarea.addClass("with-redactor");textarea.redactor(options);
var api=textarea.data("redactor");if(!api){return false}var editor=textarea.getEditor();if(!editor){return false
}api.$toolbar.find("a").attr("unselectable","on").attr("tabindex","-1");api.$editor.addClass("unreset");
editor.bind("keydown",function(ev){ev.stopPropagation();if(ev.metaKey&&!ev.ctrlKey){var sel;if(window.getSelection&&(sel=window.getSelection())&&sel.modify){var adjustmentType=ev.shiftKey?"extend":"move";
switch(ev.keyCode){case 39:sel.modify(adjustmentType,"right","lineboundary");ev.preventDefault();break;
case 37:sel.modify(adjustmentType,"left","lineboundary");ev.preventDefault();break}}}});editor.bind("keypress",function(ev){ev.stopPropagation()
});editor.bind("dragover drop",function(ev){ev.stopPropagation()});if(autosaveUrl){var getAutosaveData=function(api){var newContent=api.getCode(),name=api.$el.attr("name");
var data=[];data.push({name:name,value:newContent});if(preAutosaveCallback){data=preAutosaveCallback(textarea,data)
}return data};var autosaveContent=api.getCode(),autosaveData=getAutosaveData(api);var saveFnRunning=false;
var saveFn=$.proxy(function(){if(saveFnRunning){return}if(!textarea.data("redactor")){clearInterval(autosaveTimer);
autosaveTimer=false;return}if(!api.$editor.is(":visible")){return}if(textarea.data("disable-autosave")){return
}var newContent=this.getCode(),newData=getAutosaveData(this);if(newData.length){for(var i=0;i<newData.length;
i++){if(newData[i].name==name){newContent=newData[i].value;break}}}if(window.JSON&&window.JSON.stringify){if(JSON.stringify(newData)===JSON.stringify(autosaveData)){return
}}else{if(newContent==autosaveContent){return}}autosaveContent=newContent;autosaveData=newData;saveFnRunning=true;
var ajax=$.ajax({url:autosaveUrl,type:"post",data:newData,complete:function(){saveFnRunning=false;textarea.data("autosave-running",null)
},success:$.proxy(function(data){if(typeof this.opts.autosaveCallback==="function"){this.opts.autosaveCallback(data,this)
}},this)});textarea.data("autosave-running",ajax)},api);var autosaveTimer=setInterval(saveFn,autosaveInterval*1000);
textarea.on("dp_autosave_trigger",saveFn)}if(api.opts.imageUpload&&!$.browser.msie){var dropTarget=dropZone.length?dropZone:editor;
dropTarget.bind("drop",function(event){event.preventDefault();var file=event.originalEvent.dataTransfer.files[0];
if(!file){return}var fd=new FormData();fd.append("file",file);$.ajax({url:api.opts.imageUpload,dataType:"html",data:fd,cache:false,contentType:false,processData:false,type:"POST",success:$.proxy(function(data){var json=$.parseJSON(data);
if(typeof json.error=="undefined"){$.proxy(api.imageUploadCallback,api)(json)}else{$.proxy(api.opts.imageUploadErrorCallback,api)(api,json);
$.proxy(api.imageUploadCallback,api)(false)}},api)})});if(dropZone.length){textarea.getEditor().after(dropZone)
}}else{dropZone.remove()}var pasteImageCounter=1;var sendImage=function(pasteId,type,data,encoding){try{var form=new FormData();
if(typeof(data)=="string"){var byteString;if(encoding=="base64"){byteString=atob(data)}else{byteString=unescape(data)
}var array=[];for(var i=0;i<byteString.length;i++){array.push(byteString.charCodeAt(i))}data=new Blob([new Uint8Array(array)],{type:"image/"+type})
}form.append("file",data,"upload."+type);form.append("filename","upload."+type)}catch(e){return false
}$.ajax({url:BASE_URL+"agent/misc/accept-redactor-image-upload",type:"POST",dataType:"json",data:form,processData:false,contentType:false,success:function(json){if(!textarea.data("redactor")){return
}var img=textarea.getEditor().find("img[data-paste-id="+pasteId+"]");if(json.error){img.remove()}else{img.data("paste-id","").attr("src",json.filelink);
if(typeof api.opts.imageUploadCallback==="function"){api.opts.imageUploadCallback(api,json)}}textarea.data("redactor").insertHtml("")
}});return true};textarea.getEditor().on("copy",function(e){api.saveSelection();var html=api.getSelectedHtml();
html=html.replace(/<p/gi,'<p data-redactor="1"');if(!$.browser.msie){html=html.replace(/<(p|div)[^>]><\/(p|div)>/i,"")
}var div=$('<div data-redactor-wrapper="1" />').html(html).css({position:"absolute",left:"-9999px"});
$(document.body).append(div);var sel=api.getSelection();try{sel.selectAllChildren(div.get(0))}catch(e){if(document.createRange&&sel.removeAllRanges&&sel.addRange){var range=document.createRange();
range.selectNode(div.get(0));sel.removeAllRanges();sel.addRange(range)}}setTimeout(function(){div.remove();
api.restoreSelection()},0)});textarea.getEditor().on("paste",$.proxy(function(ev){this.pasteRunning=true;
if(ev.originalEvent.clipboardData){var items=ev.originalEvent.clipboardData.items;if(items){var hasImage=false;
for(var i=0;i<items.length;i++){if(items[i].type.match(/^image\/([a-z0-9_-]+)$/i)){var blob=items[i].getAsFile();
var URLObj=window.URL||window.webkitURL;var source=URLObj.createObjectURL(blob);var pasteImageId=pasteImageCounter++;
if(sendImage(pasteImageId,RegExp.$1,blob)){textarea.insertHtml('<img src="'+source+'" data-paste-id="'+pasteImageId+'">');
hasImage=true}}}if(hasImage){ev.preventDefault();ev.stopPropagation();return}}}this.setBuffer();if(this.opts.autoresize===true){this.saveScroll=document.body.scrollTop
}else{this.saveScroll=this.$editor.scrollTop()}var frag=this.extractContent();setTimeout($.proxy(function(){var pastedFrag=this.extractContent();
this.$editor.append(frag);this.restoreSelection();var imgs=pastedFrag.querySelectorAll("img");if(imgs){for(var i=0;
i<imgs.length;i++){imgs[i].setAttribute("style","-x-ignore: 1");if(imgs[i].src.match(/^data:image\/([a-z0-9_-]+);([a-z0-9_-]+),([\W\w]+)$/i)){var pasteImageId=pasteImageCounter++;
imgs[i].setAttribute("data-paste-id",pasteImageId);if(!sendImage(pasteImageId,RegExp.$1,RegExp.$3,RegExp.$2)){imgs[i].parentNode.removeChild(imgs[i])
}}}}var html=this.getFragmentHtml(pastedFrag);html=$.trim(html);html=html.replace(/^<div[^>]* data-redactor-wrapper="1"[^>]*>([\w\W]+)<\/div>$/,"$1");
html=html.replace(/(<p[^>]* data-redactor="1"[^>]*>[\w\W]*?<\/p>)<p>(<br>)?<span><span><\/span><\/span><\/p>/ig,"$1");
html=html.replace(/<p>(<br>)?<span><span><\/span><\/span><\/p>$/,"");html=html.replace(/<div/gi,"<p").replace(/<\/div>/g,"</p>");
html=html.replace(/<p([^>]*)>(\s*|<br\s*\/?>|&nbsp;)<\/p>/gi,"<br/>");html=html.replace(/(<p[^>]*) data-redactor="1"/g,"$1");
html=html.replace(/<\/p>\s*<p>/g,"</p><p>");html=html.replace(/^<p>/,"");html=html.replace(/<\/p>$/,"");
this.pasteCleanUp(html);this.pasteRunning=false},this),1)},textarea.data("redactor")));return textarea
}};if(typeof RedactorPlugins==="undefined"){var RedactorPlugins={}}RedactorPlugins.clean_text={init:function(){this.addBtn("clean_text","Clean selection formatting",function(redactor,event,button_key){var html=redactor.getSelectedHtml();
html=html.replace(/<\/td>/g,"\t");html=html.replace(/<\/tr>/g,"\n");html=html.replace(/\s*<div[^>]*>\s*/g,"\n");
html=html.replace(/\s*<\/p>\s*<p[^>]*>\s*/g,"\n\n");html=html.replace(/\s*<p[^>]*>\s*/g,"\n");html=html.replace(/\s*<br[^>]*\/>\s*/g,"\n");
html=html.replace(/\s*<br[^>]*>\s*/g,"\n");html=html.replace(/(<([^>]+)>)/ig,"");html=$.trim(html);html=html.replace(/\r|\r\n|\n/g,"\n<br/>");
redactor.setBuffer();redactor.insertHtml(html);redactor.syncCode()});this.addBtnSeparatorBefore("clean_text");
jQuery("a.redactor_btn_clean_text").css({backgroundImage:" url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAQ0lEQVQYV2MMDQ39zwAEq1evZgTR6AAmzwhjYFOMLAc2BZtidDG4dcgSyNbDnITiLnTFyO4mXSFRVhPlGaKDh9gABwAJuDgDsQ44aQAAAABJRU5ErkJggg==)",backgroundPosition:"7px 8px"})
}};Orb.createNamespace("DeskPRO");DeskPRO.TextExpander=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(options){this.options={textarea:null};
this.setOptions(options);this.comboString=null;this.$txt=$(this.options.textarea);var self=this;this.$txt.on("keypress",function(ev){if(ev.which==37){if(!self.comboString){self.comboString="%"
}else{var combo=self.comboString+"%";self.comboString=null;self.fireEvent("combo",[combo,ev])}}else{if(ev.which==8){}else{if(self.comboString){var chr=String.fromCharCode(ev.which);
if(chr.match(/[a-zA-Z0-9:\.\-_]/)){self.comboString+=chr}else{self.comboString=null}}else{self.comboString=null
}}}});this.$txt.on("keyup",function(ev){if(self.comboString&&ev.which==8){self.comboString=self.comboString.substring(0,self.comboString.length-1)
}})}});Orb.createNamespace("DeskPRO.UI");DeskPRO.UI.LabelsInput_Grouped={};DeskPRO.UI.LabelsInput=new Orb.Class({Implements:[Orb.Util.Options,Orb.Util.Events],initialize:function(options){var self=this;
this.options={input:null,fieldName:"labels",type:"",placeholder:false};this.setOptions(options);this.input=$(this.options.input);
var tagSource=false;if(this.options.type){if(DeskPRO.UI.LabelsInput_Grouped[this.options.type]){tagSource=DeskPRO.UI.LabelsInput_Grouped[this.options.type]
}else{if(window.DESKPRO_DATA_REGISTRY&&window.DESKPRO_DATA_REGISTRY.labels){tagSource=[];Object.each(window.DESKPRO_DATA_REGISTRY.labels,function(types,label){if(types.indexOf(this.options.type)!=-1){tagSource.push(label)
}},this);DeskPRO.UI.LabelsInput_Grouped[this.options.type]=tagSource}}if(!tagSource){console.warn("No type %s",this.options.type)
}}if(!tagSource){tagSource=[]}this.input.on("change",function(){self.fireEvent("change",self.getLabels())
});DP.select(this.input,{tags:tagSource,multiple:true,id:function(e){if(!e){return null}return e.id},formatResult:function(result,container,query){if(!result||!result.text){return""
}return Orb.escapeHtml(result.text)},matcher:function(term,text){if(typeOf(text)!="string"||typeOf(term)!="string"){return
}return text.toUpperCase().indexOf(term.toUpperCase())>=0}});this.input.select2("container").on("click",".select2-search-choice",function(ev){if(ev.target&&$(ev.target).is(".select2-search-choice-close")){return
}ev.preventDefault();ev.stopPropagation();var label=$(this).text().trim();if(label){$("#dp_search_box").data("handler").setSearch("["+label+"]")
}})},getLabels:function(){return this.input.select2("val")||[]},getFormData:function(){var tags=this.getLabels();
var field=this.options.fieldName;var postData=[];Array.each(tags,function(x){postData.push({name:field+"[]",value:x});
if(!DeskPRO.UI.LabelsInput_Grouped[this.options.type]){DeskPRO.UI.LabelsInput_Grouped[this.options.type]=[]
}if(DeskPRO.UI.LabelsInput_Grouped[this.options.type].indexOf(x)===-1){DeskPRO.UI.LabelsInput_Grouped[this.options.type].push(x)
}},this);return postData},destroy:function(){this.getLabels=function(){return[]};this.getFormData=function(){return[]
};this.input=null;this.options=null}});Orb.createNamespace("DeskPRO.UI");DeskPRO.UI.Overlay=new Orb.Class({Implements:[Orb.Util.Options,Orb.Util.Events],initialize:function(options){this.objectId=null;
this.options={triggerElement:null,contentMethod:"element",contentElement:null,contentAjax:{url:"",type:"GET",dataType:"html"},iframeUrl:null,iframeId:false,maxHeight:700,maxWidth:900,destroyOnClose:false,customClassname:"",classname:"",isModal:true,zIndex:10001,escapeClose:true,modalClickClose:true,objectGroup:"default",addClose:true,fullScreen:false,fullScreenMargin:"35px"};
this.isThisDestroyed=false;this.hasInit=false;this.hasSentAjax=false;this.elements={};if(options){this.setOptions(options)
}if(this.options.triggerElement){this.setupTriggerElement($(this.options.triggerElement))}if(this.options.zIndex=="none"){this.options.zIndex=""
}if(this.options.escapeClose){$(document).on("keydown",(function(ev){if(ev.which==27){this.closeOverlay()
}}).bind(this))}},getElement:function(){return this.getWrapper()},isOpen:function(){return this.isOverlayOpen()
},isOverlayOpen:function(){if(!this.hasInit){return false}return this.elements.wrapper.is(":visible")
},open:function(){return this.openOverlay()},openOverlay:function(){if(!this.initOverlay()){return}if(this.isOverlayOpen()){return
}var evData={overlay:this,cancel:false};this.fireEvent("beforeOverlayOpened",evData);if(evData.cancel){return
}var zindex=this.options.zIndex;if(zindex=="top"){var zindex=Orb.findHighestZindex()+1}this.elements.modal.css({"z-index":zindex,"position":"fixed","top":0,"right":0,"bottom":0,"left":0});
this.elements.modal.fadeIn(200);var topOffset=$(document).scrollTop();if(this.options.contentMethod=="iframe"){var w=$(window).width()-250;
var h=$(window).height()-150;if(w>this.options.maxWidth){w=this.options.maxWidth}if(h>this.options.maxHeight){h=this.options.maxHeight
}this.elements.wrapper.css({width:w,height:h});$("iframe:first",this.elements.wrapper).css({width:w,height:h-37});
var x=($(window).width()-this.elements.wrapperOuter.outerWidth())/2;var y=($(window).height()-this.elements.wrapperOuter.outerHeight())/2
}else{var w=this.elements.wrapperOuter.outerWidth();var pageW=$(window).width();var leftForCenter=(pageW/2)-(w/2);
var h=this.elements.wrapperOuter.outerHeight();var pageH=$(window).height();var topForCenter=(pageH/2)-(h/2);
this.elements.wrapperOuter.css({"top":topForCenter+topOffset,"left":leftForCenter})}if(true==this.getOption("fullScreen")){this.elements.wrapperOuter.css({"z-index":(zindex?zindex+1:""),"position":"fixed","left":this.getOption("fullScreenMargin"),"right":this.getOption("fullScreenMargin"),"top":this.getOption("fullScreenMargin"),"bottom":this.getOption("fullScreenMargin")})
}else{this.elements.wrapperOuter.css({"z-index":(zindex?zindex+1:""),"position":"fixed","left":leftForCenter})
}this.reposition();this.elements.wrapperOuter.fadeIn(450,(function(){this.fireEvent("overlayOpened",{overlay:this})
}).bind(this))},reposition:function(){if(this.getOption("fullScreen")){return}var w=this.elements.wrapperOuter.outerWidth();
var pageW=$(window).width();var leftForCenter=(pageW/2)-(w/2);var h=this.elements.wrapperOuter.outerHeight();
var pageH=$(window).height();var topForCenter=(pageH/2)-(h/2);var evData={overlay:this,wrapperOuter:this.elements.wrapperOuter,pageW:pageW,pageH:pageH,w:w,h:h,top:topForCenter,left:leftForCenter,setLeft:function(x){this.left=x
},setTop:function(x){this.top=x}};this.fireEvent("position",evData);this.elements.wrapperOuter.css({"top":evData.top,"left":evData.left})
},recalcForResize:function(){if(!this.isOpen()){return}this.reposition()},close:function(){return this.closeOverlay()
},closeOverlay:function(){if(!this.isOverlayOpen()){return}var eventData={overlay:this,cancelClose:false};
this.fireEvent("beforeOverlayClosed",eventData);if(eventData.cancelClose){return}this.elements.modal.fadeOut(450);
this.elements.wrapperOuter.fadeOut(200);this.fireEvent("overlayClosed",{overlay:this});this.fireEvent("close",{overlay:this});
if(this.options.destroyOnClose){this.destroy()}},initOverlay:function(){if(this.hasInit){return true}$(window).bind("resize."+this.OBJ_ID,this.recalcForResize.bind(this));
if(this.options.isModal){this.elements.modal=$('<div class="deskpro-overlay-overlay '+this.options.customClassname+'" style="display:none" />');
this.elements.modal.appendTo("body");if(this.options.modalClickClose){this.elements.modal.on("click",(function(ev){if(ev&&ev.deskpro&&ev.deskpro.cancelClose){return
}this.closeOverlay()}).bind(this))}}this.elements.wrapperOuter=$('<div class="deskpro-overlay-outer '+this.options.customClassname+" "+this.options.classname+'" style="display:none" />');
this.elements.wrapperOuter.appendTo("body");var overlayStyles="";if(true==this.getOption("fullScreen")){overlayStyles="height: 100%"
}this.elements.wrapper=$('<div class="deskpro-overlay '+this.options.customClassname+'" style="'+overlayStyles+'">');
this.elements.wrapper.appendTo(this.elements.wrapperOuter);switch(this.options.contentMethod){case"element":var el=$(this.options.contentElement);
if(el.data("overlay-apply-class")){this.elements.wrapperOuter.addClass(el.data("overlay-apply-class"))
}this._setContent(el);this.hasInit=true;return true;break;case"ajax":if(this.hasSentAjax){return false
}this.hasSentAjax=true;var ajaxConfig=Object.merge(this.options.contentAjax,{success:this._handleAjaxSuccess.bind(this)});
$.ajax(ajaxConfig);this.fireEvent("ajaxStart",{overlay:this});return false;break;case"iframe":var name="iframe_"+Orb.uuid();
var el=$('<iframe name="'+name+'" src="'+this.options.iframeUrl+'"></iframe>');if(this.options.iframeId){el.attr("id",this.options.iframeId)
}this._setContent(el);this.hasInit=true;this.elements.wrapper.addClass("no-pad").addClass("iframe");this.elements.wrapper.find("> .overlay-content").addClass("no-footer");
return true;break}DP.console.error("Unknown content method: %s",this.options.contentMethod);return false
},_handleAjaxSuccess:function(data){var dataEl=$(data);if(dataEl.length!=1){var el=$("<div />");el.append(dataEl)
}else{var el=dataEl}el.show();this._setContent(el);this.hasInit=true;var eventData={overlay:this,ajaxData:data};
this.fireEvent("ajaxDone",eventData);this.openOverlay()},_setContent:function(el){this.elements.wrapper.empty();
el.detach().appendTo(this.elements.wrapper);el.show();if(!$("div.overlay-content:first",el).length){var insideEl=el;
var el=$('<div class="overlay-content" />');insideEl.wrap(el)}if(this.options.title&&!this.elements.wrapper.find(".overlay-title")[0]){this.elements.wrapper.prepend('<div class="overlay-title"><h4></h4></div>').find("h4").text(this.options.title)
}if(this.options.addClose&&!$(".close-trigger, .close-overlay",this.elements.wrapper).length){$(".overlay-title:first",this.elements.wrapper).prepend('<a class="close close-trigger close-overlay">Close</a>')
}$(".overlay-close-trigger, .close-trigger, .close-overlay",this.elements.wrapper).first().on("click",(function(ev){ev.preventDefault();
this.closeOverlay()}).bind(this));if(!$(".overlay-footer:first",el).length){$("div.overlay-content:first",el).addClass("no-footer")
}this.reposition();this.fireEvent("contentSet",{overlay:this,contentEl:el,wrapperEl:this.elements.wrapper})
},setContent:function(el){this._setContent(el)},setupTriggerElement:function(el){el=$(el);var fn=(function(ev){this.openOverlay();
ev.preventDefault()}).bind(this);if(el.is(".dbl-click-trigger")){el.on("dblclick",fn)}else{el.on("click",fn)
}},getWrapper:function(){if(!this._hasInit){this.initOverlay()}return $(this.elements.wrapperOuter)},destroy:function(){this.fireEvent("beforeDestroy",[this]);
if(this.elements.wrapperOuter){this.elements.wrapperOuter.remove()}if(this.elements.modal){this.elements.modal.remove()
}this.isThisDestroyed=true;this.fireEvent("destroyed",[this]);$(window).unbind("."+this.OBJ_ID)},isDestroyed:function(){return this.isThisDestroyed
}});Orb.createNamespace("DeskPRO.UI");DeskPRO.UI.OptionBox=new Orb.Class({Implements:[Orb.Util.Options,Orb.Util.Events],initialize:function(options){this.options={element:null,trigger:null};
this.setOptions(options);this.el=this.options.element;if(this.options.trigger){$(this.options.trigger).on("click",this.open.bind(this))
}},getElement:function(type){if(!type||type=="element"){return this.el}else{if(type=="backdrop"){return this.backdrop
}}},_init:function(){var self=this;if(this._hasInit){return}this._hasInit=true;this.fireEvent("preInit",[this]);
this.backdrop=$('<div class="backdrop optionbox-backdrop" />');this.backdrop.appendTo("body").hide();
if(!this.el.parent().is("body")){this.el.detach().appendTo("body")}this.el.on("click",function(ev){ev.stopPropagation()
});this.backdrop.on("click",function(ev){ev.stopPropagation();self.close()});$(".close-trigger",this.el).on("click",function(ev){ev.stopPropagation();
self.close()});var allSame=this.el.is(".single-option-type");$(":checkbox, :radio",this.el).on("change",function(){self.clickCheckbox($(this))
});$("section",this.el).each(function(){var count=$("ul :checkbox",this).length;$(this).data("total-count",count);
if($(this).data("section-name")){$(this).addClass($(this).data("section-name"))}var opt=$(":checkbox, :radio",this).first();
if(opt.is(":radio")){$(this).data("input-type","radio")}else{$(this).data("input-type","checkbox")}});
$("section col",this.el).last().addClass("last");var amClicking=false;var lastClick=false;var elList=this.el.find("li");
this.el.on("click","li",function(ev){if(amClicking){return}amClicking=true;var radio=$(":radio, :checkbox",this);
if(ev.shiftKey&&lastClick){var idxMe=elList.index(this);var idxLast=elList.index(lastClick);var els=[];
if(idxMe>idxLast){for(var i=idxLast+1;i<=idxMe;i++){els.push($(elList.eq(i)).find(":radio, :checkbox").get(0))
}}else{for(var i=idxMe;i<idxLast;i++){els.push($(elList.eq(i)).find(":radio, :checkbox").get(0))}}radio=$(els)
}if(radio.length){radio.prop("checked",!radio.prop("checked"));self.clickCheckbox(radio);if(radio.is(":radio")){if(allSame){self.el.find("li.on").removeClass("on")
}else{radio.closest("section").find("li.on").removeClass("on")}}if(radio.prop("checked")){radio.closest("li").addClass("on")
}else{radio.closest("li").removeClass("on")}if(!self.options.liNoClickClose&&(radio.is(":radio")&&self.isSingleMode)){self.close()
}}lastClick=this;amClicking=false});$(":radio, :checkbox",this.el).on("change",function(){if($(this).is(":radio")){if(allSame){self.el.find("li.on").removeClass("on")
}else{$(this).closest("section").find("li.on").removeClass("on")}}if($(this).is(":checked")){$(this).closest("li").addClass("on")
}else{$(this).closest("li").removeClass("on")}});$("header .all-check",this.el).on("click",function(){var section=self._findSection($(this));
if($(this).is(":checked")){$("ul :checkbox",section).attr("checked",true)}else{$("ul :checkbox",section).attr("checked",false)
}self.updateCountEls(section)});$("header input.filter-box",this.el).on("keyup",function(){self.updateFilter($(this))
}).on("change",function(){self.updateFilter($(this))});$("header .toggle-btn",this.el).on("click",function(ev){Orb.cancelEvent(ev);
var section=self._findSection($(this));var checks=section.find(":checkbox");if(checks.filter(":checked").length){checks.attr("checked",false).trigger("change")
}else{checks.attr("checked",true).trigger("change")}self.updateCountEls(section)});var l=this.el.find("div.col").length;
if(l==0||l==1){this.isSingleMode=true}else{this.isSingleMode=false}this.fireEvent("init",[this])},clickCheckbox:function(check){var section=this._findSection(check);
this.updateCountEls(section);this.fireEvent("checked",[check,this])},updateCountEls:function(section){if(!section){var self=this;
this.el.find("section").each(function(){if($(this).data("section-name")){self.updateCountEls($(this))
}});return}var count=$("ul :checkbox:checked",section).length;var countEl=$(".selected-count",section);
if(count){$(".num",countEl).text(count);countEl.show()}else{$(".num",countEl).text("0");countEl.hide()
}if(count==section.data("total-count")){$("header .all-check",section).attr("checked",true)}else{$("header .all-check",section).attr("checked",false)
}},getCount:function(section){if(typeof section=="string"){section=$("section."+section,this.el)}return parseInt($(".selected-count .num",section).text()||0)
},getSelectedElements:function(section){if(typeof section=="string"){section=$("section."+section,this.el)
}var els=[];$("input:checked",section).each(function(){els.push($(this).closest("li").get(0))});els=$(els);
return els},getSelected:function(section){if(typeof section=="string"){section=$("section."+section,this.el)
}var val=[];$("li input:checked",section).each(function(){val.push($(this).val())});if(section.data("input-type")=="radio"){val=val.pop();
if(!val){val=null}}return val},getAllSelected:function(){var self=this;var ret={};$("section",this.el).each(function(){var name=$(this).data("section-name");
ret[name]=self.getSelected($(this))});return ret},_findSection:function(el){return el.closest("section")
},updateFilter:function(filterEl){var filter=filterEl.val().trim().toLowerCase();var section=this._findSection(filterEl);
var lis=$("li",section);if(!filter){lis.show();return}var show=[];var hide=[];lis.each(function(){var name=$("label",this).text().toLowerCase();
if(name.indexOf(filter)!==-1){show.push(this)}else{hide.push(this)}});$(hide).hide();$(show).show().each(function(){var itemId=$(this).data("item-id");
if(itemId){$("li.child-of-"+itemId,section).show();var parentId=$(this).data("parent-id");if(parentId){$("li.item-"+parentId,section).show()
}}})},open:function(event){this._init();this.fireEvent("preOpen",[this]);var viewportW=$(window).width();
var viewportH=$(window).height();var pageX=$(event.target).offset().top;var pageY=$(event.target).offset().left;
var w=this.el.width()+5;var h=this.el.height();this.el.show();this.backdrop.show();if(pageY+w>viewportW){pageY=viewportW-w-10
}if(pageX+h>viewportH){pageX=viewportH-h-10}this.el.css({top:pageX,left:pageY});this.el.addClass("open");
var cols=$(".col",this.el);if(cols.length){var max=0;var w=0;cols.each(function(){var ul=$("> section > ul",this);
w+=$(this).width();max+=ul.height()});$(".col > section > ul",this.el).each(function(){if($(this).height()<max){$(this).height(max)
}});w+=(1*cols.length);DP.console.log("setting w %i",w);this.el.width(w)}$(":checkbox, :radio",this.el).each(function(){if($(this).is(":checked")){$(this).closest("li").addClass("on")
}else{$(this).closest("li").removeClass("on")}});this.updateCountEls();this.fireEvent("open",[this])},close:function(){if(this._hasInit){this.backdrop.hide()
}if(!this.isOpen()){return}this.el.hide().removeClass("open");this.fireEvent("close",[this])},isOpen:function(){if(this._hasInit&&this.el.is(".open")){return true
}return false},destroy:function(){if(this._hasInit){this.el.remove();this.backdrop.remove()}}});Orb.createNamespace("DeskPRO.UI");
DeskPRO.UI.OptionBoxRevertable=new Orb.Class({Extends:DeskPRO.UI.OptionBox,initialize:function(options){var self=this;
options=options||{};options.liNoClickClose=true;this.parent(options);this.addEvent("preOpen",this.handlePreOpen,this);
this.addEvent("close",this.handleClose,this);this.hasApplied=false;$(".save-trigger",this.el).on("click",function(ev){self.hasApplied=true;
self.fireEvent("save",[self]);self.close()})},handlePreOpen:function(){this.preSelections=$("li.on",this.el)
},revertOptions:function(){$("li",this.el).removeClass("on");this.preSelections.each(function(){$(this).addClass("on");
$(":radio, :checkbox",this).prop("checked",true)})},handleClose:function(){if(!this.hasApplied&&this.preSelections){this.revertOptions()
}this.hasApplied=false;this.preSelections=null}});Orb.createNamespace("DeskPRO.UI");DeskPRO.UI.OptionBoxBuilder=new Orb.Class({Extends:DeskPRO.UI.OptionBox,initialize:function(options){var self=this;
var selectEl;var tpl=[];tpl.push('<div class="optionbox">');tpl.push('	<section data-section-name="default">');
tpl.push("		<header>");tpl.push("			<h3>&nbsp;</h3>");tpl.push('			<input type="text" class="filter-box" placeholder="Filter..." />');
tpl.push("		</header>");tpl.push("		<ul>");tpl.push("		</ul>");tpl.push("	</section>");tpl.push("</div>");
tpl=tpl.join("");var obEl=$(tpl);if(options.title){$("header h3",obEl).text(options.title)}if(options.addClass){obEl.addClass(options.addClass)
}var randid=Orb.uuid();var bindEl=null;if(options.values.is&&options.values.is("select")){if(options.values.attr("multiple")){options.selectType="checkbox"
}else{options.selectType="radio"}var hasSelected=false;selectEl=options.values;options.values=[];var selected_text="";
var selectoptions=$("option",selectEl);var is_sub=false;selectoptions.each(function(index,el){el=$(el);
var label=el.text().trim();if(el.parent().is("optgroup")){label=el.parent().attr("label")+" > "+label
}var has_child=false;var is_child=(label.indexOf("--")!==-1);var child_depth=0;if(is_child){child_depth=1;
if(label.indexOf("----")!==-1){child_depth=2}if(label.indexOf("------")!==-1){child_depth=3}if(label.indexOf("--------")!==-1){child_depth=4
}if(label.indexOf("----------")!==-1){child_depth=5}if(label.indexOf("------------")!==-1){child_depth=6
}if(label.indexOf("--------------")!==-1){child_depth=7}label=label.replace(/^\-\-/,"").trim()}else{has_child=(el.next().text().trim().indexOf("--")!==-1)
}if(!selected_text||el.is(":selected")){selected_text=el.text()}if(has_child){is_sub=true;options.values.push({label:label,value:el.val(),hasChild:has_child,hasParent:is_child,childDepth:child_depth,isSelected:el.hasClass("start")||el.data("start")})
}else{if(!is_child){is_sub=false}if(!hasSelected&&options.selectDefault){el.addClass("start");hasSelected=true
}options.values.push({label:label,value:el.val(),hasChild:has_child,hasParent:is_child,childDepth:child_depth,isSelected:(el.hasClass("start")||el.data("start")?true:false)})
}});var text=selected_text;if(!text.length){text=options.noValText||"Choose..."}if(options.spanEl){var spanEl=options.spanEl
}else{var spanEl=$('<span class="menu-trigger">'+Orb.escapeHtml(text)+"</span>").insertAfter(selectEl);
spanEl.on("click",self.open.bind(self))}selectEl.hide();this.addEvent("checked",function(el){var value=el.val();
$("option",selectEl).each(function(){if($(this).val()==value){if($(this).prop("selected")){$(this).prop("selected",false)
}else{$(this).prop("selected","selected")}}});selectEl.change()});selectEl.on("change",function(){var evData={select:this,stopDefault:false};
self.fireEvent("selectChange",evData);if(evData.stopDefault){return}var opt=$("option:selected",this);
if(opt.data("full-title")){var text=opt.data("full-title").trim()}else{var text=opt.text().trim()}if(!text.length){text=options.noValText||"Choose..."
}else{var prefix=$(this).data("prefix");if(prefix){text=prefix+text}}spanEl.text(text)})}var name=Orb.uuid();
if(selectEl&&selectEl.attr("name")){name=selectEl.attr("name").replace(/[^a-zA-Z_]/,"_")}Array.each(options.values,function(opt){if(options.selectType=="radio"){var li=$('<li><input type="radio" name="'+name+'" /><label></label></li>')
}else{var li=$('<li><input type="checkbox" /><label></label></li>')}if(opt.childDepth){li.addClass("depth-"+opt.childDepth);
li.prepend('<span class="elbow-end"></span>')}$("label",li).text(opt.label);$(":checkbox, :radio",li).first().val(opt.value).data("connected-to",opt);
if(opt.value==options.selected_value){$(":checkbox, :radio",li).first().prop("checked",true)}if(opt.extraData){Object.each(opt.extraData,function(v,k){li.data(k,v)
})}if(opt.hasChild){li.addClass("group-title")}if(opt.hasParent){li.addClass("child")}if(opt.isSelected){li.addClass("on");
li.find("input").prop("checked",true)}$("ul",obEl).append(li)});options.element=obEl;this.parent(options);
if(selectEl){selectEl.find(".start").prop("selected",true);selectEl.trigger("change")}}});Orb.createNamespace("DeskPRO.UI");
DeskPRO.UI.Menu_Instances={};DeskPRO.UI.Menu=new Orb.Class({DisableParentCall:true,Implements:[Orb.Util.Options,Orb.Util.Events],initialize:function(options){if(options&&options.element){options.menuElement=options.element
}if(options&&options.trigger){options.triggerElement=options.trigger}this.options={triggerElement:null,customClassname:"",zIndex:0,menuElement:null,objectGroup:"default",subMenuConfig:null,initSubMenusNow:false,initMenuNow:false,parentMenu:null};
this.hasInit=false;this.elements={};this.openTriggerEvent=null;this.openedTime=null;this.cachePosInfo=null;
this.subMenus=[];this.openSubMenuId=null;this.parentMenu=null;this.objectId=Orb.uuid();if(options){this.setOptions(options)
}if(this.options.parentMenu){this.parentMenu=this.options.parentMenu;delete this.options.parentMenu}if(DeskPRO.UI.Menu_Instances[this.options.objectGroup]===undefined){DeskPRO.UI.Menu_Instances[this.options.objectGroup]={}
}DeskPRO.UI.Menu_Instances[this.options.objectGroup][this.objectId]=this;this._setupMenuElement();if(this.options.triggerElement){this.setupTriggerElement($(this.options.triggerElement))
}if(this.options.initMenuNow){this._initMenu()}},_setupMenuElement:function(){var self=this;var origMenuElement=$(this.options.menuElement);
if(origMenuElement.data("menu-flag")&&origMenuElement.data("menu-flag").indexOf("copy-menu")!==-1){origMenuElement=origMenuElement.clone();
if(origMenuElement.attr("id")){origMenuElement.attr("id",origMenuElement.attr("id")+"_"+Orb.uuid())}}if(origMenuElement.is("select")){var html=[];
html.push('<ul class="menu" style="display:none">');var selected_text=null;var options=$("option",origMenuElement);
var is_sub=false;options.each(function(index,el){el=$(el);var has_child=(el.next().text().indexOf("--")!==-1);
var is_child=(el.text().indexOf("--")!==-1);if(!selected_text||el.is(":selected")){selected_text=el.text()
}if(index&&!is_child&&(has_child||is_sub)){html.push('<li class="sep">')}if(has_child){is_sub=true;html.push('<li class="section-title">'+Orb.escapeHtml(el.text())+"</li>")
}else{if(!is_child){is_sub=false}html.push('<li data-value="'+el.val()+'">'+Orb.escapeHtml(el.text())+"</li>")
}});html.push("</ul>");var menuElement=$(html.join("")).appendTo("body");this.options.menuElement=menuElement;
origMenuElement.css({"display":"none"});if(!this.options.triggerElement){var text=selected_text;if(!text.length){text=self.options.noValText||"Choose..."
}var spanEl=this.options.triggerElement=$('<span class="menu-trigger">'+Orb.escapeHtml(text)+"</span>").insertAfter(origMenuElement);
this.addEvent("itemClicked",function(ev){var itemEl=$(ev.itemEl);var text=itemEl.text().trim();if(!text.length){text=self.options.noValText||"Choose..."
}else{var prefix=$(ev.itemEl).data("prefix");if(prefix){text=prefix+text}}spanEl.text(text)})}this.addEvent("itemClicked",function(ev){var itemEl=$(ev.itemEl);
var value=itemEl.data("value");if(value!=origMenuElement.val()){origMenuElement.val(value);origMenuElement.change()
}});if(spanEl){origMenuElement.on("change",function(){var opt=$("option:selected",this);var text=opt.text().trim();
if(!text.length){text=self.options.noValText||"Choose..."}else{var prefix=$(this).data("prefix");if(prefix){text=prefix+text
}}spanEl.text(text)})}}},isOpen:function(){return this.isMenuOpen()},isMenuOpen:function(){if(!this.hasInit){return false
}return this.elements.wrapper.is(":visible")},getOpenTriggerEvent:function(){return this.openTriggerEvent
},getOpenTriggerElement:function(){if(!this.openTriggerEvent){return null}return this.openTriggerEvent.target
},open:function(event){return this.openMenu(event)},openMenu:function(event){if(!this._initMenu()){return
}if(this.isMenuOpen()){return}if(!this.parentMenu){Object.each(DeskPRO.UI.Menu_Instances[this.options.objectGroup],function(v,k){if(v.isMenuOpen()){v.closeMenu()
}})}this.openTriggerEvent=event;if(event&&event.stopPropagation){event.stopPropagation()}var eventData={menu:this,cancelOpen:false};
if(event&&event.customEvents){event.customEvents.fireEvent("beforeMenuOpened",eventData)}if(!eventData.noFireEvent){this.fireEvent("beforeMenuOpened",eventData)
}if(eventData.cancelOpen){this.openTriggerEvent=null;return}if(!this.options.zIndex){this.options.zIndex=Orb.findHighestZindex()+1
}var target;if(this.options.triggerElement&&this.options.triggerElement[0]){target=this.options.triggerElement
}else{if(event){target=event.target}else{}}if(target){target=$(target);if(!target.is(".menu-fitted")){target=target.closest(".menu-fitted")
}if(!target.is(".menu-fitted")){target=null}}if(!target&&!event&&this.options.triggerElement){target=$(this.options.triggerElement)
}if(target){if(target.data("menu-button")){target=target.find(target.data("menu-button"))}this.targetEl=target;
target=$(target);var tPos=target.offset();var tWidth=target.outerWidth();var tHeight=target.outerHeight();
var top=tPos.top+tHeight-1;var left=tPos.left;var minW=tWidth+15;this.elements.wrapperOuter.css("min-width",minW).addClass("fitted");
if(this.elements.wrapperOuter.outerWidth()+left>$(document).width()){left=(tPos.left+tWidth)-this.elements.wrapperOuter.outerWidth()
}this.lineRemover=$("<div />").addClass("menu-fitted-line");this.lineRemover.css({position:"absolute",width:tWidth-2,height:4,top:tPos.top+tHeight-4,left:tPos.left+1,"z-index":this.options.zIndex+10}).appendTo("body")
}else{if(this.cachePosInfo&&this.openedTime&&this.parentMenu&&this.parentMenu.openedTime&&this.parentMenu.openedTime<=this.openedTime){var left=this.cachePosInfo.left;
var top=this.cachePosInfo.top;var point=this.cachePosInfo.point}else{var width=this.elements.wrapperOuter.outerWidth();
var height=this.elements.wrapperOuter.outerHeight();var pageWidth=$(document).width();var pageHeight=$(document).height();
if(this.parentMenu!==null&&this.parentMenu.isMenuOpen()){var pageX=this.options.parentMenuItem.offset().left+this.options.parentMenuItem.outerWidth()-4;
var pageY=this.options.parentMenuItem.offset().top;if(pageX+width>pageWidth){pageX=this.options.parentMenuItem.offset().left-width
}}else{if(event&&event.target&&!$(event.target).is(".with-menu-click-position")){var pageX=$(event.target).offset().left+($(event.target).width()/2);
var pageY=$(event.target).offset().top+($(event.target).outerHeight())+2}else{if(event&&event.pageX){var pageX=event.pageX;
var pageY=event.pageY}else{if(event&&event.target){var pageX=$(event.target).offset().left;var pageY=$(event.target).offset().top
}else{}}}}var point=true;if(pageX+width<pageWidth){var left=pageX}else{var left=pageWidth-width-4;point=false
}if(pageY+height<pageHeight){var top=pageY}else{var top=pageHeight-height-4;point=false}if(top<0){top=5
}if(point&&left>=10){left-=10}this.cachePosInfo={left:left,top:top,point:point}}}if(this.elements.shim){this.elements.shim.css({"z-index":this.options.zIndex+1,"position":"absolute","top":0,"right":0,"bottom":0,"left":0,"background":"transparent"}).show()
}if(point){this.elements.wrapperOuter.addClass("with-point")}else{this.elements.wrapperOuter.removeClass("with-point")
}if((top+this.elements.wrapperOuter.height())>($(window).height()-3)){this.elements.wrapper.addClass("with-scrolldown");
this.elements.wrapperInner.css("max-height",$(window).height()-top-3)}else{this.elements.wrapper.removeClass("with-scrolldown with-scrollup");
this.elements.wrapperInner.css("max-height","auto")}this.elements.wrapperOuter.css({"z-index":this.options.zIndex+2,"position":"absolute","top":top,"left":left});
this.elements.wrapperOuter.show();this.openedTime=new Date();if(event&&event.customEvents){event.customEvents.fireEvent("menuOpened",{menu:this})
}if(!eventData.noFireEvent){this.fireEvent("menuOpened",{menu:this})}if(this.targetEl){this.targetEl.addClass("menu-open")
}},close:function(){return this.closeMenu()},closeMenu:function(){if(!this.isMenuOpen()){return false
}var eventData={menu:this,cancelClose:false};if(this.openTriggerEvent&&this.openTriggerEvent.customEvents){this.openTriggerEvent.customEvents.fireEvent("beforeMenuClosed",eventData)
}if(!eventData.noFireEvent){this.fireEvent("beforeMenuClosed",eventData)}if(eventData.cancelClose){return false
}this._closeSubMenu();if(this.elements.shim){this.elements.shim.hide()}if(this.parentMenu){this.elements.wrapperOuter.hide()
}else{this.elements.wrapperOuter.fadeOut(200)}if(this.openTriggerEvent&&this.openTriggerEvent.customEvents){this.openTriggerEvent.customEvents.fireEvent("menuClosed",{menu:this})
}if(!eventData.noFireEvent){this.fireEvent("menuClosed",{menu:this})}this.openTriggerEvent=null;if(this.targetEl){this.targetEl.removeClass("menu-open");
this.targetEl=null}if(this.lineRemover){this.lineRemover.remove();this.lineRemover=null}return true},_menuItemClicked:function(event){var eventData={menu:this,event:event,itemEl:event.currentTarget,cancelClose:false};
if($(eventData.itemEl).is(".sep, .disabled, .section-title")){return false}if($(eventData.itemEl).is(".elm, .sep, .section-title")){eventData.cancelClose=true
}if(this.openTriggerEvent&&this.openTriggerEvent.customEvents){this.openTriggerEvent.customEvents.fireEvent("itemClicked",eventData)
}if(!eventData.noFireEvent){this.fireEvent("itemClicked",eventData)}event.stopPropagation();if(this.parentMenu&&this.parentMenu.isMenuOpen()){this.parentMenu._menuItemClicked(event)
}if(eventData.cancelClose){return}this.closeMenu()},_menuItemMouseover:function(event){var eventData={menu:this,event:event,itemEl:event.currentTarget};
if(this.openTriggerEvent&&this.openTriggerEvent.customEvents){this.openTriggerEvent.customEvents.fireEvent("itemMouseover",eventData)
}if(!eventData.noFireEvent){this.fireEvent("itemMouseover",eventData)}event.stopPropagation();var itemEl=$(eventData.itemEl);
var subMenuId=itemEl.data("submenu-id");if(this.openSubMenuId==subMenuId){return}this._closeSubMenu();
if(subMenuId===undefined){return}var subMenu=this.subMenus[subMenuId];subMenu._initMenu();subMenu.openMenu(this.openTriggerEvent||event);
this.openSubMenuId=subMenuId;itemEl.addClass("hover")},_closeSubMenu:function(){if(this.openSubMenuId!==null){this.subMenus[this.openSubMenuId].closeMenu();
this.subMenus[this.openSubMenuId].options.parentMenuItem.removeClass("hover");this.openSubMenuId=null
}},_initMenu:function(){var self=this;if(this.hasInit){return true}this.hasInit=true;if(!this.parentMenu){this.elements.shim=$("<div />").hide().appendTo("body");
this.elements.shim.on("click",(function(ev){if(this.closeMenu()){ev.stopPropagation()}}).bind(this))}this._initWrapperElements();
this.elements.list=$(this.options.menuElement);this.elements.list.detach().show().appendTo(this.elements.wrapper);
if(this.options.subMenuConfig){var subMenuConfig=this.options.subMenuConfig}else{var subMenuConfig={}
}$("li",this.elements.list[0]).live("click",this._menuItemClicked.bind(this));$("li",this.elements.list[0]).live("mouseover",this._menuItemMouseover.bind(this));
$("> li[data-submenu-selector]",this.elements.list[0]).each((function(i,el){var subMenuEl=$($(el).data("submenu-selector")).first();
if(subMenuEl.length){subMenuEl=subMenuEl.clone();subMenuEl.data("menu-flag","");subMenuEl.attr("menu-flag","");
subMenuEl.attr("id","");subMenuEl.addClass("submenu");if($(el).data("submenu-add-action")){subMenuEl.data("action",$(el).data("submenu-add-action")).attr("data-action",$(el).data("submenu-add-action"))
}subMenuEl.appendTo(el);$(el).data("submenu-selector","").attr("submenu-selector","")}}).bind(this));
var subs=$("> li > ul.submenu",this.elements.list[0]);if(subs.length){subs.each((function(i,el){var subMenuEl=$(el);
el=$(subMenuEl.parent());el.on("mouseover",this._menuItemMouseover.bind(this));subMenuEl.hide();var subMenuId=this.subMenus.length;
el.addClass("with-submenu");el.data("submenu-id",subMenuId);subMenuConfig.parentMenu=this;subMenuConfig.subMenuId=subMenuId;
subMenuConfig.parentMenuItem=el;subMenuConfig.menuElement=subMenuEl;if(this.options.zIndex){subMenuConfig.zIndex=this.options.zIndex+10
}var subMenu=new DeskPRO.UI.Menu(subMenuConfig);this.subMenus.push(subMenu);el.prepend($('<span class="arrow">&#x25B8;</span>'));
if(this.options.initSubMenusNow){subMenu._initMenu()}}).bind(this))}this.elements.wrapper.find(".deskpro-menu-scrolldown").on("click",function(ev){ev.preventDefault();
ev.stopImmediatePropagation();var newpos=self.elements.wrapperInner.scrollTop()+30;var max=self.elements.wrapper.height()-self.elements.wrapperInner.height()+30;
if(newpos>=max){self.elements.wrapper.removeClass("with-scrolldown");newpos+=10}self.elements.wrapperInner.scrollTop(newpos);
self.elements.wrapper.addClass("with-scrollup")});this.elements.wrapper.find(".deskpro-menu-scrollup").on("click",function(ev){ev.preventDefault();
ev.stopImmediatePropagation();var newpos=self.elements.wrapperInner.scrollTop()-30;if(newpos<0){newpos=0
}self.elements.wrapperInner.scrollTop(newpos);self.elements.wrapper.addClass("with-scrolldown");if(newpos==0){self.elements.wrapper.removeClass("with-scrollup")
}});this.fireEvent("menuInit",{menu:this});return true},_initWrapperElements:function(){this.elements.wrapperOuter=$('<div class="deskpro-menu-outer '+this.options.customClassname+'" style="display:none" />');
this.elements.wrapperOuter.appendTo("body");this.elements.wrapperInner=$('<div class="deskpro-menu-inner '+this.options.customClassname+'" />');
this.elements.wrapperInner.appendTo(this.elements.wrapperOuter);this.elements.wrapper=$('<div class="deskpro-menu '+this.options.customClassname+'"><div class="deskpro-menu-scrollup"></div><div class="deskpro-menu-scrolldown"></div>');
this.elements.wrapper.appendTo(this.elements.wrapperInner)},getListElement:function(){if(this.elements.list){return this.elements.list
}else{return this.options.menuElement}},setupTriggerElement:function(el){el=$(el);el.on("click",(function(ev){ev.preventDefault();
this.openMenu(ev)}).bind(this))},getWrapper:function(){return $(this.elements.wrapperOuter)},destroy:function(){this.closeMenu();
if(this.elements&&this.elements.shim){this.elements.shim.remove()}if(this.elements&&this.elements.wrapperOuter){this.elements.wrapperOuter.remove()
}if(this.options.menuEl){this.options.menuEl.remove()}delete DeskPRO.UI.Menu_Instances[this.options.objectGroup][this.objectId];
Array.each(this.subMenus,function(menuInfo){if(!menuInfo.OBJ_DESTROYED){menuInfo.destroy()}});this.subMenus=[]
}});Orb.createNamespace("DeskPRO.UI");DeskPRO.UI.SimpleTabs=new Orb.Class({Implements:[Orb.Util.Options,Orb.Util.Events],initialize:function(options){this.options={triggerElements:".tab-trigger",activeClassname:"on",context:document,autoSelectFirst:true,effect:null};
this.lastActiveTab=null;this.triggerEls=null;if(options){this.setOptions(options)}this.triggerEls=this.options.triggerElements;
if(typeOf(this.triggerEls)=="string"){this.triggerEls=$(this.triggerEls,this.options.context)}var self=this;
this.triggerEls.on("click",function(ev){ev.cancel=false;ev.tabEl=$(this);self.fireEvent("tabClick",[ev]);
if(!ev.cancel){self._handleTabClick(this,ev)}self.fireEvent("postTabClick",[ev])});if(this.options.autoSelectFirst){var firstTab=this.triggerEls.filter("."+this.options.activeClassname).filter(":visible").first();
if(!firstTab.length){firstTab=this.triggerEls.filter(":visible").first();if(!firstTab.length){firstTab=this.triggerEls.first()
}}if(firstTab.length){var self=this;this.triggerEls.each(function(){self.getContentElFromTab($(this)).hide()
});this.activateTab(firstTab)}}},addTriggerElement:function(el){var self=this;this.triggerEls.add(el);
el.on("click",function(ev){ev.cancel=false;ev.tabEl=$(this);self.fireEvent("tabClick",[ev]);if(!ev.cancel){self._handleTabClick(this,ev)
}})},_handleTabClick:function(el,event){var tab=$(el);this.activateTab(tab,event)},activateTab:function(tabEl,event){if(!tabEl){return
}tabEl=$(tabEl);if(this.lastActiveTab&&this.lastActiveTab.get(0)==tabEl.get(0)){return}var eventData={event:event||null,tabEl:tabEl,lastTabEl:this.lastActiveTab,tabContent:this.getContentElFromTab(tabEl),manager:this,cancel:false};
this.fireEvent("beforeTabSwitch",eventData);if(eventData.cancel){return}delete eventData["cancel"];var showFn=(function(){this.lastActiveTab=tabEl;
this.lastActiveTab.addClass(this.options.activeClassname);var x=eventData.tabContent.addClass(this.options.activeClassname);
this.lastActiveTabContent=eventData.tabContent;var parentContainer=eventData.tabContent.closest(".tabViewDetailContent, .with-page-fragment").first();
if(parentContainer){if(parentContainer.data("page-fragment")){parentContainer.data("page-fragment").updateUi()
}else{parentContainer.find(".with-scroll-handler").each(function(){if($(this).data("scroll_handler")){$(this).data("scroll_handler").updateSize()
}})}}if(this.lastActiveTab&&this.lastActiveTab.data("tab-on-show")){this.lastActiveTab.data("tab-on-show")(eventData)
}if(this.lastActiveTabContent&&this.lastActiveTabContent.data("tab-on-show")){this.lastActiveTabContent.data("tab-on-show")(eventData)
}this.fireEvent("tabSwitch",eventData);if(this.lastActiveTabContent.data("load-url")&&!this.lastActiveTabContent.data("tab-loaded")){this._triggerTabAjaxLoad(this.lastActiveTab,this.lastActiveTabContent,eventData)
}if(this.options.effect=="slide"){x.slideDown("fast")}else{if(this.options.effect=="fade"){x.fadeIn("fast")
}else{x.show()}}x.trigger("dp_simpletabs_show")}).bind(this);if(this.lastActiveTab){this.lastActiveTab.removeClass(this.options.activeClassname);
var x=this.getContentElFromTab(this.lastActiveTab).removeClass(this.options.activeClassname);this.lastActiveTab=null;
if(this.lastActiveTab&&this.lastActiveTab.data("tab-on-hide")){this.lastActiveTab.data("tab-on-hide")(eventData)
}if(this.lastActiveTabContent&&this.lastActiveTabContent.data("tab-on-hide")){this.lastActiveTabContent.data("tab-on-hide")(eventData)
}if(this.options.effect=="slide"){x.slideUp("fast",showFn)}else{if(this.options.effect=="fade"){x.fadeOut("fast",showFn)
}else{x.hide();showFn()}}x.trigger("dp_simpletabs_hide")}else{showFn()}},_triggerTabAjaxLoad:function(tabEl,contentEl,eventData){var self=this;
contentEl.data("tab-loaded",true);delete eventData["cancel"];this.fireEvent("beforeTabLoad",eventData);
if(eventData.cancel){return}$.ajax({url:contentEl.data("load-url"),method:"get",dataType:"html",success:function(html){delete eventData["cancel"];
self.fireEvent("beforeTabLoaded",eventData);if(eventData.cancel){return}contentEl.html(html);eventData.tabContent=self.getContentElFromTab(tabEl);
self.fireEvent("tabLoaded",eventData)}})},getActiveTab:function(){return this.lastActiveTab},getActiveTabContent:function(){return this.getContentElFromTab(this.getActiveTab())
},getContentElFromTab:function(tabEl){if(!tabEl||!tabEl.data||!tabEl.data("tab-for")){DP.console.error("tab has no tab-for: %o",tabEl);
if(console&&console.trace){console.trace()}return $()}if(tabEl.data("tab-for")=="NOOP"){return $()}var el=$(tabEl.data("tab-for"),this.options.context);
if(el.length<1){DP.console.error("no tab content exists for tab: %o",tabEl);console.trace()}return el
},destroy:function(){}});Orb.createNamespace("DeskPRO.Agent.UI");DeskPRO.UI.DateChooser=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(options){this.options={rowEl:null};
if(options){this.setOptions(options)}this.rowEl=$(this.options.rowEl)},initValues:function(){var timestamp=null,date=null;
timestamp=this.date1Input.val();if(timestamp){date=new Date(timestamp*1000);this.date1Widget.datepicker("setDate",date)
}timestamp=this.date2Input.val();if(timestamp){date=new Date(timestamp*1000);this.date2Widget.datepicker("setDate",date)
}this.updateStatus()},_initUi:function(){if(this._hasInit){return}this._hasInit=true;this.opInput=$(".op",this.rowEl);
this.date1Input=$("input.date1-input",this.rowEl);this.date2Input=$("input.date2-input",this.rowEl);this.date1Display=$("input.date1-display",this.rowEl);
this.date2Display=$("input.date2-display",this.rowEl);this.currentValue=$(".display-value",this.rowEl);
this.dateWrap=$(".date-wrap",this.rowEl);this.backdrop=$('<div class="backdrop" style="display: none"></div>');
this.backdrop.appendTo("body");this.backdrop.on("click",this.hide.bind(this));this.wrapper=$('<div class="field-overlay" style="display:none"><div class="close-trigger"></div></div>');
$(".close-trigger",this.wrapper).on("click",this.hide.bind(this));this.dateWrap.detach().appendTo(this.wrapper).css("display","block");
this.wrapper.appendTo("body");this.date1=$(".date1",this.dateWrap);this.date2=$(".date2",this.dateWrap);
var self=this;this.date1Widget=$(".widget",this.date1).datepicker({dateFormat:"M d, yy",onSelect:function(dateText,inst){self.date1Input.val(self.date1Widget.datepicker("getDate").getTime()/1000);
self.date1Display.val(dateText);self.updateStatus()}});this.date2Widget=$(".widget",this.date2).datepicker({dateFormat:"M d, yy",onSelect:function(dateText,inst){self.date2Input.val(self.date2Widget.datepicker("getDate").getTime()/1000);
self.date2Display.val(dateText);self.updateStatus()}});var getDate=function(el){var timestamp=strtotime(el.val());
if(!timestamp){return null}var date=new Date(timestamp*1000);return date};this.date1Display.on("change",function(){var date=getDate($(this));
if(!date){$(this).val("");return}self.date1Widget.datepicker("setDate",date)});this.date2Display.on("change",function(){var date=getDate($(this));
if(!date){$(this).val("");return}self.date2Widget.datepicker("setDate",date)});$(".switcher",this.date1).on("click",(function(){var date=$(".date",this.date1);
var rel=$(".relative",this.date1);if(date.is(":visible")){date.hide();rel.show()}else{rel.hide();date.show()
}}).bind(this));$(".switcher",this.date2).on("click",(function(){var date=$(".date",this.date2);var rel=$(".relative",this.date2);
if(date.is(":visible")){date.hide();rel.show()}else{rel.hide();date.show()}}).bind(this))},open:function(){this._initUi();
if(this.opInput.val()=="between"){this.dateWrap.addClass("two")}else{this.dateWrap.removeClass("two")
}this.wrapper.css({left:this.currentValue.offset().left,top:this.currentValue.offset().top});this.backdrop.show();
this.wrapper.show()},updateStatus:function(){var str1="",str2="",status="";var relative1=$(".relative1",this.date1);
var relative2=$(".relative2",this.date2);if(relative1.is(":visible")){$(".date1-relative-input",this.rowEl).val($(".relative1-input",this.date1).val());
$(".date1-relative-type",this.rowEl).val($(".relative1-type",this.date1).val());this.date1Input.val("");
if($(".relative1-input",this.date1).val().trim().length){str1=$(".relative1-input",this.date1).val()+" "+$(".relative1-type",this.date1).val()+" ago"
}}else{var date1=this.date1Widget.datepicker("getDate");if(date1){str1=$.datepicker.formatDate("M d, yy",date1)
}}if(relative2.is(":visible")){$(".date2-relative-input",this.rowEl).val($(".relative2-input",this.date2).val());
$(".date2-relative-type",this.rowEl).val($(".relative2-type",this.date2).val());this.date2Input.val("");
if($(".relative2-input",this.date2).val().trim().length){str2=$(".relative2-input",this.date2).val()+" "+$(".relative2-type",this.date2).val()+" ago"
}}else{var date2=this.date2Widget.datepicker("getDate");if(date2){str2=$.datepicker.formatDate("M d, yy",date2)
}}if(!str1.length){str1="(click to set)"}if(!str2.length){str1="(click to set)"}if(this.opInput.val()=="between"){status=str1+" and "+str2
}else{status=str1}this.currentValue.text(status)},hide:function(){this.updateStatus();this.backdrop.hide();
this.wrapper.hide()},destroy:function(){this.wrapper.remove();this.backdrop.remove()}});Orb.createNamespace("DeskPRO.Agent.UI");
DeskPRO.UI.CatListEditor=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(options){this.options={listEl:null,itemSelector:"li",subListSelector:"> ul",titleSelector:".title-edit:first",dataId:"category-id",newItemTplSelector:null,editorBaseId:"",newCatRoute:""};
this.setOptions(options);var self=this;var list=$(this.options.listEl);this.list=list;var lis=$(this.options.itemSelector,this.list);
this._initLisCollection(lis);list.on("click",".sub-toggle",function(){$(this).parent().parent().toggleClass("sub-expanded")
});this.isEditMode=false;window.setTimeout(function(){self.pristineStructure=self.getStructure()},300)
},_initLisCollection:function(lis){var self=this;var list=this.list;lis.addClass("dp-cat-li").wrapInner('<div class="item-wrap dp-cat-item" />').prepend('<div class="dp-cat-dropzone between" />');
$(".dp-cat-item "+this.options.subListSelector,lis).each(function(){var li=$(this).parent().parent();
$(this).detach().appendTo(li)});$(".dp-cat-item, .dp-cat-dropzone",lis).droppable({accept:"li.dp-cat-li",tolerance:"pointer",drop:function(e,ui){var movedTree=false;
var li=$(this).parent();var child=!$(this).is(".dp-cat-dropzone");if(child&&li.children("ul").length==0){li.append("<ul/>")
}if(child){li.addClass("has-children").children("ul").append(ui.draggable)}else{li.before(ui.draggable)
}movedTree=true;$("li.dp-li-open").not(":has(li:not(.ui-draggable-dragging))").removeClass("sub-expanded");
li.find(".dp-cat-item, .dp-cat-dropzone").removeClass("dp-cat-over");$("li.has-children",list).each(function(){var p=$(this);
if(!$("> ul > li:not(.ui-draggable-dragging):first",p).length){p.removeClass("has-children")}});if(movedTree){self.fireEvent("restructured",[ui.draggable,this])
}else{self.fireEvent("reordered",[ui.draggable,this])}},over:function(){$(this).addClass("dp-cat-over");
if($(this).is(".dp-cat-dropzone")){$(".dp-cat-item:first",$(this).parent()).removeClass("dp-cat-over")
}},out:function(){$(this).filter(".dp-cat-item, .dp-cat-dropzone").removeClass("dp-cat-over")}});lis.draggable({handle:"> .dp-cat-item",opacity:0.5,addClasses:false,helper:"clone",zIndex:100});
if(!this.editMode){lis.draggable("disable")}},enableEditMode:function(){this.editMode=true;this.list.find("li.dp-cat-li").draggable("enable")
},disableEditMode:function(){this.editMode=false;this.list.find("li.dp-cat-li").draggable("disable")},getOrder:function(){var itemDataId=this.options.dataId;
var orders=[];$("li.dp-cat-li",this.list).each(function(){var id=$(this).data(itemDataId);if(id){orders.push(id)
}});return orders},getStructure:function(list){list=list||this.list;var map={};var lis=list.find("li.dp-cat-li");
lis.each(function(){var id=$(this).data("category-id");var parentId=0;var ul=$(this).parent();if(ul.parent().is("li")){parentId=ul.parent().data("category-id")
}map[id]=parentId});return map},isTitleEditing:function(){return this.list.is(".title-editing")},showEditTitles:function(){if(this.isTitleEditing()){return
}this.list.addClass("title-editing");var self=this;$(".dp-cat-item",this.list).each(function(){self._enableEditable($(this))
});this.fireEvent("titlesActivated",[this])},endEditTitles:function(){if(!this.isTitleEditing()){return
}var self=this;var titles={};$("input.dp-cat-input",this.list).each(function(){var item=$(this).parent();
var dataId=item.parent().data(self.options.dataId);var newTitle=self._disableEditable(item);if(dataId){titles[dataId]=newTitle
}});this.list.removeClass("title-editing");this.fireEvent("titlesUpdated",[titles,this])},_enableEditable:function(item){var titleEl=$(this.options.titleSelector,item);
var title=titleEl.text().trim();var inputEl=$('<input type="text" class="dp-cat-input" />');inputEl.val(title);
titleEl.hide();inputEl.insertAfter(titleEl)},_disableEditable:function(item){var titleEl=$(this.options.titleSelector,item);
var input=$("input.dp-cat-input",item).first();var newTitle=input.val().trim();input.remove();titleEl.text(newTitle).show();
return newTitle},addNew:function(li){var self=this;var tpl=$(this.options.newItemTplSelector).get(0).innerHTML;
var li=$(tpl);var firstLi=$("li.dp-cat-li:first",this.list);if(firstLi.length){li.insertBefore(firstLi)
}else{li.appendTo(this.list)}this._initLisCollection(li);this._enableEditable($(".dp-cat-item",li));this.fireEvent("newAddEditable",[li,input,this]);
var input=$("input.dp-cat-input",li);var fnDone=function(){self.fireEvent("newAdded",[li,input,self]);
self._disableEditable($(".dp-cat-item",li))};input.on("blur",fnDone).on("keypress",function(ev){if(ev.which==13){fnDone()
}});var input=$("input:first",li);input.focus().select()},showEditor:function(li){this._initEditor();
var elPos=li.offset();var elWidth=li.width()-10;var title=$(".title-edit:first",li).text().trim();$("input.title",this.editTab).val(title);
elPos.top-=5;this.editTab.css({left:elPos.left,top:elPos.top,width:elWidth});this.editTabBk.css({left:elPos.left+elWidth-4,top:elPos.top+1});
this.edit.css({left:elPos.left+elWidth,top:elPos.top-10});var ids=((li.data("usergroup-ids")+"")||"").split(",");
if(ids.indexOf("1")!==-1){$(":checkbox.usergroup",this.edit).prop("checked",true)}else{$(":checkbox.usergroup",this.edit).prop("checked",false);
Array.each(ids,function(id){$("input.usergroup-"+id,this.edit).prop("checked",true)},this)}this.editBack.show();
this.editTab.show();this.edit.show();this.editTabBk.show();this.edit.data("editing-li",li)},closeOpenEditor:function(){var li=this.edit.data("editing-li");
if(li){var newTitle=$("input.title",this.editTab).val().trim();var titleEl=$(".title-edit:first",li);
var oldTitle=titleEl.text().trim();var dataId=li.data(this.options.dataId);var updatedTitle=false;var updatedUgs=false;
if(newTitle!=oldTitle){updatedTitle=true;titleEl.text(newTitle);var titles={};titles[dataId]=newTitle;
this.fireEvent("titlesUpdated",[titles,this])}var ug_ids=[];$("input.usergroup:checked",this.edit).each(function(){ug_ids.push($(this).val())
});var ug_ids_string=ug_ids.join(",");if(li.data("usergroup-ids")!=ug_ids_string){updatedUgs=true;li.data("usergroup-ids",ug_ids_string)
}if(updatedTitle||updatedUgs){this.fireEvent("catUpdated",[li.data("category-id"),newTitle,ug_ids,li,this])
}}this.editBack.hide();this.editTab.hide();this.edit.hide().data("editing-li",0);this.editTabBk.hide()
},_initEditor:function(){if(this._editorHasInit){return}this._editorHasInit=true;this.editBack=$("#"+this.options.editorBaseId+"cat_editor_backdrop").detach().appendTo("body");
this.editTab=$("#"+this.options.editorBaseId+"cat_editor_tab").detach().appendTo("body");this.edit=$("#"+this.options.editorBaseId+"cat_editor").detach().appendTo("body");
this.editTabBk=$("#"+this.options.editorBaseId+"cat_editor_shadowbreak").detach().appendTo("body");$(".close-trigger",this.edit).on("click",this.closeOpenEditor.bind(this));
this.edit.on("click",function(ev){ev.stopPropagation()});this.editTab.on("click",function(ev){ev.stopPropagation()
});this.editBack.on("click",this.closeOpenEditor.bind(this))},destroy:function(){if(this.editBack){this.editBack.remove();
this.editTab.remove();this.edit.remove();this.editTabBk.remove();this.editBack=this.editTab=this.edit=this.editTabBk=null
}}});Orb.createNamespace("DeskPRO.UI.Select");DeskPRO.UI.Select.Widget=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function($select,options){var self=this;
this.$select=$select;this.$el=null;this.selections=[];this.isMulti=this.$select.is("[multiple]");this.menu=null;
this.options={autoRender:true,menu:null};this.setOptions(options);if(this.options.autoRender){this.renderWidget()
}self.selections=[];this.$select.find("option").each(function(){var opt=$(this);var uid=Orb.uuid();opt.data("dp-uid",uid);
opt.addClass(uid);if(opt.is(":selected")){self.selections.push(uid)}});this._doInitialize()},_doGetmenu:function(){},_doRenderWidget:function(){},_doInitialize:function(){},_doInitWidget:function(){},_doChanged:function(){},_doMenuInit:function(){},_doDestroy:function(){},renderWidget:function(){if(this.$el){return
}var self=this;this.$el=this._doRenderWidget();var evData={select:this.$select,el:this.$el,pageWidget:this};
this.fireEvent("renderWidget",[evData]);if(this.$el.get(0).parentNode){this.$select.after(this.$el)}this.$select.hide();
this.$el.find(".trigger-open-menu").each(function(){$(this).on("click",function(ev){Orb.cancelEvent(ev);
self.getMenu().open(ev)})});if(this.$el.hasClass("trigger-open-menu")){this.$el.on("click",function(ev){Orb.cancelEvent(ev);
self.getMenu().open(ev)})}self.selections=[];this.$select.find("option").each(function(){var opt=$(this);
var uid=Orb.uuid();opt.data("dp-uid",uid);opt.addClass(uid);if(opt.is(":selected")){self.selections.push(uid)
}});this._doInitWidget();this.fireEvent("initWidget",[evData])},getMenu:function(){if(this.menu){return this.menu
}if(this.options.menu){if(typeOf(this.options.menu)=="function"){this.menu=this.options.menu()}}if(!this.menu){this.menu=this._doGetmenu()
}this._doMenuInit();return this.menu},getSelect:function(){return this.$select},getEl:function(){this.renderWidget();
return this.$el},getSelectedOptions:function(){if(!this.selections.length){return $([])}var selectedOpts=[];
var options=this.$select.find("option");Array.each(this.selections,function(uid){var opt=options.filter("."+uid);
if(opt[0]){selectedOpts.push(opt.get(0))}});return $(selectedOpts)},getValue:function(){var selected=this.getSelectedOptions();
if(!selected[0]){return null}return selected.first().val()},getValuesArray:function(){var values=[];this.getSelectedOptions().each(function(){values.push($(this).val())
});return values},getSelectedUids:function(){var values=[];this.getSelectedOptions().each(function(){values.push($(this).data("dp-uid"))
});return values},getSelectedUidsString:function(){var ids=this.getSelectedUids().sort().join(",");return ids
},countSelectedOptions:function(){return this.selections.length},setSelectedOptions:function(opts,add){var idsBefore=this.getSelectedUidsString();
var self=this;this.selections=[];if(!add){this.$select.find("option").prop("selected",false)}opts.each(function(){$(this).prop("selected",true);
self.selections.push($(this).data("dp-uid"))});var idsAfter=this.getSelectedUidsString();if(idsBefore!=idsAfter){this._doChanged();
this.$select.trigger("change");this.fireEvent("changed")}},syncFromSelect:function(){var selected=this.$select.find("option").filter(":selected");
this.setSelectedOptions(selected)},setSelectedValues:function(values,add){var idsBefore=this.getSelectedUidsString();
var self=this;this.selections=[];var opts=this.$select.find("option");if(!add){opts.prop("selected",false)
}opts.each(function(){var optVal=$(this).val();var selected=false;if(typeOf(values)=="array"){Array.each(values,function(val){if(optVal==val){selected=true;
return false}})}else{if(optVal==values){selected=true}}if(selected){$(this).prop("selected",true);self.selections.push($(this).data("dp-uid"))
}});var idsAfter=this.getSelectedUidsString();if(idsBefore!=idsAfter){this._doChanged();this.$select.trigger("change");
this.fireEvent("changed")}},setSelectedUids:function(values,add){var idsBefore=this.getSelectedUidsString();
var self=this;this.selections=[];var opts=this.$select.find("option");if(!add){opts.prop("selected",false)
}Array.each(values,function(uid){opts.filter("."+uid).prop("selected",true);self.selections.push(uid)
});var idsAfter=this.getSelectedUidsString();if(idsBefore!=idsAfter){this._doChanged();this.$select.trigger("change");
this.fireEvent("changed")}},unselectOption:function(opt){opt=$(opt);opt.prop("selected",false);var uid=opt.data("dp-uid");
var uidPos=this.selections.indexOf(uid);if(uidPos!==-1){this.selections=this.selections.splice(uidPos,1);
this._doChanged();this.$select.trigger("change");this.fireEvent("changed")}},unselectValue:function(value){var didChange=false;
var self=this;this.getSelectedOptions().each(function(){var opt=$(opt);if(opt.val()==value){opt.prop("selected",false);
var uid=opt.data("dp-uid");var uidPos=self.selections.indexOf(uid);if(uidPos!==-1){self.selections=self.selections.splice(uidPos,1);
didChange=true}}});if(didChange){this._doChanged();this.$select.trigger("change");this.fireEvent("changed")
}},unselectUid:function(uid){var uidPos=this.selections.indexOf(uid);if(uidPos!==-1){this.selections=this.selections.splice(uidPos,1);
this.$select.find("."+uid).prop("selected",false);this._doChanged();this.$select.trigger("change");this.fireEvent("changed")
}},isUidSelected:function(uid){return this.selections.indexOf(uid)!==-1},isValueSelected:function(value){var is=false;
this.getSelectedOptions().each(function(){if($(this).val()==value){is=true;return false}});return is},destroy:function(){if(this.menu){this.menu.destroy()
}this._doDestroy()}});Orb.createNamespace("DeskPRO.UI.Select");DeskPRO.UI.Select.Menu=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(widget,options){this.widget=widget;
this.hasInit=false;this._isOpen=false;this.setOptions(options);this._doInitialize()},getWidget:function(){return this.widget
},_doInitialize:function(){},_doInitMenu:function(){},_doOpenMenu:function(){},_doCloseMenu:function(){},_doDestroy:function(){},initMenu:function(){if(this.hasInit){return
}this.hasInit=true;this._doInitMenu()},isOpen:function(){return this._isOpen},open:function(){if(this._isOpen){return
}this._isOpen=true;this.initMenu();this._doOpenMenu();this.fireEvent("opened")},close:function(){if(!this._isOpen){return
}this._isOpen=false;this._doCloseMenu();this.fireEvent("closed")},destroy:function(){this._doDestroy()
}});Orb.createNamespace("DeskPRO.UI.Select");DeskPRO.UI.Select.WidgetSimple=new Orb.Class({Extends:DeskPRO.UI.Select.Widget,_doRenderWidget:function(){var el=$('<div class="dp-ui-select-widget trigger-open-menu"><i class="icon-caret-down"></i><div class="val-list"></div></div>');
return el},_doInitWidget:function(){this.renderSelectedOptions()},_doChanged:function(){this.renderSelectedOptions()
},_doGetmenu:function(){if(this.$select.data("target-menu")){var menu=new DeskPRO.UI.Select.MenuHtml(this);
return menu}},renderSelectedOptions:function(){var opts=this.getSelectedOptions();var valList=this.getEl().find(".val-list");
valList.empty();if(!opts[0]){return}var lastIdx=opts.length-1;opts.each(function(idx){var span=$('<span class="val"></span>');
var title=$.trim($(this).text());if(title){span.text(title)}else{span.html("&nbsp;")}span.appendTo(valList);
if(idx!=lastIdx){span=$('<span class="sep">,</span>');span.appendTo(valList)}})}});Orb.createNamespace("DeskPRO.UI.Select");
DeskPRO.UI.Select.MenuHtml=new Orb.Class({Extends:DeskPRO.UI.Select.Menu,_doInitMenu:function(){var self=this;
var select=this.getWidget().getSelect();var isMulti=select.is("[multiple]");var zindex=select.data("zindex");
var closeOnSelect=select.data("select-close");if(select.data("target-menu")=="auto"){var name=Orb.uuid();
var inputType=isMulti?"checkbox":"radio";this.$menu=$('<div class="source-pane-select-menu"></div>');
this.$menu.append('<i class="icon-caret-up"></i>');if(select.find("optgroup")[0]){select.find("optgroup").each(function(){var group=$('<div class="group"></div>');
var groupTitle=$("<strong></strong>");groupTitle.text($.trim($(this).attr("label")));groupTitle.appendTo(group);
var checkList=$('<ul class="checkbox-list"></ul>');$(this).find("option").each(function(){var li=$('<li><label><input type="'+inputType+'" class="widget-val" /> <span></span></label></li>');
li.find("input").val($(this).val()).attr("name",name);li.find("span").text($.trim($(this).data("title")||$(this).text()));
li.appendTo(checkList)});checkList.appendTo(group);group.appendTo(self.$menu)})}else{var checkList=$('<ul class="checkbox-list"></ul>');
select.find("option").each(function(){var li=$('<li><label><input type="'+inputType+'" class="widget-val" /> <span></span></label></li>');
li.find("input").val($(this).val()).attr("name",name);li.find("span").text($.trim($(this).data("title")||$(this).text()));
li.appendTo(checkList)});checkList.appendTo(this.$menu)}}else{this.$menu=$(select.data("target-menu"))
}if(select.data("menu-addclass")){this.$menu.addClass(select.data("menu-addclass"))}this.$menu.find("trigger-close-menu").on("click",function(ev){Orb.cancelEvent(ev);
self.close()});this.$menu.detach().appendTo("body");this.$positionOver=this.getWidget().getEl();this.$shim=$('<div class="dp-shim zindex-chrome4"></div>');
if(zindex){this.$shim.css("z-index",zindex);this.$menu.css("z-index",zindex+1)}this.$shim.appendTo("body");
this.$shim.on("click",function(ev){Orb.cancelEvent(ev);self.close()});this.$menu.find(".widget-val").each(function(){var el=$(this);
if(el.is(":checkbox, :radio")){if(self.getWidget().isValueSelected(el.val())){el.prop("checked",true);
if(closeOnSelect){el.on("click",function(){self.close()})}}}else{if(el.is("select")){el.find("option").each(function(){if(self.getWidget().isValueSelected($(this).val())){$(this).prop("selected",true)
}})}}})},_doOpenMenu:function(){var pos=this.$positionOver.offset();var w=this.$positionOver.width();
this.$menu.css({top:pos.top,left:pos.left,"min-width":w});this.$menu.show();this.$shim.show()},_doCloseMenu:function(){this.$menu.hide();
this.$shim.hide();this.getWidget().setSelectedValues(this.getSelectedValues())},_doDestroy:function(){if(this.$menu){this.$menu.detach();
this.$shim.detach()}},getSelectedValues:function(){var optionEls=this.$menu.find(".widget-val");var values=[];
optionEls.each(function(){var el=$(this);if(el.is(":checkbox, :radio")){if(el.is(":checked")){values.push(el.val())
}}else{if(el.is("select")){var opts=el.find("option").find(":selected");opts.each(function(){values.push($(this).val())
})}}});return values}});Orb.createNamespace("DeskPRO.Form");DeskPRO.Form.InlineEdit=new Class({Implements:Options,options:{baseElement:window.document,editableClass:"editable",triggers:null,ajax:{timeout:20000,type:"POST",url:""},saveFinishCallback:function(){}},activeEdits:[],sendingEdits:{},documentClickSubmitOn:false,initialize:function(options){this.setOptions(options);
this.options.baseElement=$(this.options.baseElement);var sel="."+this.options["editableClass"];var self=this;
$(sel,this.options["baseElement"]).each(function(){self.initEditable(this)});this.options.baseElement.on("click",function(ev){self.handleDocumentClick(ev)
});$(document).on("keydown",function(ev){if(ev.keyCode==27){self.closeEditables()}})},initEditable:function(el){var self=this;
var j_el=$(el);if(j_el.is(".parent-trigger")){var parent=j_el.parent();var evname=parent.hasClass("single-click-activate")?"clcik":"dblclick";
parent.on(evname,function(){self.startEditable(j_el)})}else{var evname=j_el.hasClass("single-click-activate")?"clcik":"dblclick";
j_el.on(evname,function(){self.startEditable(this)})}if(this.options.triggers){$(this.options.triggers,j_el.parent()).on("click",function(ev){ev.stopPropagation();
self.startEditable(j_el)})}},handleDocumentClick:function(event){if(!this.documentClickSubmitOn){return
}if($(event.target).parents().is(".editable")){return}this.submitOpen();this.documentClickSubmitOn=false
},startEditable:function(editable){editable=$(editable);var rendered_els=$("div.rendered-value",editable);
if(!rendered_els.size()){editable.wrapInner('<div class="rendered-value" />');rendered_els=$("div.rendered-value",editable)
}var form_elements=$($(editable).data("editable-for"),this.options.baseElement);var form_elements_container=form_elements.parent();
rendered_els.fadeOut("fast",function(){rendered_els.detach();form_elements.addClass("editable-fields-on").hide().appendTo(editable).fadeIn("fast",function(){form_elements.find("input, textarea, select").first().focus()
});$("input, textarea, select",form_elements).addClass("unchanged").on("change",function(){$(this).removeClass("unchanged")
}).on("keypress",function(){$(this).removeClass("unchanged")}).filter(":visible").first().focus()});var editinfo={"editable":editable,"rendered_els":rendered_els,"form_elements":form_elements,"form_elements_container":form_elements_container};
editable.addClass("editing").parent().addClass("editing");this.documentClickSubmitOn=true;this.activeEdits.push(editinfo)
},submitOpen:function(){if(!this.activeEdits.length){return}var data=$(".editable-fields-on :input, .editable-ajax-data :input",this.options["baseElement"]).serializeArray();
var is_multi=this.activeEdits.length;var sending_edits=[];var editinfo=null;while(editinfo=this.activeEdits.pop()){this.setEditinfoLoading(editinfo);
sending_edits.push(editinfo)}var ajax_id=Orb.uuid();this.sendingEdits[ajax_id]=sending_edits;if(data.length){var self=this;
var ajax_options=Object.merge({success:function(data,textStatus,XMLHttpRequest){DP.console.log("ajax-save data: %o",data);
self.handleAjaxSuccess(ajax_id,data)},error:function(XMLHttpRequest,textStatus,errorThrown){DP.console.log("ajax-save error: %s",textStatus);
self.handleAjaxFailure(ajax_id)},context:this,dataType:"json",data:data},this.options["ajax"]);DP.console.log("ajax-save: %s",ajax_options.url);
DP.console.log("ajax-save data: %o",ajax_options.data);$.ajax(ajax_options)}else{this.handleAjaxSuccess(ajax_id,{})
}},handleAjaxSuccess:function(ajax_id,data){var all_sending_edits=this.sendingEdits[ajax_id];delete this.sendingEdits[ajax_id];
var sending_edit=null;var editinfo=null;while(editinfo=all_sending_edits.pop()){var field_data=this._findDataFromEditinfo(editinfo,data);
var html=null;if(field_data){if(field_data.errors){continue}else{if(field_data.html){html=field_data.html
}}}if(!html){var value_arr=$('input[type="text"], textarea, select',editinfo.form_elements).serializeArray();
var value_bits=[];value_arr.each(function(v){value_bits.push(v.value)});html=value_bits.join(", ")}editinfo.rendered_els.remove();
editinfo.rendered_els=$('<div class="rendered-value" />').html(html);this.closeEditinfo(editinfo)}this.options.saveFinishCallback(data)
},_findDataFromEditinfo:function(editinfo,data){var id=$(":input",editinfo.form_elements).eq(0).attr("id");
if(!id){return data}var id_parts=id.split("_");do{var check_part=id_parts.join("_");if(data[check_part]!=undefined){return data[check_part]
}}while(id_parts.pop());return data},handleAjaxFailure:function(ajax_id){},setEditinfoLoading:function(editinfo,is_multi){},closeEditables:function(){var editinfo=null;
while(editinfo=this.activeEdits.pop()){this.closeEditinfo(editinfo)}},closeEditinfo:function(editinfo){var editable=editinfo.editable;
var rendered_els=editinfo.rendered_els;var form_elements=editinfo.form_elements;var form_elements_container=editinfo.form_elements_container;
form_elements.fadeOut("fast",function(){form_elements.removeClass("editable-fields-on").appendTo(form_elements_container);
if(rendered_els.parent().get(0)!=editable.get(0)){rendered_els.hide().appendTo(editable).fadeIn("fast");
editable.removeClass("editing").parent().removeClass("editing")}})}});Orb.createNamespace("DeskPRO.Form");
DeskPRO.Form.RuleBuilder=new Orb.Class({Implements:[Orb.Util.Events],initialize:function(ruleTpl){this.ruleTpl=null;
this.typeSelectHtml=null;this.types={};this.rowDestroy={};this.enableTypes={};this.ruleTpl=ruleTpl;var self=this;
this.genTypeSel()},enableType:function(type){this.enableTypes[type]=true;this.genTypeSel()},disableType:function(type){this.enableTypes[type]=false;
this.genTypeSel()},genTypeSel:function(){var groups={};var self=this;if(this.typeSel){this.typeSel.remove();
this.typeSel=null}if(document.getElementById("dp_admin_page")){var html=['<select name="type" style="max-width: 400px;"><option>&nbsp;</option>']
}else{var html=['<select name="type" style="max-width: 320px;"><option>&nbsp;</option>']}$(".builder-type",this.ruleTpl).each(function(i,el){var type=$(el).data("rule-type");
if($(el).data("type-off")&&!self.enableTypes[type]){return}var title=$(el).attr("title");var subgroup=$(el).data("rule-group");
self.types[type]=title;if(subgroup){var id=Orb.uuid();if(!groups[subgroup]){groups[subgroup]={"id":id,types:[]};
html.push('<optgroup label="'+subgroup+'" class="'+id+'"></optgroup>')}groups[subgroup]["types"].push([type,title])
}else{html.push('<option value="'+type+'">'+title+"</option>")}});html.push("</select>");html=html.join("");
var typeSel=$(html);Object.each(groups,function(info,group){var ul=$("optgroup."+info.id,typeSel);var lis=[];
Array.each(info.types,function(type){lis.push('<option value="'+type[0]+'">'+type[1]+"</option>")});var lis=$(lis.join(""));
ul.append(lis)});this.typeSel=typeSel;this.typeSel.css({position:"absolute",bottom:0,left:0,visibility:"hidden"});
this.typeSel.appendTo("body");this.typeSel.css("width",this.typeSel.width()+35);this.typeSel.hide()},destroy:function(){Object.each(this.rowDestroy,function(rowDestroy){Array.each(rowDesotry,function(item){if(item.destroy){item.destroy()
}else{if(item.remove){item.remove()}}})});this.typeSel.remove()},addNewRow:function(addToEl,formBaseName,existing){var isStatic=addToEl.is(".static-list");
if(existing&&!this.types[existing.type]){return null}var rowId=Orb.uuid();var new_row=$(".row",this.ruleTpl).children().clone();
new_row.data("row-id",rowId);if(isStatic){new_row.addClass("static-list")}var select=this.typeSel.clone();
select.css({position:"static",left:"",bottom:""});$(".builder-type-choice",new_row).append(select);var self=this;
$(".builder-remove",new_row).on("click",function(){self.removeRow(new_row)});if(formBaseName){new_row.data("form-base-name",formBaseName);
this.updateFormName(new_row,formBaseName)}select.on("change",(function(){this.handleSelectChange(new_row)
}).bind(this));$(addToEl).append(new_row);if(!isStatic){DP.select(select)}else{var lbl=$("<span />");
lbl.text(select.find("option:selected").text());select.hide().after(lbl)}var opt=false;if(existing&&this.types[existing.type]){select.val(existing.type).change();
var label=$(".builder-type .current-value",new_row);label.text(this.types[existing.type]);this.handleSelectChange(new_row);
$(".builder-op select",new_row).val(existing.op).addClass("op").change();if(typeof existing.options=="string"||typeof existing.options=="number"||typeOf(existing.options)!="object"){var els=$(":input, textarea, select",new_row).filter(":not(.op, .type)").first().val(existing.options)
}else{Object.each(existing.options,function(val,name){if(!name||!name.length){return}var name_safe=name.replace(/\[/,"\\[").replace(/\]/,"\\]");
if(typeof val=="string"||typeof val=="number"){var el=$('[name="'+name_safe+'"], [name$="'+this.makeArrayName(name,true)+'"]',new_row).first().val(val).change();
if(el.is("select")){el.find("option").each(function(){if(this.value==val){$(this).prop("selected",true)
}})}}else{if(typeOf(val)=="object"){Object.each(val,function(subval,subname){var sub_name=name_safe+"["+subname+"]";
var sub_name_safe=name_safe+"\\["+subname+"\\]";if(typeOf(subval)=="object"){Object.each(subval,function(v,k){var k_name=sub_name+"["+k+"]";
var el=$('[name$="'+this.makeArrayName(k_name,true)+'"]',new_row).first();if(el.is(":checkbox")){el.prop("checked",true).change()
}else{el.val(v).change()}},this)}else{if(typeOf(subval)=="array"){Array.each(subval,function(v){var k_name=sub_name+"[]";
var el=$('[name$="'+this.makeArrayName(k_name,true)+'"]',new_row);if(el.is("select")){el.find('[value="'+v+'"]').prop("selected",true)
}},this)}else{var el=$('[name="'+sub_name_safe+'"], [name$="'+this.makeArrayName(sub_name,true)+'"]',new_row).first().val(subval).change()
}}},this)}else{if(typeOf(val)=="array"){if(name=="labels"){var texts=[];var labelval=$(".builder-options select.label-values",new_row);
Array.each(val,function(subval){texts.push(subval)});$(".builder-options .menu-trigger",new_row).text(texts.join(", ")).data("select-texts",texts)
}Array.each(val,function(subval){var el=$('option[value="'+subval+'"]',new_row).first().get(0);if(el){el.selected=true
}},this)}else{var el=$('[name="'+name_safe+'"], [name$="'+this.makeArrayName(name,true)+'"]',new_row).first().val(val).change()
}}}},this)}var ruleHandler=new_row.data("rule-handler-inst");if(ruleHandler){ruleHandler.initValues()
}}else{existing=null}this.fireEvent("newRow",[new_row,addToEl,existing]);return new_row},handleSelectChange:function(row){this.destroyRow(row);
var isStatic=row.is(".static-list");var rowId=row.data("row-id");var rowDestroy=[];var type=$(".builder-type-choice select",row).val();
var rule_tpl=$('.builder-type[data-rule-type="'+type+'"]',this.ruleTpl);var op=$("div.builder-op",rule_tpl).children().clone();
var rule_options_tpl=$(".builder-options",rule_tpl);var choice=rule_options_tpl.clone();if(!rule_options_tpl.hasClass("newline")){choice.css("display","inline")
}$(".builder-op",row).empty().append(op);$(".builder-op",row).find("select").addClass("op");$(".builder-options",row).empty().append(choice);
row.find("select.op").css("visibility","hidden");if(!isStatic){DP.select(row.find("select.op"))}else{var lbl=$("<span />");
lbl.text(row.find("select.op").find("option:selected").text());row.find("select.op").hide().after(lbl)
}var ruleHandlerName=rule_tpl.data("rule-handler");var ruleHandler=null;if(ruleHandlerName){ruleHandlerObj=Orb.getNamespacedObject(ruleHandlerName);
ruleHandler=new ruleHandlerObj({ruleBuilder:this,rowEl:row,rowId:rowId,opMenu:row.find("select.op")});
rowDestroy.push(ruleHandler)}var numChilds=choice.children().length;if(numChilds==1){var choiceSel=row.find(".builder-options").find("select").not(".no-auto");
if(choiceSel.length){choiceSel.css("visibility","hidden");choiceSel.each(function(){if(!isStatic){var sel=$(this);
sel.css("visibility","hidden");window.setTimeout(function(){if(sel.attr("multiple")){var cellWidth=sel.closest("td").find("> .builder-options").width();
sel.width(cellWidth-10)}DP.select(sel)},150)}else{var lbl=$("<span />");lbl.text($(this).find("option:selected").text());
$(this).hide().after(lbl)}})}}DP.select(row.find(".select2"));if(row.data("form-base-name")){this.updateFormName($(".builder-op",row),row.data("form-base-name"));
this.updateFormName($(".builder-options",row),row.data("form-base-name"))}if(ruleHandler){ruleHandler.initRow();
row.data("rule-handler-inst",ruleHandler)}if(rowDestroy.length){this.rowDestroy[rowId]=rowDestroy}var opSel=$(".builder-op select",row);
var updateOp=function(){var val=opSel.val();if(val=="changed"){$(".builder-options",row).hide()}else{$(".builder-options",row).show()
}};opSel.on("change",updateOp);this.fireEvent("selectChange",[row,type])},destroyRow:function(row){var rowId=row.data("row-id");
if(this.rowDestroy[rowId]){Array.each(this.rowDestroy[rowId],function(item){if(item.destroy){item.destroy()
}else{if(item.remove){item.remove()}}});delete this.rowDestroy[rowId]}},removeRow:function(row){this.destroyRow(row);
row.remove()},updateFormName:function(el,formBaseName){$("[name]",el).each(function(){var name=$(this).attr("name");
name=name.replace(/^([\w\d]*)/,"[$1]");name=formBaseName+name;$(this).attr("name",name)})},makeArrayName:function(name,safe){if(name.indexOf("[")===-1){name="["+name+"]"
}else{name=name.replace(/^([\w\d]+)\[(.*?)$/,"[$1][$2")}if(safe){name=name.replace(/\[/g,"\\[").replace(/\]/g,"\\]")
}return name}});Orb.createNamespace("DeskPRO");DeskPRO.FaviconBadge=new Orb.Class({Implements:[Orb.Util.Options],initialize:function(options){var self=this;
this.options={};this.origWindowTitle=document.title;this.options.strokeColor="rgb(255,0,0)";this.options.color="#FFFFFF";
this.options.strokeColorAlt="rgb(0,0,0)";this.options.colorAlt="#FFFFFF";$(document).bind("windowshow",this.disableCrazyMode.bind(this));
$(window).bind("mousemove",this.disableCrazyMode.bind(this));$(window).bind("keypress",this.disableCrazyMode.bind(this));
this.setOptions(options);this.tinyconOptions={font:"10px arial",fallback:false};this.animateTimeout=null;
this.animateCount=0;this.crazyMode=false;this.crazyTitle=null;this.lastNum=0},clearAnimate:function(){if(this.animateTimeout){window.clearTimeout(this.animateTimeout);
this.animateTimeout=null;this.animateTimeoutCount=0}$(document).unbind("windowshow.faviconbadge");$(window).unbind("mousemove.faviconbadge");
$(window).unbind("keypress.faviconbadge")},enableCrazyMode:function(title){if($("html").hasClass("window-active")){return
}this.crazyTitle=title||null;this.crazyMode=true;this.updateBadge(this.lastNum,true)},disableCrazyMode:function(){if(!this.crazyMode){return
}this.crazyMode=false;this.crazyTitle=null;document.title=this.origWindowTitle;this.updateBadge(this.lastNum,false)
},updateBadge:function(num,do_animate){var self=this;this.clearAnimate();var num=parseInt(num);if(num>99){num=99
}this.lastNum=num;if(!num&&!this.crazyMode){Tinycon.setBubble("");return}if(do_animate){this.animateTimeout=window.setInterval(function(){self.animateCount++;
if(self.crazyMode){self.tinyconOptions.width=7;self.tinyconOptions.height=8;if(self.animateCount%2==0){self.tinyconOptions.colour="#000000";
self.tinyconOptions.background="#FFFFFF";Tinycon.setOptions(self.tinyconOptions);Tinycon.setBubble("â");
if(self.crazyTitle){document.title=self.origWindowTitle}}else{self.tinyconOptions.colour="#FF0000";self.tinyconOptions.background="#FFFFFF";
Tinycon.setOptions(self.tinyconOptions);Tinycon.setBubble("â");if(self.crazyTitle){document.title=self.crazyTitle
}}}else{self.tinyconOptions.width=7;self.tinyconOptions.height=9;if(self.animateCount%2==0){self.tinyconOptions.colour=self.options.color;
self.tinyconOptions.background=self.options.strokeColor;Tinycon.setOptions(self.tinyconOptions);Tinycon.setBubble(num+"")
}else{self.tinyconOptions.colour=self.options.colorAlt;self.tinyconOptions.background=self.options.strokeColorAlt;
Tinycon.setOptions(self.tinyconOptions);Tinycon.setBubble(num+"")}}},800)}else{self.tinyconOptions.width=7;
self.tinyconOptions.height=9;self.tinyconOptions.colour=self.options.color;self.tinyconOptions.background=self.options.strokeColor;
Tinycon.setOptions(self.tinyconOptions);Tinycon.setBubble(num+"")}}});Orb.createNamespace("DeskPRO.Agent");
DeskPRO.Agent.InterfaceEffects=new Orb.Class({Implements:[Orb.Util.Events],initialize:function(){},initPage:function(){}});
Orb.createNamespace("DeskPRO.Agent.Widget");DeskPRO.Agent.Widget.FindPerson=new Orb.Class({Implements:[Orb.Util.Options,Orb.Util.Events],initialize:function(options){this.options={};
this.setOptions(options)},_initOverlay:function(){if(this.overlay){return this.overlay}this.overlay=new DeskPRO.UI.Overlay({contentMethod:"ajax",contentAjax:{url:BASE_URL+"agent/people-search/quick-find"}});
this.overlay.addEvent("ajaxDone",this._initElements,this);var event={findPerson:this,overlay:this.overlay};
this.fireEvent("initOverlay",[event])},_initElements:function(){this.wrapper=this.overlay.getWrapper();
this.headerNav=$("header > nav",this.wrapper);this.simpleBtn=$(".simple",this.headerNav).on("click",this.switchSimple.bind(this));
this.advancedBtn=$(".advanced",this.headerNav).on("click",this.switchAdvanced.bind(this));this.results=$("section.deskpro-results-list",this.wrapper);
this.loading=$("section.results-loading",this.wrapper);this.info=$("section.no-results-info",this.wrapper);
this.searchArea=$("section.search-area:first",this.wrapper);this.simpleForm=$("form.simple:first",this.searchArea);
this.advancedForm=$("form.advanced:first",this.searchArea);var self=this;this.simpleForm.on("submit",function(ev){ev.preventDefault();
self.submitSearch($(this))});this.advancedForm.on("submit",function(ev){ev.preventDefault();self.submitSearch($(this))
})},_initRuleBuilder:function(){if(this.ruleBuilder){return}var criteriaList=$(".search-form",this.advancedForm);
var criteriaTerms=$(".search-builder-tpl",this.wrapper);var editor=new DeskPRO.Form.RuleBuilder(criteriaTerms);
$(".add-term",criteriaList).data("add-count",0).on("click",function(){var count=parseInt($(this).data("add-count"));
var basename="terms["+count+"]";$(this).data("add-count",count+1);editor.addNewRow($(".search-terms",criteriaList),basename)
});this.ruleBuilder=editor},open:function(){this._initOverlay();this.overlay.open()},close:function(){this.overlay.close()
},switchDisplayElement:function(el,subEl){if(el=="results"){this.results.show();this.loading.hide();this.info.hide()
}else{if(el=="info"){this.info.show();$("> *",this.info).hide();$(subEl,this.info).show();this.results.hide();
this.loading.hide()}else{if(el=="loading"){this.loading.show();this.results.hide();this.info.hide()}}}},switchSimple:function(){if(this.simpleBtn.is(".on")){return
}this.switchDisplayElement("info","no-search");$(".on",this.headerNav).removeClass("on");this.simpleBtn.addClass("on");
this.advancedForm.slideUp();this.simpleForm.slideDown()},switchAdvanced:function(){if(this.advancedBtn.is(".on")){return
}this._initRuleBuilder();this.switchDisplayElement("info","no-search");$(".on",this.headerNav).removeClass("on");
this.advancedBtn.addClass("on");this.simpleForm.slideUp();this.advancedForm.slideDown()},submitSearch:function(form){var formData=form.serializeArray();
this.switchDisplayElement("loading");$.ajax({url:BASE_URL+"agent/people-search/quick-find-search.json",data:formData,dataType:"json",type:"POST",context:this,success:this.handleSearchSuccess})
},handleSearchSuccess:function(data){if(data.no_results){this.switchDisplayElement("info","no-results");
return}this.results.empty().html(data.html);this._initNewResults();this.switchDisplayElement("results")
},_initNewResults:function(){var self=this;$(".choose-trigger",this.results).on("click",function(ev){ev.preventDefault();
var el=$(this);var personId=el.data("person-id");var eventData={el:el,personId:personId,event:ev,doCloseOverlay:true};
self.fireEvent("choosePerson",[eventData]);if(eventData.doCloseOverlay){self.close()}})},destroy:function(){if(this.overlay){this.overlay.destroy()
}if(this.ruleBuilder){this.ruleBuilder.destroy()}}});Orb.createNamespace("DeskPRO.Agent.Widget");DeskPRO.Agent.Widget.AgentSelector=new Orb.Class({Implements:[Orb.Util.Options,Orb.Util.Events],initialize:function(options){this.options={triggerElement:null,agentList:null,multipleChoice:false,showNone:false,noneLabel:"Unassigned",zIndex:30001,startWith:[]};
if(options){this.setOptions(options)}this.previousSelection="";if(this.options.triggerElement){var self=this;
$(this.options.triggerElement).on("click",function(ev){ev.preventDefault();self.open(ev)})}},_initWrapper:function(){if(this.wrapper){return
}var agentListItems=$("li",this.options.agentList);this.backdrop=$('<div class="backdrop"></div>').appendTo("body");
this.backdrop.on("click",this.close.bind(this));this.wrapper=$('<div class="field-overlay agent-selector" style="display:none;"><div class="close-trigger"></div></div>');
$(".close-trigger",this.wrapper).on("click",this.close.bind(this));var listWrapper=$('<div class="with-scrollbar">'+'<div class="scrollbar disable"><div class="track"><div class="thumb"><div class="end"></div></div></div></div>'+'<div class="scroll-viewport"><div class="scroll-content">'+"</div></div></div>");
if(agentListItems.length>=10){this.filter=$('<div class="filter"><div class="input-wrap"><input type="text" value="" placeholder="Find an agent" /></div></div>').appendTo(this.wrapper);
$("input",this.filter).on("keyup",this.updateFilter.bind(this))}else{this.filter=null}var isMulti=this.options.multipleChoice;
var startWith=this.options.startWith;var agentList=$("<ul />");if(this.options.showNone){var newLi=$('<li class="agent-0" data-agent-id="0"><div class="name"><a>'+this.options.noneLabel+"</a></div></li>");
var choiceContainer=$('<div class="choice" />');var checked="";if(!startWith.length){checked='checked="checked"'
}if(isMulti){var choice=$('<input type="checkbox" name="agents[]" '+checked+' value="0" class="agent-choice-0" />')
}else{var choice=$('<input type="radio" name="agents[]" '+checked+' value="0" class="agent-choice-0" />')
}choice.appendTo(choiceContainer);newLi.append(choiceContainer);newLi.append($('<br style="clear:left;height: 1px;overflow: hidden;"/>'));
agentList.append(newLi)}agentListItems.each(function(){var li=$(this);var agentId=li.data("agent-id");
var agentName=$("a:first",li).text();var image=$("img:first",li);var newLi=$('<li class="agent-'+agentId+'" data-agent-id="'+agentId+'" />');
if(image.length){var imgContainer=$('<div class="avatar" />');image.clone().appendTo(imgContainer);imgContainer.appendTo(newLi)
}var nameContainer=$('<div class="name" />');nameContainer.append("<a>"+Orb.escapeHtml(agentName)+"</a>");
nameContainer.appendTo(newLi);var checked="";if(startWith.indexOf(agentId+"")!==-1||startWith.indexOf(parseInt(agentId))!==-1){checked='checked="checked"'
}var choiceContainer=$('<div class="choice" />');if(isMulti){var choice=$('<input type="checkbox" name="agents[]" '+checked+' value="'+agentId+'" class="agent-choice-'+agentId+'" />')
}else{var choice=$('<input type="radio" name="agents[]" '+checked+' value="'+agentId+'" class="agent-choice-'+agentId+'" />')
}choice.appendTo(choiceContainer);choiceContainer.appendTo(newLi);newLi.append($('<br style="clear:left;height: 1px;overflow: hidden;"/>'));
newLi.appendTo(agentList);newLi.on("click",function(ev){ev.stopPropagation();if(!$(ev.target).is("input")){choice.click()
}})});delete agentListItems;this.agentList=agentList;var self=this;$('input[type="checkbox"], input[type="radio"]',agentList).on("click",function(ev){var agentId=$(this).val();
var checked=$(this).is(":checked");var eventData={agentSelector:self,element:$(this),agentId:agentId,checked:checked,event:ev};
self.fireEvent("selectionClick",[eventData])});agentList.appendTo($("div.scroll-content",listWrapper));
listWrapper.appendTo(this.wrapper);this.listWrapper=listWrapper;this.wrapper.appendTo("body");var selectionString=this.getSelection();
if(this.options.multipleChoice){selectionString=selectionString.join(",")}this.previousSelection=selectionString;
var eventData={agentSelector:this,wrapper:this.wrapper};this.fireEvent("initWrapper",[eventData])},updateFilter:function(){var input=$("input",this.filter);
var filter=input.val().trim().toLowerCase();var lis=$("> li",this.agentList);if(!filter){lis.show();return
}lis.each(function(){var name=$("a:first",this).text().toLowerCase();if(name.indexOf(filter)!==-1){$(this).show()
}else{$(this).hide()}})},open:function(event){this._initWrapper();var target=$(event.target);var width=this.wrapper.outerWidth();
var height=this.wrapper.outerHeight();var pageWidth=$(document).width();var pageHeight=$(document).height();
var pageX=target.offset().left;var pageY=target.offset().top;if(pageX+width<pageWidth){var left=pageX+6
}else{var left=pageX-width-4}if(pageY+height<pageHeight){var top=pageY-6}else{var top=pageY-height+4}if(top<0){top=5
}this.backdrop.show();this.wrapper.addClass("open");this.wrapper.css({"z-index":this.options.zIndex,"position":"absolute","top":top,"left":left,"display":"block"});
this.listWrapper.tinyscrollbar();var eventData={agentSelector:this,event:event};this.fireEvent("open",[eventData])
},close:function(){if(!this.wrapper.is(".open")){return}var eventData={agentSelector:this,cancelClose:false};
this.fireEvent("beforeClose",[eventData]);if(eventData.cancelClose){return}delete eventData.cancelClose;
this.backdrop.hide();this.wrapper.hide().removeClass("open");this.fireEvent("close",[eventData]);var selectionString=this.getSelection();
if(this.options.multipleChoice){selectionString=selectionString.join(",")}if(this.previousSelection!=selectionString){eventData.selection=this.getSelection();
this.fireEvent("selectionChanged",[eventData]);this.previousSelection=selectionString}},isOpen:function(){return this.wrapper.is(".open")
},getWrapper:function(){return this.wrapper},getSelection:function(){if(this.options.multipleChoice){var ids=[];
$('input[type="checkbox"]:checked',this.agentList).each(function(){ids.push($(this).val())});return ids
}else{var id=$('input[type="radio"]:checked:first',this.agentList).val();return id}}});Orb.createNamespace("DeskPRO.Agent.Widget");
DeskPRO.Agent.Widget.SnippetViewer=new Orb.Class({Implements:[Orb.Util.Options,Orb.Util.Events],initialize:function(options){this.options={viewUrl:null,triggerElement:null,positionMode:"side",sidePosition:"bottom",destroyOnClose:false,snippetType:"tickets"};
var self=this;this.setOptions(options);if(this.options.triggerElement){$(this.options.triggerElement).on("click",function(ev){ev.preventDefault();
ev.stopPropagation();self.open()})}var pageSourceId=this.options.snippetType+"_snippet_shell_tpl";this.pop=new DeskPRO.Agent.PageHelper.Popover({positionMode:this.options.positionMode,sidePosition:this.options.sidePosition,pageUrl:this.options.viewUrl,pageSource:DeskPRO_Window.util.getPlainTpl($("#"+pageSourceId)),destroyOnClose:false,onPageInit:function(pop,page){page.addEvent("closeSelf",function(ev){ev.cancel=true;
self.close()});page.addEvent("snippetClick",function(ev){ev.page=page;self.fireEvent("snippetClick",[ev])
})}})},open:function(){this.fireEvent("onBeforeOpen");this.pop.open();DeskPRO.Agent.Widget.SnippetViewer.HasOpen=true
},close:function(){if(this.pop){this.pop.close()}DeskPRO.Agent.Widget.SnippetViewer.HasOpen=false;if(this.options.destroyOnClose){this.destroy()
}},destroy:function(){this.pop.destroy();DeskPRO.Agent.Widget.SnippetViewer.HasOpen=false}});DeskPRO.Agent.Widget.SnippetViewer.HasOpen=false;
Orb.createNamespace("DeskPRO.Agent.Widget");DeskPRO.Agent.Widget.TicketChangeUser=new Orb.Class({Implements:[Orb.Util.Options,Orb.Util.Events],initialize:function(options){this.options={ticketId:0,destroyOnClose:false};
this.setOptions(options);this.ticketId=this.options.ticketId;this.overlay=null},_initOverlay:function(){if(this.overlay){return this.overlay
}var data=[];var self=this;this.overlay=new DeskPRO.UI.Overlay({contentMethod:"ajax",contentAjax:{url:BASE_URL+"agent/tickets/"+this.ticketId+"/change-user-overlay",data:data},onAjaxDone:function(){self.wrapper=self.overlay.elements.wrapper;
DeskPRO_Window.initInterfaceLayerEvents(self.wrapper);var searchbox=self.wrapper.find(".person-finder");
var submitRow=self.wrapper.find(".submit-row");var newUserFields=self.wrapper.find(".new-user-fields");
self.wrapper.on("click","button.change-user-trigger",function(ev){ev.preventDefault();ev.stopPropagation();
var data=[];var personId=$(this).data("person-id");if(personId&&personId!="0"){data.push({name:"new_person_id",value:personId})
}else{data.push({name:"email",value:newUserFields.find(".email").val()});data.push({name:"name",value:newUserFields.find(".name").val()})
}var keepParticipant=self.wrapper.find(".participant-check").is(":checked");data.push({name:"keep",value:(keepParticipant?1:0)});
console.log(data);$.ajax({url:BASE_URL+"agent/tickets/"+self.ticketId+"/change-user",type:"POST",data:data,dataType:"json",success:function(data){if(!data.success){if(data.error){DeskPRO_Window.showAlert(data.error)
}return}self.fireEvent("success",[data])}})});searchbox.bind("personsearchboxclick",function(ev,personId,name,email,sb){sb.close();
$.ajax({url:BASE_URL+"agent/tickets/"+self.ticketId+"/change-user-overlay/preview/"+personId,type:"get",dataType:"html",success:function(html){self.wrapper.find("button.change-user-trigger").data("person-id",personId);
self.wrapper.find(".person-preview-content").html(html);newUserFields.hide();submitRow.show()}})});searchbox.bind("personsearchboxclicknew personsearchenter",function(ev,term,sb){sb.close();
sb.reset();if(term.indexOf("@")!==-1){$("input.email",newUserFields).val(term)}else{$("input.name",newUserFields).val(term)
}self.wrapper.find(".person-preview-content").empty();self.wrapper.find("button.change-user-trigger").data("person-id",false);
newUserFields.show();submitRow.show()})}});this.overlay.addEvent("ajaxDone",this._initElements.bind(this))
},_initElements:function(){this.wrapper=this.overlay.getWrapper();var self=this},open:function(){this._initOverlay();
this.overlay.open()},close:function(){this.overlay.close();if(this.options.destroyOnClose){this.desotry
}},destroy:function(){if(this.overlay){this.overlay.destroy()}}});Orb.createNamespace("DeskPRO.Agent.Widget");
DeskPRO.Agent.Widget.Merge=new Orb.Class({Implements:[Orb.Util.Options,Orb.Util.Events],initialize:function(options){this.options={tabType:null,metaId:0,metaIdName:null,menu:null,trigger:null,overlayUrl:null,mergeUrl:null,overlayLoaded:null};
this.setOptions(options);this.mergeMenu=null;if(this.options.menu){this.mergeMenu=new DeskPRO.UI.Menu({triggerElement:this.options.trigger,menuElement:this.options.menu,onBeforeMenuOpened:this._menuPopulate.bind(this),onItemClicked:this._menuItemClick.bind(this)})
}},_getOverlayUrl:function(id,otherId){return this.options.overlayUrl.replace("{id}",id).replace("{other}",otherId)
},_getMergeUrl:function(id,otherId){return this.options.mergeUrl.replace("{id}",id).replace("{other}",otherId)
},_menuPopulate:function(){var menu=this.options.menu,self=this;menu.find(".tab-reference").remove();
var tabInsert=menu.find(".tab-insert"),insertPosition=tabInsert;if(!insertPosition.length){insertPosition=false
}Array.each(DeskPRO_Window.getTabWatcher().findTabType(this.options.tabType),function(tab){var id=tab.page.getMetaData(self.options.metaIdName);
if(id&&id!=self.options.metaId){var li=$("<li />").addClass("tab-reference").data("merge-id",id).text(tab.title);
if(insertPosition){insertPosition.after(li)}else{menu.prepend(li)}insertPosition=li}});if(menu.find("li.tab-reference").length==0){if(!tabInsert.hasClass("always-show")){tabInsert.hide()
}menu.find("li.no-choice").show()}else{tabInsert.show();menu.find("li.no-choice").hide()}},_menuItemClick:function(info){var el=$(info.itemEl);
if(el.hasClass("elm")){return false}var otherId=el.data("merge-id");if(!otherId){otherId=0}if(this.overlay){this.overlay.destroy()
}this.overlay=new DeskPRO.UI.Overlay({contentMethod:"ajax",contentAjax:{url:this._getOverlayUrl(this.options.metaId,otherId)},zIndex:40000});
this.overlay.addEvent("ajaxDone",this._overlayLoaded.bind(this));this.overlay.open()},openWithId:function(otherId){if(this.overlay){this.overlay.destroy()
}this.overlay=new DeskPRO.UI.Overlay({contentMethod:"ajax",contentAjax:{url:this._getOverlayUrl(this.options.metaId,otherId)},zIndex:40000});
this.overlay.addEvent("ajaxDone",this._overlayLoaded.bind(this));this.overlay.open()},open:function(){if(this.overlay){this.overlay.destroy()
}this.overlay=new DeskPRO.UI.Overlay({contentMethod:"ajax",contentAjax:{url:this._getOverlayUrl(this.options.metaId,0)},zIndex:40000});
this.overlay.addEvent("ajaxDone",this._overlayLoaded.bind(this));this.overlay.open()},resetOverlay:function(html){this.overlay.setContent($(html));
this._overlayLoaded()},_overlayLoaded:function(){var overlay=this.overlay,wrapper=overlay.getWrapper(),self=this;
DeskPRO.ElementHandler_Exec(wrapper);if(this.options.overlayLoaded){this.options.overlayLoaded(this.overlay,this)
}var buttons=wrapper.find(".merge-data .merge-target-button");if(buttons.length!=2){return}this.mergeButtons=buttons;
var keepHtml="",mergeHtml="";buttons.each(function(){var $this=$(this);if($this.data("keep")){keepHtml=$this.html()
}else{mergeHtml=$this.html()}});var rows=wrapper.find(".merge-data .merge-data-rows tr:not(.mergeable)");
var getCmpVal=function(el){var val=$.trim(el.text());val=val.toLowerCase();val=val.replace(/\s/g,val);
return val};var setMergeDataLostClasses=function(){var keepCol=0,mergeCol=0;if(wrapper.find(".left-text").data("keep")){keepCol=0;
mergeCol=1}else{mergeCol=0;keepCol=1}rows.each(function(){var $row=$(this);var tds=$row.find("td"),keep=tds.eq(keepCol),merge=tds.eq(mergeCol);
keep.removeClass("merge-data-lost merge-data-keep");merge.removeClass("merge-data-lost merge-data-keep");
if($row.hasClass("always-keep")){merge.addClass("merge-data-lost");keep.addClass("merge-data-keep")}else{if(getCmpVal(keep)!=getCmpVal(merge)){merge.addClass("merge-data-lost");
keep.addClass("merge-data-keep")}}})};setMergeDataLostClasses();wrapper.find(".switch-trigger").on("click",function(ev){ev.preventDefault();
buttons.each(function(){if(!$(this).data("keep")){$(this).click();return false}})});buttons.click(function(){buttons.data("keep",false).html(mergeHtml);
$(this).data("keep",1).html(keepHtml);setMergeDataLostClasses()});wrapper.find(".merge-trigger").click(this._mergeTriggerClick.bind(this))
},_mergeTriggerClick:function(){var mergeId=0,otherMergeId=0,self=this;this.mergeButtons.each(function(){var $this=$(this);
if($this.data("keep")){mergeId=$this.data("merge-id")}else{otherMergeId=$this.data("merge-id")}});if(!mergeId||!otherMergeId){return
}var footerEl=this.overlay.getWrapper().find(".overlay-footer").addClass("loading");$.ajax({url:this._getMergeUrl(mergeId,otherMergeId),type:"POST",dataType:"json",complete:function(){footerEl.removeClass("loading")
},success:function(data){if(data.success){Array.each(DeskPRO_Window.getTabWatcher().findTabType(self.options.tabType),function(tab){var id=tab.page.getMetaData(self.options.metaIdName);
if(id==data.old_id||id==data.id){DeskPRO_Window.TabBar.removeTabById(tab.id)}});DeskPRO_Window.runPageRoute(self.options.loadRoute.replace("{id}",data.id))
}self.overlay.close()},error:function(xhr,textStatus,errorThrown){self.overlay.close();var status=(xhr.status||"")+" "+(errorThrown||"")+" "+(xhr.statusText||"");
DeskPRO_Window._showAjaxError('<div class="error-details">Here is the raw output returned from the server error:<textarea class="raw">'+status+"\n\n"+Orb.escapeHtml(xhr.responseText)+"</textarea></div>")
}})},destroy:function(){if(this.overlay){this.overlay.destroy()}if(this.mergeMenu){this.mergeMenu.destroy()
}}});Orb.createNamespace("DeskPRO.Agent.Widget");DeskPRO.Agent.Widget.AgentChatWin_Registry={};DeskPRO.Agent.Widget.AgentChatWin_Find=function(chatId){var found=null;
Object.each(DeskPRO.Agent.Widget.AgentChatWin_Registry,function(chatWin){if(chatWin&&!found&&chatWin.getConvoId()==chatId){found=chatWin
}});return found};DeskPRO.Agent.Widget.AgentChatWin_FindAgents=function(agent_ids){var found=null;agent_ids=agent_ids.sort(function(a,b){return parseInt(a)-parseInt(b)
});agent_ids_str=agent_ids.join(",");Object.each(DeskPRO.Agent.Widget.AgentChatWin_Registry,function(chatWin){if(chatWin&&!found&&chatWin.agentIdsStr==agent_ids_str){found=chatWin
}});return found};DeskPRO.Agent.Widget.AgentChatWin=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(options){this.options={convoId:0,agentIds:[],title:null};
this.setOptions(options);this.uuid=this.OBJ_ID;this.convoId=this.options.convoId;this.chatsWrapper=$("#agent_chats_wrapper");
DeskPRO.Agent.Widget.AgentChatWin_Registry[this.uuid]=this;this.agentIds=[];Array.each(this.options.agentIds,function(i){this.agentIds.push(parseInt(i))
},this);this.agentIds=this.agentIds.sort(function(a,b){return a-b});this.agentIdsStr=this.agentIds.join(",");
this.wrapper=null;this._initWindow()},_initWindow:function(){if(this._hasInitWin){return}this._hasInitWin=true;
var self=this;if(this.convoId){var exist=$("#agent_chat_conversation_"+this.convoId);if(exist.length){return
}}if(!this.options.title&&(this.agentIds.length==1||(this.agentIds.length==2&&this.agentIds.indexOf(parseInt(DESKPRO_PERSON_ID))!=-1))){if(this.agentIds[0]==DESKPRO_PERSON_ID){var agentInfo=DeskPRO_Window.getAgentInfo(this.agentIds[1])
}else{var agentInfo=DeskPRO_Window.getAgentInfo(this.agentIds[0])}if(!agentInfo){return}var newContainer=$.tmpl("agent_chat_conversation",{local_id:this.uuid,to_agent_name:agentInfo.name,to_agent_shortname:agentInfo.shortName,to_agent_id:agentInfo.id,to_agent_picture:agentInfo.pictureUrlSizable.replace(/_SIZE_/g,15)})
}else{var newContainer=$.tmpl("agent_groupchat_conversation",{local_id:this.uuid,title:this.options.title||"Group"})
}this.wrapper=newContainer;newContainer.find("> .window").find("> header, > div.messages-box, > .input-message-wrap").on("click",function(ev){var count=0;
Object.each(DeskPRO.Agent.Widget.AgentChatWin_Registry,function(win){if(win){win.wrapper.css("z-index",count++)
}});self.wrapper.css("z-index",count+1)});newContainer.find("> nav").on("click",function(){var count=0;
Object.each(DeskPRO.Agent.Widget.AgentChatWin_Registry,function(win){if(win){win.wrapper.css("z-index",count++)
}});self.wrapper.css("z-index",count+1)});newContainer.on("click","[data-route]",function(ev){ev.preventDefault();
ev.stopPropagation();DeskPRO_Window.runPageRouteFromElement($(this))});this.chatsWrapper.append(newContainer);
this.resetPosition();$("textarea",newContainer).on("keypress",(function(ev){if(ev.keyCode==13&&!ev.metaKey){ev.preventDefault();
this._fireSendMessage()}}).bind(this));var nav=$("> nav",newContainer);nav.on("click",function(ev){if(newContainer.is(".open")){newContainer.removeClass("open")
}else{newContainer.addClass("open")}});$(".close-trigger",nav).on("click",function(ev){ev.stopPropagation();
self.fireEvent("close");self.destroy()});$(".minimize",newContainer).on("click",function(ev){ev.stopPropagation();
self.fireEvent("minimize");self.close()});$(".close",newContainer).on("click",function(ev){ev.stopPropagation();
self.fireEvent("close");self.destroy()});this.loadLastConvo()},loadLastConvo:function(){var data=[];Array.each(this.agentIds,function(id){data.push({name:"agent_ids[]",value:id})
});$.ajax({url:BASE_URL+"agent/agent-chat/get-last-convo",data:data,contentType:"json",context:this,success:function(data){if(data.conversation_id){this.convoId=data.conversation_id
}if(data.messages){Array.each(data.messages,function(messageInfo){if(messageInfo.agent_id==DESKPRO_PERSON_ID){this.showMyMessage(messageInfo.message)
}else{this.showMessage(messageInfo.agent_id,messageInfo.message,messageInfo.time)}},this)}}})},resetPosition:function(){if(!this.wrapper){return
}var chats=$("> section.agent-chat",this.chatsWrapper);if(chats.length>1){var lastChat=chats.eq(-2);var leftPos=lastChat.position().left+$("> nav",lastChat).outerWidth()+8;
this.wrapper.css("left",leftPos)}else{this.wrapper.css("left",0)}},_fireSendMessage:function(){var txt=$("textarea",this.wrapper);
var msg=txt.val().trim();txt.val("");if(!msg.length){return}var messageBlock=this.showMyMessage(msg);
this.sendMessage(msg,messageBlock)},getConvoId:function(){return this.convoId},getConvoLocalId:function(){return this.uuid
},sendMessage:function(message,messageBlock){var data=[];data.push({name:"content",value:message});data.push({name:"local_id",value:this.uuid});
Array.each(this.agentIds,function(id){data.push({name:"agent_ids[]",value:id})});var messageLocalId=Orb.uuid();
var info={message:message,localMessageId:messageLocalId,convoId:this.convoId,convoLocalId:this.uuid};
this.fireEvent("sendMessage",[this,info]);$.ajax({url:BASE_URL+"agent/agent-chat/send-agent-message/"+this.convoId,data:data,contentType:"json",context:this,success:function(data){this.convoId=data.conversation_id;
info.messageId=data.message_id;info.convoId=this.convoId;this.fireEvent("sendMessageDone",[this,info]);
if(messageBlock){messageBlock.find("time").text(data.time)}}})},showMessage:function(agent_id,message,time){var agentInfo=DeskPRO_Window.getAgentInfo(agent_id);
if(!agentInfo){return}var newMessage=$.tmpl("agent_chat_message",{author_id:agent_id,author_name:agentInfo.name,author_picture:agentInfo.pictureUrlSizable.replace(/_SIZE_/g,25),message:"",time:time||""});
newMessage.find("span.message-text").html(this.formatMessage(message));$(".messages-container",this.wrapper).append(newMessage);
$(".messages-box").scrollTop(100000)},formatMessage:function(message){var message=Orb.escapeHtml(message);
var idMap={"t":{title:"Ticket",url:BASE_URL+"agent/tickets/"},"p":{title:"Person",url:BASE_URL+"agent/people/"},"o":{title:"Organization",url:BASE_URL+"agent/organizations/"},"a":{title:"Article",url:BASE_URL+"agent/kb/article/"},"n":{title:"News",url:BASE_URL+"agent/news/post/"},"d":{title:"Download",url:BASE_URL+"agent/downloads/file/"},"i":{title:"Feedback",url:BASE_URL+"agent/feedback/view/"}};
Object.each(idMap,function(info,prefix){var re=new RegExp("{{s*"+prefix+"-([0-9]+)s*}}","g");message=message.replace(re,'<a data-route="page:'+info.url+'$1">'+info.title+" #$1</a>")
});var re=new RegExp("{{s*tw-([0-9]+)s*}}","g");message=message.replace(re,'<a data-route="poppage:'+BASE_URL+'agent/twitter/status/tweet-overlay?account_status_id=$1">Tweet #$1</a>');
message=message.replace(/(https?:\/\/[^\s]+)/gi,'<a href="$1" target="_blank">$1</a>');return message
},showMyMessage:function(message){var newMessage=$.tmpl("agent_chat_message_me",{message:"",time:"..."});
newMessage.find("span.message-text").html(this.formatMessage(message));$(".messages-container",this.wrapper).append(newMessage);
$(".messages-box").scrollTop(100000);return newMessage},open:function(){if(this.wrapper){this.wrapper.addClass("open");
this.wrapper.find("textarea").focus()}},close:function(){if(this.wrapper){this.wrapper.removeClass("open")
}},destroy:function(){if(this.wrapper){this.wrapper.remove();this.wrapper=null}DeskPRO.Agent.Widget.AgentChatWin_Registry[this.uuid]=null;
delete DeskPRO.Agent.Widget.AgentChatWin_Registry[this.uuid];this.fireEvent("destroy",[this])}});Orb.createNamespace("DeskPRO.Agent.Widget");
DeskPRO.Agent.Widget.BackgroundPopout=new Orb.Class({Implements:[Orb.Util.Options,Orb.Util.Events],initialize:function(options){this.options={loadUrl:null,tabRoute:null,initialTimeout:12000,periodicalTimeout:600000,autostart:true,maxJitter:2000};
this.setOptions(options);this.template=null;this.xhr=null;this.timeout=null;this.pop=null;this.doReset=false;
this.nextParams=null;if(this.options.autostart){this.startTimeout()}},startTimeout:function(){var t;if(this.timeout){return
}if(this.template){t=this.options.periodicalTimeout}else{t=this.options.initialTimeout}t+=Math.random()*this.options.maxJitter;
this.timeout=window.setTimeout(this.loadTemplate.bind(this,null),t)},loadTemplate:function(callback){DP.console.debug("[BackgroundPopout] Loading: %s",this.options.loadUrl);
if(this.xhr){return}if(this.timeout){window.clearTimeout(this.timeout);this.timeout=null}this.xhr=$.ajax({url:this.options.loadUrl,data:this.nextParams||null,type:"GET",dataType:"html",context:this,errorDp:function(){this.template=null;
this.destroyPop();this.close();this.startTimeout()},success:function(html){this.nextParams=null;this.template=html;
if(callback){if(typeof callback!="function"){DP.console.error("Not a valid callback: %o",callback);return
}callback(html)}},complete:function(){this.xhr=null;this.startTimeout()}})},invalidateTemplate:function(){this.loadTemplate()
},getTemplate:function(){return this.template},open:function(callback){var self=this;var withNextParams=false;
if(this.nextParams){withNextParams=true;this.clear()}if(this.options.tabRoute&&!DeskPRO_Window.paneVis.list){DeskPRO_Window.runPageRoute(this.options.tabRoute);
return}if(this.pop){if(this.doReset){this.pop.setHtml(this.getTemplate());this.doReset=false}this.pop.open();
if(callback&&this.pop.page){callback(this.pop.page)}return}this.doReset=false;var self=this;var pop=new DeskPRO.Agent.PageHelper.Popover({tabRoute:this.options.tabRoute,onPageInit:function(pop,page){page.addEvent("closeSelf",function(ev){ev.cancel=true;
self.clear()});if(callback){callback(page)}}});var tpl=this.getTemplate();if(tpl){pop.setHtml(tpl)}else{this.loadTemplate(function(html){pop.setHtml(html);
if(withNextParams){self.template=null}})}this.pop=pop;pop.open()},isOpen:function(){if(!this.pop){return false
}if(this.pop.isOpen()){return true}return false},toggle:function(){if(!this.pop){this.open();return}this.pop.toggle()
},close:function(){if(!this.pop){return}this.pop.close()},clear:function(){if(this.pop){this.pop.destroy();
this.pop=null}this.template=null},destroyPop:function(){if(!this.pop){return}this.pop.destroy();this.pop=null;
this.template=null}});Orb.createNamespace("DeskPRO.Agent.RuleBuilder");DeskPRO.Agent.RuleBuilder.TermAbstract=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(options){this.options={ruleBuilder:null,rowEl:null,rowId:null,opMenu:null};
if(options){this.setOptions(options)}this.ruleBuilder=this.options.ruleBuilder;this.rowEl=$(this.options.rowEl);
this.rowId=this.options.rowId;this.opMenu=this.options.opMenu;this.init()},init:function(){},initRow:function(){},initValues:function(){}});
Orb.createNamespace("DeskPRO.Agent.RuleBuilder");DeskPRO.Agent.RuleBuilder.DateTerm=new Orb.Class({Extends:DeskPRO.Agent.RuleBuilder.TermAbstract,initRow:function(){this._initUi()
},initValues:function(){var timestamp=null,date=null;timestamp=this.date1Input.val();if(timestamp){date=new Date(timestamp*1000);
this.date1Widget.datepicker("setDate",date)}timestamp=this.date2Input.val();if(timestamp){date=new Date(timestamp*1000);
this.date2Widget.datepicker("setDate",date)}if(parseInt($(".date1-relative-input",this.rowEl).val())){$(".relative1-input",this.date1).val($(".date1-relative-input",this.rowEl).val());
$(".relative1-type",this.date1).val($(".date1-relative-type",this.rowEl).val());$(".date",this.date1).hide();
$(".relative",this.date1).show().addClass("on")}if(parseInt($(".date2-relative-input",this.rowEl).val())){$(".relative2-input",this.date2).val($(".date2-relative-input",this.rowEl).val());
$(".relative2-type",this.date2).val($(".date2-relative-type",this.rowEl).val());$(".date",this.date2).hide();
$(".relative",this.date2).show().addClass("on")}this.updateStatus()},_initUi:function(){this.opInput=$("select.op",this.rowEl);
this.date1Input=$("input.date1-input",this.rowEl);this.date2Input=$("input.date2-input",this.rowEl);this.date1Display=$("input.date1-display",this.rowEl);
this.date2Display=$("input.date2-display",this.rowEl);this.currentValue=$(".status-value",this.rowEl);
this.currentValue.text("(click to set)");this.currentValue.on("click",this.show.bind(this));this.dateWrap=$(".date-wrap",this.rowEl);
this.backdrop=$('<div class="backdrop" style="display: none"></div>');this.backdrop.appendTo("body");
this.backdrop.on("click",this.hide.bind(this));this.wrapper=$('<div class="field-overlay" style="display:none"><div class="close-trigger"></div></div>');
$(".close-trigger",this.wrapper).on("click",this.hide.bind(this));this.dateWrap.detach().appendTo(this.wrapper).css("display","block");
this.wrapper.appendTo("body");this.date1=$(".date1",this.dateWrap);this.date2=$(".date2",this.dateWrap);
var self=this;this.date1Widget=$(".widget",this.date1).datepicker({dateFormat:"M d, yy",onSelect:function(dateText,inst){self.date1Input.val(self.date1Widget.datepicker("getDate").getTime()/1000);
self.date1Display.val(dateText);self.updateStatus()}});this.date2Widget=$(".widget",this.date2).datepicker({dateFormat:"M d, yy",onSelect:function(dateText,inst){self.date2Input.val(self.date2Widget.datepicker("getDate").getTime()/1000);
self.date2Display.val(dateText);self.updateStatus()}});var getDate=function(el){var timestamp=strtotime(el.val());
if(!timestamp){return null}var date=new Date(timestamp*1000);return date};this.date1Display.on("change",function(){var date=getDate($(this));
if(!date){$(this).val("");return}self.date1Widget.datepicker("setDate",date)});this.date2Display.on("change",function(){var date=getDate($(this));
if(!date){$(this).val("");return}self.date2Widget.datepicker("setDate",date)});$(".switcher",this.date1).on("click",(function(){var date=$(".date",this.date1);
var rel=$(".relative",this.date1);if(date.is(":visible")){date.hide();rel.show().addClass("on")}else{rel.hide().removeClass("on");
date.show()}}).bind(this));$(".switcher",this.date2).on("click",(function(){var date=$(".date",this.date2);
var rel=$(".relative",this.date2);if(date.is(":visible")){date.hide();rel.show().addClass("on")}else{rel.hide().removeClass("on");
date.show()}}).bind(this))},show:function(){if(this.opInput.val()=="between"){this.dateWrap.addClass("two")
}else{this.dateWrap.removeClass("two")}this.wrapper.css({left:this.currentValue.offset().left,top:this.currentValue.offset().top});
this.backdrop.show();this.wrapper.show()},updateStatus:function(){var str1="",str2="",status="";var relative1=$(".relative1",this.date1);
var relative2=$(".relative2",this.date2);if($(".relative",this.date1).hasClass("on")){$(".date1-relative-input",this.rowEl).val($(".relative1-input",this.date1).val());
$(".date1-relative-type",this.rowEl).val($(".relative1-type",this.date1).val());this.date1Input.val("");
if($(".relative1-input",this.date1).val().trim().length){str1=$(".relative1-input",this.date1).val()+" "+$(".relative1-type",this.date1).val()+" ago"
}}else{var date1=this.date1Widget.datepicker("getDate");if(date1){str1=$.datepicker.formatDate("M d, yy",date1)
}}if($(".relative",this.date2).hasClass("on")){$(".date2-relative-input",this.rowEl).val($(".relative2-input",this.date2).val());
$(".date2-relative-type",this.rowEl).val($(".relative2-type",this.date2).val());this.date2Input.val("");
if($(".relative2-input",this.date2).val().trim().length){str2=$(".relative2-input",this.date2).val()+" "+$(".relative2-type",this.date2).val()+" ago"
}}else{var date2=this.date2Widget.datepicker("getDate");if(date2){str2=$.datepicker.formatDate("M d, yy",date2)
}}if(!str1.length){str1="(click to set)"}if(!str2.length){str1="(click to set)"}if(this.opInput.val()=="between"){status=str1+" and "+str2
}else{status=str1}this.currentValue.text(status)},hide:function(){this.updateStatus();this.backdrop.hide();
this.wrapper.hide()},destroy:function(){this.wrapper.remove();this.backdrop.remove()}});Orb.createNamespace("DeskPRO.Agent.RuleBuilder");
DeskPRO.Agent.RuleBuilder.LabelsTerm=new Orb.Class({Extends:DeskPRO.Agent.RuleBuilder.TermAbstract,initRow:function(){var self=this;
this.inner=$(".label-chooser-wrap",this.rowEl);this.labelType=this.rowEl.data("label-type");this.labelsList=$("input.labels-box",this.rowEl).first();
this.labelsInput=new DeskPRO.UI.LabelsInput({type:"tickets",input:this.labelsList,onChange:this.updateLabels.bind(this)});
this.currentValue=$(".status-value",this.rowEl);this.currentValue.text("(click to set)");this.currentValue.on("click",this.show.bind(this));
this.values=$(".label-values",this.rowEl);this.backdrop=$('<div class="backdrop" style="display: none"></div>');
this.backdrop.appendTo("body");this.backdrop.on("click",this.hide.bind(this));this.wrapper=$('<div class="field-overlay labels-chooser" style="display:none"><div class="close-trigger"></div></div>');
$(".close-trigger",this.wrapper).on("click",this.hide.bind(this));this.inner.detach().appendTo(this.wrapper).css("display","block");
this.wrapper.appendTo("body");window.setTimeout(function(){var vals=self.currentValue.data("select-texts");
if(vals){Array.each(vals,function(val){var input=$('<option value="" selected="selected" />');input.val(val);
input.appendTo(self.values)})}},450)},updateLabels:function(){var labels=this.labelsInput.getLabels();
var status="(click to set)";if(labels.length){status=labels.join(", ")}this.currentValue.text(status);
this.values.empty();if(labels.length){Array.each(labels,function(label){var input=$('<option value="" selected="selected" />');
input.val(label);input.appendTo(this.values)},this)}},show:function(){var vals=[];this.values.find("option").each(function(){vals.push($(this).val())
});this.labelsList.select2("val",vals);this.wrapper.css({left:this.currentValue.offset().left,top:this.currentValue.offset().top});
this.wrapper.show();this.backdrop.show().css("z-index",parseInt(this.wrapper.css("z-index"))-1)},hide:function(){this.backdrop.hide();
this.wrapper.hide()},destroy:function(){this.wrapper.remove();this.backdrop.remove();this.labelsInput.destroy()
}});Orb.createNamespace("DeskPRO.Agent.RuleBuilder");DeskPRO.Agent.RuleBuilder.SelectNewOption=new Orb.Class({Extends:DeskPRO.Agent.RuleBuilder.TermAbstract,initRow:function(){var self=this;
this.select=this.rowEl.find("select.template_name");this.select.on("change",function(){self.updateOption()
});this.input=this.rowEl.find("input.new_option");setTimeout(function(){self.rowEl.find("select.template_name, select.agents").each(function(){DP.select($(this))
})},10);this.updateOption()},updateOption:function(){var val=this.select.val();if(val=="NEW"){this.input.show()
}else{this.input.hide()}},show:function(){this.wrapper.css({left:this.currentValue.offset().left,top:this.currentValue.offset().top});
this.wrapper.show();this.backdrop.show().css("z-index",parseInt(this.wrapper.css("z-index"))-1)},hide:function(){this.backdrop.hide();
this.wrapper.hide()},destroy:function(){}});Orb.createNamespace("DeskPRO.Agent.Ticket");DeskPRO.Agent.Ticket.ChangeManager=new Class({Implements:[Events],ticketPage:null,ticketId:null,updateUrl:null,mode:"single",oldValues:{},changes:{},initialize:function(ticketPage){this.ticketPage=ticketPage;
this.ticketId=ticketPage.getMetaData("ticket_id");this.updateUrl=ticketPage.getMetaData("saveActionsUrl")
},propertyManagers:{},getPropertyManager:function(type,type_id){if(this.propertyManagers[type]){return this.propertyManagers[type]
}var manager=null;switch(type){case"category_id":case"product_id":case"workflow_id":case"priority_id":case"language_id":manager=new DeskPRO.Agent.Ticket.Property.StandardOption(this.ticketPage,{optionName:type});
break;case"agent_id":manager=new DeskPRO.Agent.Ticket.Property.Agent(this.ticketPage);break;case"agent_team_id":manager=new DeskPRO.Agent.Ticket.Property.AgentTeam(this.ticketPage);
break;case"department_id":manager=new DeskPRO.Agent.Ticket.Property.Department(this.ticketPage);break;
case"status":manager=new DeskPRO.Agent.Ticket.Property.Status(this.ticketPage);break;case"add_labels":manager=new DeskPRO.Agent.Ticket.Property.Labels(this.ticketPage,{mode:"add"});
break;case"remove_labels":manager=new DeskPRO.Agent.Ticket.Property.Labels(this.ticketPage,{mode:"remove"});
break;case"flag":manager=new DeskPRO.Agent.Ticket.Property.Flag(this.ticketPage);break;case"reply":manager=new DeskPRO.Agent.Ticket.Property.Reply(this.ticketPage);
break;case"ticket_field":manager=new DeskPRO.Agent.Ticket.Property.TicketField(this.ticketPage,{fieldId:type_id});
break;case"is_hold":manager=new DeskPRO.Agent.Ticket.Property.Hold(this.ticketPage);break;case"urgency":manager=new DeskPRO.Agent.Ticket.Property.Urgency(this.ticketPage);
break}if(manager===null&&type.indexOf("_id")==-1){type+="_id";return this.getPropertyManager(type,type_id)
}if(manager===null){return null}this.propertyManagers[type]=manager;return manager},hasChanges:function(){if(Object.getLength(this.changes)){return true
}return false},addChange:function(property,newValue,applyNow){if(property.isSameValue(newValue)){return
}this.mode="multi";this.changes[property.getName()]=[property,newValue];if(applyNow){this.applyChangeForProperty(property,newValue)
}},applyChangeForProperty:function(property,newValue){this.oldValues[property.getName()]=property.getValue();
property.setValue(newValue);if(this.mode=="multi"){property.highlightInterfaceElement()}},applyChanges:function(){Object.each(this.changes,function(change){var property=change[0];
var newValue=change[1];this.applyChangeForProperty(property,newValue)},this);this.fireEvent("changesApplied",{changes:this.changes});
window.setTimeout(this.ticketPage.updateUi.bind(this.ticketPage),450)},hasChangedProperty:function(type){if(this.changes[type]){return true
}return false},revertChanges:function(){Object.each(this.changes,function(change){var property=change[0];
var name=property.getName();if(this.oldValues[name]!==undefined){property.setValue(this.oldValues[name]);
property.unhighlightInterfaceElement()}property.changeReverted()},this);this.oldValues={};$(".change-on, .highlight-change-on",this.ticketPage.wrapper).removeClass("change-on").removeClass("highlight-change-on");
this.mode="single"},setInstantChange:function(property,newValue,callback){if(this.mode=="multi"){this.addChange(property,newValue,true);
return}var oldVal=property.getValue();property.setValue(newValue);property.changePersisted();var data=[];
this._addPropertyValueToData(data,property.getName(),property.getValue());this.fireEvent("changesApplied",{changes:[property,newValue]});
var classname="saving-"+property.getName().replace(".","_");this.ticketPage.wrapper.addClass(classname);
(function(){this.ticketPage.wrapper.removeClass(classname)}).delay(650,this);var self=this;if(this.updateUrl){DeskPRO_Window.util.ajaxWithClientMessages({type:"POST",url:this.updateUrl,data:data,dataType:"json",context:this,success:function(data){if(data.error_messages){property.setValue(oldVal);
var list=self.ticketPage.getEl("field_errors").find("ul").empty();Array.each(data.error_messages,function(msg){var li=$("<li/>");
li.text(msg);li.appendTo(list)});self.ticketPage.getEl("field_errors").show().addClass("on");self.ticketPage.getEl("field_edit_start").click();
self.ticketPage.getEl("field_edit_cancel").show();self.ticketPage.getEl("field_edit_save").show();self.ticketPage.getEl("field_edit_controls").removeClass("loading");
return}if(data.data&&data.data.perm_errors){var div=$("<div/>");div.append("<strong>You do not have permission to change some fields. The following changes were not saved:</strong>");
var list=$("<ul />");list.appendTo(div);Array.each(data.data.perm_errors,function(err){var li=$("<li/>");
li.text(err.capitalize());li.appendTo(list)});DeskPRO_Window.showAlert(div)}if(callback){callback(data)
}this.fireEvent("updateResult",[data])}})}window.setTimeout(this.ticketPage.updateUi.bind(this.ticketPage),450)
},saveChanges:function(data,callback){data=data||[];var saving_classes=[];var saveReply=false;Object.each(this.changes,function(change){var property=change[0];
var name=property.getName();if(name=="reply"){property.unhighlightInterfaceElement();saveReply=true;return
}var classname="saving-"+name.replace(".","_");saving_classes.push(classname);this.ticketPage.wrapper.addClass(classname);
if(!property.isDisplayOnly()){this._addPropertyValueToData(data,property.getName(),property.getValue())
}property.unhighlightInterfaceElement();property.changePersisted()},this);this.mode="single";(function(){var classname="";
while(classname=saving_classes.pop()){this.ticketPage.wrapper.removeClass(classname)}}).delay(650,this);
var self=this;if(this.updateUrl){DeskPRO_Window.util.ajaxWithClientMessages({type:"POST",url:this.updateUrl,data:data,dataType:"json",context:this,success:function(data){if(data.error_messages){var list=self.ticketPage.getEl("field_errors").find("ul").empty();
Array.each(data.error_messages,function(msg){var li=$("<li/>");li.text(msg);li.appendTo(list)});self.ticketPage.getEl("field_errors").show().addClass("on");
self.ticketPage.getEl("field_edit_cancel").show();self.ticketPage.getEl("field_edit_save").show();self.ticketPage.getEl("field_edit_controls").removeClass("loading");
return}self.ticketPage.wrapper.removeClass("field-error");this.changes={};this.oldValues={};if(data&&data.properties){Object.each(data,function(returnValue,type){var property=this.getPropertyManager(type);
property.setIncomingValue(returnValue)},this)}if(saveReply){this.ticketPage.getEl("replybox_wrap").find(".ticket-reply-form").first().data("handler").getElById("send_btn").click()
}if(data.data&&data.data.perm_errors){var div=$("<div/>");div.append("<strong>You do not have permission to change some fields. The following changes were not saved:</strong>");
var list=$("<ul />");list.appendTo(div);Array.each(data.data.perm_errors,function(err){var li=$("<li/>");
li.text(err.capitalize());li.appendTo(list)});DeskPRO_Window.showAlert(div)}if(callback){callback(data)
}this.fireEvent("updateResult",[data])}})}},_addPropertyValueToData:function(data,name,propertyValue){if(typeOf(propertyValue)=="array"){for(var x=0;
x<propertyValue.length;x++){var val=propertyValue[x];if(typeOf(val)=="object"&&val.full_name!==undefined){data.push({name:val.full_name,value:val.value})
}else{if(typeOf(val)=="object"&&val.name!==undefined){data.push({name:"actions["+name+"]["+val.name+"]",value:val.value})
}else{data.push({name:"actions["+name+"][]",value:val})}}}}else{if(typeOf(propertyValue)=="object"){Object.each(propertyValue,function(v,k){data.push({name:"actions["+name+"]["+k+"]",value:v})
},this)}else{data.push({name:"actions["+name+"]",value:propertyValue})}}},setPropertyUpdated:function(property,newValue){if(typeOf(property)=="string"){property=this.getPropertyManager(property)
}property.setIncomingValue(newValue);property.pulseInterfaceElement()}});Orb.createNamespace("DeskPRO.Agent.Ticket.Property");
DeskPRO.Agent.Ticket.Property.Abstract=new Class({Implements:[Events,Options],options:{},ticketPage:null,initialize:function(ticketPage,options){if(options){this.setOptions(options)
}this.ticketPage=ticketPage;this.init()},init:function(){},getName:function(){},isSameValue:function(compare){if(this.getValue()==compare){return true
}return false},getValue:function(){},setValue:function(value){},setIncomingValue:function(value){this.setValue(value)
},getInterfaceElement:function(){return this._getInterfaceElement()},_interfaceEl:null,_getInterfaceElement:function(){},pulseInterfaceElement:function(){this.getInterfaceElement().effect("highlight",1200)
},highlightInterfaceElement:function(){var i=this.getInterfaceElement();if(!i||!i.length){return}this.getInterfaceElement().addClass("change-on");
var displayItemWrap=i.parentsUntil(null,".display-item");if(displayItemWrap.length){displayItemWrap.addClass("highlight-change-on")
}else{i.addClass("change-on")}},changePersisted:function(){},changeReverted:function(){},unhighlightInterfaceElement:function(){this.getInterfaceElement().removeClass("change-on")
},isDisplayOnly:function(){return false},isAdditionOnly:function(){return false}});Orb.createNamespace("DeskPRO.Agent.Ticket.Property");
DeskPRO.Agent.Ticket.Property.Agent=new Class({Extends:DeskPRO.Agent.Ticket.Property.Abstract,optionName:"agent_id",init:function(){},getName:function(){return this.optionName
},getValue:function(){return this.getFormEl().val()},setValue:function(value){if(parseInt(value)==parseInt(this.ticketPage.getEl("value_form").find(".agent_id").val())){return
}this.getFormEl().select2("val",value);this.ticketPage.getEl("value_form").find(".agent_id").val(value);
this.getInterfaceElement().addClass("eat-change").val(value).change()},getInterfaceElement:function(){return this.ticketPage.getEl("agent_sel")
},_formEl:null,getFormEl:function(){if(this._formEl!==null){return this._formEl}this._formEl=$("input.agent_id:first",this.ticketPage.valueForm);
return this._formEl}});Orb.createNamespace("DeskPRO.Agent.Ticket.Property");DeskPRO.Agent.Ticket.Property.Department=new Class({Extends:DeskPRO.Agent.Ticket.Property.Abstract,optionName:"department_id",init:function(){this._formEl=null
},getName:function(){return"department_id"},getValue:function(){return this.getFormEl().val()},setValue:function(value){if(parseInt(value)==parseInt(this.ticketPage.getEl("value_form").find(".department_id").val())){return
}this.getFormEl().select2("val",value);if(value=="0"){value=0}var el=this.getInterfaceElement();var name=this.ticketPage.getEl("department_id").find("option:selected").data("full-title");
this.getInterfaceElement().text(name);this.ticketPage.getEl("value_form").find(".department_id").val(value)
},getInterfaceElement:function(){return this.ticketPage.getEl("department_txt")},getFormEl:function(){if(this._formEl!==null){return this._formEl
}this._formEl=this.ticketPage.getEl("department_id");return this._formEl}});Orb.createNamespace("DeskPRO.Agent.Ticket.Property");
DeskPRO.Agent.Ticket.Property.AgentTeam=new Class({Extends:DeskPRO.Agent.Ticket.Property.Abstract,optionName:"agent_team_id",init:function(){},getName:function(){return this.optionName
},getValue:function(){return this.getFormEl().val()},setValue:function(value){if(parseInt(value)==parseInt(this.ticketPage.getEl("value_form").find(".agent_team_id").val())){return
}this.getFormEl().select2("val",value);this.ticketPage.getEl("value_form").find(".agent_team_id").val(value);
this.getInterfaceElement().addClass("eat-change").val(value).change()},getInterfaceElement:function(){return this.ticketPage.getEl("agent_team_sel")
},_formEl:null,getFormEl:function(){if(this._formEl!==null){return this._formEl}this._formEl=$("input.agent_team_id:first",this.ticketPage.valueForm);
return this._formEl}});Orb.createNamespace("DeskPRO.Agent.Ticket.Property");DeskPRO.Agent.Ticket.Property.StandardOption=new Class({Extends:DeskPRO.Agent.Ticket.Property.Abstract,optionName:null,displayNameType:"standardOption",init:function(){var valid_options=["language_id","category_id","product_id","priority_id","workflow_id"];
if(valid_options.indexOf(this.options.optionName)==-1){throw"invalidOptionName:"+this.options.optionName
}this.optionName=this.options.optionName;switch(this.optionName){case"language_id":this.displayNameType="language";
this.displayCaption="Language";break;case"category_id":this.displayNameType="ticket_category_full";this.displayCaption="Category";
break;case"product_id":this.displayNameType="product";this.displayCaption="Product";break;case"priority_id":this.displayNameType="ticket_priority";
this.displayCaption="Priority";break;case"workflow_id":this.displayNameType="ticket_workflow";this.displayCaption="Workflow";
break}},getName:function(){return this.optionName},getValue:function(){return this.getFormEl().val()},setValue:function(value){this.getFormEl().val(value);
if(value=="0"){value=0}if(parseInt(value)==parseInt(this.ticketPage.getEl("value_form").find("."+this.optionName).val())){return
}var el=this.getInterfaceElement();var pictureEl=null;if(el.data("picture-element")){pictureEl=$(el.data("picture-element"),el.parent());
if(!pictureEl.length){pictureEl=$(el.data("picture-element"),el.parent.parent());if(!pictureEl.length){pictureEl=null
}}}if(value){var displayName=value;if(this.displayNameType){displayName=DeskPRO_Window.getDisplayName(this.displayNameType,value);
if(!displayName){displayName=value}}this.getInterfaceElement().removeClass("no-value").html(displayName);
if(pictureEl){pictureEl.removeClass("no-value").show().attr("src",pictureEl.data("picture-url").replace("{value}",value))
}}else{this.getInterfaceElement().addClass("no-value").html(this.getInterfaceElement().data("no-value-label")||"None");
if(pictureEl){pictureEl.addClass("no-value").hide()}}var fieldEl=$(".prop-input-"+this.optionName,this.ticketPage.wrapper);
if(fieldEl.hasClass("with-select2")){fieldEl.select2("val",value)}else{fieldEl.val(value)}this.ticketPage.getEl("value_form").find("."+this.optionName).val(value).trigger("change")
},getInterfaceElement:function(){return $(".prop-val."+this.optionName,this.ticketPage.contentWrapper).first()
},_formEl:null,getFormEl:function(){if(this._formEl!==null){return this._formEl}this._formEl=$('[name="ticket['+this.optionName+']"]',this.ticketPage.wrapper).first();
return this._formEl}});Orb.createNamespace("DeskPRO.Agent.Ticket.Property");DeskPRO.Agent.Ticket.Property.Status=new Class({Extends:DeskPRO.Agent.Ticket.Property.Abstract,setValue:function(value){var hidden_status=false;
var status_classname=value;if(value&&value.constructor.toString().indexOf("Array")!=-1){hidden_status=value[1].value;
value=value[0].value;status_classname=value}else{if(value.indexOf(".")!=-1){var parts=value.split(".");
var value=parts[0];var hidden_status=parts[1];status_classname=value+"_"+hidden_status;this.ticketPage.fireEvent("ticketHidden",[hidden_status])
}}this.ticketPage.wrapper.find("div.layout-content").removeClass("awaiting_agent awaiting_user resolved closed hidden_deleted hidden_spam hidden_validating hidden_temp").addClass(status_classname);
$("input.status:first",this.ticketPage.valueForm).val(value);$("input.hidden_status:first",this.ticketPage.valueForm).val(hidden_status);
if(value=="awaiting_agent"){this.ticketPage.getEl("hold_container").css("display","inline")}else{this.ticketPage.getEl("hold_container").css("display","none");
this.ticketPage.getEl("hold_container").find(".hold").show();this.ticketPage.getEl("hold_container").find(".unhold").hide()
}this.ticketPage.getEl("status_code").select2("val",value);var scode=value;if(hidden_status){value+="_"+hidden_status
}this.ticketPage.getEl("status_code").val(value);var txt=this.ticketPage.getEl("status_code").find("option:selected").text().trim();
this.getInterfaceElement().text(txt)},getValue:function(){var data=[];data.push({full_name:"actions[status]",value:$("input.status:first",this.ticketPage.valueForm).val()});
data.push({full_name:"actions[hidden_status]",value:$("input.hidden_status:first",this.ticketPage.valueForm).val()});
return data},getInterfaceElement:function(){return this.ticketPage.getEl("status_txt")},getName:function(){return"status"
}});Orb.createNamespace("DeskPRO.Agent.Ticket.Property");DeskPRO.Agent.Ticket.Property.Reply=new Class({Extends:DeskPRO.Agent.Ticket.Property.Abstract,optionName:null,menuRepository:null,getName:function(){return"reply"
},getValue:function(){this.ticketPage.getEl("replybox_wrap").find('textarea[name="message"]').val()},highlightInterfaceElement:function(){this.ticketPage.getEl("replybox_wrap").find('textarea[name="message"]').addClass("highlight-change-on")
},unhighlightInterfaceElement:function(){this.ticketPage.getEl("replybox_wrap").find('textarea[name="message"]').removeClass("highlight-change-on")
},setValue:function(value){if(value.reply_text){value=value.reply_text}return this.ticketPage.getEl("replybox_wrap").find('textarea[name="message"]').val(value)
},setIncomingValue:function(value){},getInterfaceElement:function(){return this.ticketPage.getEl("replybox_wrap").find('textarea[name="message"]')
}});Orb.createNamespace("DeskPRO.Agent.Ticket.Property");DeskPRO.Agent.Ticket.Property.TicketField=new Class({Extends:DeskPRO.Agent.Ticket.Property.Abstract,optionName:"",init:function(){this.optionName="ticket_field."+this.options.fieldId
},getName:function(){return this.optionName},getValue:function(){return this.getInterfaceElement().html()
},setValue:function(value){this.getInterfaceElement().html(value)},getInterfaceElement:function(){return $(".show-fields .custom-field-"+this.options.fieldId+" .field-input",this.ticketPage.contentWrapper)
},isDisplayOnly:function(){return true}});Orb.createNamespace("DeskPRO.Agent.Ticket.Property");DeskPRO.Agent.Ticket.Property.Urgency=new Class({Extends:DeskPRO.Agent.Ticket.Property.Abstract,setValue:function(value){this.ticketPage.getEl("urgency").select2("val",value);
var layoutDiv=this.ticketPage.wrapper.find("div.layout-content");if(!this.getInterfaceElement()[0]){return
}this.getInterfaceElement().text(value||1);this.getInterfaceElement().get(0).className=this.getInterfaceElement().get(0).className.replace(/urgency\-value\-\d+/g,"");
layoutDiv.get(0).className=layoutDiv.get(0).className.replace(/urgency\-\d+/g,"");this.getInterfaceElement().addClass("urgency-value-"+value);
layoutDiv.addClass("urgency-"+value)},getValue:function(){return this.ticketPage.getEl("urgency").val()
},getInterfaceElement:function(){return this.ticketPage.getEl("urgency_txt")},getName:function(){return"urgency"
}});Orb.createNamespace("DeskPRO.Agent.Ticket.Property");DeskPRO.Agent.Ticket.Property.Flag=new Class({Extends:DeskPRO.Agent.Ticket.Property.Abstract,optionName:"flag",init:function(){},getName:function(){return this.optionName
},getValue:function(){return this.ticketPage.getEl("flag").val()},getInterfaceElement:function(){return this.ticketPage.getEl("flag")
},setValue:function(value){var old_flag=this.ticketPage.getEl("flag_old").val();this.ticketPage.getEl("flag_old").val(value);
this.ticketPage.getEl("flag").val(value);if(old_flag==value){return}if(old_flag&&old_flag!=""){DeskPRO_Window.util.modCountEl($("#ticket_flag_"+old_flag+"_count"),"-",1)
}var winCountEl=$("#ticket_flag_"+value+"_count");DeskPRO_Window.util.modCountEl(winCountEl,"+",1);var label=winCountEl.closest("li").find(".flag-label").text().trim();
this.ticketPage.getEl("flagicon").get(0).className=this.ticketPage.getEl("flagicon").get(0).className.replace(/flag\-color\-\w+/g,"");
if(value){this.ticketPage.getEl("flagicon").addClass("flag-color-"+value);this.ticketPage.getEl("flagtext").text(label)
}else{this.ticketPage.getEl("flagtext").text("")}}});Orb.createNamespace("DeskPRO.Agent.Ticket.Property");
DeskPRO.Agent.Ticket.Property.Labels=new Class({Extends:DeskPRO.Agent.Ticket.Property.Abstract,optionName:"labels",mode:"add",init:function(){this.mode=this.options.mode
},getName:function(){return this.mode+"_"+this.optionName},getValue:function(){return this._values},_values:null,setValue:function(values){this._values=values;
if(this.mode=="add"){Array.each(values,function(val){this.ticketPage.labelsInput.tagit.add(val,'<span class="new">'+val+"</span>")
},this)}else{Array.each(values,function(val){var el=$('input[value="'+val+'"]',this.getInterfaceElement());
if(el.length){el=el.parent();li.hide()}},this)}},changePersisted:function(){if(!this._values){return}if(this.mode=="add"){$("li span.new",this.getInterfaceElement()).removeClass("new")
}else{$("li.pending-remove",this.getInterfaceElement()).remove()}this._values=null},changeReverted:function(){if(!this._values){return
}if(this.mode=="add"){$("li:has(span.new)",this.getInterfaceElement()).remove()}else{Array.each(values,function(val){var el=$('input[value="'+val+'"]',this.getInterfaceElement());
if(el.length){el=el.parent();li.show().addClass("pending-remove")}},this)}this._values=null},getInterfaceElement:function(){return $("ul.tagit",this.ticketPage.contentWrapper)
}});Orb.createNamespace("DeskPRO.Agent.Ticket.Property");DeskPRO.Agent.Ticket.Property.Hold=new Class({Extends:DeskPRO.Agent.Ticket.Property.Abstract,optionName:"is_hold",init:function(){},getName:function(){return this.optionName
},getValue:function(){return this.getFormEl().val()},setValue:function(value){if(typeof value==="boolean"){value=value?1:0
}else{value=parseInt(value)}this.getFormEl().val(value);if(value){this.ticketPage.getEl("hold_message").show();
this.ticketPage.getEl("menu_set_hold").hide();this.ticketPage.getEl("menu_unset_hold").show()}else{this.ticketPage.getEl("hold_message").hide();
this.ticketPage.getEl("menu_set_hold").show();this.ticketPage.getEl("menu_unset_hold").hide()}},_formEl:null,getFormEl:function(){if(this._formEl!==null){return this._formEl
}this._formEl=$("input.is_hold:first",this.ticketPage.valueForm);return this._formEl}});Orb.createNamespace("DeskPRO.Agent.TicketList");
DeskPRO.Agent.TicketList.MassActions=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(page,options){this.page=page;
this.options={viewHandler:null,selectionBar:null,listWrapper:null,fetchPreviewUrl:null,triggerElement:null,templateElement:null,isListView:false,resetOnClose:true};
this.setOptions(options);this.viewHandler=this.options.viewHandler;this.selectionBar=this.options.selectionBar||page.selectionBar;
this.fetchPreviewUrl=this.options.fetchPreviewUrl||page.meta.fetchResultsUrl;this.listWrapper=this.options.listWrapper;
if(!this.listWrapper){if(this.options.isListView){this.listWrapper=$(".table-result-list table",page.wrapper)
}else{this.listWrapper=$(".list-listing",page.wrapper)}}this.wrapperEl=this.options.templateElement;if(!this.wrapperEl||!this.wrapperEl[0]){this.wrapperEl=page.wrapper.find(".mass-actions-overlay-tpl");
if(!this.wrapperEl[0]){this.wrapperEl=null}}if(!this.wrapperEl){$("div.mass-actions-overlay-container",page.wrapper)
}if(!this.wrapperEl.length){return}this._resetWrapper();this.backdropEls=null;this.countEl=$(".selected-tickets-count",this.getElement());
var trigger=null;if(this.options.triggerElement===null){trigger=$(".perform-actions-trigger",page.wrapper)
}else{if(this.options.triggerElement){trigger=this.options.triggerElement}}if(trigger){trigger.on("click",(function(ev){ev.preventDefault();
ev.stopPropagation();this.open()}).bind(this))}},updateUi:function(){if(this.scrollerHandler){this.scrollerHandler.updateSize()
}},_resetWrapper:function(){if(this.wrapper){this.wrapper.remove()}if(this.wrapperContainer){this.wrapperContainer.remove()
}if(!this.wrapperEl.is("script")){this.wrapper=$("<div/>").addClass("mass-actions-overlay-container mass-actions").data("base-id",this.wrapperEl.data("base-id")).data("upload-url",this.wrapperEl.data("upload-url"));
var wrapperHtml=this.wrapperEl.html();this.wrapper.html(wrapperHtml)}else{var wrapperHtml=DeskPRO_Window.util.getPlainTpl(this.wrapperEl);
this.wrapper=$(wrapperHtml);this.wrapper.detach().appendTo("body")}this.wrapper.find(".with-scroll-handler, .scroll-setup, .scroll-draw").removeClass("with-scroll-handler scroll-setup scroll-draw");
this.countEl=$(".selected-tickets-count",this.wrapper);DP.select($("select.macro",this.wrapper));DeskPRO_Window.initInterfaceLayerEvents(this.wrapper);
var scrollEl=$(".with-scrollbar",this.wrapper).first();if(scrollEl.length){this.scrollerHandler=new DeskPRO.Agent.ScrollerHandler(null,scrollEl,{showEvent:"show",hideEvent:"hide"})
}},reset:function(){var wasopen=this.isOpen();this.close();this._resetWrapper();this._hasInit=false;this.hasAnyChange=false;
if(wasopen){this.open()}},getElement:function(){return this.wrapper},_initOverlay:function(){var self=this;
if(this._hasInit){return}this._hasInit=true;this.wrapper.detach().appendTo("body");this.wrapper.css("z-index","21001");
this.baseId=this.wrapper.data("base-id");$("select, :radio, :checkbox",this.wrapper).on("change",function(){if(!$(this).hasClass("macro")){self.hasAnyChange=true
}});$("input, textarea",this.wrapper).on("change keypress",function(){self.hasAnyChange=true});this.wrapper.on("click",function(ev){ev.stopPropagation()
});if(this.options.isListView){this.backdropEls=$('<div class="backdrop fade" />')}else{var back1=$('<div class="backdrop mass-actions" />');
var back2=$('<div class="backdrop mass-actions" />');var back3=$('<div class="backdrop mass-actions" />');
this.backdropEls=$([back1.get(0),back2.get(0),back3.get(0)])}this.backdropEls.css("z-index","21000").hide().appendTo("body");
this.backdropEls.on("click",(function(ev){ev.stopPropagation();this.close()}).bind(this));$("header .close-trigger",this.wrapper).first().on("click",(function(ev){ev.stopPropagation();
ev.preventDefault();this.close()}).bind(this));var tpl=DeskPRO_Window.util.getPlainTpl($(".radio-tpl",this.wrapper));
var groupedRadios={};$(":radio.button-toggle",this.wrapper).each(function(){var name=$(this).attr("name");
if(!groupedRadios[name]){groupedRadios[name]=[]}groupedRadios[name].push(this)});Object.each(groupedRadios,function(els){var newEls=[];
els=$(els);var clickFn=function(){var boundId=$(this).data("bound-id");var radio=$("#"+boundId);if(radio.is(":checked")){radio.attr("checked",false);
newEls.removeClass("radio-on")}else{radio.attr("checked",true);newEls.removeClass("radio-on");$(this).addClass("radio-on")
}self.updatePreview(null,true)};els.each(function(){var wrapper=$(this).parent();var title=$(".radio-title",wrapper).text().trim();
var newEl=$(tpl);newEl.addClass($(this).data("attach-class"));$(".radio-title",newEl).text(title);if(!$(this).attr("id")){$(this).attr("id",Orb.getUniqueId())
}newEl.data("bound-id",$(this).attr("id"));newEl.on("click",clickFn);wrapper.hide();newEl.insertAfter(wrapper);
newEls.push(newEl.get(0))});newEls=$(newEls)});$("input, select, textarea",this.wrapper).on("change",(function(){this.updatePreview()
}).bind(this));this.selectionBar.addEvent("checkChange",function(el,is_checked,count){if(!this.isOpen()){return
}this.updateCount(count);this.handleCheckChange(el,is_checked)},this);this.selectionBar.addEvent("checkAll",function(count){if(!this.isOpen()){return
}this.updateCount(count);this.updatePreview()},this);this.selectionBar.addEvent("checkNone",function(){if(!this.isOpen()){return
}this.updateCount(0);this.clearPreview()},this);$("select.macro",this.wrapper).on("change",function(){self.loadMacro($(this).val());
self.updatePreview(null,true)});$(".apply-actions",this.wrapper).on("click",(function(ev){this.apply()
}).bind(this));var textarea=this.getElById("replybox_txt"),isWysiwyg=false;this.textarea=textarea;if(DeskPRO_Window.canUseAgentReplyRte()){isWysiwyg=true;
DeskPRO_Window.initRteAgentReply(textarea,{defaultIsHtml:true,inlineHiddenPosition:this.getElById("is_html_reply"),minHeight:120,callback:function(obj){obj.addBtnFirst("dp_attach","Click here to attach a file. You may also drag a file from your computer desktop into this reply area to upload attachments faster.",function(){});
obj.addBtnAfter("dp_attach","dp_snippets","Open snippets",function(){});obj.addBtnSeparatorAfter("dp_attach");
snippetBtn=obj.$toolbar.find(".redactor_btn_dp_snippets").closest("li");snippetBtn.addClass("snippets").find("a").html('<span class="show-key-shortcut">S</span>nippets');
snippetBtn.on("click",function(ev){Orb.cancelEvent(ev);self.snippetsViewer.open()});var attachBtn=obj.$toolbar.find(".redactor_btn_dp_attach").closest("li");
attachBtn.addClass("attach");attachBtn.find("a").text("Attach").append('<input type="file" class="file" name="file-upload" />');
obj.addBtnSeparatorAfter("dp_snippets")}});this.getElById("is_html_reply").val(1)}this.snippetsViewer=new DeskPRO.Agent.Widget.SnippetViewer({driver:DeskPRO_Window.ticketSnippetDriver,onBeforeOpen:function(){if(isWysiwyg&&textarea.data("redactor")){try{textarea.data("redactor").saveSelection()
}catch(e){}}},onSnippetClick:function(info){var snippetId=info.snippetId;var snippetCode=info.snippetCode;
var agentText;var defaultText;var useText;var result;Array.each(snippetCode,function(info){if(info.value){if(info.language_id==DESKPRO_PERSON_LANG_ID){agentText=info.value
}if(info.language_id==DESKPRO_DEFAULT_LANG_ID){defaultText=info.value}useText=info.value}});if(agentText){useText=agentText
}else{if(defaultText){useText=defaultText}}result=useText;if(isWysiwyg&&textarea.data("redactor")){try{textarea.data("redactor").restoreSelection();
textarea.data("redactor").setBuffer()}catch(e){}var html=result;html=html.replace(/<\/p>\s*<p>/g,"<br/>");
html=html.replace(/^<p>/,"");html=html.replace(/<\/p>$/,"");textarea.data("redactor").insertHtml(html)
}else{self.page.insertTextInReply(result)}self.snippetsViewer.close()}});DeskPRO_Window.util.fileupload(this.wrapper,{page:this.page,url:this.wrapper.data("upload-url"),uploadTemplate:$(".template-upload",this.replyBox),downloadTemplate:$(".template-download",this.replyBox)});
var sels=this.wrapper.find("select.dpe_select");window.setTimeout(function(){sels.each(function(){DP.select($(this))
})},150);this.wrapper.bind("fileuploaddone",function(){self.getElById("attach_row").fadeIn();self.wrapper.find('[name="attach\\[\\]"]').each(function(){$(this).name("actions[reply][attach_ids][]")
})});this.wrapper.bind("fileuploadstart",function(){self.getElById("attach_row").fadeIn();self.updatePositions()
});this.wrapper.on("click",".remove-attach-trigger",function(){var row=$(this).closest("li");row.remove();
var rows=$("ul.files li",self.getElById("attach_row"));if(!rows.length){self.getElById("attach_row").hide().addClass("is-hidden")
}self.updatePositions()});var noneRow=$("li.no-changes",this.wrapper);var agentRow=$("li.assign-agent",this.wrapper);
var teamRow=$("li.assign-team",this.wrapper);var followersRow=$("li.add-followers",this.wrapper);if(this.assignOptionBox){this.assignOptionBox.destroy()
}var add=$(".other-properties-wrapper",this.wrapper);$("div.type",add).each(function(){var type=$(this).data("rule-type");
if(!type){return}if(type=="add_labels"||type=="remove_labels"||type.indexOf("ticket_field[")!==-1||type.indexOf("people_field[")!==-1){}else{$(this).remove()
}self.updatePositions()});this.actionsEditor=new DeskPRO.Form.RuleBuilder($(".actions-builder-tpl",add));
var actList=$(".other-properties-wrapper",this.wrapper);$(".add-term-row",add).show().on("click",function(){var x=Orb.getUniqueId();
var basename="actions_set["+x+"]";self.actionsEditor.addNewRow($(".search-terms",actList),basename);self.updatePositions()
})},updateAssignmentsDisplay:function(){},getElById:function(id){return $("#"+this.baseId+"_"+id)},_onSnippetClick:function(info){var txt=this.getElById("replybox_txt");
var val=txt.val();if(val.length){val+=" "}val+=info.snippet;txt.val(val)},updateCount:function(num){if(num===undefined||num===null){num=this.selectionBar.getCount()
}this.countEl.text(num)},getActionFormValues:function(appendArray,isApply,info){appendArray=appendArray||[];
if(!info){info={}}info.actionsCount=0;if(this.wrapper.find("select.macro_id")[0]&&this.wrapper.find("select.macro_id").val()!="0"){appendArray.push({name:"run_macro_id",value:this.wrapper.find("select.macro_id").val()});
info.actionsCount=1;return appendArray}$("input, select, textarea",this.wrapper).filter('[name^="actions["], [name^="actions_set["]').each(function(){var val=$(this).val(),name=$(this).attr("name");
if(!val){val=""}if(val=="-1"){val=""}if($(this).is(":radio, :checkbox")){if(!$(this).is(":checked")){return
}}if(val===""){return}if(!isApply&&name=="actions[reply]"){return}appendArray.push({name:name,value:val});
info.actionsCount++});return appendArray},apply:function(){var formData,rows=[];var formDataInfo={checkedCount:0,actionsCount:0};
formData=this.selectionBar.getCheckedFormValues("result_ids[]",null,formDataInfo);this.selectionBar.getChecked().each(function(){rows.push($(this).closest(".row-item").get(0))
});this.getActionFormValues(formData,true,formDataInfo);if(!formDataInfo.checkedCount||!formDataInfo.actionsCount){return
}rows=$(rows);rows.addClass("loading");this.wrapper.addClass("loading");var statusUpdate=this.wrapper.find('input[name="actions[status]"]:checked').val();
DeskPRO_Window.util.ajaxWithClientMessages({url:BASE_URL+"agent/ticket-search/ajax-save-actions",type:"POST",data:formData,dataType:"json",context:this,complete:function(){rows.removeClass("loading")
},success:function(data){if(this.options.isListView){this.close();this.page.meta.pageReloader();return
}$(".preview-edit",this.listWrapper).removeClass("preview-edit");$(".preview-edit-hide",this.listWrapper).remove();
$(".row-item.changed, .prop-val.changed",this.listWrapper).removeClass("changed");this.wrapper.removeClass("loading");
this.close();this.fireEvent("postApply",[this,data,formDataInfo]);if(data&&data.failed_tickets&&data.failed_tickets.length){DeskPRO_Window.showAlert("Note: "+data.failed_tickets.length+" tickets were not updated because you do not have permission to make the requested changed.")
}if(statusUpdate==="hidden.deleted"||statusUpdate==="hidden.spam"){$.each(data.success_tickets,function(k,ticketId){var tab=DeskPRO_Window.getTabWatcher().findTab("ticket",function(tab){return(tab&&tab.page&&tab.page&&tab.page.meta.ticket_id==ticketId)
});if(tab){DeskPRO_Window.removePage(tab.page)}})}}})},clearPreview:function(){$(".preview-edit",this.listWrapper).remove();
$(".preview-edit-hide",this.listWrapper).show().removeClass("preview-edit-hide")},updatePreview:function(specific_id,force){if(!this.hasAnyChange&&!force){return
}if(this.options.isListView){return}if(this.runningAjax){this.runningAjax.abort();this.runningAjax=null
}var formData,rows=[];var formDataInfo={checkedCount:0,actionsCount:0};if(!specific_id){formData=this.selectionBar.getCheckedFormValues("result_ids[]",null,formDataInfo);
this.selectionBar.getChecked().each(function(){rows.push($(this).closest(".row-item").get(0))})}else{formData=[{name:"result_ids[]",value:specific_id}];
formDataInfo.checkedCount=1;rows=[$(".ticket-"+specific_id+".row-item").get(0)]}this.getActionFormValues(formData,false,formDataInfo);
if(!force&&(!formDataInfo.checkedCount||!formDataInfo.actionsCount)){}rows=$(rows);rows.addClass("loading");
var runningAjax=$.ajax({url:BASE_URL+"agent/ticket-search/get-page",type:"POST",data:formData,dataType:"html",context:this,complete:function(){rows.removeClass("loading");
this.runningAjax=null},success:function(html){this.updatePreviewDisplay(html)}});if(!specific_id){this.runningAjax=runningAjax
}},updatePreviewDisplay:function(html){var resultWrap=$(html);var listWrapper=this.listWrapper;$(".row-item",resultWrap).each(function(){var ticketId=$(this).data("ticket-id");
var row=$(".ticket-"+ticketId+".row-item",listWrapper);var existPrev=$(".preview-edit",row);existPrev.remove();
var topRowRight=$(".top-row-right",this).addClass("preview-edit");var extraFields=$(".extra-fields",this).addClass("preview-edit");
var origTopRowRight=$(".top-row-right",row).addClass("preview-edit-hide");var origExtraFields=$(".extra-fields",row).addClass("preview-edit-hide");
topRowRight.insertAfter(origTopRowRight);extraFields.insertAfter(origExtraFields);origTopRowRight.hide();
origExtraFields.hide()})},handleCheckChange:function(el,is_checked){var row=$(el).closest(".row-item");
if(is_checked){this.updatePreview(row.data("ticket-id"))}else{$(".preview-edit",row).remove();$(".preview-edit-hide",row).show().removeClass("preview-edit-hide")
}},updatePositions:function(){var pos=$("#dp_content").offset();var top=pos.top-4;var bottom=10;var height="";
var scrollContent=$(".scroll-content",this.wrapper).first();var contentH=false;var hasHeader=!!($("> section > header",this.wrapper).length);
var hasFooter=!!($("> section > footer",this.wrapper).length);if(scrollContent.length){contentH=scrollContent.height();
if(hasHeader){contentH+=36}if(hasFooter){contentH+=45}contentH+=31}if(hasHeader){$("> section > article",this.wrapper).removeClass("no-header")
}else{$("> section > article",this.wrapper).addClass("no-header")}if(hasFooter){$("> section > article",this.wrapper).removeClass("no-footer")
}else{$("> section > article",this.wrapper).addClass("no-footer")}if(contentH<350){contentH=350}var maxH=$(window).height()-top-10;
if(contentH&&contentH<maxH){bottom="";height=contentH}this.wrapper.css({top:pos.top-4,left:pos.left+8,right:3,bottom:bottom,height:height});
var leftEnd=269;var topEnd=50;var contentStart=pos.left;if(!this.options.isListView){this.backdropEls.eq(0).css({top:0,width:leftEnd,bottom:0,left:0});
this.backdropEls.eq(1).css({top:0,height:topEnd,width:contentStart-leftEnd,left:leftEnd});this.backdropEls.eq(2).css({top:0,right:0,bottom:0,left:contentStart})
}this.updateUi()},loadMacro:function(macro_id){var macroEl=$(".macro-options",this.wrapper);var inputActionsEl=$(".actions-input",this.wrapper);
macro_id=parseInt(macro_id);if(!macro_id){macroEl.hide();macroEl.find("ul.actions-list").empty();macroEl.find("input.macro_id").remove();
inputActionsEl.show();this.updateUi();this.updatePositions();return}var macroBtnEl=$("div.macro-load",this.wrapper).addClass("loading");
$.ajax({url:BASE_URL+"agent/ticket-search/ajax-get-macro-actions",data:{macro_id:macro_id},type:"GET",dataType:"json",context:this,success:function(data){inputActionsEl.hide();
macroEl.show();var input=$('<input type="hidden" class="macro_id" name="run_macro_id" />');input.val(macro_id);
input.appendTo(macroEl);var ul=macroEl.find("ul.actions-list");ul.empty();Array.each(data.descriptions,function(desc){var li=$("<li />");
li.html(desc);ul.append(li)});macroBtnEl.removeClass("loading");self.hasAnyChange=true;this.updateUi();
this.updatePositions()}});this.updatePositions()},isOpen:function(){if(!this._hasInit||!this.wrapper.is(".open")){return false
}return true},open:function(){if(!this.wrapper||!this.wrapper[0]){this._resetWrapper()}this._initOverlay();
this.updatePositions();DeskPRO_Window.layout.addEvent("resized",this.updatePositions,this);this.wrapper.addClass("open");
this.backdropEls.show();this.updateCount(null);this.wrapper.addClass("open").show();this.updatePositions()
},close:function(){if(!this.isOpen()){return false}DeskPRO_Window.layout.removeEvent("resized",this.updatePositions,this);
this.wrapper.removeClass("open");this.backdropEls.hide();this.fireEvent("closed",[this]);this.clearPreview();
if(this.options.resetOnClose){this.reset()}},destroy:function(){if(this._hasInit){this.wrapper.remove();
this.backdropEls.remove()}if(this.wrapperContainer){this.wrapperContainer.remove()}if(this.textarea&&this.textarea.data("redactor")){this.textarea.redactor("destroy")
}}});Orb.createNamespace("DeskPRO.Agent.PageHelper");DeskPRO.Agent.TicketList.ListView=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(page,options){var self=this;
this.page=page;this.options={};this.setOptions(options);this.page.addEvent("destroy",(function(){this.destroy()
}).bind(this))},_initOverlay:function(){var self=this;if(this._isIniting){return}if(this._hasInit){return
}this._isIniting=true;var new_url=this.page.meta.viewTypeUrl.replace("$view_type","list");if(this.options.load_url){new_url=this.options.load_url.replace("$view_type","list")
}this.wrapper=$('<div class="dp-overlay-container ticketlist" />').appendTo("body");this.backdropEl=$('<div class="backdrop dp-overlay-backdrop" />');
this.backdropEl.css("z-index","10000").hide().appendTo("body");this.backdropEl.on("click",(function(ev){ev.stopPropagation();
this.close()}).bind(this));this.wrapper.html('<section class="dp-overlay"><div class="overlay-title"><span class="close-overlay"></span></div><div class="loading"></div></section>');
this.wrapper.find(".close-overlay").on("click",function(ev){ev.stopPropagation();self.close()});this.updatePositions();
this.wrapper.addClass("open");this.backdropEl.show();this.runningAjax=$.ajax({url:new_url,dataType:"html",context:this,done:function(){this.runningAjax=null
},success:function(html){this.wrapper.html(html);$("header .close-trigger",this.wrapper).first().on("click",(function(ev){ev.stopPropagation();
ev.preventDefault();this.close()}).bind(this));var page=DeskPRO_Window.createPageFragment(html);page.listview=this;
page.setMetaData("routeUrl",new_url);page.setMetaData("pageReloader",this.reload.bind(this));page.setMetaData("overlay",this);
page.fireEvent("render",[this.wrapper]);page.fireEvent("activate");this._isIniting=false;this._hasInit=true;
this.fireEvent("ajaxLoaded",[this]);this.open()}})},reload:function(){this.showInnerLoading();var page=this.page;
window.setTimeout(function(){if(page&&page.switchViewType){page.switchViewType("list")}},50)},open:function(){this._initOverlay();
if(!this._hasInit){return}this.updatePositions();this.wrapper.addClass("open");this.backdropEl.show();
$("body").addClass("print-overlay");this.fireEvent("opened",[this])},isOpen:function(){if(!this._hasInit||!this.wrapper.is(".open")){return false
}return true},close:function(){if(!(this._hasInit||this._isIniting||this.isOpen())){return}$("body").removeClass("print-overlay");
this.destroy()},showInnerLoading:function(){$(".full-loading",this.wrapper).show()},hideInnerLoading:function(){$(".full-loading",this.wrapper).hide()
},updatePositions:function(){this.wrapper.css({top:20,right:20,bottom:20,left:20})},destroy:function(){if(this._isIniting){this.runningAjax.abort();
this.runningAjax=null;this._isIniting=false}if(this._hasInit){this.page.destroy()}if(this.wrapper){this.wrapper.remove()
}if(this.backdropEl){this.backdropEl.remove()}delete this.wrapper;delete this.backdropEl;delete this.options;
delete this.page}});Orb.createNamespace("DeskPRO.Agent.PageHelper.PeopleList");DeskPRO.Agent.PageHelper.PeopleList.ListView=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(page,options){var self=this;
this.page=page;this.options={};this.setOptions(options);this.page.addEvent("destroy",(function(){this.destroy()
}).bind(this))},_initOverlay:function(){var self=this;if(this._isIniting){return}if(this._hasInit){return
}this._isIniting=true;var new_url=this.page.meta.viewTypeUrl.replace("$view_type","list");if(this.options.load_url){new_url=this.options.load_url.replace("$view_type","list")
}this.wrapper=$('<div class="dp-overlay-container ticketlist" />').appendTo("body");this.backdropEl=$('<div class="backdrop dp-overlay-backdrop" />');
this.backdropEl.css("z-index","10000").hide().appendTo("body");this.backdropEl.on("click",(function(ev){ev.stopPropagation();
this.close()}).bind(this));this.wrapper.html('<section class="dp-overlay"><div class="overlay-title"><span class="close-overlay"></span></div><div class="loading"></div></section>');
this.wrapper.find(".close-overlay").on("click",function(ev){ev.stopPropagation();self.close()});this.updatePositions();
this.wrapper.addClass("open");this.backdropEl.show();this.runningAjax=$.ajax({url:new_url,dataType:"html",context:this,done:function(){this.runningAjax=null
},success:function(html){this.wrapper.html(html);$("header .close-trigger",this.wrapper).first().on("click",(function(ev){ev.stopPropagation();
ev.preventDefault();this.close()}).bind(this));var page=DeskPRO_Window.createPageFragment(html);page.listview=this;
page.setMetaData("routeUrl",new_url);page.setMetaData("pageReloader",this.reload.bind(this));page.setMetaData("overlay",this);
page.fireEvent("render",[this.wrapper]);page.fireEvent("activate");this._isIniting=false;this._hasInit=true;
this.fireEvent("ajaxLoaded",[this]);this.open()}})},reload:function(){this.showInnerLoading();var page=this.page;
window.setTimeout(function(){if(page&&page.switchViewType){page.switchViewType("list")}},50)},open:function(){this._initOverlay();
if(!this._hasInit){return}this.updatePositions();this.wrapper.addClass("open");this.backdropEl.show();
$("body").addClass("print-overlay");this.fireEvent("opened",[this])},isOpen:function(){if(!(this._hasInit||this.wrapper.is(".open"))){return false
}return true},close:function(){if(!(this._hasInit||this._isIniting||this.isOpen())){return}$("body").removeClass("print-overlay");
this.destroy()},showInnerLoading:function(){$(".full-loading",this.wrapper).show()},hideInnerLoading:function(){$(".full-loading",this.wrapper).hide()
},updatePositions:function(){this.wrapper.css({top:20,right:20,bottom:20,left:20})},destroy:function(){if(this._isIniting){this.runningAjax.abort();
this.runningAjax=null;this._isIniting=false}if(this._hasInit){this.page.destroy()}if(this.wrapper){this.wrapper.remove()
}if(this.backdropEl){this.backdropEl.remove()}delete this.wrapper;delete this.backdropEl;delete this.options;
delete this.page}});Orb.createNamespace("DeskPRO.Agent.TicketList");DeskPRO.Agent.TicketList.ChangeManager=new Class({Implements:[Events],ticketPage:null,hasChanges:false,changes:{},ticketIdsBatch:null,initialize:function(ticketPage){this.ticketPage=ticketPage
},begin:function(ticketIds){this.ticketIdsBatch=ticketIds},addChange:function(property,newValue){var name=property.getName();
var id=property.getTicketId();if(property.isSameValue(newValue)){return}if(!this.changes[id]){this.changes[id]=[]
}var info={"property":property,"newValue":newValue,"hasApplied":false};this.changes[id].push(info);this.hasChanges=true
},applyChangeForEntry:function(info){var property=info.property;var name=property.getName();var id=property.getTicketId();
info.oldValue=property.getValue();property.setValue(info.newValue);property.highlightInterfaceElement();
info.hasApplied=true},applyChanges:function(){if(!this.ticketIdsBatch){return}$("tr:not(.on, .line-3)",this.ticketPage.contentWrapper).addClass("faded");
$("tr.on").removeClass("faded");$("table:first",this.ticketPage.contentWrapper).addClass("preview-mode");
Array.each(this.ticketIdsBatch,function(ticketId){Array.each(this.changes[ticketId],function(change){this.applyChangeForEntry(change)
},this)},this);this.ticketIdsBatch=null},revertChangeForEntry:function(info){var property=info.property;
if(info.hasApplied&&info.oldValue!==undefined){property.setValue(info.oldValue);property.unhighlightInterfaceElement()
}},revertChanges:function(){Object.each(this.changes,function(changes,ticketId){Array.each(changes,function(change){this.revertChangeForEntry(change)
},this)},this);this.ticketIdsBatch=null;this.changes={};this.hasChanges=false;this.fireEvent("changesCleared")
},revertChangesForTicketId:function(ticketId){if(!this.changes[ticketId]){return}Array.each(this.changes[ticketId],function(change){this.revertChangeForEntry(change)
},this);var lines=$("tr.ticket-"+ticketId,this.ticketPage.contentWrapper);lines.filter("tr.line-3").hide().find("td > ul").html("");
lines.filter(":not(.line-3)").addClass("faded").removeClass("with-line-3");delete this.changes[ticketId];
if(Object.getLength(this.changes)==0){this.revertChanges()}},commitChanges:function(){Array.each(Object.values(this.changes),function(changes){Object.each(changes,function(change){var property=change.property;
property.unhighlightInterfaceElement()},this)},this);this.ticketIdsBatch=null;this.changes={};this.hasChanges=false;
this.fireEvent("changesCleared")},setPropertyUpdated:function(property,newValue){if(typeOf(property)=="string"){property=this.ticketPage.getPropertyManager(property)
}property.setIncomingValue(newValue);property.pulseInterfaceElement()}});Orb.createNamespace("DeskPRO.Agent.TicketList.Property");
DeskPRO.Agent.TicketList.Property.Abstract=new Class({Implements:[Events,Options],displayNameType:null,displayCaption:null,options:{},ticketPage:null,ticketId:null,initialize:function(ticketPage,ticketId,options){if(options){this.setOptions(options)
}this.ticketPage=ticketPage;this.ticketId=ticketId;this.init()},init:function(){},getName:function(){},getTicketId:function(){return this.ticketId
},isSameValue:function(compare){if(this.getValue()==compare){return true}return false},getValue:function(){},setValue:function(value){},setIncomingValue:function(value){this.setValue(value)
},getInterfaceElement:function(){if(this._interfaceEl!==null){return this._interfaceEl}this._interfaceEl=this._getInterfaceElement();
return this._interfaceEl},_interfaceEl:null,_getInterfaceElement:function(){},_buildSelector:function(base_sel){sel="tr.ticket-"+this.ticketId+" "+base_sel;
return sel},getSublineElement:function(){var line2=$("tr.ticket-"+this.ticketId+".line-2",this.ticketPage.actionsBarHelper.tableEl);
line2.addClass("with-line-3");var line3=$("tr.ticket-"+this.ticketId+".line-3",this.ticketPage.actionsBarHelper.tableEl);
line3.show();var ul=$("ul",line3);var li=$('<li class="generated prop-value '+this.getName()+'"></li>');
ul.append(li);return li},pulseInterfaceElement:function(){this.getInterfaceElement().effect("highlight",1200)
},highlightInterfaceElement:function(){this.getInterfaceElement().addClass("change-on")},unhighlightInterfaceElement:function(){this.getInterfaceElement().removeClass("change-on")
}});Orb.createNamespace("DeskPRO.Agent.TicketList.Property");DeskPRO.Agent.TicketList.Property.StandardOption=new Class({Extends:DeskPRO.Agent.TicketList.Property.Abstract,optionName:null,init:function(){var valid_options=["department","category","product","priority","workflow","status","agent","agent_team"];
if(valid_options.indexOf(this.options.optionName)==-1){throw"invalidOptionName:"+this.options.optionName
}this.optionName=this.options.optionName;switch(this.optionName){case"department":this.displayNameType="department_full";
this.displayCaption="Department";break;case"category":this.displayNameType="ticket_category_full";this.displayCaption="Category";
break;case"product":this.displayNameType="product";this.displayCaption="Product";break;case"priority":this.displayNameType="ticket_priority";
this.displayCaption="Priority";break;case"workflow":this.displayNameType="ticket_workflow";this.displayCaption="Workflow";
break;case"status":this.displayNameType="status";this.displayCaption="Status";break;case"agent":this.displayNameType="agent";
this.displayCaption="Agent";break;case"agent_team":this.displayNameType="agent_team";this.displayCaption="Agent Team";
break}},getValue:function(){return this.getInterfaceElement().data("prop-value")},getName:function(){return this.optionName
},setValue:function(value){if(value=="0"){value=0}this.getInterfaceElement().data("prop-value",value);
if(value){var displayName=value;if(this.displayNameType){displayName=DeskPRO_Window.getDisplayName(this.displayNameType,value);
if(!displayName){displayName=value}}var text=displayName;if(this.getInterfaceElement().is(".generated")){var text=this.displayCaption+": "+displayName
}this.getInterfaceElement().removeClass("no-value").text(text)}else{this.getInterfaceElement().addClass("no-value").text("none")
}},_getInterfaceElement:function(){var el=$(this._buildSelector(".prop-val."+this.optionName+":first"),this.ticketPage.actionsBarHelper.tableEl);
if(!el.length){el=this.getSublineElement()}return el}});Orb.createNamespace("DeskPRO.Agent.TicketList.Property");
DeskPRO.Agent.TicketList.Property.NewReply=new Class({Extends:DeskPRO.Agent.TicketList.Property.Abstract,displayCaption:"Reply",getName:function(){return"new_reply"
},isSameValue:function(compare){return false},getValue:function(){return null},setValue:function(value){if(value){var text=value;
this.getInterfaceElement().removeClass("no-value").text(text)}},setIncomingValue:function(value){},_getInterfaceElement:function(){el=this.getSublineElement();
return el}});Orb.createNamespace("DeskPRO.Agent.TicketList.Property");DeskPRO.Agent.TicketList.Property.TicketField=new Class({Extends:DeskPRO.Agent.TicketList.Property.Abstract,optionName:null,init:function(){this.optionName="ticket_field."+this.options.fieldId
},getName:function(){return this.optionName},getValue:function(){return this.getInterfaceElement().html()
},setValue:function(value){this.getInterfaceElement().html(value)},_getInterfaceElement:function(){var el=$(".prop-val .custom-field-"+this.options.fieldId,this.ticketPage.actionsBarHelper.tableEl);
if(!el.length){el=this.getSublineElement()}return el}});Orb.createNamespace("DeskPRO.Agent.TicketList.Property");
DeskPRO.Agent.TicketList.Property.Flag=new Class({Extends:DeskPRO.Agent.TicketList.Property.Abstract,optionName:"flag",displayCaption:"Flag",init:function(){},getValue:function(){return this.getInterfaceElement().data("flag")
},getName:function(){return this.optionName},setValue:function(value){var last_value=this.getInterfaceElement().data("flag");
this.getInterfaceElement().data("flag",value);this.getInterfaceElement().removeClass("icon-flag-"+last_value).addClass("icon-flag-"+value)
},_getInterfaceElement:function(){var el=$(this._buildSelector(".ticket-flag:first"),this.ticketPage.actionsBarHelper.tableEl);
return el}});Orb.createNamespace("DeskPRO.Agent.TicketList.Property");DeskPRO.Agent.TicketList.Property.Labels=new Class({Extends:DeskPRO.Agent.TicketList.Property.Abstract,optionName:"labels",displayCaption:"Flag",mode:"add",init:function(){this.mode=this.options.mode;
if(this.mode=="add"){this.displayCaption="Add Labels"}else{this.displayCaption="Remove Labels"}},isSameValue:function(compare){return false
},getName:function(){return this.mode+"_"+this.optionName},getValue:function(){return this._values},_values:null,setValue:function(values){this._values=values;
var text=this.displayCaption+": ";Array.each(values,function(val){text+=" "+val},this);this.getInterfaceElement().text(text)
},_getInterfaceElement:function(){var el=this.getSublineElement();return el}});Orb.createNamespace("DeskPRO");
DeskPRO.BasicWindow=new Orb.Class({Implements:[Orb.Util.Options],initialize:function(options){$("html").addClass("window-active");
window.setTimeout(function(){$("html").addClass("window-active")},1000);var _winshow=function(){$(document).trigger("windowshow");
$("html").addClass("window-active")};var _winhide=function(){$(document).trigger("windowhide");$("html").removeClass("window-active")
};if(
/*@cc_on!@*/
false){document.onfocusin=_winshow;document.onfocusout=_winhide}else{window.onfocus=_winshow;
window.onblur=_winhide}window.onpageshow=_winshow();window.onpagehide=_winhide();this.DEBUG={};this.options=this.getDefaultOptions();
this.registry={};this.messageBroker=new DeskPRO.MessageBroker();this.translate=new DeskPRO.Translate();
if(options){this.setOptions(options)}this.init()},init:function(){},initPage:function(){},getDefaultOptions:function(){return{}
},getTranslate:function(){return this.translate},get:function(id,def){if(this.registry[id]===undefined){return def
}return this.registry[id]},set:function(id,value){this.registry[id]=value},getMessageBroker:function(){return this.messageBroker
},getDebug:function(name){if(this.DEBUG[name]===undefined){return false}return this.DEBUG[name]}});Orb.createNamespace("DeskPRO.Agent");
DeskPRO.Agent.Window=new Orb.Class({Extends:DeskPRO.BasicWindow,init:function(){this.onloadStack=[];this.dismissAlertQueue=[];
this.routePrefixes={};this.messageChanneler=null;this.poller=null;this.sections={};this.openSection=null;
this.listPage=null;this.innerLayout=null;this._alertOverlay=null;this._confirmOverlay=null;this.loadingIndicatorEl=null;
this.loadingIndicatorCount=0;this.ajaxErrorOverlay=null;this.cancelHashLoad=0;this.activeListNav=null;
this.activityTime=new Date();this.agentNotifyListShown=false;this.paneVis={source:true,list:true,tabs:true};
this.util={modCountEl:function(el,op,num){el=$(el);if(!num&&num!==0){num=1}var count=parseInt(el.text().trim());
if(op=="-"||op=="rem"||op=="del"||op=="sub"){count-=num;if(count<0){count=0}}else{if(op=="+"||op=="add"){count+=num
}else{count=num}}el.text(count);if(el.data("tag")){$("i."+el.data("tag")).text(count)}return count},getPlainTpl:function(el){if(!el){DP.console.error("Invalid template element passed %o",el);
return""}var el=$(el);if(!el.length){DP.console.error("No template element passed %o",el);return""}var html=el.get(0).innerHTML;
html=html.replace(/%startScript%/g,"<script>");html=html.replace(/%endScript%/g,"<\/script>");html=html.replace(/%scriptWord%/g,"script");
var uid=Orb.uuid();html=html.replace(/%baseId%/g,uid);var baseId=Orb.uuid();html=html.replace(/%baseId%/g,baseId);
return html},showSavePuff:function(overEl){if(!overEl||!overEl[0]){return}var pos=overEl.offset();if(!pos){return
}var el=$('<div class="load-puff" style="display: none; opacity: 0" />');el.appendTo("body");el.css({top:pos.top+15,left:pos.left+overEl.width()-4});
var endPos1=pos.top-5;var endPos2=pos.top-15;el.show();el.animate({top:endPos1,opacity:1},200,"swing",function(){window.setTimeout(function(){el.animate({top:endPos2,opacity:0},200,"swing",function(){el.remove()
})},225)})},ajaxWithClientMessages:function(options){if(!options.data){options.data=[]}if(!options.data.push){var newData=[];
Object.each(options.data,function(v,k){newData.push({name:k,value:v})});options.data=newData}options.data.push({name:"client_messages_since",value:DeskPRO_Window.getLastClientMessageId()});
var old_success=function(){};if(options.success){if(options.context){old_success=options.success.bind(options.context)
}else{old_success=options.success}}var old_complete=function(){};if(options.complete){if(options.context){old_complete=options.complete.bind(options.context)
}else{old_complete=options.complete}}options.complete=function(){DeskPRO_Window.getMessageChanneler().poller.unpause();
old_complete()};options.success=function(data){DeskPRO_Window.getMessageChanneler().poller.unpause();
if(options.execSuccessBefore){old_success(data)}if(data.client_messages){DeskPRO_Window.getMessageChanneler().handleMessageAjax(data.client_messages)
}if(!options.execSuccessBefore){old_success(data)}};options.dataType="json";DeskPRO_Window.getMessageChanneler().poller.pause();
return $.ajax(options)},slugify:function(str){str=str.replace(/[^a-zA-Z0-9\-]/g,"-");str=str.replace(/\-{2,}/g,"-");
str=str.replace(/^\-/,"");str=str.replace(/\-$/,"");return str},linkUrls:function(string){string=string||"";
string=Orb.linkUrls(string);string=string.replace(/<a /g,'<a target="_blank" ');return string},dpCheckbox:function(input){if(!input.attr("id")){input.attr("id",Orb.getUniqueId("dp_chk"))
}var id=input.attr("id");input.hide().addClass("with-dp-checkbox");var check=$('<span class="dp-checkbox" data-bound="#'+id+'" />');
check.attr("id",Orb.getUniqueId("dp_chk"));if(input.is(":checked")){check.addClass("checked")}input.data("bound","#"+check.attr("id"));
check.insertAfter(input);input.on("change",function(ev){if($(this).is(":checked")){check.addClass("checked")
}else{check.removeClass("checked")}});check.on("click",function(ev){ev.stopPropagation();if(input.is(":checked")){$(this).addClass("checked")
}else{$(this).removeClass("checked")}})},fileupload:function(el,options){var setel;if(!options){options={}
}if(options.page){options.namespace=options.page.OBJ_ID+"_fileupload"}if(!options.namespace){options.namespace=Orb.uuid()
}if(!options.dropZone){options.dropZone=$(el)}if(typeof options.autoUpload=="undefined"){options.autoUpload=true
}if(!options.url){if(options.saveMedia){options.url=BASE_URL+"agent/misc/accept-upload?save_media=1"}else{options.url=BASE_URL+"agent/misc/accept-upload"
}}if(options.uploadTemplate){var setel=options.uploadTemplate}else{var setel=$(".template-upload",el)
}if(!setel||!setel[0]){console.error("Invalid uploadTemplate");return $(el)}if(!setel.attr("id")){var id=Orb.getUniqueId("up");
setel.attr("id",id)}else{var id=setel.attr("id")}delete (options.uploadTemplate);options.uploadTemplateId=id;
if(options.downloadTemplate){var setel=options.downloadTemplate}else{var setel=$(".template-download",el)
}if(!setel||!setel[0]){console.error("Invalid downloadTemplate");return $(el)}if(!setel.attr("id")){var id=Orb.getUniqueId("up");
setel.attr("id",id)}else{var id=setel.attr("id")}delete (options.downloadTemplate);options.downloadTemplateId=id;
if(!options.filesContainer){options.filesContainer=$(el).find(".files")}options.start=function(){$(el).find(".error").remove();
options.filesContainer.show()};options.done=function(e,data){var that=$(this).data("fileupload"),template,preview;
if(!that){return}if(data.context){data.context.each(function(index){var file=($.isArray(data.result)&&data.result[index])||{error:"emptyResult"};
if(file.error&&that._adjustMaxNumberOfFiles){that._adjustMaxNumberOfFiles(1)}that._transition($(this)).done(function(){var node=$(this);
template=that._renderDownload([file]).css("height",node.height()).replaceAll(node);that._forceReflow(template);
that._transition(template).done(function(){data.context=$(this);that._trigger("completed",e,data)})})
})}else{template=that._renderDownload(data.result).appendTo(that.options.filesContainer);that._forceReflow(template);
that._transition(template).done(function(){data.context=$(this);that._trigger("completed",e,data)})}};
options.stop=function(e){var that=$(this).data("fileupload");if(!that){return}that._transition($(this).find(".fileupload-buttonbar .progress")).done(function(){$(this).find(".bar").css("width","0%");
that._trigger("stopped",e)})},$(el).on("click",".remove-attach-trigger",function(ev){if($(this).hasClass("delete")){return
}ev.preventDefault();var clicked=$(this),li=clicked.closest("li");li.slideUp("fast",function(){clicked.remove();
if(options.filesContainer.hasClass("dp-hide-empty")){options.filesContainer.hide()}});el.trigger("fileremoved",[li])
});return $(el).fileupload(options)},updateUserEmailAddressDisplay:function(person_id,email){var sel=$("b.pemail-"+person_id);
var mode="chance";if(!email||!email.length){mode="hide"}sel.each(function(){var el=$(this);var hideEl=el;
if(el.data("hide")&&el.data("hide")=="@parent"){hideEl=el.parent()}if(mode=="chance"){hideEl.show();el.text(email)
}else{el.text("");hideEl.hide()}})},reloadInterface:function(){$("#reload_overlay").show().on("click",function(ev){ev.stopPropagation()
});window.location.reload(false)}}},initPage:function(){var startHash=window.location.hash+"";startHash=startHash.substring(1);
var loadNewTicket=false;if(loadNewTicket=window.location.hash.match(/#newticket:(\d+)/)){loadNewTicket=loadNewTicket[1]
}var loadSearchTerm=false;if(loadSearchTerm=window.location.hash.match(/#q:(.*?)$/)){loadSearchTerm=loadSearchTerm[1]
}var loadVis=false;if(loadVis=window.location.hash.match(/vis:([0-5]{1})/)){loadVis=parseInt(loadVis[1])
}$.fn.qtip.zindex=999999999;if(!$("html").hasClass("browser-ie")){$(document).bind("drop dragover",function(e){e.preventDefault()
});$(document).bind("dragover",function(e){var timeout=window.dropZoneTimeout;if(!timeout){$("body").addClass("file-drag-over")
}else{clearTimeout(timeout)}window.dropZoneTimeout=setTimeout(function(){window.dropZoneTimeout=null;
$("body").removeClass("file-drag-over")},100)})}$("html").addClass("dp");this._initLayout();this._initWindowInterface();
this._initBasic();this._initRoutes();this._initSections();this._initInterfaceServices();if(window.DESKPRO_SNIPPETS_USE_CLIENT_DB){this.ticketSnippetDriver=new DeskPRO.Agent.TextSnippetClientDbDriver("tickets");
this.chatSnippetDriver=new DeskPRO.Agent.TextSnippetClientDbDriver("chat")}else{this.ticketSnippetDriver=new DeskPRO.Agent.TextSnippetAjaxDriver("tickets");
this.chatSnippetDriver=new DeskPRO.Agent.TextSnippetAjaxDriver("chat")}if(window.devicePixelRatio&&window.devicePixelRatio>=2){$("body").addClass("dp-is-retina")
}$("#dp_loading").remove();$("#page_loading").remove();$("#loading_css").remove();if(!window.DeskPRO_FragmentRouter){DP.console.warn("window.DeskPRO_FragmentRouter is missing. Using empty router.");
window.DeskPRO_FragmentRouter={baseUrl:"",setBaseUrl:function(x){this.baseUrl=x},hasFragment:function(){return false
},getFragmentPattern:function(){return""},getFragmentType:function(){return""},getUrl:function(){return""
},getUrlNamedArgs:function(){return""}}}this.fragmentRouter=window.DeskPRO_FragmentRouter;this.fragmentRouter.setBaseUrl(BASE_URL);
var self=this;this.hashInitial=false;$.history.init(function(hash){if(!self.hashInitial){self.hashInitial=true;
return}self.loadHashPath(hash)},{unescape:",/:"});if(!this.openSection){this.switchToSection($("#dp_nav [data-section-handler]").first().attr("id"))
}this.messageChanneler.poller.send();if(DESKPRO_TIME_OUT_OF_SYNC){DESKPRO_TIME_OUT_OF_SYNC=false;$.ajax({url:BASE_URL+"agent/misc/get-server-time",dataType:"json",success:function(data){$("#time_outofsync").find(".server_time").text(data.time_formatted);
var now_ts=((new Date()).getTime()/1000)-(new Date().getTimezoneOffset()*60);var diff=Math.abs(now_ts-data.timestamp);
if(diff>1200){DESKPRO_TIME_OUT_OF_SYNC=diff;console.log("(Recheck) Time is off by %s seconds",diff);if(DESKPRO_TIME_OUT_OF_SYNC_IGNORE&&Math.abs(diff-DESKPRO_TIME_OUT_OF_SYNC_IGNORE)<480){DESKPRO_TIME_OUT_OF_SYNC=null;
console.log("(Recheck) Time offset is ignored")}}if(DESKPRO_TIME_OUT_OF_SYNC){$("#time_outofsync").trigger("dp_open")
}}})}var fn;while(fn=this.onloadStack.shift()){fn()}$("#user_settings_link_profile").on("click",function(ev){ev.preventDefault();
$("#settingswin").trigger("dp_open","profile")});$("#user_settings_link_signature").on("click",function(ev){ev.preventDefault();
$("#settingswin").trigger("dp_open","signature")});$("#user_settings_link_ticketnotify").on("click",function(ev){ev.preventDefault();
$("#settingswin").trigger("dp_open","ticket-notify")});$("#user_settings_link_othernotify").on("click",function(ev){ev.preventDefault();
$("#settingswin").trigger("dp_open","notify")});$("#user_settings_link_macros").on("click",function(ev){ev.preventDefault();
$("#settingswin").trigger("dp_open","macros")});$("#user_settings_link_filters").on("click",function(ev){ev.preventDefault();
$("#settingswin").trigger("dp_open","filters")});$("#user_settings_link_snippets").on("click",function(ev){ev.preventDefault();
var currentTab=DeskPRO_Window.TabBar.getActiveTab();if(currentTab&&currentTab.page&&currentTab.page.TYPENAME&&currentTab.page.TYPENAME=="ticket"){currentTab.page.shortcutOpenSnippets()
}else{var snippetsViewer=new DeskPRO.Agent.Widget.SnippetViewer({viewUrl:$(this).data("snippet-viewer-url"),destroyOnClose:true,onSnippetClick:function(evData){evData.cancelClose=true;
evData.snippetEl.find(".edit-trigger").click()}});snippetsViewer.open()}});$("#dp_nav_sections").find("ul").find("li").find("a").each(function(){$(this).qtip({position:{my:"left center",at:"right center",target:$(this)},content:{attr:"title"},style:{classes:"qtip-dark qtip-rounded"}})
});$(".panevis-switcher").find("li").each(function(){$(this).qtip({position:{my:"top center",at:"bottom center",target:$(this)},content:{attr:"title"},style:{classes:"qtip-dark qtip-rounded"}})
});$(document).on("click",".click-confirm",function(ev){if(!confirm($(this).data("confirm"))){ev.preventDefault()
}});$(document).on("click",".twitter-user-find",function(ev){var name=$(this).data("name");if(name.indexOf("@")!=0){name="@"+name
}if(name.length>1){ev.preventDefault();$.ajax({url:BASE_URL+"agent/twitter/user/find",data:{name:name},type:"GET",dataType:"json",success:function(data){if(data.success){var route="page:"+data.url;
DeskPRO_Window.runPageRoute(route)}else{alert("There is no Twitter user named "+name)}}})}});$(document).on("click mousemove keypress",function(){self.activityTime=new Date()
});if(document.getElementById("notice_trigger")){this._noticeIndex=-1;this._noticeIds=$("#notice_trigger").data("ids").split(",");
$("#notice_trigger").on("click",function(ev){ev.preventDefault();ev.stopPropagation();self.openNotices()
})}$("#dp_source, #dp_left_collapsed").on("click",".toggle_source_pane",function(ev){ev.preventDefault();
DeskPRO_Window.setPaneVis("source",!DeskPRO_Window.paneVis.source)});$("#dp_list, #dp_left_collapsed").on("click",".toggle_list_pane",function(ev){ev.preventDefault();
DeskPRO_Window.setPaneVis("list",!DeskPRO_Window.paneVis.list)});$("#dp_right_collapsed").on("click",function(ev){ev.preventDefault();
DeskPRO_Window.setPaneVis("tabs",true)});$("#dp_nav_sections").on("click",function(){if(!self.paneVis["source"]){self.paneVis["source"]=true;
self.layout.doResize(true)}});$(document).on("click",".panevis-toggle-sourcepane",function(){self.paneVis["source"]=!self.paneVis["source"];
self.layout.doResize(true)});$(document).on("click",".panevis-toggle-tableview",function(){self.paneVis["list"]=true;
self.paneVis["tabs"]=false;self.layout.doResize(true)});$(document).on("click",".panevis-toggle-normalview",function(){self.paneVis["list"]=true;
self.paneVis["tabs"]=true;self.layout.doResize(true)});$(document).on("click",".panevis-toggle-tabview",function(){self.paneVis["list"]=false;
self.paneVis["tabs"]=true;self.layout.doResize(true)});$("#dp_list").on("click",".maximise_list_pane",function(ev){ev.preventDefault();
if(!DeskPRO_Window.paneVis.source&&!DeskPRO_Window.paneVis.tabs){DeskPRO_Window.setPaneVis("source",true,"tabs",true)
}else{DeskPRO_Window.setPaneVis("source",false,"tabs",false)}});$("#tabNavigationPane .maximise_tabs_pane").on("click",function(ev){ev.preventDefault();
if(!DeskPRO_Window.paneVis.source&&!DeskPRO_Window.paneVis.list){DeskPRO_Window.setPaneVis("source",true,"list",true)
}else{DeskPRO_Window.setPaneVis("source",false,"list",false)}});$("#dp_header_userchat_btn").on("click",function(){if(DeskPRO_Window.sections.chat_section){DeskPRO_Window.sections.chat_section.refreshOnlineUsers()
}var wrap=$(this).parent();wrap.addClass("active");var closeFn=function(){wrap.removeClass("active")};
Orb.shimClickCallback(closeFn,"zindex-chrome0")});var isIe=$("html").hasClass("browser-ie");$("#dp_header").find(".btn-group-actions").find(".btn").on("click",function(){var wrap=$(this).parent();
var btnMenu=wrap.find(".btn-menu");if(isIe){btnMenu.css("opacity",0)}wrap.addClass("active");Orb.Util.TimeAgo.refreshElements(wrap.find("time").toArray());
if(isIe){window.setTimeout(function(){btnMenu.find("li").css("display","block");btnMenu.css("opacity",1)
},10)}var closeFn=function(){wrap.removeClass("active")};if(!wrap.data("has-init")){btnMenu.on("click",function(ev){Orb.cancelEvent(ev);
Orb.shimClickCallbackPop()})}Orb.shimClickCallback(closeFn,"zindex-chrome0");if($(this).hasClass("dp-recent-btn")){DeskPRO_Window.recentTabs.idW=0;
var maxw=0;DeskPRO_Window.recentTabs.list.find("strong").each(function(){var w=$(this).width();if(w>maxw){maxw=w
}});DeskPRO_Window.recentTabs.idW=maxw;DeskPRO_Window.recentTabs.list.find("strong").css("min-width",maxw);
$("#recent_tabs_list_filter").focus();$("#recent_tabs_list").parent().scrollTop(0)}});$("#dp_header_help_trigger").on("click",function(ev){ev.preventDefault();
var wrap=$("#dp_header_help");wrap.addClass("active");var closeFn=function(){wrap.removeClass("active")
};if(!wrap.data("has-init")){wrap.find(".btn-menu").on("click",function(ev){Orb.cancelEvent(ev);Orb.shimClickCallbackPop()
})}Orb.shimClickCallback(closeFn,"zindex-chrome0")});$("#dp_header_notify_wrap").find("> ul > li").on("click",function(){var wrap=$(this);
wrap.addClass("active");Orb.Util.TimeAgo.refreshElements(wrap.find("time").toArray());var closeFn=function(){wrap.removeClass("active");
Orb.shimClickCallbackPop()};if(!wrap.data("has-init")){wrap.find("ul").on("click",function(ev){closeFn()
})}Orb.shimClickCallback(closeFn,"zindex-chrome0")});if(loadNewTicket){DeskPRO_Window.newTicketLoader.open(function(page){var data={person_id:loadNewTicket};
page.setNewByPerson(data)})}if(loadSearchTerm){$("#dp_search_box").focus().val(decodeURIComponent(loadSearchTerm)).trigger("keypress")
}if(loadVis){this.layout.enableHashUpdate=false;this.setPaneVisNum(loadVis);this.layout.enableHashUpdate=true
}this.cancelHashLoad=0;this.loadHashPath(startHash)},addOnloadFunction:function(fn){this.onloadStack.push(fn)
},loadHashPath:function(browserHash,force){if(this.DEBUG.disableUrlFragments){return}if(this.cancelHashLoad>0){this.cancelHashLoad--;
if(this.cancelHashLoad<0){this.cancelHashLoad=0}if(!force){return}}if(!browserHash.length){return}if(browserHash.indexOf("%")!==-1){browserHash=decodeURIComponent(browserHash)
}var segments=browserHash.split(",");var activateSection=null;var activateTabId=null;var firstTabId=null;
var activateSettings=null;DeskPRO_Window.TabBar.options.activateNew=false;Array.each(segments,function(hash,i){var m;
if(m=hash.match(/app\.([a-zA-Z]+)/)){activateSection=m[1];return}if(m=hash.match(/settings\.([a-zA-Z0-9-]+)/)){activateSettings=m[1];
return}var isOpen=false;if(hash.match(/\.o:/)){isOpen=true;hash=hash.replace(/\.o:/,":")}var tabId=DeskPRO_Window.TabBar.findTabByFragment(hash);
if(tabId){tabId=tabId.id;if(isOpen){activateTabId=tabId}else{if(!firstTabId){firstTabId=tabId}}return
}var listPage=this.getCurrentListPage();if(listPage&&listPage.getMetaData("url_fragment")==hash){return
}var parts=hash.match(/^(.*?)(\.(.*?))?:(.*?)$/);if(!parts){return}var tabId=null;if(parts[3]){var tabId=parts[3]
}var fragmentName=parts[1];var args=parts[4];if(!args.length){args=[]}else{args=args.split(":")}if(!this.fragmentRouter.hasFragment(fragmentName)){return
}var argRequired=false;switch(fragmentName){case"knowledgebase":case"news":case"downloads":case"category":case"status":case"label":case"ended":argRequired=true;
break}if(argRequired&&!args.length){return}var url=this.fragmentRouter.getUrl(fragmentName,args);var type=this.fragmentRouter.getFragmentType(fragmentName);
if(type=="vis"){}else{if(type=="list"){this.loadingListFragment=hash;this.loadListPane(url,{url_fragment:hash})
}else{this.loadingPageFragment=hash;this.loadPage(url,{url_fragment:hash,noToggle:true})}}},this);this.cancelHashLoad++;
if(activateTabId){DeskPRO_Window.TabBar.activateTabById(activateTabId)}else{if(firstTabId){DeskPRO_Window.TabBar.activateTabById(firstTabId)
}}if(activateSection){var activateSectionId=null;Object.each(this.sections,function(section,id){if(section.urlFragmentName&&section.urlFragmentName==activateSection){activateSectionId=id;
return false}});if(activateSectionId){this.fragLoadingSection=activateSectionId;this.switchToSection(activateSectionId)
}}if(activateSettings){var settingsInterval=setInterval(function(){if(window.SETTINGS_WINDOW){clearInterval(settingsInterval);
settingsInterval=false;$("#settingswin").trigger("dp_open",activateSettings)}},250)}DeskPRO_Window.TabBar.options.activateNew=true
},updateWindowUrlFragment:function(){if(this.DEBUG.disableUrlFragments){return}if(!jQuery.history){return
}var segments=[];if(this.openSection){if(this.openSection.urlFragmentName){segments.push("app."+this.openSection.urlFragmentName)
}if(this.openSection.listPage&&this.openSection.listPage.getMetaData("url_fragment")){segments.push(this.openSection.listPage.getMetaData("url_fragment"))
}}if(DeskPRO_Window.TabBar){$("#tabNavigationPane ul.dp-tab-list li").each(function(){var isActive=$(this).hasClass("activeTabList");
var tab=$(this).data("tab");if(tab&&tab.page&&tab.page.getMetaData("url_fragment")){var tabPage=tab.page;
var hash=tabPage.getMetaData("url_fragment");if(isActive){if(hash.indexOf(":")!==-1){hash=hash.replace(/:/,".o:")
}else{hash=hash+".o"}}segments.push(hash)}})}var paneVisNum=this.getPaneVisNum();if(paneVisNum){segments.push("vis:"+paneVisNum)
}var browserHash=segments.join(",");this.cancelHashLoad++;jQuery.history.load(browserHash)},getLastClientMessageId:function(){if(this.messageChanneler.lastMessageId){return this.messageChanneler.lastMessageId
}return 0},forwardClientMessageData:function(data){if(this.messageChanneler.handleMessageAjax){this.messageChanneler.handleMessageAjax(data)
}},getPoller:function(){return this.messageChanneler.poller},getTabWatcher:function(){return this.tabWatcher
},getTabStrip:function(){return DeskPRO_Window.TabBar},getDisplayName:function(type,id){if(!window.DESKPRO_NAME_REGISTRY[type]||!window.DESKPRO_NAME_REGISTRY[type][id]){if(!window.DESKPRO_NAME_REGISTRY[type]){DP.console.error("Unknown name type %s",type)
}return null}return window.DESKPRO_NAME_REGISTRY[type][id]},getAgentInfo:function(agent_id){var agentEl=$("#agent_offline_list .agent-"+agent_id);
if(!agentEl.length){DP.console.error("Unknown agent %i",agent_id);return null}return{id:agent_id,name:agentEl.data("agent-name"),email:agentEl.data("email"),shortName:agentEl.data("agent-short-name"),pictureUrl:agentEl.data("picture-url"),pictureUrlSizable:agentEl.data("picture-url-sizable")}
},getTeamInfo:function(team_id){team_id=parseInt(team_id);var teamEl=$("#agent_team_list .team-"+team_id);
if(!teamEl.length){DP.console.error("Unknown team %i",team_id);return null}return{id:team_id,name:teamEl.data("team-name"),pictureUrl:teamEl.data("picture-url"),pictureUrlSizable:teamEl.data("picture-url-sizable")}
},getUrl:function(name,vars){if(!window.DESKPRO_URL_REGISTRY[name]){DP.console.error("Unknown url name %s",name);
return null}var url=window.DESKPRO_URL_REGISTRY[name];if(vars){Object.each(vars,function(v,k){url=url.replace("{"+k+"}",v)
})}return url},getData:function(name){if(!window.DESKPRO_DATA_REGISTRY||!window.DESKPRO_DATA_REGISTRY[name]){DP.console.error("Unknown data name %s",name);
return null}return window.DESKPRO_DATA_REGISTRY[name]},showAlert:function(msg,classname){this._initAlertOverlay();
if(typeof msg=="string"){var msgEl=$("<div/>");msgEl.text(msg);msg=msgEl}$("#alert_overlay_msg").empty().append(msg);
var wrapper=this._alertOverlay.elements.wrapperOuter;var wrapperModel=this._alertOverlay.elements.modal;
if(wrapper.data("added-class")){wrapper.removeClass(wrapper.data("added-class"));wrapperModel.removeClass(wrapper.data("added-class"));
wrapper.data("added-class",null)}if(classname){wrapper.addClass(classname);wrapperModel.addClass(classname);
wrapper.data("added-class",classname)}this._alertOverlay.openOverlay()},showConfirm:function(msg,callback_yes,callback_no,phrase_yes,phrase_no,w,h){this._initConfirmOverlay();
w=w||350;h=h||150;phrase_yes=phrase_yes||"Okay";phrase_no=phrase_no||"Cancel";this._confirmOverlay_callback_yes=callback_yes||function(){};
this._confirmOverlay_callback_no=callback_no||function(){};$("#confirm_overlay").find("> .confirm-overlay").width(w).height(h);
$("#confirm_overlay_msg").html(msg);$("#confirm_overlay .okay-trigger").text(phrase_yes);if(phrase_no=="hidden"){$("#confirm_overlay .cancel-trigger").text(phrase_no).hide()
}else{$("#confirm_overlay .cancel-trigger").text(phrase_no).show()}this._confirmOverlay.openOverlay()
},showPrompt:function(msg,callback_ok,callback_cancel){this._initPromptOverlay();this._promptOverlay_callback_yes=callback_ok||function(){};
this._promptOverlay_callback_no=callback_cancel||function(){};$("#prompt_overlay_msg").html(msg);this._promptOverlay.openOverlay()
},_initAlertOverlay:function(){if(this._alertOverlay){return}this._alertOverlay=new DeskPRO.UI.Overlay({zIndex:"none",contentElement:$("#alert_overlay"),customClassname:"window-alert",onContentSet:function(eventData){$(".close-trigger",eventData.wrapperEl).on("click",(function(){eventData.overlay.closeOverlay()
}).bind(this))}});this._alertOverlay.initOverlay()},_initConfirmOverlay:function(){if(this._confirmOverlay){return
}this._confirmOverlay_callback_yes=function(){};this._confirmOverlay_callback_no=function(){};var self=this;
this._confirmOverlay=new DeskPRO.UI.Overlay({contentElement:$("#confirm_overlay"),zIndex:"50000",onContentSet:function(eventData){$(".cancel-trigger",eventData.wrapperEl).on("click",(function(){eventData.overlay.closeOverlay();
self._confirmOverlay_callback_no();self._confirmOverlay_callback_no=function(){}}).bind(this));$(".okay-trigger",eventData.wrapperEl).on("click",(function(){eventData.overlay.closeOverlay();
self._confirmOverlay_callback_yes();self._confirmOverlay_callback_yes=function(){}}).bind(this))}})},_initPromptOverlay:function(){if(this._promptOverlay){return
}this._promptOverlay_callback_yes=function(){};this._promptOverlay_callback_no=function(){};var self=this;
this._promptOverlay=new DeskPRO.UI.Overlay({contentElement:$("#prompt_overlay"),zIndex:"top",onContentSet:function(eventData){$(".cancel-trigger",eventData.wrapperEl).on("click",(function(){eventData.overlay.closeOverlay();
self._promptOverlay_callback_no($("#prompt_overlay_input").val(),$("#prompt_overlay"));self._promptOverlay_callback_no=function(){};
$("#prompt_overlay_input").val("")}).bind(this));$(".okay-trigger",eventData.wrapperEl).on("click",(function(){eventData.overlay.closeOverlay();
self._promptOverlay_callback_yes($("#prompt_overlay_input").val(),$("#prompt_overlay"));self._promptOverlay_callback_yes=function(){};
$("#prompt_overlay_input").val("")}).bind(this))}})},showRefreshAlert:function(admin_name){var self=this;
if(this._refreshAlertTimeout){window.clearTimeout(this._refreshAlertTimeout);this._refreshAlertTimeout=null
}if(!this._refreshAlertOverlay){this._refreshAlertOverlay=new DeskPRO.UI.Overlay({contentElement:$("#refresh_alert_overlay"),zIndex:"50000",escapeClose:false,modalClickClose:false});
$("#refresh_alert_overlay").find("button.okay-trigger").on("click",function(ev){ev.preventDefault();ev.stopPropagation();
if(self._refreshAlertTimeout){window.clearTimeout(self._refreshAlertTimeout);self._refreshAlertTimeout=null
}window.location.reload(false)});$("#refresh_alert_overlay").find("button.cancel-trigger").on("click",function(ev){ev.preventDefault();
ev.stopPropagation();if(self._refreshAlertTimeout){window.clearTimeout(self._refreshAlertTimeout);self._refreshAlertTimeout=null
}self._refreshAlertOverlay.closeOverlay()})}$("#refresh_alert_overlay").find(".admin-name").text(admin_name);
var time=30;var timeShow=$("#refresh_alert_overlay").find(".countdown").text(30);this._refreshAlertTimeout=window.setInterval(function(){time--;
$("#refresh_alert_overlay").find(".countdown").text(time);if(time<=0){if(self._refreshAlertTimeout){window.clearTimeout(self._refreshAlertTimeout);
self._refreshAlertTimeout=null}window.location.reload(false)}},1000);this._refreshAlertOverlay.openOverlay()
},addListPage:function(page){DP.console.error("Invalid call to addListPage for %o",page);this.setListPage(page)
},setListPage:function(page,noswitch){var testcl=function(x){return page.getMetaData("fragmentClass","").indexOf(x)!=-1
};var handler=null;var sectionId=null;if(testcl(".Kb")||testcl(".News")||testcl(".Download")||testcl(".Publish")||testcl("PublishSearch")){sectionId="publish_section"
}else{if(testcl(".Ticket")||testcl(".NewCustomFilter")){sectionId="tickets_section"}else{if(testcl(".People")||testcl(".Org")){sectionId="people_section"
}else{if(testcl(".AgentChat")){sectionId="agent_chat_section"}else{if(testcl(".OpenChats")||testcl(".UserChatFilter")){sectionId="chat_section"
}else{if(testcl(".Feedback")||testcl(".FeedbackSearch")){sectionId="feedback_section"}else{if(testcl(".TicketFilter")||testcl(".RecycleBin")){sectionId="tickets_section"
}else{if(testcl(".Task")){sectionId="tasks_section"}else{if(testcl(".Twitter")){sectionId="twitter_section"
}}}}}}}}}if(sectionId){handler=this.sections[sectionId]}if(!handler){DP.console.error("List page fragment has no section: %s: %o",page.getMetaData("fragmentClass",""),page);
return}if(typeof noswitch===undefined){if(!noswitch&&!handler.isVisible()){noswitch=true}if(handler.isVisible()&&!handler.listPage){noswitch=false
}}handler.setListPageFragment(page,noswitch);if(!noswitch){this.listPage=page;this.switchToSection(sectionId,true);
this.updateWindowUrlFragment()}},getListPage:function(){return this.listPage},addPageTab:function(page){DeskPRO_Window.TabBar.addTab(page)
},removePage:function(page){DeskPRO_Window.TabBar.removeTabById(page.meta.tabId)},addPageRouteLoader:function(prefix,callback){if(this.routePrefixes[prefix]==undefined){this.routePrefixes[prefix]=[]
}this.routePrefixes[prefix].push(callback)},runPageRoute:function(route,extraData){var found_listener=false;
var data=this.parseRoute(route);if(extraData){data=Object.merge(extraData,data)}Object.each(this.routePrefixes,function(listeners,prefix){if(route.indexOf(prefix)==0){Array.each(listeners,function(callback){callback(data);
found_listener=true});if(data.stopListeners){return true}}},this);if(!found_listener){DP.console.error("Unknown route: %s",route)
}},parseRoute:function(route){var sections=route.split(":");var master=sections.shift();var masterTag=null;
if(master.indexOf(".")!=-1){var tmp=master.split(".");master=tmp.shift();masterTag=tmp.pop()}var url=sections.pop();
var data={"route":route,"master":master,"masterTag":masterTag,"sections":sections,"url":url,stopListeners:false};
return data},runPageRouteFromElement:function(el,extraData){el=$(el);if(el.is(".route-do-confirm")){if(!el.is(".did-confirm")){DeskPRO_Window.showConfirm("Are you sure?",function(){el.addClass("did-confirm");
DeskPRO_Window.runPageRouteFromElement(el)});return}el.removeClass("did-confirm")}if(el.is(".cancel-route")){return
}if(!el.data("route")){DP.console.error("Element has no route: %o",el);DP.console.trace();return}extraData=extraData||{};
extraData.routeTriggerEl=el;if(el.data("route-title")){extraData.title=el.data("route-title");if(extraData.title=="@text"){extraData.title=el.text().trim().replace(/[\n\r]/g," ").replace(/\s+/g," ")
}else{if(extraData.title=="@title"){extraData.title=el.attr("title")}else{if(extraData.title.test(/^@selector\((.*?)\)$/)){var sel=extraData.title.match(/^@selector\((.*?)\)$/)[1];
var titleEl=null;if(sel[0]=="#"){titleEl=$(sel)}else{titleEl=$(sel,el)}if(titleEl&&titleEl.length){extraData.title=titleEl.text().trim().replace(/[\n\r]/g," ").replace(/\s+/g," ")
}else{delete extraData.title}}}}}if(el.data("route-openclass")){extraData.toggleOpenClass=el.data("route-openclass")
}if(el.data("route-notabreload")){extraData.noToggle=true;extraData.focus=true}else{if(el.closest("#dp_content_wrap")[0]||el.closest(".popover-wrapper")[0]){extraData.noToggle=true;
extraData.focus=true}}if(el.data("route-preload-id")){extraData.preloadId=el.data("route-preload-id")
}this.runPageRoute(el.data("route"),extraData)},loadRoute:function(routeData){routeData.openInSection=routeData.master;
switch(routeData.openInSection){case"listpane":this.loadListPane(routeData.url,routeData);break;default:this.loadPage(routeData.url,routeData);
break}},loadRouteOverlay:function(routeData){var positionAbove=null;var zindex=0;var trigger=routeData.routeTriggerEl;
if(trigger){if(trigger.data("zindex")){zindex=trigger.data("zindex")}else{var parent=trigger.parentsUntil("body").last();
if(parent.length&&parent.parent().is("body")){positionAbove=parent}}}var fragmentOverlay=new DeskPRO.Agent.PageHelper.FragmentOverlay({routeData:routeData,positionAbove:positionAbove,zIndex:zindex})
},loadListPane:function(url,routeData,callback){if(routeData&&!routeData.isBackgroundLoad){if(this.loadingListPage){this.loadingListPage.abort();
this.loadingListPage=null}}if(routeData&&!routeData.isBackgroundLoad){$("#dp_list > section").removeClass("on");
$("#dp_list_loading").addClass("on")}var xhr=this._doAjaxLoadRoute(url,routeData,(function(data){if(!routeData){routeData={}
}if(routeData&&!routeData.isBackgroundLoad){this.loadingListPage=null}$("#dp_list_loading").removeClass("on");
var page=this.createPageFragment(data,"DeskPRO.Agent.PageFragment.ListPane.Basic");page.setMetaData("routeUrl",url);
if(routeData){page.setMetaData("routeData",routeData)}this.setListPage(page,routeData.isBackgroundLoad||false);
if(callback){callback(page)}}).bind(this));if(routeData&&!routeData.isBackgroundLoad){this.loadingListPage=xhr
}},loadPage:function(url,routeData,callback){var self=this;if(!routeData||(!routeData.ignoreExist)){var existTab=DeskPRO_Window.TabBar.findTabByRouteUrl(url);
if(existTab&&routeData.noToggle){if(routeData.focus){DeskPRO_Window.TabBar.activateTab(existTab)}return
}if(existTab&&!(existTab.page.allowDupe&&existTab.page.TYPENAME!="loading")){if(routeData&&routeData.routeTriggerEl&&routeData.routeTriggerEl.data("route-notabreload")){DeskPRO_Window.TabBar.tabToFrontTabById(existTab.id);
DeskPRO_Window.TabBar.activateTabById(existTab.id)}else{DeskPRO_Window.TabBar.removeTabById(existTab.id);
if(routeData.routeTriggerEl&&routeData.toggleOpenClass){routeData.routeTriggerEl.removeClass(routeData.toggleOpenClass)
}}return}}routeData.tabPlaceholderId=DeskPRO_Window.TabBar.addTabPlaceholder(url,routeData);if(routeData.routeTriggerEl&&routeData.toggleOpenClass){routeData.routeTriggerEl.addClass(routeData.toggleOpenClass)
}var successFn=(function(data){try{var page=this.createPageFragment(data)}catch(e){if(routeData.tabPlaceholderId){DeskPRO_Window.TabBar.removeTabById(routeData.tabPlaceholderId)
}this._showAjaxError('<div class="error-details">There was a problem loading the tab. Here is the raw page output: <textarea class="raw">'+Orb.escapeHtml(data)+"</textarea></div>");
return}page.setMetaData("routeUrl",url);if(routeData){page.setMetaData("routeData",routeData);if(routeData.tabPlaceholderId){page.setMetaData("tabPlaceholderId",routeData.tabPlaceholderId)
}}if(routeData.fragment){page.setMetaData("fragment",routeData.fragment)}this.addPageTab(page);if(callback){callback(page)
}}).bind(this);if(routeData.preloadId){preloadEl=document.getElementById(routeData.preloadId);if(preloadEl){var content=preloadEl.innerHTML;
preloadEl.parentNode.removeChild(preloadEl);content=content.replace(/<deskpro_script/g,"<script");content=content.replace(/<\/deskpro_script/g,"<\/script");
successFn(content);return}}this._doAjaxLoadRoute(url,routeData,successFn)},_doAjaxLoadRoute:function(url,routeData,successFn){routeData=routeData||{};
if(!url){DP.console.error("No URL provided! routeData: %o",routeData);return}var self=this;if(routeData&&routeData.postData){var xhr=$.ajax({dataType:"text",url:url,type:"POST",data:routeData.postData,success:(function(data){successFn(data)
}).bind(this),noErrorOverride:true,timeout:180000});routeData.xhr=xhr}else{var xhr=$.ajax({dataType:"text",url:url,type:"GET",success:(function(data){successFn(data)
}).bind(this),noErrorOverride:true,timeout:180000});routeData.xhr=xhr}return xhr},createPageFragment:function(html,classname,force_classname){pageMeta={"title":false,"fragmentClass":classname||"DeskPRO.Agent.PageFragment.Basic"};
var regex=/<script>([\s\S]*?)<\/script>/im;var matches=regex.exec(html);if(!matches||!matches.length){var regex=/<script\s*type="text\/javascript">([\s\S]*?)<\/script>/im;
var matches=regex.exec(html)}if(matches&&matches.length){eval(matches[1]);html=html.replace(matches[0],"")
}if(force_classname){pageMeta.fragmentClass=classname}if(pageMeta&&pageMeta.goToLogin){window.location=BASE_URL+"agent/";
var page=new DeskPRO.Agent.PageFragment.Basic("");return page}var fragment_class=Orb.getNamespacedObject(pageMeta.fragmentClass);
var page=new fragment_class(html);page.setMetaData(pageMeta);return page},getCurrentListPage:function(){return this.listPage
},getCurrentTabPage:function(){var tab=DeskPRO_Window.TabBar.getActiveTab();if(!tab){return null}return tab.page
},reloadSelectedTab:function(){var tab=DeskPRO_Window.TabBar.getActiveTab();if(!tab){return}var route=tab.page.meta.routeData.route;
DeskPRO_Window.TabBar.removeTabById(tab.id);this.runPageRoute(route)},reloadSelectedList:function(){if(!this.listPage){return
}var route=this.listPage.meta.routeData.route;this.runPageRoute(route)},getMessageChanneler:function(){return this.messageChanneler
},dismissHelpMessage:function(el){el=$(el);var messageId=el.data("message-id");el.remove();if(!messageId){return
}$.ajax({dataType:"json",url:BASE_URL+"agent/misc/dismiss-help-message/"+escape(messageId),type:"GET"})
},playSound:function(files,setOptions){setOptions=setOptions||{};options=$.extend({},{"autoplay":true,"volume":false,"loop":false,"destroyAfter":true},setOptions);
if(this.volume==0){return null}if(typeof files=="string"){files=[files]}var volume=this.volume;if(options.volume){volume=options.volume
}volume=volume+0;var html=[];html.push("<audio ");if(volume!=1){html.push(' volume="'+volume+'" ')}if(options.loop){html.push(' loop="loop" ')
}html.push(">");Array.each(files,function(f){html.push('<source src="'+f.path+'" type="'+f.type+'" />')
});html.push("</audio>");html=html.join("");var el=$(html);try{el.get(0).volume=volume}catch(e){}if(options.destroyAfter){el.bind("ended",function(){$(this).remove()
})}if(options.appendTo){$(options.appendTo).append(el)}else{el.appendTo("body")}if(options.autoplay){try{el.get(0).play()
}catch(e){}}return el},playLibrarySound:function(name,options){if($.browser.msie){var files=[{path:ASSETS_BASE_URL+"/sounds/"+name+".wav",type:"audio/wav"}]
}else{var files=[{path:ASSETS_BASE_URL+"/sounds/"+name+".mp3",type:"audio/mpeg"},{path:ASSETS_BASE_URL+"/sounds/"+name+".ogg",type:"audio/ogg"}]
}this.playSound(files,options)},handleSoundElements:function(el){var self=this;if($(el).is("[data-play-sound]")){self.playLibrarySound($(el).data("play-sound"),{appendTo:el})
}else{$("[data-play-sound]",el).each(function(){self.playLibrarySound($(this).data("play-sound"),{appendTo:el})
})}},_globalHandleAjaxComplete:function(event,xhr,ajaxOptions){var is_success=false;if(xhr.status&&xhr.status==200){is_success=true
}else{if(xhr.status==0||(xhr.statusText&&xhr.statusText=="abort")){return}}if(is_success){$("#network_status_indicator > a").removeClass("on").data("error-count",0);
$("#network_status_tip").removeClass("error");if(this.update_running){window.location.reload(true)}}else{this.incNetworkError()
}},showUpdateRunning:function(){this.update_running=true;$("#reload_overlay").show();$("#reload_overlay_updates").show()
},_globalHandleAjaxError:function(event,xhr,ajaxOptions,errorThrown,force){if(this.update_running){return
}if(!xhr||(xhr.status==0&&xhr.statusText!="timeout")){return}if(xhr&&xhr.status&&xhr.status=="404"){this.showAlert($("<div><strong>Not Found</strong><br />The page you are trying to view could not be found. It may have been moved or deleted.</div>"));
return}if(force||(xhr.statusText&&xhr.statusText=="abort")){return}if(ajaxOptions.errorDp){ajaxOptions.errorDp.call(ajaxOptions.context||xhr,event,xhr,ajaxOptions,errorThrown)
}var data=xhr.responseText;try{data=$.parseJSON(data)}catch(e){data=null}if(xhr&&xhr.status&&xhr.status=="503"&&data&&data.error&&data.error=="update_running"){this.showUpdateRunning();
return}if(DPC_IS_CLOUD){if(xhr&&xhr.status&&(xhr.status=="503"||xhr.status=="500")){this.showAlert($("<div>We detected a problem while trying to load the page you requested. Please try again.</div>"));
if(DpErrorLog){DpErrorLog.logError("AJAX Error "+xhr.status+" on "+ajaxOptions.url)}return}if(xhr&&(xhr.status=="timeout"||xhr.statusText=="timeout"||xhr.responseText=="timeout"||errorThrown=="timeoutec")){this.showAlert($("<div>We could not load the page you requested because the connection timed out. Please try again.</div>"));
return}}if(xhr&&xhr.status&&xhr.status=="403"){if(data&&data.error&&(data.error=="session_expired"||data.error=="invalid_request_token")){var url=data.redirect_login;
url+="?return="+encodeURIComponent(window.location.href);url+="&timeout=1";window.location=url;ajaxOptions.error=null;
ajaxOptions.complete=null;$("#reload_overlay").show();return}if(data&&data.error&&data.error=="not_allowed"){this.showAlert($("<div>The action you attempted to execute is not allowed:<br />"+data.errorMessage+"</div>"));
return}else{if(xhr.responseText&&xhr.responseText.indexOf("DeskPRO")){this.showAlert($("<div><strong>No Permission</strong><br />You do not have permission to view the requested page. If you think this is a mistake, you should contact your administrator.</div>"))
}else{if(DPC_IS_CLOUD){if(DpErrorLog){DpErrorLog.hasSentReport=true;DpErrorLog.logError("CloudFlare Network Error: "+message,"URL: "+ajaxOptions.url,"agent",1)
}this.util.reloadInterface()}else{this.showAlert($("<div><strong>Server Error</strong><br />You do not have permission to view the requested page. If you think this is a mistake, you should contact your administrator.</div>"))
}}return}}if(ajaxOptions&&ajaxOptions.error&&!ajaxOptions.noErrorOverride){return}if(ajaxOptions&&ajaxOptions.dpIsPolling){this.incNetworkError();
return}if(xhr.status=="timeout"||xhr.statusText=="timeout"||xhr.responseText=="timeout"||errorThrown=="timeoutec"){this.showAlert($("<div><strong>Network Error</strong><br />The request timed out. The server may be too busy to handle your request, or you may have been disconnected from the internet. Try again.</div>"),"network_error");
this.incNetworkError();return}var sn=null;if(data&&data.sn){sn=data.sn}else{var match=/\[SN([0-9A-Z]{8})\]/.exec(xhr.responseText);
if(match){sn=match[1]}}if(sn){var status=(xhr.status||"")+" "+(errorThrown||"")+" "+(xhr.statusText||"");
var url=ajaxOptions.url;var method=ajaxOptions.type;var showsn="SN"+sn;if(DESKPRO_PERSON_ISADMIN){showsn='<a href="'+BASE_URL+"admin/server/error-logs/SN"+sn+'">SN'+sn+"</a>"
}this._showAjaxError("<div>If the error persists, give your administrator this code: "+showsn+'</div><div class="error-details">Here is the raw output returned from the server error:<textarea class="raw">'+Orb.escapeHtml(method)+" "+Orb.escapeHtml(url)+"\n"+Orb.escapeHtml(status)+"\n\n"+Orb.escapeHtml(xhr.responseText)+"</textarea></div>")
}else{this._showAjaxError('<div class="error-details">Here is the raw output returned from the server error:<textarea class="raw">'+Orb.escapeHtml(method)+" "+Orb.escapeHtml(url)+"\n"+Orb.escapeHtml(status)+"\n\n"+Orb.escapeHtml(xhr.responseText)+"</textarea></div>")
}},incNetworkError:function(){var a=$("#network_status_indicator > a").addClass("on");a.data("error-count",parseInt(a.data("error-count"))+1);
$("#network_status_tip").addClass("error")},_showAjaxError:function(message,type){if(DPC_IS_CLOUD){if(message.indexOf("http://www.cloudflare.com/")!==-1&&message.indexOf("<title>Website is currently unreachable</title>")!==-1){if(DpErrorLog){DpErrorLog.hasSentReport=true;
DpErrorLog.logError("CloudFlare Network Error: "+message,"","agent",1)}return}}var self=this;$("#global_ajax_error_info").empty();
if(message){$("#global_ajax_error_info").html(message)}else{$("#global_ajax_error_info").empty()}if(!this.ajaxErrorOverlay){this.ajaxErrorOverlay=new DeskPRO.UI.Overlay({contentElement:$("#global_ajax_error"),zIndex:50000})
}$("#global_ajax_error_submit").off("click").on("click",function(ev){ev.preventDefault();$("#global_ajax_error").removeClass("switch-success").addClass("switch-loading");
$.ajax({url:BASE_URL+"dp/report-error.json",data:{error_text:message},type:"POST",success:function(){$("#global_ajax_error").removeClass("switch-loading").addClass("switch-success")
}})});this.ajaxErrorOverlay.initOverlay();this.ajaxErrorOverlay.elements.wrapperOuter.addClass("error");
$("#global_ajax_error").removeClass("switch-success switch-loading");this.ajaxErrorOverlay.openOverlay()
},_initBasic:function(){this.options.messageChanneler.interval=DP_POLLER_INTERVAL;this.messageChanneler=new DeskPRO.MessageChanneler.AjaxChanneler(this.messageBroker,this.options.messageChanneler);
this.messageChanneler.poller.addData((function(){return{"at":parseInt(this.activityTime.getTime()/1000)}
}).bind(this),"at",{recurring:true});this.messageChanneler.poller.addData((function(){var chatIdsData=[];
Array.each(this.getTabWatcher().findTabType("userchat"),function(t){chatIdsData.push({name:"chat_ids[]",value:t.page.meta.conversation_id})
});if(!chatIdsData.length){return false}return chatIdsData}).bind(this),"chat_ids",{recurring:true});
this.getTabWatcher().addTabTypeWatcher("userchat",new DeskPRO.Agent.WindowElement.TabWatcher.UserChat())
},_initRoutes:function(){this.addPageRouteLoader("listpane",(function(routeData){if(!this.paneVis.list&&!routeData.noChangePaneVis){this.setPaneVis("list",true)
}this.loadRoute(routeData)}).bind(this));this.addPageRouteLoader("page",this.loadRoute.bind(this));this.addPageRouteLoader("article",this.loadRoute.bind(this));
this.addPageRouteLoader("download",this.loadRoute.bind(this));this.addPageRouteLoader("news",this.loadRoute.bind(this));
this.addPageRouteLoader("feedback",this.loadRoute.bind(this));this.addPageRouteLoader("org",this.loadRoute.bind(this));
this.addPageRouteLoader("ticket",(function(routeData){routeData.forTypename="ticket";var m=routeData.url.match(/tickets\/([0-9]+)/);
if(!m||!m[1]){console.error("Bad page loader call: "+routeData.url+" %o",routeData);return}var ticketId=m[1];
routeData.tabLoad=function(){DeskPRO_Window.getMessageBroker().sendMessage("ui.ticket.opened",{ticketId:ticketId})
};routeData.tabUnload=function(){DeskPRO_Window.getMessageBroker().sendMessage("ui.ticket.closed",{ticketId:ticketId})
};this.loadRoute(routeData)}).bind(this));this.addPageRouteLoader("person",this.loadRoute.bind(this));
this.addPageRouteLoader("kb_article_view",this.loadRoute.bind(this));this.addPageRouteLoader("kb_article_new",this.loadRoute.bind(this));
this.addPageRouteLoader("kb_article_edit",this.loadRoute.bind(this));this.addPageRouteLoader("poppage",this.loadRouteOverlay.bind(this));
var self=this},_initWindowInterface:function(){var self=this;$(document).on("textareaexpander_expanded",function(){$(".with-scroll-handler").each(function(){if($(this).data("scroll_handler")){$(this).data("scroll_handler").updateSize()
}})});this.notifications=new DeskPRO.Agent.Notifications();$("#user_settings_link").on("click",function(){$("#settingswin").trigger("dp_open")
});$(document).ajaxError(this._globalHandleAjaxError.bind(this));$(document).ajaxComplete(this._globalHandleAjaxComplete.bind(this));
this.faviconBadge=new DeskPRO.FaviconBadge({favicon:"#favicon"});this.notifications.addEvent("modCount",function(data){var count=0;
$("#dp_header_notify_wrap").find(".badge").not(".no-count").each(function(){count+=parseInt($(this).text().trim())
});var doanim=false;if(!$("html").is(".window-active")){doanim=true}self.faviconBadge.updateBadge(count,true)
});this.volume=0.8;$("#sound_icon").find("i").removeClass("icon-volume-down icon-volume-up icon-volume-off").addClass("icon-volume-up");
var updateVolumeUi=function(){if(self.volume==0||self.volume==0){self.volume=0;$("#sound_icon_in").addClass("off");
$("#sound_icon").find("i").removeClass("icon-volume-down icon-volume-up").addClass("icon-volume-off")
}else{if(self.volume<0.6){$("#sound_icon").find("i").removeClass("icon-volume-down icon-volume-up icon-volume-off").addClass("icon-volume-down")
}else{$("#sound_icon").find("i").removeClass("icon-volume-down icon-volume-up icon-volume-off").addClass("icon-volume-up")
}$("#sound_icon_in").removeClass("off")}$("audio").each(function(){this.volume=self.volume});$("#volume_controls .slider").slider("value",self.volume*100)
};$("#volume_controls .slider").slider({orientation:"vertical",range:"min",min:0,max:100,value:80,slide:function(event,ui){self.volume=parseInt(ui.value)/100;
$("#sound_icon_in").data("last-value",$("#volume_controls .slider").slider("value"));updateVolumeUi()
}});$("#sound_icon_in").data("last-value",$("#volume_controls .slider").slider("value"));$("#sound_icon_in").on("click",function(ev){ev.stopPropagation();
if($(this).is(".off")){var last=$(this).data("last-value");if(last==0||last==0){last=80}self.volume=parseInt(last)/100;
updateVolumeUi()}else{self.volume=0;updateVolumeUi()}});var closeSoundMenu=function(){$("#volume_controls_back").hide();
$("#volume_controls").fadeOut()};$("#volume_controls_back").on("click",function(ev){ev.stopPropagation();
closeSoundMenu()});var showSoundMenu=function(){$("#volume_controls_back").show();var atEl=$("#sound_icon").find("i");
$("#volume_controls").css({"top":atEl.offset().top-1,"left":atEl.offset().left-2});$("#volume_controls").fadeIn()
};$("#sound_icon").on("click",function(ev){ev.preventDefault();ev.stopPropagation();showSoundMenu()});
this.createMenu=new DeskPRO.UI.Menu({triggerElement:"#create_content_trigger",menuElement:"#create_content_menu"});
var autostart=true;if(DeskPRO_Window.DEBUG.disableSectionHandlers){autostart=false}if(DESKPRO_PERSON_PERMS["agent_tickets.create"]){var self=this;
this.newTicketLoader=new DeskPRO.Agent.Widget.BackgroundPopout({loadUrl:BASE_URL+"agent/tickets/new",tabRoute:"page:"+BASE_URL+"agent/tickets/new",autostart:autostart});
this.newTicketLoader.newLinkedTicket=function(ticket_id,message_id){self.newTicketLoader.nextParams={ticket_id:ticket_id,message_id:message_id||0};
self.newTicketLoader.open()};$("#create_ticket_btn").on("click",function(){DeskPRO_Window.newTicketLoader.toggle()
})}if(DESKPRO_PERSON_PERMS["agent_people.create"]){this.newPersonLoader=new DeskPRO.Agent.Widget.BackgroundPopout({loadUrl:BASE_URL+"agent/people/new",tabRoute:"page:"+BASE_URL+"agent/people/new",autostart:autostart});
$("#create_person_btn").on("click",function(){DeskPRO_Window.newPersonLoader.toggle()})}if(DESKPRO_PERSON_PERMS["agent_org.create"]){this.newOrganizationLoader=new DeskPRO.Agent.Widget.BackgroundPopout({loadUrl:BASE_URL+"agent/organizations/new",tabRoute:"page:"+BASE_URL+"agent/organizations/new",autostart:autostart});
$("#create_organization_btn").on("click",function(){DeskPRO_Window.newOrganizationLoader.toggle()})}if(DESKPRO_PERSON_PERMS["agent_publish.create"]){this.newArticleLoader=new DeskPRO.Agent.Widget.BackgroundPopout({loadUrl:BASE_URL+"agent/kb/article/new",tabRoute:"page:"+BASE_URL+"agent/kb/article/new",autostart:autostart});
this.newNewsLoader=new DeskPRO.Agent.Widget.BackgroundPopout({loadUrl:BASE_URL+"agent/news/new",tabRoute:"page:"+BASE_URL+"agent/news/new",autostart:autostart});
this.newDownloadLoader=new DeskPRO.Agent.Widget.BackgroundPopout({loadUrl:BASE_URL+"agent/downloads/new",tabRoute:"page:"+BASE_URL+"agent/news/new",autostart:autostart});
this.newFeedbackLoader=new DeskPRO.Agent.Widget.BackgroundPopout({loadUrl:BASE_URL+"agent/feedback/new",tabRoute:"page:"+BASE_URL+"agent/feedback/new",autostart:autostart});
$("#create_article_btn").on("click",function(){DeskPRO_Window.newArticleLoader.toggle()});$("#create_news_btn").on("click",function(){DeskPRO_Window.newNewsLoader.toggle()
});$("#create_download_btn").on("click",function(){DeskPRO_Window.newDownloadLoader.toggle()});$("#create_feedback_btn").on("click",function(){DeskPRO_Window.newFeedbackLoader.toggle()
})}this.newTaskLoader=new DeskPRO.Agent.Widget.BackgroundPopout({loadUrl:BASE_URL+"agent/tasks/new",autostart:autostart});
$("#create_task_btn").on("click",function(){$("form#newTaskForm input, form#newTaskForm select").val("");
DeskPRO_Window.newTaskLoader.toggle()});if($("#twitter_section").length){this.newTweetLoader=new DeskPRO.Agent.Widget.BackgroundPopout({loadUrl:BASE_URL+"agent/twitter/new",autostart:autostart});
$("#create_tweet_btn").on("click",function(){DeskPRO_Window.newTweetLoader.toggle()})}$("#createContentTrigger").on("click",function(ev){ev.preventDefault();
ev.stopPropagation();var pos=$(this).offset();var w=$(this).outerWidth();var h=$(this).outerHeight();
var list=$("#createTicketToggle");list.hide().detach().appendTo("body");list.css({top:pos.top,left:pos.left});
list.show();var backdrop=$('<div class="backdrop" />').appendTo("body");var close=function(){list.hide();
backdrop.remove()};backdrop.on("click",close);list.on("click",close)});$("#DP-InterfaceSwitcher > .DP-adminSwitch > .adminSwitcher").on("click",function(ev){ev.preventDefault();
ev.stopPropagation();var list=$("#interfacesToggle");list.hide().detach().appendTo("body");list.css({top:7,right:69});
list.show();var backdrop=$('<div class="backdrop" />').appendTo("body");var close=function(){list.hide();
backdrop.remove()};backdrop.on("click",close);list.find("a").on("click",close);$("ul",list).on("click",function(ev){ev.stopPropagation()
})});$("#userSetting_trigger").on("click",function(ev){ev.preventDefault();ev.stopPropagation();var list=$("#userSetting");
list.hide().detach().appendTo("body");list.css({top:41,left:4});list.show();var backdrop=$('<div class="backdrop" />').appendTo("body");
var close=function(){list.hide();backdrop.remove()};backdrop.on("click",close);list.find("a").on("click",close);
$("ul",list).on("click",function(ev){ev.stopPropagation()})});var getkbbackdrop=function(){if(this.el){return this.el
}this.el=$("<div />").addClass("backdrop").appendTo("body").on("click",function(){$("#dp_keyboard_shortcuts").hide();
getkbbackdrop().hide()});return this.el};$("#dp_keyboard_shortcuts").find(".close").on("click",function(){$("#dp_keyboard_shortcuts").hide();
getkbbackdrop().hide()});$("#keyboard_shortcuts_trigger").on("click",function(){$("#dp_keyboard_shortcuts").show();
getkbbackdrop().show()});DeskPRO_Window.getMessageBroker().addMessageListener("agent.ui.reload",function(info){DeskPRO_Window.showRefreshAlert(info.person_name)
});this.keyboardShortcuts=new DeskPRO.Agent.KeyboardShortcuts()},initStickyTips:function(els){if(!els.hasClass("with-stickytip")){els=els.find(".with-stickytip")
}els.each(function(){if($(this).hasClass("dp-stickytip-init")){return}var me=$(this);$(this).addClass("dp-stickytip-init");
$(this).one("mouseover",function(){$(this).attr("title","");var target=$(me.data("stickytip-target"));
me.data("stickytip-target",target);var hideTimout=null;var hideFn=function(){if(target.hasClass("over")||me.hasClass("over")){return
}target.hide();target.removeClass("over");me.removeClass("over")};var showFn=function(){var pos=me.offset();
target.css({left:pos.left,top:pos.top+15});target.show()};var hideTimeout=null;target.on("mouseover",function(){target.addClass("over");
if(hideTimeout){window.clearTimeout(hideTimeout);hideTimeout=null}}).on("mouseout",function(){target.removeClass("over");
if(hideTimeout){window.clearTimeout(hideTimeout);hideTimeout=null}hideTimeout=window.setTimeout(hideFn,240)
});me.on("mouseover",function(){me.addClass("over");showFn();if(hideTimeout){window.clearTimeout(hideTimeout);
hideTimeout=null}}).on("mouseout",function(){me.removeClass("over");if(hideTimeout){window.clearTimeout(hideTimeout);
hideTimeout=null}hideTimeout=window.setTimeout(hideFn,240)});me.addClass("over");target.detach().appendTo("body");
showFn()})})},_initSections:function(){var self=this;var count=-1;var secttimeout=2500;this.getSectionDataStartQueue();
$("#dp_nav [data-section-handler]").each(function(){var el=$(this);if(!el.attr("id")){el.attr("id",Orb.getUniqueId("section_"))
}var handlerClassName=el.data("section-handler");if(DeskPRO_Window.DEBUG.disableSectionHandlers){if(!DeskPRO_Window.DEBUG.enableSectionHandlers||DeskPRO_Window.DEBUG.enableSectionHandlers.indexOf(handlerClassName)===-1){return
}}var handlerClass=Orb.getNamespacedObject(handlerClassName);var handler=new handlerClass();handler.section_id=el.attr("id");
if(++count){handler.addEvent("sectionInit",function(){window.setTimeout(function(){handler._loadAutoLoadRoutes(true)
},secttimeout);secttimeout+=(400*count)})}else{handler.addEvent("sectionInit",function(){handler._loadAutoLoadRoutes()
})}self.sections[el.attr("id")]=handler;if(!el.is(".no-click-switch")){el.on("click",function(){self.switchToSection(el.attr("id"))
})}});this.getSectionDataSendQueued()},switchToSection:function(section_id,no_load_list){DP.console.debug("Switching to %s",section_id);
var handler=this.sections[section_id];if(!handler){if(section_id!="test_section"){DP.console.error("Invalid section: %s",section_id)
}return}if(this.openSection==handler){return}var btn=$("#"+section_id);if(btn.is(".on")){return}if(this.openSection){this.openSection.fireEvent("hide")
}$("#dp_nav li.active").removeClass("active");btn.addClass("active");$("#dp_source > section.on").removeClass("on");
$("#dp_list > section.on").removeClass("on");$("#dp_list_loading, #dp_source_loading").addClass("on");
if(this.openSection){this.openSection.fireEvent("afterhide")}$("#dp_list_loading").removeClass("on");
handler.fireEvent("show",[no_load_list]);var sectionEl=handler.getSectionElement();if(sectionEl){sectionEl.addClass("on")
}var listEl=handler.getListElement();if(listEl){listEl.addClass("on")}handler.fireEvent("aftershow",[no_load_list]);
this.openSection=handler;if(this.openSection.listPage){this.listPage=this.openSection.listPage}this.updateWindowUrlFragment();
if(this.openSection){this.openSection.updateUi();if(this.listPage){this.listPage.updateUi()}}},getOpenSection:function(){return this.openSection
},_initLayout:function(){this.layout=new DeskPRO.Agent.Layout.DeskproWindow();this.layout.doResize(true);
this.TabBar=new DeskPRO.Agent.WindowElement.TabBar({tabPane:$("#tabNavigationPane"),bodyPane:$("#dp_content_wrap"),menuBtn:$("#tabDropdownPicker")});
this.tabWatcher=new DeskPRO.Agent.TabWatcher({tabManager:DeskPRO_Window.TabBar});this.tabWatcher.addTabTypeWatcher("ticket",new DeskPRO.Agent.WindowElement.TabWatcher.Tickets());
this.recentTabs=new DeskPRO.Agent.RecentTabs()},_initInterfaceServices:function(){var self=this;this.popover_inited={};
this.initInterfaceLayerEvents(document)},_initInterfacePopover:function(el,opennow){var self=this;var popover_inited=this.popover_inited;
var route=el.data("route");var routeData=self.parseRoute(route);if(el.data("route-preload-id")){routeData.preloadId=el.data("route-preload-id")
}var popover;if(!popover_inited[route]){popover=new DeskPRO.Agent.PageHelper.Popover({pageUrl:routeData.url,preloadId:routeData.preloadId,tabRoute:route,loadTimeout:(el.is(".preload")?1500:0)});
popover_inited[route]={count:0,popover:popover};popover.addEvent("close",function(){if(popover_inited[route].count<1){popover_inited[route].popover.destroy();
delete popover_inited[route]}});popover.addEvent("destroy",function(){delete popover_inited[route]})}else{popover=popover_inited[route].popover
}popover_inited[route].count++;var tabWrapper=el.closest(".with-page-fragment");if(tabWrapper.length){var page=tabWrapper.data("page-fragment");
page.addEvent("destroy",function(){if(popover_inited[route]){popover_inited[route].count--;if(popover_inited[route].count<1){popover_inited[route].popover.destroy();
delete popover_inited[route]}}})}else{popover.options.destroyOnClose=true}return popover},initInterfaceLayerEvents:function(context){var self=this;
if($(context).is(".dp-interface-layer")){return}$(context).addClass("dp-interface-layer");window.setTimeout(function(){$(context).on("click","[data-route]",function(ev){if($(this).is(".as-popover")){return
}if($(this).is(".row-item")&&(!$(ev.target).is(".click-through")&&$(ev.target).is("input, a, button, textarea"))){return
}ev.preventDefault();ev.stopPropagation();self.runPageRouteFromElement($(this));if($(this).data("route").indexOf("listpane:")===0){Object.each(DeskPRO.Agent.PageHelper.Popover_Instances,function(inst){if(inst.isOpen()){inst.close()
}},this)}});$(context).on("click",".agent-link",function(ev){ev.preventDefault();ev.stopPropagation();
var agentId=$(this).data("agent-id");DP.console.log("Agent click %i",agentId);if(!agentId||agentId==="0"||agentId===""||agentId==DESKPRO_PERSON_ID){return
}if(!DeskPRO_Window.sections.agent_chat_section){DP.console.error("The agent chat section is not enabled");
return}DeskPRO_Window.sections.agent_chat_section.newChatWindow([agentId])});$(context).on("click",".as-popover",function(ev){ev.preventDefault();
ev.stopPropagation();self._initInterfacePopover($(this)).toggle()})},100);window.setTimeout(function(){$(context).find(".tipped").one("mouseover",function(ev){if($(this).hasClass("tipped-inited")){return
}$(this).addClass("tipped-inited");var options={};if($(this).data("tipped-options")){eval("options = {"+$(this).data("tipped-options")+"}")
}qtipOptions={};if(options.ajax){qtipOptions.content={text:"Loading...",ajax:{url:$(this).data("tipped"),type:"GET"}}
}else{if($(this).data("tipped")){qtipOptions.content={attr:"data-tipped"}}else{qtipOptions.content={attr:"title"}
}}if(options.inline){qtipOptions.content.attr=null;var el=$("#"+$(this).data("tipped"));qtipOptions.content.text=function(){return el.html()
}}qtipOptions.style={classes:"ui-tooltip-shadow ui-tooltip-rounded"};qtipOptions.position={my:"top center",at:"bottom center",viewport:$(window)};
qtipOptions=$.extend(true,qtipOptions,options);$(this).qtip(qtipOptions).qtip("show",ev);$(this).addClass("tipped-inited")
})},200);$(".timeago",context).timeago();DeskPRO.ElementHandler_Exec(context)},initInterfaceServices:function(context){var self=this;
var page=false;if(context.hasClass("dp-inited-iface")){return}if(context.is(".with-page-fragment")){page=context.data("page-fragment")
}else{var tabWrapper=context.closest(".with-page-fragment");page=tabWrapper.data("page-fragment")}$(".as-popover.preload",context).each(function(){var p=self._initInterfacePopover($(this))
});if(page){var scrollEls=$(".with-scrollbar",context);if(scrollEls.length){scrollEls.each(function(){new DeskPRO.Agent.ScrollerHandler(page,$(this),{showEvent:"show",hideEvent:"hide"})
})}}$(".timeago",context).timeago();DeskPRO.ElementHandler_Exec(context);$("input.dp-checkbox",context).each(function(){DeskPRO_Window.util.dpCheckbox($(this))
});window.setTimeout(function(){$(context).find(".tipped").one("mouseover",function(ev){if($(this).hasClass("tipped-inited")){return
}$(this).addClass("tipped-inited");var options={};if($(this).data("tipped-options")){eval("options = {"+$(this).data("tipped-options")+"}")
}qtipOptions={};if(options.ajax){qtipOptions.content={text:"Loading...",ajax:{url:$(this).data("tipped"),type:"GET"}}
}else{if($(this).data("tipped")){qtipOptions.content={attr:"data-tipped"}}else{qtipOptions.content={attr:"title"}
}}if(options.inline){qtipOptions.content.attr=null;var el=$("#"+$(this).data("tipped"));qtipOptions.content.text=function(){return el.html()
}}qtipOptions.style={classes:"ui-tooltip-shadow ui-tooltip-rounded"};qtipOptions.position={my:"top center",at:"bottom center",viewport:$(window)};
qtipOptions=$.extend(true,qtipOptions,options);$(this).qtip(qtipOptions).qtip("show",ev)})},200)},getSectionData:function(section_id,callback,extra_data){var self=this;
var url;if(!this.loadingSections){this.loadingSections={}}if(this.loadingSections[section_id]){return
}this.loadingSections[section_id]=true;if(this._getSectionDataQueued){this._getSectionDataQueued.push([section_id,callback]);
return}switch(section_id){case"tickets_section":url=BASE_URL+"agent/ticket-search/get-section-data.json";
break;case"chat_section":url=BASE_URL+"agent/chat/get-section-data.json";break;case"twitter_section":url=BASE_URL+"agent/twitter/get-section-data.json";
break;case"people_section":url=BASE_URL+"agent/people-search/get-section-data.json";break;case"feedback_section":url=BASE_URL+"agent/feedback/get-section-data.json";
break;case"publish_section":url=BASE_URL+"agent/publish/get-section-data.json";break;case"tasks_section":url=BASE_URL+"agent/tasks/get-section-data.json";
break;case"deals_section":url=BASE_URL+"agent/deals/get-section-data.json";break;case"agent_chat_section":url=BASE_URL+"agent/agent-chat/get-section-data.json";
break}if(!url){DP.console.error("getSectionData: Unknown section %s",section_id);return}var errorFn=function(){this.tryCount++;
if(this.tryCount<=this.retryLimit){$.ajax(this);return}delete self.loadingSections[section_id]};$.ajax({url:url,data:extra_data||{},timeout:15000,dataType:"json",success:function(data){delete self.loadingSections[section_id];
if(!data||!data.section_html){errorFn();return}callback(data)},tryCount:0,retryLimit:3,error:function(xhr,textStatus,errorThrown){errorFn();
DeskPRO_Window._globalHandleAjaxError(null,xhr,this,errorThrown)}})},getSectionDataStartQueue:function(){this._getSectionDataQueued=[]
},getSectionDataSendQueued:function(){var self=this;if(!this._getSectionDataQueued||!this._getSectionDataQueued.length){return
}var callback_map={};var data=[];Array.each(this._getSectionDataQueued,function(info){data.push({name:"section_ids[]",value:info[0]});
callback_map[info[0]]=info[1]});this._getSectionDataQueued=null;$.ajax({url:BASE_URL+"agent/get-combined-section-data.json",type:"GET",data:data,dataType:"json",timeout:30000,tryCount:0,retryLimit:3,error:function(xhr,textStatus,errorThrown){this.tryCount++;
if(this.tryCount<=this.retryLimit){$.ajax(this);return}var status=(xhr.status||"")+" "+(errorThrown||"")+" "+(xhr.statusText||"");
self._showAjaxError('<div class="error-details">Here is the raw output returned from the server error:<textarea class="raw">'+status+"\n\n"+Orb.escapeHtml(xhr.responseText)+"</textarea></div>");
self.loadingSections={}},success:function(data){self.loadingSections={};Object.each(data,function(sectionData,sectionId){if(sectionData===null||!sectionData.section_html){self.getSectionData(sectionId)
}if(callback_map[sectionId]){callback_map[sectionId](sectionData)}})}})},prepareWidgetedHtml:function(html){var finalHtml=html,widgetCssRegex=/<style type="text\/css" data-widget="(\d+)" data-hash="([a-zA-Z0-9]+)">([\s\S]*?)<\/style>/g,widgetJsRegex=/<script type="text\/javascript"([^>]*)>([\s\S]*?)<\/script>/g,cssExists={},jsSource=[],jsInline=[],match;
$("style[data-widget]").each(function(){cssExists[$(this).data("widget")]=$(this).data("hash")});while(match=widgetCssRegex.exec(html)){finalHtml=finalHtml.replace(match[0],"");
if(cssExists[match[1]]!==match[2]){cssExists[match[1]]=match[2];$(match[0]).appendTo("head")}}while(match=widgetJsRegex.exec(html)){finalHtml=finalHtml.replace(match[0],"");
if(match[1].match(/src="([^"]+)"/)){jsSource.push(RegExp.$1)}else{if(match[2]){jsInline.push({widget:match[1].match(/data-widget="(\d+)"/)?RegExp.$1:false,htmlId:match[1].match(/data-html-id="([^"]+)"/)?RegExp.$1:false,code:match[2]})
}}}return{html:finalHtml,jsSource:jsSource,jsInline:jsInline}},runWidgetedJs:function(page,src,inline){var run=function(){for(var i=0;
i<inline.length;i++){var code=inline[i].code,htmlId=inline[i].htmlId,context;if(inline[i].widget){context={page:page,meta:page.getAllMetaData(),id:htmlId,containerEl:(htmlId?$("#"+htmlId+"_container"):false),contentEl:(htmlId?$("#"+htmlId):false),tabEl:(htmlId?$("#"+htmlId+"_tab"):false)};
eval("(function() {"+code+"}).call(context);")}else{$.globalEval(code)}}};if(!src.length){run()}else{var remaining=src.length,self=this;
for(var i=0;i<src.length;i++){$.ajax({url:src[i],type:"GET",dataType:"script",cache:true}).always(function(){remaining--;
if(remaining==0){run()}})}}},canUseAgentReplyRte:function(){if(window.DP_SETTINGS){return window.DP_SETTINGS["core_tickets.enable_agent_rte"]
}return true},initRteAgentReply:function(textarea,options){return DeskPRO.Agent.RteEditor.initRteAgentReply(textarea,options)
},initAgentNotifierForRte:function(obj,textarea,agentMap,alwaysAvailable){var api=textarea.data("redactor");
if(!api){return}if(!agentMap){return}var ed=textarea.getEditor();var self=this;delete agentMap[0];var agentMapLower={},hasAgents=false;
Object.each(agentMap,function(data,agentId){hasAgents=true;agentMapLower[agentId]=data.name.toLowerCase()
});if(!hasAgents){return}obj.agentNotifyList=$("<ul />").addClass("message-agent-notify-list").hide().appendTo(document.body);
var insertAgentNotify=function(agentId){if(typeof agentMap[agentId]==="undefined"){return}self.hideAgentNotifyList(obj);
var focus=api.getFocus(),focusNode=$(focus[0]),testText;if(!focus||!focus[0]){return}if(focus[0].nodeType==3){testText=focusNode.text().substring(0,focus[1])
}else{focus[0]=focusNode.contents().get(focus[1]-1);focusNode=$(focus[0]);testText=focusNode.text();focus[1]=testText.length
}var lastAt=testText.lastIndexOf("@"),matches=[];if(lastAt!=-1){api.setSelection(focus[0],lastAt,focus[0],focus[1])
}var editable=$.browser.webkit?' contenteditable="false"':"";api.insertHtml("<span"+editable+' data-notify-agent-id="'+agentId+'">@'+Orb.escapeHtml(agentMap[agentId].name)+"</span>&nbsp;")
};obj.agentNotifyList.on("mousedown","li",function(e){e.preventDefault();insertAgentNotify($(this).data("agent-id"))
});ed.on("click blur",function(){if(obj.isNote||alwaysAvailable){self.hideAgentNotifyList(obj)}});ed.on("keydown",function(e){if(!obj.isNote&&!alwaysAvailable){self.hideAgentNotifyList(obj);
return}switch(e.keyCode){case 38:case 40:case 13:if(!obj.agentNotifyList.is(":visible")){return}break;
default:return}e.preventDefault();if(e.keyCode==13){var li=obj.agentNotifyList.find("li.selected");if(!li.length){li=obj.agentNotifyList.find("li:first")
}insertAgentNotify(li.data("agent-id"))}else{if(e.keyCode==40){var li=obj.agentNotifyList.find("li.selected");
if(!li.length){obj.agentNotifyList.find("li:first").addClass("selected")}else{li.removeClass("selected");
var next=li.next("li");if(next.length){next.addClass("selected")}else{obj.agentNotifyList.find("li:first").addClass("selected")
}}}else{if(e.keyCode==38){var li=obj.agentNotifyList.find("li.selected");if(!li.length){obj.agentNotifyList.find("li:last").addClass("selected")
}else{li.removeClass("selected");var prev=li.prev("li");if(prev.length){prev.addClass("selected")}else{obj.agentNotifyList.find("li:last").addClass("selected")
}}}}}});ed.on("keyup",function(e){if(!obj.isNote&&!alwaysAvailable){return}if(e.ctrlKey||e.metaKey){return
}switch(e.keyCode){case 16:case 17:case 18:case 19:case 20:case 91:case 92:case 93:case 224:return;case 13:case 38:case 40:e.stopImmediatePropagation();
e.preventDefault();return;case 9:case 27:case 33:case 34:case 35:case 36:case 37:case 39:self.hideAgentNotifyList(obj);
return;default:if(e.keyCode>=112&&e.keyCode<=145){self.hideAgentNotifyList(obj);return}}var focus=api.getFocus(),origin=api.getOrigin(),selection=api.getSelection();
if(focus[0]!=origin[0]||focus[1]!=origin[1]){self.hideAgentNotifyList(obj);return}var focusNode=$(focus[0]),testText=focus[0].nodeType==3?focusNode.text().substring(0,focus[1]):$(focusNode.contents().get(focus[1]-1)).text(),lastAt=testText.lastIndexOf("@"),matches=[];
if(lastAt!=-1&&(lastAt==0||testText[lastAt-1].match(/^(\s|[\.!?:;,()<>|/-])$/))){var afterAt=testText.substring(lastAt+1,testText.length).toLowerCase();
if(afterAt.length>=2&&afterAt.length<75){Object.each(agentMap,function(data,agentId){if(agentMapLower[agentId].indexOf(afterAt)==0){matches.push(agentId)
}})}}if(matches.length){var selectedId=obj.agentNotifyList.find("li:selected").data("agent-id");obj.agentNotifyList.empty();
for(var i=0;i<matches.length;i++){var li=$("<li>").text(agentMap[matches[i]].name).css("background-image","url("+agentMap[matches[i]].picture_url+")").data("agent-id",matches[i]);
if(matches[i]===selectedId){li.addClass("selected")}obj.agentNotifyList.append(li)}if(!obj.agentNotifyList.find("li:selected").length){obj.agentNotifyList.find("li:first").addClass("selected")
}var containingNode=focus[0].nodeType==3?focusNode.parent():focusNode;if(!containingNode.is("div, p, li, ul, ol, blockquote, table, body")){containingNode=containingNode.closest("div, p, li, ul, ol, blockquote, table, body")
}var offset=containingNode.offset();if(selection){var selOffset=Orb.getSelectionCoords(selection);if(selOffset){offset=selOffset
}}obj.agentNotifyList.css({top:offset.top-obj.agentNotifyList.outerHeight()-1,left:offset.left});obj.agentNotifyList.show();
obj.agentNotifyListShown=true}else{self.hideAgentNotifyList(obj)}});ed.data("events").keyup.reverse()
},hideAgentNotifyList:function(obj){if(obj.agentNotifyList&&obj.agentNotifyListShown){obj.agentNotifyList.empty().hide();
obj.agentNotifyListShown=false}},dumpDom:function(){var zindexRules=[];var zindexGot={};$("*").each(function(){var zindex=$(this).css("z-index");
if(zindex!="auto"){if(!zindexGot[zindex]){zindexRules.push(".zindex"+zindex+" { z-index: "+zindex+" !important; }");
zindexGot[zindex]=true}$(this).addClass("zindex"+zindex)}});zindexRules=zindexRules.join("\n");var css=["<!-- DP_DUMP_CSS_BEGIN -->",'<style type="text/css">'];
$.each(document.styleSheets,function(sheetIndex,sheet){$.each(sheet.cssRules||sheet.rules,function(ruleIndex,rule){css.push(rule.cssText)
})});css.push(zindexRules);css.push("</style>");css.push("<!-- DP_DUMP_CSS_END -->");css=css.join("\n");
var html=$("html").html();html=html.replace("</head>",css+"</head>");html=html.replace("DP_IS_DOMDUMP_VIEW = false","DP_IS_DOMDUMP_VIEW = true");
$.ajax({type:"POST",url:BASE_URL+"agent/save-dom.json",data:{html:html}})},openNotices:function(){var first=false;
if(!this._noticeEl){first=true}this.getNoticeEl().show();if(first){this.loadNextNotice()}},_updateNoticeEl:function(){var left=($(window).width()/2)-(this._noticeEl.outerWidth()/2);
this._noticeEl.css("left",left);if(this._noticeIds.length==1){$("#notices_control").remove();$("#notices_content").css("padding-bottom",0)
}},getNoticeEl:function(){var self=this;if(this._noticeEl){this._updateNoticeEl();return this._noticeEl
}var html='<div class="dark-overlay-box dp-notices-box">'+'<em class="close-trigger"></em>'+"<form>"+'<div class="title">'+'<div style="float:right">'+'<button class="clean-white dismiss">Dismiss</button>'+'<button class="clean-white dismiss-all">Dismiss All</button>'+"</div>"+"New Version Notes</div>"+'<div id="notices_content"></div>'+'<div id="notices_control">'+'<button class="clean-white prev">&larr;</button>'+'<button class="clean-white next">&rarr;</button>'+"</div>"+"</form>"+"</div>";
this._noticeEl=$(html);this._noticeEl.hide();this._noticeEl.appendTo("body");this._noticeEl.find(".close-trigger").on("click",function(ev){ev.preventDefault();
self._noticeEl.hide()});this._noticeEl.find(".dismiss-all").on("click",function(ev){ev.preventDefault();
self.dismissAllNotices()});this._noticeEl.find(".dismiss").on("click",function(ev){ev.preventDefault();
var current=self._noticeIds[self._noticeIndex];self.dismissNotice(current);self._noticeIndex--;self.loadNextNotice()
});this._noticeEl.find(".prev").on("click",function(ev){ev.preventDefault();self.loadPrevNotice()});this._noticeEl.find(".next").on("click",function(ev){ev.preventDefault();
self.loadNextNotice()});this._updateNoticeEl();return this._noticeEl},dismissAllNotices:function(){$.ajax({url:BASE_URL+"agent/misc/version-notices/ALL/dismiss.json",dataType:"json"});
this._noticeEl.hide();$("#notice_trigger").hide()},dismissNotice:function(id){$.ajax({url:BASE_URL+"agent/misc/version-notices/"+id+"/dismiss.json",dataType:"json"});
this._noticeIds.erase(id);if(!this._noticeIds.length){this._noticeEl.hide();$("#notice_trigger").hide();
return}this._updateNoticeEl();$("#notice_trigger").find(".badge").text(this._noticeIds.length)},loadNotice:function(id){$("#notices_content").html('<div class="loading-icon-big"></div>');
$.ajax({url:BASE_URL+"agent/misc/version-notices/"+id+"/log.html",dataType:"html",success:function(html){$("#notices_content").html(html)
}})},loadNextNotice:function(){this._noticeIndex++;if(this._noticeIds.length==this._noticeIndex){this._noticeIndex=0
}if(!this._noticeIds.length){this._noticeEl.hide();$(".DP-version-notes").hide();return}this.loadNotice(this._noticeIds[this._noticeIndex])
},loadPrevNotice:function(){this._noticeIndex--;if(this._noticeIndex<0){this._noticeIndex=this._noticeIds.length-1
}this.loadNotice(this._noticeIds[this._noticeIndex])},setPaneVis:function(id,vis){this.paneVis[id]=vis;
this.layout.doResize(true)},setPaneVisNum:function(num){switch(num){case 0:this.paneVis.source=true;this.paneVis.list=true;
this.paneVis.tabs=true;break;case 1:this.paneVis.source=true;this.paneVis.list=true;this.paneVis.tabs=false;
break;case 2:this.paneVis.source=true;this.paneVis.list=false;this.paneVis.tabs=true;break;case 3:this.paneVis.source=false;
this.paneVis.list=true;this.paneVis.tabs=false;break;case 4:this.paneVis.source=false;this.paneVis.list=false;
this.paneVis.tabs=true;break;case 5:this.paneVis.source=false;this.paneVis.list=true;this.paneVis.tabs=true;
break}this.layout.doResize(true)},getPaneVisNum:function(){var source=this.paneVis.source,list=this.paneVis.list,tabs=this.paneVis.tabs;
if(source&&list&&tabs){return 0}if(source&&list&&!tabs){return 1}if(source&&!list&&tabs){return 2}if(!source&&list&&!tabs){return 3
}if(!source&&!list&&tabs){return 4}if(!source&&list&&tabs){return 5}return 0}});Orb.createNamespace("DeskPRO.Agent.Layout");
DeskPRO.Agent.Layout.DeskproWindow=Orb.Class({Implements:[Orb.Util.Events],initialize:function(){var self=this;
this.LEFT_START=215;this.CENTER_START=55;this.listWidthRatio=0.4;this.enableHashUpdate=true;window.onresize=function(){self.doResize(true)
};var listSizer=$("#dp_list_resizer").draggable({axis:"x"}).on("dragstop",function(){var pos=parseInt(listSizer.css("left").replace(/px/,""));
self.doResize()})},doResize:function(widthCalc){var rightHide=$("#dp_right_collapsed");var listSizer=$("#dp_list_resizer");
var paneVis=DeskPRO_Window.paneVis;var newWidth=$(window).width();var totalWidth=newWidth-this.LEFT_START-this.CENTER_START;
var listWidth;if(widthCalc){listWidth=totalWidth*this.listWidthRatio;if(typeof Modernizr!="undefined"&&Modernizr.ipad){if(listWidth<370){listWidth=370
}}else{if(listWidth<370){listWidth=370}}}else{listWidth=parseInt(listSizer.css("left").replace(/px/,""))-this.LEFT_START;
this.listWidthRatio=listWidth/totalWidth}$("#dp_list").width(listWidth);$("#dp_omnibox_wrap").width(listWidth-1);
$("#dp_omnibox").width(listWidth-56);$("#dp_content").css("left",this.LEFT_START+listWidth+1);$(".with-scroll-handler").each(function(){if($(this).data("scroll_handler")){$(this).data("scroll_handler").updateSize()
}});if(!paneVis.tabs){var rightEdge=0;if(rightHide.find("li")[0]){rightEdge=26;rightHide.show()}else{rightHide.hide()
}$("#dp_content").hide();$("#dp_list").css({width:"auto",right:rightEdge})}else{rightHide.hide();$("#dp_content").show();
$("#dp_list").css({right:"auto"})}var left=0;if(!paneVis.source){$("#dp_source").hide();$("#dp_center").css("left",55)
}else{$("#dp_source").show();$("#dp_nav").show();$("#dp_center").css("left",55);left+=215}if(!paneVis.list){$("#dp_list").hide();
listSizer.hide()}else{$("#dp_list").show();listSizer.show();if(!paneVis.source){$("#dp_list").css("left",0);
left+=listWidth}else{$("#dp_list").css("left",this.LEFT_START);left+=listWidth}}if(left){$("#dp_content").css("left",left)
}else{$("#dp_content").css("left",0)}listSizer.css("left",left-2);var body=$("body");if(paneVis.source){body.addClass("panevis-source-on").removeClass("panevis-source-off")
}else{body.removeClass("panevis-source-on").addClass("panevis-source-off")}if(paneVis.list){body.addClass("panevis-list-on").removeClass("panevis-list-off")
}else{body.removeClass("panevis-list-on").addClass("panevis-list-off")}if(paneVis.tabs){body.addClass("panevis-tabs-on").removeClass("panevis-tabs-off")
}else{body.removeClass("panevis-tabs-on").addClass("panevis-tabs-off")}if(this.enableHashUpdate){DeskPRO_Window.updateWindowUrlFragment()
}this.fireEvent("resized",[this])}});Orb.createNamespace("DeskPRO.Agent.WindowElement");DeskPRO.Agent.TabWatcher=new Orb.Class({Implements:[Orb.Util.Options,Orb.Util.Events],initialize:function(options){this.options={tabManager:null};
this.setOptions(options);this.tabManager=this.options.tabManager;this.selectionHistory=[];this.tabManager.addEvent("activateTab",this._activateTab,this);
this.tabManager.addEvent("addTab",this._addTab,this);this.tabManager.addEvent("deactivateTab",this._deactivateTab,this);
this.tabManager.addEvent("removeTab",this._removeTab,this);this.watchedTypes={}},_activateTab:function(tab,containerEl,tabManager){var id=tab.id;
this.selectionHistory.erase(id);this.selectionHistory.push(id);var typename=this.getTabType(tab);if(this.watchedTypes[typename]){Array.each(this.watchedTypes[typename],function(watcher){watcher.fireEvent("watchedTabActivated",[tab])
})}if(this.watchedTypes["*"]){Array.each(this.watchedTypes["*"],function(watcher){watcher.fireEvent("watchedTabActivated",[tab])
})}},_addTab:function(tab,containerEl,tabManager){var typename=this.getTabType(tab);if(this.watchedTypes[typename]){Array.each(this.watchedTypes[typename],function(watcher){watcher.fireEvent("watchedTabAdded",[tab])
})}if(this.watchedTypes["*"]){Array.each(this.watchedTypes["*"],function(watcher){watcher.fireEvent("watchedTabAdded",[tab])
})}},_deactivateTab:function(tab,containerEl,tabManager){var typename=this.getTabType(tab);var isLast=false;
if(this.tabManager.tabCount==1){isLast=true}if(this.watchedTypes[typename]){Array.each(this.watchedTypes[typename],function(watcher){watcher.fireEvent("watchedTabDeactivated",[tab,isLast])
})}if(this.watchedTypes["*"]){Array.each(this.watchedTypes["*"],function(watcher){watcher.fireEvent("watchedTabDeactivated",[tab,isLast])
})}},_removeTab:function(tab,tabManager){this.selectionHistory.erase(tab.id);var typename=this.getTabType(tab);
if(this.watchedTypes[typename]){Array.each(this.watchedTypes[typename],function(watcher){watcher.fireEvent("watchedTabRemoved",[tab])
})}if(this.watchedTypes["*"]){Array.each(this.watchedTypes["*"],function(watcher){watcher.fireEvent("watchedTabRemoved",[tab])
})}},addTabTypeWatcher:function(typename,watcher,notifyOfExisting){if(!this.watchedTypes[typename]){this.watchedTypes[typename]=[]
}this.watchedTypes[typename].push(watcher);if(notifyOfExisting){Array.each(DeskPRO_Window.getTabWatcher().findTabType(typename),function(tab){watcher.fireEvent("watchedTabAdded",tab)
})}},removeTabTypeWatcher:function(typename,watcher){if(!this.watchedTypes[typename]){return}this.watchedTypes[typename].erase(watcher)
},getActiveTab:function(){return this.tabManager.getActiveTab()},getActiveTabIfType:function(typename){var tab=this.getActiveTab();
if(this.getTabType(tab)!=typename){return null}return tab},getActiveTabType:function(){return this.getTabType(this.getActiveTab())
},isTabTypeActive:function(typename){return this.getActiveTabType()==typename},getTabType:function(tab){if(!tab){return null
}if(tab.page){if(tab.page.TYPENAME&&tab.page.TYPENAME!="loading"){return tab.page.TYPENAME}else{if(tab.page.TYPENAME_FOR){return tab.page.TYPENAME_FOR
}}}return"general"},getLastSelectedTab:function(steps){var l=this.selectionHistory.length-1;l-=steps;
if(l<0){return null}return this.getTab(this.selectionHistory[l])},getLastSelectedTabType:function(typename){var len=this.selectionHistory.length-1;
if(!len){return null}while(len-->0){var tab=this.getTab(len);if(this.getTabType(tab)==typename){return tab
}}return null},getSelectionHistory:function(){var tabs=[];Array.each(this.selectionHistory,function(id){tabs.push(this.getTab(id))
},this);tabs.reverse();return tabs},findTabType:function(typename){var tabs=[];Object.each(this.tabManager.getTabs(),function(tab){if(this.getTabType(tab)==typename){tabs.push(tab)
}},this);return tabs},findTab:function(typename,filter){var found=null;Object.each(this.tabManager.getTabs(),function(tab){if(!typename||this.getTabType(tab)==typename){if(!filter||filter(tab)){found=tab;
return false}}},this);return found},findTabs:function(typename,filter){var tabs=[];Object.each(this.tabManager.getTabs(),function(tab){if(!typename||this.getTabType(tab)==typename){if(!filter||filter(tab)){tabs.push(tab)
}}},this);return tabs}});Orb.createNamespace("DeskPRO.Agent");if(!window.DP_NO_JS_SCROLL){DeskPRO.Agent.ScrollerHandler=new Orb.Class({Implements:[Orb.Util.Options],initialize:function(pageObject,element,options){var hasInit=false;
$.extend(options,{"showEvent":false,"hideEvent":false});element=$(element);element.data("scroll_handler",this);
element.addClass("with-scroll-handler");var scrollTrack=null;var onScrollTimer=false;function initScroll(){if(!element){return
}if(hasInit){return}hasInit=true;element.tinyscrollbar();element.on("dp_scroll",function(){if(!onScrollTimer){onScrollTimer=setTimeout(function(){onScrollTimer=false;
if(element){element.find(".select2-dropdown-open").select2("positionDropdown")}},25)}})}function updateSize(){if(!element){return
}initScroll();if(element.tinyscrollbar_update){element.tinyscrollbar_update()}}function isScrollEnabled(){if(!scrollTrack){element.find("> .scrollbar")
}return element.hasClass("disable")}function restorePosition(){if(!element){return}if(hasInit&&element){element.trigger("restorescroll")
}}function destroy(){if(!element){return}if(hasInit&&element.tinyscrollbar_destroy){element.tinyscrollbar_destroy()
}element=null;options=null;pageObject=null}if(pageObject&&pageObject.addEvent&&options.showEvent){pageObject.addEvent(options.showEvent,updateSize)
}else{initScroll()}this.updateSize=updateSize;this.restorePosition=restorePosition;this.destroy=destroy;
this.isScrollEnabled=isScrollEnabled;this.isInitialized=function(){return hasInit};this.getElement=function(){return element
}}})}else{DeskPRO.Agent.ScrollerHandler=new Orb.Class({Implements:[Orb.Util.Options],initialize:function(pageObject,$element,options){var scroller;
var resetLastX=null;var resetLastY=null;var resetTimeout=null;$.extend(options,{"showEvent":false,"hideEvent":false});
$element=$($element);$element.data("scroll_handler",this);$element.addClass("with-scroll-handler");$element.on("goscrolltop",function(){});
$element.on("scrollupdate",function(){});$element.on("goscrollbottom",function(){});$element.on("goscrollbottom_stick",function(){});
function initScroll(){}function updateSize(){return}function restorePosition(){return}function destroy(){if(!$element){return
}$element=null;options=null;pageObject=null}function scrollToElement(el){el=$(el);if(scroller){scroller.scrollToElement(el.get(0))
}}this.updateSize=updateSize;this.restorePosition=restorePosition;this.destroy=destroy;this.scrollToElement=scrollToElement;
this.isInitialized=function(){return !!scroller};this.getElement=function(){return $element}}})}Orb.createNamespace("DeskPRO.Agent");
DeskPRO.Agent.KeyboardShortcuts=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(){var self=this;
if(!DESKPRO_ENABLE_KB_SHORTCUTS){return}this.isWindows=navigator.platform.toUpperCase().indexOf("WIN")!==-1;
this.isMac=navigator.platform.toUpperCase().indexOf("MAC")!==-1;$(document).bind("keydown","ctrl+shift+left",this.tabLeft.bind(this));
$(document).bind("keydown","ctrl+shift+right",this.tabRight.bind(this));$(document).bind("keydown","ctrl+shift+c",this.closeTab.bind(this));
$(document).bind("keydown","alt+c",this.saveContent.bind(this));$(document).bind("keydown","shift+t",this.goTabTop.bind(this));
$(document).bind("keydown","shift+/",function(){if($("#dp_header_help").hasClass("active")){Orb.shimClickCallbackPop()
}else{$("#dp_header_help_trigger").click()}});function getActiveListNav(){var listNav=null;if(DeskPRO_Window.activeListNav){listNav=DeskPRO_Window.activeListNav
}else{var p=DeskPRO_Window.getListPage();if(p&&p.listNav){listNav=p.listNav}}return listNav}var navigateListPane=function(action){return function(ev){var listNav=getActiveListNav();
if(listNav){listNav[action]()}}};$(document).bind("keydown","down",navigateListPane("down"));$(document).bind("keydown","up",navigateListPane("up"));
$(document).bind("keydown","return",navigateListPane("enter"));$(document).bind("keydown","space",navigateListPane("check"));
if(DeskPRO_Window.newTicketLoader){$(document).bind("keydown","t",this.showNewTicket.bind(this))}if(DeskPRO_Window.newArticleLoader){$(document).bind("keydown","a",this.showNewArticle.bind(this))
}if(DeskPRO_Window.newNewsLoader){$(document).bind("keydown","n",this.showNewNews.bind(this))}if(DeskPRO_Window.newDownloadLoader){$(document).bind("keydown","d",this.showNewDownload.bind(this))
}if(DeskPRO_Window.newFeedbackLoader){$(document).bind("keydown","i",this.showNewFeedback.bind(this))
}if(DeskPRO_Window.newPersonLoader){$(document).bind("keydown","p",this.showNewPerson.bind(this))}if(DeskPRO_Window.newOrganizationLoader){$(document).bind("keydown","o",this.showNewOrganization.bind(this))
}if(DeskPRO_Window.newTweetLoader){$(document).bind("keydown","w",this.showNewTweet.bind(this))}$(document).bind("keydown","k",this.showNewTask.bind(this));
this.boundShortkuts={};this.addContextShortcut("ticket","shift+r","shortcutFocusReply");this.addContextShortcut("ticket","shift+p","openUserProfile");
if(this.isMac){this.addContextShortcut("ticket","ctrl+s","shortcutOpenSnippets");this.addContextShortcut("ticket","ctrl+r","shortcutSendReply");
this.addContextShortcut("ticket","ctrl+u","shortcutReplySetAwaitingUser");this.addContextShortcut("ticket","ctrl+a","shortcutReplySetAwaitingAgent");
this.addContextShortcut("ticket","ctrl+d","shortcutReplySetResolved");this.addContextShortcut("ticket","ctrl+o","shortcutReplyOpenProperties")
}else{this.addContextShortcut("ticket","alt+s","shortcutOpenSnippets");this.addContextShortcut("ticket","alt+r","shortcutSendReply");
this.addContextShortcut("ticket","alt+u","shortcutReplySetAwaitingUser");this.addContextShortcut("ticket","alt+a","shortcutReplySetAwaitingAgent");
this.addContextShortcut("ticket","alt+d","shortcutReplySetResolved");this.addContextShortcut("ticket","alt+o","shortcutReplyOpenProperties")
}this.addContextShortcut("ticket","shift+o","openOrgProfile");this.addContextShortcut("person","shift+o","openOrgProfile")
},pause:function(){this.isPaused=true},resume:function(){this.isPaused=false},addContextShortcut:function(pageTypeName,key,eventName){if(this.isPaused){return
}if(!this.boundShortkuts[key]){this.boundShortkuts[key]={};$(document).bind("keydown",key,(function(ev){this.dispatchShortcutEvent(ev,key)
}).bind(this))}this.boundShortkuts[key][pageTypeName]=eventName},dispatchShortcutEvent:function(ev,key){if(this.isPaused){return
}if(!this.boundShortkuts[key]){return}var page=DeskPRO_Window.getCurrentTabPage();if(!page||!page.TYPENAME||!this.boundShortkuts[key][page.TYPENAME]){return
}page.fireEvent(this.boundShortkuts[key][page.TYPENAME],[ev,key])},hasModalOpen:function(except){if(except!="newTicketLoader"&&DeskPRO_Window.newTicketLoader&&DeskPRO_Window.newTicketLoader.isOpen()){return true
}if(except!="newArticleLoader"&&DeskPRO_Window.newArticleLoader&&DeskPRO_Window.newArticleLoader.isOpen()){return true
}if(except!="newNewsLoader"&&DeskPRO_Window.newNewsLoader&&DeskPRO_Window.newNewsLoader.isOpen()){return true
}if(except!="newDownloadLoader"&&DeskPRO_Window.newDownloadLoader&&DeskPRO_Window.newDownloadLoader.isOpen()){return true
}if(except!="newFeedbackLoader"&&DeskPRO_Window.newFeedbackLoader&&DeskPRO_Window.newFeedbackLoader.isOpen()){return true
}if(except!="newPersonLoader"&&DeskPRO_Window.newPersonLoader&&DeskPRO_Window.newPersonLoader.isOpen()){return true
}if(except!="newOrganizationLoader"&&DeskPRO_Window.newOrganizationLoader&&DeskPRO_Window.newOrganizationLoader.isOpen()){return true
}if(except!="newTaskLoader"&&DeskPRO_Window.newTaskLoader&&DeskPRO_Window.newTaskLoader.isOpen()){return true
}if($("body").find("> .deskpro-overlay-outer").is(":visible")){return true}return false},goTabTop:function(){if(this.isPaused||this.hasModalOpen()){return
}var page=DeskPRO_Window.getCurrentTabPage();if(page){page.goTabTop()}},showNewTicket:function(ev){if(this.isPaused||this.hasModalOpen("newTicketLoader")){return
}DeskPRO_Window.newTicketLoader.toggle()},showNewArticle:function(ev){if(this.isPaused||this.hasModalOpen("newArticleLoader")){return
}DeskPRO_Window.newArticleLoader.toggle()},showNewNews:function(ev){if(this.isPaused||this.hasModalOpen("newNewsLoader")){return
}DeskPRO_Window.newNewsLoader.toggle()},showNewDownload:function(ev){if(this.isPaused||this.hasModalOpen("newDownloadLoader")){return
}DeskPRO_Window.newDownloadLoader.toggle()},showNewFeedback:function(ev){if(this.isPaused||this.hasModalOpen("newFeedbackLoader")){return
}DeskPRO_Window.newFeedbackLoader.toggle()},showNewPerson:function(ev){if(this.isPaused||this.hasModalOpen("newPersonLoader")){return
}DeskPRO_Window.newPersonLoader.toggle()},showNewOrganization:function(ev){if(this.isPaused||this.hasModalOpen("newOrganizationLoader")){return
}DeskPRO_Window.newOrganizationLoader.toggle()},showNewTask:function(ev){if(this.isPaused||this.hasModalOpen("newTaskLoader")){return
}$("form#newTaskForm input, form#newTaskForm select").val("");DeskPRO_Window.newTaskLoader.toggle()},showNewTweet:function(ev){if(this.isPaused||this.hasModalOpen("newTweetLoader")){return
}DeskPRO_Window.newTweetLoader.toggle()},showNewDeal:function(ev){if(this.isPaused||this.hasModalOpen()){return
}DeskPRO_Window.newDealLoader.toggle()},saveContent:function(){if(this.isPaused){return}var page=null;
Object.each(DeskPRO.Agent.PageHelper.Popover_Instances,function(inst){if(inst.isOpen()){page=inst.page
}});if(!page){var tab=DeskPRO_Window.getTabWatcher().getActiveTab();if(tab){page=tab.page}}if(!page){return false
}var wrapper=page.wrapper||page.el||page.wrap||false;if(!wrapper){return false}if(page.submit){page.submit()
}else{var form=$("form.keybound-submit",wrapper);if(!form.length){return false}form.submit()}},tabLeft:function(ev){if(this.isPaused){return
}var activeTab=$("li.activeTabList",DeskPRO_Window.TabBar.tabList);var next=activeTab.prev();if(!next.length){next=$("li:last",DeskPRO_Window.TabBar.tabList)
}if(!next.is(".activeTabList")){DeskPRO_Window.TabBar.activateTabById(next.data("tab-id"))}},tabRight:function(ev){if(this.isPaused){return
}var activeTab=$("li.activeTabList",DeskPRO_Window.TabBar.tabList);var next=activeTab.next();if(!next.length){next=$("li:first",DeskPRO_Window.TabBar.tabList)
}if(!next.is(".activeTabList")){DeskPRO_Window.TabBar.activateTabById(next.data("tab-id"))}},closeTab:function(ev){if(this.isPaused){return
}var activeTab=DeskPRO_Window.TabBar.getActiveTab();if(activeTab){DeskPRO_Window.TabBar.removeTabById(activeTab.id)
}}});Orb.createNamespace("DeskPRO.Agent");DeskPRO.Agent.Notifications=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(){var self=this;
this.fireEvent("init");this.dismissedIds=[];if(Modernizr.localstorage&&window.localStorage["dpa_dissmissalerts"]){this.dismissedIds=window.localStorage["dpa_dissmissalerts"].split(",");
for(var i=0;i<this.dismissedIds.length;i++){this.dismissedIds[i]=parseInt(this.dismissedIds[i],10)}}DeskPRO_Window.getMessageBroker().addMessageListener("agent-notify.tickets",function(info){this.addRow(info.row,info.alert_id||null)
},this);DeskPRO_Window.getMessageBroker().addMessageListener("agent-notify.tasks",function(info){this.addRow(info.row)
},this);DeskPRO_Window.getMessageBroker().addMessageListener("agent-notify.new_comment",function(info){this.addRow(info.row)
},this);DeskPRO_Window.getMessageBroker().addMessageListener("agent-notify.new_feedback",function(info){this.addRow(info.row)
},this);DeskPRO_Window.getMessageBroker().addMessageListener("agent-notify.new_registration",function(info){this.addRow(info.row)
},this);DeskPRO_Window.getMessageBroker().addMessageListener("agent-notify.twitter",function(info){this.addRow(info.row)
},this);$("#dp_header_notify_wrap").on("click",".trigger-dismiss",function(ev){Orb.cancelEvent(ev);self.dismissAll();
Orb.shimClickCallbackPop()}).on("click",".dismiss",function(ev){Orb.cancelEvent(ev);ev.stopImmediatePropagation();
var ul=$(this).closest("ul");var row=$(this).closest("li");if(row.data("alert-id")){self.dismissAlertId(row.data("alert-id"));
DeskPRO_Window.getMessageChanneler().poller.send()}self.removeRow(row);if(!ul.find("li")[0]){Orb.shimClickCallbackPop()
}}).on("click","li.inside",function(ev){Orb.cancelEvent(ev);ev.stopImmediatePropagation();DeskPRO_Window.runPageRouteFromElement($(this));
var ul=$(this).closest("ul");var row=$(this).closest("li");if(row.data("alert-id")){self.dismissAlertId(row.data("alert-id"));
DeskPRO_Window.getMessageChanneler().poller.send()}self.removeRow(row);if(!ul.find("li")[0]){Orb.shimClickCallbackPop()
}}).on("click",".trigger-notify-prefs",function(ev){Orb.cancelEvent(ev);ev.stopImmediatePropagation();
Orb.shimClickCallbackPop();$("#settingswin").trigger("dp_open","ticket-notify")})},dismissAll:function(){var self=this;
$("#dp_notify_list").find("li").each(function(){var row=$(this);self.removeRow(row,true)});DeskPRO_Window.dismissAlertQueue=[-1];
DeskPRO_Window.getMessageChanneler().poller.send()},dismissAlertId:function(alertId){alertId=parseInt(alertId);
this.dismissedIds.include(alertId);DeskPRO_Window.dismissAlertQueue.push(alertId);if(this.dismissedIds.length>1000){while(this.dismissedIds.length>1000){this.dismissedIds.shift()
}}if(Modernizr.localstorage){window.localStorage["dpa_dissmissalerts"]=this.dismissedIds.join(",")}if($("#dp_notify_list").find("li").length<1){DeskPRO_Window.dismissAlertQueue=[-1]
}},isDismissedAlready:function(alertId){alertId=parseInt(alertId);return this.dismissedIds.indexOf(alertId)!==-1
},getListTypeByType:function(type){var listType=null;if(type=="tickets"){listType="tickets"}else{if(type=="new_registration"){listType="people"
}else{if(type=="chat"){listType="chat"}else{if(type=="tasks"){listType="tasks"}else{if(type=="new_comment"||type=="new_feedback"){listType="publish"
}}}}}return listType},addRow:function(html_or_el,alert_id){if(alert_id&&this.isDismissedAlready(alert_id)){this.dismissAlertId(alert_id);
return}var row=$(html_or_el);row.addClass("msg-row");row.data("route-notabreload",1).attr("data-route-notabreload",1);
if(alert_id){row.data("alert-id",alert_id);row.attr("data-alert-id",alert_id)}var type=row.data("type");
if(type=="chat"){return}var listType=this.getListTypeByType(type);var list=$("#dp_header_notify_wrap").find("li.type-row."+listType).find("ul.notify-list");
var self=this;var time=row.find("time");if(time[0]){if(!time.attr("datetime")){time.attr("datetime",(new Date()).toISOString())
}Orb.Util.TimeAgo.refreshElements([time.get(0)])}var ev={row:row,type:type};this.fireEvent("addRow");
list.prepend(row);this.modCount(type,"+");if(window.webkitNotifications&&window.webkitNotifications.checkPermission()==0&&DeskPRO_Window.getMessageChanneler().hasDoneInitialLoad){var icon=row.data("icon")||"";
if(icon){icon=ASSETS_BASE_URL+"/"+icon}var notification=window.webkitNotifications.createNotification(icon,row.find("big").first().text()||"DeskPRO",row.find("small").first().text());
notification.onclick=function(){window.focus();DeskPRO_Window.runPageRouteFromElement(row);self.removeRow(row)
};notification.onclose=function(){if(!self._isRemoving&&!row.data("notification-timeout")){self.removeRow(row)
}};if(DESKPRO_PERSON_NOTIFICATION_DISMISS){notification.ondisplay=function(){setTimeout(function(){row.data("notification-timeout",true);
notification.cancel()},DESKPRO_PERSON_NOTIFICATION_DISMISS*1000)}}notification.show();row.data("notification",notification)
}},addMessage:function(type,message,route,id){var row=$(DeskPRO_Window.util.getPlainTpl("#dp_header_notify_row_tpl"));
row.data("type",type);row.addClass(type);row.data("data-route",route||"").attr("data-route",route||"").data("route-notabreload",1).attr("data-route-notabreload",1);
row.find("time").addClass("timeago").text("");row.find("big").text(message);if(id){row.addClass("id-"+id)
}this.addRow(row)},findRow:function(id_class){var row=$("#dp_header_notify_wrap").find("li."+id_class);
if(!row[0]){return null}return row},removeRow:function(row,noSendUpdate){this._isRemoving=true;var self=this;
var type=row.data("type");var ev={row:row,type:type};var any_alert_ids=false;this.fireEvent("removeRow");
if(row.data("notification")){if(row.data("notification").close){try{row.data("notification").close()}catch(e){}}if(row.data("notification").cancel){try{row.data("notification").cancel()
}catch(e){}}row.data("notification",false)}row.remove();this.modCount(type,"-");if(row.data("class-id")){var related=$("#dp_header_notify_wrap").find("li."+row.data("class-id"));
related.each(function(){var $related=$(this);$related.remove();if($related.data("alert-id")){any_alert_ids=true;
self.dismissAlertId($related.data("alert-id"))}});this.modCount(type,"-",related.length)}if(row.data("alert-id")){any_alert_ids=true;
this.dismissAlertId(row.data("alert-id"))}if(!noSendUpdate&&any_alert_ids){if($("#dp_notify_list").find("li").length<1){this.dismissAll()
}else{DeskPRO_Window.getMessageChanneler().poller.send()}}this._isRemoving=false},removeRelated:function(related){var self=this;
var any=false;$("#dp_header_notify_wrap").find("li").each(function(){var row=$(this);if(row.data("related")===related){any=true;
self.removeRow(row,true)}});if(any){DeskPRO_Window.getMessageChanneler().poller.send()}},removeRowById:function(id){var self=this;
var row=$("#dp_header_notify_wrap").find("li.id-"+id);row.each(function(){self.removeRow($(this),true)
})},removeRowByClass:function(id){var self=this;var row=$("#dp_header_notify_wrap").find("li."+id);row.each(function(){self.removeRow($(this),true)
})},modCount:function(type,op,count){var listType=this.getListTypeByType(type);if(!listType){return}var list=$("#dp_header_notify_wrap").find("li.type-row."+listType);
var el=list.find(".badge").first();var el2=list.find(".notify-count").first();var ev={notif:this,type:type,op:op,count:count,el:el,el2:el};
this.fireEvent("beforeModCount",ev);newcount=list.find("#dp_notify_list").find("li").length;el.text(newcount);
el2.text(newcount);if(list.find("#dp_notify_list").find("li").length){list.find("#dp_notify_list_none").hide();
list.find("#dp_notify_list_dismiss").show()}else{list.find("#dp_notify_list_none").show();list.find("#dp_notify_list_dismiss").hide()
}if(newcount<1){el.hide();list.removeClass("dp-notifications-on");list.hide();this.fireEvent("typeHide",[type,el]);
if(!$("#dp_header_notify_wrap").find(".dp-notifications-on")[0]){$("#dp_header_notify_wrap").find("li.none").show()
}}else{el.show();list.show();list.addClass("dp-notifications-on");this.fireEvent("typeShow",[type,el]);
$("#dp_header_notify_wrap").find("li.none").hide()}this.fireEvent("modCount",ev)}});Orb.createNamespace("DeskPRO.Agent");
DeskPRO.Agent.RecentTabs=new Orb.Class({initialize:function(){var self=this;this.recentTabIds={};this.recent=[];
this.recentPendingSync=[];this.list=$("#recent_tabs_list");this.idW=0;var eatNext=false;$("#recent_tabs_list").on("click",function(ev){Orb.shimClickCallbackPop()
});$("#recent_tabs_list_filter").on("keydown",function(ev){if(ev.keyCode==13){var current=self.list.find(".dp-cursor");
eatNext=true;if(current[0]){DeskPRO_Window.runPageRouteFromElement(current.find("a"));Orb.shimClickCallbackPop()
}}else{if(ev.keyCode==40||ev.keyCode==38){eatNext=true;var current=self.list.find(".dp-cursor");current.removeClass("dp-cursor");
var dir=ev.keyCode==40?"down":"up";var next;if(!current.length){if(dir=="down"){self.list.find(".dp-vis").first().addClass("dp-cursor")
}else{self.list.find(".dp-vis").last().addClass("dp-cursor")}}else{if(dir=="down"){next=current.next("li.dp-vis");
if(!next.length){next=self.list.find(".dp-vis").first().addClass("dp-cursor")}}else{next=current.prev("li.dp-vis");
if(!next.length){next=self.list.find(".dp-vis").last().addClass("dp-cursor")}}next.addClass("dp-cursor")
}}}}).on("keyup",function(ev){if(eatNext){return}var val=$.trim($(this).val());if(!val){self.list.find("li").show().addClass("dp-vis");
return}val=val.toLowerCase();self.list.find("li").each(function(){if($(this).data("string-match").indexOf(val)!==-1){$(this).show().addClass("dp-vis")
}else{$(this).hide().removeClass("dp-vis")}})});this.reloadRecentTabs()},reloadRecentTabs:function(){$.ajax({url:BASE_URL+"agent/ui/load-recent-tabs.json",type:"GET",dataType:"JSON",context:this,success:function(data){var readd=false;
if(this.recent.length){readd=this.recent}var pending=this.recentPendingSync;this.recent=[];Array.each(data,function(item){this.add(item[0],item[1],item[2],item[3],item[4])
},this);this.recentPendingSync=pending;if(readd){Array.each(readd,function(item){this.add(item[0],item[1],item[2],item[3],item[4])
},this)}}})},open:function(){},close:function(){},add:function(type,id,title,url,ts){$("#recent_tabs_list_li_none").remove();
if(!ts){ts=parseInt((new Date()).getTime()/1000)}var idString=type+"-"+id,idx=null;if(this.recentTabIds[idString]){delete this.recentTabIds[idString];
Array.each(this.recent,function(item,i){if((item[0]+"-"+item[1])==idString){idx=i;return false}});if(idx!==null){this.recent.splice(idx,1);
this.list.find("li."+idString).remove()}}this.recent.unshift([type,id,title,url,ts]);this.recentTabIds[idString]=true;
while(this.recent.length>350){var last=this.recent.pop();this.list.find("li."+last[0]+"-"+last[1]).remove()
}var itm=[type,id,title,url,ts];this.recentPendingSync.unshift(itm);this.renderRow(itm);this.length=this.recent.length
},renderRow:function(item){var row=$(DeskPRO_Window.util.getPlainTpl("#recent_tabs_list_tpl"));var stringMatch=item[2].toLowerCase();
row.addClass(item[0]+"-"+item[1]+" "+item[0]);row.data("string-match",stringMatch);row.find("a").data("route","page:"+item[3]).attr("data-route","page:"+item[3]).data("route-notabreload","1").attr("data-route-notabreload","1").find("span").text(item[2]);
row.find("a").find("strong").text(item[1]);var d=new Date(item[4]*1000);row.find("time").attr("datetime",d.toISOString());
Orb.Util.TimeAgo.refreshElements(row.find("time").toArray());if(this.idW){row.find("strong").css("min-width",this.idW)
}var filterVal=$.trim($("#recent_tabs_list_filter").val());if(!filterVal||stringMatch.indexOf(filterVal.toLowerCase())!==-1){row.addClass("dp-vis")
}else{row.hide()}this.list.prepend(row);var w=row.find("strong").width();if(w>this.idW){this.idW=w;this.list.find("strong").css("min-width",w)
}return row},getAll:function(){return this.recent},clear:function(){this.recent=[];this.recentPendingSync=[];
this.list.clear();this.length=0},getLast:function(){if(this.recent.length){return this.recent[this.recent.length-1]
}return null},getFirst:function(){if(this.recent.length){return this.recent[0]}return null}});Orb.createNamespace("DeskPRO.Agent.PageFragment");
DeskPRO.Agent.PageFragment.Basic=new Orb.Class({Implements:[Orb.Util.Events],initializeProperties:function(){},updateUi:function(){var x;
if(!this.IS_ACTIVE){return}if(this.wrapper){if(!this.scrollHandlers){this.scrollHandlers=this.wrapper.find("div.with-scroll-handler")
}for(x=0;x<this.scrollHandlers.length;x++){var sh=$(this.scrollHandlers[x]).data("scroll_handler");if(sh&&sh.updateSize){sh.updateSize()
}}}this.fireEvent("updateUi")},initialize:function(html){var self=this;this.pageUid=Orb.uuid();this.ZONE="agent";
this.TYPENAME="basic";this.IS_ACTIVE=false;this.allowDupe=false;this.scripts=[];this.stylesheets=[];this.html="";
this.meta={};this.urls={};this.destroyObjects=[];this.featureSelectors={routes:[],times:[]};this.resizerInterval=window.setInterval(function(){self.updateUi()
},1100);this.initializeProperties();if(html){this.html=html}this.addEvent("activate",function(){this.IS_ACTIVE=true;
DeskPRO_Window.getMessageBroker().sendMessage("page-fragment.activated",{page:this});this.updateUi()},this);
this.addEvent("deactivate",function(){this.IS_ACTIVE=false;DeskPRO_Window.getMessageBroker().sendMessage("page-fragment.deactivated",{page:this});
if(this.wrapper){this.wrapper.find(".with-handler").trigger("dp_hide")}},this);this.addEvent("render",function(wrapper){self.wrapper=wrapper;
wrapper.data("page-fragment",self);wrapper.addClass("with-page-fragment");DeskPRO_Window.initInterfaceServices(wrapper);
if(!this.noDeleteHtmlString){delete this.html}this.initPage(wrapper);DeskPRO_Window.getMessageBroker().sendMessage("agent.ui.tabinit."+this.TYPENAME,this)
},this);var self=this;this.addEvent("activate",this.activate);this.addEvent("deactivate",this.deactivate);
this.addEvent("destroy",this.destroyPage);this.init();this.addEvent("activate",function(){this.clearAlerts()
},this);this.addEvent("destroy",function(){this.scrollHandlers=[];if(self.resizerInterval){window.clearInterval(self.resizerInterval)
}if(self.wrapper){self.wrapper.find(".with-scroll-handler").each(function(){var sh=$(this).data("scroll_handler");
if(sh){sh.destroy();$(this).data("scroll_handler",null)}});self.wrapper.find(".with-select2").each(function(){$(this).select2("destroy")
});self.wrapper.find("textarea.with-redactor").each(function(){var obj=$(this).getObject();if(obj){$(this).getObject().destroy()
}});self.wrapper.data("with-page-fragment",null)}if(self.destroyObjects){var i;for(i=0;i<self.destroyObjects.length;
i++){self.destroyObjects[i].destroy()}self.destroyObjects=null}DeskPRO_Window.getMessageBroker().removeTaggedListeners(self.OBJ_ID);
if(self.wrapper){self.wrapper.find(".with-handler").each(function(){var h=$(this).data("handler");if(h){h.destroy()
}});self.wrapper.empty()}});this.addEvent("destroy",this.destroy);if(this.meta.routeData&&this.meta.routeData.routeTriggerEl&&this.meta.routeData.toggleOpenClass){this.addEvent("destroy",function(){this.meta.routeData.routeTriggerEl.removeClass(this.meta.routeData.toggleOpenClass)
},this)}},init:function(){},activate:function(){},deactivate:function(){},ownObject:function(obj){if(obj.destroy&&this.destroyObjects){this.destroyObjects.push(obj)
}},setMetaData:function(name,value){if(value===undefined&&typeOf(name)=="object"){this.meta=Object.merge(this.meta,name);
this.initMetaData()}else{this.meta[name]=value}},initMetaData:function(){},getAllMetaData:function(){return this.meta
},getMetaData:function(name,default_value){if(default_value===undefined){default_value=null}if(this.meta[name]===undefined){return default_value
}return this.meta[name]},getUrl:function(name,vars){if(!this.meta.urls){DP.console.error("Unknown url name %s (no urls set)",name);
return null}if(!this.meta.urls[name]){DP.console.error("Unknown url name %s",name);return null}var url=this.meta.urls[name];
if(vars){Object.each(vars,function(v,k){url=url.replace("{"+k+"}",v)})}return url},getScripts:function(){return this.scripts
},getStylesheets:function(){return this.stylesheets},getHtml:function(){return this.html},initPage:function(el){this.wrapper=el
},destroyPage:function(){},getEl:function(id){if(this.meta&&this.meta.baseId){id=this.meta.baseId+"_"+id
}return $("#"+id)},getTabId:function(){if(this.meta.tabId){return this.meta.tabId}return null},getTab:function(){var tabId=this.getTabId();
if(!tabId){return null}return DeskPRO_Window.TabBar.getTab(tabId)},alertTab:function(){var tab=this.getTab();
if(!tab){return}DeskPRO_Window.TabBar.alertTab(tab)},closeSelf:function(){DeskPRO_Window.removePage(this)
},goTabTop:function(){if(this.wrapper){this.wrapper.find("div.layout-content").trigger("goscrolltop")
}},goTabBottom:function(){if(this.wrapper){this.wrapper.find("div.layout-content").trigger("goscrollbottom")
}},getAlertId:function(){if(this.meta&&this.meta.alert_id){return this.meta.alert_id}return null},clearAlerts:function(){var id=this.getAlertId();
if(!id){return}DeskPRO_Window.notifications.removeRowById(id);DeskPRO_Window.notifications.removeRowByClass(id)
},destroy:function(){}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page");DeskPRO.Agent.PageFragment.Page.Loading=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.allowDupe=true;
this.TYPENAME="loading"},initPage:function(el){this.wrapper=$(el);if(this.meta.routeData&&this.meta.routeData.routeTriggerEl&&this.meta.routeData.toggleOpenClass){this.addEvent("destroy",function(){this.meta.routeData.routeTriggerEl.removeClass(this.meta.routeData.toggleOpenClass)
},this)}}});Orb.createNamespace("DeskPRO.Agent.WindowElement.TabWatcher");DeskPRO.Agent.WindowElement.TabWatcher.Tickets=new Orb.Class({Implements:[Orb.Util.Events],initialize:function(){this.addEvent("activateTab",this.activateTab,this);
this.addEvent("deactivateTab",this.deactivateTab,this);this.releasing={};DeskPRO_Window.getMessageBroker().addMessageListener("agent-notification.tickets.unlocked",function(info){var ticketId=info.ticket_id;
Array.each(DeskPRO_Window.getTabWatcher().findTabType("ticket"),function(tab){if(tab.page.getMetaData("ticket_id")==ticketId&&tab.page.ticketLocked){tab.page.ticketLocked.unlock()
}})},this)},activateTab:function(tab){var ticketId=tab.page.getMetaData("ticket_id");if(this.releasing[ticketId]){this.releasing[ticketId].abort();
delete this.releasing[ticketId]}},deactivateTab:function(tab){}});Orb.createNamespace("DeskPRO.Agent.WindowElement.TabWatcher");
DeskPRO.Agent.WindowElement.TabWatcher.UserChat=new Orb.Class({Implements:[Orb.Util.Events],initialize:function(){this.addEvent("watchedTabAdded",this.tabAdded,this);
this.addEvent("watchedTabRemoved",this.tabRemoved,this)},tabAdded:function(tab){console.debug("Enabling fast poller interval: %d",DP_POLLER_INTERVAL_FAST);
DeskPRO_Window.getMessageChanneler().poller.setInterval(DP_POLLER_INTERVAL_FAST)},tabRemoved:function(tab){var tabs=DeskPRO_Window.tabWatcher.findTabType("userchat");
if(!tabs.length){console.debug("Restoring poller interval: %d",DP_POLLER_INTERVAL);DeskPRO_Window.getMessageChanneler().poller.setInterval(DP_POLLER_INTERVAL)
}}});Orb.createNamespace("DeskPRO.Agent.WindowElement");DeskPRO.Agent.WindowElement.TabBar=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(options){this.options={tabPane:null,bodyPane:null};
this.setOptions(options);this.tabPane=$(this.options.tabPane);this.tabList=this.tabPane.find("ul.dp-tab-list").first();
this.tabList2=$("#dp_collapsed_tabs");this.bodyPane=$(this.options.bodyPane);this.menuBtn=$(this.options.menuBtn);
this.tabCount=0;this.tabs={};this.currentTabId=null;this.tabPane.on("mouseup",this._tabStripClick.bind(this));
$("#dp_collapsed_tabs").on("mouseup",this._tabStripClick.bind(this));this.tabBarOverflow=new DeskPRO.Agent.WindowElement.TabBarOverflow();
var self=this;this.tabList2.on("click",function(ev){ev.preventDefault();DeskPRO_Window.setPaneVis("tabs",true);
var el=$(ev.target);if(el.data("tab")){self.activateTab(el.data("tab"))}})},getActiveTabId:function(){return this.currentTabId
},getActiveTab:function(){return this.getTab(this.currentTabId)},getTab:function(id){if(this.tabs[id]==undefined){return null
}return this.tabs[id]},getTabs:function(){return this.tabs},getTabIds:function(){return Object.keys(this.tabs)
},findTabByFragment:function(fragment){var retTab=null;Object.each(this.tabs,function(tab){if(tab.page&&tab.page.getMetaData("url_fragment")==fragment){retTab=tab;
return false}});return retTab},findTabByRouteUrl:function(routeUrl){var retTab=null;Object.each(this.tabs,function(tab){if(tab.page.getMetaData("routeUrl")==routeUrl){retTab=tab;
return false}});return retTab},addTab:function(page){this.isAdding=true;var id=Orb.uuid();page.meta.tabId=id;
var data={};data.id=id;data.page=page;data.title=page.getMetaData("title","Untitled");data.callback_render=function(container){container=$(container);
page.fireEvent("render",[container.first(),id])};data.callback_remove_content=function(data,container){if(data.isInited){page.fireEvent("destroy")
}};data.callback_activate=function(){page.fireEvent("activate")};data.callback_deactivate=function(){page.fireEvent("deactivate")
};data.isInited=false;this.tabs[id]=data;this.tabCount++;data.wrapperId="tabcontent_"+id;if(page.meta.existingWrapper){data.wrapper=page.meta.existingWrapper;
data.wrapper.attr("id",data.wrapperId);data.wrapper.attr("class","tabViewDetailContent test");data.wrapper.css("display","none");
data.wrapper.appendTo(this.bodyPane)}else{var preparedOutput=DeskPRO_Window.prepareWidgetedHtml(page.getHtml());
data.wrapper=$('<div id="'+data.wrapperId+'" class="tabViewDetailContent" style="display: none">'+preparedOutput.html+"</div>").appendTo(this.bodyPane);
DeskPRO_Window.runWidgetedJs(data.page,preparedOutput.jsSource,preparedOutput.jsInline)}data.tabBtnId="tabbtn_"+id;
var tabIdClass=data.page.getMetaData("tabIdClass","");var html='<li id="'+data.tabBtnId+'" data-tab-id="'+data.id+'" class="'+tabIdClass;
if(data.page.TYPENAME!="basic"){html+=" "+data.page.TYPENAME}if(data.page.LOADING_TYPENAME){html+=" "+data.page.LOADING_TYPENAME
}html+='"><div class="item-hover-over-indicator"></div>';html+="<a>";html+='<i class="icon-globe dp-icon-placeholder"></i>'+Orb.escapeHtml(data.title)+"";
html+="</a>";html+='<span class="bound-fade"></span>';html+='<span class="close"></span>';html+="</li>";
var html2='<li id="'+data.tabBtnId+'_2" data-tab-id="'+data.id+'" class="'+tabIdClass;html2+='">';html2+='<span class="tab-title"><label>'+Orb.escapeHtml(data.title)+'</label> <i class="icon-remove-sign close trigger-close-tab"></i></span>';
html2+="</li>";data.tabBtn=$(html);data.tabBtn.data("tab",data);if(data.page&&data.page.meta.alert_id){data.tabBtn.addClass(data.page.meta.alert_id)
}data.tabBtn2=$(html2);data.tabBtn2.data("tab",data);var wasActive=false;var otherTab=null;if(data.page&&data.page.meta.tabPlaceholderId){otherTab=this.getTab(data.page.meta.tabPlaceholderId)
}if(otherTab){var otherTab=this.getTab(data.page.meta.tabPlaceholderId);data.tabBtn.insertAfter(otherTab.tabBtn);
otherTab.tabBtn.remove();data.tabBtn2.insertAfter(otherTab.tabBtn2);otherTab.tabBtn2.remove();if(this.currentTabId==otherTab.id){wasActive=true;
this.currentTabId=null}this.removeTab(otherTab,true)}else{data.tabBtn.prependTo(this.tabList);data.tabBtn2.appendTo(this.tabList2)
}if(!DeskPRO_Window.paneVis.tabs){DeskPRO_Window.layout.doResize(true)}this.fireEvent("addTab",[data,this]);
if(!this.currentTabId||wasActive){this.activateTabById(id)}else{DeskPRO_Window.updateWindowUrlFragment()
}this.isAdding=false;this.tabBarOverflow.update();return id},addTabPlaceholder:function(url,routeData){var html=DeskPRO_Window.util.getPlainTpl($("#tab_loading_template"));
var page=DeskPRO_Window.createPageFragment(html,"DeskPRO.Agent.PageFragment.Page.Loading");page.meta.routeUrl=url;
page.meta.routeData=routeData;page.TYPENAME_FOR=routeData.master;page.TAB_FOR_ID=routeData.masterTag;
if(routeData.url_fragment){page.meta.url_fragment=routeData.url_fragment}if(routeData.title){page.meta.title=routeData.title
}if(routeData.forTypename){page.LOADING_TYPENAME=routeData.forTypename}var id=this.addTab(page);this.activateTabById(id);
if(routeData.tabLoad){routeData.tabLoad()}return id},activateTab:function(tab){if(!tab){return}var id=tab.id;
if(id==this.currentTabId){return}this.isActivating=true;if(this.currentTabId){this.deactivateCurrentTab()
}var data=this.tabs[id];if(!data||!data.wrapper){this.removeTab(tab,true)}var wrapper=data.wrapper.show();
if(!data.isInited){data.isInited=true;if(data.callback_render!==undefined){data.callback_render(wrapper)
}this.fireEvent("activateTabRender",[data,$("#"+data.wrapperId),this])}if(data.callback_activate!==undefined){data.callback_activate(data,wrapper,this)
}this.tabList.find("li").removeClass("activeTabList");data.tabBtn.addClass("activeTabList");this.clearAlertTab(data);
this.currentTabId=id;this.fireEvent("activateTab",[data,wrapper,this]);this.isActivating=false;data.isActive=true;
DeskPRO_Window.updateWindowUrlFragment()},deactivateCurrentTab:function(){if(!this.currentTabId){return
}var data=this.tabs[this.currentTabId];data.isActive=false;this.fireEvent("deactivateTabBefore",[data,this.containerEl,this.isActivating,this]);
if(data.callback_deactivate!==undefined){data.callback_deactivate(data,$("#"+data.wrapperId),this)}DP.console.log("Hiding tab content: %o, id: %s",this.currentTabId,data.wrapperId);
$("#"+data.wrapperId).hide();if(data.callback_hide_content!==undefined){data.callback_hide_content(data,$("#"+data.wrapperId),this)
}this.fireEvent("deactivateTab",[data,$("#"+data.wrapperId),this.isActivating,this]);this.currentTabId=null
},isTabVisible:function(tab){var left=tab.tabBtn.position().left;var guess_slack=Math.round((tab.tabBtn.outerWidth()-tab.tabBtn.innerWidth())/2);
var right=left+tab.tabBtn.innerWidth()+guess_slack;var bounds=this.tabBarOverflow.getBounds();return !(right<bounds.left||left>bounds.right)
},removeTab:function(tab,silent){var id=tab.id;var wasActive=false;if(this.currentTabId==id){wasActive=true;
if(!silent){this.deactivateCurrentTab()}this.currentTabId=null}var data=this.tabs[id];delete this.tabs[id];
this.tabCount--;if(data.callback_remove_content!==undefined){data.callback_remove_content(data,$("#"+data.wrapperId),this)
}if(data.wrapper){data.wrapper.empty();data.wrapper.remove()}if(data.page){if(data.page.meta.routeData&&data.page.meta.routeData.xhr){data.page.meta.routeData.xhr.abort()
}if(data.page.meta.routeData&&data.page.meta.routeData.dataUnload){data.page.meta.routeData.dataUnload()
}}if(!silent){this.fireEvent("removeTab",[data,this]);if(wasActive){var last_tab_id=Object.keys(this.tabs).getLast();
if(last_tab_id){this.activateTabById(last_tab_id)}else{if(!DeskPRO_Window.paneVis.list){var self=this;
window.setTimeout(function(){var last_tab_id=Object.keys(this.tabs).getLast();if(!last_tab_id){DeskPRO_Window.paneVis.list=true;
DeskPRO_Window.paneVis.tabs=false;DeskPRO_Window.layout.doResize(true)}},100)}}}if(data.tabBtn){data.tabBtn.remove()
}if(data.tabBtn2){data.tabBtn2.remove()}}DeskPRO_Window.updateWindowUrlFragment();this.tabBarOverflow.update();
if(!DeskPRO_Window.paneVis.tabs){DeskPRO_Window.layout.doResize(true)}},removeTabById:function(id){var tab=this.getTab(id);
if(!tab){DP.console.log("Cannot remove, unknown tab %s",id);DP.console.trace();return null}this.removeTab(tab)
},activateTabById:function(id){var tab=this.getTab(id);if(!tab){DP.console.log("Cannot activate, unknown tab %s",id)
}this.activateTab(tab)},tabToFrontTabById:function(id,noalert){var tab=this.getTab(id);if(!tab){DP.console.log("Cannot activate, unknown tab %s",id)
}var btn=tab.tabBtn;tab.tabBtn.detach();tab.tabBtn=btn;var otherTab=null;if(tab.page&&tab.page.meta.tabPlaceholderId){otherTab=this.getTab(tab.page.meta.tabPlaceholderId)
}if(otherTab&&otherTab!=tab){tab.tabBtn.insertAfter(otherTab.tabBtn);otherTab.tabBtn.remove();if(this.currentTabId==otherTab.id){wasActive=true;
this.currentTabId=null}this.removeTab(otherTab,true)}else{tab.tabBtn.prependTo(this.tabList)}this.tabBarOverflow.resetScroll();
if(!noalert){tab.tabBtn.effect("pulsate",{times:4},500)}},alertTab:function(tab){var el=tab.tabBtn;if(!el.length||el.is(".activeTabList")||el.is(".is-alerting")){return
}if(!this.isTabVisible(tab)){this.tabToFrontTabById(tab.id,true)}el.addClass("is-alerting");var timeout=this._alertTabDoHighlight.periodical(700,this,[el]);
el.data("alerting-timeout",timeout)},clearAlertTab:function(tab){var el=tab.tabBtn;if(!el.length){return
}el.removeClass("alert-highlight").removeClass("is-alerting");var timeout=el.data("alerting-timeout");
if(timeout){window.clearTimeout(timeout)}el.data("alerting-timeout",null)},_alertTabDoHighlight:function(el){el.toggleClass("alert-highlight")
},_tabStripClick:function(event){if(this.cancelClickActivate){this.cancelClickActivate=false;return}this.cancelClickActivate=true;
var el_click=$(event.target);if(el_click.is("li")){var el=el_click}else{var el=el_click.closest("li")
}if(!el[0]||!el.is("li")){DP.console.log("not click %o",event.target);this.cancelClickActivate=false;
return}event.preventDefault();event.stopPropagation();var tabId=el.data("tab-id");if(el_click.is(".close")||event.which==2||event.isDbl){var tab=this.getTab(tabId);
if(!tab){return}if(tab.page&&tab.page.fireEvent){event.deskpro={cancelClose:false};tab.page.fireEvent("closeTab",[event,tab]);
if(event.deskpro.cancelClose){this.cancelClickActivate=false;return}}tab.isCloseClick=true;this.removeTabById(tabId);
tab.isCloseClick=false;this.cancelClickActivate=false;return}this.activateTabById(tabId);this.cancelClickActivate=false
}});Orb.createNamespace("DeskPRO.Agent.WindowElement");DeskPRO.Agent.WindowElement.TabBarOverflow=new Orb.Class({initialize:function(){var self=this;
this.tabList=$("#tabNavigationPane ul.dp-tab-list");this.tabPane=$("#tabNavigationPane");this.goLeft=$("#tabNavSelectorLeft");
this.goRight=$("#tabNavSelectorRight");this.menuBtn=$("#tabDropdownPicker");this.scrollable=$("#tabNavigationPane > .deskproTabList");
this.padLeft=10;this.padLeftCtrl=10;this.padRight=0;this.padRightCtrl=10;this.goLeft.on("click",function(ev){ev.preventDefault();
ev.stopPropagation();self.scrollLeft()});this.goRight.on("click",function(ev){ev.preventDefault();ev.stopPropagation();
self.scrollRight()});this.overflowEnabled=false},update:function(){if(this.isOverflowRequired()){this.enableOverflow()
}else{this.disableOverflow()}},getBounds:function(){var left=-this.tabList.parent().position().left;if(this.tabPane.is("with-leftbar")){left+=18
}var right=left+this.tabPane.width();if(this.tabPane.is("with-rightbar")){right-=18}console.log("left: "+left+" right: "+right);
return{"left":left,"right":right}},isOverflowRequired:function(){var paneW=this.tabPane.width();var tabW=this.tabList.width()+this.padLeft+this.padRightCtrl;
if(tabW>paneW){return true}else{return false}},enableOverflow:function(){this.tabPane.addClass("with-overflow with-rightbar");
this.maxScroll=this.tabList.width()-this.tabPane.width();this.maxScroll+=9+this.padLeft+this.padRightCtrl;
if(this.overflowEnabled){if(this.scrollable.scrollLeft()>this.maxScroll){this.scrollable.scrollLeft(this.maxScroll)
}}this.overflowEnabled=true},disableOverflow:function(){this.scrollable.scrollLeft(0);this.tabPane.removeClass("with-overflow");
this.overflowEnabled=false},resetScroll:function(){if(this.overflowEnabled){this.scrollable.scrollLeft(0);
this.tabPane.removeClass("with-leftbar")}},scrollLeft:function(amount){var self=this;if(!amount){amount=200
}self.tabPane.addClass("with-rightbar");this.scrollable.animate({scrollLeft:"-="+amount},{duration:200,complete:function(){var scrollPos=self.scrollable.scrollLeft();
if(scrollPos<=0){self.tabPane.removeClass("with-leftbar")}else{self.tabPane.addClass("with-leftbar")}}})
},scrollRight:function(amount){var self=this;if(!amount){amount=200}var current=this.scrollable.scrollLeft();
if((current+amount)>this.maxScroll){amount=this.maxScroll-current}self.tabPane.addClass("with-leftbar");
this.scrollable.animate({scrollLeft:"+="+amount},{duration:200,complete:function(){var scrollPos=self.scrollable.scrollLeft();
if(scrollPos>=self.maxScroll){self.tabPane.removeClass("with-rightbar")}else{self.tabPane.addClass("with-rightbar")
}}})}});Orb.createNamespace("DeskPRO.Agent");DeskPRO.Agent.TextSnippetClientDbDriver=new Orb.Class({Extends:DeskPRO.BasicWindow,initialize:function(typename){this.typename=typename;
this.driverName="client_db";this.loadData()},getWidgetShellTemplate:function(reload){var id=this.typename+"_snippet_shell_tpl";
var el=document.getElementById(id);if(reload||!el){$.ajax({url:BASE_URL+"agent/text-snippets/"+this.typename+"/widget-shell.txt",type:"GET",dataType:"text",success:function(txt){if(el){el.parentNode.removeChild(el)
}var $el=$('<script type="text/x-deskpro-plain" id="'+id+'"/>');$el.html(txt);$el.appendTo("body");el=$el.get(0)
}})}return DeskPRO_Window.util.getPlainTpl(el)},loadData:function(){var self=this;var tick=0;var numPages=null;
var snippetsDb=new IDBStore({dbVersion:2,storeName:"dp_text_snippets."+self.typename,keyPath:"id",autoIncrement:false,indexes:[{name:"category_id",keyPath:"category_id",unique:false,multiEntry:false}],onStoreReady:function(){snippetsDb.clear(function(){tick++;
if(tick>=1){startLoad()}})}});this.snippetsDb=snippetsDb;var startLoad=function(){$.ajax({url:BASE_URL+"agent/text-snippets/"+self.typename+"/reload-client.json",dataType:"json",success:function(data){numPages=data.num_pages;
startBatch(0)}})};var startBatch=function(num){$.ajax({url:BASE_URL+"agent/text-snippets/"+self.typename+"/reload-client/"+(num+1)+".json",dataType:"json",success:function(data){if(!data.snippets||!data.snippets.length){return
}var batchData=[];Array.each(data.snippets,function(itm){itm.category_id=parseInt(itm.category_id||0)||0;
batchData.push({type:"put",key:itm.id,value:itm})});snippetsDb.batch(batchData);if(++num<numPages){startBatch(num)
}}})}},loadSnippets:function(filter,callback,mutator){var snippets=[];filter=filter||{};var categoryId=filter.categoryId||null;
var filterString=filter.filterString||null;var page=filter.page||1;if(filterString){filterString=filterString.toLowerCase()
}var keyRange=null;var keyIndex=null;if(categoryId&&this.snippetsDb.keyRange.only){keyRange=this.snippetsDb.keyRange.only(parseInt(categoryId));
keyIndex="category_id"}this.snippetsDb.iterate(function(item){var add=true;if(categoryId&&item.category_id!=categoryId){add=false
}if(filterString&&add){add=false;Array.each(item.title,function(v){if(v.value&&v.value.toLowerCase().indexOf(filterString)!==-1){add=true;
return false}})}if(add){if(mutator){snippets.push(mutator(item))}else{snippets.push(item)}}},{index:keyIndex,keyRange:keyRange,onEnd:function(){callback(snippets)
}})},getSnippet:function(id,callback){this.snippetsDb.get(id,callback)},saveSnippet:function(snippet,callback,error_callback){var postData=[];
postData.push({name:"snippet_id",value:snippet.id||0});postData.push({name:"category_id",value:parseInt(snippet.category_id)||0});
for(var i=0;i<snippet.title.length;i++){postData.push({name:"title["+snippet.title[i].language_id+"]",value:snippet.title[i].value||""})
}for(var i=0;i<snippet.snippet.length;i++){postData.push({name:"snippet["+snippet.snippet[i].language_id+"]",value:snippet.snippet[i].value||""})
}postData.push({name:"shortcut_code",value:snippet.shortcut_code});var snippetsDb=this.snippetsDb;$.ajax({url:BASE_URL+"agent/text-snippets/"+this.typename+"/"+(snippet.id||0)+"/save.json",type:"POST",dataType:"json",data:postData,content:this,error:function(){if(error_callback){error_callback()
}},success:function(data){snippet.id=parseInt(data.snippet.id);snippet.category_id=parseInt(data.snippet.category_id);
snippetsDb.put(snippet,function(){if(callback){callback(snippet)}},function(){if(error_callback){error_callback()
}})}})},deleteSnippet:function(snippetId,callback,error_callback){var snippetsDb=this.snippetsDb;snippetId=parseInt(snippetId);
$.ajax({url:BASE_URL+"agent/text-snippets/"+this.typename+"/"+(snippetId||0)+"/delete.json",type:"POST",dataType:"json",content:this,error:function(){if(error_callback){error_callback(snippetId)
}},success:function(data){snippetsDb.remove(snippetId,function(){if(callback){callback(snippetId)}},function(){if(error_callback){error_callback(snippetId)
}})}})}});Orb.createNamespace("DeskPRO.Agent");DeskPRO.Agent.TextSnippetAjaxDriver=new Orb.Class({Extends:DeskPRO.BasicWindow,initialize:function(typename){this.typename=typename;
this.driverName="ajax";this.loadData()},getWidgetShellTemplate:function(reload){var id=this.typename+"_snippet_shell_tpl";
var el=document.getElementById(id);if(reload||!el){$.ajax({url:BASE_URL+"agent/text-snippets/"+this.typename+"/widget-shell.txt",type:"GET",dataType:"text",success:function(txt){if(el){el.parentNode.removeChild(el)
}var $el=$('<script type="text/x-deskpro-plain" id="'+id+'"/>');$el.html(txt);$el.appendTo("body");el=$el.get(0)
}})}return DeskPRO_Window.util.getPlainTpl(el)},loadData:function(){},loadSnippets:function(filter,callback,mutator){var snippets=[];
filter=filter||{};var categoryId=filter.categoryId||0;var filterString=filter.filterString||"";var languageId=filter.languageId||0;
var page=filter.page||1;$.ajax({url:BASE_URL+"agent/text-snippets/"+this.typename+"/filter.json",data:{category_id:categoryId,language_id:languageId,filter_string:filterString},type:"GET",dataType:"json",success:function(snippet_data){var snippets=[];
if(snippet_data&&snippet_data.snippets){if(mutator){Array.each(snippet_data.snippets,function(s){snippets.push(mutator(item))
})}else{snippets=snippet_data.snippets}}callback(snippets)}})},getSnippet:function(id,callback){$.ajax({url:BASE_URL+"agent/text-snippets/"+this.typename+"/"+id+".json",dataType:"json",success:function(snippet){callback(snippet.snippet)
}})},saveSnippet:function(snippet,callback,error_callback){var postData=[];postData.push({name:"snippet_id",value:snippet.id||0});
postData.push({name:"category_id",value:parseInt(snippet.category_id)||0});for(var i=0;i<snippet.title.length;
i++){postData.push({name:"title["+snippet.title[i].language_id+"]",value:snippet.title[i].value||""})
}for(var i=0;i<snippet.snippet.length;i++){postData.push({name:"snippet["+snippet.snippet[i].language_id+"]",value:snippet.snippet[i].value||""})
}postData.push({name:"shortcut_code",value:snippet.shortcut_code});var snippetsDb=this.snippetsDb;$.ajax({url:BASE_URL+"agent/text-snippets/"+this.typename+"/"+(snippet.id||0)+"/save.json",type:"POST",dataType:"json",data:postData,content:this,error:function(){if(error_callback){error_callback()
}},success:function(data){if(callback){callback(data.snippet)}}})},deleteSnippet:function(snippetId,callback,error_callback){$.ajax({url:BASE_URL+"agent/text-snippets/"+this.typename+"/"+(snippetId||0)+"/delete.json",type:"POST",dataType:"json",content:this,error:function(){if(error_callback){error_callback(snippetId)
}},success:function(data){if(callback){callback(snippetId)}}})}});Orb.createNamespace("DeskPRO.Agent.WindowElement.Section");
DeskPRO.Agent.WindowElement.Section.AbstractSection=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(){var self=this;
this.addEvent("show",this.onShow);this.addEvent("show",this._onFirstShowFire);this.addEvent("show",this._onShowSetVisible);
this.addEvent("show",this._onShowActivateList);this.addEvent("show",function(){DeskPRO_Window.updateWindowUrlFragment();
if(this.hasLoaded){$("#dp_source_loading").removeClass("on");if(DeskPRO_Window.fragLoadingSection&&DeskPRO_Window.fragLoadingSection==this.section_id){DeskPRO_Window.fragLoadingSection=null
}}},this);this.addEvent("firstshow",this.onFirstShow);this.addEvent("hide",this.onHide);this.addEvent("hide",this._onHideSetVisible);
this.addEvent("hide",this._onHideDeactivateList);this.addEvent("sectionInit",function(){if(self.contentEl){var scrollEl=$(".with-scrollbar",self.contentEl).first();
if(scrollEl.length&&!scrollEl.is(".scroll-setup")){new DeskPRO.Agent.ScrollerHandler(null,scrollEl)}}if(self.sectionEl){self.sectionEl.find(".pill-two-switcher").each(function(){$(this).find("li").each(function(){var target=$(this).data("tab-for");
if(target){$(target).on("dp_simpletabs_show",function(){self.updateUi()})}})})}});this._isVisible=false;
this.init();this.getSectionElement().on("click","[data-route]",function(ev){self.highlightNavItem($(this))
})},highlightNavItem:function(el){if(!el.is(".is-nav-item")){var el=el.closest(".is-nav-item");if(!el){return
}}$(".nav-selected",this.getSectionElement()).removeClass("nav-selected");el.addClass("nav-selected")
},init:function(){},onShow:function(){},onFirstShow:function(){},onHide:function(){},setHasInitialLoaded:function(){this.hasLoaded=true;
$("#dp_source_loading").removeClass("on");if(DeskPRO_Window.fragLoadingSection&&DeskPRO_Window.fragLoadingSection==this.section_id){DeskPRO_Window.fragLoadingSection=null
}},updateUi:function(){if(this.sectionEl){this.sectionEl.find(".with-scroll-handler").each(function(){var sh=$(this).data("scroll_handler");
if(sh&&sh.updateSize){sh.updateSize()}})}},setButtonElement:function(el){this.buttonEl=el},getButtonElement:function(){return this.buttonEl
},getSectionElement:function(){if(this.sectionEl){return this.sectionEl}return null},getListElement:function(){if(!this.listEl){this.setListElement()
}return this.listEl},setSectionElement:function(el,contentEl){if(this.sectionEl){this.sectionEl.remove()
}if(!el){el=$("<section></section>");el.attr("id",Orb.getUniqueId("outline_"))}this.sectionEl=el;if(!el.parent().is("#dp_source")){this.sectionEl.detach().appendTo("#dp_source")
}if(!contentEl){contentEl=$(".source-pane-instance",el);if(!contentEl[0]){contentEl=$("section.content",el);
if(!contentEl.length){var html=[];html.push('<div class="source-pane-wrapper"></div>');html=html.join("");
el=$(html);this.sectionEl.append(el);contentEl=el}}}this.contentEl=contentEl;contentEl.on("click",".pane-tabs li",function(ev){ev.preventDefault();
contentEl.find(".pane-tabs").find("li").removeClass("active");$(this).addClass("active");contentEl.find(".pane-content").hide().filter("."+$(this).data("tab-id")).show().find(".dp-with-activate-listener").triggerHandler("dp_activated")
})},setListElement:function(el,contentEl){if(this.listEl){this.listEl.remove()}if(!el){el=$("<section></section>");
el.attr("id",Orb.getUniqueId("list_"))}this.listEl=el;if(!el.parent().is("#dp_list")){this.listEl.detach().appendTo("#dp_list")
}if(!contentEl){contentEl=$('<section class="content"></section>')}this.listEl.append(contentEl);this.listContentEl=contentEl
},setListPageFragment:function(page,noswitch){if(this.listPage){this.listPage.fireEvent("destroy");this.listPage=null
}this.listPage=page;this.getListElement().remove();this.listEl=null;this.listContentEl=null;var contentEl=$("section.content:first",this.getListElement());
contentEl.empty();contentEl.html(page.html);page.fireEvent("render",[contentEl]);var scrollEl=$(".with-scrollbar",this.getListElement());
if(scrollEl.length&&!scrollEl.is(".scroll-setup")){page.scrollerHandler=new DeskPRO.Agent.ScrollerHandler(page,scrollEl,{showEvent:"show",hideEvent:"hide"})
}$("#dp_list_loading").removeClass("on");if(!noswitch){this.getListElement().addClass("on");page.fireEvent("activate")
}},isVisible:function(){return this._isVisible},updateBadge:function(count){var el=$(".count-badge",this.buttonEl);
var elCount=$("span",el);var count=parseInt(count);var countStr=count;if(count){if(countStr>=1000){countStr="1000+"
}elCount.html(countStr);el.show()}else{count=0;elCount.html("0");el.hide()}this.badgeCount=count;DeskPRO_Window.getMessageBroker().sendMessage("agent.ui.badge_updated",{section:this,sectionId:this.buttonEl.attr("id"),count:count})
},modBadgeCount:function(op,num){if(!num&&num!==0){num=1}var count=this.getBadgeCount();if(op=="-"||op=="rem"||op=="del"||op=="sub"){count-=num;
if(count<0){count=0}}else{if(op=="+"||op=="add"){count+=num}else{count=num}}this.updateBadge(count)},getBadgeCount:function(){return this.badgeCount||0
},_onShowSetVisible:function(){this._isVisible=true},_onHideSetVisible:function(){this._isVisible=false
},_onFirstShowFire:function(no_load_list){if(this.has_shown){return}this.has_shown=true;this.fireEvent("firstshow");
if(!no_load_list&&this.hasLoaded){this._loadAutoLoadRoutes()}},_loadAutoLoadRoutes:function(isBackgroundLoad){if(this._hasRunAutoLoadRoutes||this.listPage||!this.hasLoaded){return
}this._hasRunAutoLoadRoutes=true;if(DeskPRO_Window.getDebug("noAutoLoadList")||(!isBackgroundLoad&&DeskPRO_Window.loadingListPage)){return
}var el=$(".auto-load-route",this.sectionEl).first();if(!el[0]){el=this.sectionEl.find(".is-nav-item").first().addClass("auto-load-route");
if(!el[0]){return}}if(!el.data("route")){el=el.find("[data-route]").first();if(!el.length){return}}if(isBackgroundLoad||DeskPRO_Window.fragLoadingSection){DeskPRO_Window.runPageRoute(el.data("route"),{isBackgroundLoad:true})
}else{DeskPRO_Window.runPageRoute(el.data("route"))}this.highlightNavItem(el)},_onShowActivateList:function(){if(this.listPage){this.listPage.fireEvent("activate")
}if(this.hasLoaded){$("#deskpro_outline_loading").hide()}},_onHideDeactivateList:function(){if(this.listPage){this.listPage.fireEvent("deactivate")
}}});Orb.createNamespace("DeskPRO.Agent.WindowElement.Section");DeskPRO.Agent.WindowElement.Section.Tickets=new Orb.Class({Extends:DeskPRO.Agent.WindowElement.Section.AbstractSection,init:function(){var self=this;
this.archiveFilterIds=[];this.buttonEl=$("#tickets_section");this.filterTicketIds={};this.filterCounts={};
this.archiveTableFilterIds=[13,14,15,16];this.urlFragmentName="tickets";this.runningRefreshFilterGrouping=[];
this.rerunRefreshFilterGrouping=[];this.collectedFilterUpdates=[];this.collectedFilterUpdateOps={};this.queueRefreshFilterGrouping=[];
this.changedFilterGrouping=[];this.hasInitialGroupingLoaded=false;this.lastArchiveUpdate=new Date();this.loadHighlightNavEl=null;
this.setSectionElement($('<section id="tickets_outline"></section>'));DeskPRO_Window.getSectionData("tickets_section",this._initSection.bind(this));
DeskPRO_Window.getMessageBroker().addMessageListener("agent.filter-update",this.filterUpdated,this);DeskPRO_Window.getMessageChanneler().addEvent("postMessageSend",function(){if(!self.collectedFilterUpdates.length&&!self.queueRefreshFilterGrouping.length){return
}var filterIds=self.collectedFilterUpdates;if(self.queueRefreshFilterGrouping.length){filterIds.append(self.queueRefreshFilterGrouping)
}var filterOps=self.collectedFilterUpdateOps;self.collectedFilterUpdates=[];self.collectedFilterUpdateOps={};
self.queueRefreshFilterGrouping=[];if(filterIds.length){self.refreshFilterGrouping(filterIds,false,filterOps);
self._recountHold()}})},_initSection:function(data){var self=this;this.setHasInitialLoaded();this.contentEl.html(data.section_html);
var searchPane=this.contentEl.find(".source-pane-search");if(searchPane[0]){this.searchForm=new DeskPRO.Agent.SourcePane.SearchForm(searchPane)
}$(".find-button").on("click",function(ev){$(this).toggleClass("on");if($(this).hasClass("on")){self.contentEl.find(".source-search-area").show();
self.contentEl.find(".source-main-area").hide()}else{self.contentEl.find(".source-search-area").hide();
self.contentEl.find(".source-main-area").show()}});var searchArea=self.contentEl.find(".source-search-area");
DP.select(searchArea.find("select"));searchArea.find("header").on("click",function(){$(this).closest(".row").toggleClass("on")
});this.tabs=new DeskPRO.UI.SimpleTabs({context:this.sectionEl,triggerElements:$("#tickets_outline_tabstrip li"),onPostTabClick:function(info){self.updateUi()
}});this.filterTicketIds=data.filter_id_matches;var archiveFilterIds=[];$("#tickets_outline_archive").find("li.is-archive-filter").each(function(){archiveFilterIds.push($(this).data("filter-id"))
});this.archiveFilterIds=archiveFilterIds;this._initFilters();this._initFlagged();$("#user_settings_filters_link").on("click",function(){var overlay=new DeskPRO.UI.Overlay({contentMethod:"iframe",iframeUrl:BASE_URL+"agent/settings/ticket-filters"});
overlay.openOverlay()});this.activeNavClass=null;$(".hold-ticket-count",this.sectionEl).on("click",function(){self.toggleHoldDisplay()
});if($("#tickets_outline_custom_filters .filter").not(".filter-hidden").length){$("#tickets_outline_custom_filters .no-data").hide()
}else{$("#tickets_outline_custom_filters .no-data").show()}$("#ticket_customfilters_launch_editor").on("click",function(){$("#settingswin").trigger("dp_open","filters")
});$("#ticket_slas_launch_editor").on("click",function(){$("#settingswin").trigger("dp_open","ticketslas")
});if($("#ticket_slas_header").length){var header=$("#ticket_slas_header");DeskPRO_Window.getMessageBroker().addMessageListener("agent.ticket-sla-updated",function(info){self.getUpdatedSlaCounts();
if(self.listPage&&self.listPage.updateSlaListForTicket){self.listPage.updateSlaListForTicket(info)}else{DeskPRO_Window.getMessageBroker().sendMessage("agent.ui.ticket_updated",{ticket_id:info.ticket_id})
}});DeskPRO_Window.getMessageBroker().addMessageListener("agent.ticket-updated",function(info){if(!info.sla_ids||!info.sla_ids.length){return
}var refresh=false;for(var i=0;i<info.changed_fields.length;i++){switch(info.changed_fields[i]){case"status":refresh=true;
break;case"agent":if(header.data("sla-filter")=="agent"){refresh=true}break;case"agent_team":if(header.data("sla-filter")=="team"){refresh=true
}}}if(refresh){self.getUpdatedSlaCounts();if(self.listPage&&self.listPage.refreshSlaTicketList&&self.listPage.meta.sla_id&&$.inArray(self.listPage.meta.sla_id,info.sla_ids)!=-1){self.listPage.refreshSlaTicketList()
}}});this.updateSlaDescription()}DeskPRO_Window.getMessageBroker().addMessageListener("agent.ticket-draft-updated",function(data){var ticketId=data.ticket_id;
if(!data.via_person||data.via_person!=DESKPRO_PERSON_ID){var tab=DeskPRO_Window.getTabWatcher().findTab("ticket",function(tab){if(tab&&tab.page&&tab.page.wrapper&&tab.page.meta.ticket_id==ticketId){return true
}return false});if(tab){var wrapper=tab.page.wrapper;if(data.via_person){wrapper.find(".agent-draft-message.agent-"+data.via_person).remove()
}if(data.draft_html){if(tab.page.meta.ticket_reverse_order){wrapper.find(".ticket-messages .messages-wrap").prepend(data.draft_html)
}else{wrapper.find(".ticket-messages .messages-wrap").append(data.draft_html)}}}}});DeskPRO.ElementHandler_Exec(this.wrapper);
if(this.loadHighlightNavEl){this.highlightFilterNav(this.loadHighlightNavEl[0],this.loadHighlightNavEl[1])
}this.sectionEl.find(".dp-toggle-icon").on("click",function(ev){ev.preventDefault();ev.stopPropagation();
ev.stopImmediatePropagation();var $me=$(this);var $li=$me.closest("li");var $group=$li.find("> .item-form");
var $groupList=$li.find("> .nav-list-small");var sel=$group.find("select");if($group[0]){if($me.hasClass("icon-caret-right")){$me.removeClass("icon-caret-right");
$me.addClass("icon-caret-down");$group.show();$groupList.show();if(!sel.hasClass("with-select2")){DP.select(sel);
sel.on("change",function(ev){self.refreshFilterGrouping([sel.data("filter-id")],true)})}}else{sel.select2("val","");
sel.trigger("change");self.refreshFilterGrouping([sel.data("filter-id")],true);$me.addClass("icon-caret-right");
$me.removeClass("icon-caret-down");$group.hide();$groupList.hide()}}});var groupingFilterIds=[];this.sectionEl.find(".filter_grouping_select").each(function(){var sel=$(this);
var grouping=$(this).val();if(grouping&&grouping!=""){sel.closest("li").find(".icon-caret-right").removeClass("icon-caret-right").addClass("icon-caret-down");
groupingFilterIds.push($(this).data("filter-id"));if(!sel.hasClass("with-select2")){DP.select(sel);sel.on("change",function(ev){var filterEl=$(this).closest("li");
self.changedFilterGrouping.push(parseInt(sel.data("filter-id")));if(self.hasInitialGroupingLoaded&&$(this).val()){var countEl=filterEl.find(".counter").first();
if(parseInt(countEl.text().trim())==0){var noteEl=filterEl.find(".none-yet");noteEl.show();window.setTimeout(function(){noteEl.fadeOut(2100,function(){noteEl.hide()
})},2100)}}self.refreshFilterGrouping([sel.data("filter-id")],true)})}}});if(groupingFilterIds.length){this.refreshFilterGrouping(groupingFilterIds,false)
}else{this.hasInitialGroupingLoaded=true}this.fireEvent("sectionInit")},onShow:function(){if(!this.hasLoaded){DeskPRO_Window.getSectionData("tickets_section",this._initSection.bind(this))
}this.activeNavClass=null},highlightNav:function(){if(this.activeNavClass){var el=$(this.activeNavClass,this.getSectionElement());
var childSel=$(".nav-selected",el);if(!childSel.length){$(".nav-selected",this.getSectionElement()).removeClass("nav-selected");
el.addClass("nav-selected")}}},highlightFilterNav:function(filterId,groupingOption){this.loadHighlightNavEl=[filterId,groupingOption];
var navLi=$("#system_filters_wrap").find("li.filter-"+filterId);if(navLi[0]){$("#system_filters_wrap").find(".nav-selected").removeClass("nav-selected");
if(groupingOption!==null){navLi.find("li.grouping-"+groupingOption).addClass("nav-selected")}else{navLi.addClass("nav-selected")
}}},highlightNavItem:function(el,topGroupingOption){if(!el.is("li")){el=el.closest("li")}if(topGroupingOption){el=$(".grouping-"+topGroupingOption,el)
}$(".nav-selected",this.getSectionElement()).removeClass("nav-selected");el.addClass("nav-selected")},_initFilters:function(){var self=this;
DeskPRO_Window.getPoller().addData(function(){var filters_data_counts={};Object.each(self.filterTicketIds,function(v,k){filters_data_counts[k]=v.length
});Object.each(self.filterCounts,function(v,k){if(!filters_data_counts[k]){filters_data_counts[k]=v}});
filters_data_counts=JSON.stringify(filters_data_counts);return[{name:"do[]",value:"get-sys-filters-data"},{name:"filters_data_counts",value:filters_data_counts}]
},"filters.filter_data",{recurring:true,minDelay:33000});DeskPRO_Window.getPoller().addData([{name:"do[]",value:"get-custom-filters-data"}],"filters.filter_data",{recurring:true,minDelay:68000,minDelayAfterOne:true});
DeskPRO_Window.getMessageBroker().addMessageListener("filters.filter_data",this.updateFilterData,this);
DeskPRO_Window.getMessageBroker().addMessageListener("agent.ticket-updated",function(data){var ticketId=data.ticket_id;
if(!data.via_person||data.via_person!=DESKPRO_PERSON_ID){var tab=DeskPRO_Window.getTabWatcher().findTab("ticket",function(tab){if(tab&&tab.page&&tab.page&&tab.page.meta.ticket_id==ticketId){return true
}return false});if(tab&&data.changed_fields){tab.page.doTicketUpdate()}}if($(".show-hold-check",self.getSectionElement()).hasClass("checked")){var filterIds=self.archiveFilterIds
}else{var filterIds=self.filterTicketIds}var refreshFilterIds=[];$.each(filterIds,function(filterId){var grouping=self.getGroupingVar(filterId);
if(!grouping){return}if(data.changed_fields.indexOf(grouping)!==-1){refreshFilterIds.push(filterId)}});
if(refreshFilterIds.length){self.queueRefreshFilterGrouping.append(refreshFilterIds)}});$("#tickets_outline_inbox_list .sub-toggle").on("click",function(ev){ev.stopPropagation();
var li=$(this).parent();var sub=$("ul.sub-group",li);if(sub.is(":visible")){sub.slideUp();$(this).removeClass("open")
}else{sub.slideDown();$(this).addClass("open")}});$("li.filter",this.sectionEl).not(".is-archive-filter").each((function(i,el){el=$(el);
var filterId=parseInt(el.data("filter-id"));if(this.filterTicketIds[filterId]){this.setFilterCount(filterId,this.filterTicketIds[filterId].length)
}else{this.setFilterCount(filterId,0)}}).bind(this));this._recountHold()},getFilterCount:function(filter_id){return parseInt($("#ticket_filter_"+filter_id+"_count").data("count")||0)
},modFilterCount:function(filter_id,op){filter_id=parseInt(filter_id);var isTilde=$("#ticket_filter_"+filter_id+"_count").text().indexOf("~")!==-1;
var isPlus=$("#ticket_filter_"+filter_id+"_count").text().indexOf("+")!==-1;var count=parseInt($("#ticket_filter_"+filter_id+"_count").data("count"));
if(op=="add"){count++}else{count--}if(count<0){count=0}var countStr=count;if(isTilde){countStr="~"+count
}if(isPlus){$("#ticket_filter_"+filter_id+"_count").data("count",count)}else{$("#ticket_filter_"+filter_id+"_count").html(countStr).data("count",count);
$("#ticket_filter_"+filter_id+"_count2").html(count)}},setFilterCount:function(filter_id,count){var count_str=count;
filter_id=parseInt(filter_id);var count_str_real=count_str;if(count>=10000){count_str="10000+"}if(this.archiveTableFilterIds.indexOf(filter_id)!=-1&&count>0&&count<10000){count_str="~"+count
}var system_name=DeskPRO_Window.getData("systemFilters")[filter_id];if(system_name){if(system_name=="all"){this.updateBadge(count)
}var el=$("#ticket_filter_"+filter_id+"_count").html(count_str).data("count",count);$("#ticket_filter_"+filter_id+"_count2").html(count_str_real);
if(el.is(".is-hold-filter")){this._recountHold()}}else{var el=$("#ticket_filter_"+filter_id+"_count").html(count_str).data("count",count);
$("#ticket_filter_"+filter_id+"_count2").html(count_str_real)}},_recountHold:function(){var total=0;$("#tickets_outline_sys_hold_filters li.filter",this.sectionEl).each((function(i,el){el=$(el);
var filterId=parseInt(el.data("filter-id"));if(this.filterTicketIds[filterId]){if(el.hasClass("filter-all_w_hold")){total+=this.filterTicketIds[filterId].length
}this.setFilterCount(filterId,this.filterTicketIds[filterId].length)}else{this.setFilterCount(filterId,0)
}}).bind(this));$("#tickets_outline_sys_filters li.filter",this.sectionEl).each((function(i,el){el=$(el);
var filterId=parseInt(el.data("filter-id"));if(this.filterTicketIds[filterId]){this.setFilterCount(filterId,this.filterTicketIds[filterId].length)
}else{this.setFilterCount(filterId,0)}}).bind(this));var hold=$(".hold-ticket-count",this.sectionEl);
if(total<1){hold.hide();if($(".show-hold-check",this.getSectionElement()).hasClass("checked")){this.toggleHoldDisplay()
}}else{$(".count",hold).text(total);hold.show()}},updateFilterData:function(rawdata){var data=rawdata.ids;
var datacounts=rawdata.counts;var viewingFilterId=null;var refreshUrl=null;if(this.listPage&&this.listPage.meta){if(this.listPage.meta.filter_id){viewingFilterId=this.listPage.meta.filter_id
}if(this.listPage.meta.refreshUrl){refreshUrl=this.listPage.meta.refreshUrl}}Object.each(this.filterTicketIds,function(v,k){if(!data[k]){data[k]=v
}});Object.each(data,function(ticketIds,filterId){filterId=parseInt(filterId);var oldCount=0;if(this.filterTicketIds[filterId]){oldCount=this.filterTicketIds[filterId].length
}var newCount=ticketIds.length;this.filterTicketIds[filterId]=ticketIds;this.filterCounts[filterId]=ticketIds.length;
if(oldCount!=newCount){this.setFilterCount(filterId,newCount);if(viewingFilterId==filterId&&refreshUrl){DeskPRO_Window.runPageRoute("listpane:"+refreshUrl)
}}},this);Object.each(datacounts,function(count,filterId){filterId=parseInt(filterId);var oldCount=0;
if(this.filterCounts[filterId]){oldCount=this.filterCounts[filterId]}var newCount=count;this.filterCounts[filterId]=newCount;
if(oldCount!=newCount){this.setFilterCount(filterId,newCount);if(viewingFilterId==filterId&&refreshUrl){DeskPRO_Window.runPageRoute("listpane:"+refreshUrl)
}}},this)},filterUpdated:function(data){var filterId=parseInt(data.filter_id);var ticketId=parseInt(data.ticket_id);
var filterOps={};if(!this.filterTicketIds[filterId]){this.filterTicketIds[filterId]=[]}var page=null;
if(this.listPage&&parseInt(this.listPage.meta.filter_id)==filterId){page=this.listPage}if(data.op=="add"){if(this.archiveFilterIds.indexOf(filterId)!=-1){this.modFilterCount(filterId,"add")
}else{this.filterTicketIds[filterId].include(ticketId);var count=this.filterTicketIds[filterId].length;
this.setFilterCount(filterId,count)}filterOps={ticketId:ticketId,op:"add"};if(page&&ticketId){page.handleAutoAdd(ticketId)
}}else{if(data.op=="del"){if(this.archiveFilterIds.indexOf(filterId)!=-1){this.modFilterCount(filterId,"del")
}else{this.filterTicketIds[filterId].erase(ticketId);var count=this.filterTicketIds[filterId].length;
this.setFilterCount(filterId,count)}filterOps={ticketId:ticketId,op:"del"};if(page&&ticketId){page.delTicket(ticketId)
}}}this.collectedFilterUpdates.push(filterId);this.collectedFilterUpdateOps[filterId]=filterOps},refreshFilterGrouping:function(filterIds,doSave,filterOps){if(this.queueRefreshFilterGrouping.length){filterIds.append(this.queueRefreshFilterGrouping);
this.queueRefreshFilterGrouping=[]}var postData=[];var els=[];if(this.runningRefreshFilterGrouping&&this.runningRefreshFilterGrouping.length){var setFilterIds=[];
Array.each(filterIds,function(filterId){if(this.runningRefreshFilterGrouping.indexOf(filterId)!==-1){this.rerunRefreshFilterGrouping.include(filterId)
}else{setFilterIds.push(filterId)}},this);filterIds=setFilterIds;if(!filterIds||!filterIds.length){return
}}Array.each(filterIds,function(filterId){filterId=parseInt(filterId);var filterEl=$("li.filter-"+filterId,this.sectionEl);
els.push(filterEl.get(0));var boundFilterEl=null;var boundFilterId=null;if(filterEl.data("filter-name")){boundFilterEl=$(".filter-"+filterEl.data("filter-name")+"_w_hold",this.sectionEl);
boundFilterId=parseInt(boundFilterEl.data("filter-id"))}if(!this.filterTicketIds[filterId]&&(!boundFilterId||!this.filterTicketIds[boundFilterId])){return
}var grouping=this.getGroupingVar(filterId);if(!grouping||!grouping.length){if(!doSave){this.setFilterGroupingContent(filterId,"",grouping);
if(boundFilterId){this.setFilterGroupingContent(boundFilterId,"",grouping)}return}}postData.push({name:"batches["+filterId+"][grouping]",value:grouping});
if(grouping){postData.push({name:"batches["+filterId+"][ticket_ids]",value:this.filterTicketIds[filterId].join(",")})
}if(boundFilterId){if(this.filterTicketIds[boundFilterId]){postData.push({name:"batches["+boundFilterId+"][grouping]",value:grouping});
if(grouping){postData.push({name:"batches["+boundFilterId+"][ticket_ids]",value:this.filterTicketIds[boundFilterId].join(",")})
}}else{this.setFilterGroupingContent(boundFilterId,"",grouping)}}},this);if(doSave){postData.push({name:"save_pref",value:1})
}if(!postData.length){return}var countEls=$(".list-counter",$(els)).first();countEls.addClass("loading");
this.runningRefreshFilterGrouping=filterIds;$.ajax({url:BASE_URL+"agent/ticket-search/group-tickets.json",type:"POST",dataType:"json",data:postData,context:this,complete:function(){countEls.removeClass("loading")
},success:function(batches){Object.each(batches,function(html,filterId){var filterEl=$(".filter-"+filterId,this.sectionEl);
var name=filterEl.data("filter-name");if(name.indexOf("_w_hold")!==-1){name=name.replace(/_w_hold$/,"");
parentFilterEl=$(".filter-"+name,this.sectionEl);parentFilterId=parseInt(parentFilterEl.data("filter-id"));
var grouping=this.getGroupingVar(parentFilterId)}else{var grouping=this.getGroupingVar(filterId)}var selectedGrouping=filterEl.find("ul.nav-list-small").first().find("li.nav-selected").data("grouping-option");
var li=filterEl.find("li.grouping-"+selectedGrouping);var currentRoute=null;if(li.data("route")){currentRoute=li.data("route")
}else{currentRoute=li.find("[data-route]").data("route")}var count=parseInt(li.find("span.list-counter").text());
this.setFilterGroupingContent(filterId,html,grouping);var hasCurrentSelection=filterEl.find("ul.sub-group").find("li.grouping-"+selectedGrouping);
if(!hasCurrentSelection[0]){if(currentRoute){DeskPRO_Window.runPageRoute(currentRoute,{noChangePaneVis:true})
}}else{if(selectedGrouping!="undefined"){filterEl=$(".filter-"+filterId,this.sectionEl);li=filterEl.find("li.grouping-"+selectedGrouping);
if(li[0]){var count2=parseInt(li.find("span.list-counter").text());if(count!=count2){li.addClass("is-stale");
var listPage=DeskPRO_Window.getListPage();if(listPage.meta.filter_id&&((listPage.meta.filter_id==parseInt(filterId)&&listPage.reloadIfStale)||(listPage.meta.filter_id=="5")||(listPage.meta.topGroupingOption))){if(filterOps&&filterOps[filterId]&&filterOps[filterId].ticketId&&filterOps[filterId].op=="del"){listPage.delTicket(filterOps[filterId].ticketId)
}else{if(li.data("route")){DeskPRO_Window.runPageRouteFromElement(li,{noChangePaneVis:true})}else{DeskPRO_Window.runPageRouteFromElement(li.find("[data-route]"),{noChangePaneVis:true})
}}}}li.addClass("nav-selected")}}}},this);this.runningRefreshFilterGrouping=[];if(this.rerunRefreshFilterGrouping&&this.rerunRefreshFilterGrouping.length){var refreshIds=this.rerunRefreshFilterGrouping;
this.rerunRefreshFilterGrouping=[];this.refreshFilterGrouping(refreshIds)}this.hasInitialGroupingLoaded=true
}})},getGroupingVar:function(filterId){return $(".filter-"+filterId,this.sectionEl).find("select").val()
},setFilterGroupingContent:function(filterId,html,grouping){var filterEl=$(".filter-"+filterId,this.sectionEl);
var subgroupEl=$("ul.nav-list-small",filterEl);var baseRoute=$(".item",filterEl).first().data("route");
var existGroupingEl=subgroupEl.find(".nav-selected");var existGrouping=existGroupingEl[0]?existGroupingEl.data("grouping-option"):null;
subgroupEl.empty();if(html.length){subgroupEl.html(html)}if(existGrouping){subgroupEl.find(".grouping-"+existGrouping).addClass("nav-selected")
}var li=subgroupEl.closest("li");var note=filterEl.find(".none-yet");var lis=$("> li",subgroupEl);if(lis.length){note.stop().hide();
if(li.find(".icon-caret-down")[0]){subgroupEl.show()}lis.each(function(){var setRoute=Orb.appendQueryData(baseRoute,"set_group_term",grouping);
setRoute=Orb.appendQueryData(setRoute,"set_group_option",$(this).data("grouping-option"));$(".item",this).first().data("route",setRoute);
$(".item",this).first().attr("data-route",setRoute)})}else{subgroupEl.hide()}this.changedFilterGrouping.erase(parseInt(filterId));
if($(this).data("grouping-option")!=""){li.find(".item-form").hide()}this.updateUi()},toggleHoldDisplay:function(){var check=$(".show-hold-check",this.getSectionElement());
check.toggleClass("checked");var counts1=$("#tickets_outline_sys_filters > li > .title > .list-counter");
var counts2=$("#tickets_outline_sys_hold_filters > li > .title > .list-counter");var els=[];var selectedIndex=null;
counts1.each(function(i){var other=counts2.eq(i);if(selectedIndex===null&&($(this).parent().parent().is(".nav-selected")||other.parent().parent().is(".nav-selected"))){selectedIndex=i
}var val1=parseInt($(this).text().trim());var val2=parseInt(other.text().trim());if(val1!=val2){$(".list-counter",$(this).parent().parent()).each(function(){els.push(this)
});$(".list-counter",other.parent().parent()).each(function(){els.push(this)})}});els=$(els);els.addClass("loading");
if(selectedIndex!==null){if(check.is(".checked")){var runEl=$("#tickets_outline_sys_hold_filters li").eq(selectedIndex).addClass("nav-selected")
}else{var runEl=$("#tickets_outline_sys_filters li").eq(selectedIndex).addClass("nav-selected")}DeskPRO_Window.runPageRouteFromElement($("h3",runEl).first())
}window.setTimeout(function(){if(check.is(".checked")){$("#tickets_outline_sys_filters").hide();$("#tickets_outline_sys_hold_filters").show();
$("#tickets_outline_sys_filters li.nav-selected").removeClass("nav-selected")}else{$("#tickets_outline_sys_hold_filters").hide();
$("#tickets_outline_sys_filters").show();$("#tickets_outline_sys_hold_filters li.nav-selected").removeClass("nav-selected")
}els.removeClass("loading")},310)},_initFlagged:function(){DeskPRO_Window.getMessageBroker().addMessageListener("filter-flagged.counts",this.updateFlagCounts,this);
DeskPRO_Window.getMessageBroker().addMessageListener("filter-flagged.flag-changed",this.changeFlagCountsForSwitch,this);
var self=this;$("#tickets_outline_flagged ul").sortable({"axis":"y","distance":8,"update":function(){var data=[];
$("#tickets_outline_flagged ul > li").each(function(){var flag=$(this).data("flag");if(flag){data.push({name:"prefs[agent.ui.ticket-flag-order][]",value:flag})
}});$.ajax({timeout:20000,type:"POST",url:BASE_URL+"agent/misc/ajax-save-prefs",data:data})}});$("#tickets_outline_flagged li").on("dblclick",function(ev){ev.preventDefault();
ev.stopPropagation();var li=$(this);var inputEl=li.find(".flag-label-input");var labelEl=li.find(".flag-label");
if(!inputEl.hasClass("init")){inputEl.addClass("init");inputEl.on("blur",function(){closeFn()});inputEl.on("click",function(ev){Orb.cancelEvent(ev)
});inputEl.on("keypress keydown",function(ev){if(ev.keyCode==13){closeFn()}})}var closeFn=function(){var newTitle=inputEl.val().trim();
if(newTitle.length){$.ajax({type:"POST",url:BASE_URL+"agent/misc/ajax-save-prefs",data:[{name:"prefs[agent.ui.flag."+li.data("flag")+"]",value:newTitle}]});
labelEl.text(newTitle)}inputEl.hide();labelEl.show();backdrop.remove()};var backdrop=$('<div class="backdrop"></div>');
backdrop.css("left",270);backdrop.appendTo("body");backdrop.on("click",closeFn);inputEl.val(labelEl.text().trim());
labelEl.hide();inputEl.show();inputEl.focus().val(labelEl.text().trim()).focus()})},updateFlagCounts:function(counts){$("ol#ticket_flagged_list span.list-counter").html("0");
Object.each(counts,(function(count,flag){this.updateFlagCountFor(flag,count)}).bind(this))},updateFlagCountFor:function(flag,count){var count_str=count;
if(count>=10000){count_str="10000+"}else{if(count<0){count=0;count_str="0"}}var el=$("#ticket_flag_"+flag+"_count").text(count_str)
},changeFlagCountsForSwitch:function(info){if(info.old_flag){var old_flag_count=parseInt($("#ticket_flag_"+info.old_flag+"_count").text());
this.updateFlagCountFor(info.old_flag,old_flag_count-1)}var new_flag_count=parseInt($("#ticket_flag_"+info.new_flag+"_count").text());
this.updateFlagCountFor(info.new_flag,new_flag_count+1)},removeCustomFilter:function(id){$("#tickets_outline_custom_filters").find("li.filter-"+id).remove();
if(!$("#tickets_outline_custom_filters").find("li.filter")[0]){$("#tickets_outline_custom_filters").find("li.no-data").show()
}},updateCustomFilterTitle:function(id,title){$("#tickets_outline_custom_filters").find("li.filter-"+id).find("h3").text(title)
},updateSlaDescription:function(){var row=$("#ticket_slas_header");var filter=row.data("sla-filter");
row.find("h1 span.sla-filter-type").hide();$("#ticket_sla_filter_"+filter).show()},getUpdatedSlaCounts:function(callback){$.ajax({url:BASE_URL+"agent/ticket-search/get-sla-counts.json",dataType:"json",context:this,success:function(data){this.updateSlaCounts(data);
if($.isFunction(callback)){callback(data)}}})},updateSlaCounts:function(data){if(!data.counts){return
}var header=$("#ticket_slas_header");header.data("sla-filter",data.sla_filter);this.updateSlaDescription();
Object.each(data.counts,function(counts,sla_id){this.setSlaCounts(sla_id,counts.ok,counts.warning,counts.fail)
},this)},setSlaCounts:function(sla_id,ok,warning,fail){sla_id=parseInt(sla_id);var list=$("#tickets_outline_slas");
var row=list.find(".sla-"+sla_id);if(row.length){var okCount=row.find(".list-counter.ok");okCount.text(ok||0);
if(ok>0){okCount.addClass("not-empty")}else{okCount.removeClass("not-empty")}var warningCount=row.find(".list-counter.warning");
warningCount.text(warning||0);if(warning>0){warningCount.addClass("not-empty")}else{warningCount.removeClass("not-empty")
}var failCount=row.find(".list-counter.fail");failCount.text(fail||0);if(fail>0){failCount.addClass("not-empty")
}else{failCount.removeClass("not-empty")}}}});Orb.createNamespace("DeskPRO.Agent.WindowElement.Section");
DeskPRO.Agent.WindowElement.Section.People=new Orb.Class({Extends:DeskPRO.Agent.WindowElement.Section.AbstractSection,init:function(){this.buttonEl=$("#people_section");
this.urlFragmentName="people";this.setSectionElement($('<section id="people_outline"></section>'));DeskPRO_Window.getMessageBroker().addMessageListener("agent-notify.new_registration",function(info){this.reloadCounts()
},this);DeskPRO_Window.getMessageBroker().addMessageListener("agent.person.added",function(info){this.reloadCounts()
},this);DeskPRO_Window.getMessageBroker().addMessageListener("agent.person.confirmed",function(info){this.reloadCounts()
},this);DeskPRO_Window.getMessageBroker().addMessageListener("agent.person.removed",function(info){this.reloadCounts()
},this);this.reload()},reload:function(){DeskPRO_Window.getSectionData("people_section",(function(data){var wasLaoded=false;
if(this.hasLoaded){wasLoaded=true;this.peopleTabs.destroy();delete this.peopleTabs;this.orgTabs.destroy();
delete this.orgTabs}this._initSection(data);if(!wasLaoded){this.fireEvent("sectionInit")}}).bind(this))
},reloadCounts:function(){$.ajax({url:BASE_URL+"agent/people/get-section-data/reload-counts.json",dataType:"json",context:this,success:function(countData){this.setCountData(countData)
}})},setCountData:function(countData){if(typeof countData.people_count!="undefined"){$("#people_nav_all").find("span.list-counter").text(countData.people_count+"")
}if(typeof countData.usergroup_counts!="undefined"){Object.each(countData.usergroup_counts,function(count,uid){var el=$("#people_nav_ug_"+uid);
el.find("span.list-counter").text(count+"");if(!parseInt(count)){el.hide()}else{el.show()}})}if(typeof countData.validating_count!="undefined"){var el=$("#people_nav_awaiting_validation");
el.find("span.list-counter").text(countData.validating_count+"");if(!parseInt(countData.validating_count)){el.hide()
}else{el.show()}}if(typeof countData.validating_count_agent!="undefined"){var el=$("#people_nav_awaiting_agent_validation");
el.find("span.list-counter").text(countData.validating_count_agent+"");if(!parseInt(countData.validating_count_agent)){el.hide()
}else{el.show()}}if(!parseInt(countData.validating_count)&&!parseInt(countData.validating_count_agent)){$("#people_pending_section").hide()
}else{$("#people_pending_section").show()}},reloadLabels:function(){$.ajax({url:BASE_URL+"agent/people/get-section-data/labels.json",context:this,success:function(data){$("#people_outline_tagcloud").empty().html(data.people_label_cloud);
$("#people_outline_taglist").empty().html(data.people_label_list);if($(".no-labels","#people_outline_taglist").length){$("#people_outline_tabstrip").hide()
}else{$("#people_outline_tabstrip").show()}$("#people_outline_org_tagcloud").empty().html(data.org_label_cloud);
$("#people_outline_org_taglist").empty().html(data.org_label_list);if($(".no-labels","#people_outline_org_taglist").length){$("#people_outline_org_tabstrip").hide()
}else{$("#people_outline_org_tabstrip").show()}}})},_initSection:function(data){this.setHasInitialLoaded();
this.contentEl.empty().html(data.section_html);this._initSectionSearch();var self=this;this.peopleTabs=new DeskPRO.UI.SimpleTabs({context:this.sectionEl,triggerElements:$("#people_outline_tabstrip li"),onTabSwitch:function(info){}});
this.orgTabs=new DeskPRO.UI.SimpleTabs({context:this.sectionEl,triggerElements:$("#people_outline_org_tabstrip li"),onTabSwitch:function(info){}})
},_initSectionSearch:function(){var searchPane=this.contentEl.find(".source-pane-search");if(!searchPane[0]){return
}this.searchForm=new DeskPRO.Agent.SourcePane.SearchForm(searchPane);var typeSwitcher=searchPane.find(".content_type");
typeSwitcher.on("change",function(ev){searchPane.find(".content_type_wrap").hide().filter(".content_type-"+$(this).val()).show()
})}});Orb.createNamespace("DeskPRO.Agent.WindowElement.Section");DeskPRO.Agent.WindowElement.Section.Publish=new Orb.Class({Extends:DeskPRO.Agent.WindowElement.Section.AbstractSection,init:function(){var self=this;
this.expanded_ids=[];this.selected_id=null;this.buttonEl=$("#publish_section");this.lastLoad=null;this.urlFragmentName="publish";
this.setSectionElement($('<section id="publish_outline"></section>'));DeskPRO_Window.getSectionData("publish_section",this._initSection.bind(this));
window.setInterval(function(){self.reloadIfStale()},420000);this.addEvent("show",function(){self.reloadIfStale()
});this.buttonEl.on("dblclick",function(){self.reload()});DeskPRO_Window.getMessageBroker().addMessageListener("agent.ui.content_deleted.*",function(){self.reload()
});DeskPRO_Window.getMessageBroker().addMessageListener("agent.ui.new-pending",function(){self.reload()
})},modCommentCount:function(type,op,num){if(!this.commentCountEls){this.commentCountEls={"all":$("#publish_all_comments_count"),"articles":$("#publish_articles_comments_count"),"news":$("#publish_news_comments_count"),"downloads":$("#publish_downloads_comments_count")}
}var el=this.commentCountEls[type];if(!el||!el[0]){return}DeskPRO_Window.util.modCountEl(el,op,num);DeskPRO_Window.util.modCountEl(this.commentCountEls.all,op,num);
var elNum=parseInt(el.text());if(elNum!=0){el.closest("li").show()}else{el.closest("li").hide()}var allNum=parseInt(this.commentCountEls.all.text());
if(allNum){$("#publish_section_comments").show()}else{$("#publish_section_comments").hide()}},reloadIfStale:function(){var now=new Date();
if(!this.lastLoad||(now.getTime()-this.lastLoad.getTime()>120000)){this.reload();return true}return false
},reload:function(){this.lastLoad=new Date();var expanded_ids=[];this.selected_id=null;if(this.contentEl&&this.contentEl.length){this.contentEl.find(".dp-collapsible-open").each(function(){var id=$(this).attr("id");
if(id){expanded_ids.push(id)}});this.contentEl.find("li.dp-list-open").each(function(){var id=this.id;
if(id){expanded_ids.push(id)}});var sel=this.contentEl.find(".nav-selected").first();if(sel[0]&&sel.attr("id")){this.selected_id=sel.attr("id")
}}this.expanded_ids=expanded_ids;DeskPRO_Window.getSectionData("publish_section",(function(data){this._initSection(data);
if(this.sectionEl){var scroller=this.sectionEl.find(".with-scroll-handler").data("scroll_handler");if(scroller){scroller.updateSize()
}}}).bind(this))},_initSection:function(data){if(this.hasSectionInitialised){this.contentEl.empty()}else{DeskPRO_Window.getMessageBroker().addMessageListener("publish.drafts.list-remove",function(info){DeskPRO_Window.util.modCountEl("#publish_drafts_count","-");
self.modBadgeCount("-")});DeskPRO_Window.getMessageBroker().addMessageListener("publish.drafts.list-add",function(info){DeskPRO_Window.util.modCountEl("#publish_drafts_count","+");
self.modBadgeCount("+")})}this.hasSectionInitialised=true;var self=this;this.setHasInitialLoaded();this.contentEl.html(data.section_html);
if(this.selected_id){$("#"+this.selected_id).addClass("nav-selected")}if(this.expanded_ids&&this.expanded_ids.length){Array.each(this.expanded_ids,function(id){var el=$("#"+id);
if(el.is("li")){var $me=el.find("> i");var $li=el;var $groupList=el.find("> .nav-list-small");$me.removeClass("icon-caret-right");
$me.addClass("icon-caret-down");$groupList.show();$li.addClass("dp-list-open")}else{el.addClass("dp-collapsible-open")
}})}this._initSectionSearch();var self=this;this.contentEl.find(".pane-section").filter(".dp-collapsible").each(function(){var section=$(this);
var header=section.find("> header");var article=section.find("> article");header.css("cursor","pointer").on("click",function(ev){Orb.cancelEvent(ev);
section.toggleClass("dp-collapsible-open");self.updateUi()})});this.contentEl.find(".dp-toggle-icon").on("click",function(ev){Orb.cancelEvent(ev);
var $me=$(this);var $li=$me.closest("li");var $groupList=$li.find("> .nav-list-small");if($me.hasClass("icon-caret-right")){$me.removeClass("icon-caret-right");
$me.addClass("icon-caret-down");$groupList.show();$li.addClass("dp-list-open")}else{$me.addClass("icon-caret-right");
$me.removeClass("icon-caret-down");$groupList.hide();$li.removeClass("dp-list-open")}});this._initGlossary();
this.recountBadge();this.fireEvent("sectionInit");this.updateUi()},_initSectionSearch:function(){var searchPane=this.contentEl.find(".source-pane-search");
if(searchPane[0]){this.searchForm=new DeskPRO.Agent.SourcePane.SearchForm(searchPane)}var catSelectTypes=searchPane.find(".cat-select-type");
searchPane.find(".content_type").on("change",function(){catSelectTypes.hide();catSelectTypes.filter(".cat-select-"+$(this).val()).show()
})},recountBadge:function(){var count=0;count+=parseInt($("#kb_pending_count").text().trim())||0;count+=parseInt($("#publish_validating_count").text().trim())||0;
count+=parseInt($("#publish_validating_comments_count").text().trim())||0;this.updateBadge(count)},recountChildCounts:function(ul){var self=this;
$("> li",ul).each(function(){var li=$(this);var countEl=$(".list-counter:first",li);var count=parseInt(countEl.data("count"));
var totalCount=count;var subUl=$("> ul",li);var subLis=null;if(subUl.length){subLis=$("> li",subUl)}if(subLis&&subLis.length){self.recountChildCounts(subUl);
subLis.each(function(){totalCount+=parseInt($(".list-counter:first",this).data("total-count"))});countEl.text(count+"/"+totalCount)
}else{countEl.text(count)}countEl.data("total-count",totalCount)})},_initGlossary:function(){this.glossaryWrapper=$("#publish_outline_glossary");
var self=this;$(".glossary-new-trigger",this.glossaryWrapper).on("click",this.showGlossaryAddDlg.bind(this));
$(".glossary-word-trigger",this.glossaryWrapper).on("click",function(ev){ev.preventDefault();self.showGlossaryEditDlg($(this).data("word-id"))
})},showGlossaryAddDlg:function(){var addDlg=this.getGlossaryAddDlg();addDlg.openOverlay()},showGlossaryEditDlg:function(id){var editDlg=this.getGlossaryEditDlg();
var form=$(".form",editDlg.elements.wrapper);var loading=$(".loading",editDlg.elements.wrapper);form.hide();
loading.show();editDlg.openOverlay();$.ajax({url:BASE_URL+"agent/glossary/"+id+".json",type:"GET",context:this,dataType:"json",success:function(info){form.find("input.word").select2("val",info.words);
$("input.word_id",form).val(info.id);$("textarea.definition",form).val(info.definition);loading.hide();
form.show()}})},getGlossaryAddDlg:function(){if(this.addDlg){return this.addDlg}var el=$(".glossary-add-dlg:first",this.glossaryWrapper);
this.addDlg=new DeskPRO.UI.Overlay({contentElement:el,customClassname:"normal-size",onBeforeOverlayOpened:function(){el.find("textarea.definition").val("");
el.find("input.word").val("").select2("val",[])}});$(".save-trigger",el).on("click",this.saveNewWord.bind(this));
DP.select(el.find("input.word"),{tags:[],id:function(e){if(!e){return null}return e.id},formatResult:function(result,container,query){if(!result||!result.text){return""
}return Orb.escapeHtml(result.text)},matcher:function(term,text){if(typeOf(text)!="string"||typeOf(term)!="string"){return
}return text.toUpperCase().indexOf(term.toUpperCase())>=0}});return this.addDlg},getGlossaryEditDlg:function(){if(this.editDlg){return this.editDlg
}var el=$(".glossary-edit-dlg:first",this.glossaryWrapper);this.editDlg=new DeskPRO.UI.Overlay({contentElement:el,customClassname:"normal-size"});
DP.select(el.find("input.word"),{tags:[],id:function(e){if(!e){return null}return e.id},formatResult:function(result,container,query){if(!result||!result.text){return""
}return Orb.escapeHtml(result.text)},matcher:function(term,text){if(typeOf(text)!="string"||typeOf(term)!="string"){return
}return text.toUpperCase().indexOf(term.toUpperCase())>=0}});$(".save-trigger",el).on("click",this.saveEditWord.bind(this));
$(".delete-trigger",el).on("click",this.deleteEditWord.bind(this));return this.editDlg},saveNewWord:function(){var data=[];
var words=$("input.word",this.addDlg.elements.wrapperOuter).select2("val");for(var i=0;i<words.length;
i++){data.push({name:"words[]",value:words[i]})}data.push({name:"definition",value:$("textarea.definition",this.addDlg.elements.wrapperOuter).val().trim()});
$.ajax({url:BASE_URL+"agent/glossary/new-word.json",type:"POST",data:data,context:this,dataType:"json",success:function(data){this.addDlg.closeOverlay();
this.reload()}})},saveEditWord:function(){var word_id=$("input.word_id",this.editDlg.elements.wrapperOuter).val().trim();
var data=[];data.push({name:"word_id",value:word_id});var words=$("input.word",this.editDlg.elements.wrapperOuter).select2("val");
for(var i=0;i<words.length;i++){data.push({name:"words[]",value:words[i]})}data.push({name:"definition",value:$("textarea.definition",this.editDlg.elements.wrapperOuter).val().trim()});
$.ajax({url:BASE_URL+"agent/glossary/"+word_id+"/edit.json",type:"POST",data:data,context:this,dataType:"json",success:function(counts){this.getGlossaryEditDlg().close();
this.reload()}})},deleteEditWord:function(){var word_id=$("input.word_id",this.editDlg.elements.wrapperOuter).val().trim();
$.ajax({url:BASE_URL+"agent/glossary/"+word_id+"/delete.json",type:"POST",context:this,dataType:"json",success:function(counts){this.getGlossaryEditDlg().close();
this.reload()}})}});Orb.createNamespace("DeskPRO.Agent.WindowElement.Section");DeskPRO.Agent.WindowElement.Section.AgentChat=new Orb.Class({Extends:DeskPRO.Agent.WindowElement.Section.AbstractSection,init:function(){this.buttonEl=$("#agent_chat_section");
this.chatsWrapper=$("#agent_chats_wrapper");this.setSectionElement($('<section id="agent_chat_outline"></section>'));
this.urlFragmentName="agentchat";$("#agent_chat_conversation").template("agent_chat_conversation");$("#agent_groupchat_conversation").template("agent_groupchat_conversation");
$("#agent_chat_message").template("agent_chat_message");$("#agent_chat_message_me").template("agent_chat_message_me");
this._initMessageHandlers();this._initInterface();DeskPRO_Window.getSectionData("agent_chat_section",(function(data){this.setHasInitialLoaded();
this.contentEl.html(data.section_html);this.initSection()}).bind(this));DeskPRO_Window.getMessageBroker().addMessageListener("agentchat-section.list-activated",function(info){this.highlightNavItem($(".agent-"+info.id,this.getSectionElement()))
},this);DeskPRO_Window.getPoller().addData([{name:"do[]",value:"get-online-agents"}],"agent.online-agents",{recurring:true,minDelay:210000,minDelayAfterOne:true})
},onShow:function(){DeskPRO_Window.getSectionData("agent_chat_section",(function(data){this.setHasInitialLoaded();
this.contentEl.html(data.section_html);this.initSection()}).bind(this))},initSection:function(){},_initMessageHandlers:function(){var self=this;
DeskPRO_Window.getMessageBroker().addMessageListener("agent_chat.new-message",this.newIncomingMessage,this);
DeskPRO_Window.getMessageBroker().addMessageListener("agent.new-agent-online",function(info){var agent_id=info.agent_id;
this.addOnlineAgent(agent_id)},this);DeskPRO_Window.getMessageBroker().addMessageListener("agent.online-agents",function(info){$("#agent_online_list").find("li").not(".no-agents").remove();
$("#agent_online_list").find("li.no-agents").show();$("#agent_offline_list").find("li").show();self.onlineCountEl.html("0");
Array.each(info.online_agents,function(agent_id){self.addOnlineAgent(agent_id)})},this)},_initInterface:function(){this.panelEl=$("#agent_chat_panel");
this.onlineListEl=$("#agent_online_list");this.offlineListEl=$("#agent_offline_list");this.onlineCountEl=$("#chat_online_count");
this.agentTeamList=$("#agent_team_list");$(".show-offline-opt",this.panelEl).on("click",function(){if($(this).is(":checked")){$("#agent_chat_panel").addClass("show-offline")
}else{$("#agent_chat_panel").removeClass("show-offline")}});this.panelEl.on("click",function(ev){ev.stopPropagation()
});$(".show-section",this.panelEl).on("click",function(){DeskPRO_Window.switchToSection("agent_chat_section")
});$("#agent_chat_section").on("click",(function(ev){ev.stopPropagation();this.panelEl.toggleClass("open")
}).bind(this));$("#agent_chat_panel .close-trigger").on("click",(function(){this.close()}).bind(this));
this.chatsWrapper.on("click",function(ev){ev.stopPropagation()});var self=this;var openChatFn=function(ev){ev.stopPropagation();
var agent_id=$(this).data("agent-id");if(agent_id){self.newChatWindow([agent_id])}};this.onlineListEl.on("click","li",openChatFn);
this.offlineListEl.on("click","li",openChatFn);this.agentTeamList.on("click","li",function(ev){ev.stopPropagation();
var agentIds=$(this).data("member-ids")||"";agentIds=(agentIds+"").split(",");agentIds.include(window.DESKPRO_PERSON_ID);
agentIds=agentIds.filter(function(x){if(x){return true}});var name=$(this).data("team-name");self.newChatWindow(agentIds,name)
});this.listTabs=new DeskPRO.UI.SimpleTabs({triggerElements:$("#agent_chat_panel_listviews > li"),onTabSwitch:function(info){if(info.tabEl.is(".teams")){$(".show-offline",self.panelEl).hide()
}else{$(".show-offline",self.panelEl).show()}}});$("#agent_chat_panel .view-history-trigger").on("click",function(ev){DeskPRO_Window.switchToSection("agent_chat_section");
self.close()});$("li.online-now","#agent_offline_list").each(function(){self.addOnlineAgent($(this).removeClass("online-now").data("agent-id"))
});this.panelEl.on("click",function(){})},close:function(){this.panelEl.removeClass("open")},newChatWindow:function(agent_ids,title){var self=this;
var chatWin=DeskPRO.Agent.Widget.AgentChatWin_FindAgents(agent_ids);if(!chatWin){chatWin=new DeskPRO.Agent.Widget.AgentChatWin({agentIds:agent_ids,title:title||null,onDestroy:function(){self.reflowButtons()
}})}this.close();chatWin.open()},newIncomingMessage:function(info){var self=this;var chatWin=DeskPRO.Agent.Widget.AgentChatWin_Find(info.conversation_id);
if(!chatWin){chatWin=new DeskPRO.Agent.Widget.AgentChatWin({convoId:info.conversation_id,agentIds:info.participant_ids,onDestroy:function(){self.reflowButtons()
}})}chatWin.showMessage(info.author_id,info.message,info.time);chatWin.open()},reflowButtons:function(){var lastChat=null;
$("> section.agent-chat",this.chatsWrapper).each(function(){var left=0;if(lastChat){left+=lastChat.position().left+$("> nav",lastChat).outerWidth()+8
}$(this).css("left",left);lastChat=$(this)})},addOnlineAgent:function(agent_id){if(typeof agent_id.agent_id!="undefined"){agent_id=agent_id.agent_id
}var origLi=$(".agent-"+agent_id,this.offlineListEl);if(!origLi.length){DP.console.error("No agent element for %i",agent_id);
return}if($(".agent-"+agent_id,this.onlineListEl).length){return}var li=origLi.clone();li.show();this.onlineListEl.append(li);
origLi.hide();var countInt=parseInt(this.onlineCountEl.html());countInt++;this.onlineCountEl.html(countInt);
$("li.no-agents",this.onlineListEl).hide()},removeOnlineAgent:function(agent_id){if(DESKPRO_PERSON_ID&&agent_id==DESKPRO_PERSON_ID){return
}var li=$(".agent-"+agent_id,this.onlineListEl);var offlineLi=$(".agent-"+agent_id,this.offlineListEl);
if(!li.length){return}li.remove();offlineLi.show();var countInt=parseInt(this.onlineCountEl.html());countInt--;
this.onlineCountEl.html(countInt);if(countInt<1){$("li.no-agents",this.onlineListEl).show()}}});Orb.createNamespace("DeskPRO.Agent.WindowElement.Section");
DeskPRO.Agent.WindowElement.Section.UserChat=new Orb.Class({Extends:DeskPRO.Agent.WindowElement.Section.AbstractSection,init:function(){var self=this;
this.buttonEl=$("#chat_section");this.setSectionElement($('<section id="chat_outline"></section>'));this.groups={};
this.urlFragmentName="userchat";this.hasSectionInitialised=false;this.lastOnlineUserLoad=null;this.lastOnlineUserCount=null;
this.onlineUsersWrap=$("#agent_status_online_users");this.statusMenuOpen=false;this.dismissedChats={};
this.openingChatTimeout={};this.refreshCountsTimeout=null;this.onlineAgentIds=[];this._initStatusMenu();
this._initStatusMenuAgents();this._initStatusMenuUsers();this._initTemplates();this._initMessageHandlers();
this._lastLoaded=new Date();DeskPRO_Window.getSectionData("chat_section",(function(data){this._initSection(data)
}).bind(this))},_initSection:function(data){var self=this;var lastSelectedId=null;if(this.contentEl){lastSelectedId=this.contentEl.find(".nav-selected").find(".list-counter").attr("id")
}if(this.hasSectionInitialised){this._lastLoaded=new Date();this.contentEl.empty()}this.hasSectionInitialised=true;
var self=this;this.setHasInitialLoaded();this.contentEl.html(data.section_html);this.refreshFilterGrouping(data,lastSelectedId);
this.updateGroupingVars();this._lastLoaded=new Date();this.handleUpdateCounts();if(lastSelectedId){$("#"+lastSelectedId).closest(".is-nav-item").addClass("nav-selected")
}new DeskPRO.ElementHandler.SimpleTabs($("#chat_outline_labels_switcher"));this.fireEvent("sectionInit")
},_initStatusMenu:function(){var self=this;var statusMenuHandler={getBackdrop:function(){if(!this.backdrop){this.backdrop=$('<div class="backdrop" />').appendTo("body");
this.backdrop.on("click",function(){statusMenuHandler.close()})}return this.backdrop},getList:function(){if(!this.list){this.list=$("#agent_status_menu").hide().detach().appendTo("body")
}return this.list},open:function(){this.getBackdrop().show();this.getList().show();self.statusMenuOpen=true;
self.fireEvent("statusMenuOpened")},close:function(){this.getBackdrop().hide();this.getList().hide();
self.statusMenuOpen=false;self.fireEvent("statusMenuClosed")},init:function(){$("#chatStatusWrap").on("click",function(){statusMenuHandler.open()
});$("#agent_status_away_overlay").on("click",function(){statusMenuHandler.close()});$("#agent_status_menu").find(".notifHead").on("click",function(){statusMenuHandler.close()
})}};statusMenuHandler.init();$("#agent_status_menu_me_list").find(".trigger-toggle-status").on("click",function(ev){ev.preventDefault();
ev.stopPropagation();$("#agent_status_menu_me_list").addClass("dp-loading-on");var is_available;if(!$("#agent_status_menu_me_list").data("is-online")){is_available=true
}else{is_available=false}$("#agent_status_menu_me_list").data("is-online",is_available);self.sendUpdateAgentStatus(is_available,function(){$("#agent_status_menu_me_list").removeClass("dp-loading-on");
if(!is_available){self.onlineAgentIds.erase(DESKPRO_PERSON_ID)}else{self.onlineAgentIds.include(DESKPRO_PERSON_ID)
}self.refreshOnlineAgentsList();self.refreshOnlineAgentDepGroups()})})},_initStatusMenuAgents:function(){var self=this;
var status_menu_el=$("#agent_status_menu_onlinelist");this.onlineAgentsGroupDepCheck=status_menu_el.find(".agents-list-groupdep");
this.onlineAgentsList=status_menu_el.find("ul.list.normal");this.onlineAgentsListGrouped=status_menu_el.find("ul.list.department-grouped");
status_menu_el.find(".agents-list-groupdep").on("click",function(ev){ev.preventDefault();ev.stopPropagation();
self.onlineAgentsGroupDepCheck.toggleClass("toggle-on");if(self.onlineAgentsGroupDepCheck.hasClass("toggle-on")){self.refreshOnlineAgentDepGroups();
self.onlineAgentsListGrouped.show();self.onlineAgentsList.hide()}else{self.onlineAgentsListGrouped.hide();
self.onlineAgentsList.show()}});DeskPRO_Window.getMessageBroker().addMessageListener("agent.ui.user-chat-status",function(info){if(info.is_online){self.onlineAgentIds.include(DESKPRO_PERSON_ID)
}else{self.onlineAgentIds.erase(DESKPRO_PERSON_ID)}});this.getSectionElement().on("click",".sub-toggle",function(ev){var row=$(this).closest("li");
var sub=$("> ul.sub-group",row);if(sub.length){if(sub.is(":visible")){row.removeClass("sub-expanded");
sub.slideUp("fast")}else{row.addClass("sub-expanded");sub.slideDown("fast")}}});DeskPRO_Window.getMessageBroker().addMessageListener("agent.online-agents-userchat",function(info){self.onlineAgentIds=[];
if(info.online_agents&&info.online_agents.length){Array.each(info.online_agents,function(agent_id){self.onlineAgentIds.push(parseInt(agent_id))
})}self.refreshOnlineAgentsList();self.refreshOnlineAgentDepGroups()},this)},_initStatusMenuUsers:function(){var self=this;
this.addEvent("statusMenuOpened",function(){this.refreshOnlineUsers()},this);this.addEvent("statusMenuOpened",function(){if(this.onlineUsersRefreshTimer){window.clearTimeout(this.onlineUsersRefreshTimer);
this.onlineUsersRefreshTimer=null}},this);DeskPRO_Window.getMessageBroker().addMessageListener("agent.online-users-count",function(info){var count=parseInt(info.online_count)||0;
Orb.phraseTextEl($(".agent_chrome_chat_online_users"),{count:count});DeskPRO_Window.util.modCountEl($(".userchat-online-users-count"),"=",count);
if(count!=self.lastOnlineUserCount){self.lastOnlineUserLoad=null}self.lastOnlineUserCount=count});this.onlineUsersWrap.on("click",".reload-table-btn",function(){self.onlineUsersWrap.addClass("refreshing refreshing-clicked");
self.refreshOnlineUsers()})},_initTemplates:function(){$("#new_user_chat_alert").template("new_user_chat_alert");
$("#invite_chat_alert").template("invite_chat_alert");$("#new_user_chat_alert_message").template("new_user_chat_alert_message");
$("#added_part_user_chat_alert").template("added_part_user_chat_alert");$("#user_chat_newmsg_sound").template("user_chat_newmsg_sound")
},_initMessageHandlers:function(){DeskPRO_Window.getMessageBroker().addMessageListener("chat.new",this.handleNewChat,this);
DeskPRO_Window.getMessageBroker().addMessageListener("chat.reassigned",this.handleReassignedChat,this);
DeskPRO_Window.getMessageBroker().addMessageListener("chat.unassigned",this.handleUnassignedChat,this);
DeskPRO_Window.getMessageBroker().addMessageListener("chat.ended",this.handleChatEnded,this);DeskPRO_Window.getMessageBroker().addMessageListener("chat.depchange",this.handleDepChange,this);
DeskPRO_Window.getMessageBroker().addMessageListener("chat.invited",this.handleInvited,this);DeskPRO_Window.getMessageBroker().addMessageListener("chat_user_agent.chat-parts-updated",this.handlePartsUpdated,this)
},startRefreshingWhileOpenTimer:function(){var self=this;if(!this.statusMenuOpen){return}if(this.onlineUsersRefreshAjax){return
}if(this.onlineUsersRefreshTimer){window.clearTimeout(this.onlineUsersRefreshTimer);this.onlineUsersRefreshTimer=null
}this.onlineUsersRefreshTimer=window.setTimeout(function(){self.refreshOnlineUsers()},5000)},refreshOnlineUsersIfNeeded:function(){var now=new Date();
if(!this.lastOnlineUserLoad||(now.getTime()-this.lastOnlineUserLoad.getTime())>15000){this.refreshOnlineUsers()
}},refreshOnlineUsers:function(){this.onlineUsersWrap.addClass("refreshing");this.onlineUsersRefreshAjax=$.ajax({url:BASE_URL+"agent/user-track/win-header-table.html",type:"GET",dataType:"html",context:this,complete:function(){this.onlineUsersRefreshAjax=null;
this.onlineUsersWrap.removeClass("refreshing refreshing-clicked");this.startRefreshingWhileOpenTimer()
},success:function(html){$("#agent_status_online_users").empty().html(html);var count=parseInt($.trim($("#agent_status_online_users").find(".count-online-users").text()));
count=count||0;Orb.phraseTextEl($(".agent_chrome_chat_online_users"),{count:count});$(".userchat-online-users-count").text(count);
this.lastOnlineUserLoad=new Date()}})},refreshOnlineAgentsList:function(){var self=this;var list=this.onlineAgentsList;
var count;var hasme=false;list.find("li").hide().removeClass("on last");Array.each(this.onlineAgentIds,function(agent_id){if(parseInt(agent_id)===DESKPRO_PERSON_ID){hasme=true
}list.find("li.agent-"+agent_id).show().addClass("on")});list.find("li.on").last().addClass("last");count=self.onlineAgentIds.length;
if(hasme){$("#agent_status_menu_me_list").data("is-online",true);Orb.enablePhraseEl("agent.chrome.chat_sign-out",$("#agent_status_menu_me_list"));
Orb.enablePhraseEl("agent.chrome.chat_logged-in",$("#dp_header_userchat_btn").find(".status"))}else{$("#agent_status_menu_me_list").data("is-online",false);
Orb.enablePhraseEl("agent.chrome.chat_sign-in",$("#agent_status_menu_me_list"));Orb.enablePhraseEl("agent.chrome.chat_logged-out",$("#dp_header_userchat_btn").find(".status"))
}Orb.phraseTextEl($(".agent_chrome_chat_online_agents"),{count:count});DeskPRO_Window.util.modCountEl($(".userchat-online-agents-count"),"=",count);
var userchatBtn=$("#dp_header_userchat_btn");userchatBtn.removeClass("me-offline all-offline");if(count){if(!hasme){$("#dp_header_userchat_btn").addClass("me-offline")
}}else{$("#dp_header_userchat_btn").addClass("all-offline")}},refreshOnlineAgentDepGroups:function(){var self=this;
if(!this.onlineAgentsGroupDepCheck.hasClass("toggle-on")){return}this.onlineAgentsListGrouped.find("li.dep").hide();
this.onlineAgentsListGrouped.find("ul").empty();Array.each(this.onlineAgentIds,function(agentId){var li=this.onlineAgentsList.find("li.agent-"+agentId);
var depIds=(li.data("department-ids")||"")+"";depIds=depIds.split(",");if(depIds.length){depIds.each(function(depId){var depRow=self.onlineAgentsListGrouped.find("li.dep-"+depId);
var depList=depRow.find("ul");depList.append(li.clone());depRow.show()})}},this)},sendUpdateAgentStatus:function(is_available,callback){var status="available";
var postData=[];if(is_available){postData.push({name:"is_chat_available",value:1})}else{postData.push({name:"is_chat_available",value:0})
}if(status=="available"){$.ajax({url:BASE_URL+"agent/misc/set-agent-status/available",type:"POST",data:postData,complete:function(){if(!is_available){$("#chatStatusWrap").addClass("offline")
}else{$("#chatStatusWrap").removeClass("offline")}if(callback){callback()}}})}else{if(status=="away"){$.ajax({url:BASE_URL+"agent/misc/set-agent-status/away",type:"POST",complete:function(){if(callback){callback()
}}})}}},refreshOpenCounts:function(now){var self=this;if(!now&&this.refreshCountsTimeout){return}var fn=function(){self.refreshCountsTimeout=null;
$.ajax({url:BASE_URL+"agent/chat/open-counts.json",dataType:"json",success:function(data){$("#userchat_deplist_all").find("span.list-counter").each(function(){var key,subkey,count;
key=$(this).data("count-key").split(".");subkey=key[1];key=key[0];if(data&&data[key]&&data[key][subkey]){count=data[key][subkey]
}else{count=0}$(this).text(count);if(!$(this).parent().is("h3")){$(this).closest("li").hide()}else{$(this).closest("li").show()
}});$("#userchat_deplist_all").find("> ul.nav-list").each(function(){if($(this).find("> li").filter(":visible")){$(this).show()
}else{$(this).hide()}});self.handleUpdateCounts()}})};if(now){if(this.refreshCountsTimeout){window.clearTimeout(refreshCountsTimeout)
}fn()}else{this.refreshCountsTimeout=window.setTimeout(fn,4500)}},refreshFilterGrouping:function(filterId,lastSelectedId){var self=this;
this.groups[filterId]=this.getGroupingVar(filterId);$.ajax({type:"POST",url:BASE_URL+"agent/chat/group-count.json",data:{filters:this.groups},dataType:"json",success:function(data){self.updateFilterGrouping(data,self);
if(lastSelectedId){$("#"+lastSelectedId).closest(".is-nav-item").addClass("nav-selected")}}})},updateFilterGrouping:function(data,self){var container=$("#chats_outline_sys_filters");
for(filterId in data){var element=$(".filter-"+filterId+" .sub-group",container);element.html(data[filterId]);
if(data[filterId]){element.show()}else{element.hide()}}},getGroupingVar:function(filterId){return $("#chat_filter_group_editor .filter-"+filterId+" .field-option").val()
},updateGroupingVars:function(){var filterId;if(!this.groups){return}for(filterId in this.groups){$("#chat_filter_group_editor").find(".filter-"+filterId+" .field-option").val(this.groups[filterId]||"")
}},onShow:function(){var self=this;window.setTimeout(function(){if(!self.isVisible()){DeskPRO_Window.getSectionData("chat_section",self._initSection.bind(self));
var el=self.getSectionElement().find(".nav-selected");if(el[0]){if(el.data("route")){DeskPRO_Window.runPageRouteFromElement(el)
}else{DeskPRO_Window.runPageRouteFromElement(el.closest("[data-route]"))}}}},250)},onHide:function(){},handleUpdateCounts:function(data){var count=parseInt($("#userchat_deplist_0_counter").text());
this.updateBadge(count);if(!count){$("#userchat_deplist_all").find(".nav-list").removeClass("show")}else{$("#userchat_deplist_all").find(".nav-list").addClass("show")
}},isChatOpen:function(convoId){var chatTabs=DeskPRO_Window.getTabWatcher().findTabType("userchat");var isOpen=false;
Array.each(chatTabs,function(tab){if(parseInt(tab.page.meta.conversation_id)==parseInt(convoId)){isOpen=tab;
return false}},this);return isOpen},modListingCount:function(id,op,count){var el=$("#userchat_list_"+(id!="0"?id:"allagents")+"_counter");
var oldCount=parseInt(el.text().trim())||0;var newCount=DeskPRO_Window.util.modCountEl(el,op,count);if(id!="0"){var row=el.closest("li");
if(newCount){row.show()}else{row.hide()}this.modListingCount(0,op,count)}else{this.handleUpdateCounts()
}var newCount=parseInt(el.text().trim())||0;if(oldCount!=newCount){if(this.isVisible()){DeskPRO_Window.runPageRouteFromElement(el.closest("[data-route]"))
}}},modDepListingCount:function(id,op,count){var el=$("#userchat_deplist_"+id+"_counter");var newCount=DeskPRO_Window.util.modCountEl(el,op,count);
if(id!="0"){var row=el.closest("li");if(el.data("parentid")){this.modDepListingCount(el.data("parentid"),op,count)
}else{this.modDepListingCount(0,op,count)}if(newCount){row.show()}else{row.hide()}}else{this.handleUpdateCounts()
}},handleDepChange:function(data){if(!data.agent_id){if(data.old_department_id){this.modDepListingCount(data.old_department_id,"-")
}if(data.department_id){this.modDepListingCount(data.department_id,"+")}}this.handleUpdateCounts()},handleChatEnded:function(data){if(!this.isDepAllowed(data.department_id)){return
}this.refreshOpenCounts();$("#new_user_chat_alert_"+data.conversation_id).remove();this.modListingCount(data.agent_id,"-");
DeskPRO_Window.getMessageBroker().sendMessage("chat_convo."+data.conversation_id+".ended",data);if(!data.agent_id){this.modDepListingCount(data.department_id,"-")
}if(this.dismissedChats[data.conversation_id]){delete this.dismissedChats[data.conversation_id]}if(this.openingChatTimeout[data.conversation_id]){window.clearTimeout(this.openingChatTimeout[data.conversation_id]);
delete this.openingChatTimeout[data.conversation_id];DeskPRO_Window.faviconBadge.disableCrazyMode()}if(data.agent_id){if(parseInt(data.agent_id)==DESKPRO_PERSON_ID){DeskPRO_Window.util.modCountEl($("#userchat_mine_count"),"+")
}else{DeskPRO_Window.util.modCountEl($("#userchat_assigned_count"),"+")}}else{DeskPRO_Window.util.modCountEl($("#userchat_missed_count"),"+")
}this.handleUpdateCounts()},handlePartsUpdated:function(data){DeskPRO_Window.getMessageBroker().sendMessage("chat_user_agent.chat-parts-updated-"+data.conversation_id,data);
if(data&&data.participant_ids&&data.participant_ids.contains(DESKPRO_PERSON_ID)){if(!this.isChatOpen(data.conversation_id)){DeskPRO_Window.runPageRoute("page:"+BASE_URL+"agent/chat/view/"+data.conversation_id,{noToggle:true})
}}},handleNewChat:function(data){var self=this;if(!this.isDepAllowed(data.department_id)){return}this.handleUpdateCounts();
var openTab=this.isChatOpen(data.conversation_id);if(openTab&&data.restarted){openTab.page.closeSelf();
DeskPRO_Window.runPageRoute("page:"+BASE_URL+"agent/chat/view/"+data.conversation_id,{noToggle:true});
return}if(!data.agent_id){if(!this.dismissedChats[data.conversation_id]){var info_line=[];this.showNewChatAlert(data)
}}else{if(data.agent_id==DESKPRO_PERSON_ID&&!this.isChatOpen(data.conversation_id)){var self=this;this.openingChatTimeout[data.conversation_id]=window.setTimeout(function(){DeskPRO_Window.runPageRoute("page:"+BASE_URL+"agent/chat/view/"+data.conversation_id,{noToggle:true});
delete self.openingChatTimeout[data.conversation_id];DeskPRO_Window.faviconBadge.disableCrazyMode()},1000)
}DeskPRO_Window.getSectionData("chat_section",self._initSection.bind(self))}if(!data.agent_id){this.modDepListingCount(data.department_id,"+")
}this.refreshOpenCounts()},handleUnassignedChat:function(data){if(!this.isDepAllowed(data.department_id)){return
}this.modListingCount(data.old_agent_id,"-");this.handleUpdateCounts();if(data.old_agent_id){this.modDepListingCount(data.department_id,"+")
}if(data.old_agent_id&&data.old_agent_id==DESKPRO_PERSON_ID){this.dismissedChats[data.conversation_id]=true
}if(!this.dismissedChats[data.conversation_id]){this.showNewChatAlert(data,{name:data.author_name,message:data.subject_line})
}if(data.old_agent_id==DESKPRO_PERSON_ID&&this.openingChatTimeout[data.conversation_id]){window.clearTimeout(this.openingChatTimeout[data.conversation_id]);
delete this.openingChatTimeout[data.conversation_id];DeskPRO_Window.faviconBadge.disableCrazyMode()}this.handleUpdateCounts()
},handleInvited:function(data){$("#invite_chat_alert_"+data.conversation_id).remove();this.showInviteAlert(data)
},showInviteAlert:function(data){var conversation_id=data.conversation_id;var alertEl=$.tmpl("invite_chat_alert",data);
alertEl.appendTo("body");DeskPRO_Window.handleSoundElements(alertEl);var audio=$("audio",alertEl).get(0);
var self=this;$(".dismiss-trigger",alertEl).on("click",function(){if(audio&&audio.pause){try{audio.pause()
}catch(e){}}alertEl.remove()});$(".accept-trigger",alertEl).on("click",function(ev){ev.stopPropagation();
DeskPRO_Window.runPageRouteFromElement(this);if(audio&&audio.pause){audio.pause()}alertEl.remove()}).data("route","page:"+BASE_URL+"agent/chat/view/"+conversation_id)
},handleReassignedChat:function(data){var self=this;if(!this.isDepAllowed(data.department_id)&&data.agent_id!=DESKPRO_PERSON_ID){return
}this.handleUpdateCounts();this.modListingCount(data.agent_id,"+");if(data.agent_id&&!data.old_agent_id){this.modDepListingCount(data.department_id,"-")
}if(data.old_agent_id&&data.old_agent_id==DESKPRO_PERSON_ID){this.dismissedChats[data.conversation_id]=true
}var notifyWin=$("#new_user_chat_alert_"+data.conversation_id);if(notifyWin[0]){if(DP_USERCHAT_HIDE_CLAIMED_CHAT){notifyWin.remove();
return}notifyWin.addClass("claimed");notifyWin.find(".waiting.row").hide();notifyWin.find(".taken.row").show().find(".place-assigned-name").text(data.new_agent_name);
notifyWin.find("button.accept-trigger").hide();notifyWin.find("button.join-trigger").show();notifyWin.find("audio").remove();
notifyWin.data("dismiss-count",100);var updateFn=function(){notifyWin.find();var count=parseInt(notifyWin.data("dismiss-count"))-1;
notifyWin.data("dismiss-count",count);notifyWin.find("button.dismiss-trigger").find(".place-countdown").show().text("("+count+")");
if(count==0){notifyWin.remove()}else{window.setTimeout(updateFn,1000)}};updateFn()}DeskPRO_Window.getMessageBroker().sendMessage("chat_convo."+data.conversation_id+".reassigned",data);
if(data.agent_id==DESKPRO_PERSON_ID&&!this.isChatOpen(data.conversation_id)){this.openingChatTimeout[data.conversation_id]=window.setTimeout(function(){DeskPRO_Window.runPageRoute("page:"+BASE_URL+"agent/chat/view/"+data.conversation_id,{noToggle:true});
delete self.openingChatTimeout[data.conversation_id];DeskPRO_Window.faviconBadge.disableCrazyMode()},1000)
}this.handleUpdateCounts()},showNewChatAlert:function(data){if(!this.isDepAllowed(data.department_id)){return
}this.refreshOpenCounts();if(!this.onlineAgentIds.contains(DESKPRO_PERSON_ID)){return}var conversation_id=data.conversation_id;
var chatTabs=DeskPRO_Window.getTabWatcher().findTabType("userchat");var found=false;Array.each(chatTabs,function(t){if(t.meta&&t.meta.conversation_id&&parseInt(t.meta.conversation_id)==parseInt(conversation_id)){found=t;
return false}});if(found){DeskPRO_Window.loadPage(BASE_URL+"agent/chat/view/"+conversation_id,{ignoreExist:true});
found.closeSelf();return}var alertEl=$(data.html);alertEl.appendTo("body");DeskPRO_Window.handleSoundElements(alertEl);
var titles=this.getNewChatTitles();if(titles.length==1){var winTitle="New chat: "+titles[0]}else{var winTitle=titles.length+" New chats: "+titles.join(", ")
}DeskPRO_Window.faviconBadge.enableCrazyMode(winTitle);var audio=$("audio",alertEl).get(0);var self=this;
var secEl=alertEl.find("span.wait-timer");function up(){var secs=parseInt(secEl.data("time"));secs++;
secEl.data("time",secs);if(secs>60){secEl.text((Math.floor(secs/60))+" minutes")}else{secEl.text(secs+" seconds")
}}var waitTimer=window.setInterval(up,1000);DeskPRO_Window.notifications.addMessage("chat","New chat by "+alertEl.find(".label-by-name").text(),"page:"+BASE_URL+"agent/chat/view/"+conversation_id,"chat-"+conversation_id);
$(".dismiss-trigger",alertEl).on("click",function(){if(audio&&audio.pause){try{audio.pause()}catch(e){}}alertEl.remove();
self.dismissedChats[data.conversation_id]=true;DeskPRO_Window.faviconBadge.disableCrazyMode();window.clearTimeout(waitTimer)
});$(".accept-trigger, .join-trigger",alertEl).on("click",function(ev){ev.stopPropagation();DeskPRO_Window.runPageRouteFromElement(this);
if(audio){try{audio.pause()}catch(e){}}alertEl.remove();window.clearTimeout(waitTimer);if(!DeskPRO_Window.paneVis.tabs){DeskPRO_Window.setPaneVis("tabs",true)
}}).data("route","page:"+BASE_URL+"agent/chat/view/"+conversation_id)},getNewChatTitles:function(){var titles=[];
$("body > section.new-user-chat-alert").each(function(){titles.push($(this).find("span.label-by-name").text().trim())
});return titles},isDepAllowed:function(id){id=parseInt(id);console.log("%d in %o",id,window.DESKPRO_PERSON_PERMS.chat_dep_ids);
return window.DESKPRO_PERSON_PERMS.chat_dep_ids.indexOf(id)!==-1}});Orb.createNamespace("DeskPRO.Agent.WindowElement.Section");
DeskPRO.Agent.WindowElement.Section.Feedback=new Orb.Class({Extends:DeskPRO.Agent.WindowElement.Section.AbstractSection,init:function(){this.buttonEl=$("#feedback_section");
var self=this;this.urlFragmentName="feedback";this.setSectionElement($('<section id="feedback_outline"></section>'));
DeskPRO_Window.getSectionData("feedback_section",this._initSection.bind(this));DeskPRO_Window.getMessageBroker().addMessageListener("agent.ui.new-feedback",this.reload,this);
DeskPRO_Window.getMessageBroker().addMessageListener("agent.ui.feedback-status-update",this.reload,this);
window.setInterval(function(){self.reload()},420000);this.currentNavSelection=null;this.currentNavSelectionOldCount=null
},reload:function(){if(this.contentEl){var selectedNav=this.contentEl.find(".nav-selected").find(".list-counter");
if(selectedNav[0]){this.currentNavSelection=selectedNav.attr("id");this.currentNavSelectionOldCount=parseInt(selectedNav.text())
}}DeskPRO_Window.getSectionData("feedback_section",this._initSection.bind(this))},_initSection:function(data){this.setHasInitialLoaded();
this.contentEl.html(data.section_html);this._initSectionSearch();var self=this;this.catTabs=new DeskPRO.UI.SimpleTabs({context:this.sectionEl,triggerElements:$("#feedback_outline_tabstrip li"),onTabSwitch:function(info){}});
this.recountBadge();if(this.currentNavSelection){var el=$("#"+this.currentNavSelection).parent();if(el[0]){var count=parseInt($("#"+this.currentNavSelection).text());
if(count!=this.currentNavSelectionOldCount){DeskPRO_Window.runPageRouteFromElement(el)}el.addClass("nav-selected")
}}this.currentNavSelection=null;this.currentNavSelectionOldCount=null;this.fireEvent("sectionInit")},_initSectionSearch:function(){var searchPane=this.contentEl.find(".source-pane-search");
if(searchPane[0]){this.searchForm=new DeskPRO.Agent.SourcePane.SearchForm(searchPane)}},recountBadge:function(){var count=0;
count+=parseInt($("#feedback_validating_count").text().trim())||0;count+=parseInt($("#feedback_comments_validating_count").text().trim())||0;
this.updateBadge(count)}});Orb.createNamespace("DeskPRO.Agent.WindowElement.Section");DeskPRO.Agent.WindowElement.Section.Tasks=new Orb.Class({Extends:DeskPRO.Agent.WindowElement.Section.AbstractSection,init:function(){this.buttonEl=$("#tasks_section");
this.urlFragmentName="tasks";this.setSectionElement($('<section id="task_outline"></section>'));this.refresh();
DeskPRO_Window.getMessageBroker().addMessageListener("agent.ui.tasks.refresh-task-list",function(){this.refresh()
},this);this.doRelaodPage=false;this.addEvent("show",function(){if(this.doRelaodPage){this.refreshPage()
}},this)},refreshPage:function(){this.doRelaodPage=false;if(this.listPage&&this.listPage.meta.routeUrl){DeskPRO_Window.runPageRoute("listpane:"+this.listPage.meta.routeUrl)
}},refresh:function(){var countmap={};$("span.list-counter",this.contentEl).each(function(){countmap[$(this).attr("id")]=$(this).text().trim()
});var selected=$(".nav-selected",this.contentEl);var selectedCountId=null;if(selected){var e=$("span.list-counter",selected).first();
if(e.length){selectedCountId=e.attr("id")}}DeskPRO_Window.getSectionData("tasks_section",(function(data){this._initSection(data);
this.recalcBadge();if(selectedCountId){var countEl=$("#"+selectedCountId);var newCount=countEl.text().trim();
var nav=countEl.closest(".is-nav-item");nav.addClass("nav-selected");if(newCount!=countmap[selectedCountId]){var routeEl;
if(nav.data("route")){routeEl=nav}else{routeEl=$("[data-route]",nav).first()}DeskPRO_Window.runPageRouteFromElement(routeEl)
}}}).bind(this))},recalcBadge:function(){var total=parseInt($.trim($("#tasks_counter_all_total").text()));
this.modBadgeCount("=",total)},markUnloadPage:function(){this.doRelaodPage=true;if($("#task_outline").is(".on")){this.refreshPage()
}},_initSection:function(data){this.setHasInitialLoaded();this.contentEl.html(data.section_html);this.fireEvent("sectionInit")
}});Orb.createNamespace("DeskPRO.Agent.WindowElement.Section");DeskPRO.Agent.WindowElement.Section.Twitter=new Orb.Class({Extends:DeskPRO.Agent.WindowElement.Section.AbstractSection,init:function(){this.buttonEl=$("#twitter_section");
this.urlFragmentName="twitter";var self=this;this.setSectionElement($('<section id="twitter_outline"></section>'));
this.refresh();DeskPRO_Window.getMessageBroker().addMessageListener("agent.tweet-added",function(data){self.adjustTweetCountsFromClientMessage(data,1)
});DeskPRO_Window.getMessageBroker().addMessageListener("agent.tweet-updated",function(data){if(typeof data.change_archived!=="undefined"){if(data.change_archived){self.adjustTweetCountsFromClientMessage(data,-1)
}else{self.adjustTweetCountsFromClientMessage(data,1)}}if(data.deleted){self.adjustTweetCountsFromClientMessage(data,-1)
}if(data.favorited){self.adjustTweetCountsFromClientMessage(data,1);self.adjustTweetCountsFromClientMessage($.extend({},data,{is_favorited:0}),-1)
}if(data.unfavorited){self.adjustTweetCountsFromClientMessage(data,1);self.adjustTweetCountsFromClientMessage($.extend({},data,{is_favorited:1}),-1)
}if(typeof data.change_assignment!=="undefined"){self.adjustTweetCountsFromClientMessage(data,1);self.adjustTweetCountsFromClientMessage($.extend({},data,{assignment:data.old_assignment,agent_id:data.old_agent_id,agent_team_id:data.old_agent_team_id}),-1)
}});DeskPRO_Window.getMessageBroker().addMessageListener("agent.twitter-follower",function(data){var newCount=$("#twitter_"+data.account_id+"_new_followers_count");
var totalCount=$("#twitter_"+data.account_id+"_followers_count");var totalCountHeader=$("#twitter_"+data.account_id+"_followers_count_header");
switch(data.action){case"new":newCount.text(parseInt(newCount.text().trim(),10)+1);totalCount.text(parseInt(totalCount.text().trim(),10)+1);
totalCountHeader.text(totalCount.text());break;case"new-archived":totalCount.text(parseInt(totalCount.text().trim(),10)+1);
totalCountHeader.text(totalCount.text());break;case"archived":newCount.text(Math.max(0,parseInt(newCount.text().trim(),10)-1));
break;case"unarchived":newCount.text(parseInt(newCount.text().trim(),10)+1);break}});DeskPRO_Window.getMessageBroker().addMessageListener("agent.twitter-friend",function(data){var totalCount=$("#twitter_"+data.account_id+"_following_count");
var totalCountHeader=$("#twitter_"+data.account_id+"_following_count_header");switch(data.action){case"new":totalCount.text(parseInt(totalCount.text().trim(),10)+1);
totalCountHeader.text(totalCount.text());break;case"removed":totalCount.text(Math.max(0,parseInt(totalCount.text().trim(),10)-1));
totalCountHeader.text(totalCount.text());break}});DeskPRO_Window.getMessageBroker().addMessageListener("twitter-section.list-activated",function(info){var url="listpane:"+info.listUrl.replace("?partial=1","");
var interval;var f=function(){if(self.contentEl&&self.contentEl.find(".is-nav-item").length){clearInterval(interval);
interval=false;self.contentEl.find(".is-nav-item").each(function(){var $this=$(this);if($this.data("route")===url){self.highlightNavItem($this);
return false}})}};if(self.contentEl&&self.contentEl.find(".is-nav-item").length){f()}else{interval=setInterval(f,1000)
}});window.setInterval(function(){self.refresh()},420000)},adjustTweetCountsFromClientMessage:function(data,adjustAmount){if(data.is_from_self){return
}var accountId=data.account_id;var types={};this.getSectionElement().find("#twitter-section-counts-"+accountId+" > li").each(function(){var $this=$(this);
types[$this.data("type")]=$this});if(data.assignment==="agent:"+DESKPRO_PERSON_ID){this._adjustSectionCount(types.mine,data,adjustAmount)
}for(var i=0;i<DESKPRO_TEAM_IDS.length;i++){var teamId=DESKPRO_TEAM_IDS[i];if(data.assignment==="agent_team:"+teamId){this._adjustSectionCount(types.team,data,adjustAmount);
break}}if(data.assignment===""){if(data.is_favorited){this._adjustSectionCount(types.unassigned,data,adjustAmount)
}else{switch(data.status_type){case"direct":if(data.is_from_self){break}case"reply":case"mention":case"retweet":this._adjustSectionCount(types.unassigned,data,adjustAmount)
}}}if(data.is_favorited){this._adjustSectionCount(types.all,data,adjustAmount)}else{switch(data.status_type){case"direct":if(data.is_from_self){break
}case"reply":case"mention":case"retweet":this._adjustSectionCount(types.all,data,adjustAmount);break}}},_adjustSectionCount:function(el,data,adjustAmount){if(!el){return
}var groupType=el.data("initial-grouping");var type=el.data("type");var counter=el.find("h3 .list-counter");
counter.text(parseInt(counter.text().trim(),10)+adjustAmount);var subGroup=el.find(".sub-group");if(subGroup.length&&groupType){var value="";
switch(groupType){case"type":if(data.is_favorited){value="favorite"}else{switch(data.status_type){case"reply":case"mention":case"retweet":case"direct":value=data.status_type;
break;default:value="other"}}break;case"agent":value=data.agent_id;break;case"team":value=data.agent_team_id;
break}var specificValue=subGroup.find(".twitter-sub-group-"+data.account_id+"-"+type+"-"+groupType+"-"+value);
var count;if(specificValue.length){counter=specificValue.find(".list-counter");count=Math.max(0,parseInt(counter.text().trim(),10)+adjustAmount);
counter.text(count);var li=specificValue.closest("li");if(count==0){li.hide()}else{li.show()}}if(subGroup.find("li").filter(function(){return $(this).css("display")!=="none"
}).length){subGroup.show()}else{subGroup.hide()}}this.recountBadge()},refresh:function(extraData){var self=this;
DeskPRO_Window.getSectionData("twitter_section",function(data){self._initSection(data);if(self.sectionEl){var scroller=self.sectionEl.find(".with-scroll-handler").data("scroll_handler");
if(scroller){scroller.updateSize()}}},extraData)},_initSection:function(data){var self=this;this.setHasInitialLoaded();
this.contentEl.html(data.section_html);var contentEl=this.contentEl;contentEl.find(".source-list .sub-group").each(function(){var $this=$(this);
if(!$this.find("li").filter(function(){return $(this).css("display")!=="none"}).length){$this.css("display","none")
}});contentEl.on("click",".twitter-account-add-status",function(){if(DeskPRO_Window.newTweetLoader){var accountId=$(this).data("account-id");
DeskPRO_Window.newTweetLoader.open(function(page){var select=page.getEl("from_account");if(select.length&&select.is(".with-select2")){select.select2("val",[accountId])
}})}});contentEl.on("click",".twitter-search-delete-trigger",function(e){e.preventDefault();e.stopPropagation();
var $this=$(this);if(confirm($this.data("confirm"))){$.ajax({url:$this.attr("href"),type:"POST"});$this.closest("li").remove()
}});this.searchBoxes={};contentEl.find("input.twitter-search-add-box").each(function(){var searchBox=$(this);
var tabHolder=$(this).closest(".deskpro-tab-item");var accountId=tabHolder.data("account-id");self.searchBoxes[accountId]=searchBox;
searchBox.on("keypress",function(e){if(e.which!=13){return true}e.preventDefault();self.doSearch(searchBox.val(),accountId);
searchBox.val("")});tabHolder.find(".twitter-search-add-button").click(function(e){e.preventDefault();
self.doSearch(searchBox.val(),accountId);searchBox.val("")})});contentEl.find("input.twitter-person-find-box").each(function(){var personBox=$(this);
var tabHolder=$(this).closest(".deskpro-tab-item");var accountId=tabHolder.data("account-id");personBox.on("keypress",function(e){if(e.which!=13){return true
}e.preventDefault();self.doFindPerson(personBox.val(),accountId);personBox.val("")});tabHolder.find(".twitter-person-find-button").click(function(e){e.preventDefault();
self.doFindPerson(personBox.val(),accountId);personBox.val("")})});contentEl.find(".twitter-tab-container").each(function(){var container=$(this);
new DeskPRO.UI.SimpleTabs({context:container,triggerElements:".pane-section-tabs li",onTabSwitch:function(info){self.updateUi()
}})});var onGroupingChanged=function(accountId,group_by,el){el.data("initial-grouping",group_by);$.ajax({url:BASE_URL+"agent/twitter/update-grouping.json",data:{account_id:accountId,type:el.data("type"),group:group_by},dataType:"json",success:function(json){el.find(".item-form").hide();
if(json.group==el.data("initial-grouping")){var html=$(json.html);if(!html.find("li").filter(function(){return $(this).css("display")!=="none"
}).length){html.css("display","none")}el.find(".nav-list-small").first().replaceWith(html);el.find(".nav-list-small").show()
}}})};this.sectionEl.find(".dp-toggle-icon").on("click",function(ev){ev.preventDefault();ev.stopPropagation();
ev.stopImmediatePropagation();var $me=$(this);var $li=$me.closest("li");var $group=$li.find("> .item-form");
var $groupList=$li.find("> .nav-list-small");var sel=$group.find("select");var $account=$me.closest(".twitter-account-section");
var accountId=parseInt($account.data("account-id"));var $counter=$account.find(".counter").first();if($group[0]){if($me.hasClass("icon-caret-right")){$me.removeClass("icon-caret-right");
$me.addClass("icon-caret-down");$group.show();$groupList.show();if(!sel.hasClass("with-select2")){DP.select(sel);
sel.on("change",function(ev){onGroupingChanged(accountId,sel.val(),$li)})}}else{sel.select2("val","");
sel.trigger("change");$me.addClass("icon-caret-right");$me.removeClass("icon-caret-down");$group.hide();
$groupList.hide();onGroupingChanged(accountId,"",$li)}}});this.recountBadge()},doSearch:function(searchTerm,accountId){searchTerm=$.trim(searchTerm);
if(!searchTerm.length){return}var templateLi=this.searchBoxes[accountId].closest(".nav-list").find(".twitter-delete-template");
var templateHtml=templateLi.clone().wrap("<div>").parent().html();templateHtml=templateHtml.replace(/__placeholder-url__/g,encodeURIComponent(searchTerm)).replace(/__placeholder__/g,searchTerm);
templateLi.after($(templateHtml).show());DeskPRO_Window.runPageRoute("listpane:"+BASE_URL+"agent/twitter/"+accountId+"/search/new?search_term="+encodeURIComponent(searchTerm))
},doFindPerson:function(name,accountId){name=$.trim(name);if(!name.length){return}DeskPRO_Window.runPageRoute("page:"+BASE_URL+"agent/twitter/user/find?tab=1&name="+encodeURIComponent(name)+"&account_id="+accountId)
},recountBadge:function(){var count=0;this.contentEl.find(".twitter-all-counter").each(function(){count+=parseInt($(this).text().trim(),10)||0
});this.updateBadge(count)}});Orb.createNamespace("DeskPRO.Agent.WindowElement.Section");DeskPRO.Agent.WindowElement.Section.Deals=new Orb.Class({Extends:DeskPRO.Agent.WindowElement.Section.AbstractSection,init:function(){this.buttonEl=$("#deals_section");
this.urlFragmentName="deals";this.setSectionElement($('<section id="deal_outline"></section>'));this.refresh()
},refresh:function(){DeskPRO_Window.getSectionData("deals_section",this._initSection.bind(this))},_initSection:function(data){this.setHasInitialLoaded();
this.contentEl.html(data.section_html);this.recountBadge()},recountBadge:function(){var count=0;$("span.badge-count",this.contentEl).each(function(){count+=parseInt($(this).text().trim())||0
});this.updateBadge(count)}});Orb.createNamespace("DeskPRO.Agent.ElementHandler");DeskPRO.Agent.ElementHandler.SettingsWindow=new Orb.Class({Extends:DeskPRO.ElementHandler,initPage:function(){window.SETTINGS_WINDOW=this;
this.el.bind("dp_open",this.open.bind(this));this.el.bind("dp_close",this.close.bind(this))},_lazyInit:function(){var self=this;
this.updatePos();if(this._hasInit){return}this._hasInit=true;$(".close-trigger",this.el).first().on("click",function(ev){ev.stopPropagation();
ev.preventDefault();self.el.trigger("dp_close")});this.topTabs=new DeskPRO.UI.SimpleTabs({triggerElements:$("#settingswin_nav > li"),context:this.el,onTabSwitch:function(ev){var wrapper=$(ev.tabContent);
$("#settingswin_pages").find("> section.on").removeClass("on");wrapper.addClass("on");if(!wrapper.data("page-fragment")){self._loadPageForTabTarget(wrapper)
}else{wrapper.data("page-fragment").fireEvent("activate")}}});this.backdrop=$('<div class="backdrop fade" />').hide().appendTo("body").css("z-index",32000);
this.backdrop.click(this.close.bind(this));DeskPRO_Window.layout.addEvent("resized",function(){self.updatePos()
})},updatePos:function(){this.el.css({top:54,bottom:10,width:850,left:($(window).width()-700)/2});var overlay=this.el.find(".dp-overlay");
var winH=Math.min($(window).height()-150,700);overlay.css({"max-height":winH,"height":"auto"})},_loadPageForTabTarget:function(wrapper){var self=this;
$.ajax({dataType:"text",url:wrapper.data("page-url"),type:"GET",context:this,success:function(html){var page=DeskPRO_Window.createPageFragment(html);
page.settingsWindow=self;wrapper.html(page.html);delete page.html;page.fireEvent("render",[wrapper]);
page.fireEvent("activate");wrapper.data("page-fragment",page)}})},reloadTab:function(name){var tab=$("#settingswin_nav li.tab-"+name);
var target=$(tab.data("tab-for"));var page=target.data("page-fragment");if(page){page.fireEvent("destroy")
}target.empty();target.append('<div class="page-loading"></div>');if(tab.is(".on")){this._loadPageForTabTarget(target)
}},_cleanupOld:function(){},showSavePuff:function(){$("#settingswin_saved_overlay").fadeIn(250,function(){$("#settingswin_pages .on").scrollTop(0);
window.setTimeout(function(){$("#settingswin_saved_overlay").fadeOut(250)},1200)})},open:function(ev,tabName,activateView){this.el.data("activateView",activateView);
if(tabName){var tabEl=$("#settingswin_nav > li.tab-"+tabName)}if(tabName&&!this._hasInit){$("#settingswin_nav > li").removeClass("on");
tabEl.addClass("on")}this._lazyInit();if(tabName&&tabEl){this.topTabs.activateTab(tabEl)}if(this._cleanupTimer){window.clearTimeout(this._cleanupTimer);
this._cleanupTimer=null}this.el.show();this.backdrop.show();if($("#userSetting").data("backdrop")){$("#userSetting").data("backdrop").remove();
$("#userSetting").hide()}},isOpen:function(){if(this._hasInit&&this.el.is(":visible")){return true}return false
},close:function(){if(this.isOpen()){this.el.hide();this.backdrop.hide();this._cleanupTimer=window.setTimeout(this._cleanupOld.bind(this),180000);
if(this.reloadInterface){DeskPRO_Window.util.reloadInterface()}}}});Orb.createNamespace("DeskPRO.Agent.PageFragment.SettingsPage");
DeskPRO.Agent.PageFragment.SettingsPage.Profile=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="settings_profile"},initPage:function(el){var self=this;this.el=el;var form=$("form",this.el);
if(this.el.find(".dp-form-row.new-picture")[0]){DeskPRO_Window.util.fileupload(this.el.find(".dp-form-row.new-picture"));
this.el.find(".dp-form-row.new-picture").bind("fileuploadadd",function(){$(".files",form).empty()})}var startEmail=$("#settings_profile_email").val();
var changePass=false;var changeEmail=false;var verifyPasswords=function(){var pass1=$("input.password1",form);
var pass2=$("input.password2",form);if(!pass1[0]){changePass=false;return true}if(pass1.val().length){changePass=true;
if(pass1.val()!=pass2.val()){DeskPRO_Window.showAlert("Please enter the same password into both password fields","error");
return false}}else{changePass=false}return true};var checkEmailChange=function(){if($("#settings_profile_email").val()!=startEmail){changeEmail=true
}else{changeEmail=false}};var passCode=null;form.on("submit",function(ev){ev.preventDefault();ev.stopPropagation();
if(!verifyPasswords()){return}checkEmailChange();if((changePass||changeEmail)&&!passCode){$("#password_confirm").trigger("dp_open",{explain:"Confirm these changes to your profile by entering your current password.",success:function(code){passCode=code;
form.submit()}});return}var data=$(this).serializeArray();if(passCode){data.push({name:"authcode",value:passCode})
}$.ajax({url:$(this).attr("action"),type:"POST",data:data,dataType:"json",complete:function(){changePass=false;
changeEmail=false;passCode=null;$("input.password1",form).val("");$("input.password2",form).val("")},success:function(data){if(data.form_errors){$("#agent_settings_win_errors").find("li").hide();
Array.each(data.form_errors,function(code){var classname=code.replace(/\./g,"_");$("#agent_settings_win_errors").find("li."+classname).show()
});$("#agent_settings_win_errors").show();return}$("#agent_settings_win_errors").hide();if(data.login){DeskPRO_Window.util.reloadInterface();
return}self.settingsWindow.showSavePuff();startEmail=$("#settings_profile_email").val();self.settingsWindow.reloadInterface=true;
self.settingsWindow.reloadTab("profile")}})});if(window.webkitNotifications){var notificationsRow=el.find(".dp-desktop-notifications");
notificationsRow.show();var enableButton=notificationsRow.find(".enable-desktop-notifications");var permissionCallback=function(){var permission=window.webkitNotifications.checkPermission();
if(permission==0){enableButton.hide();notificationsRow.find(".dp-desktop-notifications-enabled").show();
notificationsRow.find(".dp-desktop-notifications-disabled").hide()}else{if(permission==1){enableButton.show();
notificationsRow.find(".dp-desktop-notifications-enabled").hide();notificationsRow.find(".dp-desktop-notifications-disabled").hide()
}else{enableButton.hide();notificationsRow.find(".dp-desktop-notifications-enabled").hide();notificationsRow.find(".dp-desktop-notifications-disabled").show()
}}};permissionCallback();this.addEvent("updateUi",function(){permissionCallback()});enableButton.click(function(e){e.preventDefault();
window.webkitNotifications.requestPermission(permissionCallback)});notificationsRow.find(".generate-test-notification").click(function(e){e.preventDefault();
if(window.webkitNotifications.checkPermission()!=0){return}var notification=window.webkitNotifications.createNotification("","DeskPRO","This is a test DeskPRO desktop notification.");
notification.ondisplay=function(){setTimeout(function(){notification.cancel()},60*1000)};notification.show()
})}el.find(".more_emails_empty").find("a").on("click",function(ev){Orb.cancelEvent(ev);el.find(".more_emails_empty").hide();
el.find(".more_emails").show()});var moreEmails=el.find(".more_emails");var addEmailTxt=el.find(".more_emails_txt");
el.find(".more_emails_trigger").on("click",function(ev){Orb.cancelEvent(ev);var val=$.trim(addEmailTxt.val());
if(!val.indexOf("@")){alert("Please enter a valid email address");return}var li=$('<li class="is-new">&bull; <input type="hidden" name="new_emails[]" /><span></span>&nbsp;&nbsp;&nbsp;<i class="icon-trash remove-trigger" title="Remove email"></i></li>');
li.addClass("is-new");li.find("input").val(val);li.find("span").text(val);moreEmails.find("ul").prepend(li);
addEmailTxt.val("")});moreEmails.on("click",".remove-trigger",function(ev){Orb.cancelEvent(ev);var li=$(this).closest("li");
if(li.hasClass("is-new")){li.remove()}else{var input=$('<input type="hidden" name="remove_emails[]" />');
input.val(li.data("email-id"));moreEmails.append(input);li.remove()}})}});Orb.createNamespace("DeskPRO.Agent.PageFragment.SettingsPage");
DeskPRO.Agent.PageFragment.SettingsPage.Signature=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="settings_signature"},initPage:function(el){var self=this;this.el=el;var form=$("form",this.el);
var textarea=$("#agent_settings_signature");if(DeskPRO_Window.canUseAgentReplyRte()&&textarea.data("rte")==1){textarea.val($("#agent_settings_signature_html").val());
DeskPRO_Window.initRteAgentReply(textarea,{defaultIsHtml:true,inlineHiddenPosition:$("#agent_settings_is_html_signature"),minHeight:100});
$("#agent_settings_is_html_signature").val(1)}else{textarea.val($("#agent_settings_signature_text").val())
}form.on("submit",function(ev){ev.preventDefault();ev.stopPropagation();if(textarea.syncCode){textarea.syncCode()
}var data=$(this).serializeArray();$.ajax({url:$(this).attr("action"),type:"POST",data:data,dataType:"json",success:function(data){self.settingsWindow.showSavePuff()
}})})}});Orb.createNamespace("DeskPRO.Agent.PageFragment.SettingsPage");DeskPRO.Agent.PageFragment.SettingsPage.TicketNotifications=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="settings_ticket_notifications"},initPage:function(el){var self=this;this.el=el;this.typeTabs=new DeskPRO.UI.SimpleTabs({triggerElements:$(".pageheader li",el),effect:"fade"});
var form=$("form",this.el);form.on("submit",function(ev){ev.preventDefault();ev.stopPropagation();var data=$(this).serializeArray();
$.ajax({url:$(this).attr("action"),type:"POST",data:data,dataType:"json",success:function(){self.settingsWindow.showSavePuff()
}})});var checks=this.el.find(":checkbox");Array.each(["email","alert"],function(type){checks.filter('[name^="filter_sub[5]['+type+'"]').each(function(){$(this).on("click",function(){if(this.checked){var name=$(this).attr("name").replace(/^.*?\[([a-zA-Z_]+)\]$/,"$1");
checks.filter('[name$="['+name+']"]').prop("checked",true)}})})})}});Orb.createNamespace("DeskPRO.Agent.PageFragment.SettingsPage");
DeskPRO.Agent.PageFragment.SettingsPage.OtherNotifications=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="settings_other_notifications"},initPage:function(el){var self=this;this.el=el;this.typeTabs=new DeskPRO.UI.SimpleTabs({triggerElements:$(".pageheader li",el)});
var form=$("form",this.el);form.on("submit",function(ev){ev.preventDefault();ev.stopPropagation();var data=$(this).serializeArray();
$.ajax({url:$(this).attr("action"),type:"POST",data:data,dataType:"json",success:function(){self.settingsWindow.showSavePuff()
}})})}});Orb.createNamespace("DeskPRO.Agent.PageFragment.SettingsPage");DeskPRO.Agent.PageFragment.SettingsPage.Macros=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="settings_macros"},initPage:function(el){var self=this;this.el=el;$("#settingswin").bind("dp_settings_macrosupdated",function(){self.settingsWindow.reloadTab("macros");
window.DESKPRO_MACRO_LABELS=null});var event=jQuery.Event("dp_macros_updated");event.macroItems=[];this.el.find(".obj-macro").each(function(ev){event.macroItems.push({id:$(this).data("macro-id"),title:$(this).text()})
});$("#settingswin").trigger(event);this.el.on("click",".delete-macro",function(){var row=$(this).closest("tr");
var url=$(this).data("delete-url");var macroId=$(this).data("macro-id");DeskPRO_Window.showConfirm("Are you sure you want to permanantly delete this macros?",function(){$.ajax({url:url,success:function(){row.fadeOut(function(){row.remove()
});$(".res-ticketmacro-"+macroId).remove()}})})})}});Orb.createNamespace("DeskPRO.Agent.PageFragment.SettingsPage");
DeskPRO.Agent.PageFragment.SettingsPage.MacroEdit=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="settings_macro_edit"},initPage:function(el){var self=this;this.el=el;var actTpl=this.getEl("actions_tpl");
var actList=this.getEl("actions_list");var editor=new DeskPRO.Form.RuleBuilder(actTpl);editor.addEvent("newRow",function(new_row){$(".remove",new_row).on("click",function(){new_row.remove()
})});$(".add-term",actList).data("add-count",0).on("click",function(){var count=parseInt($(this).data("add-count"));
var basename="actions["+count+"]";$(this).data("add-count",count+1);editor.addNewRow($(".search-terms",actList),basename);
self.el.find("article").first().scrollTop(10000)});var count=0;var actions=this.meta.actions;if(actions){Array.each(actions,function(info,x){var basename="actions[initial_"+x+"]";
editor.addNewRow($(".search-terms",actList),basename,{type:info.type,op:info.op,options:info.options})
})}this.getEl("save_btn").on("click",function(ev){ev.preventDefault();ev.stopPropagation();var form=self.getEl("form");
var postData=form.serializeArray();$.ajax({url:form.attr("action"),type:"POST",data:postData,dataType:"json",success:function(){$("#settingswin").trigger("dp_settings_macrosupdated");
self.fragmentOverlay.close()}})})}});Orb.createNamespace("DeskPRO.Agent.PageFragment.SettingsPage");DeskPRO.Agent.PageFragment.SettingsPage.Filters=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initPage:function(el){var ticketsSection=DeskPRO_Window.sections.tickets_section;
window.settings_filters_page=this;this.el=el;var self=this;var didChangeFilterVis=false;$("#settingswin").bind("dp_settings_filtersupdated",function(){self.settingsWindow.reloadInterface=true;
self.settingsWindow.reloadTab("filters")});var runningAjax=null;var sendUpdate=function(){if(runningAjax){runningAjax.abort();
runningAjax=null}var postData=[];self.el.find(".filter-hidden-check").each(function(){var id=parseInt($(this).val());
var v;if(this.checked){v="hidden"}else{v=""}postData.push({name:"prefs[agent.ui.filter-visibility."+id+"]",value:v})
});runningAjax=$.ajax({type:"POST",url:BASE_URL+"agent/misc/ajax-save-prefs",data:postData})};this.el.find(".filter-hidden-check").on("click",function(ev){if(!DeskPRO_Window||!DeskPRO_Window.sections.tickets_section){return
}var filterId=$(this).val();didChangeFilterVis=true;if(this.checked){$("#tickets_outline_custom_filters").find(".filter-"+filterId).addClass("filter-hidden");
if(!$("#tickets_outline_custom_filters").find("li.filter").not(".filter-hidden")[0]){$("#tickets_outline_custom_filters").find(".no-data").show()
}}else{$("#tickets_outline_custom_filters").find(".filter-"+filterId).removeClass("filter-hidden");$("#tickets_outline_custom_filters").find(".no-data").hide()
}$("#tickets_outline_custom_filters").find("li").removeClass("first").not(".filter-hidden").first().addClass("first");
sendUpdate()});var activateView=$("#settingswin").data("activateView");if(activateView){this.activateView(activateView)
}},initializeProperties:function(){this.parent();this.TYPENAME="settings_filters"}});Orb.createNamespace("DeskPRO.Agent.PageFragment.SettingsPage");
DeskPRO.Agent.PageFragment.SettingsPage.FilterEdit=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="settings_filter_edit"},initPage:function(el){var self=this;this.el=el;var ticketsSection=DeskPRO_Window.sections.tickets_section;
var critTpl=this.getEl("criteria_tpl");var critList=this.getEl("criteria_list");var editor=new DeskPRO.Form.RuleBuilder(critTpl);
editor.addEvent("newRow",function(new_row){$(".remove",new_row).on("click",function(){new_row.remove()
})});$(".add-term",critList).data("add-count",0).on("click",function(){var count=parseInt($(this).data("add-count"));
var basename="terms["+count+"]";$(this).data("add-count",count+1);editor.addNewRow($(".search-terms",critList),basename);
self.el.find("article").first().scrollTop(10000)});var count=0;var terms=this.meta.terms;if(terms){Array.each(terms,function(info,x){var basename="terms[initial_"+x+"]";
editor.addNewRow($(".search-terms",critList),basename,{type:info.type,op:info.op,options:info.options})
})}this.getEl("delete_btn").on("click",function(ev){ev.preventDefault();ev.stopPropagation();var url=$(this).data("delete-url");
var filterId=$(this).data("filter-id");DeskPRO_Window.showConfirm("Are you sure you want to permanantly delete this filter?",function(){$.ajax({url:url,success:function(){var ticketsSection=DeskPRO_Window.sections.tickets_section;
if(ticketsSection){ticketsSection.removeCustomFilter(filterId)}self.fragmentOverlay.close()}})})});this.getEl("save_btn").on("click",function(ev){ev.preventDefault();
ev.stopPropagation();var form=self.getEl("form");var postData=form.serializeArray();if(!$('input[name="filter[title]"]').val().trim().length){alert("Enter a filter title");
return}if(!$('select[name^="terms["]').length){alert("Choose at least one criteria");return}$.ajax({url:form.attr("action"),type:"POST",data:postData,dataType:"json",success:function(data){if(ticketsSection&&data){if(data.is_new){}else{ticketsSection.updateCustomFilterTitle(data.filter_id,data.filter_title)
}}$("#settingswin").trigger("dp_settings_filtersupdated");self.fragmentOverlay.close()}})})}});Orb.createNamespace("DeskPRO.Agent.PageFragment.SettingsPage");
DeskPRO.Agent.PageFragment.SettingsPage.TicketSlas=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initPage:function(el){this.el=el;
var self=this;var runningAjax=null;var sendUpdate=function(){if(runningAjax){runningAjax.abort();runningAjax=null
}var postData=[];self.el.find(".sla-hidden-check").each(function(){var id=parseInt($(this).val());var v;
if(this.checked){v="hidden"}else{v=""}postData.push({name:"prefs[agent.ui.sla.filter-visibility."+id+"]",value:v})
});postData.push({name:"prefs[agent.ui.sla.ticket-filter]",value:el.find(".grouping-option").val()});
runningAjax=$.ajax({type:"POST",url:BASE_URL+"agent/misc/ajax-save-prefs",data:postData})};el.find(".grouping-option").on("change",function(){$("#ticket_slas_header").data("sla-filter",$(this).val());
sendUpdate();if(!DeskPRO_Window||!DeskPRO_Window.sections.tickets_section){return}DeskPRO_Window.sections.tickets_section.getUpdatedSlaCounts()
});this.el.find(".sla-hidden-check").on("click",function(ev){if(!DeskPRO_Window||!DeskPRO_Window.sections.tickets_section){return
}var filterId=$(this).val();didChangeFilterVis=true;if(this.checked){$("#tickets_outline_slas").find(".sla-"+filterId).addClass("filter-hidden");
if($("#tickets_outline_slas").find("li").not(".filter-hidden")[0]){$("#tickets_outline_slas").find(".no-data").show()
}}else{$("#tickets_outline_slas").find(".sla-"+filterId).removeClass("filter-hidden");$("#tickets_outline_slas").find(".no-data").hide()
}sendUpdate()});var activateView=$("#settingswin").data("activateView");if(activateView){this.activateView(activateView)
}},initializeProperties:function(){this.parent();this.TYPENAME="settings_slas"}});Orb.createNamespace("DeskPRO.Agent.ElementHandler");
DeskPRO.Agent.ElementHandler.MediaManagerWindow=new Orb.Class({Extends:DeskPRO.ElementHandler,initPage:function(){window.MEDIA_MANAGER_WINDOW=this;
this.el.bind("dp_open",this.open.bind(this));this.el.bind("dp_close",this.close.bind(this));this.boundEditor=null
},bindToEditor:function(rte){this.boundEditor=rte},_lazyInit:function(){var self=this;if(this._hasInit){return
}this._hasInit=true;$("#mediawin_nav > li").removeClass("on");$("#mediawin_pages > section").each(function(){var page=$(this).data("page-fragment");
if(page){page.fireEvent("destroy")}$(this).data("page-fragment",null);$(this).empty();$(this).append('<div class="page-loading"></div>')
});this.el.css({top:45,bottom:120,width:780,left:($(window).width()-780)/2});$(".close-trigger",this.el).first().on("click",function(ev){ev.stopPropagation();
ev.preventDefault();self.el.trigger("dp_close")});this.topTabs=new DeskPRO.UI.SimpleTabs({triggerElements:$("#mediawin_nav > li"),context:this.el,onTabSwitch:function(ev){var wrapper=$(ev.tabContent);
$("#mediawin_pages .on").removeClass("on");wrapper.addClass("on");if(!wrapper.data("page-fragment")){self._loadPageForTabTarget(wrapper)
}else{if(wrapper.data("page-fragment").TYPENAME=="mediawin_browse"){self.reloadTab("browser")}else{self.reloadTab("upload")
}}}});this.backdrop=$('<div class="backdrop fade" />').hide().appendTo("body").css("z-index",32000);this.backdrop.click(this.close.bind(this))
},_loadPageForTabTarget:function(wrapper){if(wrapper.hasClass("loading")){return}wrapper.addClass("loading");
var self=this;$.ajax({dataType:"text",url:wrapper.data("page-url"),type:"GET",context:this,complete:function(){wrapper.removeClass("loading")
},success:function(html){var page=DeskPRO_Window.createPageFragment(html);page.mediaWindow=self;wrapper.html(page.html);
delete page.html;page.fireEvent("render",[wrapper]);page.fireEvent("activate");wrapper.data("page-fragment",page)
}})},reloadTab:function(name){var tab=$("#mediawin_nav li.tab-"+name);var target=$(tab.data("tab-for"));
var page=target.data("page-fragment");if(page){page.fireEvent("destroy");page.destroy()}target.empty();
target.append('<div class="page-loading"></div>');if(tab.is(".on")){this._loadPageForTabTarget(target)
}},showSavePuff:function(){$("#mediawin_saved_overlay").fadeIn(250,function(){$("#mediawin_pages .on").scrollTop(0);
window.setTimeout(function(){$("#mediawin_saved_overlay").fadeOut(250)},1200)})},open:function(ev,tabName,activateView){this._lazyInit();
var tabEl=null;if(tabName){tabEl=$("#mediawin_nav > li.tab-"+tabName)}if(tabName&&tabEl){this.topTabs.activateTab(tabEl)
}this.el.show();this.backdrop.show()},isOpen:function(){if(this._hasInit&&this.el.is(":visible")){return true
}return false},close:function(){if(this.isOpen()){this.el.hide();this.backdrop.hide()}this.boundEditor=null
}});Orb.createNamespace("DeskPRO.Agent.PageFragment.MediaManagerPage");DeskPRO.Agent.PageFragment.MediaManagerPage.Upload=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="mediawin_upload"},initPage:function(wrapper){var self=this;this.wrapper=wrapper;var el=wrapper.find(".manager-window-content");
DeskPRO_Window.util.fileupload(el,{page:this,saveMedia:1,uploadTemplate:$(".template-upload",el),downloadTemplate:$(".template-download",el)}).bind("fileuploadstart",function(){wrapper.find(".upload-control").hide()
}).bind("fileuploadadd",function(e,data){$(".files",wrapper).empty()}).bind("fileuploadcompleted",function(e,data){wrapper.find(".insert-trigger").each(function(){var btn=$(this);
btn.on("click",function(ev){ev.preventDefault();if(!window.MEDIA_MANAGER_WINDOW||!MEDIA_MANAGER_WINDOW.boundEditor||!MEDIA_MANAGER_WINDOW.boundEditor.selection){return
}if(btn.data("is-image")=="1"){MEDIA_MANAGER_WINDOW.boundEditor.selection.setContent('<img src="'+btn.data("download-url")+'" />')
}else{MEDIA_MANAGER_WINDOW.boundEditor.selection.setContent('<a href="'+btn.data("download-url")+'">'+btn.data("file-name")+"</a>")
}MEDIA_MANAGER_WINDOW.close()})});wrapper.find(".file-url").focus()});wrapper.on("click",".cancel-trigger",function(ev){ev.preventDefault();
wrapper.find(".upload-control").show();wrapper.find(".files").hide();self.mediaWindow.reloadTab("upload")
})}});Orb.createNamespace("DeskPRO.Agent.PageFragment.MediaManagerPage");DeskPRO.Agent.PageFragment.MediaManagerPage.Browse=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="mediawin_browse"},initPage:function(wrapper){this.wrapper=wrapper;wrapper.on("click",".insert-trigger",function(ev){ev.preventDefault();
if(!window.MEDIA_MANAGER_WINDOW||!MEDIA_MANAGER_WINDOW.boundEditor||!MEDIA_MANAGER_WINDOW.boundEditor.selection){return
}var btn=$(this);if(btn.data("is-image")=="1"){MEDIA_MANAGER_WINDOW.boundEditor.selection.setContent('<img src="'+btn.data("download-url")+'" />')
}else{MEDIA_MANAGER_WINDOW.boundEditor.selection.setContent('<a href="'+btn.data("download-url")+'">'+btn.data("file-name")+"</a>")
}MEDIA_MANAGER_WINDOW.close()})}});Orb.createNamespace("DeskPRO.Agent.PageHelper");DeskPRO.Agent.PageHelper.NewUserOverlay=new Class({Implements:[Options,Events],options:{contentEl:"div.new-user-overlay",context:document,saveUrl:null,zIndex:30001},contentEl:null,overlay:null,initialize:function(options){if(options){this.setOptions(options)
}this.contentEl=this.options.contentEl;if(typeOf(this.contentEl)=="string"){this.contentEl=$(this.contentEl,this.context)
}Orb.Compat.WebForms.placeholder($('input[name="person[first_name]"]',this.contentEl));Orb.Compat.WebForms.placeholder($('input[name="person[last_name]"]',this.contentEl))
},open:function(){this._initOverlay();this.overlay.openOverlay()},_hasInit:false,_initOverlay:function(){if(this._hasInit){return
}this._hasInit=true;this.overlay=new DeskPRO.UI.Overlay({contentElement:this.contentEl});$("button.save-trigger",this.contentEl).on("click",this._handleSave.bind(this))
},_handleSave:function(){var els=this.getFormElements();var data=els.serializeArray();var eventData={formData:data,contentEl:this.contentEl,overlay:this.overlay,cancel:false};
this.fireEvent("beforeSave",eventData);if(eventData.cancel){return}$.ajax({url:this.options.saveUrl,data:data,type:"POST",dataType:"json",success:this._handleSaveSuccess.bind(this)})
},_handleSaveSuccess:function(data){var eventData={contentEl:this.contentEl,overlay:this.overlay,data:data};
if(data.isError){$(".error-message",this.contentEl).html(data.errorMessage).show();return}this._clear();
this.fireEvent("afterSave",eventData)},_clear:function(){$(".error-message",this.contentEl).hide()},getFormElements:function(){var els=$(":input",this.contentEl);
return els},destroy:function(){if(this.overlay){this.overlay.destroy()}else{this.contentEl.remove()}}});
Orb.createNamespace("DeskPRO.Agent.PageHelper");DeskPRO.Agent.PageHelper.ListColDrag=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(options){this.options={table:null,onlyRowSel:null,onlyRowColOffset:0};
this.setOptions(options||{});this.moveIndicator=$('<div class="col-move"></div>').appendTo("body");this.table=$(this.options.table);
this.resetHeads();var self=this;this.heads.draggable({axis:"x",helper:function(event,ui){var el=$('<div style="background-color:#EEF1F5;padding:3px;border: 1px solid #CAD0D7;" />').text($(this).text());
return el},start:function(event,ui){event.stopPropagation();var index=$(this).index();$(this).closest("table").data("drag_col_index",index)
},stop:function(){self.moveIndicator.hide()},scope:"col-drag"});this.dropHeads.droppable({scope:"col-drag",over:function(event,ui){var index=$(this).index();
var pos=$(this).offset();var w=$(this).width();var leftPos=pos.left+w;self.moveIndicator.css({left:leftPos,top:pos.top-self.moveIndicator.height(),display:"block"})
},out:function(event,ui){},drop:function(event,ui){self.moveIndicator.hide();var orig_index=self.table.data("drag_col_index");
self.table.data("drag_col_index","null");var new_index=$(this).index();if(new_index==orig_index){return
}if(self.options.onlyRowSel){var rows=$(self.options.onlyRowSel,self.table)}else{var rows=$("tr",self.table)
}rows=rows.filter(":not(.is-head)");var method="after";if(self.options.onlyRowColOffset){orig_index-=self.options.onlyRowColOffset;
new_index-=self.options.onlyRowColOffset;if(new_index<0){new_index=0;method="before"}}var dragCell=$(ui.draggable);
var posCell=$(this);dragCell.detach().insertAfter(posCell);rows.each(function(row_index,row){var dragCell=$(row).find("td").eq(orig_index);
var posCell=$(row).find("td").eq(new_index);if(method=="before"){dragCell.detach().insertBefore(posCell)
}else{dragCell.detach().insertAfter(posCell)}});self.resetHeads();self.fireEvent("orderChanged",[self.heads,this])
}})},resetHeads:function(){var r=$("> thead:first > tr:first",this.table);r.addClass("is-head");$(".not-droppable").removeClass("not-droppable");
$(".not-draggable").addClass("not-droppable");this.heads=$("th:not(.not-draggable), td:not(.not-draggable)",r);
this.heads.eq(0).prev().addClass("first-drop-target").removeClass("not-droppable");this.dropHeads=$("th:not(.not-droppable), td:not(.not-droppable)",r)
}});Orb.createNamespace("DeskPRO.Agent.PageHelper");DeskPRO.Agent.PageHelper.ListColResize=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(options){this.options={table:null};
this.setOptions(options||{});this.table=$(this.options.table);var r=$("> thead:first > tr:first",this.table);
var heads=$("> td:not(.not-resizable), > th:not(.not-resizable)",r);$("td, th",r).each(function(){$(this).css({width:$(this).width()})
});this.table.css("table-layout","fixed");var self=this;heads.each(function(){var resizer=$('<div class="col-resizer"></div>');
var el=$(this);el.prepend(resizer);resizer.on("mousedown",function(ev){ev.stopPropagation()});resizer.draggable({helper:function(){return $('<div class="col-resizer-helper"></div>')
},cursorAt:{left:5},axis:"x",start:function(event,ui){event.stopPropagation()},stop:function(event,ui){var pos=el.offset();
var helperPos=ui.offset;var width=helperPos.left-pos.left;DP.console.log("%i %i",el.width(),width);el.css("width",width);
self.fireEvent("widthUpdated",[heads,self])}})})}});Orb.createNamespace("DeskPRO.Agent.PageHelper");DeskPRO.Agent.PageHelper.TicketFields=new Orb.Class({initialize:function(page){var self=this;
this.page=page;this.display=this.page.getEl("field_holders").find(".field-holders-table");this.mode="view";
this.currentDisplay=[];this.currentDisplayModify=[];this.ticketReader={getDepartmentId:function(){if(self.mode=="edit"){var catId=self.page.getEl("department_id").val()
}else{var catId=self.page.getEl("value_form").find(".department_id").val()}return parseInt(catId)||0},getCategoryId:function(){var catId=null;
if(self.mode=="edit"){catId=self.page.getEl("ticket_category_id").val()}if(typeof catId=="undefined"||catId===null){catId=self.page.getEl("value_form").find(".category_id").val()
}return parseInt(catId)||0},getPriorityVal:function(){var id=this.getPriorityId();if(!id){return -999999999
}if(!window.DESKPRO_TICKET_PRI_MAP||!window.DESKPRO_TICKET_PRI_MAP[id]){return 0}return parseInt(window.DESKPRO_TICKET_PRI_MAP[id])
},getPriorityId:function(){var catId=null;if(self.mode=="edit"){catId=self.page.getEl("ticket_priority_id").val()
}if(typeof catId=="undefined"||catId===null){catId=self.page.getEl("value_form").find(".priority_id").val()
}return parseInt(catId)||0},getProductId:function(){var catId=null;if(self.mode=="edit"){catId=self.page.getEl("ticket_product_id").val()
}if(typeof catId=="undefined"||catId===null){catId=self.page.getEl("value_form").find(".product_id").val()
}return parseInt(catId)||0},getOrganizationId:function(){return 0},getWorkflow:function(){var catId=null;
if(self.mode=="edit"){catId=self.page.getEl("value_form").find(".workflow_id").val()}if(typeof catId=="undefined"||catId===null){catId=self.page.getEl("ticket_workflow_id").val()
}return parseInt(catId)||0}};this.fieldDisplay=new DeskPRO.Agent.PageHelper.TicketFieldDisplay(this.ticketReader,"view");
this.fieldDisplayModify=new DeskPRO.Agent.PageHelper.TicketFieldDisplay(this.ticketReader,"modify");this.page.getEl("department").on("change",function(){self.updateDisplay()
});this.page.getEl("field_edit_start").on("click",function(ev){ev.preventDefault();self.openEditMode()
});self.page.getEl("field_edit_cancel").on("click",function(ev){ev.preventDefault();self.closeEditMode()
});self.page.getEl("field_edit_save").on("click",function(ev){self.page.getEl("field_edit_cancel").hide();
self.page.getEl("field_edit_save").hide();self.page.getEl("field_edit_start").hide();self.page.getEl("field_edit_controls").addClass("loading");
self.page.getEl("field_errors").hide().removeClass("on");self.saveChanges()});this.page.changeManager.addEvent("updateResult",function(data){if(data.holders){if(self.mode=="view"){self.replaceHolders(data.holders)
}}})},openEditMode:function(){this.mode="edit";this.display.addClass("mode-edit-on");this.page.getEl("field_edit_start").hide();
this.page.getEl("field_edit_cancel").show();this.page.getEl("field_edit_save").show();this.page.getEl("field_edit_controls").removeClass("loading");
this.display.find("select[multiple]").each(function(){var min=$(this).width()+30;var parent=$(this).closest("td").find("> div").first().width();
if(parent){min=Math.max(min,Math.ceil(parent/1.75))}$(this).width(min)});DP.select(this.display.find("select"));
this.updateDisplay();$(".Date.customfield input",this.display).datepicker({dateFormat:"yy-mm-dd",showButtonPanel:true,beforeShow:function(input){setTimeout(function(){var buttonPane=$(input).datepicker("widget").find(".ui-datepicker-buttonpane");
buttonPane.find("button:first").remove();var btn=$('<button class="ui-datepicker-current ui-state-default ui-priority-secondary ui-corner-all" type="button">Clear</button>');
btn.unbind("click").bind("click",function(){$.datepicker._clearDate(input)});btn.appendTo(buttonPane);
$(input).datepicker("widget").css("z-index",30001)},1)}});this.page.getEl("fields_display_main_wrap_tab").click()
},closeEditMode:function(){this.mode="view";this.display.removeClass("mode-edit-on");this.page.getEl("field_edit_save").hide();
this.page.getEl("field_edit_cancel").hide();this.page.getEl("field_edit_start").show();this.page.getEl("field_edit_controls").removeClass("loading");
this.updateDisplay()},updateDisplay:function(){if(this.mode=="view"){this.updateDisplay_view()}else{this.updateDisplay_modify()
}},updateDisplay_modify:function(){var fields=this.fieldDisplayModify.getFields(this.ticketReader.getDepartmentId());
if(!fields||!fields["default"]){fields["default"]=[]}fields=fields["default"];if(fields.length==this.currentDisplayModify.length){var change=false;
for(var i=0;i<fields.length;i++){if(this.currentDisplayModify&&this.currentDisplayModify[i]&&fields[i].field_type==this.currentDisplayModify[i].field_type){if(fields[i].field_type=="ticket_field"&&fields[i].field_id!=this.currentDisplayModify[i].field_id){change=true;
break}}else{change=true;break}}}else{var change=true}if(!change){console.log("[TicketFields] No change");
return}this.currentDisplayModify=fields;this.display.find("tbody.item.item-on").hide().removeClass("item-on");
var last=this.display.find("tbody.always-bottom");Array.each(this.currentDisplayModify,function(f){if(f.field_type=="ticket_field"){var classname="ticket_field_"+f.field_id
}else{var classname=f.field_type}this.display.find(".item."+classname).detach().appendTo(this.display).show().addClass("item-on")
},this);last.detach().appendTo(this.display)},updateDisplay_view:function(){var fields=this.fieldDisplay.getFields(this.ticketReader.getDepartmentId());
if(!fields||!fields["default"]){fields["default"]=[]}fields=fields["default"];if(fields.length==this.currentDisplay.length){var change=false;
for(var i=0;i<fields.length;i++){if(fields[i].field_type==this.currentDisplay[i].field_type){if(fields[i].field_type=="ticket_field"&&fields[i].field_id!=this.currentDisplay[i].field_id){change=true;
break}}else{change=true;break}}}else{var change=true}if(!change){console.log("[TicketFields] No change");
return}this.currentDisplay=fields;this.display.find("tbody.item.item-on").hide().removeClass("item-on");
var last=this.display.find("tbody.always-bottom");Array.each(this.currentDisplay,function(f){if(f.field_type=="ticket_field"){var classname="ticket_field_"+f.field_id
}else{var classname=f.field_type}this.display.find(".item."+classname).detach().appendTo(this.display).show().addClass("item-on")
},this);last.detach().appendTo(this.display)},saveChanges:function(){var changeManager=this.page.changeManager;
this.display.find("[data-prop-id]").each(function(){var prop=changeManager.getPropertyManager($(this).data("prop-id"));
prop.setValue($(this).val());changeManager.addChange(prop)});var customFieldData=this.display.find(".custom-field input, .custom-field textarea, .custom-field select").serializeArray();
this.display.find('input[type="checkbox"][value="1"]').not(":checked").each(function(){customFieldData.push({name:$(this).attr("name"),value:"0"})
});changeManager.saveChanges(customFieldData,(function(data){this.updateDisplay();this.closeEditMode();
if(data.data&&data.data.perm_errors){var div=$("<div/>");div.append("<strong>You do not have permission to change some fields. The following changes were not saved:</strong>");
var list=$("<ul />");list.appendTo(div);Array.each(data.data.perm_errors,function(err){var li=$("<li/>");
li.text(err.capitalize());li.appendTo(list)});DeskPRO_Window.showAlert(div)}if(data.data&&data.data.reload){this.page.closeSelf();
DeskPRO_Window.runPageRoute("ticket:"+BASE_URL+"agent/tickets/"+this.page.meta.ticket_id)}}).bind(this))
},replaceHolders:function(html){var last=this.display.find("tbody.always-bottom");last.detach();var old=this.display;
this.display=$('<table cellspacing="0" cellpadding="0" width="100%" class="field-holders-table">'+html+"</table>");
old.after(this.display);old.remove();this.display.append(last);this.currentDisplay=[];this.currentDisplayModify=[];
this.updateDisplay()}});Orb.createNamespace("DeskPRO.Agent.PageHelper");DeskPRO.Agent.PageHelper.TicketFieldDisplay=new Orb.Class({initialize:function(ticketReader,mode){this.ticketReader=ticketReader;
this.mode=mode||"create"},getFields:function(department_id){department_id=parseInt(department_id);DP.console.log("[TicketFieldDisplay] department %i",department_id);
var depItems=[];if(window.DESKPRO_TICKET_DISPLAY&&window.DESKPRO_TICKET_DISPLAY[this.mode]){if(this.mode=="view"){if(typeof window.DESKPRO_TICKET_DISPLAY[this.mode][department_id]=="undefined"&&typeof window.DESKPRO_TICKET_DISPLAY[this.mode][department_id]=="undefined"){DP.console.log("[TicketFieldDisplay] Dynamic switch mode to create");
this.mode="create"}}if(typeof window.DESKPRO_TICKET_DISPLAY[this.mode][department_id]=="undefined"){DP.console.log("[TicketFieldDisplay] Dynamic switch to dep 0");
depItems=window.DESKPRO_TICKET_DISPLAY[this.mode][0]||[]}else{DP.console.log("[TicketFieldDisplay] Using dep");
depItems=window.DESKPRO_TICKET_DISPLAY[this.mode][department_id]||[]}}DP.console.log("[TicketFieldDisplay] depItems %o",depItems);
var items=this.runRules(depItems);DP.console.log("[TicketFieldDisplay] items %o",items);return items},runRules:function(depItems){var items={};
Array.each(depItems,function(item){if(!items[item.section]){items[item.section]=[]}switch(item.section){case"default":var state=this.runCheckForItem(item);
if(state){items[item.section].push(item)}break}},this);return items},runCheckForItem:function(item){var visible=true;
if(item.check&&!item.check(this.ticketReader)){visible=false}return visible}});Orb.createNamespace("DeskPRO.Agent.PageHelper");
DeskPRO.Agent.PageHelper.ChatFields=new Orb.Class({initialize:function(page){var self=this;this.page=page;
this.display=this.page.getEl("field_holders").find(".field-holders-table");this.mode="view";this.currentDisplay=[];
this.currentDisplayModify=[];this.chatReader={getDepartmentId:function(){var catId=self.page.getEl("department_id").val();
return parseInt(catId)||0}};this.fieldDisplay=new DeskPRO.Agent.PageHelper.ChatFieldDisplay(this.ticketReader,"create");
this.fieldDisplayModify=new DeskPRO.Agent.PageHelper.ChatFieldDisplay(this.ticketReader,"create");this.page.getEl("department_id").on("change",function(){self.updateDisplay()
});this.page.getEl("field_edit_start").on("click",function(ev){ev.preventDefault();self.openEditMode()
});self.page.getEl("field_edit_cancel").on("click",function(ev){ev.preventDefault();self.closeEditMode()
});self.page.getEl("field_edit_save").on("click",function(ev){self.page.getEl("field_edit_cancel").hide();
self.page.getEl("field_edit_save").hide();self.page.getEl("field_edit_start").hide();self.page.getEl("field_edit_controls").addClass("loading");
self.page.getEl("field_errors").hide().removeClass("on");self.saveChanges()})},openEditMode:function(){this.mode="edit";
this.display.addClass("mode-edit-on");this.page.getEl("field_edit_start").hide();this.page.getEl("field_edit_cancel").show();
this.page.getEl("field_edit_save").show();this.page.getEl("field_edit_controls").removeClass("loading");
this.display.find("select[multiple]").each(function(){var min=$(this).width()+30;var parent=$(this).closest("td").find("> div").first().width();
if(parent){min=Math.max(min,Math.ceil(parent/1.75))}$(this).width(min)});DP.select(this.display.find("select"));
this.updateDisplay();$(".Date.customfield input",this.display).datepicker({dateFormat:"yy-mm-dd",showButtonPanel:true,beforeShow:function(input){setTimeout(function(){var buttonPane=$(input).datepicker("widget").find(".ui-datepicker-buttonpane");
buttonPane.find("button:first").remove();var btn=$('<button class="ui-datepicker-current ui-state-default ui-priority-secondary ui-corner-all" type="button">Clear</button>');
btn.unbind("click").bind("click",function(){$.datepicker._clearDate(input)});btn.appendTo(buttonPane);
$(input).datepicker("widget").css("z-index",30001)},1)}});this.page.getEl("fields_display_main_wrap_tab").click()
},closeEditMode:function(){this.mode="view";this.display.removeClass("mode-edit-on");this.page.getEl("field_edit_save").hide();
this.page.getEl("field_edit_cancel").hide();this.page.getEl("field_edit_start").show();this.page.getEl("field_edit_controls").removeClass("loading");
this.updateDisplay()},updateDisplay:function(){if(this.mode=="view"){this.updateDisplay_view()}else{this.updateDisplay_modify()
}},updateDisplay_modify:function(){var fields=this.fieldDisplayModify.getFields(this.chatReader.getDepartmentId());
if(!fields||!fields["default"]){fields["default"]=[]}fields=fields["default"];if(fields.length==this.currentDisplayModify.length){var change=false;
for(var i=0;i<fields.length;i++){if(this.currentDisplayModify&&this.currentDisplayModify[i]&&fields[i].field_type==this.currentDisplayModify[i].field_type){if(fields[i].field_type=="chat_field"&&fields[i].field_id!=this.currentDisplayModify[i].field_id){change=true;
break}}else{change=true;break}}}else{var change=true}if(!change){var ons=this.display.find("tbody.item-on");
ons.removeClass("last");ons.last().addClass("last");console.log("[ChatFields] No change");return}this.currentDisplayModify=fields;
this.display.find("tbody.item.item-on").hide().removeClass("item-on");Array.each(this.currentDisplayModify,function(f){if(f.field_type=="chat_field"){var classname="chat_field_"+f.field_id
}else{var classname=f.field_type}this.display.find(".item."+classname).detach().appendTo(this.display).show().addClass("item-on")
},this);var ons=this.display.find("tbody.item-on");if(ons[0]){ons.removeClass("last");ons.last().addClass("last");
this.page.getEl("fields_display_main_wrap_tab").show()}else{this.page.getEl("fields_display_main_wrap_tab").hide();
if(this.page.getEl("fields_display_main_wrap_tab").hasClass("on")){this.page.getEl("fields_display_main_wrap_tab").next().trigger("click")
}}},updateDisplay_view:function(){var fields=this.fieldDisplay.getFields(this.chatReader.getDepartmentId());
if(!fields||!fields["default"]){fields["default"]=[]}fields=fields["default"];if(fields.length==this.currentDisplay.length){var change=false;
for(var i=0;i<fields.length;i++){if(fields[i].field_type==this.currentDisplay[i].field_type){if(fields[i].field_type=="chat_field"&&fields[i].field_id!=this.currentDisplay[i].field_id){change=true;
break}}else{change=true;break}}}else{var change=true}if(!change){console.log("[ChatFields] No change");
var ons=this.display.find("tbody.item-on");ons.removeClass("last");ons.last().addClass("last");return
}this.currentDisplay=fields;this.display.find("tbody.item.item-on").hide().removeClass("item-on");Array.each(this.currentDisplay,function(f){if(f.field_type=="chat_field"){var classname="chat_field_"+f.field_id
}else{var classname=f.field_type}this.display.find(".item."+classname).detach().appendTo(this.display).show().addClass("item-on")
},this);var ons=this.display.find("tbody.item-on");if(ons[0]){ons.removeClass("last");ons.last().addClass("last");
this.page.getEl("fields_display_main_wrap_tab").show()}else{this.page.getEl("fields_display_main_wrap_tab").hide();
if(this.page.getEl("fields_display_main_wrap_tab").hasClass("on")){this.page.getEl("fields_display_main_wrap_tab").next().trigger("click")
}}},saveChanges:function(){var data=this.page.getEl("field_holders").find("input, select, textarea").serializeArray();
$.ajax({url:BASE_URL+"agent/chat/"+this.page.meta.conversation_id+"/save-fields",type:"POST",dataType:"html",data:data,context:this,complete:function(){this.page.getEl("field_edit_cancel").hide();
this.page.getEl("field_edit_save").hide();this.page.getEl("field_edit_start").show();this.page.getEl("field_edit_controls").removeClass("loading")
},success:function(new_holders){this.replaceHolders(new_holders)}})},replaceHolders:function(html){this.display.parent().html(html);
this.display=this.page.getEl("field_holders").find(".field-holders-table");this.currentDisplay=[];this.currentDisplayModify=[];
this.updateDisplay()}});Orb.createNamespace("DeskPRO.Agent.PageHelper");DeskPRO.Agent.PageHelper.ChatFieldDisplay=new Orb.Class({initialize:function(chatReader,mode){this.chatReader=chatReader;
this.mode=mode||"create"},getFields:function(department_id){department_id=parseInt(department_id);DP.console.log("[ChatFieldDisplay] department %i",department_id);
var depItems=[];if(window.DESKPRO_CHAT_DISPLAY&&window.DESKPRO_CHAT_DISPLAY[this.mode]){if(this.mode=="view"){if(typeof window.DESKPRO_CHAT_DISPLAY[this.mode][department_id]=="undefined"&&typeof window.DESKPRO_CHAT_DISPLAY[this.mode][department_id]=="undefined"){DP.console.log("[ChatFieldDisplay] Dynamic switch mode to create");
this.mode="create"}}if(typeof window.DESKPRO_CHAT_DISPLAY[this.mode][department_id]=="undefined"){DP.console.log("[ChatFieldDisplay] Dynamic switch to dep 0");
depItems=window.DESKPRO_CHAT_DISPLAY[this.mode][0]||[]}else{DP.console.log("[ChatFieldDisplay] Using dep");
depItems=window.DESKPRO_CHAT_DISPLAY[this.mode][department_id]||[]}}DP.console.log("[ChatFieldDisplay] depItems %o",depItems);
var items=this.runRules(depItems);DP.console.log("[ChatFieldDisplay] items %o",items);return items},runRules:function(depItems){var items={};
Array.each(depItems,function(item){if(!items[item.section]){items[item.section]=[]}switch(item.section){case"default":var state=this.runCheckForItem(item);
if(state){items[item.section].push(item)}break}},this);return items},runCheckForItem:function(item){return true
}});Orb.createNamespace("DeskPRO.Agent.PageHelper");DeskPRO.Agent.PageHelper.ListSearchForm=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(page,options){this.page=page;
this.options={form:null,context:null,searchData:null};this.setOptions(options);this.form=this.options.form;
this.topSection=this.options.context;this._initSearchOptions()},_initSearchOptions:function(){var editBtn=$(".summary .edit",this.topSection);
editBtn.on("click",this.showSearchForm.bind(this));var form=this.form;var self=this;form.on("submit",function(ev){ev.preventDefault();
var url=form.attr("action");var data=form.serializeArray();self.fireEvent("searchSubmit",[url,data])})
},showSearchForm:function(){var criteriaList=$(".search-form",this.topSection);var criteriaTerms=$(".search-builder-tpl",this.topSection);
var editor=new DeskPRO.Form.RuleBuilder(criteriaTerms);$(".add-term",criteriaList).data("add-count",0).on("click",function(){var count=parseInt($(this).data("add-count"));
var basename="terms["+count+"]";$(this).data("add-count",count+1);editor.addNewRow($(".search-terms",criteriaList),basename)
});var searchDataEl=this.searchData;if(searchDataEl&&searchDataEl.length){var searchData=searchDataEl.get(0).innerHTML;
searchData=$.parseJSON(searchData);if(searchData.terms){Array.each(searchData.terms,function(info,x){var basename="terms[initial_"+x+"]";
editor.addNewRow($(".search-terms",criteriaList),basename,{type:info.type,op:info.op,options:info.options})
})}searchDataEl.remove()}$(".summary",this.topSection).slideUp();$(".form-panel",this.topSection).slideDown()
}});Orb.createNamespace("DeskPRO.Agent.PageHelper");DeskPRO.Agent.PageHelper.CategoryEdit=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(options){this.options={wrapper:null};
this.setOptions(options||{});this.wrapper=$(this.options.wrapper)},_init:function(){if(this.hasInit){return
}this.hasInit=true;this.wrapper.detach().appendTo("body");this.wrapper.on("click",function(ev){ev.stopPropagation()
});$(".close-trigger",this.wrapper).on("click",(function(ev){this.close()}).bind(this));$(".new-close-trigger",this.wrapper).on("click",(function(ev){this.closeNewDlg()
}).bind(this));$("ul",this.wrapper).sortable({axis:"y",items:"> li"});this.backdrop=$(".backdrop:first",this.wrapper);
this.newDlg=$(".new-dlg:first",this.wrapper);this.newParent=$("select:first",this.newDlg);this.newTitle=$("input:first",this.newDlg);
$(".add-save-trigger",this.newDlg).on("click",(function(){this.addNewToList()}).bind(this));$(".add-trigger:first",this.wrapper).on("click",(function(){this.openNewDlg()
}).bind(this));$(".save-all-trigger",this.wrapper).on("click",(function(){this.fireEvent("save",[this]);
this.close()}).bind(this));var self=this;this.wrapper.on("dblclick",".title",function(){self.enableEditTitle($(this))
})},open:function(){this._init();if(this.wrapper.is(".open")){return}this.wrapper.css({position:"absolute",left:40,top:150});
this.wrapper.addClass("open").fadeIn()},close:function(){this.closeNewDlg();this.wrapper.removeClass("open").fadeOut()
},openNewDlg:function(){var html=[];$("li > .title",this.wrapper).each(function(){var el=$(this);var depth=parseInt(el.data("depth"));
var catId=el.data("cat-id");var title=el.text().trim();if(depth){title=Orb.strRepeat("--",depth)+" "+title
}html.push('<option value="'+catId+'">'+Orb.escapeHtml(title)+"</option>")});html=html.join("");$("option:not(.none)",this.newParent).remove();
$("option.none",this.newParent).after($(html));var top=50;var left=65;var dlg=this.newDlg;dlg.css({display:"absolute",top:top,left:left});
this.backdrop.fadeIn("fast");dlg.fadeIn()},closeNewDlg:function(){var dlg=this.newDlg;dlg.fadeOut("fast");
this.backdrop.fadeOut("fast")},addNewToList:function(){var parentId=this.newParent.val();var title=this.newTitle.val().trim();
if(!title.length){return}this.newTitle.val("");var ul,depth=0,parent_li=false;if(parentId&&parentId!="0"){parent_li=$("li.cat-"+parentId,this.wrapper)
}if(parent_li&&parent_li.length){depth=parseInt($("> .title",parent_li).data("depth"))+1;ul=$("> ul",parent_li);
if(!ul.length){var new_ul=$("<ul></ul>");parent_li.append(new_ul);new_ul.sortable({axis:"y",items:"> li"})
}ul=$("> ul",parent_li)}else{ul=$("ul.top:first",this.wrapper)}var tmp_id="new_"+Orb.uuid();var li='<li class="cat-'+tmp_id+'"><div class="title new" data-cat-id="'+tmp_id+'" data-depth="'+depth+'">'+Orb.escapeHtml(title)+"</div></li>";
ul.append(li);this.closeNewDlg()},enableEditTitle:function(titleEl){var input=$("<input />");input.val(titleEl.text().trim());
titleEl.empty().append(input);var btn=$('<button class="dp-button x-small">Apply</button>');titleEl.append(btn);
var self=this;input.on("keypress",function(ev){if(ev.keyCode==13){ev.preventDefault();self._applyEditTitle(titleEl,input)
}});btn.on("click",function(){self._applyEditTitle(titleEl,input)})},_applyEditTitle:function(titleEl,input){titleEl.empty().text(input.val())
},encode:function(){var data=[];this._encodeSet(data,$("ul.top",this.wrapper),0);return data},_encodeSet:function(data,ul,parentId){var self=this;
$("li",ul).each(function(){var li=$(this);var title=$("> .title",li);var catId=title.data("cat-id");var displayOrder=data.length+1;
var isNew=title.is(".new");data.push({id:catId,parentId:parentId,isNew:isNew,displayOrder:displayOrder,title:title.text().trim()});
var ul=$("> ul",li);if(ul.length){self._encodeSet(data,ul,catId)}})},encodeForm:function(name){if(!name){name="cats"
}var rawData=this.encode();var data=[];var count=0;Array.each(rawData,function(item){Object.each(item,function(v,k){if(k=="isNew"){if(v){v=1
}else{v=0}}data.push({name:name+"["+count+"]["+k+"]",value:v})});count++});return data},destroy:function(){if(this.hasInit){this.wrapper.remove()
}}});Orb.createNamespace("DeskPRO.Agent.PageHelper");DeskPRO.Agent.PageHelper.DisplayOptions=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(page,options){var self=this;
this.page=page;this.options={triggerElement:null,resultId:0,prefSaveResultId:null,prefId:"",refreshUrl:""};
this.setOptions(options);if(this.options.prefSaveResultId===null){this.options.prefSaveResultId=this.options.resultId
}if(!this.options.triggerElement){this.options.triggerElement=$(".display-options-trigger",this.page.wrapper)
}$(this.options.triggerElement).on("click",(function(ev){ev.stopPropagation();ev.preventDefault();this.open()
}).bind(this));var menuBtn=$("button.order-by-trigger",this.page.wrapper);var menuEl=$("ul.order-by-menu",this.page.wrapper);
if(menuBtn.length&&menuEl.length){this.orderByMenu=new DeskPRO.UI.Menu({triggerElement:menuBtn,menuElement:menuEl,onItemClicked:(function(info){var item=$(info.itemEl);
var prop=item.data("field");var label=item.text().trim();$(".label",menuBtn).text(label);var disOptWrap=self.getWrapperElement();
var sel=$("select.sel-order-by",disOptWrap);$("option",sel).prop("selected",false);$("option."+prop.replace(".","_"),sel).prop("selected",true);
self.saveAndRefresh()}).bind(this)})}this.page.addEvent("destroy",(function(){this.destroy()}).bind(this))
},_initOverlay:function(){if(this._hasInit){return}this._hasInit=true;var ul=$("ul.display-fields-list.on-list",this.wrapper);
var makeBogus=function(ul){var exist=ul.find("> li.bogus").length;for(var i=exist;i<8;i++){var li=$('<li class="bogus">&nbsp;</li>');
li.css({width:30,visibility:"hidden"});ul.append(li)}};this.wrapper=$(".display-options",this.page.wrapper).first();
this.optionsList=$("ul.display-fields-list.on-list",this.wrapper).sortable({forceHelperSize:true,opacity:0.6,update:function(){ul.find("> li.bogus").remove();
makeBogus(ul)}});var onList=this.optionsList;var offList=$("ul.display-fields-list.off-list",this.wrapper);
onList.find(":checkbox").on("click",function(){var check=$(this);var li=$(this).closest("li");if(check.attr("checked")){li.detach().removeClass("off").appendTo(onList);
if(!offList.find("> li").length){offList.hide()}}else{li.detach().addClass("off").prependTo(offList);
offList.show()}ul.find("> li.bogus").remove();makeBogus(ul)}).not(":checked").each(function(){$(this).closest("li").detach().addClass("off").appendTo(offList)
});if(!offList.find("> li").length){offList.hide()}this.wrapper.detach().appendTo("body");this.wrapper.css("z-index","10101");
this.wrapper.on("click",function(ev){ev.stopPropagation()});this.backdropEl=$('<div class="backdrop dp-overlay-backdrop" />');
this.backdropEl.css("z-index","10100").hide().appendTo("body");this.backdropEl.on("click",(function(ev){ev.stopPropagation();
this.close()}).bind(this));$("header .close-trigger",this.wrapper).on("click",(function(ev){ev.stopPropagation();
ev.preventDefault();this.close()}).bind(this));$(".save-trigger",this.wrapper).on("click",(function(){this.saveDisplayOptions()
}).bind(this))},getDisplayFields:function(){var fields=[];$(":checkbox:checked",this.getWrapperElement()).each(function(){fields.push($(this).attr("name"))
});return fields},saveDisplayOptions:function(){this.wrapper.addClass("loading");this.saveAndRefresh()
},saveAndRefresh:function(){var self=this;var wrap=this.getWrapperElement();var data=[];var pref_name="prefs[agent.ui."+this.options.prefId+"-display-fields."+this.options.prefSaveResultId+"][]";
var has=false;$('input[type="checkbox"]:checked',wrap).each(function(){has=true;data.push({name:pref_name,value:$(this).attr("name")})
});if(!has){data.push({name:pref_name,value:"NONE"})}data.push({name:"prefs[agent.ui."+this.options.prefId+"-order-by."+this.options.prefSaveResultId+"]",value:$('select[name="order_by"]',wrap).val()});
var url=this.options.refreshUrl;if(this.options.isListView){var page=this.page;$.ajax({timeout:20000,type:"POST",url:BASE_URL+"agent/misc/ajax-save-prefs",data:data,context:this,complete:function(){this.close()
},success:function(){page.meta.pageReloader()}})}else{$.ajax({timeout:20000,type:"POST",url:BASE_URL+"agent/misc/ajax-save-prefs",data:data,context:this,complete:function(){this.close()
},success:function(){DeskPRO_Window.loadListPane(url)}})}},open:function(){this._initOverlay();this.updatePositions();
this.wrapper.addClass("open");this.backdropEl.show();this.wrapper.addClass("open");this.fireEvent("opened",[this])
},isOpen:function(){if(!this._hasInit||!this.wrapper.is(".open")){return false}return true},close:function(){if(!this._hasInit||!this.isOpen()){return
}this.wrapper.removeClass("open");this.backdropEl.hide();this.fireEvent("closed",[this])},updatePositions:function(){var elW=this.wrapper.width();
var elH=this.wrapper.height();var pageW=$(window).width();var pageH=$(window).height();this.wrapper.css({top:55,left:(pageW-elW)/2})
},getWrapperElement:function(){if(this._hasInit){return this.wrapper}else{return $(".display-options:first",this.page.wrapper)
}},destroy:function(){if(this._hasInit){this.wrapper.remove();this.backdropEl.remove()}delete this.wrapper;
delete this.backdropEl;delete this.options;delete this.page}});Orb.createNamespace("DeskPRO.Agent.PageHelper");
DeskPRO.Agent.PageHelper.SelectionBar=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(page,options){var self=this;
this.page=page;this.options={selectionBar:null,selectedCount:null,button:null,checkSelector:"input.item-select",saveSelectionId:null};
this.setOptions(options);if(this.options.saveSelectionId){this.options.saveSelectionRealId="dp.agent.selectionbar."+this.options.saveSelectionId
}if(!this.options.selectionBar){this.options.selectionBar=$(".list-selection-bar",this.page.wrapper).first()
}this.selectionBar=$(this.options.selectionBar);if(!this.options.selectedCount){this.options.selectedCount=$(".selected-count:first",this.selectionBar)
}this.selectedCount=$(this.options.selectedCount);if(!this.options.button){this.options.button=$(".perform-actions-trigger:first",this.selectionBar)
}this.button=$(this.options.button);this.button.addClass("disabled");this.button.on("click",this.buttonClicked.bind(this));
this.controlCheck=$(".selection-control",this.page.wrapper).on("click",function(){if($(this).is(":checked")){self.checkAll()
}else{self.checkNone()}});this.lastCheckBox=null;this.page.wrapper.on("click",this.options.checkSelector,function(event){var el=$(this);
self.handleCheckChange(el,el.is(":checked"));if(self.lastCheckBox&&event.shiftKey){self.checkRange(el,self.lastCheckBox)
}self.lastCheckBox=el})},buttonClicked:function(ev){if(this.button.is(".disabled")){return}this.fireEvent("buttonClick",[ev])
},getCheckedValues:function(){var values=[];$(this.options.checkSelector+":checked",this.page.wrapper).each(function(){values.push($(this).val())
});return values},getCheckedFormValues:function(form_name,appendArray,info){appendArray=appendArray||[];
if(!info){info={}}info.checkedCount=0;$(this.options.checkSelector+":checked",this.page.wrapper).each(function(){appendArray.push({name:form_name,value:$(this).val()});
info.checkedCount++});return appendArray},getChecked:function(){return $(this.options.checkSelector+":checked",this.page.wrapper)
},getCount:function(){return $(this.options.checkSelector+":checked",this.page.wrapper).length},checkAll:function(){$(this.options.checkSelector,this.page.wrapper).attr("checked",true);
var count=this.updateCount();this.fireEvent("checkAll",[count])},checkRange:function(start,end){var is_checked=start.is(":checked");
var checks=this.page.wrapper.find(this.options.checkSelector);var indexStart=checks.index(start);var indexEnd=checks.index(end);
if(indexStart>indexEnd){var tmp=indexEnd;indexEnd=indexStart;indexStart=tmp}checks=checks.slice(indexStart,indexEnd+1);
checks.prop("checked",is_checked);var count=this.updateCount();this.fireEvent("checkRange",[count])},checkNone:function(){$(this.options.checkSelector,this.page.wrapper).filter(":checked").attr("checked",false);
var count=this.updateCount();this.fireEvent("checkNone")},handleCheckChange:function(el,is_checked){var count=this.updateCount();
this.fireEvent("checkChange",[el,is_checked,count])},restoreFromSessionStorage:function(){if(this.options.saveSelectionRealId&&window.sessionStorage&&window.sessionStorage[this.options.saveSelectionRealId]){var checked=window.sessionStorage[this.options.saveSelectionRealId].split(",");
if(checked.length){$(this.options.checkSelector,this.page.wrapper).each(function(){if(this.value&&checked.contains(this.value)){this.checked=true
}});this.updateCount()}}},updateCount:function(){var oldCount=parseInt(this.selectedCount.text(),10)||0;
var checkedEls=$(this.options.checkSelector,this.page.wrapper).filter(":checked");var count=checkedEls.length;
this.selectedCount.text(count);if(count>0){this.button.removeClass("disabled")}else{this.button.addClass("disabled")
}if(this.options.saveSelectionRealId&&window.sessionStorage){var checked=[];if(count){checkedEls.each(function(){if(this.value){checked.push(this.value)
}})}sessionStorage[this.options.saveSelectionRealId]=checked.join(",")}if(!checkedEls.length||count==0){this.controlCheck.attr("checked",false)
}else{this.controlCheck.attr("checked",true)}if(oldCount!=count){this.fireEvent("countChange",[count,oldCount])
}return count},resetCountLabel:function(){return this.updateCount()}});Orb.createNamespace("DeskPRO.Agent.PageHelper");
DeskPRO.Agent.PageHelper.Popover_Instances={};DeskPRO.Agent.PageHelper.Popover=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(options){this.options={loadTimeout:0,pageUrl:"",pageCallback:null,tabRoute:false,destroyOnClose:true,overFrom:"#dp_content",positionMode:"side",sidePosition:"top"};
DeskPRO.Agent.PageHelper.Popover_Instances[this.OBJ_ID]=this;this.setOptions(options);this.pageSource=null;
if(this.options.pageSource){this.pageSource=this.options.pageSource;delete this.options.pageSource}this.page=null;
this.isWaiting=false;this.popover=null;this.popoverOuter=null;if(this.options.loadTimeout){this.autoloadTimeout=window.setTimeout(this._loadPage.bind(this),this.options.loadTimeout)
}this.formString=""},_loadPage:function(){if(this.isDestroyed){return}if(this.options.pageCallback){return this.options.pageCallback(this.setHtml.bind(this))
}if(!this.options.pageUrl){return}if(this._isLoading){return}this._isLoading=true;if(this.autoloadTimeout){window.clearTimeout(this.autoloadTimeout);
this.autoloadTimeout=null}this.loadingAjax=$.ajax({dataType:"text",url:this.options.pageUrl,type:"GET",context:this,cache:false,complete:function(){this.loadingAjax=null;
delete this.loadingAjax},success:function(html){this._isLoading=false;this.setHtml(html)}})},setHtml:function(html){this.pageSource=html;
if(this.isWaiting){this.isWaiting=false;this._initFragment();this.open()}},_initPopover:function(){var self=this;
if(this._hasInit){return}this._hasInit=true;this.popoverOuter=$($("#popover_tpl").get(0).innerHTML);this.popover=$(".popover-inner",this.popoverOuter).first();
this.popoverOuter.detach().appendTo("body");DeskPRO_Window.initInterfaceLayerEvents(this.popoverOuter);
this.popoverOuter.on("click",function(ev){ev.stopPropagation()});this.updatePositions();$(".close",this.popoverOuter).first().on("click",(function(ev){ev.preventDefault();
ev.stopPropagation();this.isWaiting=false;var ev={pop:this,cancel:false};this.fireEvent("closeTabClick",ev);
if(ev.cancel){return}this.close()}).bind(this));if(this.options.tabRoute){$(".move-to-tab:first",this.popoverOuter).on("click",(function(ev){ev.preventDefault();
ev.stopPropagation();var doXfer=function(){this.isWaiting=false;DeskPRO_Window.runPageRoute(self.options.tabRoute);
self.close(true)};if(self.hasFormsChanged()){DeskPRO_Window.showConfirm("This will re-load a new form in the tabbed area to the right. You will lose all unsaved changes. Do you want to continue?",function(){doXfer()
})}else{doXfer()}}).bind(this))}else{$(".move-to-tab:first",this.popoverOuter).remove()}if(this.options.positionMode=="side"){DeskPRO_Window.layout.addEvent("resized",this.updatePositions,this)
}},_initFragment:function(){if(this.page){return}if(!this.pageSource){return}if(!this.popover){return
}var self=this;this.page=DeskPRO_Window.createPageFragment(this.pageSource);this.page.addEvent("updateUi",this.updatePositions.bind(this));
var preparedOutput=DeskPRO_Window.prepareWidgetedHtml(this.page.getHtml());this.popover.html(preparedOutput.html);
DeskPRO_Window.runWidgetedJs(this.page,preparedOutput.jsSource,preparedOutput.jsInline);this.pageSource=null;
if(this.page.meta.title){$("h1.tab-title",this.popoverOuter).text(this.page.meta.title)}this.page.meta.isPopover=true;
this.page.meta.popover=this;this.page.fireEvent("render",[this.popover]);this.fireEvent("pageInit",[this,this.page]);
var foot=$("footer.pop-footer",this.popover);if(foot.length){foot.detach().appendTo($("> section",this.popoverOuter))
}var data=self.popover.find("input, select, textarea").serializeArray();self.formString=JSON.stringify(data);
this.updatePositions()},hasFormsChanged:function(do_resave){var data=this.popover.find("input, select, textarea").serializeArray();
var newFormString=JSON.stringify(data);var ret=false;if(this.formString!=newFormString){ret=true}if(do_resave){this.formString=newFormString
}return ret},updatePositions:function(){if(this.isDestroyed){return}var changeVis=false;if(!this.popoverOuter.is(":visible")){changeVis=true;
this.popoverOuter.css({"visibility":"hidden","display":"block"})}var pos=$(this.options.overFrom).offset();
var top=pos.top-4;var width=pos.left-9;var bottom=10;var height="";var contentH=false;var hasHeader=!!($("> section > header",this.popoverOuter).length);
var hasFooter=!!($("> section > footer",this.popoverOuter).length);var scrollContentHeight=false;$(".scroll-content",this.popoverOuter).each(function(){var $this=$(this);
var height=$this.height();if($this.data("extra-height")){height+=parseInt($this.data("extra-height"),10)
}if(scrollContentHeight===false||height>scrollContentHeight){scrollContentHeight=height}});if(scrollContentHeight!==false){contentH=scrollContentHeight;
if(hasHeader){contentH+=36}if(hasFooter){contentH+=45}contentH+=31}if(hasHeader){$("> section > article",this.popoverOuter).removeClass("no-header")
}else{$("> section > article",this.popoverOuter).addClass("no-header")}if(hasFooter){$("> section > article",this.popoverOuter).removeClass("no-footer")
}else{$("> section > article",this.popoverOuter).addClass("no-footer")}if(contentH<350){contentH=350}var maxH=$(window).height()-top-10;
if(contentH&&contentH<maxH){bottom="";height=contentH}if(this.options.positionMode=="side"){if(DeskPRO_Window.paneVis.source&&DeskPRO_Window.paneVis.list){if(this.options.sidePosition=="bottom"){if(!bottom){top="";
bottom=10}}this.popoverOuter.css({"position":"absolute","z-index":30001,"width":width+2+6,"overflow":"auto","top":top?top-3:"","left":9,"bottom":bottom,"height":height})
}else{width=$(window).width()/2;this.popoverOuter.css({"position":"absolute","z-index":30001,"width":width+2+6,"overflow":"auto","top":top?top-3:"","left":9,"bottom":10,"height":height})
}}else{this.popoverOuter.css({"position":"absolute","z-index":30001,"overflow":"auto",top:pos.top-4,left:pos.left+8,right:3,"bottom":bottom,"height":height})
}if(changeVis){this.popoverOuter.css({"display":"none","visibility":"visible"})}},isOpen:function(){if(this.isDestroyed||!this._hasInit){return false
}if(this.popover&&this._isOpen){return true}return false},open:function(){if(this.isDestroyed){return
}this._initPopover();this._initFragment();if(!this.page&&!this.pageSource){this.isWaiting=true;this._loadPage()
}var tabAnchor=$("a.tab-anchor",this.popover);tabAnchor.focus();if(this.isOpen()){if(this.page&&!this.page.IS_ACTIVE){this.page.fireEvent("activate",[this.page]);
this.page.fireEvent("popover-open",[this])}return}Object.each(DeskPRO.Agent.PageHelper.Popover_Instances,function(inst){if(inst.isOpen()&&inst.options.positionMode==this.options.positionMode){inst.close()
}},this);this._isOpen=true;this.popoverOuter.show();var self=this;setTimeout(function(){self.updatePositions()
},1000);if(this.page){this.page.fireEvent("activate",[this.page]);this.page.fireEvent("popover-open",[this])
}},toggle:function(){if(this.isOpen()){this.close()}else{this.open()}},close:function(ignoreForms){if(this.isDestroyed){return
}if(!this.isOpen()){return}if(!ignoreForms&&this.hasFormsChanged()&&this.page&&!this.page.noIgnoreForm){var self=this;
DeskPRO_Window.showConfirm("Are you sure you want to close the form? Your changes will be lost.",function(){self.close(true)
});return}this._isOpen=false;this.formString="";var ev={pop:this,cancel:false};this.fireEvent("close",ev);
if(ev.cancel){return}this.popoverOuter.hide();if(this.options.destroyOnClose&&this.hasFormsChanged()){if(this.page){this.page.closeSelf()
}}else{if(this.page){this.page.fireEvent("deactivate")}if(this.page){this.page.fireEvent("popover-closed")
}}},destroy:function(){if(this.isDestroyed){return}this.isDestroyed=true;if(this.page){this.page.fireEvent("destroy");
this.page=null}if(this.popover){this.popoverOuter.remove();this.popover.remove()}if(this.autoloadTimeout){window.clearTimeout(this.autoloadTimeout);
this.autoloadTimeout=null}if(this.loadingAjax){this.loadingAjax.abort();this.loadingAjax=null}this.popoverOuter=null;
this.popover=null;this.options=null;delete DeskPRO.Agent.PageHelper.Popover_Instances[this.OBJ_ID];this.fireEvent("destroy",[this])
}});Orb.createNamespace("DeskPRO.Agent.PageHelper");DeskPRO.Agent.PageHelper.FragmentOverlay=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(options){this.options={routeData:{},positionAbove:true,zIndex:0};
this.setOptions(options);this.page=null;this._initOverlay();this.reloadFragment()},reloadFragment:function(){var routeData=this.options.routeData;
if(this.loadingXhr){this.loadingXhr.abort();this.loadingXhr=null}this.loadingXhr=DeskPRO_Window._doAjaxLoadRoute(routeData.url,routeData,(function(data){if(this.page){this.page.fireEvent("destroy");
this.page=null;this.wrapper.empty()}this.page=DeskPRO_Window.createPageFragment(data);this.page.setMetaData("routeUrl",routeData.url);
if(routeData){this.page.setMetaData("routeData",routeData)}this.page.fragmentOverlay=this;this.wrapper.removeClass("overlay-loading");
$("section.dp-overlay",this.wrapper).empty().html(data);$("header .close-trigger",this.wrapper).on("click",(function(ev){ev.stopPropagation();
ev.preventDefault();this.close()}).bind(this));this.updatePositions();this.page.fireEvent("render",[this.wrapper]);
this.fireEvent("pageInit",[this.page,this])}).bind(this))},_initOverlay:function(){if(this._hasInit){return
}this._hasInit=true;this.wrapper=$(DeskPRO_Window.util.getPlainTpl($("#fragment_overlay_tpl")));this.wrapper.hide().appendTo("body");
this.wrapper.on("click",function(ev){ev.stopPropagation()});this.backdropEl=$('<div class="backdrop dp-overlay-backdrop dp-fragment-overlay-backdrop" />');
this.backdropEl.hide().appendTo("body");this.backdropEl.on("click",(function(ev){ev.stopPropagation();
this.close()}).bind(this));$("header .close-trigger",this.wrapper).on("click",(function(ev){ev.stopPropagation();
ev.preventDefault();this.close()}).bind(this));this.updatePositions();this.wrapper.show();this.backdropEl.show()
},updatePositions:function(){var article=$("section.dp-overlay > article",this.wrapper);var w=parseInt(article.data("width"));
var h=parseInt(article.data("height"));if(w){this.wrapper.css("width",w+5)}if(h){this.wrapper.css("height",h+5)
}if(article.data("add-class")){this.wrapper.addClass(article.data("add-class"))}var w=this.wrapper.outerWidth();
var pageW=$(window).width();var leftForCenter=(pageW-w)/2;var h=this.wrapper.outerHeight();var pageH=$(window).height();
var topForCenter=(pageH-h)/2;this.wrapper.css({"top":topForCenter,"left":leftForCenter});if(this.options.zIndex){this.wrapper.css("z-index",this.options.zIndex+1);
this.backdropEl.css("z-index",this.options.zIndex)}else{if(this.options.positionAbove){var zIndex=Orb.findHighestZindex()+10;
this.wrapper.css("z-index",zIndex+1);this.backdropEl.css("z-index",zIndex)}}if($("section > header",this.wrapper).length){this.wrapper.removeClass("no-header")
}else{this.wrapper.addClass("no-header")}if($("section > footer",this.wrapper).length){this.wrapper.removeClass("no-footer")
}else{this.wrapper.addClass("no-footer")}},close:function(){this.destroy()},destroy:function(){if(this.loadingXhr){this.loadingXhr.abort();
this.loadingXhr=null}if(this.page){this.page.fireEvent("destroy");this.page=null}if(this.wrapper){this.wrapper.remove();
this.backdropEl.remove()}this.wrapper=null;this.backdropEl=null;this.fireEvent("destroy",[this])}});Orb.createNamespace("DeskPRO.Agent.PageHelper");
DeskPRO.Agent.PageHelper.ValidatingEdit=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(page,options){var self=this;
this.page=page;this.options={typename:"",contentId:0,singleType:""};this.setOptions(options);$("button.approve-trigger",this.page.wrapper).on("click",this.approveEdit.bind(this));
$("button.disapprove-trigger",this.page.wrapper).on("click",this.showDisapproveForm.bind(this));$("button.disapprove2-trigger",this.page.wrapper).on("click",this.disapproveEdit.bind(this));
$("button.skip-trigger",this.page.wrapper).on("click",this.skipValidateEdit.bind(this))},showDisapproveForm:function(){$(".validating-bar:first .options",this.page.wrapper).hide();
$(".validating-bar:first .disapprove-form",this.page.wrapper).show()},approveEdit:function(){$.ajax({url:BASE_URL+"agent/publish/content/approve/"+this.options.typename+"/"+this.options.contentId+".json?specific_type="+this.options.singleType,type:"POST",context:this,dataType:"json",success:function(info){if(info.next_url){DeskPRO_Window.runPageRoute("page:"+info.next_url)
}DeskPRO_Window.getMessageBroker().sendMessage("publish.validating.list-remove",{typename:this.options.typename,contentId:this.options.contentId});
DeskPRO_Window.removePage(this.page);if(DeskPRO_Window.sections.feedback_section){DeskPRO_Window.sections.feedback_section.reload()
}}})},disapproveEdit:function(){var reason=$(".validating-bar .disapprove-reason",this.page.wrapper).val().trim();
$.ajax({url:BASE_URL+"agent/publish/content/disapprove/"+this.options.typename+"/"+this.options.contentId+".json?specific_type="+this.options.singleType,type:"POST",context:this,data:{reason:reason},dataType:"json",success:function(info){if(info.next_url){DeskPRO_Window.runPageRoute("page:"+info.next_url)
}DeskPRO_Window.getMessageBroker().sendMessage("publish.validating.list-remove",{typename:this.options.typename,contentId:this.options.contentId});
if(DeskPRO_Window.sections.feedback_section){DeskPRO_Window.sections.feedback_section.reload()}DeskPRO_Window.removePage(this.page)
}})},skipValidateEdit:function(){$.ajax({url:BASE_URL+"agent/publish/content/get-next-validating/"+this.options.typename+"/"+this.options.contentId+".json?specific_type="+this.options.singleType,type:"POST",context:this,dataType:"json",success:function(info){if(info.next_url){DeskPRO_Window.runPageRoute("page:"+info.next_url)
}DeskPRO_Window.getMessageBroker().sendMessage("publish.validating.list-remove",{typename:this.options.typename,contentId:this.options.contentId});
DeskPRO_Window.removePage(this.page)}})}});Orb.createNamespace("DeskPRO.Agent.PageHelper");DeskPRO.Agent.PageHelper.RelatedContent=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(page,options){var self=this;
this.page=page;this.options={typename:"",content_id:0,listEl:null,newItemTpl:"#related_content_newitem",disabled:false};
this.setOptions(options);this.listEl=$(this.options.listEl);this.listEl.on("click",".remove",function(ev){ev.stopPropagation();
ev.preventDefault();var li=$(this);var x=0;while(!li.is(".related-content")){if(x++>15){return}li=li.parent()
}self.removeLinkByElement(li)});this.page.getEl("count_related").text(this.listEl.find("li.related-content").length)
},isViewing:function(){var tab=this.page.bodyTabs.lastActiveTabContent;if(tab&&tab.is(".related-content")){return true
}return false},_refreshInstructionEl:function(){if($(".related-content:not(.removing):first",this.listEl).length){$(".no-related-content",this.listEl).hide()
}else{$(".related-section",this.listEl).hide();$(".no-related-content",this.listEl).show()}this.page.getEl("count_related").text(this.listEl.find("li.related-content:not(.removing)").length)
},setActiveRelatedListController:function(controller){this.relatedContentList=controller},addLink:function(typename,content_id,title,route){if(this.isLinked(typename,content_id)){return
}var li=$(DeskPRO_Window.util.getPlainTpl(this.options.newItemTpl));$(".link-title",li).text(title);$(".link-route",li).data("route",route);
li.addClass("related-content").addClass(typename+"-"+content_id);li.data("content-type",typename);li.data("content-id",content_id);
li.hide();var wrapper=$("."+typename+".related-section",this.listEl);if(wrapper.length){var list=$(".related-list:first",wrapper);
list.append(li);if(!wrapper.is(":visible")){li.show();wrapper.slideDown("fast")}else{li.slideDown("fast")
}}else{if(!this.listEl.is(":visible")){li.show();this.listEl.append(li).slideDown("fast")}else{this.listEl.append(li);
li.slideDown("fast")}}if(this.relatedContentList){this.relatedContentList.elementIsLinked(typename,content_id)
}this._refreshInstructionEl();this.fireEvent("contentLinked",[typename,content_id,title,route,this])},addLinkByElement:function(el){var typename=el.data("content-type");
var content_id=el.data("content-id");if(el.data("route")){var route=el.data("route");var title=el.text().trim()
}else{var routeEl=$("[data-route]:first",el);var route=routeEl.data("route");var title=routeEl.text().trim()
}if(el.data("route-title")){title=el.data("route-title");if(title=="@text"){title=el.text().trim().replace(/[\n\r]/g," ").replace(/\s+/g," ")
}else{if(title=="@title"){title=el.attr("title")}else{if(title.test(/^@selector\((.*?)\)$/)){var sel=title.match(/^@selector\((.*?)\)$/)[1];
var titleEl=null;if(sel[0]=="#"){titleEl=$(sel)}else{titleEl=$(sel,el)}if(titleEl&&titleEl.length){title=titleEl.text().trim().replace(/[\n\r]/g," ").replace(/\s+/g," ")
}else{title=el.text().trim()}}}}}return this.addLink(typename,content_id,title,route)},removeLinkByElement:function(el){var typename=el.data("content-type");
var content_id=el.data("content-id");if(!typename||!content_id){DP.console.error("No content linked on element: %o",el);
return false}this.removeLink(typename,content_id);return true},removeLink:function(typename,content_id){var listItem=this.getLinkElementInList(typename,content_id);
if(!listItem){return}listItem.addClass("removing").slideUp("fast",function(){listItem.remove();var wrapper=$("."+typename+".related-section",this.listEl);
if(wrapper.length){if(!$(".related-content:first",wrapper).length){wrapper.slideUp("fast")}}});if(this.relatedContentList){this.relatedContentList.elementIsUnlinked(typename,content_id)
}this._refreshInstructionEl();this.fireEvent("contentUnlinked",[typename,content_id,this])},getLinkElementInList:function(typename,content_id){var el=$("."+typename+"-"+content_id+".related-content:first",this.listEl);
if(!el.length){return null}return el},isLinked:function(typename,content_id){return $("."+typename+"-"+content_id+".related-content:first",this.listEl).length
},isLinkable:function(typename,content_id){if(this.options.disabled){return false}if(typename==this.options.typename&&content_id==this.options.content_id){return false
}var ev={linkable:true};this.fireEvent("checkLinkable",[ev,typename,content_id,this]);if(ev.linkable){return true
}else{return false}},elementIsLinkable:function(el){if(this.options.disabled){return false}return this.isLinkable(el.data("content-type"),el.data("content-id"))
},elementIsLinked:function(el){return this.isLinked(el.data("content-type"),el.data("content-id"))}});
Orb.createNamespace("DeskPRO.Agent.PageHelper");DeskPRO.Agent.PageHelper.RelatedContentList=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(page,options){var self=this;
this.page=page;this.options={contentListEl:null};this.setOptions(options);this.contentListEl=$(this.options.contentListEl);
DeskPRO_Window.getTabWatcher().addTabTypeWatcher("*",this);var types=["article","download","news","feedback"];
this.addEvent("watchedTabActivated",function(tab){$(".related-is-linkable",this.contentListEl).each(function(){var el=$(this);
el.removeClass("related-not-linkable").removeClass("related-is-linked")});if(tab.page&&tab.page.meta.routeData&&tab.page.meta.routeData.routeTriggerEl){var row=$(tab.page.meta.routeData.routeTriggerEl);
if(row.hasClass("row-item")){row.addClass("related-not-linkable").removeClass("related-is-linked")}}var tabtype=DeskPRO_Window.getTabWatcher().getTabType(tab);
if(types.indexOf(tabtype)!==-1){if(tab.page&&tab.page.relatedContent){if(tab.page.relatedContent.isViewing()){$("body").addClass("related-controls-on")
}else{$("body").removeClass("related-controls-on")}}else{$("body").removeClass("related-controls-on")
}this.enableControls(tab)}else{this.disableControls()}},this);this.addEvent("watchedTabDeactivated",function(tab,isLast){if(isLast){this.disableControls();
$("body").removeClass("related-controls-on")}},this);var selectedTabType=DeskPRO_Window.getTabWatcher().getActiveTabType();
if(types.indexOf(selectedTabType)!==-1){this.enableControls(DeskPRO_Window.getTabWatcher().getActiveTab())
}var findLinkable=function(el){var x=0;while(!el.is(".related-is-linkable")){if(x++>15){return null}el=el.parent()
}return el};this.contentListEl.on("click",".related-link",function(ev){ev.stopPropagation();ev.preventDefault();
var el=findLinkable($(this));if(!el){return}self.fireEvent("relatedLinkClick",[el,$(this),this]);var tab=DeskPRO_Window.getTabWatcher().getActiveTab();
if(!tab||!tab.page||!tab.page.relatedContent){return}tab.page.relatedContent.addLinkByElement(el)});this.contentListEl.on("click",".related-unlink",function(ev){ev.stopPropagation();
ev.preventDefault();var el=findLinkable($(this));if(!el){return}self.fireEvent("relatedUnlinkClick",[el,$(this),this]);
var tab=DeskPRO_Window.getTabWatcher().getActiveTab();if(!tab||!tab.page||!tab.page.relatedContent){return
}tab.page.relatedContent.removeLinkByElement(el)})},enableControls:function(tab){var page=tab.page;if(!page.relatedContent){return
}this.activePage=page;page.relatedContent.setActiveRelatedListController(this);var self=this;$(".related-is-linkable",this.contentListEl).each(function(){var el=$(this);
el.removeClass("related-not-linkable").removeClass("related-is-linked");if(page.relatedContent.elementIsLinkable(el)){if(page.relatedContent.elementIsLinked(el)){el.addClass("related-is-linked")
}}else{el.addClass("related-not-linkable")}});this.contentListEl.addClass("with-related-content-controls");
this.fireEvent("relatedControlsActivated",[this.contentListEl,this])},disableControls:function(){this.activePage=null;
this.contentListEl.removeClass("with-related-content-controls");this.fireEvent("relatedControlsDeactivated",[this.contentListEl,this])
},elementIsLinked:function(typename,content_id){$("."+typename+"-"+content_id+".related-is-linkable",this.contentListEl).addClass("related-is-linked")
},elementIsUnlinked:function(typename,content_id){$("."+typename+"-"+content_id+".related-is-linkable",this.contentListEl).removeClass("related-is-linked")
},destroy:function(){if(this.activePage){this.activePage.relatedContent.setActiveRelatedListController(null)
}}});Orb.createNamespace("DeskPRO.Agent.PageHelper");DeskPRO.Agent.PageHelper.Comments=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(page,options){var self=this;
this.page=page;this.options={commentsWrapper:null};this.setOptions(options);this.commentsWrapper=$(this.options.commentsWrapper);
this.commentsWrapper.on("click",".comment-edit-btn",function(ev){ev.stopPropagation();ev.preventDefault();
self.getCommentMenu().open(ev)});this.commentsWrapper.on("click",".comment-validate-btn",function(ev){ev.stopPropagation();
ev.preventDefault();self.getCommentValidationMenu().open(ev)})},getCommentMenu:function(){if(this._commentMenu){return this._commentMenu
}var clone=$("#comment_tools_menu").first().clone(false);clone.attr("id",Orb.getUniqueId("el"));var self=this;
this._commentMenu=new DeskPRO.UI.Menu({menuElement:clone,onItemClicked:function(info){var commentEl=$(info.menu.getOpenTriggerElement()).parent().parent().parent();
var action=$(info.itemEl).data("action");switch(action){case"edit":self.editComment(commentEl,commentEl.data("content-type"),commentEl.data("comment-id"));
break;case"delete":self.deleteComment(commentEl,commentEl.data("content-type"),commentEl.data("comment-id"));
break;case"create-ticket":$.ajax({url:BASE_URL+"agent/publish/comments/new-ticket-info/"+commentEl.data("content-type")+"/"+commentEl.data("comment-id")+".json",type:"GET",dataType:"json",success:function(data){DeskPRO_Window.newTicketLoader.open(function(page){page.setNewByComment(data)
})}});break}}});return this._commentMenu},getCommentValidationMenu:function(){if(this._commentValidationMenu){return this._commentValidationMenu
}var clone=$("#comment_validation_menu").first().clone(false);clone.attr("id",Orb.getUniqueId("el"));
var self=this;this._commentValidationMenu=new DeskPRO.UI.Menu({menuElement:clone,onItemClicked:function(info){var commentEl=$(info.menu.getOpenTriggerElement()).closest("article.content-message");
var action=$(info.itemEl).data("action");switch(action){case"approve":self.approveComment(commentEl,commentEl.data("content-type"),commentEl.data("comment-id"));
break;case"delete":self.deleteComment(commentEl,commentEl.data("content-type"),commentEl.data("comment-id"));
break}}});return this._commentValidationMenu},editComment:function(commentEl,typename,commentId){commentEl.addClass("gear-loading");
var self=this;$.ajax({url:BASE_URL+"agent/publish/comments/info/"+typename+"/"+commentId,type:"GET",dataType:"json",context:this,success:function(data){var editEl=$(DeskPRO_Window.util.getPlainTpl("#comment_edit_tpl"));
$(".save-trigger",editEl).on("click",function(ev){ev.preventDefault();self._saveEditComment(commentEl,editEl,typename,commentId)
});$(".cancel-trigger",editEl).on("click",function(ev){ev.preventDefault();self._closeEditComment(commentEl,editEl)
});editEl.hide();$("textarea.comment",editEl).val(data.comment_text);var rendered=$(".rendered-message",commentEl);
editEl.insertBefore(rendered);rendered.slideUp("fast",function(){editEl.slideDown("fast")})},complete:function(){commentEl.removeClass("gear-loading")
}})},_saveEditComment:function(commentEl,editEl,typename,commentId){commentEl.addClass("gear-loading");
$.ajax({url:BASE_URL+"agent/publish/comments/save-comment/"+typename+"/"+commentId,type:"POST",data:{comment:$("textarea.comment",editEl).val()},dataType:"json",context:this,error:function(){},success:function(data){var rendered=$(".rendered-message",commentEl);
rendered.html(data.comment_html);this._closeEditComment(commentEl,editEl)},complete:function(){commentEl.removeClass("gear-loading")
}})},_closeEditComment:function(commentEl,editEl){var rendered=$(".rendered-message",commentEl);editEl.slideUp("fast",function(){rendered.slideDown();
editEl.remove()})},deleteComment:function(commentEl,typename,commentId){commentEl.fadeOut();$.ajax({url:BASE_URL+"agent/publish/comments/delete/"+typename+"/"+commentId,type:"POST",context:this,dataType:"json",error:function(){commentEl.show()
},success:function(data){commentEl.remove();if(DeskPRO_Window.sections.publish_section){DeskPRO_Window.sections.publish_section.modCommentCount(commentEl.data("content-type"),"-")
}}})},approveComment:function(commentEl,typename,commentId){commentEl.removeClass("validating").addClass("gear-loading");
$.ajax({url:BASE_URL+"agent/publish/comments/approve/"+typename+"/"+commentId,type:"POST",context:this,dataType:"json",success:function(){commentEl.find(".comment-validate-btn").hide()
},error:function(){commentEl.addClass("validating")},complete:function(){commentEl.removeClass("gear-loading")
}})}});Orb.createNamespace("DeskPRO.Agent.PageHelper");DeskPRO.Agent.PageHelper.MiscContent=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(page,options){var self=this;
this.page=page;this.options={revisionCompareUrl:""};this.setOptions(options);this.wrapper=this.page.wrapper;
this.getEl=this.page.getEl;this._initCompareRevs()},_initCompareRevs:function(){$(".compare-trigger",this.wrapper).on("click",this.showCompareRev.bind(this));
var all_checks=$("input.rev-compare-check",this.wrapper);var counter=0;var table=this.wrapper.find(".revision-compare-table");
table.on("click","input.rev-compare-check",function(){if($(this).is(":checked")){var checked=all_checks.filter(":checked");
if(checked.length>2){checked.each(function(){if($(this).data("check-count")==counter){$(this).prop("checked",false)
}})}$(this).data("check-count",++counter)}});var count=table.find("input.rev-compare-check").length;this.page.getEl("count_revs").text(count)
},showCompareRev:function(){var checks=$(".revision-compare-table input.rev-compare-check:checked",this.wrapper);
var old_id=checks.first().val();var new_id=checks.last().val();if(!old_id||!new_id||old_id==new_id){console.log("bad compare");
return}var overlay=new DeskPRO.UI.Overlay({triggerElement:$("button.compare-trigger",this.wrapper),contentMethod:"ajax",contentAjax:{url:this.options.revisionCompareUrl.replace("{OLD}",old_id).replace("{NEW}",new_id)},destroyOnClose:true});
overlay.openOverlay()}});Orb.createNamespace("DeskPRO.Agent.PageHelper");DeskPRO.Agent.PageHelper.ListNav=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(page,options){options=options||{};
this.page=page;this.listSelector=options.listSelector||false;this.itemSelector=options.itemSelector||"article.row-item";
this.activeClass="selection-on";this.scrollContainer=this.page.wrapper.find(".scroll-content").first();
this.scrollView=this.page.wrapper.find(".scroll-viewport").first()},getCurrentSelection:function(){var list=this.listSelector?this.page.wrapper.find(this.listSelector):this.page.wrapper;
var el=list.find(this.itemSelector).filter("."+this.activeClass);if(el[0]){return el}return null},scrollIntoView:function(row){if(!row||!row.position()){return
}if(this.scrollContainer.height()<=this.scrollView.height()){return}var viewTop=Math.abs(parseInt(this.scrollContainer.css("top")));
var viewBtm=viewTop+this.scrollContainer.parent().height();var elTop=row.position().top;var elBtm=elTop+row.height()+row.height()+20;
if(viewTop<elTop&&viewBtm>elBtm){return}var scrollTo=elBtm-this.scrollContainer.parent().height();if(scrollTo<0){scrollTo=0
}var scroll=this.page.wrapper.find(".with-scrollbar").first();scroll.trigger("goscrollto",[scrollTo])
},down:function(){var list=this.listSelector?this.page.wrapper.find(this.listSelector):this.page.wrapper;
var current=this.getCurrentSelection();var next;if(current){next=current.next(this.itemSelector);if(!next||!next.closest(list[0])[0]){next=current
}current.removeClass(this.activeClass)}else{next=list.find(this.itemSelector).first()}next.addClass(this.activeClass);
this.scrollIntoView(next);return next},up:function(){var list=this.listSelector?this.page.wrapper.find(this.listSelector):this.page.wrapper;
var current=this.getCurrentSelection();var next;if(current){next=current.prev(this.itemSelector);if(!next||!next.closest(list[0])[0]){next=current
}current.removeClass(this.activeClass)}else{next=list.find(this.itemSelector).first()}next.addClass(this.activeClass);
this.scrollIntoView(next);return next},enter:function(){var current=this.getCurrentSelection();if(current){DeskPRO_Window.runPageRouteFromElement(current)
}},check:function(){var current=this.getCurrentSelection();if(current){var check=current.find("input.item-select");
if(check.prop("checked")){check.prop("checked",false)}else{check.prop("checked",true)}}}});Orb.createNamespace("DeskPRO.Agent.PageHelper");
DeskPRO.Agent.PageHelper.AutoSave=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(options){var self=this;
this.options={field:null,fieldName:null,saveUrl:null,postData:[],showSavePuff:true};this.setOptions(options);
this.field=$(this.options.field);if(this.field.is("select, :checkbox, :radio")){this.field.on("change",this.save.bind(this))
}else{this.intervalCaller=new DeskPRO.IntervalCaller({resetTimeForce:2500,timeout:1500,callback:this.save.bind(this)});
var touchFn=function(){self.fireEvent("touch",[self.field,self]);if(self.intervalCaller){self.intervalCaller.touch()
}};this.field.on("change",touchFn).on("keypress",touchFn)}},save:function(){var self=this;var postData=Array.clone(this.options.postData);
var fieldName=this.options.fieldName||this.field.attr("name");var fieldVal=this.field.val();postData.push({name:fieldName,value:fieldVal});
self.fireEvent("preSave",[postData,self.field,self]);$.ajax({url:this.options.url,type:"POST",data:postData,success:function(data){self.fireEvent("save",[data,postData,self.field,self]);
if(self.options.showSavePuff){DeskPRO_Window.util.showSavePuff(self.field)}}})},destroy:function(){this.intervalCaller.destroy();
this.field=null;this.options=null}});Orb.createNamespace("DeskPRO.Agent.PageHelper");DeskPRO.Agent.PageHelper.StateSaver=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(options){var self=this;
this.options={stateId:"",expireTime:"+7 days",time:1000,alwaysChanged:false,listenOn:null,callback:null};
this.setOptions(options);if(this.options.listenOn){var wrap=$(this.options.listenOn);$(":input, textarea, select",wrap).on("change",function(){self.triggerChange()
});$("input[type=text], textarea",wrap).on("keypress",function(){self.triggerChange()});if(!this.options.callback){this.options.callback=function(){if(wrap.is("form")){return wrap.serializeArray()
}else{return $(":input, textarea, select",wrap).serializeArray()}}}}if(!this.options.callback){this.options.callback=function(){};
DP.console.error("No callback for state save")}this.doRestartTimer=false;this.hasChanged=false;if(this.alwaysChanged){this.restartTimer()
}},triggerChange:function(){this.hasChanged=true;this.restartTimer()},restartTimer:function(){if(this.ajax){this.doRestartTimer=true
}if(this.timer){window.clearTimeout(this.timer);this.timer=null}this.doRestartTimer=false;this.timer=window.setTimeout(this.saveState.bind(this),this.options.time)
},saveState:function(){var setData=this.options.callback();this.hasChanged=false;this.fireEvent("beforeSaveState",[setData]);
var namePart=function(name){if(name.indexOf("[")===-1){name="["+name+"]"}else{name=name.replace(/^([\w\d]+)\[(.*?)$/,"[$1][$2")
}return name};var data=[];data.push({name:"prefs_expire[agent.ui.state."+this.options.stateId+"]",value:this.options.expireTime});
if(typeOf(setData)=="array"){Array.each(setData,function(x){data.push({name:"prefs[agent.ui.state."+this.options.stateId+"]"+namePart(x.name),value:x.value})
},this)}else{data.push({name:"prefs[agent.ui.state."+this.options.stateId+"]",value:text})}$.ajax({url:BASE_URL+"agent/misc/ajax-save-prefs",type:"POST",data:data,context:this,complete:function(){this.ajax=null;
if(this.doRestartTimer||this.alwaysChanged){this.restartTimer()}}})},resetState:function(){var data=[];
data.push({name:"prefs[agent.ui.state."+this.options.stateId+"]",value:""});data.push({name:"prefs_expire[agent.ui.state."+this.options.stateId+"]",value:""});
window.setTimeout(function(){$.ajax({url:BASE_URL+"agent/misc/ajax-save-prefs",type:"POST",data:data,context:this})
},150)},stop:function(){if(this.ajax){this.ajax.abort()}if(this.timer){window.clearTimeout(this.timer);
this.timer=null}},destroy:function(){if(this.ajax){this.ajax.abort()}if(this.timer){window.clearTimeout(this.timer);
this.timer=null}}});Orb.createNamespace("DeskPRO.Agent.PageHelper");DeskPRO.Agent.PageHelper.Results=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(page,options){var self=this;
this.page=page;this.wrapper=page.wrapper;this.options={displayOptions:null,resultsContainer:null,navEl:null,showingCountEl:null,resultIds:null,totalCount:0,resultRowSelector:"article.row-item",perPage:50,refreshMode:false,currentPage:1,tabResultCountEls:null,preFetchCallback:null,infiniteScroll:false,infiniteScrollTriggerOffset:800,infiniteScrollLoadFilter:null,infiniteScrollTarget:null};
this.setOptions(options);this.displayOptions=this.options.displayOptions||page.displayOptions;this.resultsContainer=this.options.resultsContainer||$(".list-listing",this.wrapper);
this.navEl=this.options.navEl||$("footer.results-nav",this.wrapper);this.showingCountEl=this.options.showingCountEl||$(".results-showing-count",this.wrapper);
this.totalCountEl=this.options.totalCountEl||$(".results-total-count",this.wrapper);this.tabResultCountEls=this.options.tabResultCountEls||this.wrapper.find(".results-count-display");
this.pageNav=$("ul.pagenav",this.navEl);this.prevBtn=$("> li.prev",this.pageNav);this.nextBtn=$("> li.next",this.pageNav);
this.resultCount=this.options.resultIds?this.options.resultIds.length:this.options.totalCount;this.scrollableEl=this.resultsContainer.closest(".with-scrollbar");
if(this.options.infiniteScroll){this.options.infiniteScroll=this.scrollableEl.length>0}this.resultIds=this.options.resultIds;
delete this.options.resultIds;this.numPages=Math.ceil(this.resultCount/this.options.perPage);this.currentPage=this.options.currentPage;
if(this.currentPage<=1){this.pageNav.addClass("no-prev")}else{this.pageNav.removeClass("no-prev")}if(this.currentPage>=this.numPages){this.pageNav.addClass("no-next")
}else{this.pageNav.removeClass("no-next")}this.updateShowingCount();this.pageNav.on("click",".prev",this.loadPrevPage.bind(this));
this.pageNav.on("click",".next",this.loadNextPage.bind(this));if(this.options.infiniteScroll){this.pageNav.closest(".results-nav").hide();
var onScrollTimer;var self=this;this.scrollableEl.on("dp_scroll.infinite",function(){if(!onScrollTimer){var scrollEl=$(this);
onScrollTimer=setTimeout(function(){onScrollTimer=false;if(self.getCurrentPage()+1>self.getNumPages()){self.scrollableEl.unbind("dp_scroll.infinite");
return}var scrollBottom=(scrollEl.data("dp-scroll-pos")+scrollEl.data("dp-scroll-viewport")),totalHeight=scrollEl.data("dp-scroll-height");
if(totalHeight-scrollBottom<self.options.infiniteScrollTriggerOffset){self.loadNextPage()}},25)}})}},getCurrentPage:function(){return this.currentPage
},getNumPages:function(){return this.numPages},getPageIds:function(pageNum){if(pageNum<1||pageNum>this.numPages){console.warn("Requesting page "+pageNum+" when there are only "+this.numPages);
return[]}return this.resultIds.slice((pageNum-1)*this.options.perPage,pageNum*this.options.perPage)},setResultCount:function(count){if(!this.options){return
}this.resultCount=count;this.numPages=Math.ceil(this.resultCount/this.options.perPage);this.pageNav.removeClass("no-prev no-next");
if(this.currentPage==1){this.pageNav.addClass("no-prev")}else{if(this.currentPage>=this.numPages){this.pageNav.addClass("no-next")
}}this.totalCountEl.text(this.resultCount);this.tabResultCountEls.text(this.resultCount);this.updateShowingCount()
},adjustResultCount:function(adjust){this.setResultCount(this.resultCount+adjust)},loadNextPage:function(){var nextPage=this.getCurrentPage()+1;
if(nextPage>this.getNumPages()){return}return this.loadNewPage(nextPage)},loadPrevPage:function(){var prevPage=this.getCurrentPage()-1;
if(prevPage<1){return}return this.loadNewPage(prevPage)},loadNewPage:function(pageNum){if(this.navEl.is(".loading")){return
}if(this.options.refreshMode){var url=this.page.meta.refreshUrl;url=Orb.appendQueryData(url,"p",pageNum);
DeskPRO_Window.runPageRoute("listpane:"+url);return}if(this.options.infiniteScroll){pageNum=this.getCurrentPage()+1
}var evData={html:null},html=null;this.setPage(pageNum);this.fireEvent("loadResultPage",[evData]);if(evData.html!==null){html=evData.html;
this.setNewResults(html)}else{this.showLoading();var data=[];if(this.resultIds){Array.each(this.getPageIds(pageNum),function(i){data.push({name:"result_ids[]",value:i})
})}else{data.push({name:"page",value:pageNum})}if(this.displayOptions){Array.each(this.displayOptions.getDisplayFields(),function(i){data.push({name:"display_fields[]",value:i})
})}if(this.options.preFetchCallback){data=this.options.preFetchCallback(data)}$.ajax({url:this.page.meta.fetchResultsUrl,data:data,type:"GET",dataType:"html",context:this,complete:function(){this.hideLoading()
},success:function(html){this.setNewResults(html)}})}},setPage:function(pageNum,updateShowing){this.currentPage=pageNum;
this.pageNav.removeClass("no-prev no-next");if(pageNum==1){this.pageNav.addClass("no-prev")}else{if(pageNum==this.numPages){this.pageNav.addClass("no-next")
}}if(updateShowing){this.updateShowingCount()}},setNewResults:function(html){if(!this.options){return
}var results=$(html);DeskPRO_Window.initInterfaceServices(results);if(this.options.infiniteScroll){if(this.options.infiniteScrollLoadFilter){results=this.options.infiniteScrollLoadFilter(results)
}if(this.options.infiniteScrollTarget){this.options.infiniteScrollTarget.append(results)}else{this.resultsContainer.append(results)
}this.scrollableEl.trigger("scrollupdate")}else{this.resultsContainer.empty().html(results);if(this.scrollableEl.length){this.scrollableEl.trigger("goscrolltop")
}}if(this.options.postSetNewResults){this.options.postSetNewResults()}this.updateShowingCount();this.fireEvent("postSetNewResults",[this,this.resultsContainer,results])
},showLoading:function(){if(this.page.meta.viewType=="list"){return}this.navEl.addClass("loading")},hideLoading:function(){this.navEl.removeClass("loading")
},showNoMore:function(){this.navEl.removeClass("loading");this.navEl.addClass("no-more-results")},updateShowingCount:function(){if(!this.options){return false
}var showingCount=$(this.options.resultRowSelector,this.resultsContainer).length||0;var start=((this.currentPage-1)*this.options.perPage);
var end=start+showingCount;start++;if(this.resultIds){if(end>this.resultIds.length){end=this.resultIds.length
}}else{if(end>this.resultCount){end=this.resultCount}}this.showingCountEl.empty().text(start+"-"+end);
this.tabResultCountEls.text(this.resultCount);return showingCount},prependResultId:function(resultId){if(this.resultIds){this.resultIds.unshift(resultId)
}},removeResultId:function(resultId){if(this.resultIds){this.resultIds.erase(resultId)}},destroy:function(){this.options=null;
this.resultPages=null}});Orb.createNamespace("DeskPRO.Agent.PageHelper");DeskPRO.Agent.PageHelper.MassActions=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(page,options){this.page=page;
this.options={viewHandler:null,selectionBar:null,listWrapper:null,fetchPreviewUrl:null,triggerElement:null,templateElement:null,isListView:false,resetOnClose:true,closeOnApply:true,noScroll:false,applyAction:function(){},openAction:function(){}};
this.setOptions(options);this.viewHandler=this.options.viewHandler;this.selectionBar=this.options.selectionBar||page.selectionBar;
this.fetchPreviewUrl=this.options.fetchPreviewUrl||page.meta.fetchResultsUrl;this.listWrapper=this.options.listWrapper;
if(!this.listWrapper){if(this.options.isListView){this.listWrapper=$(".table-result-list table",page.wrapper)
}else{this.listWrapper=$(".list-listing",page.wrapper)}}this.wrapperEl=this.options.templateElement||$("div.mass-actions-overlay-container",page.wrapper);
this.wrapperEl.detach();this.wrapper=this.wrapperEl.clone();this.wrapper.find(".with-handler").removeClass("with-handler");
DeskPRO_Window.initInterfaceLayerEvents(this.wrapper);var scrollEl=$(".with-scrollbar",this.wrapper).first();
if(scrollEl.length&&!this.options.noScroll){this.scrollerHandler=new DeskPRO.Agent.ScrollerHandler(null,scrollEl,{showEvent:"show",hideEvent:"hide"})
}$(".dp-radio-expander-form",this.wrapper).on("click",this.updatePositions.bind(this));this.backdropEls=null;
this.countEl=$(".selected-tickets-count",this.getElement());var trigger=null;if(this.options.triggerElement===null){trigger=$(".perform-actions-trigger",page.wrapper)
}else{if(this.options.triggerElement){trigger=this.options.triggerElement}}if(trigger){trigger.on("click",(function(ev){ev.preventDefault();
ev.stopPropagation();this.open()}).bind(this))}},reset:function(){var wasopen=this.isOpen();this.close();
this.backdropEls.remove();this.wrapper.remove();this.wrapper=this.wrapperEl.clone();this.wrapper.find(".with-handler").removeClass("with-handler");
DeskPRO_Window.initInterfaceLayerEvents(this.wrapper);var scrollEl=$(".with-scrollbar",this.wrapper).first();
scrollEl.removeClass("scroll-draw");if(scrollEl.length&&!this.options.noScroll){this.scrollerHandler=new DeskPRO.Agent.ScrollerHandler(null,scrollEl,{showEvent:"show",hideEvent:"hide"})
}this.countEl=$(".selected-tickets-count",this.wrapper);this.updatePositions();$(".dp-radio-expander-form",this.wrapper).on("click",this.updatePositions.bind(this));
this._hasInit=false;this.hasAnyChange=false;if(wasopen){this.open()}},getElement:function(){return this.wrapper
},_initOverlay:function(){var self=this;if(this._hasInit){return}this._hasInit=true;this.wrapper.detach().appendTo("body");
DeskPRO.ElementHandler_Exec(this.wrapper);this.wrapper.css("z-index","21001");this.baseId=this.wrapper.data("base-id");
this.wrapper.on("click",function(ev){ev.stopPropagation()});if(this.options.isListView){this.backdropEls=$('<div class="backdrop fade" />')
}else{var back1=$('<div class="backdrop mass-actions" />');var back2=$('<div class="backdrop mass-actions" />');
var back3=$('<div class="backdrop mass-actions" />');this.backdropEls=$([back1.get(0),back2.get(0),back3.get(0)])
}this.backdropEls.css("z-index","21000").hide().appendTo("body");this.backdropEls.on("click",(function(ev){ev.stopPropagation();
this.close()}).bind(this));$("header .close-trigger",this.wrapper).first().on("click",(function(ev){ev.stopPropagation();
ev.preventDefault();this.close()}).bind(this));$(".apply-actions",this.wrapper).on("click",(function(ev){this.apply()
}).bind(this));if(!this._hasSelectionEvents){this._hasSelectionEvents=true;this.selectionBar.addEvent("countChange",function(count){if(!this.isOpen()){return
}this.updateCount(count)},this)}},updateAssignmentsDisplay:function(){},getElById:function(id){return $("#"+this.baseId+"_"+id)
},updateCount:function(num){if(num===undefined||num===null){num=this.selectionBar.getCount()}this.countEl.text(num)
},getActionFormValues:function(appendArray,isApply,info){},apply:function(){if(this.options.applyAction){var formDataInfo={checkedCount:0,actionsCount:0},formData=this.selectionBar.getCheckedFormValues("result_ids[]",null,formDataInfo),rows=[];
$(formData).each(function(index,param){rows.push(param.value)});if(formDataInfo.checkedCount){this.options.applyAction(this.wrapper,{"result_ids":rows})
}}if(this.options.closeOnApply){this.close()}},clearPreview:function(){},updatePreview:function(specific_id,force){},updatePreviewDisplay:function(html){},handleCheckChange:function(el,is_checked){},resetForm:function(){},updatePositions:function(){if(!this.isOpen()){return
}var pos=$("#dp_content").offset();var top=pos.top-4;var bottom=10;var height="";var scrollContent=$(".scroll-content",this.wrapper).first();
var contentH=false;var hasHeader=!!($("> section > header",this.wrapper).length);var hasFooter=!!($("> section > footer",this.wrapper).length);
if(scrollContent.length){contentH=scrollContent.height();if(hasHeader){contentH+=36}if(hasFooter){contentH+=45
}contentH+=31}if(hasHeader){$("> section > article",this.wrapper).removeClass("no-header")}else{$("> section > article",this.wrapper).addClass("no-header")
}if(hasFooter){$("> section > article",this.wrapper).removeClass("no-footer")}else{$("> section > article",this.wrapper).addClass("no-footer")
}if(contentH<100){contentH=100}var maxH=$(window).height()-top-10;if(contentH&&contentH<maxH){bottom="";
height=contentH}this.wrapper.css({top:pos.top-4,left:pos.left+8,right:3,bottom:bottom,height:height});
var leftEnd=269;var topEnd=50;var contentStart=pos.left;if(!this.options.isListView){this.backdropEls.eq(0).css({top:0,width:leftEnd,bottom:0,left:0});
this.backdropEls.eq(1).css({top:0,height:topEnd,width:contentStart-leftEnd,left:leftEnd});this.backdropEls.eq(2).css({top:0,right:0,bottom:0,left:contentStart})
}if(this.scrollerHandler){this.scrollerHandler.updateSize()}},_initMacroOverlay:function(){},loadMacro:function(macro_id){},isOpen:function(){if(!this._hasInit||!this.wrapper.is(".open")){return false
}return true},open:function(){this._initOverlay();this.wrapper.addClass("open");this.backdropEls.show();
this.updateCount(null);this.updatePositions();this.updatePositions();DeskPRO_Window.layout.addEvent("resized",this.updatePositions,this);
this.options.openAction(this.wrapper)},close:function(){if(!this.isOpen()){return false}DeskPRO_Window.layout.removeEvent("resized",this.updatePositions,this);
this.wrapper.removeClass("open");this.backdropEls.hide();this.fireEvent("closed",[this]);this.clearPreview();
if(this.options.resetOnClose){this.reset()}},destroy:function(){if(this._hasInit){this.wrapper.remove();
this.backdropEls.remove()}}});Orb.createNamespace("DeskPRO.Agent.PageHelper");DeskPRO.Agent.PageHelper.AcceptContentLink=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(options){var self=this;
this.options={page:null,rte:null,isReadyCallback:null};this.setOptions(options)},isReady:function(){if(this.options.isReadyCallback){return this.options.isReadyCallback()
}return true},sendLink:function(linkTitle,url){var tiny=this.options.rte.tinymce();var title=tiny.selection.getContent({format:"text"});
if(title){title=title.trim()}if(!title.length){title=linkTitle}tiny.selection.setContent('<a href="'+url+'">'+Orb.escapeHtml(title)+"</a>")
}});Orb.createNamespace("DeskPRO.Agent.PageHelper");DeskPRO.Agent.PageHelper.SendContentLink=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(page,options){var self=this;
this.page=page;this.options={contentListEl:null};this.setOptions(options);this.contentListEl=$(this.options.contentListEl);
DeskPRO_Window.getTabWatcher().addTabTypeWatcher("*",this);var types=["article","newarticle",];this.addEvent("watchedTabActivated",function(tab){var tabtype=DeskPRO_Window.getTabWatcher().getTabType(tab);
if(types.indexOf(tabtype)!==-1){if(tab.page&&tab.page.acceptContentLink){if(tab.page.acceptContentLink.isReady()){$("body").addClass("content-link-control-on")
}else{$("body").removeClass("content-link-control-on")}}else{$("body").removeClass("content-link-control-on")
}}else{$("body").removeClass("content-link-control-on")}},this);this.addEvent("watchedTabDeactivated",function(tab,isLast){if(isLast){$("body").removeClass("content-link-control-on")
}},this);this.contentListEl.on("click",".insert-content-link",function(ev){ev.stopPropagation();ev.preventDefault();
var tab=DeskPRO_Window.getTabWatcher().getActiveTab();if(!tab||!tab.page||!tab.page.acceptContentLink){return
}tab.page.acceptContentLink.sendLink($(this).data("link-title"),$(this).data("link"))})},updateList:function(){var tab=DeskPRO_Window.getTabWatcher().getActiveTab();
if(!tab||!tab.page||!tab.page.acceptContentLink||!tab.page.acceptContentLink.isReady()){$("body").removeClass("content-link-control-on")
}else{$("body").addClass("content-link-control-on")}}});Orb.createNamespace("DeskPRO.Agent.PageHelper");
DeskPRO.Agent.PageFragment.Page.EditTitle=new Orb.Class({initialize:function(page,saveUrl,data){var namef=page.getEl("showname");
var editName=page.getEl("editname");var startBtn=page.getEl("editname_start");var stopBtn=page.getEl("editname_end");
var codeid=page.getMetaData("obj_code")||null;var startEditable=function(){namef.hide();editName.show();
startBtn.hide();stopBtn.show()};var stopEditable=function(){var nametxt=editName.find("input").first();
var setName=nametxt.val().trim();if(!setName){return}editName.hide();startBtn.show();namef.show();stopBtn.hide();
namef.text(setName);var postData=data?Array.clone(data):[];postData.push({name:"action",value:"title"});
postData.push({name:"title",value:setName});if(codeid){$("span.obj-title-"+codeid).text(setName)}$.ajax({url:saveUrl,type:"POST",data:postData,success:function(retData){if(page.handleUnloadRevisions){page.handleUnloadRevisions(retData.revision_id)
}}})};namef.on("dblclick",startEditable).on("keypress",function(ev){if(ev.keyCode==13){ev.preventDefault();
stopEditable()}});page.getEl("editname_start").on("click",startEditable);page.getEl("editname_end").on("click",stopEditable)
}});Orb.createNamespace("DeskPRO.Agent.PageHelper");DeskPRO.Agent.PageHelper.TaskListControl=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(el,options){var self=this;
var openForEl=null;var menuVis=options.menuVis;var completeCountEl=options.completeCountEl;var updateCount=function(op,row){var els=[];
var checksub=function(prefix){if(row.data("in-sublist-overdue")){els.push(document.getElementById(prefix+"_overdue"))
}if(row.data("in-sublist-today")){els.push(document.getElementById(prefix+"_today"))}if(row.data("in-sublist-future")){els.push(document.getElementById(prefix+"_future"))
}};if(row.data("in-my")){els.push(document.getElementById("tasks_counter_own_total"));checksub("tasks_counter_own")
}if(row.data("in-my-teams")){els.push(document.getElementById("tasks_counter_team_total"));checksub("tasks_counter_team")
}if(row.data("in-delegated")){els.push(document.getElementById("tasks_counter_delegated_total"));checksub("tasks_counter_delegated")
}els.push(document.getElementById("tasks_counter_all_total"));checksub("tasks_counter_all");if(completeCountEl){DeskPRO_Window.util.modCountEl(completeCountEl,op,-1)
}Array.each(els,function(el){DeskPRO_Window.util.modCountEl($(el),op)});DeskPRO_Window.sections.tasks_section.recalcBadge();
self.fireEvent("updateCount",[op,row])};var updateUi=function(){self.fireEvent("updateUi")};var sendUpdate=function(rowEl,prop,val,callback){var taskId=rowEl.data("task-id");
var url=BASE_URL+"agent/tasks/"+taskId+"/ajax-save";var postData=[];postData.push({name:"action",value:prop});
postData.push({name:"value",value:val});$.ajax({url:url,type:"POST",data:postData,dataType:"json",success:callback||function(){}})
};var statusMenu=new DeskPRO.UI.Menu({menuElement:menuVis,onItemClicked:function(info){sendUpdate(openForEl,"visibility",$(info.itemEl).data("vis"));
$(".opt-trigger.visibility label",openForEl).text($(info.itemEl).text())}});el.on("click","input.item-select",function(ev){var row=$(this).closest("article.task");
var value=$(this).is(":checked");if(value){$(".task-sub-wrap",row).hide();row.addClass("completed");sendUpdate(row,"completed",1);
updateCount("-",row)}else{row.removeClass("expanded");$(".task-sub-wrap",row).show();row.removeClass("completed");
sendUpdate(row,"completed",0);updateCount("+",row)}updateUi()});el.find("li.assigned_agent select.agents_sel").not(".has-init").each(function(){var row=$(this).closest("article.task");
DP.select($(this));$(this).on("change",function(){var val=$(this).val();var label=$(this).find(":selected").text().trim();
if(!val){val="";label="Me"}row.find(".assigned_agent").find("label").text(label);sendUpdate(row,"assigned",val,function(){DeskPRO_Window.getMessageBroker().sendMessage("agent.ui.tasks.refresh-task-list")
})})});el.on("click",".opt-trigger.visibility",function(ev){openForEl=$(this).closest("article.task");
statusMenu.open(ev)});el.on("click",".opt-trigger.date_due",function(ev){openForEl=$(this).closest("article.task");
var label=$("label",this);var date=openForEl.data("date-due");if(!date){date=new Date()}openForEl.datepicker("dialog",date,function(date,inst){sendUpdate(openForEl,"date_due",date);
label.text(date)},{dateFormat:"yy-mm-dd",showButtonPanel:true,beforeShow:function(input){setTimeout(function(){var buttonPane=$(input).datepicker("widget").find(".ui-datepicker-buttonpane");
var btn=$('<button class="ui-datepicker-current ui-state-default ui-priority-secondary ui-corner-all" type="button">Clear</button>');
btn.unbind("click").bind("click",function(){$.datepicker._clearDate(input);label.text("No due date")});
btn.appendTo(buttonPane);$(input).datepicker("widget").css("z-index",30001)},1)}},ev)});el.on("click",".expand-collapse-icon",function(ev){var row=$(this).closest("article.task");
if(row.is(".expanded")){row.removeClass("expanded");$(".task-info",row).hide();$(".task-comments",row).hide();
$(".new-comment",row).hide();$(".task-sub-wrap",row).hide();updateUi()}else{row.addClass("expanded");
$(".task-info",row).show();$(".task-comments",row).show();$(".new-comment",row).show();$(".task-sub-wrap",row).show();
updateUi()}});el.on("click",".comment-btn",function(ev){var row=$(this).closest("article.task");var input=$(".new-comment",row);
if(input.is(":visible")){input.hide()}else{input.show()}updateUi()});el.on("click",".cancel-comment-trigger",function(ev){var row=$(this).closest("article.task");
var btn=$(".comment-btn",row);$(".new-comment",row).hide();updateUi()});el.on("click",".save-comment-trigger",function(ev){var row=$(this).closest("article.task");
var commentTxt=$("textarea",row);var closefn=function(){commentTxt.val("");$(".new-comment",row).hide()
};if(!commentTxt.val().trim().length){return}var postData=[];postData.push({name:"comment",value:commentTxt.val().trim()});
row.addClass("loading");var taskId=row.data("task-id");$.ajax({url:BASE_URL+"agent/tasks/"+taskId+"/ajax-save-comment",type:"POST",dataType:"json",data:postData,complete:function(){row.removeClass("loading")
},success:function(data){closefn();if(data.error){return}var list=$("ul.task-comment-list",row);$(data.comment_li_html).appendTo(list);
$(".task-comments",row).show();updateUi()}})});el.on("click",".task-group header",function(){$(this).parent().toggleClass("collapsed");
updateUi()});el.on("click",".delete-task",function(ev){var row=$(this).closest(".row-item");var taskId=row.data("task-id");
if(confirm($(this).data("confirm"))){row.slideUp();updateCount("-",row);$.ajax({url:BASE_URL+"agent/tasks/"+taskId+"/delete",error:function(){row.show()
},success:function(){row.remove()}})}})}});Orb.createNamespace("DeskPRO.Agent.PageHelper");DeskPRO.Agent.PageHelper.TicketBilling=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(wrap,baseId,options){this.baseId=baseId;
this.options={auto_start_bill:false};this.setOptions(options);this.billingStart=false;this.billingExtraTime=0;
this.billingTimer=null;var self=this;this.hasBilling=(wrap.length>0);if(!wrap.length){return}var form=this.getEl("billing_form");
var progress=this.getEl("billing_save_progress");var typeInputs=form.find("input[name="+this.baseId+"_billing_type]");
var billingRows=this.getEl("billing_rows");typeInputs.change(function(){self.updateBillingForm(true)});
this.updateBillingForm(true);this.getEl("billing_stop").click(function(){self.stopBillingTimer(false);
$(this).hide();self.getEl("billing_start").show()});this.getEl("billing_start").click(function(){if(self.getEl("billing_type_hidden").val()!="time"){return
}self.startBillingTimer(false);$(this).hide();self.getEl("billing_stop").show()});this.getEl("billing_reset").click(function(){if(typeInputs.filter(":checked").val()=="time"){if(self.getEl("billing_stop").is(":visible")){self.startBillingTimer(true)
}else{self.stopBillingTimer(true)}}else{self.stopBillingTimer(true)}});this.getEl("billing_save").click(function(){progress.show();
$.ajax({url:$(this).data("submit-url"),data:form.find("input, textarea, select").serialize(),type:"POST",dataType:"json"}).done(function(json){if(json.inserted&&self.addBillingRow){self.addBillingRow(json.html);
self.resetBillingForm()}}).always(function(){progress.hide()})});wrap.on("click","a.billing-delete",function(e){var $this=$(this);
e.preventDefault();if(confirm(billingRows.data("delete-confirm"))){$.ajax({url:$this.attr("href"),type:"POST",dataType:"json"}).done(function(json){if(json.success){var table=$this.closest("table");
$this.closest("tr").remove();if(!table.find("tbody tr").length){table.hide()}}})}});if(this.options.auto_start_bill){this.getEl("billing_start").hide();
this.getEl("billing_stop").show();this.getEl("billing_start").click()}else{this.getEl("billing_stop").hide();
this.getEl("billing_start").show();this.stopBillingTimer(true)}},addBillingRow:function(html){var add=$(html);
var billingRows=this.getEl("billing_rows");billingRows.append(add);add.find(".timeago").timeago();billingRows.closest("table").show()
},updateBillingForm:function(reset){var form=this.getEl("billing_form");var typeInputs=form.find("input[name="+this.baseId+"_billing_type]");
var val=typeInputs.filter(":checked").val();this.getEl("billing_type_hidden").val(val);var replyBaseId=$("form.ticket-reply-form",this.getEl("replybox_wrap")).data("base-id");
if(replyBaseId){var replyBillingRow=$("#"+replyBaseId+"_billing_reply")}else{var replyBillingRow=false
}this.clearTimer();if(val=="time"){if(this.getEl("billing_stop").is(":visible")){this.startBillingTimer(reset)
}if(replyBillingRow){replyBillingRow.show();replyBillingRow.find("input[type=checkbox]").attr("disabled",false)
}}else{this.stopBillingTimer(reset);if(replyBillingRow){replyBillingRow.hide();replyBillingRow.find("input[type=checkbox]").attr("disabled",true)
}}},clearTimer:function(){if(this.billingTimer){clearInterval(this.billingTimer);this.billingTimer=null
}},resetBillingForm:function(){var form=this.getEl("billing_form");this.getEl("billing_amount").val("");
this.getEl("billing_comment").val("");if(this.getEl("billing_type_hidden").val()=="time"&&this.options.auto_start_bill){this.startBillingTimer(true)
}else{this.stopBillingTimer(true)}},startBillingTimer:function(reset){if(reset){this.billingStart=new Date();
this.billingExtraTime=0}else{if(this.billingStart){this.billingExtraTime=Math.floor((new Date()-this.billingStart)/1000)+this.billingExtraTime
}this.billingStart=new Date()}this.clearTimer();this.updateBillingTimer(true,true);var self=this;this.billingTimer=setInterval(function(){self.updateBillingTimer()
},1000)},stopBillingTimer:function(reset){if(reset){this.billingStart=false;this.billingExtraTime=0}else{if(this.billingStart){this.billingExtraTime=Math.floor((new Date()-this.billingStart)/1000)+this.billingExtraTime
}this.billingStart=false}this.clearTimer();this.updateBillingTimer(true)},updateBillingTimer:function(force,showZero){var seconds=0;
if(this.billingStart){seconds=Math.floor((new Date()-this.billingStart)/1000)}seconds+=this.billingExtraTime;
var rawSeconds=seconds,hours=0,minutes=0;var form=this.getEl("billing_form");var timeInputs={hours:this.getEl("billing_hours"),minutes:this.getEl("billing_minutes"),seconds:this.getEl("billing_seconds")};
if(seconds>=3600){hours=Math.floor(seconds/3600);timeInputs.hours.val(hours);seconds-=hours*3600}else{if(force){timeInputs.hours.val("")
}}if(seconds>=60){minutes=Math.floor(seconds/60);timeInputs.minutes.val(minutes);seconds-=minutes*60}else{if(force){timeInputs.minutes.val("")
}}if(seconds>0||minutes>0||hours>0||showZero){timeInputs.seconds.val(seconds||0)}else{if(force){timeInputs.seconds.val("")
}}var replyBaseId=$("form.ticket-reply-form",this.getEl("replybox_wrap")).data("base-id");if(replyBaseId){var reply=$("#"+replyBaseId+"_billing_reply");
if(reply.length){reply.find("input[type=checkbox]").val(rawSeconds);var text="";if(hours){text+=hours+(hours>1?" hours ":" hour ")
}if(minutes){text+=minutes+(minutes>1?" minutes ":" minute ")}text+=seconds+" seconds";$("#"+replyBaseId+"_billing_reply_time").text(text)
}}},getEl:function(id){if(this.baseId){id=this.baseId+"_"+id}return $("#"+id)}});Orb.createNamespace("DeskPRO.Agent.PageHelper");
DeskPRO.Agent.PageHelper.Twitter=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(content,page,options){this.content=$(content);
this.page=page;var self=this;this.options={saveMessageCallback:"default",messageUrl:page.getMetaData("saveReplyUrl"),statusArchiveHideCallback:null,userArchiveHideCallback:null};
options=options||{};this.setOptions(options);this.content.on("click",".photo, .user",function(e){e.preventDefault();
DeskPRO_Window.runPageRouteFromElement(this);return false});this.content.on("click",".mention",function(e){e.preventDefault();
var route="page:"+BASE_URL+"agent/twitter/user/"+$(this).data("user-id");DeskPRO_Window.runPageRoute(route);
return false});this.content.on("click",".follow",function(e){e.preventDefault();e.stopPropagation();var row=self.closestRow(this);
var id=row.attr("data-user-id");self.content.find('[data-user-id="'+id+'"] .follow').each(function(){$(this).addClass("unfollow").removeClass("follow");
var label=$(this).find("label");if(label.length){label.text("Unfollow")}else{$(this).text("Unfollow")
}});$.ajax({url:self.page.getMetaData("saveFollowUrl"),type:"POST",data:{user_id:id,account_id:self.page.getMetaData("accountId")}});
if(page.getMetaData("listRoute")=="agent_twitter_followers_list_new"){row.addClass("archived");row.find(".status-archived").show();
if(self.page.getMetaData("hideArchived")){if(self.options.userArchiveHideCallback){self.options.userArchiveHideCallback(row)
}row.fadeOut("fast",function(){if(self.options.userArchiveHideCallback){self.options.userArchiveHideCallback(row)
}row.remove()})}}});this.content.on("click",".unfollow",function(e){e.preventDefault();e.stopPropagation();
var id=self.closestRow(this).attr("data-user-id");self.content.find('[data-user-id="'+id+'"] .unfollow').each(function(){$(this).addClass("follow").removeClass("unfollow");
var label=$(this).find("label");if(label.length){label.text("Follow")}else{$(this).text("Follow")}});
$.ajax({url:self.page.getMetaData("saveUnfollowUrl"),type:"POST",data:{user_id:id,account_id:self.page.getMetaData("accountId")}})
});this.content.on("click",".status-archive.user-action",function(e){e.preventDefault();var row=$(this).closest(".twitter-user");
var id=row.attr("data-user-id");if(id){$(this).hide();row.addClass("archived");row.find(".status-archived").show();
self.doArchiveUser(id,1);if(self.page.getMetaData("hideArchived")){row.fadeOut("fast",function(){if(self.options.userArchiveHideCallback){self.options.userArchiveHideCallback(row)
}row.remove()})}}});this.content.on("click",".status-archived.user-action",function(e){e.preventDefault();
var row=$(this).closest(".twitter-user");var id=$(this).closest(".twitter-user").attr("data-user-id");
if(id){$(this).hide();row.removeClass("archived");row.find(".status-archive").show();self.doArchiveUser(id,0)
}});this.content.on("click",".add-favorite",function(e){e.preventDefault();var id=self.closestRow(this).attr("data-status-id");
if(id){self.removeTweetNotification(id);$(this).addClass("favorited").removeClass("add-favorite");self.doFavorite(id,1)
}});this.content.on("click",".favorited",function(e){e.preventDefault();var id=self.closestRow(this).attr("data-status-id");
if(id){self.removeTweetNotification(id);$(this).addClass("add-favorite").removeClass("favorited");self.doFavorite(id,0)
}});this.content.on("click",".status-archive.status-action",function(e){e.preventDefault();var row=self.closestRow(this);
var id=row.attr("data-status-id");if(id){$(this).hide();row.addClass("archived");row.find(".status-archived").show();
self.doArchiveStatus(id,1);self.removeTweetNotification(id);if(page.menuOptions&&!page.menuOptions.filter("[name=archived]").is(":checked")){row.fadeOut("fast",function(){if(self.options.statusArchiveHideCallback){self.options.statusArchiveHideCallback(row)
}row.remove()})}}});this.content.on("click",".status-archived.status-action",function(e){e.preventDefault();
var row=self.closestRow(this);var id=row.attr("data-status-id");if(id){$(this).hide();row.removeClass("archived");
row.find(".status-archive").show();self.removeTweetNotification(id);self.doArchiveStatus(id,0)}});this.content.on("click",".status-delete.status-action",function(e){e.preventDefault();
var row=self.closestRow(this);var id=row.attr("data-status-id");if(id&&confirm("Are you sure you want to delete this tweet?")){row.hide();
self.removeTweetNotification(id);$.ajax({url:self.page.getMetaData("saveDeleteUrl"),type:"POST",dataType:"json",data:{account_status_id:id},success:function(json){if(json.success){row.remove()
}else{if(json.error){row.show();alert(json.error)}}}})}});this.content.on("click",".status-delete.reply-action",function(e){e.preventDefault();
var reply=$(this).closest(".twitter-reply");var id=reply.attr("data-status-id");if(id&&confirm("Are you sure you want to delete this tweet?")){reply.hide();
$.ajax({url:self.page.getMetaData("saveDeleteUrl"),type:"POST",dataType:"json",data:{account_status_id:id},success:function(json){if(json.success){var row=self.closestRow(reply);
reply.remove();if(!row.find(".twitter-replies .twitter-reply").length){row.find(".reply-list").hide()
}}else{if(json.error){reply.show();alert(json.error)}}}})}});this.content.on("click",".status-edit.status-action",function(e){e.preventDefault();
var row=$(this).closest("[data-status-id]");var id=row.attr("data-status-id");if(id){var overlay=new DeskPRO.UI.Overlay({contentMethod:"ajax",contentAjax:{url:BASE_URL+"agent/twitter/status/ajax-edit",data:{account_status_id:id}},zIndex:40000,onAjaxDone:function(){var wrapper=overlay.getWrapper();
var textarea=wrapper.find("textarea[name=text]");textarea.TextAreaExpander().focus();wrapper.find(".save-trigger").click(function(){wrapper.addClass("loading");
$.ajax({url:BASE_URL+"agent/twitter/status/ajax-edit",type:"POST",data:{account_status_id:id,text:textarea.val(),process:1},dataType:"json",success:function(data){if(data.success){overlay.close();
if(row.is(".twitter-reply")){row.find(".status-text").html(data.parsed_text)}else{row.find(".main-status-body .status-text").html(data.parsed_text)
}}else{if(data.error){alert(data.error)}}}}).always(function(){wrapper.removeClass("loading")})})}});
overlay.open()}});this.content.on("click","li.opt-trigger.retweet",function(e){e.preventDefault();var row=self.closestRow(this);
var id=row.attr("data-status-id");var retweetContainer=row.find(".new-retweet");if(retweetContainer.is(":visible")){retweetContainer.hide()
}else{retweetContainer.show();row.find(".new-message").hide();self.removeTweetNotification(id);var textarea=retweetContainer.find("textarea");
if(!textarea.hasClass("tae")){textarea.TextAreaExpander()}self.updateTweetLength(textarea);textarea.focus()
}});this.content.on("change",".new-retweet .retweet-type input[type=radio]",function(){var $this=$(this),container=$this.closest(".new-retweet");
if($this.val()=="1"){container.find(".edit-only").hide()}else{container.find(".edit-only").show()}});
this.content.on("keypress keyup change",".new-retweet textarea",function(){var $this=$(this);setTimeout(function(){self.updateTweetLength($this)
},0)});this.content.on("click",".cancel-retweet-trigger",function(){var retweetContainer=$(this).closest(".new-retweet");
retweetContainer.hide()});this.content.on("click",".save-retweet-trigger",function(e){e.preventDefault();
var row=self.closestRow(this);var id=row.attr("data-status-id");var retweetContainer=$(this).closest(".new-retweet");
var val=$.trim(retweetContainer.find("textarea").val());if(!val.length){retweetContainer.hide();return
}var data=retweetContainer.find("form").serializeArray();data.push({name:"account_status_id",value:id});
retweetContainer.addClass("loading");self.removeTweetNotification(id);$.ajax({url:page.getMetaData("saveRetweetUrl"),type:"POST",dataType:"json",data:data,success:function(json){if(json.success){if(json.html&&json.html.length){for(var i=0;
i<json.html.length;i++){var html=$(json.html[i]);row.find(".twitter-replies").append(html);$(".timeago",html).timeago()
}row.find(".reply-list").show()}if(json.retweet){var link=row.find("li.opt-trigger.retweet");link.addClass("retweeted").removeClass("retweet");
link.find("label").text("Retweeted")}retweetContainer.hide();if(json.archived){row.addClass("archived");
row.find(".status-archive").hide();row.find(".status-archived").show();if(page.menuOptions&&!page.menuOptions.filter("[name=archived]").is(":checked")){row.fadeOut("fast",function(){if(self.options.statusArchiveHideCallback){self.options.statusArchiveHideCallback(row)
}row.remove()})}}}else{alert(json.error)}}}).always(function(){retweetContainer.removeClass("loading")
})});this.content.on("click","li.opt-trigger.retweeted",function(e){e.preventDefault();var link=$(this);
var id=self.closestRow(this).attr("data-status-id");if(id&&confirm("Are you sure you want to un-retweet this?")){self.removeTweetNotification(id);
$.ajax({url:page.getMetaData("saveUnretweetUrl"),type:"POST",dataType:"json",data:{account_status_id:id},success:function(json){if(json.success){link.addClass("retweet").removeClass("retweeted");
link.find("label").text("Retweet")}else{alert(json.error)}}})}});this.content.on("click","li.opt-trigger.message",function(e){e.preventDefault();
var row=self.closestRow(this);var id=row.attr("data-status-id");var newMessage=row.find(".new-message");
if(newMessage.is(":visible")){newMessage.hide()}else{newMessage.show();row.find(".new-retweet").hide();
self.removeTweetNotification(id);var textarea=newMessage.find("textarea");if(!textarea.hasClass("tae")){textarea.TextAreaExpander()
}if(!$.trim(textarea.val()).length&&!row.hasClass("dm")){var name=row.find(".main-status-body .screen-name, h4 .screen-name").first().text();
textarea.val(name+" ")}if(self.page.getMetaData("tweetSignature")){textarea.val(textarea.val()+self.page.getMetaData("tweetSignature"))
}self.updateTweetLength(textarea);textarea.focus()}});this.content.on("keypress keyup change",".new-message textarea",function(){var $this=$(this);
setTimeout(function(){self.updateTweetLength($this)},0)});this.content.on("click",".new-message .message-type li",function(){var $this=$(this);
var messageContainer=$this.closest(".new-message");var first=messageContainer.find(".message-type li").not($this).first();
$this.removeClass("on");first.addClass("on");messageContainer.find(".message-type-hidden").val(first.data("type"))
});this.content.on("click",".cancel-message-trigger",function(){var messageContainer=$(this).closest(".new-message");
messageContainer.hide()});this.content.on("click",".save-message-trigger",function(e){e.preventDefault();
var row=self.closestRow(this);var id=row.attr("data-status-id");var messageContainer=$(this).closest(".new-message");
var val=$.trim(messageContainer.find("textarea").val());if(!val.length){messageContainer.hide();return
}var data=messageContainer.find("form").serializeArray();self.removeTweetNotification(id);if(self.options.saveMessageCallback==="default"){messageContainer.addClass("loading");
$.ajax({url:self.options.messageUrl,type:"POST",dataType:"json",data:data,success:function(json){if(json.success){if(json.html&&json.html.length){for(var i=0;
i<json.html.length;i++){var html=$(json.html[i]);row.find(".twitter-replies").append(html);$(".timeago",html).timeago()
}row.find(".reply-list").show()}row.find(".message-sent-confirmation .message").text(val);row.find(".message-sent-confirmation").show();
messageContainer.hide();messageContainer.find("textarea").val("");if(json.archived){row.addClass("archived");
row.find(".status-archive").hide();row.find(".status-archived").show();if(page.menuOptions&&!page.menuOptions.filter("[name=archived]").is(":checked")){row.fadeOut("fast",function(){if(self.options.statusArchiveHideCallback){self.options.statusArchiveHideCallback(row)
}row.remove()})}}}else{alert(json.error)}}}).always(function(){messageContainer.removeClass("loading")
})}else{if(self.options.saveMessageCallback){self.options.saveMessageCallback(data,row)}}});this.content.on("click",".note-btn",function(){var row=self.closestRow(this);
var id=row.attr("data-status-id");var newNote=row.find(".new-note");if(newNote.is(":visible")){newNote.hide()
}else{var textarea=newNote.find("textarea");if(!textarea.data("redactor")){self.initializeNoteEditor(textarea,page.getMetaData("agentMap"))
}newNote.show();self.removeTweetNotification(id);if(textarea.data("redactor")){textarea.setFocus()}else{textarea.focus()
}}});this.content.on("click",".cancel-note-trigger",function(){var noteContainer=$(this).closest(".new-note");
noteContainer.hide()});this.content.on("click",".save-note-trigger",function(e){e.preventDefault();var row=self.closestRow(this);
var id=row.attr("data-status-id");var noteContainer=$(this).closest(".new-note");var textarea=noteContainer.find("textarea");
if(textarea.data("redactor")){textarea.data("redactor").syncCode()}var val=$.trim(textarea.val());if(!val.length){noteContainer.hide();
return}noteContainer.addClass("loading");self.removeTweetNotification(id);$.ajax({url:page.getMetaData("saveNoteUrl"),type:"POST",dataType:"json",data:{account_status_id:id,text:val},success:function(json){if(json.success){if(json.html){var html=$(json.html);
row.find(".note-list").append(html);$(".timeago",html).timeago();row.find(".status-notes").show()}noteContainer.hide();
textarea.val("");if(textarea.data("redactor")){textarea.setCode("")}}else{alert(json.error)}}}).always(function(){noteContainer.removeClass("loading")
})});this.content.on("click",".opt-trigger.agent > label, .opt-trigger.agent span",function(ev){var li=$(this).closest("li");
var row=$(this).closest("article.twitter-status");var select=li.find("select");if(!select.data("select2")){DP.select(select);
select.on("change",function(){var val=$(this).val();var sel=$(this).find(":selected");var label=sel.text().trim();
self.removeTweetNotification(id);if(val=="agent:"+DESKPRO_PERSON_ID){label="Me"}var labelEl=row.find("li.opt-trigger.agent label");
if(sel.data("icon")){labelEl.text(" "+label).prepend($('<img class="agent-assign-icon" />').attr("src",sel.data("icon")))
}else{labelEl.text(label)}var id=$(this).closest(".twitter-status").attr("data-status-id");$.ajax({url:page.getMetaData("saveAssignUrl"),type:"POST",dataType:"json",data:{account_status_id:id,assign:val},success:function(json){if(json.error){alert(json.error)
}}})});li.find(".select2-container").css({height:5,overflow:"hidden"})}var oldOpen=select.data("select2").open;
var oldClose=select.data("select2").close;var s2=select.data("select2");s2.open=function(){oldOpen.call(s2);
select.data("select2").container.addClass("select2-dropdown-open")};s2.close=function(){select.data("select2").container.addClass("select2-dropdown-open");
oldClose.call(s2)};s2.open()})},updateTweetLength:function(textarea){var text=textarea.val();text=text.replace(/\r?\n/g," ").replace(/http:\/\/(?=([^ \t\r\n[\]#]+))\1(?!#)/g,"1234567890123456789012").replace(/https:\/\/(?=([^ \t\r\n[\]#]+))\1(?!#)/g,"1234567890123456789013");
var newMessageArea=textarea.closest(".new-message, .new-retweet"),charCount=newMessageArea.find(".character-count"),charCountCounter=charCount.find("em"),overOptions=newMessageArea.find(".over-options");
if(text.length>140){charCount.hide();overOptions.show()}else{charCountCounter.text(140-text.length);charCount.show();
overOptions.hide()}},closestRow:function(el){return $(el).closest(".row-item, .overlay-content, .twitter-status-inline")
},doArchiveStatus:function(id,archive){$.ajax({url:this.page.getMetaData("saveArchiveUrl"),type:"POST",dataType:"json",data:{account_status_id:id,archive:archive?1:0},success:function(json){if(json.error){alert(json.error)
}}})},doFavorite:function(id,favorite){$.ajax({url:this.page.getMetaData("saveFavoriteUrl"),type:"POST",dataType:"json",data:{account_status_id:id,favorite:favorite?1:0},success:function(json){if(json.error){alert(json.error)
}}})},doArchiveUser:function(id,archive){$.ajax({url:this.page.getMetaData("saveUserArchiveUrl"),type:"POST",dataType:"json",data:{user_id:id,account_id:this.page.getMetaData("accountId"),archive:archive?1:0},success:function(json){if(json.error){alert(json.error)
}}})},removeTweetNotification:function(id){DeskPRO_Window.notifications.removeRelated("tweet:"+id)},initializeNoteEditor:function(textarea,agentMap){if(textarea.data("redactor")){return
}textarea.redactor({toolbar:false,buttons:[],shortcuts:false,minHeight:50});var api=textarea.data("redactor");
if(!api){return}var editor=textarea.getEditor();if(!editor){return false}editor.bind("keydown",function(ev){ev.stopPropagation();
if(ev.metaKey&&!ev.ctrlKey){var sel;if(window.getSelection&&(sel=window.getSelection())&&sel.modify){var adjustmentType=ev.shiftKey?"extend":"move";
switch(ev.keyCode){case 39:sel.modify(adjustmentType,"right","lineboundary");ev.preventDefault();break;
case 37:sel.modify(adjustmentType,"left","lineboundary");ev.preventDefault();break}}}});editor.bind("keypress",function(ev){ev.stopPropagation()
});DeskPRO_Window.initAgentNotifierForRte(self,textarea,agentMap||false,true)}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page");
DeskPRO.Agent.PageFragment.Page.SnippetViewer=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="snippets";this.allowDupe=true;this.activeSection=null;this.activeSnippets=$([]);this.noIgnoreForm=true
},initPage:function(el){var self=this;this.snippet_typename=this.meta.snippet_typename;if(this.snippet_typename=="tickets"){var driver=DeskPRO_Window.ticketSnippetDriver
}else{var driver=DeskPRO_Window.chatSnippetDriver}this.snippetDriver=driver;var catList=this.getEl("catlist");
var snippetList=this.getEl("snippet_list");var filterInput=this.getEl("filter");var langSelect=this.getEl("show_language_id");
var rowsTpl=twig({data:DeskPRO_Window.util.getPlainTpl($("#snippet_rows_tpl"))});this.rowsTpl=rowsTpl;
var pickLangText=function(lang_vals,myLangId,showLangId){if(!showLangId||showLangId=="0"){showLangId=DESKPRO_DEFAULT_LANG_ID
}var ret={my:"",myId:0,show:"",showId:0};var hasShow=false;Array.each(lang_vals,function(l){if(l.value&&l.language_id==myLangId){ret.my=l.value;
ret.myId=l.language_id}if(l.value&&l.language_id==showLangId){ret.show=l.value;ret.showId=l.language_id
}if(!ret.show&&l.value){ret.show=l.value;ret.showId=l.language_id}});if((!ret.show||ret.showId!=showLangId)&&ret.my&&ret.myId){ret.show=ret.my;
ret.showId=ret.myId}return ret};this.pickLangText=pickLangText;var useLocalCompare=(typeof String.localeCompare!="undefined");
var sortSnippets=function(snippets){return snippets.sort(function(a,b){var a_string,b_string;a_string=a.title_use.show||"";
b_string=b.title_use.show||"";if(useLocalCompare){var cmp=a_string.localeCompare(b_string,null,{usage:"sort",ignorePunctuation:true,caseFirst:false});
return cmp}else{a_string=a_string.toLowerCase();b_string=b_string.toLowerCase();if(a_string==b_string){return 0
}return(a_string<b_string)?-1:1}})};var updateCatList=function(categoryId,filterString,languageId){var myLangId=DESKPRO_PERSON_LANG_ID;
var showLangId=langSelect.val();if(categoryId){driver.loadSnippets({categoryId:categoryId,filterString:filterString||null,languageId:languageId||null},function(snippets){var newList=$("<ul></ul>");
Array.each(snippets,function(s){s.title_use=pickLangText(s.title,myLangId,showLangId);s.snippet_use=pickLangText(s.snippet,myLangId,showLangId)
});snippets=sortSnippets(snippets);newList.html(rowsTpl.render({snippets:snippets}));snippetList.empty().append(newList)
})}else{var catIds=[];catList.find("li").each(function(){var id=parseInt($(this).data("category-id"));
if(id){catIds.push(id)}});snippetList.empty();if(!catIds.length){return}var tick=0;if(driver.driverName=="client_db"){Array.each(catIds,function(cid){driver.loadSnippets({categoryId:cid,filterString:filterString||null,languageId:languageId||null},function(snippets){if(!snippets.length){return
}Array.each(snippets,function(s){s.title_use=pickLangText(s.title,myLangId,showLangId);s.snippet_use=pickLangText(s.snippet,myLangId,showLangId)
});snippets=sortSnippets(snippets);var hasMore=false;if(snippets.length>15){var hasMore=true;snippets=snippets.slice(0,15)
}var newListWrap=$("<div/>");var catTitle=$('<div class="cat-title"/>');catTitle.text(catList.find(".category-"+cid).text());
catTitle.appendTo(newListWrap);var newList=$("<ul></ul>");newList.html(rowsTpl.render({snippets:snippets}));
newListWrap.append(newList);snippetList.append(newListWrap)})})}else{driver.loadSnippets({filterString:filterString||null},function(snippets){if(!snippets.length){return
}Array.each(catIds,function(cid){var catSnippets=snippets.filter(function(s){return s.category_id==cid
});if(!catSnippets.length){return}Array.each(catSnippets,function(s){s.title_use=pickLangText(s.title,myLangId,showLangId);
s.snippet_use=pickLangText(s.snippet,myLangId,showLangId)});catSnippets=sortSnippets(catSnippets);var hasMore=false;
if(catSnippets.length>15){var hasMore=true;catSnippets=catSnippets.slice(0,15)}var newListWrap=$("<div/>");
var catTitle=$('<div class="cat-title"/>');catTitle.text(catList.find(".category-"+cid).text());catTitle.appendTo(newListWrap);
var newList=$("<ul></ul>");newList.html(rowsTpl.render({snippets:catSnippets}));newListWrap.append(newList);
snippetList.append(newListWrap)})})}}};langSelect.on("change",function(ev){var categoryId=parseInt(catList.find(".on").data("category-id")||0)||0;
var filterString=$.trim(filterInput.val());var languageId=parseInt(langSelect.val())||0;updateCatList(categoryId,filterString,languageId)
});catList.on("click","li",function(ev){Orb.cancelEvent(ev);catList.find(".on").removeClass("on");var categoryId=$(this).addClass("on").data("category-id");
var filterString=$.trim(filterInput.val());var languageId=parseInt(langSelect.val())||0;updateCatList(categoryId,filterString,languageId)
});var filterTimer=null;var sendUpdate=function(){filterTimer=null;var categoryId=parseInt(catList.find(".on").data("category-id")||0)||0;
var filterString=$.trim(filterInput.val());var languageId=parseInt(langSelect.val())||0;updateCatList(categoryId,filterString,languageId)
};var cmdEat=false;filterInput.on("change keydown keyup",function(ev){if(ev.keyCode==13){ev.preventDefault();
if(cmdEat){cmdEat=false;return}cmdEat=true;var activeSnippets=snippetList.find("li.snippet");var current=activeSnippets.filter(".cursor");
if(!current[0]){if(activeSnippets.length==1){current=activeSnippets}}if(current[0]){current.click()}return
}else{if(ev.keyCode==40||ev.keyCode==38){ev.preventDefault();if(cmdEat){cmdEat=false;return}cmdEat=true;
var activeSnippets=snippetList.find("li.snippet");var dir=ev.keyCode==40?"down":"up";var current=activeSnippets.filter(".cursor");
if(!current.length){if(dir=="down"){activeSnippets.first().addClass("cursor")}else{activeSnippets.last().addClass("cursor")
}}else{var nextIndex=activeSnippets.index(current);if(dir=="down"){nextIndex++}else{nextIndex--}if(nextIndex<0){nextIndex=activeSnippets.length-1
}else{if(nextIndex>(activeSnippets.length-1)){nextIndex=0}}current.removeClass("cursor");activeSnippets.eq(nextIndex).addClass("cursor")
}return}}cmdEat=false;if(filterTimer){window.clearTimeout(filterTimer);filterTimer=null}filterTimer=window.setTimeout(function(){sendUpdate()
},140)});snippetList.on("click","li",function(ev){if($(ev.target).hasClass("edit-trigger")){return}Orb.cancelEvent(ev);
self.insertSnippetEl($(this),ev)});var catEditor=new (function(){var editCatEl=self.getEl("edit_snippet_cat");
var editCatBack=null;var hasInit=false;self.wrapper.find(".trigger-newcat").on("click",function(ev){Orb.cancelEvent(ev);
openCatEditor(0,"")});var openCatEditor=function(catId,catTitle,shareOpt,openPos){if(!hasInit){hasInit=true;
editCatEl.detach().appendTo("body");editCatBack=$('<div class="dp-popover-backdrop" />').hide();editCatBack.appendTo("body");
editCatBack.on("click",function(ev){Orb.cancelEvent(ev);closeCatEditor()});editCatEl.find(".trigger-close").on("click",function(ev){Orb.cancelEvent(ev);
closeCatEditor()});editCatEl.find(".trigger-save").on("click",function(ev){Orb.cancelEvent(ev);saveCategory()
});editCatEl.find(".delete-cat-trigger").on("click",function(ev){Orb.cancelEvent(ev);delCategory()})}if(!openPos){openPos={of:self.wrapper.find(".trigger-newcat").first(),my:"left top",at:"center right",collision:"flipfit"}
}if(catList.find("li").length<2){editCatEl.find(".no-cats-notice").show()}else{editCatEl.find(".no-cats-notice").hide()
}editCatEl.css({left:0,top:0});editCatEl.position(openPos);editCatEl.find(".input_id").val(catId||"0");
editCatEl.find(".input_title").val(catTitle||"");shareOpt=shareOpt||"me";editCatEl.find(".perm-type-opt").prop("checked",false).filter('[value="'+shareOpt+'"]').prop("checked",true);
if(catId&&catId!="0"){editCatEl.find(".delete-link-wrap").show()}else{editCatEl.find(".delete-link-wrap").hide()
}editCatEl.show();editCatBack.show()};this.openCatEditor=openCatEditor;var closeCatEditor=function(){editCatEl.hide();
editCatBack.hide()};var saveCategory=function(){var catId=editCatEl.find(".input_id").val();var catTitle=$.trim(editCatEl.find(".input_title").val());
var shareOpt=editCatEl.find(".perm-type-opt").filter(":checked").val();if(!catTitle){closeCatEditor();
return}var postData=[];postData.push({name:"title",value:catTitle});postData.push({name:"perm_type",value:shareOpt});
editCatEl.addClass("dp-loading-on");$.ajax({url:BASE_URL+"agent/text-snippets/"+self.snippet_typename+"/categories/"+catId+"/save.json",data:postData,dataType:"json",type:"POST",complete:function(){editCatEl.removeClass("dp-loading-on")
},success:function(data){closeCatEditor();var cat=data.category;var catEl=catList.find(".category-"+cat.id);
if(catEl[0]){catEl.find(".label").text(catTitle);if(shareOpt=="global"){catEl.data("is-global",1)}else{catEl.data("is-global",null)
}self.getEl("editsnippet_category_select").find('option[value="'+catId+'"]').text(catTitle)}else{catEl=$('<li><a><span class="label"></span></a><span class="trigger-edit-cat"><i class="icon-cog"></i></span></li>');
catEl.addClass("category category-"+cat.id);catEl.data("category-id",cat.id);if(shareOpt=="global"){catEl.data("is-global",1)
}else{catEl.data("is-global",null)}catEl.find(".label").text(cat.title[0].value);catEl.insertAfter(catList.find(".category-0"));
var catOpt=$("<option/>");catOpt.val(cat.id);catOpt.text(cat.title[0].value);self.getEl("editsnippet_category_select").prepend(catOpt)
}catEl.click();driver.getWidgetShellTemplate(true)}})};var delCategory=function(){if(confirm("Are you sure?")){var catId=editCatEl.find(".input_id").val();
editCatEl.addClass("dp-loading-on");$.ajax({url:BASE_URL+"agent/text-snippets/"+self.snippet_typename+"/categories/"+catId+"/delete.json",dataType:"json",type:"POST",complete:function(){editCatEl.removeClass("dp-loading-on")
},success:function(data){editCatEl.removeClass("dp-loading-on");closeCatEditor();if(data.error){alert("You cannot delete this category because it still has snippets in it. Delete the snippets first then try again.");
return}var catEl=catList.find(".category-"+catId);catEl.remove();driver.getWidgetShellTemplate(true)}})
}};this.destroy=function(){if(hasInit){editCatEl.detach();editCatBack.detach()}}})();this.ownObject(catEditor);
catList.on("click",".trigger-edit-cat",function(ev){Orb.cancelEvent(ev);var row=$(this).closest("li");
var catId=row.data("category-id");var catTitle=$.trim(row.find(".label").text());var shareOpt=row.data("is-global")?"global":"me";
var openPos={of:$(this),my:"left top",at:"center right",collision:"flipfit"};catEditor.openCatEditor(catId,catTitle,shareOpt,openPos)
});this._initEditingSnippets();if(!catList.find(".on")[0]){catList.find("li").first().click()}filterInput.focus();
this.addEvent("activate",function(){if(filterInput){filterInput.focus()}})},closeSelf:function(){var ev={cancel:false};
this.fireEvent("closeSelf",ev);if(!ev.cancel){this.parent()}},destroy:function(){if(DeskPRO_Window.activeListNav==this.listNav){DeskPRO_Window.activeListNav=null
}if(this.newCatOverlay){this.newCatOverlay.remove()}},insertSnippetEl:function(el,event,evData){var snippetId=$(el).data("snippet-id");
var snippetCode=[];el.find(".snippet-value").each(function(ev){snippetCode.push({language_id:$(this).data("language-id"),value:$(this).val()})
});evData=evData||{};evData=$.extend(evData,{event:event||null,snippetId:snippetId,snippetCode:snippetCode});
this.fireEvent("snippetClick",[evData])},_initEditingSnippets:function(){var self=this;var snippetList=this.getEl("snippet_list");
var editSnippetEl=this.getEl("edit_snippet");var textarea=this.getEl("snippet_input");if(!textarea.data("redactor")){DeskPRO_Window.initRteAgentReply(textarea,{defaultIsHtml:true,autoresize:false})
}snippetList.on("click",".edit-trigger",function(ev){Orb.cancelEvent(ev);var snippetId=$(this).closest("li").data("snippet-id");
self.snippetDriver.getSnippet(snippetId,function(snippet){self.editSnippet(snippet)})});self.wrapper.find(".trigger-new-snippet").on("click",function(ev){Orb.cancelEvent(ev);
if(self.getEl("catlist").find("li").length<2){self.wrapper.find(".trigger-newcat").first().click();return
}self.editSnippet()});editSnippetEl.find(".language_id").on("change",function(ev){var langId=$(this).val();
var inputTitleEl=self.getEl("title_input");var inputSnippetEl=self.getEl("snippet_input");var langTitleEl=editSnippetEl.find(".lang-bound-title.lang-"+langId);
var langSnippetEl=editSnippetEl.find(".lang-bound-snippet.lang-"+langId);textarea.data("redactor").syncCode();
if($(this).hasClass("initial")){inputTitleEl.val(langTitleEl.val());textarea.data("redactor").setCode(langSnippetEl.val())
}else{if($(this).hasClass("set-bound")){langTitleEl.val(inputTitleEl.val());langSnippetEl.val(inputSnippetEl.val())
}else{inputTitleEl.val(langTitleEl.val());textarea.data("redactor").setCode(langSnippetEl.val());langTitleEl.val(inputTitleEl.val());
langSnippetEl.val(inputSnippetEl.val())}}$(this).removeClass("initial set-bound")});editSnippetEl.find(".save-snippet-trigger").on("click",function(ev){editSnippetEl.find(".language_id").addClass("set-bound").trigger("change");
Orb.cancelEvent(ev);var snippet=self.editingSnippet;var oldShortcutCode=snippet.shortcut_code;snippet.category_id=editSnippetEl.find("select.category_id").val();
editSnippetEl.find(".lang-bound-title").each(function(){var langId=$(this).data("language-id");var value=$(this).val();
var found=false;for(var i=0;i<snippet.title.length;i++){if(snippet.title[i].language_id==langId){snippet.title[i].value=value;
found=true;break}}if(!found){snippet.title.push({language_id:langId,value:value})}});editSnippetEl.find(".lang-bound-snippet").each(function(){var langId=$(this).data("language-id");
var value=$(this).val();var found=false;for(var i=0;i<snippet.snippet.length;i++){if(snippet.snippet[i].language_id==langId){snippet.snippet[i].value=value;
found=true;break}}if(!found){snippet.snippet.push({language_id:langId,value:value})}});snippet.shortcut_code=editSnippetEl.find(".shortcut_code").val();
editSnippetEl.find(".overlay-footer").addClass("loading");self.snippetDriver.saveSnippet(snippet,function(snippet){var myLangId=DESKPRO_PERSON_LANG_ID;
var showLangId=self.getEl("show_language_id").val();snippet.title_use=self.pickLangText(snippet.title,myLangId,showLangId);
snippet.snippet_use=self.pickLangText(snippet.snippet,myLangId,showLangId);editSnippetEl.find(".overlay-footer").removeClass("loading");
self.snippetEditOverlay.close();var currentCatId=self.getEl("catlist").find(".on").data("category-id")||0;
var newList=$("<ul></ul>");newList.html(self.rowsTpl.render({snippets:[snippet]}));var row=newList.find("li").first();
if(!currentCatId||snippet.category_id==currentCatId){var exist=self.getEl("snippet_list").find(".snippet-"+snippet.id);
if(exist[0]){exist.replaceWith(row)}else{self.getEl("snippet_list").prepend(row)}}var newShortcutCode=snippet.shortcut_code;
if(self.snippet_typename=="tickets"){if(oldShortcutCode){delete window.DESKPRO_TICKET_SNIPPET_SHORTCODES[oldShortcutCode]
}if(newShortcutCode){window.DESKPRO_TICKET_SNIPPET_SHORTCODES[newShortcutCode]=snippet.id}}else{if(self.snippet_typename=="chat"){if(oldShortcutCode){delete window.DESKPRO_CHAT_SNIPPET_SHORTCODES[oldShortcutCode]
}if(newShortcutCode){window.DESKPRO_CHAT_SNIPPET_SHORTCODES[newShortcutCode]=snippet.id}}}},function(){editSnippetEl.find(".overlay-footer").removeClass("loading")
})});editSnippetEl.find(".delete-snippet-trigger").on("click",function(ev){var snippet=self.editingSnippet;
editSnippetEl.find(".overlay-footer").addClass("loading");self.snippetDriver.deleteSnippet(snippet.id,function(snippet_id){editSnippetEl.find(".overlay-footer").removeClass("loading");
self.snippetEditOverlay.close();var exist=self.getEl("snippet_list").find(".snippet-"+snippet_id);exist.remove()
},function(){editSnippetEl.find(".overlay-footer").removeClass("loading")})});var varSel=editSnippetEl.find(".variables-select");
editSnippetEl.find(".variables-insert-btn").on("click",function(){var text="{{ "+varSel.val()+" }}";if(textarea.data("redactor")){textarea.data("redactor").insertHtml(DP.convertTextToWysiwygHtml(text,false))
}else{var pos=textarea.getCaretPosition();if(!pos){textarea.setCaretPosition(0)}textarea.insertAtCaret(text)
}});this.snippetEditOverlay=new DeskPRO.UI.Overlay({contentElement:editSnippetEl,zIndex:30010})},editSnippet:function(snippet){if(!snippet){snippet={id:0,category_id:this.getEl("catlist").find(".on").data("category-id")||this.getEl("catlist").find("li").eq(1).data("category-id"),shortcut_code:"",title:[],snippet:[]}
}this.editingSnippet=snippet;var editSnippetEl=this.getEl("edit_snippet");editSnippetEl.find("input, textarea").val("");
editSnippetEl.find("input.snippet_id").val(snippet.id);editSnippetEl.find("select.category_id").val(snippet.category_id);
editSnippetEl.find("input.shortcut_code").val(snippet.shortcut_code);Array.each(snippet.title,function(trans){editSnippetEl.find("input.title.lang-"+trans.language_id).val(trans.value)
});Array.each(snippet.snippet,function(trans){editSnippetEl.find("input.snippet.lang-"+trans.language_id).val(trans.value)
});editSnippetEl.find(".language_id").addClass("initial").trigger("change");if(snippet.id){editSnippetEl.find(".delete-link-wrap").show()
}else{editSnippetEl.find(".delete-link-wrap").hide()}this.snippetEditOverlay.open()}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page");
DeskPRO.Agent.PageFragment.Page.Ticket=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="ticket";this.wrapper=null;this.changeManager=null;this.valueForm=null;this.layout=null;
this.popout=null;this.popout_overview=null;this.isMouseOverPopout=false;this.hasInitPopout=false;this.popoutPage=null;
this.lastActiveDate=null;this.ticketReplyBox=null},getAlertId:function(){return"ticket-row-"+this.meta.ticket_id
},initMetaData:function(){DeskPRO_Window.recentTabs.add("tickets",this.meta.ticket_id,this.meta.title,BASE_URL+"agent/tickets/"+this.meta.ticket_id)
},initPage:function(el){this.wrapper=el;var self=this;this.getEl("replybox_wrap").data("page",this);this.hasReplyFocused=false;
if(this.getEl("linked_count").data("count")=="0"){this.getEl("linked_wrap_tab").hide()}try{var flashEnabled=!!(navigator.mimeTypes["application/x-shockwave-flash"]||window.ActiveXObject&&new ActiveXObject("ShockwaveFlash.ShockwaveFlash"));
if(flashEnabled){window.setTimeout(function(){self.wrapper.find(".copy-btn").each(function(){var btnEl=this;
var btn=$(this);try{var clip=new ZeroClipboard(this,{btnEl:this,savePuffEl:self.getEl("idref_switch")});
clip.on("mouseover",function(client,args){$(client.options.btnEl).addClass("over")});clip.on("mouseout",function(client,args){$(client.options.btnEl).removeClass("over")
});clip.on("complete",function(client,args){DeskPRO_Window.util.showSavePuff($(this).closest(".id-number"))
});self.addEvent("destroy",function(){try{clip.unglue(btnEl)}catch(e){}});self.addEvent("activate",function(){try{clip.reposition()
}catch(e){}})}catch(e){}})},100)}else{this.wrapper.find(".copy-btn").remove()}}catch(e){this.wrapper.find(".copy-btn").remove()
}this.valueForm=$("form.value-form:first",this.wrapper);this.valueForm.on("submit",function(ev){ev.preventDefault()
});this.changeManager=new DeskPRO.Agent.Ticket.ChangeManager(this);this.changeManager.addEvent("updateResult",function(data){self.clearAlerts();
DeskPRO_Window.getMessageBroker().sendMessage("agent.ui.ticket_updated",{ticket_id:self.meta.ticket_id});
if(data.data&&!data.data.can_view){self.closeSelf()}if(data.data&&data.data.refresh){DeskPRO_Window.loadPage(BASE_URL+"agent/tickets/"+self.getMetaData("ticket_id"),{ignoreExist:true});
self.closeSelf()}});this.changePic=new DeskPRO.Agent.PageFragment.Page.PersonHelper.ChangePic(this,{loadUrl:BASE_URL+"agent/people/"+this.meta.person_id+"/change-picture-overlay",saveUrl:BASE_URL+"agent/people/"+this.meta.person_id+"/ajax-save"});
this.ownObject(this.changePic);this.ticketFields=new DeskPRO.Agent.PageHelper.TicketFields(this);this.ownObject(this.ticketFields);
this._initMessage(this.wrapper.find(".messages-wrap"));this.getEl("value_form").find(".language_id").on("change",function(){var langId=$(this).val();
if(!langId){langId=DESKPRO_DEFAULT_LANG_ID}var langLocale=DESKPRO_NAME_REGISTRY.lang_data[langId].locale;
var langTitle=$.trim(DESKPRO_NAME_REGISTRY.lang_data[langId].title);self.getEl("message_page_wrap").find(".translate-from-lang").each(function(){$(this).text(langTitle).data(langLocale)
})});this._initTicketActionsMenu();this._initMessageActionsMenu();this._initLabels();this._initTicketLocking();
this._initTasks();this._initEditName();this._initSlas();var emailText=this.getEl("user_email_text");var emailChangeTrig=this.getEl("user_email_menu_trigger");
var emailChangeMenu=this.getEl("user_email_menu");var emailChangeBackdrop=null;if(emailChangeTrig[0]){var closeEmailChangeMenu=function(){emailChangeBackdrop.hide();
emailChangeMenu.hide()};var updateEmailChangePos=function(){var pos=emailChangeTrig.offset();emailChangeMenu.css({left:pos.left+3,top:pos.top+32})
};var openEmailChangeMenu=function(){if(!emailChangeBackdrop){emailChangeBackdrop=$('<div class="backdrop"></div>');
emailChangeBackdrop.appendTo("body");emailChangeBackdrop.on("click",function(ev){ev.stopPropagation();
closeEmailChangeMenu()});emailChangeMenu.detach().appendTo("body");emailChangeMenu.find("li").on("click",function(ev){ev.preventDefault();
var item=$(this);var emailId=item.data("email-id");var text=item.text().trim();emailText.text(text);closeEmailChangeMenu();
$.ajax({url:BASE_URL+"agent/tickets/"+self.meta.ticket_id+"/ajax-change-email.json",data:{email_id:emailId},dataType:"json",type:"POST"})
})}emailChangeBackdrop.show();updateEmailChangePos();emailChangeMenu.show()};emailChangeTrig.on("click",function(ev){ev.preventDefault();
openEmailChangeMenu()})}this.billing=new DeskPRO.Agent.PageHelper.TicketBilling(this.getEl("billing_wrap"),this.meta.baseId,{auto_start_bill:this.meta.auto_start_bill});
this.addEvent("deactivate",function(){$("form.ticket-reply-form",this.getEl("replybox_wrap")).trigger("page_deactivate")
});this.addEvent("activate",function(){$("form.ticket-reply-form",this.getEl("replybox_wrap")).trigger("page_activate")
});this.addEvent("destroy",function(){if(self.meta.unlockOnClose&&self.getEl("locked_message").data("locked-self")){$.ajax({url:BASE_URL+"agent/tickets/"+self.meta.ticket_id+"/release-lock.json",type:"POST"})
}},false,false,true);if(this.meta.ticket_perms["delete"]){this.wrapper.on("click","button.undelete-trigger",this.doTicketUndelete.bind(this));
this.wrapper.on("click","button.unspam-trigger",this.doTicketUnspam.bind(this))}DeskPRO_Window.getMessageBroker().sendMessage("ui.ticket.opened",{ticketId:this.getMetaData("ticket_id")});
DeskPRO_Window.getMessageBroker().sendMessage("ui.tab.opened",{type:"tickets",id:this.getMetaData("ticket_id")});
DeskPRO_Window.getMessageBroker().addMessageListener("tickets.deleted",(function(ticket_ids){if(ticket_ids.indexOf(this.getMetaData("ticket_id"))!==-1){DeskPRO_Window.removePage(this)
}}).bind(this),this.pageUid);DeskPRO_Window.getMessageBroker().addMessageListener("agent.ui.reload",function(info){self.getReplyTextArea().trigger("dp_autosave_trigger")
});this.addEvent("shortcutFocusReply",function(ev){ev.preventDefault();if(!self.meta.ticket_reverse_order){self.wrapper.find("div.layout-content").trigger("goscrollbottom")
}self.focusOnReply()});this.addEvent("shortcutOpenSnippets",function(ev){ev.preventDefault();self.shortcutOpenSnippets()
});this.addEvent("shortcutSendReply",function(ev){ev.preventDefault();self.shortcutSendReply()});this.addEvent("shortcutReplySetAwaitingUser",function(ev){ev.preventDefault();
self.shortcutReplySetAwaitingUser()});this.addEvent("shortcutReplySetAwaitingAgent",function(ev){ev.preventDefault();
self.shortcutReplySetAwaitingAgent()});this.addEvent("shortcutReplySetResolved",function(ev){ev.preventDefault();
self.shortcutReplySetResolved()});this.addEvent("shortcutReplyOpenProperties",function(ev){ev.preventDefault();
self.shortcutReplyOpenProperties()});this.addEvent("openUserProfile",function(ev){ev.preventDefault();
self.getEl("profile_link").trigger("click")});this.addEvent("openOrgProfile",function(ev){ev.preventDefault();
self.getEl("org_link").trigger("click")});if(this.meta.ticket_perms.modify_merge){this.merge=new DeskPRO.Agent.Widget.Merge({tabType:"ticket",metaId:self.meta.ticket_id,metaIdName:"ticket_id",trigger:$(".merge-menu-trigger",this.wrapper),overlayUrl:BASE_URL+"agent/tickets/{id}/merge-overlay/{other}",mergeUrl:BASE_URL+"agent/tickets/{id}/merge/{other}",loadRoute:"ticket:"+BASE_URL+"agent/tickets/{id}",overlayLoaded:function(overlay,merge){overlay.getWrapper().find(".ticket-finder").bind("ticketsearchboxclick",function(ev,ticketId,subject,sb){sb.close();
$.ajax({url:merge._getOverlayUrl(merge.options.metaId,ticketId),type:"get",dataType:"html",success:function(html){merge.resetOverlay(html)
}})})}});this.ownObject(this.merge);this.mergeMenu=new (function(){var menuEl=null;var menuElInner=null;
var backEl=null;var hasInitUserTickets=false;var lastOvers=null;var lastOverId=null;var updateOverHighlight=function(ticketId){removeLastOverHighlight();
if(!DeskPRO_Window.sections.tickets_section||!DeskPRO_Window.sections.tickets_section.isVisible()){return
}var searchListEl=DeskPRO_Window.sections.tickets_section.getListElement();lastOverId=ticketId;lastOvers=searchListEl.find(".ticket-"+ticketId);
lastOvers=lastOvers.add($("#tabNavigationPane").find(".ticket-"+ticketId));lastOvers.addClass("item-hover-over")
};var removeLastOverHighlight=function(){if(lastOvers){lastOvers.removeClass("item-hover-over")}lastOvers=null;
lastOverId=null};var renderTicketOption=function(ticket){var row=$("<li><time></time><a><strong></strong><span></span></a></li>");
row.data("ticket-id",ticket.id);row.addClass("ticket-"+ticket.id+" ticket");row.find("strong").text(ticket.id);
row.find("span").text(ticket.subject);var d=new Date(ticket.last_activity*1000);row.find("time").attr("datetime",d.toISOString()).timeago();
row.on("mouseover",function(){updateOverHighlight(ticket.id)}).on("mouseout",function(){if(lastOverId&&lastOverId==ticket.id){removeLastOverHighlight()
}});return row.get(0)};var refreshOpenTickets=function(){var append=[];Array.each(DeskPRO_Window.getTabWatcher().findTabType("ticket"),function(tab){var id=tab.page.getMetaData("ticket_id");
if(id&&id!=self.meta.ticket_id){var row=renderTicketOption({id:id,subject:tab.title,last_activity:tab.page.getMetaData("last_activity")});
append.push(row)}});if(append.length){menuEl.find(".open-tickets").show().find("ul").empty().append($(append))
}else{menuEl.find(".open-tickets").hide().find("ul").empty()}};var refreshUserTickets=function(){$.ajax({url:BASE_URL+"agent/ticket-search/quick-search",data:{person_id:self.meta.person_id},dataType:"json",success:function(data){var append=[];
Array.each(data,function(t){if(t.id&&t.id!=self.meta.ticket_id){var row=renderTicketOption(t);append.push(row)
}});if(append.length){menuEl.find(".users-tickets").show().find("ul").empty().append($(append))}else{menuEl.find(".users-tickets").hide().find("ul").empty()
}}})};var refreshFilterResults=function(){if(!DeskPRO_Window.sections.tickets_section||!DeskPRO_Window.sections.tickets_section.isVisible()){menuEl.find(".filter-tickets").hide().find("ul").empty();
return}var searchListEl=DeskPRO_Window.sections.tickets_section.getListElement();var append=[];searchListEl.find(".row-item").each(function(){var el=$(this);
var t={id:el.data("ticket-id"),subject:$.trim(el.find(".subject").text()),last_activity:parseInt(el.data("ticket-lastactivity"))};
if(!t.id){return}if(t.id&&t.id!=self.meta.ticket_id){var row=renderTicketOption(t);append.push(row)}});
if(append.length){menuEl.find(".filter-tickets").show().find("ul").empty().append($(append))}else{menuEl.find(".filter-tickets").hide().find("ul").empty()
}};var openMenu=function(atEl){var tmp;if(!menuEl){menuEl=$("<div/>");menuEl.addClass("dp-popover");menuEl.css("width",500);
menuElInner=$("<div/>").addClass("dp-popover-inner");menuElInner.appendTo(menuEl);backEl=$("<div/>");
backEl.addClass("dp-popover-backdrop");tmp=$("<div/>").html("<section><header><strong>"+self.meta.lang.find_ticket+'</strong></header><article style="padding: 6px;"><button class="trigger-search dp-btn dp-btn-small">'+self.meta.lang.search+"</button></article></section>");
tmp.addClass("search-tickets");tmp.appendTo(menuElInner);tmp=$("<div/>").html("<section><header><strong>"+self.meta.lang.users_tickets+"</strong></header><article><ul></ul></article></section>");
tmp.addClass("users-tickets").hide();tmp.appendTo(menuElInner);tmp=$("<div/>").html("<section><header><strong>"+self.meta.lang.open_tickets+"</strong></header><article><ul></ul></article></section>");
tmp.addClass("open-tickets").hide();tmp.appendTo(menuElInner);tmp=$("<div/>").html("<section><header><strong>"+self.meta.lang.filter_results+"</strong></header><article><ul></ul></article></section>");
tmp.addClass("filter-tickets").hide();tmp.appendTo(menuElInner);menuEl.find(".trigger-search").on("click",function(ev){Orb.cancelEvent(ev);
self.merge.open();closeMenu()});menuEl.on("click","li",function(ev){Orb.cancelEvent(ev);closeMenu();self.merge.openWithId($(this).data("ticket-id"))
});backEl.on("click",function(ev){Orb.cancelEvent(ev);closeMenu()});menuEl.appendTo("body");backEl.appendTo("body")
}if(!hasInitUserTickets){hasInitUserTickets=true;refreshUserTickets()}window.setTimeout(function(){refreshOpenTickets()
},1);window.setTimeout(function(){refreshFilterResults()},1);var maxH=parseInt(($(window).height()/2)-40);
menuEl.find(".dp-popover-inner").css("max-height",maxH);menuEl.show();menuEl.position({of:atEl,my:"center top",at:"center bottom",collision:"flipfit"});
backEl.show()};var closeMenu=function(){menuEl.hide();backEl.hide();removeLastOverHighlight()};self.wrapper.find(".merge-menu-trigger").on("click",function(ev){Orb.cancelEvent(ev);
openMenu($(this))});this.destroy=function(){if(menuEl){menuEl.detach()}if(backEl){backEl.detach()}}})()
}this.addEvent("deactivate",function(){if(self.ticketReplyBox&&self.ticketReplyBox.textarea){self.ticketReplyBox.textarea.trigger("dp_autosave_trigger")
}});$("form.ticket-reply-form",this.getEl("replybox_wrap")).bind("replyboxsubmit",this.handleReplySave.bind(this));
this.ticketActions=new DeskPRO.Agent.PageFragment.Page.Ticket.TicketActions(this);this.ownObject(this.ticketActions);
if(this.meta.isLocked){this.ticketLocked=new DeskPRO.Agent.PageFragment.Page.Ticket.TicketLocked(this);
this.ownObject(this.ticketLocked)}$(".agent-link.other-agent",this.El).on("click",function(){DeskPRO_Window.sections.agent_chat_section.newChatWindow([$(this).data("agent-id")])
});this.getEl("newtask").on("click",function(ev){ev.preventDefault();DeskPRO_Window.newTaskLoader.open()
});this.ticketFields.updateDisplay();this.wrapper.find(".lock-overlay").on("click",function(ev){ev.preventDefault();
self.showLockAlert()});this.getEl("idref_switch").on("click",function(){if($(this).hasClass("refmode")){$(this).removeClass("refmode");
self.getEl("ref_num").hide();self.getEl("id_num").show()}else{$(this).addClass("refmode");self.getEl("id_num").hide();
self.getEl("ref_num").show()}});DeskPRO.ElementHandler_Exec(this.wrapper);var messageboxTabs=this.getEl("messagebox_tabs").data("simpletabs");
if(messageboxTabs){messageboxTabs.addEvent("tabSwitch",function(evData){var type=evData.tabEl.data("list-type");
if(type=="messages"){self.getEl("messages_wrap").removeClass("show-log");self.getEl("messages_wrap").find("article.content-message").show()
}else{if(type=="feedback"){self.getEl("messages_wrap").removeClass("show-log");self.getEl("messages_wrap").find("article.content-message").show().not("article.with-feedback").hide()
}else{if(type=="log"){self.refreshLogTypes()}}}})}this.getEl("people_box_agent").find(".select2-container-multi").css("width","90%").find("input.select2-input").css("width","90%");
if(this.getEl("field_errors").hasClass("on")){this.wrapper.addClass("field-error");this.ticketFields.openEditMode()
}var messagePageWrap=this.getEl("message_page_wrap");var messagesWrap=this.getEl("messages_wrap");this.getEl("message_prev_page").on("click",function(ev){ev.preventDefault();
if(self.meta.ticket_reverse_order){var p=parseInt(messagesWrap.data("page"))-1}else{var p=parseInt(messagesWrap.data("page"))+1
}self.loadMessagePage(p)});this.getEl("message_next_page").on("click",function(ev){ev.preventDefault();
if(self.meta.ticket_reverse_order){var p=parseInt(messagesWrap.data("page"))+1}else{var p=parseInt(messagesWrap.data("page"))-1
}self.loadMessagePage(p)});var head=this.getEl("properties_header");var st=head.find("nav").data("simpletabs");
if(st){st.addEvent("tabSwitch",function(evData){var id=$(evData.tabEl).attr("id")||"";if(id&&id.indexOf("fields_display_main_wrap_tab")!==-1){head.removeClass("controls-off")
}else{head.addClass("controls-off")}})}this.getEl("cc_list_btn").on("click",function(ev){ev.preventDefault();
if(self.getEl("cc_list").hasClass("cc-open")){if(!self.getEl("cc_row_list").find("li")[0]){self.getEl("cc_list").hide().removeClass("cc-open")
}else{self.getEl("cc_list").find(".addrow").toggle()}}else{self.getEl("cc_list").show().addClass("cc-open");
self.getEl("cc_list").find(".addrow").show()}});var logsWrap=this.getEl("logs_wrap");logsWrap.on("click",".trigger-update-filter",function(ev){Orb.cancelEvent(ev);
var logsNav=logsWrap.find("nav").first();var filter=$(this).data("typename");var postData=[];if(filter&&filter!="all"){postData.push({name:"filter",value:filter})
}postData.push({name:"page",value:1});logsNav.addClass("dp-loading-on");if(filter=="attach"){$.ajax({url:BASE_URL+"agent/tickets/"+self.meta.ticket_id+"/load-attach-list",data:postData,complete:function(){logsNav.removeClass("dp-loading-on")
},success:function(html){logsWrap.html(html);self.updateUi()}})}else{$.ajax({url:BASE_URL+"agent/tickets/"+self.meta.ticket_id+"/load-logs",data:postData,complete:function(){logsNav.removeClass("dp-loading-on")
},success:function(html){logsWrap.html(html);self.updateUi()}})}});logsWrap.on("click",".trigger-next-page",function(ev){var btn=$(this);
var logsNav=logsWrap.find("nav").first();var filter=logsNav.data("filter");var page=logsNav.data("page");
var postData=[];if(filter&&filter!="all"){postData.push({name:"filter",value:filter})}if(page){page++;
postData.push({name:"page",value:page})}logsNav.addClass("dp-loading-on");btn.addClass("dp-loading-on");
$.ajax({url:BASE_URL+"agent/tickets/"+self.meta.ticket_id+"/load-logs",data:postData,complete:function(){logsNav.removeClass("dp-loading-on");
btn.remove()},success:function(html){var el=$(html);var newNav=el.find("nav").first();var newPage=el.find(".logs-page").first();
DeskPRO_Window.initInterfaceServices(newPage);logsNav.replaceWith(newNav);logsWrap.append(newPage);self.updateUi()
}})});logsWrap.on("click",".expand",function(ev){var expandBtn=$(this);var el=expandBtn.closest(".log-row");
if(!el[0]){return}Orb.cancelEvent(ev);var sel=".expand-set";if($(this).data("set")){sel=$(this).data("set")
}var expandEl=$(sel,el);if(expandEl.is(":visible")){expandEl.slideUp();expandBtn.removeClass("open")}else{expandEl.slideDown();
expandBtn.addClass("open")}})},setTicketReplyBox:function(rb){var isFirst=this.ticketReplyBox?false:true;
if(this.ticketReplyBox){this.ticketReplyBox.destroy();this.ticketReplyBox=null}this.ticketReplyBox=rb;
if(isFirst&&this.meta.ticket_reverse_order){this.focusOnReply()}},loadMessagePage:function(page,noShowLoading){var messagePageWrap=this.getEl("message_page_wrap");
var messagesWrap=this.getEl("messages_wrap");var reload=false;if(!page){reload=true;page=parseInt(messagesWrap.data("page"))
}var loadDiv=false;if(!noShowLoading){loadDiv=$('<div style="padding: 25px;"><div class="loading-icon-big">&nbsp;</div></div>');
if(!this.meta.ticket_reverse_order){messagePageWrap.empty()}messagePageWrap.append(loadDiv);this.updateUi()
}$.ajax({url:BASE_URL+"agent/tickets/"+this.meta.ticket_id+"/message-page/"+page,type:"GET",dataType:"html",context:this,success:function(html){if(loadDiv){loadDiv.remove()
}if(this.meta.ticket_reverse_order&&!reload){var div=$("<div></div>");div.html(html);this._initMessage(div.find("article.content-message"));
messagePageWrap.append(div)}else{messagePageWrap.empty();messagePageWrap.html(html);this._initMessage(messagePageWrap.find("article.content-message"))
}this.updateUi();var d=messagePageWrap.find("> div").first();if(d[0]){messagesWrap.data("page-count",d.data("page-count"));
messagesWrap.data("page",d.data("page"))}messagesWrap.data("page",page);var numPages=parseInt(messagesWrap.data("page-count"));
if(this.meta.ticket_reverse_order){if(page==numPages){this.getEl("message_next_page").hide()}else{this.getEl("message_next_page").show()
}}else{if(page==numPages){this.getEl("message_prev_page").hide()}else{this.getEl("message_prev_page").show()
}if(page==1){this.getEl("message_next_page").hide()}else{this.getEl("message_next_page").show()}}}})},refreshLogTypes:function(){var self=this;
var logsLi=this.getEl("messagebox_tabs").find(".logs");var logsWrap=this.getEl("logs_wrap");var logsNav=logsWrap.find("nav").first();
var isActive=logsLi.hasClass("on");if(!isActive||!logsLi.hasClass("dirty")){return}var filter=logsNav.data("filter");
var page=logsNav.data("page");var postData=[];if(filter&&filter!="all"){postData.push({name:"filter",value:filter})
}if(page&&page!=1){postData.push({name:"page",value:page});postData.push({name:"up_to_page",value:1})
}$.ajax({url:BASE_URL+"agent/tickets/"+self.meta.ticket_id+"/load-logs",data:postData,success:function(html){logsWrap.html(html);
self.updateUi()}})},showLockAlert:function(){DeskPRO_Window.showAlert("You are not allowed to make any changes to this ticket until it has been unlocked.")
},handleReplySave:function(ev,formData,handler){if(this.pauseSend){window.setTimeout((function(){this.handleReplySave(ev,formData,handler)
}).bind(this),250)}if(this.replySaveAjax){return}var self=this;var closetabTimeoutHit=false;var ajaxHit=false;
var hitRun=false;var reply_form=handler.el;formData.push({name:"client_messages_since",value:DeskPRO_Window.getLastClientMessageId()});
formData.push({name:"last_message_id",value:this.getLastMessageId()});formData.push({name:"last_log_id",value:this.getEl("messages_wrap").find(".log-row").last().data("log-id")});
if(this.getReplyTextArea()){this.getReplyTextArea().data("disable-autosave",true);if(this.getReplyTextArea().data("autosave-running")){this.getReplyTextArea().data("autosave-running").abort();
this.getReplyTextArea().data("autosave-running",null)}}var form=this.getEl("replybox_wrap").find(".ticket-reply-form");
var keepOpen=true;if(this.getEl("replybox_wrap").find('[name="options[close_tab]"]').prop("checked")){keepOpen=false
}var loadingEl=this.getEl("replybox_wrap").find(".ticket-sending-overlay");loadingEl.fadeIn();this.getEl("replybox_wrap").find("textarea.touched").removeClass("touched");
DeskPRO_Window.getMessageChanneler().poller.pause();function hitDone(){hitRun=true;DeskPRO_Window.getMessageChanneler().poller.unpause();
if(!keepOpen){self.closeSelf();if(self.getMetaData("goNextOnReply")){var listPage=DeskPRO_Window.getListPage();
if(listPage&&listPage.wrapper){console.log(listPage.wrapper);var ticketListEl=listPage.wrapper.find("article.row-item.ticket-"+self.getMetaData("ticket_id"));
if(ticketListEl.length){var next=ticketListEl.next("article.row-item");console.log(ticketListEl);console.log(next);
if(next.length){DeskPRO_Window.runPageRouteFromElement(next)}}}}return}var result=ajaxHit;if(!result.can_view){self.closeSelf();
return}if(result.refresh_tab){DeskPRO_Window.loadPage(BASE_URL+"agent/tickets/"+self.getMetaData("ticket_id"),{ignoreExist:true});
self.closeSelf()}loadingEl.hide();if(result.error&&result.error=="no_message"){DeskPRO_Window.showAlert("Please enter a message");
return}if(result.dupe_message){DeskPRO_Window.showAlert("You have already sent that message.");self.loadMessagePage(0,true);
return}self.handleTicketUpdate(result);if(DeskPRO_Window.sections.tickets_section&&DeskPRO_Window.sections.tickets_section.listPage){var row=DeskPRO_Window.sections.tickets_section.listPage.wrapper.find("article.ticket-"+self.meta.ticket_id);
if(row[0]&&!row.hasClass("removing")){DeskPRO_Window.sections.tickets_section.listPage.addTicket(self.meta.ticket_id,true)
}}}this.clearAlerts();this.replySaveAjax=$.ajax({url:reply_form.attr("action"),type:"POST",dataType:"json",data:formData,context:this,noErrorOverride:true,complete:function(){this.replySaveAjax=null;
DeskPRO_Window.getMessageChanneler().poller.unpause();this.getReplyTextArea().data("disable-autosave",false)
},error:function(event,xhr,ajaxOptions,errorThrown,force){DeskPRO_Window.getMessageChanneler().poller.unpause();
var loadingEl=this.getEl("replybox_wrap").find(".ticket-sending-overlay");loadingEl.hide();DeskPRO_Window._globalHandleAjaxError(event,xhr,ajaxOptions,errorThrown,force)
},success:function(result){DeskPRO_Window.getMessageChanneler().poller.unpause();if(result.client_messages){DeskPRO_Window.getMessageChanneler().handleMessageAjax(result.client_messages);
result.client_messages=null}if(result.error_messages){var prop=self.changeManager.getPropertyManager("status");
self.changeManager.setInstantChange(prop,"awaiting_agent");var list=self.getEl("field_errors").find("ul").empty();
Array.each(result.error_messages,function(msg){var li=$("<li/>");li.text(msg);li.appendTo(list)});self.getEl("field_errors").show().addClass("on");
self.getEl("field_edit_start").click();self.getEl("field_edit_cancel").show();self.getEl("field_edit_save").show();
self.getEl("field_edit_controls").removeClass("loading");DeskPRO_Window.showAlert("Your reply was saved but the status was not set to resolved because of form errors. You should correct these errors and then you may set the status to resolved.");
keepOpen=true}if(result.notified_agents&&DeskPRO.Agent.Widget.AgentChatWin_Registry){Array.each(result.notified_agents,function(aid){aid=parseInt(aid);
Object.each(DeskPRO.Agent.Widget.AgentChatWin_Registry,function(v,k){if(v.agentIds.length==1&&v.agentIds.indexOf(aid)!==-1){v.loadLastConvo()
}})})}ajaxHit=result;hitDone()}})},getLastMessageId:function(){var id=this.getEl("messages_wrap").find("article.message").last().data("message-id");
return id||0},getLastLogId:function(){return parseInt($(".log-row",this.getEl("messages_wrap")).last().data("log-id")||0)
},destroyPage:function(){if(this.ticketReplyBox){this.ticketReplyBox.destroy();this.ticketReplyBox=null
}DeskPRO_Window.getMessageBroker().sendMessage("ui.ticket.closed",{ticketId:this.getMetaData("ticket_id")})
},handleTicketUpdate:function(data){var self=this;if(data.client_messages){DeskPRO_Window.getMessageChanneler().handleMessageAjax(data.client_messages)
}if(data.active_drafts){this.wrapper.find(".agent-draft-message").remove();if(data.active_drafts.length){var insertPos=this.wrapper.find(".ticket-messages .messages-wrap");
for(var i=0;i<data.active_drafts.length;i++){if(this.meta.ticket_reverse_order){insertPos.prepend(data.active_drafts[i])
}else{insertPos.append(data.active_drafts[i])}}}}if(!this.changeManager){return}var new_messages=null;
if(data.ticket_messages_block){new_messages=$(data.ticket_messages_block);var any=false;if(new_messages.hasClass("message")){if(!this.getEl("messages_wrap").find(".message-"+new_messages.data("message-id"))[0]){any=true
}}else{new_messages.find(".message").each(function(){if(self.getEl("messages_wrap").find(".message-"+$(this).data("message-id"))[0]){$(this).hide()
}else{any=true}})}if(any){this.wrapper.find(".agent-draft-message").remove();self.loadMessagePage(0,true)
}}if(data.updated_agent_parts_html){this.getEl("agent_part_list").html(data.updated_agent_parts_html);
$(".agent-part-count",this.wrapper).text(data.updated_agent_parts_count)}if(data.replybox_html){if(!this.getEl("replybox_wrap").find("textarea.touched")[0]){var textarea=this.getReplyTextArea();
if(textarea.data("redactor")){textarea.destroyEditor()}this.getEl("replybox_wrap").empty().append(data.replybox_html);
DeskPRO_Window.initInterfaceServices(this.getEl("replybox_wrap"));$("form.ticket-reply-form",this.getEl("replybox_wrap")).bind("replyboxsubmit",this.handleReplySave.bind(this))
}}if(typeof data.cc_list=="string"){this.wrapper.find("ul.cc-row-list").empty().html(data.cc_list)}var billing=this.billing;
if(billing.hasBilling){if(data.charge_html){billing.addBillingRow(data.charge_html);billing.updateBillingForm(true);
billing.resetBillingForm()}else{billing.updateBillingForm(false);billing.resetBillingForm()}}if(data.locked_by_agent_id&&data.locked_by_agent_id!=DESKPRO_PERSON_ID){DeskPRO_Window.loadPage(BASE_URL+"agent/tickets/"+self.getMetaData("ticket_id"),{ignoreExist:true});
self.closeSelf();return}else{this.wrapper.find(".lock-overlay").remove();this.getEl("locked_message").hide();
this.getEl("locked_message").data("locked-self",false);this.getEl("lock_ticket").show();this.getEl("unlock_ticket").hide()
}var props=["status","department_id","category_id","product_id","workflow_id","priority_id","urgency","is_hold"];
if(data.via_reply){if(data.changed_agent){props.push("agent_id")}if(data.changed_team){props.push("agent_team_id")
}}else{props.push("agent_id");props.push("agent_team_id")}Array.each(props,function(propId){var val="0";
if(data[propId]){val=data[propId]}var prop=this.changeManager.getPropertyManager(propId);prop.setIncomingValue(val)
},this);if(data.dupe_message){var sig=this.getEl("replybox_wrap").find("textarea.signature-value").val();
if(sig){sig="\n\n"+sig}var textarea=this.getReplyTextArea();if(textarea.data("redactor")){textarea.setCode(DP.convertTextToWysiwygHtml(sig,true))
}else{textarea.val(sig)}return}this.getEl("messagebox_tabs").find(".logs").addClass("dirty");this.refreshLogTypes()
},updateUi:function(toReplyHeight){var x;if(!this.IS_ACTIVE){return}if(this.wrapper){if(!this.scrollHandlers){this.scrollHandlers=this.wrapper.find("div.with-scroll-handler")
}for(x=0;x<this.scrollHandlers.length;x++){var sh=$(this.scrollHandlers[x]).data("scroll_handler");if(sh&&sh.updateSize){sh.updateSize()
}}if(this.doScrollBottom){this.wrapper.find("div.layout-content").trigger("goscrollbottom_stick");this.doScrollBottom=false
}else{if(toReplyHeight){var oWrap=this.wrapper.find("div.layout-content").first();oWrap.trigger("goscrollto",toReplyHeight+10)
}}this.getEl("labels_wrap").find(".select2-input").width("95%")}},_initMessage:function(messageEl){var self=this;
var imageEls=$("ul.attachment-list li.is-image a, a.dp-is-image",messageEl);DeskPRO_Window.initStickyTips(messageEl);
$(".timeago",messageEl).timeago();imageEls.colorbox({title:function(){if($(this).data("deskpro-url")){var url=$(this).data("deskpro-url")
}else{var url=$(this).attr("href")}var dl_url=Orb.appendQueryData(url,"dl","1");return'<a href="'+url+'" target="_blank">Open In New Window</a> | <a href="'+dl_url+'" target="_blank">Download</a>'
},onComplete:function(){var image=$("#cboxLoadedContent img");if(image.length){$("#cboxLoadedContent").append($("<a />").attr("href",$(this).attr("href")).attr("target","_blank").append(image))
}},width:"50%",height:"50%",initialWidth:"200",initialHeight:"150",scalePhotos:true,photo:true,opacity:0.5,transition:"none"});
var lastCount=0;if(this.lastMessageCount){lastCount=this.lastMessageCount}if(messageEl.hasClass("messages-wrap")){var articles=messageEl.find("article.content-message")
}else{var articles=messageEl.filter("article.content-message")}articles.each(function(){var article=$(this);
if(article.is(".agent-draft-message")){return}var fullEl=article.find(".body-text-full-message");if(fullEl[0]){var simpleEl=article.find(".body-text-message");
fullEl.find(".message-toggle-btn > em").on("click",function(ev){ev.preventDefault();fullEl.hide();simpleEl.show();
self._initTicketMessageClipped(article);self.updateUi()});simpleEl.find(".message-toggle-btn > em").on("click",function(ev){ev.preventDefault();
fullEl.show();simpleEl.hide();self.updateUi();if(!fullEl.hasClass("loaded")){var row=$(this).closest("article.content-message");
var message_id=row.data("message-id");$.ajax({url:BASE_URL+"agent/tickets/messages/"+message_id+"/get-full-message.json",type:"GET",success:function(data){row.find(".full-message-content").html(data.message_full);
self._initTicketMessageClipped(article);self.updateUi()}})}})}self._initTicketMessageClipped(article);
var trans=article.find(".message-translate-controls");if(trans[0]){var transShow=article.find(".body-message-translated");
var existTo=transShow.data("to-lang-code");var existFrom=transShow.data("from-lang-code");var transMenu=trans.find(".dp-lang-choose");
var transMenuBack=null;var transFromEl=trans.find(".translate-from-lang");var transToEl=trans.find(".translate-to-lang");
trans.on("click",".translate-controls-off",function(ev){Orb.cancelEvent(ev);trans.addClass("on")});trans.find(".dp-dropdown-toggle").on("click",function(ev){Orb.cancelEvent(ev);
if(!transMenu.hasClass("has-init")){transMenu.detach().appendTo("body");transMenu.addClass("has-init");
transMenuBack=$("<div/>").addClass("dp-popover-backdrop").hide().appendTo("body");self.addEvent("destroy",function(){transMenu.detach();
transMenuBack.detach()});transMenuBack.on("click",function(ev){Orb.cancelEvent(ev);transMenu.hide();transMenuBack.hide()
});transMenu.find("select").on("change",function(){var locale=$(this).val();var title=$(this).find(":selected").text();
if($(this).attr("name")=="from"){transFromEl.data("locale",locale).text(title)}else{transToEl.data("locale",locale).text(title)
}})}transMenu.css({top:0,left:0}).position({of:$(this),my:"right top",at:"right bottom",collision:"flipfit"}).show();
transMenuBack.show()});trans.find(".trans-trigger").on("click",function(ev){Orb.cancelEvent(ev);self.refreshMessageTranslation(article)
})}});this.lastMessageCount=lastCount;messageEl.find("img").bind("load",function(){var article=$(this).closest("article.content-message");
self._initTicketMessageClipped(article)});var wr=this.getEl("messages_wrap");wr.find(".message-id-txt").each(function(){var findclass=".message-counter-"+$(this).data("message-id");
var counterText=wr.find(findclass).text().trim();if(counterText.length){$(this).attr("title",$(this).text()).text(counterText).removeClass("message-id-txt")
}})},refreshMessageTranslation:function(messageEl){var trans=messageEl.find(".message-translate-controls");
var transShow=messageEl.find(".body-message-translated");var selFrom=trans.find(".translate-from-lang");
var selTo=trans.find(".translate-to-lang");var formData={message_id:messageEl.data("message-id"),from:selFrom.data("locale"),to:selTo.data("locale")};
selFrom.parent().find("em").text(selFrom.find(":selected").text());selTo.parent().find("em").text(selTo.find(":selected").text());
trans.addClass("dp-loading-on");$.ajax({url:window.DESKPRO_TRANSLATE_SERVICE.translate_ticket_message_url,data:formData,type:"POST",dataType:"json",complete:function(){trans.removeClass("dp-loading-on")
},success:function(data){if(data.error_code){DeskPRO_Window.showAlert("Could not translate message: "+data.message);
return}trans.removeClass("on");transShow.data("to-lang-code",data.to_lang_code);transShow.data("from-lang-code",data.from_lang_code);
transShow.empty().html(data.message);transShow.show();transShow.parent().addClass("with-translated")}})
},_initTicketMessageClipped:function(article){var h=article.find("div.body-text").height();if(h>=600){if(!article.hasClass("with-clipped-body")){article.addClass("with-clipped-body");
article.find(".fade-bar-longmsg").one("click",function(ev){ev.stopPropagation();article.addClass("clipped-show")
})}}else{if(article.hasClass("with-clipped-body")){article.removeClass("with-clipped-body")}}},incCount:function(id){var countEl=$("."+id+"-count",this.wrapper);
var count=countEl.data("count")+1;countEl.data("count",count).html("("+count+")")},setCount:function(id,count){var countEl=$("."+id+"-count",this.wrapper);
countEl.data("count",count).html("("+count+")")},appendToMessage:function(content,is_html){if(is_html){var textarea=this.getReplyTextArea();
if(textarea.data("redactor")){try{textarea.data("redactor").restoreSelection();textarea.data("redactor").setBuffer()
}catch(e){}var html=content;html=html.replace(/<\/p>\s*<p>/g,"<br/>");html=html.replace(/^<p>/,"");html=html.replace(/<\/p>$/,"");
textarea.data("redactor").insertHtml(html)}}else{this.insertTextInReply(content);if(!this.meta.ticket_reverse_order){this.wrapper.find("div.layout-content").trigger("goscrollbottom_stick")
}this.focusOnReply();this.getReplyTextArea().trigger("textareaexpander_fire")}},addAttachToList:function(attachInfo){var row=$(".template-download",this.getEl("replybox")).tmpl(attachInfo);
$(".file-list",this.getEl("replybox")).append(row);this.updateUi()},getPropertyManager:function(type,type_id){DP.console.error("Depreciated");
return this.changeManager.getPropertyManager(type,type_id)},_initLabels:function(){if(this.getEl("labels_input")[0]){this.labelsInput=new DeskPRO.UI.LabelsInput({type:"tickets",input:this.getEl("labels_input"),onChange:this.saveLabels.bind(this)});
this.ownObject(this.labelsInput)}},saveLabels:function(){if(this.changeManager.hasChanges()){return}if(this._saveLabelsTimeout){window.clearTimeout(this._saveLabelsTimeout)
}this._labelsData=this.labelsInput.getFormData();this._saveLabelsTimeout=this._doSaveLabels.delay(2000,this)
},_doSaveLabels:function(){var data=this._labelsData;$.ajax({url:this.getMetaData("labelsSaveUrl"),type:"POST",context:this,data:data,dataType:"json"})
},_initTicketLocking:function(){var self=this;$([this.getEl("unlock_ticket").get(0),this.getEl("unlock_ticket2").get(0)]).on("click",function(){self.wrapper.find(".hide-locked").removeClass("hide-locked");
self.wrapper.find(".lock-overlay").remove();self.getEl("locked_message").hide();self.getEl("locked_message").data("locked-self",false);
self.getEl("lock_ticket").show();self.getEl("unlock_ticket").hide();$.ajax({url:BASE_URL+"agent/tickets/"+self.meta.ticket_id+"/unlock-ticket.json",type:"POST",dataType:"json",complete:function(){}})
});this.getEl("lock_ticket").on("click",function(){self.wrapper.find(".lock-overlay").remove();self.getEl("locked_message").data("locked-self",true);
self.getEl("locked_message").show();self.getEl("locked_message_self").show();self.getEl("locked_message_other").hide();
self.getEl("lock_ticket").hide();self.getEl("unlock_ticket").show();$.ajax({url:BASE_URL+"agent/tickets/"+self.meta.ticket_id+"/lock-ticket.json",type:"POST",dataType:"json",success:function(data){if(data.error){DeskPRO_Window.showAlert("Someone else has already locked the ticket");
self.getEl("locked_message").hide();self.getEl("lock_ticket").show();DeskPRO_Window.loadPage(BASE_URL+"agent/tickets/"+self.getMetaData("ticket_id"),{ignoreExist:true});
self.closeSelf()}}})})},_initTicketActionsMenu:function(){var self=this;var removeMenu=new DeskPRO.UI.Menu({triggerElement:this.getEl("remove_menu_trigger"),menuElement:this.getEl("remove_menu"),onItemClicked:function(info){var it=$(info.itemEl);
var doBan=false;if(it.data("action").indexOf(".ban")!==-1){doBan=true}switch(it.data("action")){case"spam":case"spam.ban":self.doTicketSpam(doBan);
break;case"delete":case"delete.ban":self.showDeleteOverlay(doBan);break}}});var actionsMenu=new DeskPRO.UI.Menu({triggerElement:this.getEl("actions_menu_trigger"),menuElement:this.getEl("actions_menu"),onBeforeMenuOpened:function(info){var status=self.getEl("status_code").val();
if(status=="awaiting_agent"){if(self.getEl("value_form").find(".is_hold").val()){self.getEl("menu_unset_hold").show()
}else{self.getEl("menu_set_hold").show()}}else{self.getEl("menu_set_hold").hide();self.getEl("menu_unset_hold").hide()
}},onItemClicked:function(info){var it=$(info.itemEl);switch(it.data("action")){case"change-user":var changeUserOverlay=new DeskPRO.Agent.Widget.TicketChangeUser({ticketId:self.getMetaData("ticket_id"),destroyOnClose:true,onSuccess:function(data){self.closeSelf();
DeskPRO_Window.runPageRoute("ticket:"+BASE_URL+"agent/tickets/"+data.ticket_id);changeUserOverlay.close()
}});changeUserOverlay.open();break;case"split":self.showSplitOverlay("");break;case"print":window.print();
break;case"set-hold":self.setHold(true);break;case"unset-hold":self.setHold(false);break;case"linked_ticket":DeskPRO_Window.newTicketLoader.newLinkedTicket(self.meta.ticket_id);
break;case"kb-pending":if(!self.pendingKbOverlay){var el=self.getEl("pending_add");self.pendingKbOverlay=new DeskPRO.UI.Overlay({contentElement:self.getEl("pending_add")});
el.find(".save-new-trigger").on("click",function(ev){ev.preventDefault();var formData=el.find("input, textarea").serializeArray();
el.addClass("loading");$.ajax({url:el.data("save-url"),type:"POST",data:formData,dataType:"json",complete:function(){el.removeClass("loading")
},success:function(){self.pendingKbOverlay.close();el.find("textarea").val("")}})})}self.pendingKbOverlay.open();
break}}});this.getEl("unhold_btn").on("click",function(ev){ev.preventDefault();self.setHold(false)})},setHold:function(val){var prop=this.changeManager.getPropertyManager("is_hold");
this.changeManager.setInstantChange(prop,val?1:0)},_initDeleteOverlay:function(){if(this.deleteOverlay){return
}this.deleteOverlayEl=$(".delete-ticket-overlay:first",this.wrapper);this.deleteOverlay=new DeskPRO.UI.Overlay({contentElement:this.deleteOverlayEl});
this.ownObject(this.deleteOverlay);$(".save-trigger",this.deleteOverlayEl).on("click",(function(){this.doTicketDelete()
}).bind(this))},showDeleteOverlay:function(doBan){this._initDeleteOverlay();this.deleteOverlay.doBan=doBan;
if(doBan){this.getEl("delete_user_list").show()}else{this.getEl("delete_user_list").hide()}this.deleteOverlay.openOverlay()
},doTicketDelete:function(){$(".loading-off",this.deleteOverlayEl).hide();$(".loading-on",this.deleteOverlayEl).show();
var data=[];data.push({name:"reason",value:$(".delete-reason",this.deleteOverlayEl).val()});if(this.deleteOverlay.doBan){data.push({name:"ban",value:1})
}var self=this;$.ajax({url:BASE_URL+"agent/tickets/"+this.getMetaData("ticket_id")+"/delete",type:"POST",data:data,dataType:"json",success:function(data){self.deleteOverlay.closeOverlay();
self.getEl("remove_menu_trigger").hide();if(data.hidden_html){self.getEl("page_header").before($(data.hidden_html))
}else{DeskPRO_Window.removePage(self);DeskPRO_Window.loadPage(BASE_URL+"agent/tickets/"+self.getMetaData("ticket_id"),{ignoreExist:true})
}}})},doTicketSpam:function(doBan){var self=this;this.getEl("actions_loading").show();$.ajax({url:BASE_URL+"agent/tickets/"+this.getMetaData("ticket_id")+"/spam",type:"POST",dataType:"json",data:{ban:doBan?1:0},success:function(data){self.getEl("actions_loading").hide();
self.getEl("remove_menu_trigger").hide();if(data.hidden_html){self.getEl("page_header").before($(data.hidden_html))
}DeskPRO_Window.removePage(self)}})},doTicketUndelete:function(){var self=this;var prop=this.changeManager.getPropertyManager("status");
this.changeManager.setInstantChange(prop,"awaiting_agent",function(){DeskPRO_Window.removePage(self)})
},doTicketUnspam:function(){var self=this;var prop=this.changeManager.getPropertyManager("status");this.changeManager.setInstantChange(prop,"awaiting_agent",function(){DeskPRO_Window.removePage(self);
DeskPRO_Window.loadPage(BASE_URL+"agent/tickets/"+self.getMetaData("ticket_id"),{ignoreExist:true})})
},_initMessageActionsMenu:function(){var self=this;var menuElement=$(".ticket-message-edit-menu",this.wrapper);
this.messageActionsMenu=new DeskPRO.UI.Menu({triggerElement:null,menuElement:menuElement,onBeforeMenuOpened:function(info){var message=$(info.menu.getOpenTriggerElement()).closest("article.message");
if(message.hasClass("note-message")){menuElement.find("li.set-as-message").show();menuElement.find("li.set-as-note").hide()
}else{menuElement.find("li.set-as-message").hide();menuElement.find("li.set-as-note").show()}if(message.hasClass("with-attach")){menuElement.find("li.delete-attachments-link").show()
}else{menuElement.find("li.delete-attachments-link").hide()}},onItemClicked:function(info){var itemEl=$(info.itemEl);
var triggerEl=$(info.menu.getOpenTriggerElement());if(!triggerEl.hasClass("ticket-message-edit-btn")){triggerEl=triggerEl.closest(".ticket-message-edit-btn")
}self._doMessageAction(itemEl.data("option-id"),triggerEl.data("message-id"),itemEl)}});this.ownObject(this.messageActionsMenu);
var menu=this.messageActionsMenu;var wrap=$(".messages-wrap",this.wrapper)[0];$(".ticket-message-edit-btn",wrap).live("mousedown",function(event){var textarea=self.getReplyTextArea();
if(textarea.data("redactor")){$.proxy(function(){this.savedSel=this.getOrigin();this.savedSelObj=this.getFocus()
},textarea.data("redactor"))()}});$(".ticket-message-edit-btn",wrap).live("click",function(event){menu.openMenu(event)
})},_doMessageAction:function(optionId,messageId,itemEl){if(!messageId){return}switch(optionId){case"quote":var quote=$("textarea.message-quote-"+messageId,this.wrapper).val();
if(!quote){quote=""}var textarea=this.getReplyTextArea();if(textarea.data("redactor")){textarea.data("redactor").restoreSelection()
}this.insertTextInReply(quote.trim()+"\n");if(!this.meta.ticket_reverse_order){this.wrapper.find("div.layout-content").trigger("goscrollbottom")
}this.focusOnReply();break;case"delete":this.showDeleteMessageOverlay(messageId);break;case"delete-attachments":var self=this;
var overlay=new DeskPRO.UI.Overlay({contentMethod:"ajax",contentAjax:{url:BASE_URL+"agent/tickets/messages/"+messageId+"/attachments"},zIndex:40000,onAjaxDone:function(){var wrapper=overlay.getWrapper();
wrapper.on("click",".delete-trigger",function(e){e.preventDefault();var $this=$(this),attachmentId=$this.data("attachment-id");
var container=$this.closest(".overlay-content");var row=$this.closest(".attachment-row");if(!confirm(container.data("confirm"))){return
}row.addClass("loading");$.ajax({url:BASE_URL+"agent/tickets/messages/"+messageId+"/attachments/"+attachmentId+"/delete",type:"POST",dataType:"json"}).always(function(){row.removeClass("loading")
}).done(function(data){if(data.message_html){self.wrapper.find("article.message-"+messageId).replaceWith(data.message_html)
}row.remove();if(!container.find(".attachment-row").length){overlay.close()}})})}});overlay.open();break;
case"setnote.note":case"setnote.message":var is_note=optionId=="setnote.note"?"1":"0";var row=this.wrapper.find("article.message-"+messageId);
row.addClass("gear-loading");$.ajax({url:BASE_URL+"agent/tickets/messages/"+messageId+"/set-message-note.json",data:{is_note:is_note},complete:function(){row.removeClass("gear-loading")
},success:function(info){if(info.is_note){row.addClass("note-message")}else{row.removeClass("note-message")
}}});break;case"split":this.showSplitOverlay(messageId);break;case"linked_ticket":DeskPRO_Window.newTicketLoader.newLinkedTicket(this.meta.ticket_id,messageId);
break;case"fwd":this.showFwdOverlay(messageId);break;case"edit":this.showMessageEditor(messageId);break;
case"window":var url=itemEl.data("url");url=url.replace(/00000/g,this.meta.ticket_id);url=url.replace(/11111/g,messageId);
var width=780;var height=600;window.open(url,"msgwin","status=0,toolbar=0,location=0,menubar=0,directories=0,resizable=1,scrollbars=1,height="+height+",width="+width);
break;case"debug":var url=itemEl.data("url");url=url.replace(/00000/g,this.meta.ticket_id);var width=200;
var height=200;window.open(url,"debugwin","status=0,toolbar=0,location=0,menubar=0,directories=0,resizable=1,scrollbars=1,height="+height+",width="+width);
break}},_initDeleteMessageOverlay:function(){if(this.deleteMessageOverlay){return}this.deleteMessageOverlayEl=$(".delete-message-overlay:first",this.wrapper);
this.deleteMessageOverlay=new DeskPRO.UI.Overlay({contentElement:this.deleteMessageOverlayEl});this.ownObject(this.deleteMessageOverlay);
$(".save-trigger",this.deleteMessageOverlayEl).on("click",(function(){this.doTicketMessageDelete()}).bind(this))
},showDeleteMessageOverlay:function(messageId){this._initDeleteMessageOverlay();$(".message-id",this.deleteMessageOverlayEl).val(messageId);
this.deleteMessageOverlayEl.find(".ticket-messages").empty().html(this.wrapper.find("article.message-"+messageId).clone());
this.deleteMessageOverlayEl.find(".ticket-messages .edit-gear").remove();this.deleteMessageOverlay.openOverlay()
},doTicketMessageDelete:function(){$(".loading-off",this.deleteMessageOverlayEl).hide();$(".loading-on",this.deleteMessageOverlayEl).show();
var messageId=$(".message-id",this.deleteMessageOverlayEl).val();var self=this;$.ajax({url:BASE_URL+"agent/tickets/messages/"+messageId+"/delete",type:"POST",dataType:"json",success:function(data){self.deleteMessageOverlay.closeOverlay();
if(data.ticket_deleted){self.getEl("remove_menu_trigger").hide();if(data.hidden_html){var html=$(data.hidden_html);
self.getEl("page_header").before(html);html.closest(".with-scrollbar").trigger("goscrolltop")}else{DeskPRO_Window.removePage(self);
DeskPRO_Window.loadPage(BASE_URL+"agent/tickets/"+self.getMetaData("ticket_id"),{ignoreExist:true})}}else{self.wrapper.find("article.message-"+messageId).remove()
}}}).always(function(){$(".loading-off",this.deleteMessageOverlayEl).show();$(".loading-on",this.deleteMessageOverlayEl).hide()
})},showSplitOverlay:function(messageId){var self=this;var overlay=new DeskPRO.UI.Overlay({contentMethod:"ajax",contentAjax:{url:BASE_URL+"agent/tickets/"+this.meta.ticket_id+"/split/"+messageId},zIndex:40000,onAjaxDone:function(){var wrapper=overlay.getWrapper(),form=wrapper.find("form");
wrapper.on("click",".body-text",function(){var $this=$(this);if($this.find(".fade-bar").is(":visible")){$this.find(".fade-bar").hide();
$this.find(".body-text-message").css("max-height","")}else{$this.find(".fade-bar").show();$this.find(".body-text-message").css("max-height","70px")
}});wrapper.on("change",".message-id-checkbox",function(){var $this=$(this),container=$this.closest(".content-message");
if($this.is(":checked")){container.removeClass("message-unselected")}else{container.addClass("message-unselected")
}});wrapper.on("click",".content header",function(e){if($(e.target).is(".message-id-checkbox")){return
}var cb=$(this).find(".message-id-checkbox");cb.attr("checked",!cb.attr("checked"));cb.trigger("change")
});form.on("submit",function(e){e.preventDefault();form.addClass("loading");$.ajax({url:form.attr("action"),type:"POST",data:form.serializeArray(),dataType:"json"}).always(function(){form.removeClass("loading")
}).done(function(data){overlay.close();if(data.ticket_id){DeskPRO_Window.removePage(self);if(!data.old_ticket_deleted){DeskPRO_Window.loadPage(BASE_URL+"agent/tickets/"+self.getMetaData("ticket_id"),{ignoreExist:true})
}DeskPRO_Window.runPageRoute("ticket:"+BASE_URL+"agent/tickets/"+data.ticket_id)}})})}});overlay.open()
},showFwdOverlay:function(messageId){var self=this;var overlay=new DeskPRO.UI.Overlay({contentMethod:"ajax",contentAjax:{url:BASE_URL+"agent/tickets/"+this.meta.ticket_id+"/forward/"+messageId},zIndex:40000,destroyOnClose:true,onAjaxDone:function(){var wrapper=overlay.getWrapper(),form=wrapper.find("form"),sendBtn=wrapper.find(".save-trigger"),footer=wrapper.find(".overlay-footer");
form.on("submit",function(ev){ev.preventDefault();ev.stopPropagation()});sendBtn.on("click",function(ev){ev.preventDefault();
ev.stopPropagation();var formData=form.serializeArray();footer.addClass("loading");$.ajax({url:form.attr("action"),type:"POST",data:formData,dataType:"json",success:function(data){if(data.error&&data.error=="invalid_to"){DeskPRO_Window.showAlert("Please enter a valid To address");
footer.removeClass("loading")}else{DeskPRO_Window.showAlert("Your message has been sent.");overlay.close()
}}})})}});overlay.open()},showMessageEditor:function(message_id){var self=this;this.currentOpenMessageId=message_id;
if(!this.messageEditOverlay){var overlayEl=this.getEl("message_edit_overlay");overlayEl.find(".save-text-trigger").on("click",function(ev){ev.preventDefault();
$(this).hide();overlayEl.find(".save-text-loading").show();if(overlayEl.find("textarea.message_text").data("redactor")){overlayEl.find("textarea.message_text").data("redactor").syncCode()
}var postData={message_html:overlayEl.find("textarea.message_text").val()};$.ajax({url:BASE_URL+"agent/tickets/messages/"+self.currentOpenMessageId+"/save-message-text.json",type:"POST",data:postData,dataType:"json",complete:function(){overlayEl.find(".save-text-loading").hide();
overlayEl.find(".save-text-trigger").show()},success:function(info){self.messageEditOverlay.close();var messageHtml=info.message_html;
self.wrapper.find("article.message-"+self.currentOpenMessageId).find(".body-text-message").html(messageHtml)
}})});this.messageEditOverlay=new DeskPRO.UI.Overlay({contentElement:this.getEl("message_edit_overlay"),fullScreen:true,fullScreenMargin:55,onOverlayOpened:function(){overlayEl.find("input.message_id").val(self.currentOpenMessageId);
if(!self.messageEditOverlay.hasInitRte){self.messageEditOverlay.hasInitRte=true;overlayEl.find("textarea.message_text").height(overlayEl.find(".overlay-content").height()-50);
DeskPRO_Window.initRteAgentReply(overlayEl.find("textarea.message_text"),{autoresize:false})}overlayEl.find("textarea.message_text").setCode("Loading...");
$.ajax({url:BASE_URL+"agent/tickets/messages/"+self.currentOpenMessageId+"/get-message-text.json",dataType:"json",success:function(data){overlayEl.find("textarea.message_text").setCode(data.message_html)
}})}})}this.messageEditOverlay.open()},getReplyTextArea:function(){return this.getEl("replybox_wrap").find('textarea[name="message"]')
},insertTextInReply:function(text){var txt=this.getReplyTextArea();if(txt.data("redactor")){try{txt.data("redactor").restoreSelection();
txt.data("redactor").setBuffer()}catch(e){}var html=DP.convertTextToWysiwygHtml(text,true);html=html.replace(/<\/p>\s*<p>/g,"<br/>");
html=html.replace(/^<p>/,"");html=html.replace(/<\/p>$/,"");txt.data("redactor").insertHtml(html)}else{var pos=txt.getCaretPosition();
if(!pos){txt.setCaretPosition(0)}txt.insertAtCaret(text);txt.trigger("textareaexpander_fire")}},focusOnReply:function(){var txt=this.getReplyTextArea();
if(txt.data("redactor")){var first=!txt.hasClass("touched");txt.setFocus();if(first){var cursor=txt.data("redactor").$editor.find("> *").first();
txt.data("redactor").setSelection(cursor[0],0,cursor[0],0)}}else{txt.focus()}},doTicketUpdate:function(){if(this.doTicketUpdateRunning){this.doTicketUpdateRunning.abort();
this.doTicketUpdateRunning=null}var formData=[];formData.push({name:"last_message_id",value:this.getLastMessageId()});
formData.push({name:"last_log_id",value:this.getEl("messages_wrap").find(".log-row").last().data("log-id")});
this.doTicketUpdateRunning=$.ajax({url:BASE_URL+"agent/tickets/"+this.getMetaData("ticket_id")+"/update-views.json",type:"POST",dataType:"json",data:formData,context:this,success:function(result){this.alertTab();
this.handleTicketUpdate(result)}})},_initTasks:function(){var self=this;var openForEl=null;var menuVis2=this.getEl("task_menu_vis").clone().appendTo(this.wrapper);
var statusMenu=new DeskPRO.UI.Menu({menuElement:this.getEl("task_menu_vis"),onItemClicked:function(info){$("input.input-vis",openForEl).val($(info.itemEl).data("vis"));
$(".opt-trigger.visibility label",openForEl).text($(info.itemEl).text());sendUpdate(openForEl,"visibility",$(info.itemEl).data("vis"))
}});var sendUpdate=function(rowEl,prop,val,callback){var taskId=rowEl.data("task-id");if(!taskId){return
}var url=BASE_URL+"agent/tasks/"+taskId+"/ajax-save";var postData=[];postData.push({name:"action",value:prop});
postData.push({name:"value",value:val});$.ajax({url:url,type:"POST",data:postData,dataType:"json",success:callback||function(){}})
};var rowContainer=this.getEl("tasks_wrap");var openForEl=null;rowContainer.on("click",".remove-row-trigger",function(ev){var row=$(this).closest(".row-item");
if(confirm($(this).data("confirm"))){row.slideUp();$.ajax({url:BASE_URL+"agent/tasks/"+row.data("task-id")+"/delete",error:function(){row.show()
},success:function(){row.remove();if(DeskPRO_Window.sections.tasks_section){DeskPRO_Window.sections.tasks_section.refresh()
}}})}});rowContainer.on("click",".opt-trigger.visibility",function(ev){openForEl=$(this).closest(".row-item");
statusMenu.open.open(ev)});rowContainer.find("li.assigned_agent select.agents_sel").each(function(){$(this).addClass("has-init");
var row=$(this).closest(".row-item");DP.select($(this));$(this).on("change",function(){var val=$(this).val();
var label=$(this).find(":selected").text().trim();if(!val){val="";label="Me"}row.find(".assigned_agent").find("label").text(label);
$("input.input-agent",row).val(val);sendUpdate(row,"assigned",val,function(){DeskPRO_Window.getMessageBroker().sendMessage("agent.ui.tasks.refresh-task-list")
})})});rowContainer.on("click",".opt-trigger.date_due",function(ev){var label=$("label",this);var row=$(this).closest(".row-item");
var field=$("input.input-date-due",row);var date=$("input.input-date-due",row).val();if(!date){date=new Date()
}field.datepicker("dialog",date,function(date,inst){sendUpdate(row,"date_due",date);$("input.input-date-due",row).val(date);
label.text(date)},{dateFormat:"yy-mm-dd",showButtonPanel:true,beforeShow:function(input){setTimeout(function(){var buttonPane=$(input).datepicker("widget").find(".ui-datepicker-buttonpane");
$("button",buttonPane).remove();var btn=$('<button class="ui-datepicker-current ui-state-default ui-priority-secondary ui-corner-all" type="button">Clear</button>');
btn.unbind("click").bind("click",function(){$.datepicker._clearDate(input);label.text("No due date")});
btn.appendTo(buttonPane);$(input).datepicker("widget").css("z-index",30101)},1)}},ev)});this.getEl("task_save").on("click",function(ev){ev.preventDefault();
if($(this).hasClass("saving")){return}var title=$.trim(self.getEl("newtask_title").val());if(!title){alert("Please enter a description");
return}$(this).addClass("saving").html("<em>Saving</em>");var postData=self.getEl("task_row").find("input").serializeArray();
postData.push({name:"from_ticket",value:1});$.ajax({url:BASE_URL+"agent/tasks/save",data:postData,type:"POST",dataType:"json",complete:function(){self.getEl("task_save").removeClass("saving").text("Add")
},success:function(data){updateTaskPane();self.getEl("newtask_title").val("");if(!data.tasks||!data.tasks[0]){return
}data=data.tasks[0];var row=$(data.row_html);row.find("li.assigned_agent select.agents_sel").each(function(){$(this).addClass("has-init");
var row=$(this).closest(".row-item");DP.select($(this));$(this).on("change",function(){var val=$(this).val();
var label=$(this).find(":selected").text().trim();if(!val){val="";label="Me"}row.find(".assigned_agent").find("label").text(label);
$("input.input-agent",row).val(val)})});self.getEl("task_list").show().prepend(row);DeskPRO_Window.util.modCountEl(self.getEl("task_count"),"+",1);
if(DeskPRO_Window.sections.tasks_section){DeskPRO_Window.sections.tasks_section.refresh()}}})});var control=new DeskPRO.Agent.PageHelper.TaskListControl(this.wrapper,{menuVis:menuVis2,completeCountEl:null});
control.addEvent("updateUi",function(){self.updateUi();updateTaskPane()});control.addEvent("updateCount",function(){updateTaskPane()
});var updateTaskPane=function(){if(DeskPRO_Window.sections.tasks_section){DeskPRO_Window.sections.tasks_section.markUnloadPage()
}}},_initSlas:function(){var self=this;var form=this.getEl("sla_form");var idSelect=form.find("select[name=sla_id]");
var rows=this.getEl("sla_rows");var tabHeader=this.getEl("sla_wrap_tab");var addSlaRow=function(html){var add=$(html);
rows.append(add);add.find(".timeago").timeago();rows.closest("table").show();tabHeader.append($("<span />").addClass("sla-pip").addClass(add.data("sla-status")).data("sla-id",add.data("sla-id")))
};var getVisibleOptions=function(options){return options.filter(function(){return $(this).css("display")!=="none"
})};var rowRemoved=function(slaId){var table=rows.closest("table");if(!table.find("tbody tr").length){table.hide()
}if(idSelect.length){idSelect.find('option[value="'+slaId+'"]').show();if(getVisibleOptions(idSelect.find("option")).length>1){form.show()
}}tabHeader.find(".sla-pip").each(function(){var $this=$(this);if($this.data("sla-id")==slaId){$this.remove();
return false}})};rows.on("click","a.sla-delete",function(e){var $this=$(this);e.preventDefault();if(confirm(rows.data("delete-confirm"))){DeskPRO_Window.util.ajaxWithClientMessages({url:$this.attr("href"),type:"POST",dataType:"json"}).done(function(json){if(json.success){var slaId=$this.closest("tr").data("sla-id");
var table=$this.closest("table");$this.closest("tr").remove();rowRemoved(slaId)}})}});if(form.length){if(getVisibleOptions(idSelect.find("option")).length<=1){form.hide()
}var progress=this.getEl("sla_save_progress");DP.select(idSelect,{});form.on("click","button",function(){var val=idSelect.val();
if(val.length&&val!="0"){progress.show();DeskPRO_Window.util.ajaxWithClientMessages({url:form.data("submit-url"),data:form.find("input, textarea, select").serializeArray(),type:"POST",dataType:"json"}).done(function(json){if(json.inserted){addSlaRow(json.html);
idSelect.find('option[value="'+val+'"]').hide();if(getVisibleOptions(idSelect.find("option")).length<=1){form.hide()
}else{idSelect.val("0")}}}).always(function(){progress.hide()})}});DeskPRO_Window.getMessageBroker().addMessageListener("agent.ticket-sla-updated",function(info){if(info.ticket_id==self.getMetaData("ticket_id")){rows.find("tr").each(function(){var row=$(this);
if(row.data("sla-id")==info.sla_id){if(info.removed){row.remove();rowRemoved(info.sla_id)}else{row.find(".sla-status-icon").removeClass(info.original_status).addClass(info.sla_status);
row.data("sla-status",info.sla_status);row.find(".warn-date").html(info.warn_date?$('<time class="timeago" datetime="'+info.warn_date+'"></time>').timeago():"N/A");
row.find(".fail-date").html(info.fail_date?$('<time class="timeago" datetime="'+info.fail_date+'"></time>').timeago():"N/A");
if(info.is_completed){row.find(".delete").addClass("completed").removeClass("delete")}else{row.find(".completed").addClass("delete").removeClass("completed")
}tabHeader.find(".sla-pip").each(function(){var pip=$(this);if(pip.data("sla-id")==info.sla_id){pip.removeClass(info.original_status).addClass(info.sla_status);
return false}})}return false}})}},this.pageUid)}},_initEditName:function(){var self=this;var namef=this.getEl("showname");
var editName=this.getEl("editname");var startBtn=this.getEl("editname_start");var stopBtn=this.getEl("editname_end");
var startEditable=function(){namef.hide();editName.show();startBtn.hide();stopBtn.show()};var stopEditable=function(){var nametxt=editName.find("input").first();
var setName=nametxt.val().trim();if(!setName){return}editName.hide();startBtn.show();namef.show();stopBtn.hide();
namef.text(setName);var postData=[];postData.push({name:"subject",value:setName});$.ajax({url:BASE_URL+"agent/tickets/"+self.meta.ticket_id+"/ajax-save-subject.json",type:"POST",data:postData})
};namef.on("dblclick",startEditable).on("keypress",function(ev){if(ev.keyCode==13){ev.preventDefault();
stopEditable()}});this.getEl("editname_start").on("click",startEditable);this.getEl("editname_end").on("click",stopEditable)
},shortcutOpenSnippets:function(){if(!this.ticketReplyBox){return}if(!this.meta.ticket_reverse_order){this.wrapper.find("div.layout-content").trigger("goscrollbottom")
}this.focusOnReply();this.ticketReplyBox.snippetsViewer.open()},shortcutSendReply:function(){if(!this.ticketReplyBox){return
}if(!this.meta.ticket_reverse_order){this.wrapper.find("div.layout-content").trigger("goscrollbottom")
}this.ticketReplyBox.el.find(".submit-trigger").click()},shortcutReplySetAwaitingUser:function(){if(!this.ticketReplyBox){return
}this.ticketReplyBox.setReplyAsOptionName("awaiting_user");if(!this.meta.ticket_reverse_order){this.wrapper.find("div.layout-content").trigger("goscrollbottom")
}this.focusOnReply()},shortcutReplySetAwaitingAgent:function(){if(!this.ticketReplyBox){return}this.ticketReplyBox.setReplyAsOptionName("awaiting_agent");
if(!this.meta.ticket_reverse_order){this.wrapper.find("div.layout-content").trigger("goscrollbottom")
}this.focusOnReply()},shortcutReplySetResolved:function(){if(!this.ticketReplyBox){return}this.ticketReplyBox.setReplyAsOptionName("resolved");
if(!this.meta.ticket_reverse_order){this.wrapper.find("div.layout-content").trigger("goscrollbottom")
}this.focusOnReply()},shortcutReplyOpenProperties:function(){if(!this.ticketReplyBox){return}if(!this.meta.ticket_reverse_order){this.wrapper.find("div.layout-content").trigger("goscrollbottom")
}this.ticketReplyBox.openStatusMenu()}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page.Ticket");
DeskPRO.Agent.PageFragment.Page.Ticket.TicketLocked=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(page,options){this.page=page;
this.options={};this.setOptions(options);this.lockedBar=this.page.getEl("locked_bar");this.lockedOverlay=this.page.getEl("locked_overlay");
this.dismissBtn=$("button.dismiss",this.lockedBar);this.dismissBtn.on("click",this.dismiss.bind(this))
},dismiss:function(){var wrapper=$(".page-ticket:first",this.page.wrapper);var self=this;this.lockedOverlay.fadeOut("fast");
this.lockedBar.fadeOut("fast",function(){wrapper.removeClass("locked")})},unlock:function(){this.dismiss()
},destroy:function(){}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page.Ticket");DeskPRO.Agent.PageFragment.Page.Ticket.TicketActions=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(page,options){var self=this;
this.macroId=null;this.page=page;this.options={};this.setOptions(options);this.changeManager=this.page.changeManager;
this.ticketId=this.page.meta.ticket_id;var wrapper=this.page.wrapper;var actionsButtons=this.getEl("action_buttons");
this.page.getEl("flag").on("change",function(){var value=$(this).val();var prop=self.changeManager.getPropertyManager("flag");
self.changeManager.setInstantChange(prop,value)});DP.select(this.getEl("agent_sel"));DP.select(this.getEl("agent_team_sel"));
DP.select(this.getEl("followers_sel"));var showSaving=this.getEl("agent_prop_controls").find(".mark-loading");
var showSaved=this.getEl("agent_prop_controls").find(".mark-saved");var callQueue=new Orb.Util.CallQueue({startCallback:function(){showSaved.stop().hide();
showSaving.show()},endCallback:function(){showSaving.hide();showSaved.show().fadeOut(1000)}});this.getEl("agent_sel").on("change",function(){if($(this).hasClass("eat-change")){$(this).removeClass("eat-change");
return}var agent_id=parseInt($(this).find(":selected").val())||0;var agentProp=self.changeManager.getPropertyManager("agent_id");
if(self.page.ticketReplyBox){self.page.ticketReplyBox.getElById("agent_sel").select2("val",agent_id);
self.page.ticketReplyBox.getElById("agent_sel").trigger("change")}callQueue.call(function(){self.changeManager.setInstantChange(agentProp,agent_id,function(){callQueue.next()
})})});this.getEl("agent_team_sel").on("change",function(){if($(this).hasClass("eat-change")){$(this).removeClass("eat-change");
return}var agent_team_id=parseInt($(this).find(":selected").val())||0;var agentTeamProp=self.changeManager.getPropertyManager("agent_team_id");
if(self.page.ticketReplyBox){self.page.ticketReplyBox.getElById("agent_team_sel").select2("val",agent_team_id);
self.page.ticketReplyBox.getElById("agent_sel").trigger("change")}callQueue.call(function(){self.changeManager.setInstantChange(agentTeamProp,agent_team_id,function(){callQueue.next()
})})});var followerSel=this.page.getEl("followers_sel");var followersList=this.page.getEl("followers_list");
this.page.getEl("add_follower_btn").on("click",function(ev){ev.preventDefault();self.page.getEl("followers_sel_wrap").toggleClass("on");
followerSel.select2("val","0")});followerSel.on("change",function(){var agentId=parseInt($(this).val());
self.page.getEl("followers_sel_wrap").removeClass("on");if(!agentId||followersList.find(".agent-"+agentId)[0]){return
}var option=followerSel.find('option[value="'+agentId+'"]');var li=$('<li class="agent-'+agentId+'" data-agent-id="'+agentId+'"><a class="dp-btn dp-btn-small agent-link" data-agent-id="'+agentId+'"><span class="text"></span><span class="remove-row-trigger"> <i class="icon-remove"></i></span></a></li>');
li.find("span.text").css("background-image","url("+option.data("icon-small")+")").text(option.text());
followersList.append(li);updateFollowersList()});followersList.on("click",".remove-row-trigger",function(ev){ev.preventDefault();
ev.stopPropagation();ev.stopImmediatePropagation();$(this).closest("li").remove();updateFollowersList()
});var updateFollowersList=function(){var postData=[{name:"with_set_agent_parts",value:1}];followersList.find("li").each(function(){postData.push({name:"set_agent_part_ids[]",value:$(this).data("agent-id")})
});callQueue.call(function(){self.changeManager.saveChanges(postData,function(){callQueue.next()})})};
if(this.page.meta.ticket_perms.modify_set_resolved||this.page.meta.ticket_perms.modify_set_awaiting_agent||this.page.meta.ticket_perms.modify_set_awaiting_user){var statusEl=this.page.getEl("status_code").on("change",function(){var prop=self.changeManager.getPropertyManager("status");
var status=$(this).val();self.changeManager.setInstantChange(prop,status)});if(!this.page.meta.ticket_perms.modify_set_resolved){statusEl.find('option[value="resolved"]').not(":selected").remove()
}if(!this.page.meta.ticket_perms.modify_set_awaiting_agent){statusEl.find('option[value="awaiting_agent"]').not(":selected").remove()
}if(!this.page.meta.ticket_perms.modify_set_awaiting_user){statusEl.find('option[value="awaiting_user"]').not(":selected").remove()
}if(!this.page.meta.ticket_perms.modify_set_closed){statusEl.find('option[value="closed"]').not(":selected").remove()
}}if(this.page.meta.ticket_perms.modify_department){this.page.getEl("department_id").on("change",function(){var prop=self.changeManager.getPropertyManager("department_id");
var depId=parseInt($(this).val());var currentDepId=prop.getValue();if(!depId){return}self.changeManager.setInstantChange(prop,depId);
self.page.ticketFields.updateDisplay()});this.page.getEl("field_holders").find("select.prop-input-product, select.prop-input-priority_id, select.prop-input-workflow_id, select.prop-input-category_id").on("change",function(){self.page.ticketFields.updateDisplay()
})}if(this.page.meta.ticket_perms.modify_fields){this.page.getEl("urgency").on("change",function(){var prop=self.changeManager.getPropertyManager("urgency");
var urgency=$(this).val();self.changeManager.setInstantChange(prop,urgency)})}var macroMenu=this.getEl("macros_menu");
this.macrosMenu=new DeskPRO.UI.Menu({triggerElement:this.getEl("macros_menu_trigger"),menuElement:macroMenu,onItemClicked:(function(info){var item=$(info.itemEl);
if(item.hasClass("open-settings-trigger")){$("#settingswin").trigger("dp_open","macros")}else{this.confirmMacro($(info.itemEl).data("macro-id"))
}}).bind(this)});$("#settingswin").on("dp_macros_updated",function(ev){macroMenu.find("li").not(".open-settings-trigger").remove();
Array.each(ev.macroItems,function(x){var li=$("<li />");li.data("macro-id",x.id);li.text(x.title);li.appendTo(macroMenu)
})});DP.select(this.page.getEl("flag"));DP.select(this.page.getEl("department_id"));DP.select(this.page.getEl("status_code"));
DP.select(this.page.getEl("urgency"))},_initMacroOverlay:function(){var self=this;if(this.macroOverlay){return
}var overlayEl=this.getEl("confirm_macro_overlay");this.getEl("apply_macro_btn").on("click",function(){self.saveMacro()
});this.macroOverlay=new DeskPRO.UI.Overlay({contentElement:overlayEl})},confirmMacro:function(macroId){this.macroActions=null;
var overlayEl=this.getEl("confirm_macro_overlay");$.ajax({url:this.page.getMetaData("getMacroUrl").replace("$macro_id",macroId),type:"GET",context:this,dataType:"json",success:function(data){this._initMacroOverlay();
console.log(data);var ul=overlayEl.find("ul.actions-list");ul.empty();Array.each(data.descriptions,function(desc){var li=$("<li />");
li.html(desc);ul.append(li)});this.macroId=macroId;this.macroOverlay.open()}})},saveMacro:function(){this.macroOverlay.close();
if(!this.macroId){return}DP.console.log("Applying macro %d",this.macroId);var url=BASE_URL+"agent/tickets/"+this.ticketId+"/"+this.macroId+"/apply-macro.json";
$.ajax({url:url,type:"POST",dataType:"json",context:this,success:function(data){if(data.error){DeskPRO_Window.showAlert("The macro was not applied because you do not have permission to perform one or more of the defined actions.");
return}this.page.closeSelf();if(!data.close_tab){DeskPRO_Window.runPageRoute("page:"+BASE_URL+"agent/tickets/"+this.ticketId)
}}});this.macroId=null},getEl:function(id){return this.page.getEl(id)}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page.PersonHelper");
DeskPRO.Agent.PageFragment.Page.PersonHelper.ChangePic=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(page,options){var self=this;
this.options={loadUrl:"",saveUrl:""};this.setOptions(options);this.page=page;this.page.getEl("change_user_picture").on("click",this.open.bind(this));
this.page.addEvent("destroy",this.destroy,this)},_initOverlay:function(){var self=this;if(this.overlay){return
}this.wrapperEl=$('<div class="change-picture-overlay"><div class="overlay-content" style="width: 400px; height: 300px; "/><div>Loading...</div></div>');
this.overlay=new DeskPRO.UI.Overlay({contentElement:this.wrapperEl,destroyOnClose:true,zIndex:"top",onOverlayClosed:function(){self.overlay=null
}});$.ajax({url:this.options.loadUrl,type:"GET",dataType:"html",context:this,success:function(html){if(this.overlay){this.overlay.setContent($(html));
this.wrapperEl=this.overlay.getWrapper();this._initControls()}}})},_initControls:function(){var wrapper=this.overlay.getWrapper();
DeskPRO_Window.util.fileupload(wrapper,{page:this.page,uploadTemplate:$(".template-upload",wrapper),downloadTemplate:$(".template-download",wrapper),formData:[{name:"is_image",value:1}],completed:function(){$(".files .in",wrapper).css("height","auto")
}}).bind("fileuploadstart",function(){$("p.explain",wrapper).hide()}).bind("fileuploadadd",function(){$(".files",wrapper).empty();
$("input[name=set_pic_opt]",wrapper).each(function(){$(this).attr("checked",$(this).val()=="newpic")})
});wrapper.on("click",".save-trigger",this._doSave.bind(this))},_doSave:function(e){e.preventDefault();
var type=$("input[name=set_pic_opt]:checked",this.overlay.getWrapper()).val();var newImgSrc=null;var action=null;
var formData=[];switch(type){case"nochange":this.close();return;case"remove":formData.push({name:"action",value:"delete-picture"});
formData.push({name:"disable_picture",value:"1"});newImgSrc=$("img.pic-default",this.wrapperEl).attr("src");
break;case"gravatar":formData.push({name:"action",value:"delete-picture"});newImgSrc=$("img.pic-gravatar",this.wrapperEl).attr("src");
break;case"newpic":formData.push({name:"action",value:"set-picture"});var blobId=$("input.new_blob_id",this.wrapperEl).val();
if(!blobId){return}formData.push({name:"blob_id",value:blobId});newImgSrc=$("img.pic-new",this.wrapperEl).data("setted-size");
break;default:return}$.ajax({url:this.options.saveUrl,type:"POST",dataType:"json",data:formData});this.page.getEl("picture_display").attr("src",newImgSrc);
this.close()},open:function(){this._initOverlay();this.overlay.open()},close:function(){if(this.overlay){this.overlay.destroy();
this.overlay=null}},destroy:function(){if(this.overlay){this.overlay.destroy()}}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page.PersonHelper");
DeskPRO.Agent.PageFragment.Page.PersonHelper.ContactEditor=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(page,options){var self=this;
this.options={displayEl:null,outsideEl:null,saveUrl:""};this.setOptions(options);this.page=page;this.wrapper=this.page.wrapper;
this.page.addEvent("destroy",this.destroy,this);this.initEditorOverlay();var displayEl=$(self.options.displayEl||".contact-list-wrapper",self.wrapper);
var outsideEl=$(self.options.outsideEl);if($("div.outside-html",displayEl)){var outside=$("div.outside-display",displayEl).detach()
}else{var outside=$("<div/>")}outsideEl.empty().append(outside)},replaceEditorOverlay:function(html){var contactEditor=$(".profile-contact-editor",this.wrapper);
contactEditor.remove();contactEditor=null;$(html).appendTo(this.wrapper);this.initEditorOverlay();this.fireEvent("replaceEditor",[this])
},initEditorOverlay:function(){var self=this;if(this.contactOverlay){this.contactOverlay.destroy();this.contactOverlay=null
}if(this.contactNewMenu){this.contactNewMenu.destroy();this.contactNewMenu=null}var contactEditor=$(".profile-contact-editor-wrapper",this.wrapper);
this.contactOverlay=new DeskPRO.UI.Overlay({customClassname:"profile-contact-editor",triggerElement:$(".contact-edit",this.wrapper),contentElement:contactEditor,zIndex:"none"});
$(".save-trigger",contactEditor).on("click",function(ev){var formData=$(":input, select, textarea",contactEditor).serializeArray();
contactEditor.addClass("loading");$.ajax({url:self.options.saveUrl,type:"POST",dataType:"json",data:formData,complete:function(){contactEditor.removeClass("loading")
},success:function(data){self.contactOverlay.close();var displayEl=$(self.options.displayEl||".contact-list-wrapper",self.wrapper);
var outsideEl=$(self.options.outsideEl);var newHtml=$(data.display_html);if($("div.outside-html",newHtml)){var outside=$("div.outside-display",newHtml).detach()
}else{var outside=$("<div/>")}displayEl.empty().append(newHtml);outsideEl.empty().append(outside);DeskPRO_Window.initInterfaceServices(displayEl);
DeskPRO_Window.initInterfaceServices(outsideEl);self.replaceEditorOverlay(data.editor_overlay_html);if(data.errors){var div=$("<div>There were errors with the following changes:</div>");
var ul=$("<ul></ul>");Array.each(data.errors,function(e){var li=$("<li />");li.text(e);li.appendTo(ul)
});ul.appendTo(div);DeskPRO_Window.showAlert(div)}self.fireEvent("success",data)}})});var checkFields=function(rowTypeEl){var row=$("li",rowTypeEl).last();
var show=false;if(row.is(".new")){var fields=$("input, textarea, select",row);fields.each(function(){if($(this).val()){show=true
}})}else{show=false}if(show){$(".with-some",rowTypeEl).show()}else{$(".with-some",rowTypeEl).hide()}};
function doRemove(row,rowTypeEl){var removeName=row.data("remove-name");var removeVal=row.data("remove-value");
if(removeName&&removeVal){var input=$('<input type="hidden" />');input.attr("name",removeName);input.val(removeVal);
input.appendTo(contactEditor)}row.fadeOut("fast",function(){row.remove();checkFields(rowTypeEl);var lis=$("li",rowTypeEl);
if(lis.length<1){rowTypeEl.removeClass("with-values")}})}contactEditor.on("click",".remove",function(ev){var rowTypeEl=$(this).closest(".row-type");
var row=$(this).closest("li");if(row.data("confirm")){DeskPRO_Window.showConfirm(row.data("confirm"),function(){doRemove(row,rowTypeEl)
})}else{doRemove(row,rowTypeEl)}});contactEditor.on("click",".add-trigger",function(ev){var rowTypeEl=$(this).closest(".row-type");
var tpl=DeskPRO_Window.util.getPlainTpl($(".tpl-new-row",rowTypeEl));tpl=tpl.replace(/%id%/g,Orb.uuid());
var el=$(tpl);el.addClass("new");el.appendTo($("ul",rowTypeEl));DeskPRO_Window.initInterfaceServices(el);
$("input, textarea, select",el).bind("change blur keyup",function(){checkFields(rowTypeEl)});$(".with-some",rowTypeEl).hide();
rowTypeEl.addClass("with-values")})},destroy:function(){if(this.contactOverlay){this.contactOverlay.destroy();
this.contactOverlay=null}}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page.Content");DeskPRO.Agent.PageFragment.Page.Content.DeleteControl=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(page,options){var self=this;
this.options={ajaxSaveUrl:"",type:"delete"};this.setOptions(options);this.page=page;this.deleteBtn=$("."+this.options.type,this.page.getEl("action_buttons"));
this.deletedNotice=$("."+this.options.type+"-notice:first",this.page.wrapper);this.statusBtn=$(".the-status:first",this.page.wrapper);
this.undeleteBtn=$(".un"+this.options.type,this.deletedNotice);this.otherDeleteBtns=$(".delete-type:not(."+this.options.type+")",this.page.getEl("action_buttons"));
this.deleteBtn.on("click",function(){self.handleDeleted();$.ajax({url:self.options.ajaxSaveUrl,data:{action:self.options.type},type:"GET",dataType:"json",error:function(){self.handleUndelete()
},success:function(html){DeskPRO_Window.getMessageBroker().sendMessage("agent.ui.content_deleted."+page.TYPENAME)
}})})},undelete:function(){},handleDeleted:function(){this.deleteBtn.hide();this.statusBtn.hide();this.deletedNotice.show();
this.otherDeleteBtns.hide()},handleUndelete:function(){this.deleteBtn.show();this.statusBtn.show();this.deletedNotice.hide();
this.otherDeleteBtns.show()}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page.Content");DeskPRO.Agent.PageFragment.Page.Content.StickyWords=new Orb.Class({Implements:[Orb.Util.Events,Orb.Util.Options],initialize:function(page,options){var self=this;
this.page=page;this.options={saveUrl:null,contentType:"",contentId:0,element:null};this.setOptions(options);
if(!this.options.saveUrl){this.options.saveUrl=BASE_URL+"agent/publish/save-sticky-search-words/"+this.options.contentType+"/"+this.options.contentId
}this.termsInput=new DeskPRO.UI.LabelsInput({input:this.options.element,placeholder:"Enter a search word..."});
this.termsInput.addEvent("change",function(){self._updated()})},_updated:function(){var labels=this.termsInput.getLabels();
var ev={labels:labels,cancel:false};this.fireEvent("change",[ev]);if(ev.cancel){return}var data=[];Array.each(labels,function(w){data.push({name:"words[]",value:w})
});$.ajax({url:this.options.saveUrl,data:data,type:"POST"})}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page");
DeskPRO.Agent.PageFragment.Page.NewArticle=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="newarticle";this.allowDupe=true},initPage:function(el){var self=this;this.wrapper=el;this.parent(el);
if(!this.getEl("cat").find("option")[0]){this.wrapper.find(".form-header-error").show();this.wrapper.find(".form-outer").hide();
this.markForReload()}this.form=$("form",this.wrapper).on("submit",function(ev){ev.preventDefault()});
$("button.submit-trigger",this.wrapper).on("click",this.submit.bind(this));this._initContentSection();
this._initOtherSection();this.stateSaver=new DeskPRO.Agent.PageHelper.StateSaver({stateId:"newarticle",listenOn:this.getEl("newarticle")});
this.ownObject(this.stateSaver);window.setTimeout(function(){if(self.OBJ_DESTROYED){return}self.wrapper.find("select").each(function(){if($(this).prop("multiple")){$(this).width(300)
}DP.select($(this))});self.updateUi()},300);this.activate()},activate:function(){var selectedCat=$("#publish_outline_articlescat_list").find(".nav-selected").data("cat-id");
if(selectedCat){this.getEl("cat").find('option[value="'+selectedCat+'"]').prop("selected",true);this.getEl("cat").trigger("change")
}},markForReload:function(){if(!this.markedForReload){this.markedForReload=true;this.addEvent("deactivate",this.closeSelf.bind(this))
}},closeSelf:function(){var ev={cancel:false};this.fireEvent("closeSelf",ev);if(!ev.cancel){this.parent()
}},destroyPage:function(){var el=this.wrapper.find(".article-section");if(el[0]){el.get(0).parentNode.removeChild(el.get(0))
}},submit:function(){var formData=this.form.serializeArray();if(this.labelsInput){formData.append(this.labelsInput.getFormData())
}$("div.error.section",this.wrapper).removeClass("error");$(".error-message-on",this.wrapper).removeClass("error-message-on");
this.stateSaver.stop();this.stateSaver.resetState();this.wrapper.addClass("loading");$.ajax({url:BASE_URL+"agent/kb/article/new/save",type:"POST",data:formData,dataType:"json",context:this,complete:function(){this.wrapper.removeClass("loading")
},success:function(data){if(data.error){Array.each(data.error_codes,function(code){this.showErrorCode(code)
},this);this.updateUi();return}var pending_article_id=this.getEl("pending_article_id").val();if(pending_article_id){DeskPRO_Window.getMessageBroker().sendMessage("kb.pending_article_removed",{pending_article_id:pending_article_id})
}if(data.success){DeskPRO_Window.runPageRoute("page:"+BASE_URL+"agent/kb/article/"+data.article_id);this.markForReload();
this.closeSelf()}else{alert("There was an error with the form")}}})},showErrorCode:function(code){$("."+code+".error-message",this.wrapper).addClass("error-message-on")
},setTitle:function(title){this.getEl("title").val(title).change()},setContent:function(content,is_html){if(!is_html){content=Orb.escapeHtml(content)
}this.getEl("content").html(content)},setPendingArticle:function(data){this.getEl("pending_article_id").val(data.id);
if(data.ticket_subject){this.setTitle(data.ticket_subject)}if(data.initial_message_html){var content="";
if(data.initial_message_html){content="<h3>Question:</h3>";content+=data.initial_message_html+="<br /><br />"
}this.setContent(content,true)}else{this.setContent("",true)}var infoWrap=$(".pending-info:first",this.wrapper);
if(data.ticket_url){$(".pending-ticket a",infoWrap).text(data.ticket_subject);$(".pending-ticket a",infoWrap).data("route","page:"+data.ticket_url);
$(".pending-ticket",infoWrap).show()}if(data.comment){$(".pending-reason",infoWrap).text(data.comment).show()
}$(".person-name",infoWrap).text(data.person_name);infoWrap.show()},_initContentSection:function(){var self=this;
this.getEl("content").css({width:this.wrapper.width()-80});var h=$(window).height();this.getEl("content").css("height",Math.max(h-500,200));
DP.rteTextarea(this.getEl("content"),{setup:function(ed){ed.onKeyPress.add(function(){if(self.stateSaver){self.stateSaver.triggerChange()
}})}});this.acceptContentLink=new DeskPRO.Agent.PageHelper.AcceptContentLink({page:this,rte:this.getEl("content")})
},_initOtherSection:function(){var self=this;this.otherTabs=new DeskPRO.UI.SimpleTabs({triggerElements:$("li",this.getEl("other_props_tabs")),context:this.getEl("other_props_tabs_content"),autoSelectFirst:false,onTabSwitch:function(eventData){if(!self.labelsInput&&eventData.tabContent.hasClass("tab-properties")){self.labelsInput=new DeskPRO.UI.LabelsInput({type:"articles",fieldName:"newarticle[labels]",input:$(".tags-wrap input",eventData.tabContent),onChange:function(){if(self.stateSaver){self.stateSaver.triggerChange()
}}});self.ownObject(self.labelsInput)}},onTabClick:(function(ev){var contentWrap=this.getEl("other_props_tabs_content");
var navWrap=this.getEl("other_props_tabs_wrap");var tab=ev.tabEl;if(!$(".on",navWrap).length||tab.is(".on")){if(contentWrap.is(":visible")){contentWrap.hide();
navWrap.removeClass("on")}else{contentWrap.show();navWrap.addClass("on")}}}).bind(this)});this.ownObject(this.otherTabs);
this.getEl("slug").on("focus",function(){$(this).addClass("had-focus")});var list=$(".file-list",this.wrapper);
$("input",list[0]).live("click",function(){var el=$(this);var li=el.parent();if(el.is(":checked")){li.removeClass("unchecked")
}else{li.addClass("unchecked")}});DeskPRO_Window.util.fileupload(this.wrapper,{page:this})}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page");
DeskPRO.Agent.PageFragment.Page.NewPerson=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="newperson";this.allowDupe=true},initPage:function(el){var self=this;this.wrapper=el;this.form=$("form",this.wrapper).on("submit",function(ev){ev.preventDefault()
});$("button.submit-trigger",this.wrapper).on("click",this.submit.bind(this));this._initNameSection();
this._initOtherSection();this.stateSaver=new DeskPRO.Agent.PageHelper.StateSaver({stateId:"newperson",listenOn:this.getEl("newperson")});
this.ownObject(this.stateSaver);this.getEl("org_searchbox").on("orgsearchboxclick orgsearchboxcreate",function(){self.getEl("org_pos").show();
self.updateUi()}).on("orgsearchboxcleared",function(){self.getEl("org_pos").hide();self.updateUi()});
DeskPRO_Window.util.fileupload(el,{uploadTemplate:$(".template-upload",el),downloadTemplate:$(".template-download",el),url:BASE_URL+"agent/misc/parse-vcard"});
el.bind("fileuploaddone",function(event,data){for(name in data.result[0].fields){$('[name$="['+name+']"]',el).val(data.result[0].fields[name])
}});el.bind("fileuploadstart",function(event,data){});self.wrapper.find(".dpe_select").each(function(){if(!$(this).hasClass("labels-input")){DP.select($(this))
}})},markForReload:function(){if(!this.markedForReload){this.markedForReload=true;this.addEvent("deactivate",this.closeSelf.bind(this))
}},closeSelf:function(){var ev={cancel:false};this.fireEvent("closeSelf",ev);if(!ev.cancel){this.parent()
}},submit:function(){var formData=this.form.serializeArray();$.ajax({url:BASE_URL+"agent/people/new/save",type:"POST",data:formData,dataType:"json",context:this,success:function(data){if(data.success){if(this.getEl("org_id").val().length&&this.fromCompanyTab){DeskPRO_Window.getMessageBroker().sendMessage("new-org-user",{organization_id:this.getEl("org_id").val(),person_id:data.person_id})
}else{DeskPRO_Window.runPageRoute("person:"+BASE_URL+"agent/people/"+data.person_id)}DeskPRO_Window.getMessageBroker().sendMessage("agent.person.added",{person_id:data.person_id});
this.closeSelf()}else{var errorMessages=$("<div/>");errorMessages.append("<p>Please correct the following errors with your form:</p>");
Array.each(data.error_messages,function(msg){errorMessages.append("<div>&bull; "+msg+"</div>")});DeskPRO_Window.showAlert(errorMessages,"error")
}}})},setOrganization:function(org_id,org_name){this.getEl("org_id").val(org_id);this.getEl("org_name").val(org_name);
this.getEl("org_pos").show();this.updateUi();this.fromCompanyTab=true},setGuessTerm:function(term){if(term.indexOf("@")!==-1){this.getEl("email").val(term)
}else{this.getEl("name").val(term)}},_initNameSection:function(){},_initOtherSection:function(){var self=this;
this.otherTabs=new DeskPRO.UI.SimpleTabs({triggerElements:$("li",this.getEl("other_props_tabs")),context:this.getEl("other_props_tabs_content"),autoSelectFirst:false,onTabSwitch:function(eventData){if(!self.labelsInput&&eventData.tabContent.hasClass("tab-properties")&&self.getEl("labels_input")[0]){self.labelsInput=new DeskPRO.UI.LabelsInput({type:"tickets",input:self.getEl("labels_input")});
self.ownObject(self.labelsInput)}},onTabClick:(function(ev){var contentWrap=this.getEl("other_props_tabs_content");
var navWrap=this.getEl("other_props_tabs_wrap");var tab=ev.tabEl;if(!$(".on",navWrap).length||tab.is(".on")){if(contentWrap.is(":visible")){contentWrap.hide();
navWrap.removeClass("on")}else{contentWrap.show();navWrap.addClass("on")}}}).bind(this)});this.ownObject(this.otherTabs)
}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page");DeskPRO.Agent.PageFragment.Page.NewOrganization=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="neworganization";this.allowDupe=true},initPage:function(el){var self=this;this.wrapper=el;
this.parent(el);this.form=$("form",this.wrapper).on("submit",function(ev){ev.preventDefault()});$("button.submit-trigger",this.wrapper).on("click",this.submit.bind(this));
this._initNameSection();this._initOtherSection();this.stateSaver=new DeskPRO.Agent.PageHelper.StateSaver({stateId:"neworg",listenOn:this.getEl("neworg")});
this.ownObject(this.stateSaver)},markForReload:function(){if(!this.markedForReload){this.markedForReload=true;
this.addEvent("deactivate",this.closeSelf.bind(this))}},closeSelf:function(){var ev={cancel:false};this.fireEvent("closeSelf",ev);
if(!ev.cancel){this.parent()}},submit:function(){var self=this;var formData=this.form.serializeArray();
$.ajax({url:BASE_URL+"agent/organizations/new/save",type:"POST",data:formData,dataType:"json",context:this,success:function(data){if(data.success){DeskPRO_Window.runPageRoute("person:"+BASE_URL+"agent/organizations/"+data.org_id);
$("select.dp-org-select").each(function(){var opt=$("<option />");opt.val(data.org_id);opt.text(self.getEl("name").val());
$(this).append(opt)});this.closeSelf()}else{if(data&&data.error_code&&data.error_code=="invalid_name"){DeskPRO_Window.showAlert("Please enter a name for the organization")
}}}})},_initNameSection:function(){},_initOtherSection:function(){var self=this;this.otherTabs=new DeskPRO.UI.SimpleTabs({triggerElements:$("li",this.getEl("other_props_tabs")),context:this.getEl("other_props_tabs_content"),autoSelectFirst:false,onTabSwitch:function(eventData){if(!self.labelsInput&&eventData.tabContent.hasClass("tab-properties")){self.labelsInput=new DeskPRO.UI.LabelsInput({type:"org",fieldName:"neworg[labels]",textarea:$(".tags-wrap input",eventData.tabContent),onChange:function(){self.stateSaver.triggerChange()
}});self.ownObject(self.labelsInput)}},onTabClick:(function(ev){var contentWrap=this.getEl("other_props_tabs_content");
var navWrap=this.getEl("other_props_tabs_wrap");var tab=ev.tabEl;if(!$(".on",navWrap).length||tab.is(".on")){if(contentWrap.is(":visible")){contentWrap.hide();
navWrap.removeClass("on")}else{contentWrap.show();navWrap.addClass("on")}}}).bind(this)});this.ownObject(this.otherTabs)
}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page");DeskPRO.Agent.PageFragment.Page.NewDownload=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="newdownload";this.allowDupe=true},initPage:function(el){var self=this;this.wrapper=el;
this.parent(el);if(!this.getEl("cat").find("option")[0]){this.wrapper.find(".form-header-error").show();
this.wrapper.find(".form-outer").hide();this.markForReload()}this.form=$("form",this.wrapper).on("submit",function(ev){ev.preventDefault()
});$("button.submit-trigger",this.wrapper).on("click",this.submit.bind(this));this._initCategorySection();
this._initTitleSection();this._initFileSection();this._initContentSection();this._initOtherSection();
this.stateSaver=new DeskPRO.Agent.PageHelper.StateSaver({stateId:"newdownload",listenOn:this.getEl("newdownload")});
this.ownObject(this.stateSaver);window.setTimeout(function(){if(self.OBJ_DESTROYED){return}self.wrapper.find("select").each(function(){if($(this).prop("multiple")){$(this).width(300)
}DP.select($(this))});self.updateUi()},300);this.wrapper.find(".switch-upload-type").on("click",function(ev){ev.preventDefault();
ev.stopPropagation();if(self.getEl("file_upload_type").hasClass("on")){self.getEl("file_upload_type").removeClass("on").hide();
self.getEl("file_url_type").addClass("on").show()}else{self.getEl("file_url_type").removeClass("on").hide();
self.getEl("file_upload_type").addClass("on").show()}});this.activate()},activate:function(){var selectedCat=$("#publish_outline_downloadscat_list").find(".nav-selected").data("cat-id");
if(selectedCat){this.getEl("cat").find('option[value="'+selectedCat+'"]').prop("selected",true);this.getEl("cat").trigger("change")
}},markForReload:function(){if(!this.markedForReload){this.markedForReload=true;this.addEvent("deactivate",this.closeSelf.bind(this))
}},destroyPage:function(){var el=this.wrapper.find(".article-section");if(el[0]){el.get(0).parentNode.removeChild(el.get(0))
}},closeSelf:function(){var ev={cancel:false};this.fireEvent("closeSelf",ev);if(!ev.cancel){this.parent()
}},submit:function(){var formData=this.form.serializeArray();if(this.labelsInput){formData.append(this.labelsInput.getFormData())
}$("div.error.section",this.wrapper).removeClass("error");$(".error-message-on",this.wrapper).removeClass("error-message-on");
this.stateSaver.stop();this.stateSaver.resetState();this.wrapper.addClass("loading");$.ajax({url:BASE_URL+"agent/downloads/new/save",type:"POST",data:formData,dataType:"json",context:this,complete:function(){this.wrapper.removeClass("loading")
},success:function(data){if(data.error){Array.each(data.error_codes,function(code){this.showErrorCode(code)
},this);this.updateUi();return}if(data.success){this.markForReload();DeskPRO_Window.runPageRoute("page:"+BASE_URL+"agent/downloads/file/"+data.download_id);
this.closeSelf()}else{alert("There was an error with the form")}}})},showErrorCode:function(code){$("."+code+".error-message",this.wrapper).addClass("error-message-on")
},_initCategorySection:function(){var self=this;this.getEl("cat").on("change",function(){if(parseInt($(this).val())){self.getEl("cat_section").addClass("done")
}else{self.getEl("cat_section").removeClass("done")}})},_initTitleSection:function(){var self=this;var fn=function(){if($(this).val().trim()==""){self.getEl("title_section").removeClass("done")
}else{self.getEl("title_section").addClass("done")}};this.getEl("title").on("change",fn).on("keypress",fn).on("change",function(){var val=$(this).val().trim().toLowerCase();
val=val.replace(/[^a-z0-9\-_]/g,"-");val=val.replace(/-{2,}/g,"-");self.getEl("slug").val(val)})},_initFileSection:function(){var self=this;
var upinput=this.getEl("file_section_up");var list=$(".file-list",this.wrapper);list.on("click",".remove-attach-trigger",function(){$("ul.file-list",self.wrapper).empty();
upinput.show();self.updateUi()});DeskPRO_Window.util.fileupload(this.wrapper,{page:this});this.wrapper.bind("fileuploaddone",function(){self.getEl("file_section").addClass("done");
upinput.hide();self.updateUi()});this.wrapper.bind("fileuploadadd",function(){$("ul.file-list",self.wrapper).empty()
})},_initContentSection:function(){var self=this;this.getEl("content").css({width:this.wrapper.width()-80});
this.getEl("content").css("height",250);DP.rteTextarea(this.getEl("content"),{setup:function(ed){ed.onClick.add(function(){self.getEl("content_section").addClass("done")
});ed.onKeyPress.add(function(){if(self.stateSaver){self.stateSaver.triggerChange()}})}})},_initOtherSection:function(){var self=this;
this.otherTabs=new DeskPRO.UI.SimpleTabs({triggerElements:$("li",this.getEl("other_props_tabs")),context:this.getEl("other_props_tabs_content"),autoSelectFirst:false,onTabSwitch:function(eventData){if(!self.labelsInput&&eventData.tabContent.hasClass("tab-properties")){self.labelsInput=new DeskPRO.UI.LabelsInput({type:"downloads",fieldName:"newdownload[labels]",input:$(".tags-wrap input",eventData.tabContent),onChange:function(){if(self.stateSaver){self.stateSaver.triggerChange()
}}});self.ownObject(self.labelsInput)}},onTabClick:(function(ev){var contentWrap=this.getEl("other_props_tabs_content");
var navWrap=this.getEl("other_props_tabs_wrap");var tab=ev.tabEl;if(!$(".on",navWrap).length||tab.is(".on")){if(contentWrap.is(":visible")){contentWrap.hide();
navWrap.removeClass("on")}else{contentWrap.show();navWrap.addClass("on")}}}).bind(this)});this.ownObject(this.otherTabs)
}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page");DeskPRO.Agent.PageFragment.Page.NewNews=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="newnews";this.allowDupe=true},initPage:function(el){var self=this;this.wrapper=el;this.parent(el);
if(!this.getEl("cat").find("option")[0]){this.wrapper.find(".form-header-error").show();this.wrapper.find(".form-outer").hide();
this.markForReload()}this.form=$("form",this.wrapper).on("submit",function(ev){ev.preventDefault()});
$("button.submit-trigger",this.wrapper).on("click",this.submit.bind(this));this._initCategorySection();
this._initTitleSection();this._initContentSection();this._initOtherSection();this.stateSaver=new DeskPRO.Agent.PageHelper.StateSaver({stateId:"c",listenOn:this.getEl("newnews")});
this.ownObject(this.stateSaver);window.setTimeout(function(){if(self.OBJ_DESTROYED){return}self.wrapper.find("select").each(function(){if($(this).prop("multiple")){$(this).width(300)
}DP.select($(this))});self.updateUi()},300);this.activate()},activate:function(){var selectedCat=$("#publish_outline_newscat_list").find(".nav-selected").data("cat-id");
if(selectedCat){this.getEl("cat").find('option[value="'+selectedCat+'"]').prop("selected",true);this.getEl("cat").trigger("change")
}},destroyPage:function(){var el=this.wrapper.find(".article-section");if(el[0]){el.get(0).parentNode.removeChild(el.get(0))
}},markForReload:function(){if(!this.markedForReload){this.markedForReload=true;this.addEvent("deactivate",this.closeSelf.bind(this))
}},closeSelf:function(){var ev={cancel:false};this.fireEvent("closeSelf",ev);if(!ev.cancel){this.parent()
}},submit:function(){var formData=this.form.serializeArray();if(this.labelsInput){formData.append(this.labelsInput.getFormData())
}$("div.error.section",this.wrapper).removeClass("error");$(".error-message-on",this.wrapper).removeClass("error-message-on");
this.stateSaver.stop();this.stateSaver.resetState();this.wrapper.addClass("loading");$.ajax({url:BASE_URL+"agent/news/new/save",type:"POST",data:formData,dataType:"json",context:this,complete:function(){this.wrapper.removeClass("loading")
},success:function(data){if(data.error){Array.each(data.error_codes,function(code){this.showErrorCode(code)
},this);this.updateUi();return}if(data.news_id){DeskPRO_Window.runPageRoute("page:"+BASE_URL+"agent/news/post/"+data.news_id)
}this.markForReload();this.closeSelf()}})},showErrorCode:function(code){$("."+code+".error-message",this.wrapper).addClass("error-message-on")
},_initCategorySection:function(){var self=this;this.getEl("cat").on("change",function(){if(parseInt($(this).val())){self.getEl("cat_section").addClass("done")
}else{self.getEl("cat_section").removeClass("done")}})},_initTitleSection:function(){var self=this;var fn=function(){if($(this).val().trim()==""){self.getEl("title_section").removeClass("done")
}else{self.getEl("title_section").addClass("done")}};this.getEl("title").on("change",fn).on("keypress",fn).on("change",function(){var val=$(this).val().trim().toLowerCase();
val=val.replace(/[^a-z0-9\-_]/g,"-");val=val.replace(/-{2,}/g,"-");self.getEl("slug").val(val)})},_initContentSection:function(){var self=this;
this.getEl("content").css({width:this.wrapper.width()-80});var h=$(window).height();this.getEl("content").css("height",Math.max(h-500,200));
DP.rteTextarea(this.getEl("content"),{setup:function(ed){ed.onClick.add(function(){self.getEl("content_section").addClass("done")
});ed.onKeyPress.add(function(){if(self.stateSaver){self.stateSaver.triggerChange()}})}})},_initOtherSection:function(){var self=this;
this.otherTabs=new DeskPRO.UI.SimpleTabs({triggerElements:$("li",this.getEl("other_props_tabs")),context:this.getEl("other_props_tabs_content"),autoSelectFirst:false,onTabSwitch:function(eventData){if(!self.labelsInput&&eventData.tabContent.hasClass("tab-properties")){self.labelsInput=new DeskPRO.UI.LabelsInput({type:"news",fieldName:"newnews[labels]",input:$(".tags-wrap input",eventData.tabContent),onChange:function(){if(self.stateSaver){self.stateSaver.triggerChange()
}}});self.ownObject(self.labelsInput)}},onTabClick:(function(ev){var contentWrap=this.getEl("other_props_tabs_content");
var navWrap=this.getEl("other_props_tabs_wrap");var tab=ev.tabEl;if(!$(".on",navWrap).length||tab.is(".on")){if(contentWrap.is(":visible")){contentWrap.hide();
navWrap.removeClass("on")}else{contentWrap.show();navWrap.addClass("on")}}}).bind(this)});this.ownObject(this.otherTabs);
this.getEl("slug").on("focus",function(){$(this).addClass("had-focus")});var list=$(".file-list",this.wrapper);
$("input",list[0]).live("click",function(){var el=$(this);var li=el.parent();if(el.is(":checked")){li.removeClass("unchecked")
}else{li.addClass("unchecked")}});DeskPRO_Window.util.fileupload(this.wrapper,{page:this})}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page");
DeskPRO.Agent.PageFragment.Page.NewTicket=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="newticket";this.allowDupe=true},initPage:function(el){var self=this;this.wrapper=el;this.el=el;
this.contentWrapper=this.wrapper.children(".layout-content").attr("id",Orb.getUniqueId());this.parent(el);
el.find("select").addClass("with-select2");this.form=$("form",this.wrapper).on("submit",function(ev){ev.preventDefault()
});this._initUserSection();this._initMessageSection();this._initOtherSection();this._initCcSelection();
this.meta.person_api_data={};this.addEvent("activate",function(){window.setTimeout(function(){if(!self.getEl("user_searchbox").find("input.person-id").val()){self.getEl("userselect").focus()
}},60)});if(this.getEl("headerbox_box_billing").length){var billing=new DeskPRO.Agent.PageHelper.TicketBilling(this.getEl("headerbox_box_billing"),this.meta.baseId,{auto_start_bill:this.meta.auto_start_bill});
this.addEvent("activate",function(){if(this.meta.auto_start_bill){billing.startBillingTimer(true)}});
this.addEvent("deactivate",function(){billing.stopBillingTimer(true)})}$(".submit-trigger",this.wrapper).on("click",this.submit.bind(this));
DeskPRO_Window.util.fileupload(this.wrapper,{dropZone:$(".option-rows",this.wrapper),uploadTemplate:$(".template-upload",this.wrapper),downloadTemplate:$(".template-download",this.wrapper)});
this.wrapper.bind("fileuploaddone",function(){self.getEl("attach_row").slideDown().removeClass("is-hidden")
});this.wrapper.bind("fileuploadstart",function(){self.getEl("attach_row").slideDown().removeClass("is-hidden")
});this.wrapper.on("click",".remove-attach-trigger",function(){var row=$(this).closest("li");row.fadeOut("fast",function(){row.remove();
var rows=$("ul.files li",self.getEl("attach_row"));if(!rows.length){self.getEl("attach_row").slideUp().addClass("is-hidden")
}})});$(".Date.customfield input",this.wrapper).datepicker({dateFormat:"yy-mm-dd",showButtonPanel:true,beforeShow:function(input){setTimeout(function(){var buttonPane=$(input).datepicker("widget").find(".ui-datepicker-buttonpane");
buttonPane.find("button:first").remove();var btn=$('<button class="ui-datepicker-current ui-state-default ui-priority-secondary ui-corner-all" type="button">Clear</button>');
btn.unbind("click").bind("click",function(){$.datepicker._clearDate(input)});btn.appendTo(buttonPane);
$(input).datepicker("widget").css("z-index",30002)},1)}});this.wrapper.find(".pending-info").on("click",".reset",function(ev){ev.preventDefault();
self._resetForX()});this.addEvent("deactivate",function(){this._resetForX()},this);var messageEl=this.getEl("message");
var subjectEl=this.getEl("subject");var appliedMsgTpl=null;var sig=$.trim(self.getEl("signature_value").val());
messageEl.on("keydown",function(){messageEl.addClass("editted")});subjectEl.on("keydown",function(){subjectEl.addClass("editted")
});this.getEl("message_template").on("change",function(){var id=$(this).val();if(appliedMsgTpl==id){return
}if(!id){if(!messageEl.hasClass("editted")){self.setMessageText("")}if(!subjectEl.hasClass("editted")){subjectEl.val("")
}return}appliedMsgTpl=id;$.ajax({url:BASE_URL+"agent/tickets/get-message-template/"+id+".json",type:"GET",cache:false,dataType:"json",success:function(data){if(messageEl.hasClass("editted")){var msgCmp=data.message.replace(/(\r\n|\n|\r)/gm," ");
var valCmp=messageEl.val().replace(/(\r\n|\n|\r)/gm," ");if(valCmp.indexOf(msgCmp)===-1){self.insertMessageText(data.message)
}}else{var val=data.message;if(sig){val+="\n\n";val+=sig}self.setMessageText(val)}if(subjectEl.hasClass("editted")){if(subjectEl.val().indexOf(data.subject)===-1){subjectEl.insertAtCaret(data.subject)
}}else{subjectEl.val(data.subject)}}})});var w=this.getEl("message_template").width()+55;if(w>350){w=350
}this.getEl("message_template").css("width",w);this.getEl("message_template_holder").css({visibility:"visible",display:"none"});
window.setTimeout(function(){if(self.OBJ_DESTROYED){return}self.wrapper.find("select").each(function(){if($(this).prop("multiple")){$(this).width(300)
}DP.select($(this))});self.updateUi()},50);self.wrapper.find("select").each(function(){var len=0;$(this).find("option").each(function(){var ol=$(this).text().length;
if(ol>len){len=ol}});$(this).width((10*len)+25)});var depSel=this.getEl("dep");var ticketReader={getCategoryId:function(){var catId=self.getEl("cat").val();
return parseInt(catId)||0},getPriorityVal:function(){var id=this.getPriorityId();if(!id){return -999999999
}if(!window.DESKPRO_TICKET_PRI_MAP||!window.DESKPRO_TICKET_PRI_MAP[id]){return 0}return parseInt(window.DESKPRO_TICKET_PRI_MAP[id])
},getPriorityId:function(){var catId=self.getEl("pri").val();return parseInt(catId)||0},getProductId:function(){var catId=self.getEl("prod").val();
return parseInt(catId)||0},getOrganizationId:function(){return 0},getWorkflow:function(){var catId=self.getEl("work").val();
return parseInt(catId)||0}};var tplHolder=this.getEl("message_template_holder");var tplSel=this.getEl("message_template");
var tplSelOrig=this.getEl("message_template_orig");var fieldDisplayFetch=new DeskPRO.Agent.PageHelper.TicketFieldDisplay(ticketReader,"create");
function updateFields(){$(".ticket-field",self.getEl("fields_container")).removeClass("item-on").hide();
var fieldDisplay=fieldDisplayFetch.getFields(depSel.val());Object.each(fieldDisplay,function(fields,section){Array.each(fields,function(f){if(f.field_type=="ticket_field"){var classname="ticket-field-"+f.field_id
}else{var classname=f.field_type}$(".ticket-field."+classname,self.wrapper).not(".error-message").detach().appendTo(self.getEl("fields_container")).show().addClass("item-on")
})});var depId=depSel.val();var opts=tplSelOrig.find("option.department_"+depId+", option.department_0").clone();
if(opts[0]){var selected=tplSel.val();tplSel.empty();tplSel.append('<option value="0" selected="selected">Blank</option>');
tplSel.append(opts);tplHolder.show();self.getEl("message_template_holder_row").show();var selectedOpt=tplSel.find('[value="'+selected+'"]');
if(selectedOpt[0]){tplSel.select2("val",selected)}else{tplSel.select2("val",0);tplSel.change()}}else{tplSel.empty();
tplHolder.hide();self.getEl("message_template_holder_row").hide()}self.getEl("fields_container").find("tbody").removeClass("last").filter(":visible").last().addClass("last");
self.updateUi()}depSel.on("change",function(ev){updateFields()});$(".ticket-field select",this.wrapper).on("change",function(){updateFields()
});updateFields();var statusMenuTrigger=this.el.find(".status-menu-trigger");var footerEl=this.getEl("message_footer");
var statusMenu=this.getEl("status_menu");statusMenu.css("z-index",999999);var statusMenuH=null;var statusBackdrop=null;
var statusMacroFilter=null;var statusMacroList=statusMenu.find(".macro-list");var statusListItems=null;
var replyAsType=this.getEl("reply_as_type");var closeStatusMenu=function(){statusBackdrop.hide();statusMenu.hide()
};var updateStatusPos=function(){statusMenuH=statusMenu.height();if(statusMenu>500){statusMenu.find("macro-list").css("max-height",500).css("overflow","auto");
statusMenuH=500}var pos=footerEl.offset();statusMenu.css({left:pos.left+6,top:pos.top-statusMenuH+3})
};var openStatusMenu=function(){statusListItems=statusMenu.find("li[data-type]").not(".off");if(!statusBackdrop){statusBackdrop=$('<div class="backdrop"></div>');
statusBackdrop.css("z-index",999998);statusBackdrop.appendTo("body");statusBackdrop.on("click",function(ev){ev.stopPropagation();
closeStatusMenu()});statusMenu.detach().appendTo("body");statusMacroFilter=statusMenu.find(".macro-filter");
statusMenu.on("click","li[data-type]",function(ev){ev.stopPropagation();self.setReplyAsOption($(this));
closeStatusMenu()});statusMacroFilter.on("keyup",function(ev){var isCtrl=false;if(ev.ctrlKey&&DeskPRO_Window.keyboardShortcuts.isMac){isCtrl=true
}else{if(ev.altKey){isCtrl=true}}if(isCtrl){if(isCtrl&&(ev.which==85)){closeStatusMenu();self.setReplyAsOptionName("awaiting_user");
return}if(isCtrl&&(ev.which==65)){closeStatusMenu();self.setReplyAsOptionName("awaiting_agent");return
}if(isCtrl&&(ev.which==68)){closeStatusMenu();self.setReplyAsOptionName("resolved");return}}if(ev.keyCode==13){ev.preventDefault();
var current=statusListItems.filter(".cursor");if(current[0]){self.setReplyAsOption(current);closeStatusMenu()
}}else{if(ev.keyCode==27){ev.preventDefault();closeStatusMenu()}else{if(ev.keyCode==40||ev.keyCode==38){ev.preventDefault();
var dir=ev.keyCode==40?"down":"up";var current=statusListItems.filter(".cursor");if(!current.length){if(dir=="down"){statusListItems.first().addClass("cursor")
}else{statusListItems.last().addClass("cursor")}}else{var nextIndex=statusListItems.index(current);if(dir=="down"){nextIndex++
}else{nextIndex--}if(nextIndex<0){nextIndex=statusListItems.length-1}else{if(nextIndex>(statusListItems.length-1)){nextIndex=0
}}current.removeClass("cursor");statusListItems.eq(nextIndex).addClass("cursor")}}}}});statusMacroFilter.on("keyup",function(){var val=$.trim($(this).val());
if(!val){statusMacroList.find("li").show().removeClass("off");updateStatusPos()}else{val=val.toLowerCase();
statusMacroList.find("li").each(function(){if($(this).text().toLowerCase().indexOf(val)!==-1){$(this).show().removeClass("off")
}else{$(this).hide().addClass("off")}});updateStatusPos()}statusListItems=statusMenu.find("li[data-type]").not(".off");
if(!statusListItems.filter(".cursor")[0]){statusMenu.find("li.cursor").removeClass("cursor");statusListItems.first().addClass("cursor")
}})}var type=replyAsType.data("type");statusMenu.find("li").removeClass("cursor").filter("[data-type]").removeClass("on").filter('[data-type="'+type+'"]').addClass("on");
var w=self.getEl("reply_btn_group").width()-3;if(w<200){w=200}statusMenu.width(w);statusBackdrop.show();
updateStatusPos();statusMenu.show();statusMacroFilter.focus()};this.openStatusMenu=openStatusMenu;statusMenuTrigger.on("click",function(ev){ev.preventDefault();
openStatusMenu()});$("#settingswin").on("dp_macros_updated",function(ev){Array.each(ev.macroItems,function(info){var has=statusMacroList.find(".res-ticketmacro-"+info.id);
if(has[0]){return}var li=$('<li><div class="on-icon"><i class="icon-okay"></i></div><span class="macro-title"></span></li>');
li.data("get-macro-url",BASE_URL+"agent/tickets/0/ajax-get-macro?macro_id="+info.id+"&macro_reply_context=1");
li.data("label","Send Reply and "+info.title);li.data("type","macro:"+info.id);li.attr("data-type","macro:"+info.id);
li.find(".macro-title").text(info.title);statusMacroList.append(li)})});this.el.find(".expander").on("click",function(){var target=self.el.find($(this).data("target"));
if(target.is(":visible")){$(this).removeClass("expanded").addClass("is-hidden");target.slideUp("fast")
}else{$(this).addClass("expanded").removeClass("is-hidden");target.slideDown("fast")}})},setReplyAsOptionName:function(name){var item=this.getEl("status_menu").find('li[data-type="'+name+'"]').first();
if(item[0]){this.setReplyAsOption(item)}},setReplyAsOption:function(item){var replyAsType=this.getEl("reply_as_type");
var html=Orb.escapeHtml(item.data("label"));html=html.replace(/^Send Reply/,'Send <span class="show-key-shortcut">R</span>eply');
replyAsType.data("type",item.data("type")).html(html);var macroUrl=item.data("get-macro-url");var textarea=this.textarea;
var api=this.textarea.data("redactor");if(!macroUrl){this.getEl("actions_row").hide();this.updateUi();
this.wrapper.find("div.layout-content").trigger("goscrollbottom")}else{var actionsRow=this.getEl("actions_row");
var actionsRowList=actionsRow.find("ul");actionsRowList.empty();actionsRowList.append('<li class="load"><i class="flat-spinner"></i></li>');
actionsRow.show();this.updateUi();this.wrapper.find("div.layout-content").trigger("goscrollbottom");$.ajax({url:macroUrl,type:"GET",context:this,dataType:"json",success:function(data){actionsRowList.empty();
Array.each(data.descriptions,function(desc){var li=$("<li />");li.html(desc);actionsRowList.append(li)
});var sig=null;if(api){sig=api.$editor.find(".dp-signature-start");if(!sig[0]){sig=null}}actionsRowList.find(".with-reply, .with-snippet").each(function(){var pos=$(this).data("reply-pos");
var html=$(this).find(".reply-text").get(0).innerHTML;if(pos){if(api){if(pos=="overwrite"){api.$editor.html(html);
if(sig){api.$editor.append(sig)}}else{if(pos=="prepend"){api.$editor.prepend(html)}else{if(sig){var usesig=sig;
var prev=sig.prev();if(prev[0]&&prev.is("p")&&$.trim(prev.text())===""){usesig=prev;var prev2=prev.prev();
if(prev2[0]&&prev2.is("p")&&$.trim(prev2.text())===""){prev2.remove()}}usesig.before(html)}else{api.$editor.append(html)
}}}api.syncCode()}else{var text=$("<div>"+html+"</div>");text=text.text().trim();textarea.val($.trim(textarea.val()+"\n\n"+text))
}}});var agentId=parseInt(actionsRowList.find(".with-agent").data("agent-id"));if(agentId){if(agentId==-1){agentId=DESKPRO_PERSON_ID
}this.getEl("agent_sel").select2("val",agentId)}var agentTeamId=parseInt(actionsRowList.find(".with-agent-team").data("agent-team-id"));
if(agentTeamId){if(agentTeamId==-1){if(!window.DESKPRO_TEAM_IDS||!window.DESKPRO_TEAM_IDS.length){agentTeamId=null
}else{agentTeamId=window.DESKPRO_TEAM_IDS[0]}}if(agentTeamId){this.getEl("agent_team_sel").select2("val",agentTeamId)
}}if(actionsRowList.find(".with-close-tab")){this.getEl("close_tab_opt").prop("checked",true)}var setSubject=actionsRowList.find(".with-set-subject").text().trim();
if(setSubject){this.getEl("subject").val(setSubject)}this.updateUi();this.wrapper.find("div.layout-content").trigger("goscrollbottom")
}})}},markForReload:function(){if(!this.markedForReload){this.markedForReload=true;this.addEvent("deactivate",this.closeSelf.bind(this))
}},closeSelf:function(){var ev={cancel:false};this.fireEvent("closeSelf",ev);if(!ev.cancel){this.parent()
}},submit:function(){if(this.pauseSend){window.setTimeout(this.submit.bind(this),250)}this.getEl("action").val(this.getEl("reply_as_type").data("type"));
var formData=this.form.serializeArray();$("div.error.section",this.wrapper).removeClass("error");$(".error-message-on",this.wrapper).removeClass("error-message-on").hide();
this.getEl("error_section").hide();this.wrapper.parent().addClass("loading");this.getEl("send_btn").hide();
this.getEl("send_loading").show();$.ajax({url:BASE_URL+"agent/tickets/new/save",type:"POST",data:formData,dataType:"json",context:this,complete:function(){this.wrapper.parent().removeClass("loading");
this.getEl("send_btn").show();this.getEl("send_loading").hide()},success:function(data){if(data.error){if(data.is_dupe){DeskPRO_Window.showConfirm("The ticket you tried to submit is an exact duplicate of an existing ticket. This new ticket was not saved.",function(){DeskPRO_Window.runPageRoute("ticket:"+BASE_URL+"agent/tickets/"+data.dupe_ticket_id)
},function(){},"View Existing Ticket","hidden")}else{Array.each(data.error_codes,function(code){this.showErrorCode(code)
},this);if(data.error_messages){this.showErrorCode("free");var free=$("<div/>");Array.each(data.error_messages,function(msg){var x=$("<div/>");
x.text("- "+msg);free.append(x)});this.getEl("freemessage").html(free.html())}this.updateUi()}}if(data.ticket_id){if(data.comment_id){DeskPRO_Window.getMessageBroker().sendMessage("agent-ui.comment-remove",{comment_id:data.comment_id,comment_type:data.comment_type})
}if(data.can_view&&this.getEl("opt_open_tab").is(":checked")){DeskPRO_Window.runPageRoute("ticket:"+BASE_URL+"agent/tickets/"+data.ticket_id)
}this.closeSelf()}}})},showErrorCode:function(code){$("."+code+".error-message",this.wrapper).addClass("error-message-on").show();
switch(code){case"person_id":case"person_no_user":case"person_email_address":$("div.user-section.section",this.wrapper).addClass("error");
break;case"subject":$("div.subject-section.section",this.wrapper).addClass("error");break;case"message":$("div.message-section.section",this.wrapper).addClass("error");
break}this.getEl("error_section").show();this.updateUi()},clearErrorCode:function(code){$("."+code+".error-message",this.wrapper).removeClass("error-message-on").hide();
switch(code){case"person_id":case"person_no_user":case"person_email_address":$("div.user-section.section",this.wrapper).removeClass("error");
break;case"subject":$("div.subject-section.section",this.wrapper).removeClass("error");break;case"message":$("div.message-section.section",this.wrapper).removeClass("error");
break}if(this.getEl("error_section").find(".error-message-on")[0]){this.getEl("error_section").show()
}else{this.getEl("error_section").hide()}this.updateUi()},updateUi:function(){var x;if(!this.IS_ACTIVE){return
}if(this.wrapper){if(!this.scrollHandlers){this.scrollHandlers=this.wrapper.find("div.with-scroll-handler")
}for(x=0;x<this.scrollHandlers.length;x++){var sh=$(this.scrollHandlers[x]).data("scroll_handler");if(sh&&sh.updateSize){sh.updateSize()
}}if(this.doScrollBottom){this.wrapper.find("div.layout-content").trigger("goscrollbottom_stick");this.doScrollBottom=false
}}this.fireEvent("updateUi")},insertMessageText:function(content){var textarea=this.getEl("message");
if(textarea.data("redactor")){textarea.data("redactor").insertHtml(DP.convertTextToWysiwygHtml(content,true))
}else{var pos=textarea.getCaretPosition();if(!pos){textarea.setCaretPosition(0)}textarea.insertAtCaret(content);
textarea.trigger("textareaexpander_fire")}},setMessageText:function(content,is_quote){var textarea=this.getEl("message");
if(is_quote){content="> "+content.replace(/\r\n|\n/,"\n> ")}if(textarea.data("redactor")){content=DP.convertTextToWysiwygHtml(content,true);
if(is_quote){content="<br/><br/><blockquote>"+content+"</blockquote>"}textarea.setCode(content)}else{if(is_quote){content="\n\n"+content
}textarea.val(content);textarea.trigger("textareaexpander_fire")}},setNewByComment:function(data){this.setMessageText(data.name+" <"+data.email+"> wrote:\n"+data.message,true);
this.getEl("for_comment_type").val(data.content_type);this.getEl("for_comment_id").val(data.comment_id);
$(".pending-info.comment",this.wrapper).show();this.getEl("comment_title").text(data.name+" ("+data.email+")");
this.getEl("comment_object_link").data("route","page:"+data.object_url).text(data.object_title);this.getEl("user_searchbox").find("input.person-id").val(data.person_id);
this.getEl("usersearch").val(data.email_address);this.getEl("user_section").hide();this.getEl("choose_user").hide();
this.getEl("user_searchbox").find("input.person-id").val(data.person_id);this.setUser(data.person_id);
if(data.status=="validating"){$('option[value="approve"]',this.getEl("comment_action")).hide()}else{$('option[value="approve"]',this.getEl("comment_action")).show()
}this.updateUi()},setNewByChat:function(data){var self=this;this.getEl("for_chat_id").val(data.chat_id);
this.getEl("chat_title").text(data.chat_title);$(".pending-info.chat",this.wrapper).show();if(data.person_id){this.setUser(data.person_id,data.session_id);
this.getEl("user_searchbox").find("input.person-id").val(data.person_id);this.getEl("user_section").hide();
this.getEl("choose_user").hide()}else{$.ajax({type:"GET",url:BASE_URL+"agent/tickets/new/get-person-row/0",data:{"email":data.email},dataType:"html",context:this,success:function(html){self.placeUserRow(html);
self.updateUi()}})}this.updateUi()},setNewByPerson:function(data){this.getEl("user_searchbox").find("input.person-id").val(data.person_id);
this.getEl("choose_user").hide();this.getEl("user_section").show();this.getEl("user_choice").show().html('<div style="padding:10px;"><div class="loading-icon-big"></div></div>');
this.setUser(data.person_id);this.updateUi()},_resetForX:function(){this.wrapper.find(".pending-info").hide();
this.getEl("user_section").show();this.getEl("choose_user").show();this.getEl("for_chat_id").val("");
this.getEl("for_comment_type").val("");this.getEl("for_comment_id").val("");this.updateUi()},_initUserSection:function(){var self=this;
var searchbox=this.getEl("user_searchbox");var userfields=this.getEl("user_choice");var rechooseBtn=this.getEl("switch_user");
rechooseBtn.on("click",function(ev){ev.preventDefault();showUserChoice()});var showUserChoice=function(){userfields.empty();
userfields.hide();searchbox.show();self.getEl("choose_user").show();rechooseBtn.hide();self.loadSnippetsViewer();
self.updateUi()};var placeUserRow=function(html){self.placeUserRow(html)};searchbox.bind("personsearchboxclick",function(ev,personId,name,email,sb){$.ajax({type:"GET",url:BASE_URL+"agent/tickets/new/get-person-row/"+personId,dataType:"html",context:this,success:function(html){self.clearErrorCode("person_id");
self.clearErrorCode("person_email_address");self.clearErrorCode("person_no_user");$("input.person-id",searchbox).val(personId);
placeUserRow(html);self.loadSnippetsViewer();self.updateUi()}});sb.close();sb.reset()});searchbox.bind("personsearchboxclicknew personsearchenter",function(ev,term,sb){$.ajax({type:"GET",url:BASE_URL+"agent/tickets/new/get-person-row/0",data:{"email":term},dataType:"html",context:this,success:function(html){placeUserRow(html);
if(term.indexOf("@")!==-1){$("input.email",userfields).val(term)}else{$("input.name",userfields).val(term)
}var personId=self.getEl("user_choice").find(".set_userid").val();if(personId){self.clearErrorCode("person_id");
self.clearErrorCode("person_email_address");self.clearErrorCode("person_no_user");$("input.person-id",self.getEl("user_searchbox")).val(personId);
self.loadSnippetsViewer()}self.updateUi()}});sb.close();sb.reset()})},setUser:function(person_id,session_id){var self=this;
$.ajax({type:"GET",url:BASE_URL+"agent/tickets/new/get-person-row/0",data:{"person_id":person_id,"session_id":session_id},dataType:"html",context:this,success:function(html){this.placeUserRow(html)
}})},placeUserRow:function(html){var self=this;var searchbox=this.getEl("user_searchbox");var userfields=this.getEl("user_choice");
var rechooseBtn=this.getEl("switch_user");userfields.empty();userfields.html(html);self.getEl("choose_user").hide();
rechooseBtn.show();searchbox.hide();userfields.show();var apiData=userfields.find(".api_data");this.meta.person_api_data={};
if(apiData[0]){try{this.meta.person_api_data=$.parseJSON(apiData.val())}catch(e){}}var e=$("input.email",userfields);
if(e&&e[0]){var fnCheck=function(){if(e.val()&&e.val().indexOf("@")!==-1){self.clearErrorCode("person_email_address");
self.clearErrorCode("person_no_user")}};fnCheck();e.on("change",fnCheck)}var e=$("input.set_person_id",userfields);
if(e[0]){var person_id=e.val();this.getEl("user_searchbox").find("input.person-id").val(person_id)}this.updateUi()
},_initCcSelection:function(){var self=this;var ccbox=this.getEl("user_ccbox");ccbox.bind("personsearchboxclick",function(ev,personId,name,email,sb){$.ajax({type:"GET",url:BASE_URL+"agent/people/"+personId+"/basic.json",dataType:"json",context:this,success:function(data){var html=[];
html.push("<li>");html.push('<em class="remove"></em>');html.push('<a data-route="page:'+data.url+'">'+data.contact_name+"</a>");
html.push('<input type="hidden" name="newticket[add_cc_person][]" value="'+personId+'" />');html.push("</li>");
html=html.join("");self.getEl("cc_list").append(html);self.updateUi()}});sb.close();sb.reset()});ccbox.bind("personsearchboxclicknew personsearchenter",function(ev,term,sb){var rowid=Orb.uuid();
var html=[];html.push("<li>");html.push('<em class="remove"></em>');html.push('<input type="text" class="name" name="newticket[add_cc_newperson]['+rowid+'][name]" placeholder="Enter a full name" />');
html.push('<input type="text" class="email" name="newticket[add_cc_newperson]['+rowid+'][email]" placeholder="Enter an email address" />');
html.push("</li>");html=$(html.join(""));if(term.indexOf("@")!==-1){$("input.email",html).val(term)}else{$("input.name",html).val(term)
}self.getEl("cc_list").append(html);self.updateUi();sb.close();sb.reset()});this.getEl("cc_list").on("click","em.remove",function(){$(this).closest("li").remove();
self.updateUi()})},_initMessageSection:function(){var self=this;this.getEl("text_snippets_btn").on("click",function(ev){ev.preventDefault();
self.openSnippetsViewer()});this.loadSnippetsViewer();var textarea=this.getEl("message");this.textarea=textarea;
if(DeskPRO_Window.canUseAgentReplyRte()){var sig=this.getEl("signature_value_html").val()||"";sig=sig.replace(/<div class="dp-signature-start">([\w\W]*)<\/div>/,'<p class="dp-signature-start">$1</p>');
if(sig&&parseInt(this.getEl("parent_ticket_id").val())===0){textarea.val(($.browser.msie?"<p></p><p></p>":"<p><br></p><p><br></p>")+"\n\n"+sig)
}DeskPRO_Window.initRteAgentReply(textarea,{defaultIsHtml:true,inlineHiddenPosition:this.getEl("is_html_reply"),callback:function(obj){obj.addBtnFirst("dp_attach","Click here to attach a file. You may also drag a file from your computer desktop into this reply area to upload attachments faster.",function(){});
obj.addBtnAfter("dp_attach","dp_snippets","Open snippets",function(){self.openSnippetsViewer()});obj.addBtnSeparatorAfter("dp_attach");
obj.addBtnSeparatorAfter("dp_snippets");var snippetBtn=obj.$toolbar.find(".redactor_btn_dp_snippets").closest("li");
snippetBtn.addClass("snippets").find("a").html('<span class="show-key-shortcut">S</span>nippets');var attachBtn=obj.$toolbar.find(".redactor_btn_dp_attach").closest("li");
attachBtn.addClass("attach");attachBtn.find("a").text("Attach").append('<input type="file" class="file" name="file-upload" />')
}});this.getEl("is_html_reply").val(1);var ed=textarea.getEditor();var api=textarea.data("redactor");
var lastH=ed.height();ed.on("keyup",function(ev){var isCtrl=false;if(ev.ctrlKey&&DeskPRO_Window.keyboardShortcuts.isMac){isCtrl=true
}else{if(ev.altKey){isCtrl=true}}if(isCtrl){if(isCtrl&&(ev.which==85)){ev.preventDefault();self.shortcutReplySetAwaitingUser();
return}if(isCtrl&&(ev.which==65)){ev.preventDefault();self.shortcutReplySetAwaitingAgent();return}if(isCtrl&&(ev.which==68)){ev.preventDefault();
self.shortcutReplySetResolved();return}if(isCtrl&&(ev.which==82)){ev.preventDefault();self.shortcutSendReply();
return}if(isCtrl&&(ev.which==83)){ev.preventDefault();window.setTimeout(function(){self.shortcutOpenSnippets()
},10);return}if(isCtrl&&(ev.which==79)){ev.preventDefault();window.setTimeout(function(){self.shortcutReplyOpenProperties()
},10);return}}});ed.on("keypress change",function(){textarea.addClass("touched");if(lastH!=ed.height()){lastH=ed.height();
self.doScrollBottom=true;window.setTimeout(function(){if(self.page){self.page.updateUi()}},50)}});var te=new DeskPRO.TextExpander({textarea:ed,onCombo:function(combo,ev){combo=combo.replace(/%/g,"");
if(window.DESKPRO_TICKET_SNIPPET_SHORTCODES&&window.DESKPRO_TICKET_SNIPPET_SHORTCODES[combo]){ev.preventDefault();
var snippetId=window.DESKPRO_TICKET_SNIPPET_SHORTCODES[combo];var focus=api.getFocus(),focusNode=$(focus[0]),testText;
if(focus[0].nodeType==3){testText=focusNode.text().substring(0,focus[1])}else{focus[0]=focusNode.contents().get(focus[1]-1);
focusNode=$(focus[0]);testText=focusNode.text();focus[1]=testText.length}var lastAt=testText.lastIndexOf("%"),matches=[];
if(lastAt!=-1){api.setSelection(focus[0],lastAt,focus[0],focus[1])}var editable=$.browser.webkit?' contenteditable="false"':"";
api.insertHtml('<span class="editor-inserting-var snippet-'+snippetId+'" '+editable+' data-snippet-id="'+snippetId+'">Inserting snippet...</span>');
var personId=self.getEl("user_searchbox").find("input.person-id").val()||0;self.pauseSend=true;$.ajax({url:BASE_URL+"agent/tickets/0/get-snippet/"+snippetId,dataType:"text",data:{person_id:personId},complete:function(){self.pauseSend=false
},success:function(data){var el=api.$editor.find(".editor-inserting-var.snippet-"+snippetId);data=$("<div>"+data+"</div>");
var coll=data.find("> br");coll.last().remove();var cursor=$('<span class="_cursor"></span>');var cursorPos=data.find("> p");
if(!cursorPos[0]){cursorPos=data}el.after(data);cursorPos.append(cursor);el.remove();var next=data.next();
if(next.is("br")){next.remove()}if(cursor.next().is("br")){cursor.next().remove()}if(cursor.prev().is("br")){cursor.prev().remove()
}api.setSelection(cursor[0],0,cursor[0],0);api.syncCode()}})}}})}else{var sig=this.getEl("signature_value").val();
if(sig){textarea.val("\n\n"+sig)}textarea.css("height",100);textarea.TextAreaExpander(150,1000).on("textareaexpander_expanded",function(){self.updateUi();
window.setTimeout(function(){if(self.wrapper){self.wrapper.find("div.layout-content").trigger("goscrollbottom_stick")
}},250)})}},loadSnippetsViewer:function(){var self=this;if(this.snippetsViewer){this.snippetsViewer.destroy()
}var self=this;this.snippetsViewer=new DeskPRO.Agent.Widget.SnippetViewer({positionMode:this.meta.isPopover?"over":"side",onBeforeOpen:function(){var redactor=self.getEl("message").data("redactor");
if(redactor){redactor.saveSelection()}},onSnippetClick:function(info){var ticketLangId=self.getEl("value_form").find(".language_id").val();
if(!ticketLangId){ticketLangId=info.language_id==DESKPRO_DEFAULT_LANG_ID}var snippetId=info.snippetId;
var snippetCode=info.snippetCode;var agentText;var defaultText;var wantText;var useText;var result;Array.each(snippetCode,function(info){if(info.value){if(info.language_id==ticketLangId){wantText=info.value
}if(info.language_id==DESKPRO_PERSON_LANG_ID){agentText=info.value}if(info.language_id==DESKPRO_DEFAULT_LANG_ID){defaultText=info.value
}useText=info.value}});if(wantText){useText=wantText}else{if(agentText){useText=agentText}else{if(defaultText){useText=defaultText
}}}try{var tpl=twig({data:useText,strict_variables:true});result=tpl.render({ticket:{person:self.meta.person_api_data}},{strict_variables:true})
}catch(e){console.log("Snippet render failed: %o",e);result=useText}var redactor=self.getEl("message").data("redactor");
if(redactor){var html=result;html=html.replace(/<\/p>\s*<p>/g,"<br/>");html=html.replace(/^<p>/,"");html=html.replace(/<\/p>$/,"");
redactor.restoreSelection();redactor.insertHtml(html)}else{self.insertMessageText(result)}}})},openSnippetsViewer:function(){this.snippetsViewer.open()
},_initOtherSection:function(){var self=this;this.otherTabs=new DeskPRO.UI.SimpleTabs({triggerElements:$("li",this.getEl("other_props_tabs")),context:this.getEl("other_props_tabs_content"),autoSelectFirst:false,onTabSwitch:function(eventData){if(!self.labelsInput&&eventData.tabContent.hasClass("tab-properties")){self.labelsInput=new DeskPRO.UI.LabelsInput({type:"tickets",textarea:$(".ticket-tags input",eventData.tabContent)});
self.ownObject(self.labelsInput)}self.updateUi()},onTabClick:(function(ev){var contentWrap=this.getEl("other_props_tabs_content");
var navWrap=this.getEl("other_props_tabs_wrap");var tab=ev.tabEl;if(!$(".on",navWrap).length||tab.is(".on")){if(contentWrap.is(":visible")){contentWrap.hide();
navWrap.removeClass("on")}else{contentWrap.show();navWrap.addClass("on")}}self.updateUi()}).bind(this)});
this.ownObject(this.otherTabs);var self=this;$(".add-cc-trigger",this.wrapper).on("click",function(){var txt=self.getEl("add_cc_txt");
var val=txt.val();var el=$("<li>"+val+'<input type="hidden" name="newticket[new_parts][]" value="'+val+'" />&nbsp;&nbsp;<span class="remove-trigger" style="cursor: pointer;">x</span></li>');
$(".remove-trigger",el).on("click",function(ev){ev.preventDefault();ev.stopPropagation();el.remove();
self.updateUi()});el.appendTo(self.getEl("cc_list"));self.updateUi();txt.val("")});var list=$(".file-list",this.wrapper);
$("input",list[0]).live("click",function(){var el=$(this);var li=el.parent();if(el.is(":checked")){li.removeClass("unchecked")
}else{li.addClass("unchecked")}self.updateUi()})},focusOnReply:function(){var txt=this.textarea;if(txt.data("redactor")){var first=!txt.hasClass("touched");
txt.setFocus();if(first){var cursor=txt.data("redactor").$editor.find("> *").first();txt.data("redactor").setSelection(cursor[0],0,cursor[0],0)
}}else{txt.focus()}},shortcutOpenSnippets:function(){this.openSnippetsViewer()},shortcutSendReply:function(){this.submit()
},shortcutReplySetAwaitingUser:function(){this.setReplyAsOptionName("awaiting_user")},shortcutReplySetAwaitingAgent:function(){this.setReplyAsOptionName("awaiting_agent")
},shortcutReplySetResolved:function(){this.setReplyAsOptionName("resolved")},shortcutReplyOpenProperties:function(){this.openStatusMenu()
}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page");DeskPRO.Agent.PageFragment.Page.PublishNewCat=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="pubnewcat";this.allowDupe=true},closeSelf:function(){this.fragmentOverlay.close()},initPage:function(el){var self=this;
this.wrapper=el;this.el=el;this.contentWrapper=this.wrapper.children(".layout-content").attr("id",Orb.getUniqueId());
this.parent(el);var form=el.find("form");form.on("submit",function(ev){Orb.cancelEvent(ev)});var footer=el.find("footer");
footer.find(".submit-trigger").on("click",function(ev){Orb.cancelEvent(ev);footer.addClass("dp-loading-on");
var postData=form.serializeArray();$.ajax({data:postData,url:form.attr("action"),type:"POST",complete:function(){DeskPRO_Window.sections.publish_section.reload();
self.closeSelf()}})})}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page");DeskPRO.Agent.PageFragment.Page.NewFeedback=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="newfeedback";this.allowDupe=true},initPage:function(el){var self=this;this.wrapper=el;
this.parent(el);if(!this.getEl("cat").find("option")[0]){this.wrapper.find(".form-header-error").show();
this.wrapper.find(".form-outer").hide();this.markForReload()}this.form=$("form",this.wrapper).on("submit",function(ev){ev.preventDefault()
});$("button.submit-trigger",this.wrapper).on("click",this.submit.bind(this));this._initCategorySection();
this._initTitleSection();this._initContentSection();this._initOtherSection();this.stateSaver=new DeskPRO.Agent.PageHelper.StateSaver({stateId:"newnews",listenOn:this.getEl("newfeedback")});
this.ownObject(this.stateSaver);window.setTimeout(function(){if(self.OBJ_DESTROYED){return}self.wrapper.find("select").each(function(){if($(this).prop("multiple")){$(this).width(300)
}DP.select($(this))});self.updateUi()},300)},destroyPage:function(){var el=this.wrapper.find(".article-section");
if(el[0]){el.get(0).parentNode.removeChild(el.get(0))}},markForReload:function(){if(!this.markedForReload){this.markedForReload=true;
this.addEvent("deactivate",this.closeSelf.bind(this))}},closeSelf:function(){var ev={cancel:false};this.fireEvent("closeSelf",ev);
if(!ev.cancel){this.parent()}},submit:function(){var formData=this.form.serializeArray();if(this.labelsInput){formData.append(this.labelsInput.getFormData())
}$("div.error.section",this.wrapper).removeClass("error");$(".error-message-on",this.wrapper).removeClass("error-message-on");
this.stateSaver.stop();this.wrapper.addClass("loading");$.ajax({url:BASE_URL+"agent/feedback/new/save",type:"POST",data:formData,dataType:"json",context:this,complete:function(){this.wrapper.removeClass("loading")
},success:function(data){if(data.error){Array.each(data.error_codes,function(code){this.showErrorCode(code)
},this);this.updateUi();return}if(data.success){DeskPRO_Window.runPageRoute("page:"+BASE_URL+"agent/feedback/view/"+data.feedback_id);
this.markForReload();this.closeSelf()}else{alert("There was an error with the form")}}})},showErrorCode:function(code){$("."+code+".error-message",this.wrapper).addClass("error-message-on")
},_initCategorySection:function(){var self=this;this.getEl("cat").on("change",function(){if(parseInt($(this).val())){self.getEl("cat_section").addClass("done")
}else{self.getEl("cat_section").removeClass("done")}})},_initTitleSection:function(){var self=this;var fn=function(){if($(this).val().trim()==""){self.getEl("title_section").removeClass("done")
}else{self.getEl("title_section").addClass("done")}};this.getEl("title").on("change",fn).on("keypress",fn).on("change",function(){var val=$(this).val().trim().toLowerCase();
val=val.replace(/[^a-z0-9\-_]/g,"-");val=val.replace(/-{2,}/g,"-");self.getEl("slug").val(val)})},_initContentSection:function(){var self=this;
this.getEl("content").css({width:this.wrapper.width()-150});var h=$(window).height();this.getEl("content").css("height",Math.max(h-500,200));
DP.rteTextarea(this.getEl("content"),{setup:function(ed){ed.onKeyPress.add(function(){if(self.stateSaver){self.stateSaver.triggerChange()
}})}})},_initOtherSection:function(){var self=this;this.otherTabs=new DeskPRO.UI.SimpleTabs({triggerElements:$("li",this.getEl("other_props_tabs")),context:this.getEl("other_props_tabs_content"),autoSelectFirst:false,onTabSwitch:function(eventData){if(!self.labelsInput&&eventData.tabContent.hasClass("tab-properties")){self.labelsInput=new DeskPRO.UI.LabelsInput({type:"feedback",fieldName:"newfeedback[labels]",input:$(".tags-wrap input",eventData.tabContent),onChange:function(){if(self.stateSaver){self.stateSaver.triggerChange()
}}});self.ownObject(self.labelsInput)}},onTabClick:(function(ev){var contentWrap=this.getEl("other_props_tabs_content");
var navWrap=this.getEl("other_props_tabs_wrap");var tab=ev.tabEl;if(!$(".on",navWrap).length||tab.is(".on")){if(contentWrap.is(":visible")){contentWrap.hide();
navWrap.removeClass("on")}else{contentWrap.show();navWrap.addClass("on")}}}).bind(this)});this.ownObject(this.otherTabs);
DeskPRO_Window.util.fileupload(this.wrapper,{page:this});var list=$(".file-list",this.wrapper);$("input",list[0]).live("click",function(){var el=$(this);
var li=el.parent();if(el.is(":checked")){li.removeClass("unchecked")}else{li.addClass("unchecked")}self.updateUi()
})}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page");DeskPRO.Agent.PageFragment.Page.Organization=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){var self=this;
this.parent();this.TYPENAME="organization";this.tabBtn=null;this.noIgnoreForm=true;this.addEvent("render",function(container,id){if(id){self.tabBtn=$("#tabbtn_"+id)
}})},initMetaData:function(){DeskPRO_Window.recentTabs.add("org",this.meta.org_id,this.meta.title,BASE_URL+"agent/organizations/"+this.meta.org_id)
},initPage:function(el){this.wrapper=el;this.contentWrapper=$("div.layout-content:first",el);if(this.tabBtn){if(this.getMetaData("orgPicIcon")){this.tabBtn.find("a").find("i").attr("class","").addClass("image-icon").css("background-image",'url("'+this.getMetaData("orgPicIcon")+'")').css("background-position","50% 50%")
}}var self=this;this.contactEditor=new DeskPRO.Agent.PageFragment.Page.PersonHelper.ContactEditor(this,{saveUrl:BASE_URL+"agent/organizations/"+this.meta.org_id+"/save-contact-data.json",onReplaceEditor:function(){self.refreshPropBox()
}});this.ownObject(this.contactEditor);if(this.meta.perms.edit){var name=$("h3.name.editable:first",el);
if(!name.attr("id")){name.attr("id",Orb.getUniqueId())}var editable=new DeskPRO.Form.InlineEdit({baseElement:this.wrapper,editableClass:"person-name-editable",ajax:{url:BASE_URL+"agent/organizations/"+this.meta.org_id+"/ajax-save"},triggers:".edit-name-gear"});
$(this.wrapper).on("click",function(ev){editable.handleDocumentClick(ev)})}this.getEl("delete_btn").on("click",function(){var url=$(this).data("delete-url");
DeskPRO_Window.showConfirm($('<div>Are you sure you want to delete this organization? <strong class="warning">The organization will be permanantly deleted</strong>.'),function(){$.ajax({url:url,type:"POST",success:function(){DeskPRO_Window.showAlert("The organization was deleted")
}});self.closeSelf()})});this.changePic=new DeskPRO.Agent.PageFragment.Page.PersonHelper.ChangePic(this,{loadUrl:BASE_URL+"agent/organizations/"+this.meta.org_id+"/change-picture-overlay",saveUrl:BASE_URL+"agent/organizations/"+this.meta.org_id+"/ajax-save"});
this.ownObject(this.changePic);this._initLabels();this._initCustomFieldsEditor();this.getEl("members_list").on("click",".remove",function(){var row=$(this).closest(".member-row");
var personId=row.data("person-id");if(!personId){return}row.fadeOut("fast");$.ajax({url:BASE_URL+"agent/organizations/"+self.meta.org_id+"/ajax-save",data:{action:"remove-person",person_id:personId},type:"POST",context:this,error:function(){row.show()
},success:function(){row.remove();DeskPRO_Window.util.modCountEl(self.getEl("members_count"),"-")}})});
this.getEl("add_searchbox").bind("personsearchboxclicknew",function(ev,term,sb){if(DeskPRO_Window.newPersonLoader){DeskPRO_Window.newPersonLoader.open(function(page){page.setGuessTerm(term);
page.setOrganization(self.meta.org_id,self.getEl("editname").find('input[name="name"]').val())})}else{DeskPRO_Window.showAlert("You are not allowed to create new people")
}sb.close();sb.reset()});this.getEl("add_searchbox").bind("personsearchboxclick",function(ev,personId,name,email,sb){self.getEl("newmember_person_name").text(name);
self.getEl("newmember_person_email").text(email);self.getEl("newmember_person_id").val(personId);self.getEl("newmember_position").val("");
self.getEl("newmember_row").hide();self.getEl("newmember_row_named").show();sb.close();sb.reset()});var close_newmember_row=function(){self.getEl("add_searchbox_txt").val("");
self.getEl("newmember_row_named").hide();self.getEl("newmember_row").show()};this.getEl("newmember_cancel_btn").on("click",function(){close_newmember_row()
});this.getEl("newmember_btn").on("click",function(){var personId=self.getEl("newmember_person_id").val();
var pos=self.getEl("newmember_position").val();$.ajax({url:BASE_URL+"agent/organizations/"+self.meta.org_id+"/ajax-save",data:{action:"add-person",person_id:personId,position:pos},type:"POST",context:this,success:function(data){self.getEl("newmember_person_input").val("");
self.getEl("newmember_position").val("");self.getEl("newmember_person_id").val("0");if(data.already_in_organization){DeskPRO_Window.showAlert("That user is already in an organization")
}else{var row=$(data.row_html);row.insertAfter(self.getEl("newmember_row_named"));DeskPRO_Window.util.showSavePuff(row);
DeskPRO_Window.util.modCountEl(self.getEl("members_count"),"+")}}});close_newmember_row()});DeskPRO_Window.getMessageBroker().addMessageListener("new-org-user",function(info){if(!info.organization_id||info.organization_id!=self.meta.org_id){return
}$.ajax({url:BASE_URL+"agent/organizations/"+self.meta.org_id+"/ajax-save",data:{action:"get-person-row",person_id:info.person_id},type:"GET",context:this,success:function(data){var row=$(data.row_html);
row.insertAfter(self.getEl("newmember_row_named"));DeskPRO_Window.util.showSavePuff(row);DeskPRO_Window.util.modCountEl(self.getEl("members_count"),"+")
}})},this);this.getEl("members_list").on("click",".organization-manager-icon",function(ev){ev.stopPropagation();
var $this=$(this),line=$this.closest("tr");line.toggleClass("is-manager");$.ajax({url:$this.data("save-url"),type:"POST",data:{organization_manager:line.hasClass("is-manager")?1:0}});
$(this).qtip("hide",ev)});this.getEl("members_list").on("mouseover",".organization-manager-icon",function(ev){if($(this).is(".tipped-inited")){return
}var qtipOptions={content:{text:function(){var $this=$(this),line=$this.closest(".line");if(line.hasClass("is-manager")){return $this.data("is-manager")
}else{return $this.data("not-manager")}}},position:{my:"top center",at:"bottom center",viewport:$(window)},style:{classes:"ui-tooltip-shadow ui-tooltip-rounded"}};
$(this).qtip(qtipOptions).qtip("show",ev);$(this).addClass("tipped-inited")});this.getEl("members_list").on("click",".position-edit-trigger",function(ev){ev.stopPropagation();
var row=$(this).closest(".member-row");var label=$(".position-label",row);var input=$(".position-edit",row);
var inputTxt=$(".position-edit input",row);label.fadeOut("fast",function(){input.fadeIn("fast");input.get(0).focus()
});var done=function(){var val=inputTxt.val();if(val){label.text(val)}else{label.empty().append($('<span style="font-size: 11px; color: #959595;">No position set</span>'))
}input.fadeOut("fast",function(){label.fadeIn("fast")});$.ajax({url:inputTxt.data("save-url"),type:"POST",data:{organization_position:val}})
};if(!input.is(".has-init")){input.addClass("has-init");input.on("click",function(ev){ev.stopPropagation()
});input.on("keypress",function(){if(ev.keyCode==13){done()}});var closest=input.closest(".popover-wrapper");
$(closest.length?closest:document).on("click",done)}});$(".profile-box-container.tabbed",this.wrapper).each(function(){var simpleTabs=new DeskPRO.UI.SimpleTabs({triggerElements:"> header li",context:this});
self.ownObject(simpleTabs)});$(".new-note textarea",this.getEl("notes_tab")).TextAreaExpander(40,225);
var summaryTxt=this.getEl("summary").TextAreaExpander(40,225);if(this.meta.perms.edit){this._initEmailDomainAssoc()
}this.refreshPropBox();var fieldsRendered=this.getEl("custom_fields_rendered");var fieldsForm=this.getEl("custom_fields_editable");
var box=$(".profile-box-container.properties ",el);var propToggle=function(what){if(what=="display"){$(".prop-edit-trigger",box).show();
$(".is-loading",box).hide();$(".save",box).hide();$(".cancel",box).hide();fieldsForm.hide();fieldsRendered.show()
}else{if(!fieldsForm.hasClass("dp-has-init")){fieldsForm.addClass("dp-has-init");fieldsForm.find(".Date.customfield input").datepicker({dateFormat:"yy-mm-dd",showButtonPanel:true,beforeShow:function(input){setTimeout(function(){var buttonPane=$(input).datepicker("widget").find(".ui-datepicker-buttonpane");
buttonPane.find("button:first").remove();var btn=$('<button class="ui-datepicker-current ui-state-default ui-priority-secondary ui-corner-all" type="button">Clear</button>');
btn.unbind("click").bind("click",function(){$.datepicker._clearDate(input)});btn.appendTo(buttonPane);
$(input).datepicker("widget").css("z-index",30001)},1)}})}$(".prop-edit-trigger",box).hide();$(".is-loading",box).hide();
$(".save",box).show();$(".cancel",box).show();fieldsRendered.hide();fieldsForm.show()}};$(".prop-edit-trigger",box).on("click",function(){propToggle("form")
});$(".save",box).on("click",function(){var formData=$('input[type="text"], input[type="password"], input:checked, select, textarea',fieldsForm);
$(".is-loading",box).show();$(".save",box).hide();$(".cancel",box).hide();$.ajax({url:BASE_URL+"agent/organizations/"+self.meta.org_id+"/ajax-save-custom-fields",type:"POST",data:formData,dataType:"html",success:function(rendered){fieldsRendered.empty().html(rendered);
propToggle("display")}})});$(".cancel",box).on("click",function(){propToggle("display")});if(!this.meta.perms.edit){var contactBox=$(".profile-box-container.contact",this.el);
if(!contactBox.find("> section > .table-content > *")[0]){contactBox.hide()}}this.initUgEditor();this.initSlaEditor()
},refreshPropBox:function(){var contactBox=$(".profile-box-container.contact",this.el);var has=false;
if($(".contact-data-list > li",contactBox).length){has=true}if(!has&&$(".outside-display > *",contactBox).length){has=true
}if(!has&&$(".addresses > *",contactBox).length){has=true}if(!has){contactBox.addClass("no-section")}else{contactBox.removeClass("no-section")
}},_initEmailDomainAssoc:function(opennow){if(this.emailDomainOverlay){this.emailDomainOverlay.destroy()
}var self=this;var contain=this.getEl("email_assoc_box");var trigger=$(".email-assoc-edit",contain);var overlayEl=$(".email-assoc-overlay",contain);
var newInput=$("input.new-domain",contain);var newContain=$(".profile-box-container.new",contain);this.emailDomainOverlay=null;
var updateNew=function(){if(newInput.val().trim()){$(".controls .save",newContain).show()}else{$(".controls .save",newContain).hide()
}};var open=function(){if(!self.emailDomainOverlay){self.emailDomainOverlay=new DeskPRO.UI.Overlay({triggerElement:trigger,contentElement:overlayEl,zIndex:30001});
newInput.on("keyup",updateNew).on("change",updateNew);var replaceEditor=function(newDisplayHtml){self.getEl("email_assoc_box").empty().html(newDisplayHtml);
self._initEmailDomainAssoc(true)};$(".controls .save",newContain).on("click",function(){$.ajax({url:BASE_URL+"agent/organizations/"+self.meta.org_id+"/assign-domain",type:"POST",data:{domain:newInput.val().trim()},dataType:"html",success:function(newDisplayHtml){replaceEditor(newDisplayHtml)
}})});var delBtn=$(".delete-button",overlayEl);var cancelDelBtn=$(".cancel-delete-button",overlayEl);
var delSection=$(".delete-controls",overlayEl);delBtn.on("click",function(){var sect=$(this).closest("tr");
var delBtn=$(".delete-button",sect);var cancelDelBtn=$(".cancel-delete-button",sect);var delSection=$(".delete-controls",sect);
$(".delete-controls",sect).slideDown("fast");delBtn.hide();cancelDelBtn.show();delSection.slideDown("fast")
});cancelDelBtn.on("click",function(){var sect=$(this).closest("tr");var delBtn=$(".delete-button",sect);
var cancelDelBtn=$(".cancel-delete-button",sect);var delSection=$(".delete-controls",sect);cancelDelBtn.hide();
delBtn.show();delSection.slideUp("fast")});$(".remove-email, .remove-email-users",overlayEl).on("click",function(){var domain=$(this).closest("tr").data("org-domain");
var removeusers=$(this).is(".remove-email-users")?1:0;$.ajax({url:BASE_URL+"agent/organizations/"+self.meta.org_id+"/unassign-domain",type:"POST",data:{domain:domain,remove_users:removeusers},dataType:"html",success:function(newDisplayHtml){self.emailDomainOverlay.destroy();
self.closeSelf();DeskPRO_Window.runPageRoute("page:"+BASE_URL+"agent/organizations/"+self.meta.org_id)
}})});$(".move-users",overlayEl).on("click",function(){var domain=$(this).closest("tr").data("org-domain");
$.ajax({url:BASE_URL+"agent/organizations/"+self.meta.org_id+"/domain/move-users",type:"POST",data:{domain:domain},dataType:"html",success:function(newDisplayHtml){self.emailDomainOverlay.destroy();
self.closeSelf();DeskPRO_Window.runPageRoute("page:"+BASE_URL+"agent/organizations/"+self.meta.org_id)
}})});$(".move-all-users",overlayEl).on("click",function(){var domain=$(this).closest("tr").data("org-domain");
$.ajax({url:BASE_URL+"agent/organizations/"+self.meta.org_id+"/domain/reassign-users",type:"POST",data:{domain:domain},dataType:"html",success:function(newDisplayHtml){self.emailDomainOverlay.destroy();
self.closeSelf();DeskPRO_Window.runPageRoute("page:"+BASE_URL+"agent/organizations/"+self.meta.org_id)
}})})}self.emailDomainOverlay.open()};trigger.on("click",open);if(opennow){open()}},_initCustomFieldsEditor:function(){var fieldsRenderedWrap,fieldsEditWrap;
fieldsRenderedWrap=this.fieldsRenderedWrap=this.getEl("custom_fields_rendered");fieldsEditWrap=this.fieldsEditWrap=this.getEl("custom_fields_editable");
var toggle=(function(){if(fieldsRenderedWrap.is(":visible")){fieldsRenderedWrap.hide();fieldsEditWrap.show()
}else{fieldsEditWrap.hide();fieldsRenderedWrap.show()}}).bind(this);$(".show-edit-custom-fields",this.wrapper).on("click",function(){toggle()
});$(".save-custom-fields",this.wrapper).on("click",(function(){var formData=$("input, select, textarea",fieldsEditWrap).serializeArray();
$.ajax({url:BASE_URL+"agent/organizations/"+this.meta.org_id+"/ajax-save-custom-fields",type:"POST",data:formData,dataType:"html",success:function(rendered){fieldsRenderedWrap.empty().html(rendered);
toggle()}})}).bind(this))},_initLabels:function(){if(this.getEl("labels_input")[0]){this.labelsInput=new DeskPRO.UI.LabelsInput({type:"tickets",input:this.getEl("labels_input"),onChange:this.saveLabels.bind(this)});
this.ownObject(this.labelsInput)}},saveLabels:function(){this._doSaveLabels()},_doSaveLabels:function(){var data=this.labelsInput.getFormData();
$.ajax({url:this.getMetaData("labelsSaveUrl"),type:"POST",context:this,data:data,dataType:"json"})},initUgEditor:function(){var self=this;
var ugbox=this.getEl("ug_box");var editBtn=ugbox.find(".edit-trigger");var cancelBtn=ugbox.find(".cancel-trigger");
var saveBtn=ugbox.find(".save-trigger");var displayBox=this.getEl("ug_display_box");var editBox=this.getEl("ug_edit_box");
var showEdit=function(){ugbox.removeClass("loading");editBtn.hide();saveBtn.show();cancelBtn.show();displayBox.hide();
editBox.show();ugbox.removeClass("no-section").find("> section").show()};var showSaving=function(){ugbox.addClass("loading");
editBtn.hide();saveBtn.hide();cancelBtn.hide();displayBox.show();editBox.hide();if(ugbox.find(":checkbox.ug-check:checked").length){ugbox.find("> section").show();
ugbox.removeClass("no-section")}else{ugbox.find("> section").hide();ugbox.addClass("no-section")}};var showNormal=function(){ugbox.removeClass("loading");
editBtn.show();saveBtn.hide();cancelBtn.hide();displayBox.show();editBox.hide();if(ugbox.find(":checkbox.ug-check:checked").length){ugbox.find("> section").show();
ugbox.removeClass("no-section")}else{ugbox.find("> section").hide();ugbox.addClass("no-section")}};editBtn.on("click",function(){showEdit()
});cancelBtn.on("click",function(){showNormal()});saveBtn.on("click",function(){var formData=editBox.find(":checkbox.ug-check:checked").serializeArray();
formData.push({name:"action",value:"set-usergroups"});displayBox.find("li.ug-row").hide();if(ugbox.find(":checkbox.ug-check:checked").length){ugbox.find("> section").show();
ugbox.removeClass("no-section")}else{ugbox.find("> section").hide();ugbox.addClass("no-section")}ugbox.find(":checkbox.ug-check:checked").each(function(){var id=$(this).val();
displayBox.find("li.ug-row-"+id).show()});showSaving();$.ajax({url:BASE_URL+"agent/organizations/"+self.meta.org_id+"/ajax-save",type:"POST",dataType:"json",data:formData,context:this,complete:function(){showNormal()
},success:function(data){showNormal()}})})},initSlaEditor:function(){var self=this;var slaBox=this.getEl("sla_box");
if(!slaBox.length){return}var editBtn=slaBox.find(".edit-trigger");var cancelBtn=slaBox.find(".cancel-trigger");
var saveBtn=slaBox.find(".save-trigger");var noSlas=slaBox.find(".no-slas");var displayBox=this.getEl("sla_display_box");
var editBox=this.getEl("sla_edit_box");var showEdit=function(){slaBox.removeClass("loading");editBtn.hide();
saveBtn.show();cancelBtn.show();displayBox.hide();editBox.show()};var showSaving=function(){slaBox.addClass("loading");
editBtn.hide();saveBtn.hide();cancelBtn.hide();displayBox.show();editBox.hide()};var showNormal=function(){slaBox.removeClass("loading");
editBtn.show();saveBtn.hide();cancelBtn.hide();displayBox.show();editBox.hide()};editBtn.on("click",function(){showEdit()
});cancelBtn.on("click",function(){showNormal()});saveBtn.on("click",function(){var checks=editBox.find(":checkbox.sla-check:checked");
var formData=checks.serializeArray();formData.push({name:"action",value:"set-slas"});displayBox.find("li.sla-row").hide();
checks.each(function(){var id=$(this).val();displayBox.find("li.sla-row-"+id).show()});if(checks.length){noSlas.hide()
}else{noSlas.show()}showSaving();$.ajax({url:BASE_URL+"agent/organizations/"+self.meta.org_id+"/ajax-save",type:"POST",dataType:"json",data:formData,context:this,complete:function(){showNormal()
},success:function(data){showNormal()}})})}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page");
DeskPRO.Agent.PageFragment.Page.Person=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){var self=this;
this.parent();this.TYPENAME="person";this.tabBtn=null;this.noIgnoreForm=true;this.addEvent("render",function(container,id){if(id){self.tabBtn=$("#tabbtn_"+id)
}})},initMetaData:function(){DeskPRO_Window.recentTabs.add("person",this.meta.person_id,this.meta.title,BASE_URL+"agent/people/"+this.meta.person_id)
},initPage:function(el){var self=this;this.wrapper=el;this.contentWrapper=$("div.layout-content:first",el);
try{var flashEnabled=!!(navigator.mimeTypes["application/x-shockwave-flash"]||window.ActiveXObject&&new ActiveXObject("ShockwaveFlash.ShockwaveFlash"));
if(flashEnabled){window.setTimeout(function(){self.wrapper.find(".copy-btn").each(function(){var btnEl=this;
var btn=$(this);try{var clip=new ZeroClipboard(this,{btnEl:this,savePuffEl:self.getEl("idref_switch")});
clip.on("mouseover",function(client,args){$(client.options.btnEl).addClass("over")});clip.on("mouseout",function(client,args){$(client.options.btnEl).removeClass("over")
});clip.on("complete",function(client,args){DeskPRO_Window.util.showSavePuff($(this).closest(".id-number"))
});self.addEvent("destroy",function(){try{clip.unglue(btnEl)}catch(e){}});self.addEvent("activate",function(){try{clip.reposition()
}catch(e){}})}catch(e){}})},100)}else{this.wrapper.find(".copy-btn").remove()}}catch(e){this.wrapper.find(".copy-btn").remove()
}this.zIndex=30001;var cw=this.contentWrapper;if(this.tabBtn){if(this.getMetaData("personPicIcon")){this.tabBtn.find("a").find("i").attr("class","").addClass("image-icon").css("background-image",'url("'+this.getMetaData("personPicIcon")+'")').css("background-position","50% 50%")
}else{if(this.getMetaData("personGravatarIcon")){var defaultIcon=ASSETS_BASE_URL_FULL+"images/agent/tabs/tabtype-person.png";
var url=this.getMetaData("personGravatarIcon");url=Orb.appendQueryData(url,"d",defaultIcon);var a=this.tabBtn.find("a").find("i");
a.attr("class","").addClass("image-icon");a.css("background-image",'url("'+url+'")').css("background-position","2px 50%")
}}}var propBox=self.getEl("properties_box");if(this.meta.perms.edit){this.contactEditor=new DeskPRO.Agent.PageFragment.Page.PersonHelper.ContactEditor(this,{saveUrl:BASE_URL+"agent/people/"+this.meta.person_id+"/save-contact-data.json",displayEl:this.getEl("contact_display"),outsideEl:this.getEl("contact_outside"),onReplaceEditor:function(){self.refreshPropBox()
},onSuccess:function(data){if(data.changed_primary_email){DeskPRO_Window.util.updateUserEmailAddressDisplay(self.meta.person_id,data.primary_email_address)
}}});this.ownObject(this.contactEditor);var tzMenu=new DeskPRO.UI.Menu({menuElement:this.getEl("timezone")});
this.ownObject(tzMenu);var autoResMenu=new DeskPRO.UI.Menu({menuElement:this.getEl("disable_autoresponses")});
this.ownObject(autoResMenu);this.getEl("timezone").on("change",function(){var val=$(this).val();$(".timezone-info",this.wrapper).empty();
$.ajax({url:BASE_URL+"agent/people/"+self.meta.person_id+"/ajax-save",type:"POST",dataType:"json",data:{action:"timezone",timezone:val},context:this,success:function(data){$(".timezone-info",this.wrapper).empty().html(data.bit_html)
}})});this.getEl("disable_autoresponses").on("change",function(){var val=$(this).val();$.ajax({url:BASE_URL+"agent/people/"+self.meta.person_id+"/ajax-save",type:"POST",dataType:"json",data:{action:"disable_autoresponses",disable_autoresponses:val}});
self.getEl("disable_autoresponses_reason").remove()});var namef=this.getEl("showname");var editName=this.getEl("editname");
var editTitle=this.getEl("edittitle");var orgpos=this.getEl("showorgpos");var editOrgpos=this.getEl("editorgpos");
var startBtn=this.getEl("editname_start");var stopBtn=this.getEl("editname_end");var editTitleChoicesRaw=editTitle.data("choices").split(",");
var editTitleChoices=[];for(var i=0;i<editTitleChoicesRaw.length;i++){editTitleChoices.push($.trim(editTitleChoicesRaw[i]))
}editTitle.select2({initSelection:function(el,callback){var existingTitle=editTitle.val();if(existingTitle.length){callback({id:existingTitle,text:existingTitle})
}else{callback({id:"",text:"\u00A0"})}},query:function(query){var inList=function(term){for(var i=0;i<editTitleChoices.length;
i++){if(editTitleChoices[i]==term){return true}}return false};var results=[];if(query.term.length){results.push({id:query.term,text:query.term})
}var val=editTitle.val();if(val.length&&!inList(val)&&val!=query.term){results.push({id:val,text:val})
}for(var i=0;i<editTitleChoices.length;i++){var choice=editTitleChoices[i];results.push({id:choice,text:choice})
}results.push({id:"",text:"\u00A0"});query.callback({results:results})}});var startEditable=function(){namef.hide();
orgpos.hide();editName.show();editOrgpos.show();startBtn.hide();stopBtn.show()};var stopEditable=function(){var nametxt=editName.find("input[name=name]").first();
var titletxt=editName.find("input[name=title_prefix]").first();var postxt=editOrgpos.find("input").first();
var setName=nametxt.val().trim();var setTitle=titletxt.val().trim();if(postxt){var setPos=""}else{var setPos=postxt.val().trim()
}if(!setName){return}if(setPos){orgpos.show().find(".org-pos-display").text(setPos)}else{orgpos.hide()
}editName.hide();editOrgpos.hide();startBtn.show();namef.show();orgpos.hide();stopBtn.hide();namef.text((setTitle?setTitle+" ":"")+setName);
var postData=[];postData.push({name:"action",value:"quick-edit-name"});postData.push({name:"name",value:setName});
postData.push({name:"title_prefix",value:setTitle});postData.push({name:"organization_position",value:setPos});
$.ajax({url:BASE_URL+"agent/people/"+self.meta.person_id+"/ajax-save",type:"POST",data:postData})};namef.on("dblclick",startEditable).on("keypress",function(ev){if(ev.keyCode==13){ev.preventDefault();
stopEditable()}});editOrgpos.find("input").first().on("keypress",function(ev){if(ev.keyCode==13){ev.preventDefault();
stopEditable()}});this.getEl("editname_start").on("click",startEditable);this.getEl("editname_end").on("click",stopEditable);
$(".contact-list-wrapper",this.wrapper).first().on("click",".set-primary",function(){var email_id=$(this).data("email-id");
$(".contact-list-wrapper .email.is-primary",self.wrapper).removeClass("is-primary");$(".contact-list-wrapper .email-"+email_id,self.wrapper).addClass("is-primary");
var val=$(this).val();$.ajax({url:BASE_URL+"agent/people/"+self.meta.person_id+"/ajax-save",type:"POST",dataType:"json",data:{action:"set-primary-email",email_id:email_id},success:function(data){DeskPRO_Window.util.updateUserEmailAddressDisplay(self.meta.person_id,data.primary_email_address)
}})});$(".contact-list-wrapper",this.wrapper).first().on("click",".banned",function(){var el=$(this);
var url=$(this).data("unban-url");DeskPRO_Window.showConfirm("Do you want to unban this email address?",function(){el.remove();
$.ajax({url:url,dataType:"json"})},function(){},"Unban","Cancel")});this.changePic=new DeskPRO.Agent.PageFragment.Page.PersonHelper.ChangePic(this,{loadUrl:BASE_URL+"agent/people/"+this.meta.person_id+"/change-picture-overlay",saveUrl:BASE_URL+"agent/people/"+this.meta.person_id+"/ajax-save"});
this.ownObject(this.changePic)}var self=this;$(".create-ticket",this.getEl("action_buttons")).on("click",function(){DeskPRO_Window.newTicketLoader.open(function(page){var data={person_id:self.meta.person_id,email:self.getEl("contact_display").find("li.is-primary.email").data("email-address"),name:self.getEl("editname").find('input[name="name"]').val()};
page.setNewByPerson(data)})});var person_id=this.meta.person_id;this.moreactionsMenu=new DeskPRO.UI.Menu({triggerElement:$(".more",this.getEl("action_buttons")),menuElement:this.getEl("more_actions_menu"),onItemClicked:function(info){var itemEl=$(info.itemEl),action=itemEl.data("action");
if(action=="reset-password"){DeskPRO_Window.showPrompt("<div>Enter a new password. The user will be notified.</div>",function(val,wrap){var postData=[];
postData.push({name:"password",value:val});postData.push({name:"send_email",value:$(".send_email",wrap).is(":checked")});
postData.push({name:"action",value:"password"});$.ajax({url:BASE_URL+"agent/people/"+self.meta.person_id+"/ajax-save",type:"POST",dataType:"json",data:postData})
})}else{if(action=="delete"){var el=self.getEl("delete_confirm").clone();DeskPRO_Window.showConfirm(el,function(){$.ajax({url:$(info.itemEl).data("delete-url"),type:"POST",success:function(){DeskPRO_Window.getMessageBroker().sendMessage("agent.person.removed",{person_id:person_id});
DeskPRO_Window.showAlert("The user was deleted");var tabs=DeskPRO_Window.getTabWatcher().findTabs("ticket",function(tab){return(tab&&tab.page&&tab.page&&tab.page.meta.person_id==person_id)
});$.each(tabs,function(k,tab){DeskPRO_Window.removePage(tab.page)})}});self.closeSelf()},null,null,null,400,260)
}else{if(action=="ban"){var el=self.getEl("ban_confirm").clone();DeskPRO_Window.showConfirm(el,function(){$.ajax({url:$(info.itemEl).data("delete-url"),type:"POST",success:function(){DeskPRO_Window.getMessageBroker().sendMessage("agent.person.removed",{person_id:person_id});
DeskPRO_Window.showAlert("The user was deleted and banned")}});self.closeSelf()},null,null,null,400,260)
}else{if(action=="enable-user"){$.ajax({url:BASE_URL+"agent/people/"+self.meta.person_id+"/ajax-save",type:"POST",dataType:"json",data:{action:"set-is-disabled",is_disabled:0}});
var text=itemEl.text();itemEl.text(itemEl.data("flip"));itemEl.data("flip",text);itemEl.data("action","disable-user");
self.getEl("change_user_picture").find(".person-disabled").remove()}else{if(action=="disable-user"){$.ajax({url:BASE_URL+"agent/people/"+self.meta.person_id+"/ajax-save",type:"POST",dataType:"json",data:{action:"set-is-disabled",is_disabled:1}});
var text=itemEl.text();itemEl.text(itemEl.data("flip"));itemEl.data("flip",text);itemEl.data("action","enable-user");
self.getEl("change_user_picture").append($('<span class="person-disabled" />'))}}}}}}});this.ownObject(this.moreactionsMenu);
this.merge=new DeskPRO.Agent.Widget.Merge({tabType:"person",metaId:self.meta.person_id,metaIdName:"person_id",menu:this.getEl("merge_menu"),trigger:$(".merge",this.getEl("action_buttons")),overlayUrl:BASE_URL+"agent/people/{id}/merge-overlay/{other}",mergeUrl:BASE_URL+"agent/people/{id}/merge/{other}",loadRoute:"person:"+BASE_URL+"agent/people/{id}",overlayLoaded:function(overlay,merge){overlay.getWrapper().find(".person-finder").bind("personsearchboxclick",function(ev,personId,name,email,sb){sb.close();
$.ajax({url:merge._getOverlayUrl(merge.options.metaId,personId),type:"get",dataType:"html",success:function(html){merge.resetOverlay(html)
}})})}});this.ownObject(this.merge);this._initLabels();$(".profile-box-container.tabbed",this.wrapper).each(function(){var simpleTabs=new DeskPRO.UI.SimpleTabs({triggerElements:"> header li",context:this});
self.ownObject(simpleTabs)});this._initOrgEdit();var self=this;this.getEl("tickets_viewall").on("click",function(ev){var row=$(this).closest("tr").remove();
self.getEl("tickets_rest").slideDown("fast",function(){self.updateUi()})});$(".new-note textarea",this.getEl("notes_tab")).TextAreaExpander(40,225);
var summaryTxt=this.getEl("summary").TextAreaExpander(40,225);this.refreshPropBox();var fieldsRendered=this.getEl("custom_fields_rendered");
var fieldsForm=this.getEl("custom_fields_editable");var box=$(".profile-box-container.properties ",el);
var propToggle=function(what){if(what=="display"){$(".prop-edit-trigger",box).show();$(".is-loading",box).hide();
$(".save",box).hide();$(".cancel",box).hide();fieldsForm.hide();fieldsRendered.show();self.updateUi()
}else{if(!fieldsForm.hasClass("dp-has-init")){fieldsForm.addClass("dp-has-init");fieldsForm.find(".Date.customfield input").datepicker({dateFormat:"yy-mm-dd",showButtonPanel:true,beforeShow:function(input){setTimeout(function(){var buttonPane=$(input).datepicker("widget").find(".ui-datepicker-buttonpane");
buttonPane.find("button:first").remove();var btn=$('<button class="ui-datepicker-current ui-state-default ui-priority-secondary ui-corner-all" type="button">Clear</button>');
btn.unbind("click").bind("click",function(){$.datepicker._clearDate(input)});btn.appendTo(buttonPane);
$(input).datepicker("widget").css("z-index",30001)},1)}})}$(".prop-edit-trigger",box).hide();$(".is-loading",box).hide();
$(".save",box).show();$(".cancel",box).show();fieldsRendered.hide();fieldsForm.show();self.updateUi()
}};$(".prop-edit-trigger",box).on("click",function(){propToggle("form")});$(".save",box).on("click",function(){var formData=$('input[type="text"], input[type="password"], input:checked, select, textarea',fieldsForm).serializeArray();
$(".is-loading",box).show();$(".save",box).hide();$(".cancel",box).hide();$.ajax({url:BASE_URL+"agent/person/"+self.meta.person_id+"/ajax-save-custom-fields",type:"POST",data:formData,dataType:"html",success:function(rendered){fieldsRendered.empty().html(rendered);
propToggle("display")}})});$(".cancel",box).on("click",function(){propToggle("display")});var tabWarn=$(".full-tab-warn",this.el);
if(tabWarn.length){$(".dismiss-trigger",tabWarn).on("click",function(){tabWarn.fadeOut("fast",function(){tabWarn.remove()
})})}if(this.getEl("editname_start").is(".auto-click")){this.getEl("editname_start").click()}this.initUgEditor();
this.initSlaEditor();if(this.getEl("approve_user")[0]){DeskPRO_Window.getMessageBroker().addMessageListener("agent.person.removed",function(info){DeskPRO_Window.removePage(self)
},this);DeskPRO_Window.getMessageBroker().addMessageListener("agent.person.confirmed",function(info){if(info.person_id==self.meta.person_id){this.wrapper.find(".validating-bar").remove()
}},this);this.getEl("approve_user").on("click",function(ev){ev.preventDefault();DeskPRO_Window.util.ajaxWithClientMessages({url:BASE_URL+"agent/people/validate/approve",data:{"people_ids[]":self.meta.person_id},success:function(){DeskPRO_Window.removePage(self);
DeskPRO_Window.runPageRoute("page:"+BASE_URL+"agent/people/"+self.meta.person_id);DeskPRO_Window.getMessageBroker().sendMessage("agent.person.confirmed",{person_id:self.meta.person_id})
}})});this.getEl("delete_user").on("click",function(ev){ev.preventDefault();DeskPRO_Window.util.ajaxWithClientMessages({url:BASE_URL+"agent/people/validate/delete",data:{"people_ids[]":self.meta.person_id},success:function(){DeskPRO_Window.getMessageBroker().sendMessage("agent.person.removed",{person_id:self.meta.person_id});
DeskPRO_Window.removePage(self)}})})}var vemails=this.getEl("validating_emails");if(vemails){vemails.on("click",".validate-trigger",function(){var id=$(this).data("email-id");
var token=$(this).data("token");$.ajax({url:BASE_URL+"agent/people/validate-email/"+id+"/"+token,type:"POST",success:function(){self.closeSelf();
DeskPRO_Window.runPageRoute("person:"+BASE_URL+"agent/people/"+self.meta.person_id)}})})}this.addEvent("openOrgProfile",function(ev){ev.preventDefault();
self.getEl("org_box").find(".org_link").trigger("click")})},refreshPropBox:function(){var contactBox=$(".profile-box-container.contact",this.el);
var has=false;if($(".contact-data-list > li",contactBox).length){has=true}if(!has&&$(".outside-display > *",contactBox).length){has=true
}if(!has&&$(".addresses > *",contactBox).length){has=true}if(!has){contactBox.addClass("no-section")}else{contactBox.removeClass("no-section")
}this.updateUi()},_initOrgEdit:function(){var self=this;$(".org-edit-trigger, .cancel",this.getEl("org_display_header")).on("click",function(ev){ev.preventDefault();
self.toggleOrgEdit();refreshBox();if($(this).is(".cancel")){if(!parseInt(self.meta.org_id)){$(".org-name",self.getEl("org_edit_wrap")).val("");
$(".extra-input",self.getEl("org_edit_wrap")).hide()}self.getEl("org_searchbox").removeClass("is-new").removeClass("is-set");
self.toggleOrgEdit("close")}});var orgDisplay=this.getEl("org_display_wrap");var orgEdit=this.getEl("org_edit_wrap");
this.getEl("org_searchbox").bind("orgsearchboxclick",function(ev,orgId,name){$(".extra-input",orgEdit).show();
self.orgEnableBtn("save")}).bind("orgsearchboxcreate",function(ev,term,name){$(".extra-input",orgEdit).show();
self.orgEnableBtn("save")}).bind("orgsearchreverted",function(ev,term,name){if(self.getEl("org_searchbox").is(".is-new")||($(".org-id",orgEdit).val()&&$(".org-id",orgEdit).val()!="0")){self.orgEnableBtn("save")
}else{self.orgEnableBtn("cancel")}});$(".extra-input",orgEdit).on("keyup change",function(){if(self.getEl("org_searchbox").is(".is-new")||($(".org-id",orgEdit).val()&&$(".org-id",orgEdit).val()!="0")){self.orgEnableBtn("save")
}});var refreshBox=function(){var box=self.getEl("org_box");box.removeClass("no-section");if(orgEdit.is(":visible")){}else{if(!$("> *",orgDisplay).length){box.addClass("no-section")
}}};var saveFn=function(){self.orgEnableBtn("saving");var postData=[];postData.push({name:"action",value:"set-organization"});
postData.push({name:"name",value:$(".org-name",self.getEl("org_edit_wrap")).val().trim()});postData.push({name:"id",value:$(".org-id",self.getEl("org_edit_wrap")).val().trim()});
postData.push({name:"position",value:$(".org-pos-set",self.getEl("org_edit_wrap")).val().trim()});postData.push({name:"manager",value:$(".org-manager-set",self.getEl("org_edit_wrap")).is(":checked")?1:0});
$.ajax({url:BASE_URL+"agent/people/"+self.meta.person_id+"/ajax-save",type:"POST",data:postData,dataType:"json",success:function(data){orgDisplay.empty();
if(data.organization_id){orgDisplay.html(data.html);self.meta.org_id=data.organization_id}else{self.meta.org_id=0
}self.getEl("org_searchbox").removeClass("is-new").removeClass("is-set");self.toggleOrgEdit();refreshBox()
}})};this.getEl("org_edit_save").on("click",saveFn);this.getEl("org_edit_remove_org").on("click",function(){$(".org-id",self.getEl("org_edit_wrap")).val("0");
$(".org-name",self.getEl("org_edit_wrap")).val("");$(".extra-input",orgEdit).hide();saveFn()});refreshBox()
},orgEnableBtn:function(name){var names=["org-edit-trigger","saved","save","cancel","is-loading","remove-org"];
var els=$("."+names.join(", ."),this.getEl("org_display_header")).hide();els.filter("."+name).show();
if(name=="save"){els.filter(".cancel").show()}else{if(name=="cancel"){var orgid=$(".org-id",this.getEl("org_edit_wrap")).val();
if(orgid&&orgid!="0"){els.filter(".remove-org").show()}}}this.updateUi()},toggleOrgEdit:function(force){var orgDisplay=this.getEl("org_display_wrap");
var orgEdit=this.getEl("org_edit_wrap");if((force&&force=="close")||orgEdit.is(":visible")){orgEdit.hide();
this.getEl("org_searchbox").data("org-search-box").close();orgDisplay.show();this.orgEnableBtn("org-edit-trigger")
}else{if((force&&force=="open")||!orgEdit.is(":visible")){orgDisplay.hide();orgEdit.show();this.orgEnableBtn("cancel")
}}this.updateUi()},_initLabels:function(){if(this.getEl("labels_input")[0]){this.labelsInput=new DeskPRO.UI.LabelsInput({type:"tickets",input:this.getEl("labels_input"),onChange:this.saveLabels.bind(this)});
this.ownObject(this.labelsInput)}},saveLabels:function(){this._doSaveLabels();this.updateUi()},_doSaveLabels:function(){var data=this.labelsInput.getFormData();
$.ajax({url:this.getMetaData("labelsSaveUrl"),type:"POST",context:this,data:data,dataType:"json",success:function(data){var sect=DeskPRO_Window.sections.people_section;
if(sect){sect.reloadLabels()}}})},initUgEditor:function(){var self=this;var ugbox=this.getEl("ug_box");
var editBtn=ugbox.find(".edit-trigger");var cancelBtn=ugbox.find(".cancel-trigger");var saveBtn=ugbox.find(".save-trigger");
var displayBox=this.getEl("ug_display_box");var editBox=this.getEl("ug_edit_box");var showEdit=function(){ugbox.removeClass("loading");
editBtn.hide();saveBtn.show();cancelBtn.show();displayBox.hide();editBox.show();ugbox.removeClass("no-section").find("> section").show()
};var showSaving=function(){ugbox.addClass("loading");editBtn.hide();saveBtn.hide();cancelBtn.hide();
displayBox.show();editBox.hide()};var showNormal=function(){ugbox.removeClass("loading");editBtn.show();
saveBtn.hide();cancelBtn.hide();displayBox.show();editBox.hide()};editBtn.on("click",function(){showEdit()
});cancelBtn.on("click",function(){showNormal()});saveBtn.on("click",function(){var formData=editBox.find(":checkbox.ug-check:checked").serializeArray();
formData.push({name:"action",value:"set-usergroups"});displayBox.find("li.ug-row").hide();ugbox.find(":checkbox.ug-check:checked").each(function(){var id=$(this).val();
displayBox.find("li.ug-row-"+id).show()});showSaving();$.ajax({url:BASE_URL+"agent/people/"+self.meta.person_id+"/ajax-save",type:"POST",dataType:"json",data:formData,context:this,complete:function(){showNormal()
},success:function(data){showNormal()}})})},initSlaEditor:function(){var self=this;var slaBox=this.getEl("sla_box");
if(!slaBox.length){return}var editBtn=slaBox.find(".edit-trigger");var cancelBtn=slaBox.find(".cancel-trigger");
var saveBtn=slaBox.find(".save-trigger");var noSlas=slaBox.find(".no-slas");var displayBox=this.getEl("sla_display_box");
var editBox=this.getEl("sla_edit_box");var showEdit=function(){slaBox.removeClass("loading");editBtn.hide();
saveBtn.show();cancelBtn.show();displayBox.hide();editBox.show()};var showSaving=function(){slaBox.addClass("loading");
editBtn.hide();saveBtn.hide();cancelBtn.hide();displayBox.show();editBox.hide()};var showNormal=function(){slaBox.removeClass("loading");
editBtn.show();saveBtn.hide();cancelBtn.hide();displayBox.show();editBox.hide()};editBtn.on("click",function(){showEdit()
});cancelBtn.on("click",function(){showNormal()});saveBtn.on("click",function(){var checks=editBox.find(":checkbox.sla-check:checked");
var formData=checks.serializeArray();formData.push({name:"action",value:"set-slas"});displayBox.find("li.sla-row").hide();
checks.each(function(){var id=$(this).val();displayBox.find("li.sla-row-"+id).show()});if(checks.length){noSlas.hide()
}else{noSlas.show()}showSaving();$.ajax({url:BASE_URL+"agent/people/"+self.meta.person_id+"/ajax-save",type:"POST",dataType:"json",data:formData,context:this,complete:function(){showNormal()
},success:function(data){showNormal()}})})}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page");
DeskPRO.Agent.PageFragment.Page.PersonSession=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="person_session"},initPage:function(el){this.el=el;this.tabs=new DeskPRO.UI.SimpleTabs({triggerElements:$("li",this.getEl("chats_tab_triggers"))})
}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page");DeskPRO.Agent.PageFragment.Page.Visitor=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="visitor"},initPage:function(el){this.el=el}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page");
DeskPRO.Agent.PageFragment.Page.PersonPopout=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Page.Person,initializeProperties:function(){this.parent();
this.TYPENAME="person"},initPage:function(el){this.parent(el)}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page");
DeskPRO.Agent.PageFragment.Page.KbViewArticle=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="article"},initMetaData:function(){DeskPRO_Window.recentTabs.add("article",this.meta.article_id,this.meta.title,BASE_URL+"agent/kb/article/"+this.meta.article_id)
},initPage:function(el){var self=this;this.wrapper=el;this.article_id=this.getMetaData("article_id");
this._initBasic();this._initArticleArea();this._initLabels();this._initCommentForm();if(this.meta.canEdit){this._initMenus();
this._initPostArea();this._initAutoUnpublishOptions();this._initAutoPublishOptions();var btn=$(".kb-editor-edit",this.wrapper);
btn.on("click",this.showEditor.bind(this));if(this.meta.isValidating){this.validatingEdit=new DeskPRO.Agent.PageHelper.ValidatingEdit(this,{typename:"articles",contentId:this.meta.article_id});
this.ownObject(this.validatingEdit)}}this.relatedContent=new DeskPRO.Agent.PageHelper.RelatedContent(this,{typename:"articles",content_id:this.meta.article_id,listEl:$("section.linked-content:first",this.wrapper),disabled:!this.meta.canEdit,onContentLinked:function(typename,content_id){$.ajax({url:BASE_URL+"agent/kb/article/"+self.meta.article_id+"/ajax-save",type:"POST",data:{content_type:typename,content_id:content_id,action:"add-related"},context:this,dataType:"json"})
},onContentUnlinked:function(typename,content_id){$.ajax({url:BASE_URL+"agent/kb/article/"+self.meta.article_id+"/ajax-save",type:"POST",data:{content_type:typename,content_id:content_id,action:"remove-related"},context:this,dataType:"json"})
}});this.ownObject(this.relatedContent);this.whoVotedOverlay=new DeskPRO.UI.Overlay({triggerElement:".who-voted-trigger",contentMethod:"ajax",contentAjax:{url:BASE_URL+"agent/publish/rating-who-voted/article/"+this.meta.article_id}});
this.ownObject(this.whoVotedOverlay);this.whoViewedOverlay=new DeskPRO.UI.Overlay({triggerElement:".open-who-viewed",contentMethod:"ajax",contentAjax:{url:BASE_URL+"agent/publish/who-viewed/1/"+this.meta.article_id}});
this.ownObject(this.whoViewedOverlay);this.miscContent=new DeskPRO.Agent.PageHelper.MiscContent(this,{revisionCompareUrl:BASE_URL+"agent/kb/compare-revs/{OLD}/{NEW}"});
this.ownObject(this.miscContent);var fieldsRendered=this.getEl("custom_fields_rendered");var fieldsForm=this.getEl("custom_fields_editable");
var buttonsWrap=this.getEl("properties_controls");var propToggle=function(what){if(what=="display"){$(".showing-editing-fields",buttonsWrap).hide();
$(".showing-rendered-fields",buttonsWrap).show();fieldsForm.hide();fieldsRendered.show()}else{$(".showing-rendered-fields",buttonsWrap).hide();
$(".showing-editing-fields",buttonsWrap).show();fieldsRendered.hide();fieldsForm.show()}};$(".edit-fields-trigger",buttonsWrap).on("click",function(){propToggle("edit")
});$(".save-fields-trigger",buttonsWrap).on("click",function(){var formData=$('input[type="text"], input[type="password"], input:checked, select, textarea',fieldsForm);
$.ajax({url:BASE_URL+"agent/kb/article/"+self.meta.article_id+"/ajax-save-custom-fields",type:"POST",data:formData,dataType:"html",success:function(rendered){fieldsRendered.empty().html(rendered);
propToggle("display")}})});this.scanGlossaryWords();this._initTrans()},handleUnloadRevisions:function(revision_id){if(!revision_id){return
}if($(".rev-"+revision_id,this.getEl("revs")).length){return}this.getEl("revs").empty().removeClass("loaded");
DeskPRO_Window.util.modCountEl(this.getEl("count_revs"),"+")},scanGlossaryWords:function(){DeskPRO.WordHighlighter.highlight(this.getEl("content_ed").find(".article-content-wrap").get(0),this.meta.glossaryWords);
this.getEl("content_ed").find("span.dp-highlight-word").each(function(){$(this).addClass("embedded-glossary-word tipped").data("tipped-options","ajax:true, maxWidth:300").data("tipped",BASE_URL+"agent/glossary/"+$(this).data("word")+"/tip")
})},_initBasic:function(){var self=this;if(this.meta.canEdit){$(".edit-trigger",this.wrapper).on("click",function(){DeskPRO_Window.runPageRoute("kb_article_edit:"+BASE_URL+"agent/kb/article/"+self.article_id);
DeskPRO_Window.removePage(self)});$(".validate-trigger",this.wrapper).on("click",function(){DeskPRO_Window.runPageRoute("kb_article_edit:"+BASE_URL+"agent/kb/article/"+self.article_id+"?do_validate=1");
DeskPRO_Window.removePage(self)});var editTitle=new DeskPRO.Agent.PageFragment.Page.EditTitle(this,BASE_URL+"agent/kb/article/"+self.meta.article_id+"/ajax-save")
}this.bodyTabs=new DeskPRO.UI.SimpleTabs({triggerElements:$("li",this.getEl("bodytabs")),onTabSwitch:(function(info){if($(info.tabContent).is(".kb-content")){self.getEl("content_edit_btns").show()
}else{self.getEl("content_edit_btns").hide()}if($(info.tabContent).is(".kb-related-content")){$("body").addClass("related-controls-on")
}else{$("body").removeClass("related-controls-on");if($(info.tabContent).is(".search-tab")){self._initSearchTab()
}}if($(info.tabContent).is(".revisions-tab")&&!$(info.tabContent).is(".loaded")){$.ajax({url:BASE_URL+"agent/kb/article/"+this.meta.article_id+"/view-revisions",type:"GET",dataType:"html",context:self,success:function(html){this.getEl("revs").html(html);
this.miscContent._initCompareRevs();$(info.tabContent).addClass("loaded")}})}}).bind(this)});this.ownObject(this.bodyTabs);
var actions=this.getEl("action_buttons");$(".permalink",actions).on("click",function(){var html=[];html.push("<div>");
html.push("The permalink to this article on the website is:<br />");html.push('<input type="text" style="width:95%;" />');
html.push("</div>");var msg=$(html.join(""));$("input",msg).val(self.meta.permalink);DeskPRO_Window.showAlert(msg)
});$(".view-user-interface",actions).on("click",function(){window.open(self.meta.permalink)});var list=$(".file-list",this.wrapper);
DeskPRO_Window.util.fileupload(this.wrapper,{url:BASE_URL+"agent/misc/accept-upload?attach_to_object=article&object_id="+this.meta.article_id,page:this});
list.on("click",".delete",function(ev){ev.preventDefault();ev.stopImmediatePropagation();var blob_id=$(this).data("blob-id");
$.ajax({url:BASE_URL+"agent/kb/article/"+self.meta.article_id+"/ajax-save",type:"POST",data:{action:"remove-blob",blob_id:blob_id},context:self,dataType:"json"});
$(this).closest("li").remove();if(!list.find("li")[0]){list.hide()}})},_initMenus:function(){var self=this;
var statusSel=this.getEl("status");DP.select(statusSel);statusSel.on("change",function(){DeskPRO_Window.sections.publish_section.reload();
var status=$(this).val();self.getEl("auto_unpub").hide();self.getEl("auto_pub").hide();if(status=="published"){self.getEl("auto_unpub").show()
}else{if(status=="hidden.unpublished"){self.getEl("auto_pub").show()}}$.ajax({url:BASE_URL+"agent/kb/article/"+self.meta.article_id+"/ajax-save",type:"POST",data:{action:"status",status:status},context:self,dataType:"json",success:function(){DeskPRO_Window.sections.publish_section.reload()
}})});this.deleteHelper=new DeskPRO.Agent.PageFragment.Page.Content.DeleteControl(this,{ajaxSaveUrl:BASE_URL+"agent/kb/article/"+self.meta.article_id+"/ajax-save"});
this.ownObject(this.deleteHelper);var lis=$("li:not(.add)",self.getEl("categories"));if(lis.length<2){$(".remove",lis).hide()
}this.getEl("categories").on("click",".remove",function(ev){var li=$(this).parent();li.remove();var lis=$("li:not(.add)",self.getEl("categories"));
if(lis.length==1){$(".remove",lis).hide()}self.sendUpdateCats()});this.getEl("addcat_trigger").on("click",function(ev){if(!self.newCatTpl){self.newCatTpl=DeskPRO_Window.util.getPlainTpl(self.getEl("addcat_select_tpl"))
}var newLi=$(self.newCatTpl);newLi.find("select").on("change",function(){self.sendUpdateCats()}).prepend("<option></option>");
newLi.find("select").find("option").first().prop("selected",true);self.getEl("addcat_li").before(newLi);
DP.select(newLi.find("select"))});this.getEl("categories").on("change",function(ev){self.sendUpdateCats()
});DP.select(this.getEl("categories").find("select"));this.getEl("products").on("click",".remove",function(ev){var li=$(this).parent();
li.remove();var lis=$("li:not(.add)",self.getEl("products"));if(lis.length==1){$(".remove",lis).hide()
}self.sendUpdateProds()});this.getEl("addprod_trigger").on("click",function(ev){if(!self.newProdTpl){self.newProdTpl=DeskPRO_Window.util.getPlainTpl(self.getEl("addprod_select_tpl"))
}var newLi=$(self.newProdTpl);newLi.find("select").on("change",function(){self.sendUpdateProds()}).prepend("<option></option>");
newLi.find("select").find("option").first().prop("selected",true);self.getEl("addprod_li").before(newLi);
DP.select(newLi.find("select"))});this.getEl("products").on("change",function(ev){self.sendUpdateProds()
});DP.select(this.getEl("products").find("select"))},sendUpdateCats:function(){if(this.sendingCatUpdate){this.resetCatUpdate=true;
return}this.sendingCatUpdate=true;this.resetCatUpdate=false;var ids=[];this.getEl("categories").find("select").each(function(){var id=parseInt($(this).val());
if(id){if(ids.indexOf(id)!==-1){$(this).closest("li").remove()}else{ids.push(id)}}});var formData=$("select",this.getEl("categories")).serializeArray();
formData.push({name:"action",value:"categories"});$.ajax({url:BASE_URL+"agent/kb/article/"+this.meta.article_id+"/ajax-save",type:"POST",data:formData,context:this,dataType:"json",success:function(data){this.sendingCatUpdate=false;
DeskPRO_Window.sections.publish_section.reload();if(data&&data.category_ids&&data.category_ids.length>=2){this.getEl("categories").find(".remove").show()
}if(this.resetCatUpdate){this.sendUpdateCats()}}})},sendUpdateProds:function(){if(this.sendingProdUpdate){this.resetProdUpdate=true;
return}this.sendingProdUpdate=true;this.resetProdUpdate=false;var ids=[];this.getEl("products").find("select").each(function(){var id=parseInt($(this).val());
if(id){if(ids.indexOf(id)!==-1){$(this).closest("li").remove()}else{ids.push(id)}}});var formData=$("select",this.getEl("products")).serializeArray();
formData.push({name:"action",value:"products"});$.ajax({url:BASE_URL+"agent/kb/article/"+this.meta.article_id+"/ajax-save",type:"POST",data:formData,context:this,dataType:"json",success:function(data){this.sendingProdUpdate=false;
if(this.resetProdUpdate){this.sendUpdateProds()}}})},_initLabels:function(){if(this.hasInitLabels){return
}this.hasInitLabels=true;this.labelsInput=new DeskPRO.UI.LabelsInput({type:"article",input:this.getEl("labels_input"),onChange:this.saveLabels.bind(this)});
this.ownObject(this.labelsInput)},saveLabels:function(){if(this._saveLabelsTimeout){window.clearTimeout(this._saveLabelsTimeout)
}this._labelsData=this.labelsInput.getFormData();this._saveLabelsTimeout=this._doSaveLabels.delay(2000,this)
},_doSaveLabels:function(){var data=this._labelsData;$.ajax({url:this.getMetaData("labelsSaveUrl"),type:"POST",context:this,data:data,dataType:"json",success:function(data){this._handleSaveLabelsSuccess(data)
}})},_handleSaveLabelsSuccess:function(data){},_initSearchTab:function(){if(this.hasInitSearchTab){return
}this.hasInitSearchTab=true;this.stickyWords=new DeskPRO.Agent.PageFragment.Page.Content.StickyWords(this,{contentType:"articles",contentId:this.meta.article_id,element:this.getEl("stickysearch_input")});
this.ownObject(this.stickyWords)},_initAutoUnpublishOptions:function(){var self=this;var optWrap=this.getEl("auto_unpub");
$(".auto-unpublish-set",optWrap).on("click",function(){self.updateAutoUnPubOptions();$(".auto-unpublish",optWrap).show();
$(this).hide()});$(".remove-auto-unpublish",optWrap).on("click",function(){self.removeAutoUnPubOptions();
$(".auto-unpublish-set",optWrap).show();$(".auto-unpublish",optWrap).hide()});var endOpt=$(".auto-unpublish .end-action.opt",optWrap);
var m=new DeskPRO.UI.Menu({triggerElement:endOpt,menuElement:$(".end-action-menu",optWrap),onItemClicked:function(info){var val=$(info.itemEl).data("action");
var label=$(info.itemEl).text().trim();endOpt.data("val",val);endOpt.text(label);self.updateAutoUnPubOptions()
}});this.ownObject(m);var endDate=$(".auto-unpublish .end-date.opt",optWrap);var dateInput=$(".auto-unpublish .end-date-input",optWrap);
dateInput.datepicker({dateFormat:"M d, yy",onSelect:function(dateText,inst){var timestamp=dateInput.datepicker("getDate").getTime()/1000;
endDate.data("val",timestamp);endDate.text(dateText);self.updateAutoUnPubOptions()}});endDate.on("click",function(){$(".auto-unpublish .end-date-input",optWrap).datepicker("show")
})},removeAutoUnPubOptions:function(){$.ajax({url:BASE_URL+"agent/kb/article/"+this.meta.article_id+"/ajax-save",type:"POST",data:{action:"remove-auto-unpub"},context:this,dataType:"json"})
},updateAutoUnPubOptions:function(){var optWrap=this.getEl("auto_unpub");var endTimestamp=$(".auto-unpublish .end-date.opt",optWrap).data("val");
var endAction=$(".auto-unpublish .end-action.opt",optWrap).data("val");if(!endTimestamp||!endAction){return
}var data=[];data.push({name:"action",value:"auto-unpub"});data.push({name:"end_action",value:endAction});
data.push({name:"end_timestamp",value:endTimestamp});$.ajax({url:BASE_URL+"agent/kb/article/"+this.meta.article_id+"/ajax-save",type:"POST",data:data,context:this,dataType:"json"})
},_initAutoPublishOptions:function(){var self=this;var optWrap=this.getEl("auto_pub");$(".auto-publish-set",optWrap).on("click",function(){self.updateAutoPubOptions();
$(".auto-publish",optWrap).show();$(this).hide()});$(".remove-auto-publish",optWrap).on("click",function(){self.removeAutoPubOptions();
$(".auto-publish-set",optWrap).show();$(".auto-publish",optWrap).hide()});var pubDate=$(".auto-publish .pub-date.opt",optWrap);
var dateInput=$(".auto-publish .pub-date-input",optWrap);dateInput.datepicker({dateFormat:"M d, yy",onSelect:function(dateText,inst){var timestamp=dateInput.datepicker("getDate").getTime()/1000;
pubDate.data("val",timestamp);pubDate.text(dateText);self.updateAutoPubOptions()}});pubDate.on("click",function(){$(".auto-publish .pub-date-input",optWrap).datepicker("show")
})},removeAutoPubOptions:function(){$.ajax({url:BASE_URL+"agent/kb/article/"+this.meta.article_id+"/ajax-save",type:"POST",data:{action:"remove-auto-pub"},context:this,dataType:"json"})
},updateAutoPubOptions:function(){var optWrap=this.getEl("auto_unpub");var timestamp=$(".auto-unpublish .end-date.opt",optWrap).data("val");
if(!timestamp){return}var data=[];data.push({name:"action",value:"auto-pub"});data.push({name:"pub_timestamp",value:timestamp});
$.ajax({url:BASE_URL+"agent/kb/article/"+this.meta.article_id+"/ajax-save",type:"POST",data:data,context:this,dataType:"json"})
},_initArticleArea:function(){var loader=this.wrapper.find(".article-loading");loader.show();var iframe=this.wrapper.find(".article-iframe");
var iframeLoad=function(){if(this.contentWindow&&this.contentWindow.document){loader.hide();$(this).css({overflow:"hidden",border:"none",padding:0,margin:0});
$(this).height($(this.contentWindow.document).height());var doc=this.contentWindow.document,iframeWindow=this.contentWindow;
var wheel=function(e){e=e||iframeWindow.event;var scroller=iframe.closest(".with-scrollbar").get(0),proxyE;
if(scroller.dispatchEvent){try{proxyE=document.createEvent("MouseWheelEvent");proxyE.initMouseWheelEvent(e.type,e.bubbles,e.cancelable,window,e.detail,e.screenX,e.screenY,e.clientX,e.clientY,e.button,null,"",e.wheelDelta)
}catch(e){proxyE=null}if(!proxyE){proxyE=document.createEvent("MouseEvent");proxyE.initMouseEvent(e.type,e.bubbles,e.cancelable,window,e.detail,e.screenX,e.screenY,e.clientX,e.clientY,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,e.button,null)
}iframe.closest(".with-scrollbar").get(0).dispatchEvent(proxyE)}else{proxyE=document.createEventObject(e);
proxyE.view=window;iframe.closest(".with-scrollbar").get(0).fireEvent("onmousewheel",proxyE)}};if(doc.addEventListener){doc.addEventListener("DOMMouseScroll",wheel,false);
doc.addEventListener("mousewheel",wheel,false)}else{doc.onmousewheel=wheel}}};iframe.on("load",iframeLoad);
iframeLoad.call(iframe)},_initPostArea:function(){this._hasInitEd=false;this.getEl("cancel_btn").off("click").on("click",(function(){this.hideEditor();
if(!this.wrapper.find(".revert-default")[0]){var def=this.wrapper.find("textarea.edit-content-field-default").val();
this.wrapper.find("textarea.edit-content-field").val(def);if(this.rte){this.rte.val(def)}}}).bind(this));
var attachList=$("ul.attachment-list:first",this.wrapper);if(attachList.length){this.getEl("attachtab").empty().append(attachList);
var imageEls=$("li.is-image a",attachList);imageEls.colorbox({title:function(){var url=$(this).attr("href");
return'<a href="'+url+'" target="_blank">Open In New Window</a>'},width:"50%",height:"50%",initialWidth:"200",initialHeight:"150",scalePhotos:true,photo:true,opacity:0.5,transition:"none"})
}if(this.editStateSaver){this.editStateSaver.destroy()}this.editStateSaver=new DeskPRO.Agent.PageHelper.StateSaver({stateId:"editarticle."+this.article_id,listenOn:$(".article-editor-wrap:first",wrap)});
this.ownObject(this.editStateSaver);var wrap=this.wrapper;this.getEl("save_btn").off("click").on("click",(function(ev){ev.preventDefault();
var data=[];data.push({name:"action",value:"content"});data.push({name:"content",value:$(".article-editor-wrap textarea:first",wrap).val()});
data.push({name:"language_id",value:wrap.find(".article-editor.wrap").find(".language_id").val()});$("input.edit-content-attach:checked",wrap).each(function(){data.push({name:"attach[]",value:$(this).val()})
});var showSaving=this.getEl("article_save").find(".mark-loading");var showSaved=this.getEl("article_save").find(".mark-saved");
showSaved.stop().hide();showSaving.show();$.ajax({url:BASE_URL+"agent/kb/article/"+this.meta.article_id+"/ajax-save",type:"POST",context:this,data:data,dataType:"json",complete:function(){showSaving.hide()
},success:function(data){this.getEl("content_ed").html(data.content_html);this._initPostArea();this._initArticleArea();
this.handleUnloadRevisions(data.revision_id);showSaved.show().fadeOut(2000)}})}).bind(this));this.hideEditor()
},destroyPage:function(){var el=$(".article-editor-wrap",this.getEl("content_ed"));if(el[0]){el.get(0).parentNode.removeChild(el.get(0))
}},showEditor:function(){$("body").addClass("content-link-control-on");var self=this;$(".article-content-wrap",this.getEl("content_ed")).hide();
var edWrap=$(".article-editor-wrap",this.getEl("content_ed")).show();$(".revert-default",edWrap).on("click",function(){var def=$("textarea.edit-content-field-default").val();
$("textarea.edit-content-field").val(def);$(".revert-message-notice",edWrap).remove()});if(!this._hasInitEd){this._hasInitEd=true;
var txt=$(".edit-content-field",this.getEl("content_ed"));var w=$(txt.closest(".content-tab-item")).width()-30;
if(this.wrapper.find("> .layout-content > .scrollbar.disabled")){var h=$(window).height()-90-txt.offset().top
}else{h=425}txt.css({width:w,height:h});this.rte=DP.rteTextarea(txt,{setup:function(ed){ed.onKeyPress.add(function(){self.editStateSaver.triggerChange()
})}});var saveBtn=this.getEl("save_btn");this.acceptContentLink=new DeskPRO.Agent.PageHelper.AcceptContentLink({page:this,rte:txt,isReadyCallback:function(){return saveBtn.is(":visible")
}});this._hasInitEdBefore=true}this.getEl("edit_btn").hide();this.getEl("save_btn").show();this.getEl("cancel_btn").show();
this.updateUi()},hideEditor:function(){$("body").removeClass("content-link-control-on");this.getEl("edit_btn").show();
this.getEl("save_btn").hide();this.getEl("cancel_btn").hide();$(".article-editor-wrap",this.getEl("content_ed")).hide();
$(".article-content-wrap",this.getEl("content_ed")).show();this.updateUi()},_initMediaBrowser:function(){if(this.mediabrowser_has_init){return
}this.mediabrowser_has_init=true;this.mediaBrowserEl=$(".media-browser",this.wrapper);this.mediaBrowserOverlay=new DeskPRO.UI.Overlay({contentElement:this.mediaBrowserEl});
this.mediaBrowser=new DeskPRO.Agent.MediaBrowser({wrapper:this.mediaBrowserEl,additionalDropZone:$(".kb-editor > textarea",this.wrapper)})
},showMediaBrowser:function(){this._initMediaBrowser();this.mediaBrowserOverlay.openOverlay()},_initCommentForm:function(){this.commentsController=new DeskPRO.Agent.PageHelper.Comments(this,{commentsWrapper:this.getEl("comments_wrap")});
this.ownObject(this.commentsController);this.newCommentWrapper=$(".new-note:first",this.wrapper);$("button",this.newCommentWrapper).on("click",this.saveNewComment.bind(this))
},saveNewComment:function(){var loadingOn=$(".loading-on",this.newCommentWrapper).show();var loadingOff=$(".loading-off",this.newCommentWrapper).hide();
var data=[];data.push({name:"content",value:$("textarea",this.newCommentWrapper).val()});$.ajax({url:BASE_URL+"agent/kb/article/"+this.getMetaData("article_id")+"/ajax-save-comment",type:"POST",context:this,data:data,dataType:"html",success:function(html){loadingOn.hide();
loadingOff.show();$("textarea",this.newCommentWrapper).val("");var el=$(html);this.newCommentWrapper.before(el);
DeskPRO_Window.util.modCountEl(this.getEl("count_comments"),"+");if(DeskPRO_Window.sections.publish_section){DeskPRO_Window.sections.publish_section.modCommentCount("articles","+")
}}})},_initTrans:function(){var self=this;var transGroup=this.wrapper.find(".trans-input-form");if(!transGroup[0]){return
}transGroup.find(".language_id_switcher").on("click change",function(){transGroup.find(".dp-group").removeClass("on");
$(this).closest(".dp-group").addClass("on")});transGroup.find("textarea").each(function(){var rte=DP.rteTextarea($(this));
$(this).data("rte",rte)});transGroup.find(".copy-trigger").on("click",function(){var row=$(this).closest(".dp-group");
var titleInput=row.find(".title-row").find("input");var contentInput=row.find(".editor-row").find("textarea");
var defaultTitleInput=self.getEl("editname").find("input");var defaultContentInput=self.wrapper.find(".article-editor-wrap").find(".edit-content-field-default");
titleInput.val(defaultTitleInput.val());contentInput.tinymce().setContent(defaultContentInput.val())});
transGroup.find(".save-trigger").on("click",function(){var row=$(this).closest(".dp-group");var titleInput=row.find(".title-row").find("input");
var contentInput=row.find(".editor-row").find("textarea");var postData=[];postData.push({name:titleInput.attr("name"),value:titleInput.val()});
postData.push({name:contentInput.attr("name"),value:contentInput.val()});postData.push({name:"action",value:"trans"});
row.addClass("dp-loading-on");$.ajax({url:BASE_URL+"agent/kb/article/"+self.meta.article_id+"/ajax-save",type:"POST",data:postData,context:this,dataType:"json",complete:function(){row.removeClass("dp-loading-on")
},success:function(data){row.removeClass("is-status-neg").addClass("is-status-pos")}})})}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page");
DeskPRO.Agent.PageFragment.Page.AgentChatTranscript=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.TYPENAME="agentchat"
}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page");DeskPRO.Agent.PageFragment.Page.UserChat=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.TYPENAME="userchat"
},initMetaData:function(){DeskPRO_Window.recentTabs.add("userchat",this.meta.conversation_id,this.meta.title,BASE_URL+"agent/chat/view/"+this.meta.conversation_id)
},initPage:function(el){var self=this;var OBJ_ID=this.OBJ_ID;this.el=el;this.chatStatus=this.meta.status;
this.chatEndedBy=this.meta.ended_by;var messageTextarea=this.getEl("replybox_txt");var sendMsg=function(){var msg=messageTextarea.val().trim();
if(messageTextarea.data("redactor")){messageTextarea.setCode("");messageTextarea.change();self.getEl("replybox").css("height",40+69);
self.getEl("messages_box").css("bottom",40+69)}else{messageTextarea.val("")}if(!msg.length){return}var tmp_id=Orb.uuid();
self.addMessageRow(self.meta.youName,msg,"agent",DeskPRO_Window.canUseAgentReplyRte(),tmp_id,{no_notify:true,person_avatar:self.meta.youPictureUrl});
self.sendMessage(msg,function(message_id){var d=new Date();var a_p="am";var curr_hour=d.getHours();if(d.getHours()>12){a_p="pm"
}if(curr_hour==0){curr_hour=12}else{if(curr_hour>12){curr_hour=curr_hour-12}}var curr_min=d.getMinutes();
curr_min=curr_min+"";if(curr_min.length==1){curr_min="0"+curr_min}var time=curr_hour+":"+curr_min+""+a_p;
self.getEl("messages_box").find(".message-"+tmp_id).addClass("message-"+message_id).addClass("server-ack").data("message-id",message_id).attr("title","User read message at: "+time)
})};this.doSendMsg=function(){sendMsg()};messageTextarea.on("keypress",function(ev){if(ev.keyCode==13&&!ev.metaKey){ev.preventDefault();
sendMsg()}});this.addEvent("destroy",function(){DeskPRO_Window.getMessageBroker().removeTaggedListeners(OBJ_ID);
if(self.chatStatus=="ended"){return}if(self.closeAction=="unassign"){self.leaveConvo("unassign")}else{if(self.closeAction=="end"){self.leaveConvo("end")
}else{self.leaveConvo(null)}}});this._initMenus();this._initAssignControl();this._initBlock();this._initLabels();
DeskPRO_Window.getMessageBroker().addMessageListener("chat_convo."+this.meta.conversation_id+".newmessage",this.handleNewMessageCm,this,[this.OBJ_ID]);
DeskPRO_Window.getMessageBroker().addMessageListener("chat_convo."+this.meta.conversation_id+".hidden_newmessage",this.handleNewMessageCm,this,[this.OBJ_ID]);
DeskPRO_Window.getMessageBroker().addMessageListener("chat_convo."+this.meta.conversation_id+".ended",this.chatHasEnded,this,[this.OBJ_ID]);
DeskPRO_Window.getMessageBroker().addMessageListener("chat_convo."+this.meta.conversation_id+".reassigned",function(data){this.chatReassignedTo(data.agent_id)
},this,[this.OBJ_ID]);DeskPRO_Window.getMessageBroker().addMessageListener("chat_convo."+this.meta.conversation_id+".unassigned",function(data){this.chatReassignedTo(data.agent_id)
},this,[this.OBJ_ID]);DeskPRO_Window.getMessageBroker().addMessageListener("chat_convo."+this.meta.conversation_id+".usertyping",function(data){this.userTyping(data)
},this,[this.OBJ_ID]);DeskPRO_Window.getMessageBroker().addMessageListener("chat_convo."+this.meta.conversation_id+".ack_messages",function(data){this.ackMessages(data)
},this,[this.OBJ_ID]);DeskPRO_Window.getMessageBroker().addMessageListener("chat.ended",function(data){if(this.meta.conversation_id==data.conversation_id){this.chatStatus="ended"
}},this,[this.OBJ_ID]);var textarea=this.getEl("replybox_txt"),isWysiwyg=false;if(DeskPRO_Window.canUseAgentReplyRte()){isWysiwyg=true;
DeskPRO_Window.initRteAgentReply(textarea,{defaultIsHtml:true,minHeight:65,maxHeight:40,inlineHiddenPosition:this.getEl("is_html_reply"),convertLinks:false,callback:function(obj){obj.addBtnFirst("dp_attach","Click here to attach a file. You may also drag a file from your computer desktop into this reply area to upload attachments faster.",function(){});
obj.addBtnAfter("dp_attach","dp_snippets","Open snippets",function(){});obj.addBtnAfter("horizontalrule","dp_create_ticket","Create Ticket",function(){DeskPRO_Window.newTicketLoader.open(function(page){page.setNewByChat({chat_id:self.meta.conversation_id,chat_title:self.meta.chatTitle,person_id:self.meta.person_id,sesson_id:self.meta.session_id,email:self.meta.email})
})});obj.addBtnAfter("dp_create_ticket","dp_end_chat","End Chat",function(){self.endChat()});obj.addBtnAfter("dp_end_chat","dp_send_message","Send your message (or press the Enter or Return key on your keyboard)",function(){self.doSendMsg()
});obj.addBtnSeparatorAfter("dp_attach");obj.addBtnSeparatorAfter("dp_snippets");obj.addBtnSeparatorAfter("horizontalrule");
snippetBtn=obj.$toolbar.find(".redactor_btn_dp_snippets").closest("li");snippetBtn.addClass("snippets").find("a").html('<span class="show-key-shortcut">S</span>nippets');
var tmp=obj.$toolbar.find(".redactor_btn_dp_attach").closest("li");tmp.addClass("attach");tmp.find("a").text("Attach").append('<input type="file" class="file" name="file-upload" />');
tmp=obj.$toolbar.find(".redactor_btn_dp_send_message").closest("li");tmp.addClass("dp_send_message");
tmp.find("a").text("Send")}});this.getEl("is_html_reply").val(1);if(textarea.data("redactor")){var ed=textarea.getEditor();
ed.on("keypress",function(ev){if(ev.keyCode===13&&!ev.shiftKey&&!ev.ctrlKey&&!ev.metaKey){ev.preventDefault();
window.setTimeout(function(){ed.linkify();window.setTimeout(function(){sendMsg()},100)},10)}});var lastH=ed.height();
ed.on("keypress change",function(){window.setTimeout(function(){var tmp=ed.height();if(lastH!=tmp){lastH=tmp;
self.getEl("replybox").css("height",lastH+44);self.getEl("messages_box").css("bottom",lastH+44)}},50)
})}}if(textarea.data("redactor")){var ed=textarea.getEditor();var api=textarea.data("redactor");var te=new DeskPRO.TextExpander({textarea:ed,onCombo:function(combo,ev){combo=combo.replace(/%/g,"");
if(window.DESKPRO_CHAT_SNIPPET_SHORTCODES&&window.DESKPRO_CHAT_SNIPPET_SHORTCODES[combo]){ev.preventDefault();
var snippetId=window.DESKPRO_CHAT_SNIPPET_SHORTCODES[combo];var focus=api.getFocus(),focusNode=$(focus[0]),testText;
if(focus[0].nodeType==3){testText=focusNode.text().substring(0,focus[1])}else{focus[0]=focusNode.contents().get(focus[1]-1);
focusNode=$(focus[0]);testText=focusNode.text();focus[1]=testText.length}var lastAt=testText.lastIndexOf("%"),matches=[];
if(lastAt!=-1){api.setSelection(focus[0],lastAt,focus[0],focus[1])}var editable=$.browser.webkit?' contenteditable="false"':"";
api.insertHtml('<span class="editor-inserting-var snippet-'+snippetId+'" '+editable+' data-snippet-id="'+snippetId+'">Inserting snippet...</span>');
$.ajax({url:BASE_URL+"agent/text-snippets/chat/"+snippetId+".json",dataType:"json",success:function(data){var snippet=data.snippet;
var snippetId=snippet.id;var snippetCode=snippet.snippet;var agentText;var defaultText;var wantText;var useText;
var result;Array.each(snippetCode,function(info){if(info.language_id==DESKPRO_DEFAULT_LANG_ID){defaultText=info.value
}useText=info.value});if(wantText){useText=wantText}else{if(agentText){useText=agentText}else{if(defaultText){useText=defaultText
}}}var el=api.$editor.find(".editor-inserting-var.snippet-"+snippetId);var wrapper=$("<div/>");wrapper.html(useText);
if(wrapper.find("> div, > p, > span")[0]){data=wrapper.find("> *")}else{data=wrapper}var coll;if(data.length==1){coll=data
}else{coll=data.find("> p")}coll.each(function(){var l=$(this).find("> *").last();if(l.is("br")){l.remove()
}});if(data.find("> div, > span, > p").length==1){var span=$("<span></span>");span.append(data.find("> *"));
data=span}else{if(data.find("> *").length==0){var span=$("<span></span>");span.html(data.html());data=span
}}data.append('<span class="_cursor"></span>');var cursor=data.find("._cursor");el.after(data);el.remove();
api.setSelection(cursor[0],0,cursor[0],0)}})}}})}this.snippetsViewer=new DeskPRO.Agent.Widget.SnippetViewer({triggerElement:snippetBtn,snippetType:"chat",onSnippetClick:function(info){var snippetId=info.snippetId;
var snippetCode=info.snippetCode;var agentText;var defaultText;var wantText;var useText;var result;Array.each(snippetCode,function(info){if(info.language_id==DESKPRO_DEFAULT_LANG_ID){defaultText=info.value
}useText=info.value});if(wantText){useText=wantText}else{if(agentText){useText=agentText}else{if(defaultText){useText=defaultText
}}}var val=useText;var messageTextarea=self.getEl("replybox_txt");var data=$("<div></div>").html(val);
if(data.find("> span, > div, > p").length==1){var span=$("<span></span>");span.append(data.find("> *"));
data=span}else{if(data.find("> span, > div, > p").length==0){var span=$("<span></span>");span.html(data.html());
data=span}}val=data.html();if(messageTextarea.data("redactor")){try{messageTextarea.data("redactor").restoreSelection();
messageTextarea.data("redactor").setBuffer()}catch(e){}var html=val;html=html.replace(/<\/p>\s*<p>/g,"<br/>");
html=html.replace(/^<p>/,"");html=html.replace(/<\/p>$/,"");messageTextarea.data("redactor").insertHtml(html);
messageTextarea.change();window.setTimeout(function(){var tmp=ed.height();if(lastH!=tmp){lastH=tmp;self.getEl("replybox").css("height",lastH+69);
self.getEl("messages_box").css("bottom",lastH+69)}},100)}else{var pos=messageTextarea.getCaretPosition();
if(!pos){messageTextarea.setCaretPosition(0)}messageTextarea.insertAtCaret(val)}self.snippetsViewer.close()
}});this.closeAction=false;this._confirmCloseOverlay=new DeskPRO.UI.Overlay({contentElement:this.getEl("closetab_prompt"),addClassname:"normal-size",onPosition:function(evData){var tabId=self.getTabId();
if(!tabId){return}var tabEl=$("#tabbtn_"+tabId);if(!tabEl[0]){return}var tabW=tabEl.width();evData.left=(tabEl.offset().left+(tabW/2))-(evData.w/2);
evData.top=tabEl.offset().top;if((evData.left+evData.w)>evData.pageW){evData.left=evData.pageW-evData.w-15
}},onContentSet:function(eventData){$(".unassign-trigger").on("click",function(){self._confirmCloseOverlay.close();
self.closeAction="unassign";DeskPRO_Window.TabBar.removeTabById(self.meta.tabId)});$(".end-trigger").on("click",function(){self._confirmCloseOverlay.close();
self.closeAction="end";DeskPRO_Window.TabBar.removeTabById(self.meta.tabId)});$(".cancel-trigger").on("click",function(){self._confirmCloseOverlay.close()
})}});this.addEvent("closeTab",function(event){if(this.getEl("assign_btn").data("agent-id")!=DESKPRO_PERSON_ID||this.chatStatus=="ended"){return
}if(this.chatStatus=="ended"){return}if(this.closeAction){return}event.deskpro.cancelClose=true;this._confirmCloseOverlay.open()
},this);this.getEl("create_ticket_btn2").on("click",function(){DeskPRO_Window.newTicketLoader.open(function(page){page.setNewByChat({chat_id:self.meta.conversation_id,chat_title:self.meta.chatTitle,person_id:self.meta.person_id,sesson_id:self.meta.session_id,email:self.meta.email})
})});var imposter=this.getEl("imposter");if(imposter[0]){imposter.find("button.dismiss").on("click",function(){imposter.fadeOut("fast",function(){imposter.remove()
})})}var notifRow=DeskPRO_Window.notifications.findRow("id-chat-"+this.meta.conversation_id);if(notifRow){DeskPRO_Window.notifications.removeRow(notifRow)
}this.getEl("replybox_txt").on("focus",function(){$(this).addClass("is-focused")});this.getEl("replybox_txt").on("blur",function(){$(this).removeClass("is-focused")
});this.getEl("messages_box").on("click",".truncated-wrap",function(){var content=$(this).find("textarea").val();
self.showFullMessage(content)});this.chatFields=new DeskPRO.Agent.PageHelper.ChatFields(this);this.chatFields.updateDisplay();
this.ownObject(this.chatFields);var maintabs=this.getEl("main_tabs_nav");if(maintabs.data("simpletabs")){maintabs.data("simpletabs").addEvent("tabSwitch",function(evData){var tabEl=$(evData.tabEl);
if(tabEl[0]){if(tabEl.hasClass("is-fields-tab")){self.getEl("field_edit_controls").show()}else{self.getEl("field_edit_controls").hide()
}}})}this._initUpload()},handleNewMessageCm:function(data,name){if(data.author_type&&data.author_type=="agent"&&data.author_id&&data.author_id==DESKPRO_PERSON_ID&&!(data.metadata&&data.metadata.type&&data.metadata.type=="file")){return
}if(this.userTypingTime&&(new Date()).getTime()>this.userTypingTime){this.userTypingTime=null;this.getEl("user_typing").hide()
}this.addMessageRow(data.author_name,data.content,data.author_type,data.is_html,data.message_id,data.metadata,data)
},chatReassignedTo:function(agent_id){var btnEl=this.getEl("assign_btn");if(agent_id=="0"){var pic="";
var agentInfo={name:"Unassigned"}}else{var agentInfo=DeskPRO_Window.getAgentInfo(agent_id);if(!agentInfo){return
}var pic=agentInfo.pictureUrlSizable.replace("{SIZE}",20)}$("li",this.getEl("agent_parts")).show();if(agent_id!="0"){$("li.agent-"+agent_id,this.getEl("agent_parts")).hide()
}if($("li:visible",this.getEl).length){this.getEl("agent_parts_none").hide()}else{this.getEl("agent_parts_none").show()
}this.getEl("agent_assign_ob").data("assigned",agent_id);btnEl.css("background-image",pic);btnEl.text(agentInfo.name);
btnEl.data("agent-id",agent_id)},addPart:function(agent_id){if($(".agent-"+agent_id,this.getEl("agent_parts")).length){return
}var agentInfo=DeskPRO_Window.getAgentInfo(agent_id);var li=$("<li><a></a></li>");li.addClass("agent-"+agent_id);
$("a",li).text(agentInfo.name).addClass("agent-link").css({"background-image":agentInfo.pictureUrlSizable.replace("{SIZE}",20)});
this.getEl("agent_parts").append(li);if(this.getEl("assign_btn").data("agent-id")==agent_id){li.hide()
}if($("li:visible",this.getEl).length){this.getEl("agent_parts_none").show()}},removePart:function(agent_id){$(".agent-"+agent_id,this.getEl("agent_parts")).remove();
if(!$("li:visible",this.getEl).length){this.getEl("agent_parts_none").hide()}},updateActiveAgentList:function(assigned,parts){var assigned_name=DeskPRO_Window.getDisplayName("agent",agent_id)||"Unassigned";
$("span.agent_id.val",this.el).html(assigned_name);var ul=$(".convo_participants ul",this.el);ul.empty();
if(!parts.lenght){ul.append('<li class="agent-0">None</li>')}else{Array.each(parts,function(agent_id){var name=DeskPRO_Window.getDisplayName("agent",agent_id);
ul.append('<li class="agent-'+agent_id+'">'+name+"</li>")})}},userTyping:function(data){if(!data||!data.preview||!data.preview.length){this.getEl("user_typing").hide();
return}var preview=data.preview;if(preview.length>500){preview="..."+preview.substring(preview.length-500)
}this.userTypingTime=(new Date()).getTime();var el=this.getEl("user_typing");$(".prop-msg",el).text(preview);
el.detach().appendTo(this.getEl("messages_box"));el.show();this.updateUi.bind(this);this.getEl("messages_box").scrollTop(10000)
},ackMessages:function(data){if(!data||!data.message_ids||!data.message_ids.length){return}Array.each(data.message_ids,function(message_id){this.getEl("messages_box").find(".message-"+message_id).addClass("user-ack")
},this)},_initMenus:function(){var self=this;var dep=this.getEl("department_id");DP.select(dep);dep.on("change",function(){var depId=parseInt($(this).val());
DeskPRO_Window.util.ajaxWithClientMessages({url:BASE_URL+"agent/chat/change-props/"+self.meta.conversation_id,data:[{name:"props[department_id]",value:depId}],type:"POST"})
})},endChat:function(){DeskPRO_Window.util.ajaxWithClientMessages({url:BASE_URL+"agent/chat/end-chat/"+this.meta.conversation_id})
},leaveChat:function(){if(this.chatStatus=="ended"||this.getEl("assign_btn").data("agent-id")!=DESKPRO_PERSON_ID){return
}$.ajax({url:BASE_URL+"agent/chat/assign/"+this.meta.conversation_id+"/0",data:{"leaving":true},context:this,contentType:"json"})
},chatHasEnded:function(data){},addPart:function(agent_id){$.ajax({url:BASE_URL+"agent/chat/add-part/"+this.meta.conversation_id+"/"+agent_id,context:this,contentType:"json"})
},syncPars:function(agent_ids){var postData=[];Array.each(agent_ids,function(id){postData.push({name:"agent_ids[]",value:id})
});$.ajax({url:BASE_URL+"agent/chat/sync-parts/"+this.meta.conversation_id,data:postData,type:"POST",context:this,contentType:"json"})
},reassignConvo:function(agent_id){DeskPRO_Window.util.ajaxWithClientMessages({url:BASE_URL+"agent/chat/assign/"+this.meta.conversation_id+"/"+agent_id})
},leaveConvo:function(after){this.quitting=true;var self=this;var action="";if(after){if(after=="unassign"){action="unassign"
}else{if(after=="end"){action="end"}}}DeskPRO_Window.util.ajaxWithClientMessages({url:BASE_URL+"agent/chat/leave/"+this.meta.conversation_id,data:{action:action}})
},addMessageRow:function(name,msg,type,is_html,message_id,metadata,reqData){var notify=true;if(message_id&&$(".message-"+message_id,this.getEl("messages_box")).length){return
}if(type=="sys"){name="* "}else{name="&lt;"+name+"&gt; "}var popoutclass="";if(type=="user"){popoutclass=" person-overview"
}var addclass="";if(metadata&&metadata.new_user_track){this.userTyping();addclass="user-track";notify=false;
this.getEl("messages_box").find(".row.agent").addClass("user-ack")}var avatarHtml="";var person_avatar=metadata.person_avatar||this.meta.userPictureUrl;
person_avatar=person_avatar.replace(/\/avatar\/\d+\//,"/avatar/25/",person_avatar);person_avatar=person_avatar.replace(/\/size\/\d+\//,"/size/25/",person_avatar);
if(person_avatar.indexOf("gravatar.com")!==-1){person_avatar=person_avatar.replace(/&?s=\d+\//,"",person_avatar);
person_avatar=Orb.appendQueryData(person_avatar,"s","25")}avatarHtml='<div class="avatar tipped" title="'+Orb.escapeHtml(metadata.author_name||"")+'"><img src="'+person_avatar+'" /></div>';
var html=['<div class="row '+type+" "+addclass+'"><div class="message-content">'];if(type=="sys"){html.push('<div class="message prop-msg"></div><time></time>')
}else{if(type=="agent"){html.push(avatarHtml);html.push('<div class="chatSend"><div class="chatMsgSend"><div class="prop-msg"></div><span class="bubbleLeft"></span></div></div><time></time><span class="ack-icon"></span>');
html.push('<div class="chat-clear"></div>')}else{if(type=="user"){this.userTyping();html.push(avatarHtml);
html.push('<div class="chatRecieve"><div class="chatMsgRecieve"><div class="prop-msg"></div><span class="bubbleRight"></span></div></div><time></time>');
html.push('<div class="chat-clear"></div>')}}}html.push("</div></div>");var row=$(html.join(""));var d=new Date();
var a_p="am";var curr_hour=d.getHours();if(d.getHours()>12){a_p="pm"}if(curr_hour==0){curr_hour=12}else{if(curr_hour>12){curr_hour=curr_hour-12
}}var curr_min=d.getMinutes();curr_min=curr_min+"";if(curr_min.length==1){curr_min="0"+curr_min}$("time",row).text(curr_hour+":"+curr_min+""+a_p);
if(message_id){row.addClass("message-"+message_id)}if(type=="sys"){if(msg.indexOf('{"phrase_id":')===0){try{var data=$.parseJSON(msg)
}catch(e){console.error(e);data={}}if(data.phrase_id){msg=DeskPRO_Window.getTranslate().phrase("agent.userchat."+data.phrase_id,data,true)
}else{msg="unknown phrase"}}}if(is_html){var titleMsg="New chat message";$(".prop-msg",row).html(msg)
}else{var titleMsg=msg;var isTruncated=false;var origMsg=msg;if(type=="user"&&msg.length>500){isTruncated=true;
msg=msg.substring(0,500)}msg=Orb.escapeHtml(msg);msg=Orb.nl2br(msg);msg=DeskPRO_Window.util.linkUrls(msg);
if(isTruncated){msg+=' <div class="truncated-wrap"><div class="truncated-btn">&bull; &bull; &bull;</div><textarea class="orig-message" style="display:none;">'+Orb.escapeHtml(origMsg)+"</textarea></div>"
}$(".prop-msg",row).html(msg)}$("time",row).attr("datetime",(new Date()).toString());DeskPRO_Window.initInterfaceLayerEvents(row);
row.appendTo(this.getEl("messages_box"));this.getEl("messages_box").scrollTop(10000);if(notify){if(reqData&&reqData.author_type&&reqData.author_type=="agent"&&reqData.from_client==DESKPRO_SESSION_ID){notify=false
}}if(metadata&&metadata.no_notify){notify=false}if(notify&&!this.quitting){this.alertTab();DeskPRO_Window.faviconBadge.enableCrazyMode(titleMsg);
var alertEl=$.tmpl("user_chat_newmsg_sound");alertEl.appendTo(this.el);DeskPRO_Window.handleSoundElements(alertEl)
}this.updateUi()},sendMessage:function(msg,success){DeskPRO_Window.util.ajaxWithClientMessages({type:"POST",url:BASE_URL+"agent/chat/send-message/"+this.meta.conversation_id,data:{content:msg,is_html:DeskPRO_Window.canUseAgentReplyRte()},execSuccessBefore:true,success:function(data){if(success&&data.message_id){success(data.message_id)
}}})},sendInvite:function(agent_id){DeskPRO_Window.util.ajaxWithClientMessages({url:BASE_URL+"agent/chat/invite/"+this.meta.conversation_id+"/"+agent_id})
},showFullMessage:function(msg){if(!this.fullMessageOverlay){this.fullMessageOverlay=new DeskPRO.UI.Overlay({contentElement:this.getEl("view_fulle_message_overlay")})
}msg=Orb.escapeHtml(msg);msg=Orb.nl2br(msg);this.getEl("view_full_message_content").html(msg);this.fullMessageOverlay.openOverlay()
},_initAssignControl:function(){var self=this;var followersList=this.getEl("followers_list");var el=this.getEl("agent_assign_ob");
this.assignOptionBox=new DeskPRO.UI.OptionBoxRevertable({element:el,trigger:this.getEl("assign_ob_trigger"),onSave:function(ob){var selections=ob.getAllSelected();
var agent_id=parseInt(selections.agents||0);followersList.empty();var selections=ob.getAllSelected();
var part_ids=[];Array.each(selections.followers,function(part_id){var label=$(".agent-part-label-"+part_id,ob.getElement()).first().text().trim();
var li=$("<li />");var span=$("<span />");span.addClass("agent-link");span.data("agent-id",part_id);span.attr("data-agent-id",part_id);
span.text(label);span.appendTo(li);followersList.append(li);part_ids.push(part_id)});if(part_ids.length){self.syncPars(part_ids)
}if(!selections.followers.length){followersList.append("<li>No followers</li>")}var current_agent=parseInt(el.data("assigned"));
if(current_agent!=agent_id){self.reassignConvo(agent_id)}}});var box1=self.getEl("people_box_person_container");
var box2=self.getEl("people_box_agent_container");var box1_in=$("> article",box1);var box2_in=$("> article",box2);
var chatView=this.getEl("chat_view"),chatPositioner=this.getEl("chat_positioner"),header=self.wrapper.find(".page-header");
var syncSizes=function(){var h1=box1_in.height();var h2=box2_in.height();box1_in.each(function(){var thisH=$(this).outerHeight();
if(thisH>h1){h1=thisH}});box2_in.each(function(){var thisH=$(this).outerHeight();if(thisH>h2){h2=thisH
}});var h=(h1>h2)?h1:h2;box2.css("min-height",h);box1.css("min-height",h)};var syncChatSize=function(){chatView.css("top",chatPositioner.outerHeight()+header.outerHeight())
};chatPositioner.on("resize",syncChatSize);box1.on("resize",syncSizes);box2.on("resize",syncSizes);syncSizes();
syncChatSize()},_initUpload:function(){var self=this;DeskPRO_Window.util.fileupload(this.el,{uploadTemplate:$(".template-upload",this.el),downloadTemplate:$(".template-download",this.el),dropZone:this.getEl("replybox").find("nav")});
this.el.bind("fileuploaddone",function(ev,data){if(data.result&&data.result.length){var items=data.result,x;
for(x=0;x<items.length;x++){DeskPRO_Window.util.ajaxWithClientMessages({url:BASE_URL+"agent/chat/send-file-message/"+self.meta.conversation_id,data:{send_blob_id:items[0].blob_id}})
}}self.getEl("uploading_list").hide().find("> ul").empty()});this.el.bind("fileuploadstart",function(){self.getEl("uploading_list").detach().appendTo(self.getEl("messages_box")).show();
self.updateUi();self.getEl("messages_box").scrollTop(10000)})},_initBlock:function(){var self=this;this.getEl("block_user").on("click",function(ev){$(this).prop("disabled",true).html("<em>Loading</em>");
ev.preventDefault();var postData={block_ip:self.getEl("block_ip").is(":checked")?1:0,reason:self.getEl("block_reason").val()};
$.ajax({url:BASE_URL+"agent/chat/block-user/"+self.meta.conversation_id,type:"POST",data:postData,dataType:"json",complete:function(){self.closeSelf();
DeskPRO_Window.loadPage(BASE_URL+"agent/chat/view/"+self.meta.conversation_id,{ignoreExist:true})}})});
this.getEl("unblock_user").on("click",function(ev){$(this).prop("disabled",true).html("<em>Loading</em>");
ev.preventDefault();$.ajax({url:BASE_URL+"agent/chat/unblock-user/"+self.meta.conversation_id,type:"POST",dataType:"json",complete:function(){self.closeSelf();
DeskPRO_Window.loadPage(BASE_URL+"agent/chat/view/"+self.meta.conversation_id,{ignoreExist:true})}})})
},_initLabels:function(){if(this.getEl("labels_input")[0]){this.labelsInput=new DeskPRO.UI.LabelsInput({type:"chat_conversations",input:this.getEl("labels_input"),onChange:this.saveLabels.bind(this)});
this.ownObject(this.labelsInput)}},saveLabels:function(){if(this._saveLabelsTimeout){window.clearTimeout(this._saveLabelsTimeout)
}this._labelsData=this.labelsInput.getFormData();this._saveLabelsTimeout=this._doSaveLabels.delay(2000,this)
},_doSaveLabels:function(){var data=this._labelsData;$.ajax({url:BASE_URL+"agent/chat/"+this.meta.conversation_id+"/ajax-save-labels",type:"POST",context:this,data:data,dataType:"json"})
}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page");DeskPRO.Agent.PageFragment.Page.FeedbackView=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="feedback"},initPage:function(el){var self=this;this.wrapper=el;this.feedback_id=this.getMetaData("feedback_id");
this._initBasic();if(this.meta.canEdit){this._initMenus();this._initPostArea()}this._initActions();this._initLabels();
this._initCommentForm();if(this.meta.canEdit){if(this.meta.isValidating){this.validatingEdit=new DeskPRO.Agent.PageHelper.ValidatingEdit(this,{typename:"feedback",contentId:this.feedback_id,singleTyle:"feedback"});
this.ownObject(this.validatingEdit)}this.getEl("edit_btn").on("click",this.showEditor.bind(this))}this.relatedContent=new DeskPRO.Agent.PageHelper.RelatedContent(this,{typename:"feedback",content_id:this.feedback_id,listEl:$("section.linked-content:first",this.wrapper),disabled:!this.meta.canEdit,onContentLinked:function(typename,content_id){$.ajax({url:BASE_URL+"agent/feedback/view/"+self.feedback_id+"/ajax-save",type:"POST",data:{content_type:typename,content_id:content_id,action:"add-related"},context:this,dataType:"json"})
},onContentUnlinked:function(typename,content_id){$.ajax({url:BASE_URL+"agent/feedback/view/"+self.feedback_id+"/ajax-save",type:"POST",data:{content_type:typename,content_id:content_id,action:"remove-related"},context:this,dataType:"json"})
}});this.ownObject(this.relatedContent);DeskPRO_Window.getMessageBroker().addMessageListener("publish.validating.list-remove",function(info){$("article."+info.typename+"-"+info.contentId).slideUp()
});this.miscContent=new DeskPRO.Agent.PageHelper.MiscContent(this,{revisionCompareUrl:BASE_URL+"agent/feedback/compare-revs/{OLD}/{NEW}"});
this.ownObject(this.miscContent);this.whoVotedOverlay=new DeskPRO.UI.Overlay({triggerElement:".who-voted-trigger",contentMethod:"ajax",contentAjax:{url:BASE_URL+"agent/publish/rating-who-voted/feedback/"+this.feedback_id}});
this.ownObject(this.whoVotedOverlay);this.getEl("my_vote").on("click",function(){self.toggleMyVote()});
var fieldsRendered=this.getEl("custom_fields_rendered");var fieldsForm=this.getEl("custom_fields_editable");
var buttonsWrap=this.getEl("properties_controls");var propToggle=function(what){if(what=="display"){$(".showing-editing-fields",buttonsWrap).hide();
$(".showing-rendered-fields",buttonsWrap).show();fieldsForm.hide();fieldsRendered.show()}else{$(".showing-rendered-fields",buttonsWrap).hide();
$(".showing-editing-fields",buttonsWrap).show();fieldsRendered.hide();fieldsForm.show()}};$(".edit-fields-trigger",buttonsWrap).on("click",function(){propToggle("edit")
});$(".save-fields-trigger",buttonsWrap).on("click",function(){var formData=$('input[type="text"], input[type="password"], input:checked, select, textarea',fieldsForm);
$.ajax({url:BASE_URL+"agent/feedback/view/"+self.meta.feedback_id+"/ajax-save-custom-fields",type:"POST",data:formData,dataType:"html",success:function(rendered){fieldsRendered.empty().html(rendered);
propToggle("display")}})});var namef=this.getEl("showname");var editName=this.getEl("editname");var startBtn=this.getEl("editname_start");
var stopBtn=this.getEl("editname_end");var startEditable=function(){namef.hide();editName.show();startBtn.hide();
stopBtn.show()};var stopEditable=function(){var nametxt=editName.find("input").first();var setName=nametxt.val().trim();
if(!setName){return}editName.hide();startBtn.show();namef.show();stopBtn.hide();namef.text(setName);var postData=[];
postData.push({name:"action",value:"title"});postData.push({name:"title",value:setName});$.ajax({url:BASE_URL+"agent/feedback/view/"+self.feedback_id+"/ajax-save",type:"POST",data:postData,success:function(data){self.handleUnloadRevisions(data.revision_id)
}})};namef.on("dblclick",startEditable).on("keypress",function(ev){if(ev.keyCode==13){ev.preventDefault();
stopEditable()}});this.getEl("editname_start").on("click",startEditable);this.getEl("editname_end").on("click",stopEditable);
if(this.meta.canEdit){var self=this;this.getEl("status").on("change",function(){var catId=$(this).val();
$.ajax({url:BASE_URL+"agent/feedback/view/"+self.feedback_id+"/ajax-save",type:"POST",data:{action:"status",status:catId},context:self,dataType:"json",success:function(){DeskPRO_Window.getMessageBroker().sendMessage("agent.ui.feedback-status-update",{feedback_id:self.feedback_id,new_status:catId})
}})})}else{this.getEl("status").prop("disabled",true)}DP.select(this.getEl("status"));this.deleteHelper=new DeskPRO.Agent.PageFragment.Page.Content.DeleteControl(this,{ajaxSaveUrl:BASE_URL+"agent/feedback/view/"+self.feedback_id+"/ajax-save"});
this.deleteHelper.undeleteBtn.on("click",function(){self.getEl("status").find("option").first().prop("selected",true).trigger("change");
self.deleteHelper.handleUndelete()});this.ownObject(this.deleteHelper)},destroyPage:function(){var el=$(".feedback-editor-wrap",this.getEl("content_ed"));
if(el&&el.parentNode){el.parentNode.removeChild(el)}},handleUnloadRevisions:function(revision_id){if(!revision_id){return
}if($(".rev-"+revision_id,this.getEl("revs")).length){return}this.getEl("revs").empty().removeClass("loaded");
DeskPRO_Window.util.modCountEl(this.getEl("count_revs"),"+")},_initBasic:function(){var self=this;this.bodyTabs=new DeskPRO.UI.SimpleTabs({triggerElements:$("li.tab-trigger",this.getEl("bodytabs")),onTabSwitch:(function(info){if($(info.tabContent).is(".content-tab")){self.getEl("content_edit_btns").show()
}else{self.getEl("content_edit_btns").hide()}if($(info.tabContent).is(".related-content-tab")){$("body").addClass("related-controls-on")
}else{if($(info.tabContent).is(".search-tab")){self._initSearchTab()}$("body").removeClass("related-controls-on")
}if($(info.tabContent).is(".feedback-revs")&&!$(info.tabContent).is(".loaded")){$.ajax({url:BASE_URL+"agent/feedback/view/"+this.feedback_id+"/view-revisions",type:"GET",dataType:"html",context:self,success:function(html){this.getEl("revs").html(html);
this.miscContent._initCompareRevs();$(info.tabContent).addClass("loaded")}})}}).bind(this)});this.ownObject(this.bodyTabs)
},toggleMyVote:function(){var action;if(this.getEl("my_vote").is(".radio-on")){action="clear-vote";DeskPRO_Window.util.modCountEl(this.getEl("num_votes"),"-");
this.getEl("my_vote").removeClass("radio-on")}else{action="vote";DeskPRO_Window.util.modCountEl(this.getEl("num_votes"),"+");
this.getEl("my_vote").addClass("radio-on")}$.ajax({url:BASE_URL+"agent/feedback/view/"+this.feedback_id+"/ajax-save",type:"POST",data:{action:action},context:this,dataType:"json"})
},_initMenus:function(){var self=this;if(this.meta.canEdit){var catOb=new DeskPRO.UI.OptionBoxRevertable({trigger:this.getEl("cat_trigger"),element:this.getEl("cat_ob"),onSave:function(ob){var catEl=ob.getSelectedElements("category");
var catId=catEl.data("item-id");var title=catEl.data("full-title");self.getEl("cat_label").text(title);
$.ajax({url:BASE_URL+"agent/feedback/view/"+self.feedback_id+"/ajax-save",type:"POST",data:{action:"category",category_id:catId},dataType:"json"})
}})}},_initActions:function(){var self=this;var actions=this.getEl("action_buttons");$(".permalink",actions).on("click",function(){var html=[];
html.push("<div>");html.push("The permalink to this feedback on the website is:<br />");html.push('<input type="text" style="width:95%;" />');
html.push("</div>");var msg=$(html.join(""));$("input",msg).val(self.meta.permalink);DeskPRO_Window.showAlert(msg)
});$(".view-user-interface",actions).on("click",function(){window.open(self.meta.permalink)});this.merge=new DeskPRO.Agent.Widget.Merge({tabType:"feedback",metaId:self.meta.feedback_id,metaIdName:"feedback_id",menu:this.getEl("merge_menu"),trigger:$(".merge",this.getEl("action_buttons")),overlayUrl:BASE_URL+"agent/feedback/merge-overlay/{id}/{other}",mergeUrl:BASE_URL+"agent/feedback/merge/{id}/{other}",loadRoute:"feedback:"+BASE_URL+"agent/feedback/view/{id}"});
this.ownObject(this.merge)},_initLabels:function(){this.labelsInput=new DeskPRO.UI.LabelsInput({type:"feedback",input:this.getEl("labels_input"),onChange:this.saveLabels.bind(this)});
this.ownObject(this.labelsInput)},saveLabels:function(){if(this._saveLabelsTimeout){window.clearTimeout(this._saveLabelsTimeout)
}this._labelsData=this.labelsInput.getFormData();this._saveLabelsTimeout=this._doSaveLabels.delay(2000,this)
},_doSaveLabels:function(){var data=this._labelsData;$.ajax({url:this.getMetaData("labelsSaveUrl"),type:"POST",context:this,data:data,dataType:"json",success:function(data){this._handleSaveLabelsSuccess(data)
}})},_handleSaveLabelsSuccess:function(data){},_initSearchTab:function(){if(this.hasInitSearchTab){return
}this.hasInitSearchTab=true;this.stickyWords=new DeskPRO.Agent.PageFragment.Page.Content.StickyWords(this,{contentType:"feedback",contentId:this.meta.feedback_id,element:this.getEl("stickysearch_input")});
this.ownObject(this.stickyWords)},_initCommentForm:function(){this.commentsController=new DeskPRO.Agent.PageHelper.Comments(this,{commentsWrapper:this.getEl("comments_wrap")});
this.ownObject(this.commentsController);this.newCommentWrapper=$(".new-note:first",this.wrapper);$("button",this.newCommentWrapper).on("click",this.saveNewComment.bind(this))
},saveNewComment:function(){var loadingOn=$(".loading-on",this.newCommentWrapper).show();var loadingOff=$(".loading-off",this.newCommentWrapper).hide();
var data=[];data.push({name:"content",value:$("textarea",this.newCommentWrapper).val()});if(this.getEl("agent_comment_ck").is(":checked")){data.push({name:"agent_only",value:1})
}$.ajax({url:BASE_URL+"agent/feedback/view/"+this.getMetaData("feedback_id")+"/ajax-save-comment",type:"POST",context:this,data:data,dataType:"html",success:function(html){loadingOn.hide();
loadingOff.show();$("textarea",this.newCommentWrapper).val("");var el=$(html);this.newCommentWrapper.before(el);
DeskPRO_Window.util.modCountEl(this.getEl("count_comments"),"+")}})},_initPostArea:function(){this._hasInitEd=false;
this.getEl("cancel_btn").off("click").on("click",(function(){this.hideEditor();if(!this.wrapper.find(".revert-default")[0]){var def=this.wrapper.find("textarea.edit-content-field-default").val();
this.wrapper.find("textarea.edit-content-field").val(def);if(this.rte){this.rte.val(def)}}}).bind(this));
var wrap=this.wrapper;if(this.editStateSaver){this.editStateSaver.destroy()}this.editStateSaver=new DeskPRO.Agent.PageHelper.StateSaver({stateId:"editfeedback",listenOn:$(".feedback-editor-wrap:first",wrap)});
this.ownObject(this.editStateSaver);this.getEl("save_btn").off("click").on("click",(function(ev){ev.preventDefault();
var data={action:"content",content:$(".feedback-editor-wrap textarea:first",wrap).val(),attach:$(".feedback-editor-wrap .edit-content-attach:first",wrap).val()};
$.ajax({url:BASE_URL+"agent/feedback/view/"+this.feedback_id+"/ajax-save",type:"POST",context:this,data:data,dataType:"json",success:function(data){this.getEl("content_ed").html(data.content_html);
this.handleUnloadRevisions(data.revision_id);this._initPostArea()}})}).bind(this));this.hideEditor()},showEditor:function(){var self=this;
var edWrap=$(".feedback-editor-wrap",this.getEl("content_ed")).show();$(".revert-default",edWrap).on("click",function(){var def=$("textarea.edit-content-field-default").val();
$("textarea.edit-content-field").val(def);$(".revert-message-notice",edWrap).remove()});$(".feedback-content-wrap",this.getEl("content_ed")).hide();
$(".feedback-editor-wrap",this.getEl("content_ed")).show();if(!this._hasInitEd){this._hasInitEd=true;
var txt=$(".edit-content-field",this.getEl("content_ed"));var w=$(txt.closest(".content-tab-item")).width()-30;
if(this.wrapper.find("> .layout-content > .scrollbar.disabled")){var h=$(window).height()-90-txt.offset().top
}else{h=425}txt.css({width:w,height:h});DP.rteTextarea($(".edit-content-field",this.getEl("content_ed")),{setup:function(ed){ed.onKeyPress.add(function(){self.editStateSaver.triggerChange()
})}});var list=$(".file-list",this.wrapper);DeskPRO_Window.util.fileupload(this.wrapper,{url:BASE_URL+"agent/misc/accept-upload?attach_to_object=feedback&object_id="+this.meta.feedback_id,page:this});
list.on("click",".delete",function(ev){ev.preventDefault();ev.stopImmediatePropagation();var blob_id=$(this).data("blob-id");
$.ajax({url:BASE_URL+"agent/feedback/view/"+self.meta.feedback_id+"/ajax-save",type:"POST",data:{action:"remove-blob",blob_id:blob_id},context:self,dataType:"json"});
$(this).parent().fadeOut()})}this.getEl("edit_btn").hide();this.getEl("save_btn").show();this.getEl("cancel_btn").show();
this.updateUi()},hideEditor:function(){this.getEl("edit_btn").show();this.getEl("save_btn").hide();this.getEl("cancel_btn").hide();
$(".feedback-editor-wrap",this.getEl("content_ed")).hide();$(".feedback-content-wrap",this.getEl("content_ed")).show();
this.updateUi()},_initMediaBrowser:function(){if(this.mediabrowser_has_init){return}this.mediabrowser_has_init=true;
this.mediaBrowserEl=$(".media-browser",this.wrapper);this.mediaBrowserOverlay=new DeskPRO.UI.Overlay({contentElement:this.mediaBrowserEl});
this.mediaBrowser=new DeskPRO.Agent.MediaBrowser({wrapper:this.mediaBrowserEl,additionalDropZone:$(".kb-editor > textarea",this.wrapper)})
},showMediaBrowser:function(){this._initMediaBrowser();this.mediaBrowserOverlay.openOverlay()},_initCompareRevs:function(){$(".compare-trigger",this.wrapper).on("click",this.showCompareRev.bind(this))
},showCompareRev:function(){var old_id=$(".feedback-revs input.old:checked",this.wrapper).val();var new_id=$(".feedback-revs input.new:checked",this.wrapper).val();
if(!old_id||!new_id){return}var overlay=new DeskPRO.UI.Overlay({triggerElement:$("button.compare-trigger",this.wrapper),contentMethod:"ajax",contentAjax:{url:BASE_URL+"agent/feedback/compare-revs/"+old_id+"/"+new_id},destroyOnClose:true});
overlay.openOverlay()}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page");DeskPRO.Agent.PageFragment.Page.NewsView=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="news"},initMetaData:function(){DeskPRO_Window.recentTabs.add("news",this.meta.news_id,this.meta.title,BASE_URL+"agent/news/post/"+this.meta.news_id)
},initPage:function(el){var self=this;this.wrapper=el;this.news_id=this.getMetaData("news_id");this._initBasic();
if(this.meta.canEdit){this._initMenus();this._initPostArea()}this._initActions();this._initLabels();this._initCommentForm();
if(this.meta.canEdit){if(this.meta.isValidating){this.validatingEdit=new DeskPRO.Agent.PageHelper.ValidatingEdit(this,{typename:"news",contentId:this.meta.news_id});
this.ownObject(this.validatingEdit)}this.getEl("edit_btn").on("click",this.showEditor.bind(this))}this.relatedContent=new DeskPRO.Agent.PageHelper.RelatedContent(this,{typename:"news",content_id:this.meta.news_id,listEl:$("section.linked-content:first",this.wrapper),disabled:!this.meta.canEdit,onContentLinked:function(typename,content_id){$.ajax({url:BASE_URL+"agent/news/post/"+self.meta.news_id+"/ajax-save",type:"POST",data:{content_type:typename,content_id:content_id,action:"add-related"},context:this,dataType:"json"})
},onContentUnlinked:function(typename,content_id){$.ajax({url:BASE_URL+"agent/news/post/"+self.meta.news_id+"/ajax-save",type:"POST",data:{content_type:typename,content_id:content_id,action:"add-related"},context:this,dataType:"json"})
}});this.ownObject(this.relatedContent);this.miscContent=new DeskPRO.Agent.PageHelper.MiscContent(this,{revisionCompareUrl:BASE_URL+"agent/news/compare-revs/{OLD}/{NEW}"});
this.ownObject(this.miscContent);this.whoVotedOverlay=new DeskPRO.UI.Overlay({triggerElement:".who-voted-trigger",contentMethod:"ajax",contentAjax:{url:BASE_URL+"agent/publish/rating-who-voted/news/"+this.meta.news_id}});
this.ownObject(this.whoVotedOverlay)},destroyPage:function(){var el=$(".news-editor-wrap",this.getEl("content_ed"));
if(el[0]){el.get(0).parentNode.removeChild(el.get(0))}},handleUnloadRevisions:function(revision_id){if(!revision_id){return
}if($(".rev-"+revision_id,this.getEl("revs")).length){return}this.getEl("revs").empty().removeClass("loaded");
DeskPRO_Window.util.modCountEl(this.getEl("count_revs"),"+")},_initBasic:function(){var self=this;this.bodyTabs=new DeskPRO.UI.SimpleTabs({triggerElements:$("li",this.getEl("bodytabs")),onTabSwitch:(function(info){if($(info.tabContent).is(".news-content")){self.getEl("content_edit_btns").show()
}else{self.getEl("content_edit_btns").hide()}if($(info.tabContent).is(".related-content-tab")){$("body").addClass("related-controls-on")
}else{if($(info.tabContent).is(".search-tab")){self._initSearchTab()}$("body").removeClass("related-controls-on")
}if($(info.tabContent).is(".revisions-tab")&&!$(info.tabContent).is(".loaded")){$.ajax({url:BASE_URL+"agent/news/post/"+this.meta.news_id+"/view-revisions",type:"GET",dataType:"html",context:self,success:function(html){this.getEl("revs").html(html);
this.miscContent._initCompareRevs();$(info.tabContent).addClass("loaded")}})}}).bind(this)});this.ownObject(this.bodyTabs);
if(this.meta.canEdit){var editTitle=new DeskPRO.Agent.PageFragment.Page.EditTitle(this,BASE_URL+"agent/news/post/"+this.meta.news_id+"/ajax-save")
}},_initMenus:function(){var self=this;var statusSel=this.getEl("status");DP.select(statusSel);statusSel.on("change",function(){var status=$(this).val();
self.getEl("auto_unpub").hide();self.getEl("auto_pub").hide();if(status=="published"){self.getEl("auto_unpub").show()
}else{if(status=="hidden.unpublished"){self.getEl("auto_pub").show()}}$.ajax({url:BASE_URL+"agent/news/post/"+self.meta.news_id+"/ajax-save",type:"POST",data:{action:"status",status:status},context:self,dataType:"json",success:function(){DeskPRO_Window.sections.publish_section.reload()
}})});this.deleteHelper=new DeskPRO.Agent.PageFragment.Page.Content.DeleteControl(this,{ajaxSaveUrl:BASE_URL+"agent/news/post/"+self.meta.news_id+"/ajax-save",statusMenu:this.statusMenu});
this.ownObject(this.deleteHelper);var catSel=this.getEl("cat");DP.select(catSel);catSel.on("change",function(){$.ajax({url:BASE_URL+"agent/news/post/"+self.meta.news_id+"/ajax-save",type:"POST",data:{action:"category",category_id:$(this).val()},dataType:"json",success:function(){DeskPRO_Window.sections.publish_section.reload()
}})})},_initActions:function(){var self=this;var actions=this.getEl("action_buttons");$(".delete",actions).on("click",function(){});
$(".permalink",actions).on("click",function(){var html=[];html.push("<div>");html.push("The permalink to this post on the website is:<br />");
html.push('<input type="text" style="width:80%;" />');html.push("</div>");var msg=$(html.join(""));$("input",msg).val(self.meta.permalink);
DeskPRO_Window.showAlert(msg)});$(".view-user-interface",actions).on("click",function(){window.open(self.meta.permalink)
})},_initLabels:function(){this.labelsInput=new DeskPRO.UI.LabelsInput({type:"news",input:this.getEl("labels_input"),onChange:this.saveLabels.bind(this)});
this.ownObject(this.labelsInput)},saveLabels:function(){if(this._saveLabelsTimeout){window.clearTimeout(this._saveLabelsTimeout)
}this._labelsData=this.labelsInput.getFormData();this._saveLabelsTimeout=this._doSaveLabels.delay(2000,this)
},_doSaveLabels:function(){var data=this._labelsData;$.ajax({url:this.getMetaData("labelsSaveUrl"),type:"POST",context:this,data:data,dataType:"json",success:function(data){this._handleSaveLabelsSuccess(data)
}})},_handleSaveLabelsSuccess:function(data){},_initSearchTab:function(){if(this.hasInitSearchTab){return
}this.hasInitSearchTab=true;this.stickyWords=new DeskPRO.Agent.PageFragment.Page.Content.StickyWords(this,{contentType:"news",contentId:this.meta.news_id,element:this.getEl("stickysearch_input")});
this.ownObject(this.stickyWords)},_initCommentForm:function(){this.commentsController=new DeskPRO.Agent.PageHelper.Comments(this,{commentsWrapper:this.getEl("comments_wrap")});
this.ownObject(this.commentsController);this.newCommentWrapper=$(".new-note:first",this.wrapper);$("button",this.newCommentWrapper).on("click",this.saveNewComment.bind(this))
},saveNewComment:function(){var loadingOn=$(".loading-on",this.newCommentWrapper).show();var loadingOff=$(".loading-off",this.newCommentWrapper).hide();
var data=[];data.push({name:"content",value:$("textarea",this.newCommentWrapper).val()});$.ajax({url:BASE_URL+"agent/news/post/"+this.getMetaData("news_id")+"/ajax-save-comment",type:"POST",context:this,data:data,dataType:"html",success:function(html){loadingOn.hide();
loadingOff.show();$("textarea",this.newCommentWrapper).val("");var el=$(html);this.newCommentWrapper.before(el);
DeskPRO_Window.util.modCountEl(this.getEl("count_comments"),"+");if(DeskPRO_Window.sections.publish_section){DeskPRO_Window.sections.publish_section.modCommentCount("news","+")
}}})},_initPostArea:function(){this._hasInitEd=false;this.getEl("cancel_btn").off("click").on("click",(function(){this.hideEditor();
if(!this.wrapper.find(".revert-default")[0]){var def=this.wrapper.find("textarea.edit-content-field-default").val();
this.wrapper.find("textarea.edit-content-field").val(def);if(this.rte){this.rte.val(def)}}}).bind(this));
var wrap=this.wrapper;if(this.editStateSaver){this.editStateSaver.destroy()}this.editStateSaver=new DeskPRO.Agent.PageHelper.StateSaver({stateId:"editarticle",listenOn:$(".news-editor-wrap:first",wrap)});
this.ownObject(this.editStateSaver);this.getEl("save_btn").off("click").on("click",(function(ev){ev.preventDefault();
var data={action:"content",content:$(".news-editor-wrap textarea:first",wrap).val(),attach:$(".news-editor-wrap .edit-content-attach:first",wrap).val()};
$.ajax({url:BASE_URL+"agent/news/post/"+this.meta.news_id+"/ajax-save",type:"POST",context:this,data:data,dataType:"json",success:function(data){this.getEl("content_ed").html(data.content_html);
this.handleUnloadRevisions(data.revision_id);this._initPostArea()}})}).bind(this));this.hideEditor()},showEditor:function(){var self=this;
var edWrap=$(".news-editor-wrap",this.getEl("content_ed")).show();$(".revert-default",edWrap).on("click",function(){var def=$("textarea.edit-content-field-default").val();
$("textarea.edit-content-field").val(def);$(".revert-message-notice",edWrap).remove()});$(".news-content-wrap",this.getEl("content_ed")).hide();
$(".news-editor-wrap",this.getEl("content_ed")).show();if(!this._hasInitEd){this._hasInitEd=true;var txt=$(".edit-content-field",this.getEl("content_ed"));
var w=$(txt.closest(".content-tab-item")).width()-30;if(this.wrapper.find("> .layout-content > .scrollbar.disabled")){var h=$(window).height()-90-txt.offset().top
}else{h=425}txt.css({width:w,height:h});DP.rteTextarea($(".edit-content-field",this.getEl("content_ed")),{setup:function(ed){ed.onKeyPress.add(function(){self.editStateSaver.triggerChange()
})}})}this.getEl("edit_btn").hide();this.getEl("save_btn").show();this.getEl("cancel_btn").show();this.updateUi()
},hideEditor:function(){this.getEl("edit_btn").show();this.getEl("save_btn").hide();this.getEl("cancel_btn").hide();
$(".news-editor-wrap",this.getEl("content_ed")).hide();$(".news-content-wrap",this.getEl("content_ed")).show();
this.updateUi()},_initMediaBrowser:function(){if(this.mediabrowser_has_init){return}this.mediabrowser_has_init=true;
this.mediaBrowserEl=$(".media-browser",this.wrapper);this.mediaBrowserOverlay=new DeskPRO.UI.Overlay({contentElement:this.mediaBrowserEl});
this.mediaBrowser=new DeskPRO.Agent.MediaBrowser({wrapper:this.mediaBrowserEl,additionalDropZone:$(".kb-editor > textarea",this.wrapper)})
},showMediaBrowser:function(){this._initMediaBrowser();this.mediaBrowserOverlay.openOverlay()},_initCompareRevs:function(){$(".compare-trigger",this.wrapper).on("click",this.showCompareRev.bind(this))
},showCompareRev:function(){var old_id=$(".reivisons input.old:checked",this.wrapper).val();var new_id=$(".revisions input.new:checked",this.wrapper).val();
if(!old_id||!new_id){return}var overlay=new DeskPRO.UI.Overlay({triggerElement:$("button.compare-trigger",this.wrapper),contentMethod:"ajax",contentAjax:{url:BASE_URL+"agent/news/compare-revs/"+old_id+"/"+new_id},destroyOnClose:true});
overlay.openOverlay()}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page");DeskPRO.Agent.PageFragment.Page.DownloadsView=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="download"},initMetaData:function(){DeskPRO_Window.recentTabs.add("download",this.meta.download_id,this.meta.title,BASE_URL+"agent/downloads/file/"+this.meta.download_id)
},initPage:function(el){var self=this;this.wrapper=el;this.download_id=this.getMetaData("download_id");
this._initBasic();this._initLabels();this._initCommentForm();this._initActions();if(this.meta.canEdit){this._initPostArea();
if(this.meta.isValidating){this.validatingEdit=new DeskPRO.Agent.PageHelper.ValidatingEdit(this,{typename:"downloads",contentId:this.meta.download_id});
this.ownObject(this.validatingEdit)}this.getEl("edit_btn").on("click",this.showEditor.bind(this))}$("time.timeago",this.wrapper).timeago();
this.relatedContent=new DeskPRO.Agent.PageHelper.RelatedContent(this,{typename:"downloads",content_id:this.meta.download_id,listEl:$("section.linked-content:first",this.wrapper),disabled:!this.meta.canEdit,onContentLinked:function(typename,content_id){$.ajax({url:BASE_URL+"agent/downloads/file/"+self.meta.download_id+"/ajax-save",type:"POST",data:{content_type:typename,content_id:content_id,action:"add-related"},context:this,dataType:"json"})
},onContentUnlinked:function(typename,content_id){$.ajax({url:BASE_URL+"agent/downloads/file/"+self.meta.download_id+"/ajax-save",type:"POST",data:{content_type:typename,content_id:content_id,action:"add-related"},context:this,dataType:"json"})
}});this.ownObject(this.relatedContent);this.miscContent=new DeskPRO.Agent.PageHelper.MiscContent(this,{revisionCompareUrl:BASE_URL+"agent/downloads/compare-revs/{OLD}/{NEW}"});
this.ownObject(this.miscContent);this.whoVotedOverlay=new DeskPRO.UI.Overlay({triggerElement:".who-voted-trigger",contentMethod:"ajax",contentAjax:{url:BASE_URL+"agent/publish/rating-who-voted/download/"+this.meta.download_id}});
this.ownObject(this.whoVotedOverlay);this.whoViewedOverlay=new DeskPRO.UI.Overlay({triggerElement:".open-who-viewed",contentMethod:"ajax",contentAjax:{url:BASE_URL+"agent/publish/who-viewed/2/"+this.meta.download_id}});
this.ownObject(this.whoViewedOverlay);this.whoDownloadedOverlay=new DeskPRO.UI.Overlay({triggerElement:".open-who-downloaded",contentMethod:"ajax",contentAjax:{url:BASE_URL+"agent/publish/who-viewed/2/"+this.meta.download_id+"/2"}});
this.ownObject(this.whoViewedOverlay);var editBtn=this.getEl("editfile_controls").find(".edit-trigger");
var cancelBtn=this.getEl("editfile_controls").find(".cancel-trigger");var saveBtn=this.getEl("editfile_controls").find(".save-trigger");
var loadingBtn=this.getEl("editfile_controls").find(".is-loading");var editArea=this.getEl("editfile");
var showArea=this.getEl("showfile");editBtn.on("click",function(ev){ev.preventDefault();editBtn.hide();
cancelBtn.show();saveBtn.show();showArea.hide();editArea.show();editArea.find(".file-list").empty()});
saveBtn.on("click",function(ev){ev.preventDefault();editBtn.hide();cancelBtn.hide();saveBtn.hide();var formData=editArea.find("input, select, textarea").serializeArray();
formData.push({name:"action",value:"file"});loadingBtn.show();$.ajax({url:BASE_URL+"agent/downloads/file/"+self.meta.download_id+"/ajax-save",data:formData,error:function(){loadingBtn.hide();
cancelBtn.show();saveBtn.show()},success:function(data){loadingBtn.hide();cancelBtn.hide();saveBtn.hide();
editBtn.show();self.handleUnloadRevisions(data.revision_id);editArea.hide();showArea.empty().html(data.file_html).show()
}})});cancelBtn.on("click",function(ev){ev.preventDefault();editBtn.show();cancelBtn.hide();saveBtn.hide();
editArea.hide();showArea.show()});var list=$(".file-list",editArea);if(list[0]){DeskPRO_Window.util.fileupload(editArea,{page:this});
this.wrapper.bind("fileuploadadd",function(){$("ul.file-list",editArea).empty()})}},handleUnloadRevisions:function(revision_id){if(!revision_id){return
}if($(".rev-"+revision_id,this.getEl("revs")).length){return}this.getEl("revs").empty().removeClass("loaded");
DeskPRO_Window.util.modCountEl(this.getEl("count_revs"),"+")},destroyPage:function(){var el=$(".download-editor-wrap",this.getEl("content_ed"));
if(el[0]){el.get(0).parentNode.removeChild(el.get(0))}},_initBasic:function(){var self=this;this.bodyTabs=new DeskPRO.UI.SimpleTabs({triggerElements:$("li",this.getEl("bodytabs")),onTabSwitch:(function(info){if($(info.tabContent).is(".dl-content")){self.getEl("content_edit_btns").show()
}else{self.getEl("content_edit_btns").hide()}if($(info.tabContent).is(".related-content-tab")){$("body").addClass("related-controls-on")
}else{if($(info.tabContent).is(".search-tab")){self._initSearchTab()}$("body").removeClass("related-controls-on");
$("body").addClass("related-controls-off")}if($(info.tabContent).is(".revisions-tab")&&!$(info.tabContent).is(".loaded")){$.ajax({url:BASE_URL+"agent/downloads/file/"+this.meta.download_id+"/view-revisions",type:"GET",dataType:"html",context:self,success:function(html){this.getEl("revs").html(html);
this.miscContent._initCompareRevs();$(info.tabContent).addClass("loaded")}})}}).bind(this)});this.ownObject(this.bodyTabs);
if(this.meta.canEdit){var name=$("h3.title.editable:first",this.wrapper);if(!name.attr("id")){name.attr("id",Orb.getUniqueId())
}var editable=new DeskPRO.Form.InlineEdit({baseElement:this.wrapper,ajax:{url:BASE_URL+"agent/downloads/file/"+this.meta.download_id+"/ajax-save",success:function(data){self.handleUnloadRevisions(data.revision_id)
}}});var catOb=new DeskPRO.UI.OptionBoxRevertable({trigger:this.getEl("cat_trigger"),element:this.getEl("cat_ob"),onSave:function(ob){var catEl=ob.getSelectedElements("category");
var catId=catEl.data("item-id");var title=catEl.data("full-title");self.getEl("cat_label").text(title);
$.ajax({url:BASE_URL+"agent/downloads/file/"+self.meta.download_id+"/ajax-save",type:"POST",data:{action:"category",category_id:catId},dataType:"json",success:function(){DeskPRO_Window.sections.publish_section.reload()
}})}});var trigger=$(".the-status:first",this.wrapper);this.statusMenu=new DeskPRO.UI.Menu({triggerElement:trigger,menuElement:$(".status-menu:first",this.wrapper),onItemClicked:function(info){var status=$(info.itemEl).data("option-value");
$(".download-status",trigger).attr("title",status);$(".download-status span",trigger).attr("class","").addClass("ticket-"+status.replace(/\./,"_"));
$.ajax({url:BASE_URL+"agent/downloads/file/"+self.meta.download_id+"/ajax-save",type:"POST",data:{action:"status",status:status},context:self,dataType:"json",success:function(){DeskPRO_Window.sections.publish_section.reload()
}})}});this.ownObject(this.statusMenu);this.deleteHelper=new DeskPRO.Agent.PageFragment.Page.Content.DeleteControl(this,{ajaxSaveUrl:BASE_URL+"agent/downloads/file/"+self.meta.download_id+"/ajax-save",statusMenu:this.statusMenu});
this.ownObject(this.deleteHelper)}},_initActions:function(){var self=this;var actions=this.getEl("action_buttons");
$(".delete",actions).on("click",function(){});$(".permalink",actions).on("click",function(){var html=[];
html.push("<div>");html.push("The permalink to this download on the website is:<br />");html.push('<input type="text" style="width:95%" />');
html.push("</div>");var msg=$(html.join(""));$("input",msg).val(self.meta.permalink);DeskPRO_Window.showAlert(msg)
});$(".view-user-interface",actions).on("click",function(){window.open(self.meta.permalink)})},_initLabels:function(){this.labelsInput=new DeskPRO.UI.LabelsInput({type:"downloads",input:this.getEl("labels_input"),onChange:this.saveLabels.bind(this)});
this.ownObject(this.labelsInput)},saveLabels:function(){if(this._saveLabelsTimeout){window.clearTimeout(this._saveLabelsTimeout)
}this._labelsData=this.labelsInput.getFormData();this._saveLabelsTimeout=this._doSaveLabels.delay(2000,this)
},_doSaveLabels:function(){var data=this._labelsData;$.ajax({url:this.getMetaData("labelsSaveUrl"),type:"POST",context:this,data:data,dataType:"json",success:function(data){this._handleSaveLabelsSuccess(data)
}})},_handleSaveLabelsSuccess:function(data){},_initSearchTab:function(){if(this.hasInitSearchTab){return
}this.hasInitSearchTab=true;this.stickyWords=new DeskPRO.Agent.PageFragment.Page.Content.StickyWords(this,{contentType:"download",contentId:this.meta.download_id,element:this.getEl("stickysearch_input")});
this.ownObject(this.stickyWords)},_initCommentForm:function(){this.commentsController=new DeskPRO.Agent.PageHelper.Comments(this,{commentsWrapper:this.getEl("comments_wrap")});
this.ownObject(this.commentsController);this.newCommentWrapper=$(".new-note:first",this.wrapper);$("button",this.newCommentWrapper).on("click",this.saveNewComment.bind(this))
},saveNewComment:function(){var loadingOn=$(".loading-on",this.newCommentWrapper).show();var loadingOff=$(".loading-off",this.newCommentWrapper).hide();
var data=[];data.push({name:"content",value:$("textarea",this.newCommentWrapper).val()});$.ajax({url:BASE_URL+"agent/downloads/file/"+this.getMetaData("download_id")+"/ajax-save-comment",type:"POST",context:this,data:data,dataType:"html",success:function(html){loadingOn.hide();
loadingOff.show();$("textarea",this.newCommentWrapper).val("");var el=$(html);this.newCommentWrapper.before(el);
DeskPRO_Window.util.modCountEl(this.getEl("count_comments"),"+");if(DeskPRO_Window.sections.publish_section){DeskPRO_Window.sections.publish_section.modCommentCount("downloads","+")
}}})},_initPostArea:function(){this._hasInitEd=false;this.getEl("cancel_btn").off("click").on("click",(function(){this.hideEditor();
if(!this.wrapper.find(".revert-default")[0]){var def=this.wrapper.find("textarea.edit-content-field-default").val();
this.wrapper.find("textarea.edit-content-field").val(def);if(this.rte){this.rte.val(def)}}}).bind(this));
var wrap=this.wrapper;if(this.editStateSaver){this.editStateSaver.destroy()}this.editStateSaver=new DeskPRO.Agent.PageHelper.StateSaver({stateId:"editdownload",listenOn:$(".download-editor-wrap:first",wrap)});
this.ownObject(this.editStateSaver);this.getEl("save_btn").off("click").on("click",(function(ev){ev.preventDefault();
var data={action:"content",content:$(".download-editor-wrap textarea:first",wrap).val(),attach:$(".download-editor-wrap .edit-content-attach:first",wrap).val()};
$.ajax({url:BASE_URL+"agent/downloads/file/"+this.meta.download_id+"/ajax-save",type:"POST",context:this,data:data,dataType:"json",success:function(data){this.getEl("content_ed").html(data.content_html);
this.handleUnloadRevisions(data.revision_id);this._initPostArea()}})}).bind(this));this.hideEditor()},showEditor:function(){var self=this;
var edWrap=$(".download-editor-wrap",this.getEl("content_ed")).show();$(".revert-default",edWrap).on("click",function(){var def=$("textarea.edit-content-field-default").val();
$("textarea.edit-content-field").val(def);$(".revert-message-notice",edWrap).remove()});$(".download-content-wrap",this.getEl("content_ed")).hide();
$(".download-editor-wrap",this.getEl("content_ed")).show();if(!this._hasInitEd){this._hasInitEd=true;
var txt=$(".edit-content-field",this.getEl("content_ed"));var w=$(txt.closest(".content-tab-item")).width()-30;
if(this.wrapper.find("> .layout-content > .scrollbar.disabled")){var h=$(window).height()-90-txt.offset().top
}else{h=425}txt.css({width:w,height:h});DP.rteTextarea(txt,{setup:function(ed){ed.onKeyPress.add(function(){self.editStateSaver.triggerChange()
})}});this._hasInitEdBefore=true}this.getEl("edit_btn").hide();this.getEl("save_btn").show();this.getEl("cancel_btn").show();
this.updateUi()},hideEditor:function(){$(".download-editor-wrap",this.getEl("content_ed")).hide();$(".download-content-wrap",this.getEl("content_ed")).show();
this.getEl("edit_btn").show();this.getEl("save_btn").hide();this.getEl("cancel_btn").hide();this.updateUi()
}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page");DeskPRO.Agent.PageFragment.Page.NewTask=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="newtask"},initPage:function(el){this.noIgnoreForm=true;var self=this;this.wrapper=el;var nolink=false;
this.addEvent("popover-open",function(){nolink=false;rowContainer.empty();addTaskRow()});var statusMenu=new DeskPRO.UI.Menu({menuElement:this.getEl("menu_vis"),onItemClicked:function(info){$("input.input-vis",openForEl).val($(info.itemEl).data("vis"));
$(".opt-trigger.visibility label",openForEl).text($(info.itemEl).text())}});var form=this.getEl("form");
form.on("submit",Orb.cancelEvent);var rowContainer=this.getEl("tasks");var openForEl=null;rowContainer.on("click",".remove-row-trigger",function(ev){var row=$(this).closest(".task-row");
row.slideUp("fast",function(){row.remove();self.updateUi()})});rowContainer.on("click",".opt-trigger.visibility",function(ev){openForEl=$(this).closest(".task-row");
statusMenu.open(ev)});rowContainer.on("click",".opt-trigger.date_due",function(ev){var label=$("label",this);
var row=$(this).closest(".task-row");var field=$("input.input-date-due",row);var date=$("input.input-date-due",row).val();
if(!date){date=new Date()}field.datepicker("dialog",date,function(date,inst){$("input.input-date-due",row).val(date);
label.text(date)},{dateFormat:"yy-mm-dd",showButtonPanel:true,beforeShow:function(input){setTimeout(function(){var buttonPane=$(input).datepicker("widget").find(".ui-datepicker-buttonpane");
$("button",buttonPane).remove();var btn=$('<button class="ui-datepicker-current ui-state-default ui-priority-secondary ui-corner-all" type="button">Clear</button>');
btn.unbind("click").bind("click",function(){$.datepicker._clearDate(input);label.text("No due date")});
btn.appendTo(buttonPane);$(input).datepicker("widget").css("z-index",30101)},1)}},ev)});var addTaskRow=function(){var tpl=DeskPRO_Window.util.getPlainTpl(self.getEl("task_row_tpl"));
var row=$(tpl);if(!nolink){var activeTab=DeskPRO_Window.getTabWatcher().getActiveTabIfType("ticket");
if(activeTab){var linkEl=$(".linked-ticket",row);$("label",linkEl).text(activeTab.page.meta.title);$("input.input-ticket-id",row).val(activeTab.page.meta.ticket_id);
linkEl.show();$(".remove-link-trigger",row).on("click",function(){nolink=true;linkEl.hide();$("input.input-ticket-id",row).val(0);
$(".linked-container",row).hide()})}activeTab=DeskPRO_Window.getTabWatcher().getActiveTabIfType("deal");
if(activeTab){linkEl=$(".linked-deal",row);$("label",linkEl).text(activeTab.page.meta.title);$("input.input-deal-id",row).val(activeTab.page.meta.deal_id);
linkEl.show();$(".remove-link-trigger",row).on("click",function(){nolink=true;linkEl.hide();$("input.input-ticket-id",row).val(0);
$(".linked-container",row).hide()})}if(linkEl){$(".linked-container",row).show()}}rowContainer.append(row);
var agent_sel=row.find(".agents_sel");DP.select(agent_sel);agent_sel.on("change",function(){var val=$(this).val();
var label=$(this).find(":selected").text().trim();if(!val){val="";label="Me"}row.find(".assigned_agent").find("label").text(label);
$("input.input-agent",row).val(val)});self.updateUi()};this.getEl("add_btn").on("click",addTaskRow);addTaskRow();
var footer=$("footer.pop-footer",el);$(".submit-trigger",el).on("click",function(){var postData=form.serializeArray();
footer.addClass("loading");$.ajax({url:form.attr("action"),type:"POST",dataType:"json",data:postData,complete:function(){footer.removeClass("loading")
},success:function(data){self.meta.popover.close();if(DeskPRO_Window.sections.tasks_section){DeskPRO_Window.sections.tasks_section.refresh()
}}})});this.addEvent("popover-closed",function(){rowContainer.empty();addTaskRow()})}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page");
DeskPRO.Agent.PageFragment.Page.NewTweet=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="newtweet";this.allowDupe=true},initPage:function(el){this.noIgnoreForm=true;var self=this;
this.wrapper=el;var helper=new DeskPRO.Agent.PageHelper.Twitter(this.wrapper,this);var textarea=this.wrapper.find("textarea");
textarea.TextAreaExpander();if(this.getMetaData("tweetSignature")){textarea.val(" "+this.getMetaData("tweetSignature"));
helper.updateTweetLength(textarea)}textarea.focus();DP.select(this.getEl("from_account"));var form=this.getEl("form");
form.on("submit",Orb.cancelEvent);var footer=$("footer.pop-footer",el);$(".submit-trigger",el).on("click",function(){var postData=form.serializeArray();
footer.addClass("loading");$.ajax({url:form.attr("action"),type:"POST",dataType:"json",data:postData,complete:function(){footer.removeClass("loading")
},success:function(data){self.meta.popover.close();if(DeskPRO_Window.sections.twitter_section){DeskPRO_Window.sections.twitter_section.refresh()
}}})})},markForReload:function(){if(!this.markedForReload){this.markedForReload=true;this.addEvent("deactivate",this.closeSelf.bind(this))
}},closeSelf:function(){var ev={cancel:false};this.fireEvent("closeSelf",ev);if(!ev.cancel){this.parent()
}}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page");DeskPRO.Agent.PageFragment.Page.Test=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.allowDupe=true;this.TYPENAME="test"},initPage:function(el){var self=this;$(el).on("click",function(){window.setTimeout(function(){self.alertTab()
},3000)})}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page");DeskPRO.Agent.PageFragment.Page.Deal=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.allowDupe=true;this.TYPENAME="deal"},initPage:function(el){var self=this;this.wrapper=el;this._initLabels();
this._initDisplayOptions();this._initAgentSection();this._initAssignPersonSection();this._initAssignOrganizationSection();
this._initUserSection();this._initOrgEdit();this._initAssignAgentSection();this._removePersonAndOrg();
this._initStatusMenus();this._initCustomField();this.relatedContent=new DeskPRO.Agent.PageHelper.RelatedContent(this,{typename:"deals",content_id:this.meta.deal_id,listEl:$("section.linked-content:first",this.wrapper),onContentLinked:function(typename,content_id){$.ajax({url:BASE_URL+"agent/deals/"+self.meta.deal_id+"/ajax-save",type:"POST",data:{content_type:typename,content_id:content_id,action:"add-related"},context:this,dataType:"json"})
},onContentUnlinked:function(typename,content_id){$.ajax({url:BASE_URL+"agent/deals/"+self.meta.deal_id+"/ajax-save",type:"POST",data:{content_type:typename,content_id:content_id,action:"remove-related"},context:this,dataType:"json"})
}});this.ownObject(this.relatedContent);$(".create_deal_task_btn").on("click",function(){$("form#newTaskForm input, form#newTaskForm select").val("");
DeskPRO_Window.newTaskLoader.toggle()});var name=$("h3.name.editable:first",el);if(!name.attr("id")){name.attr("id",Orb.getUniqueId())
}var editable=new DeskPRO.Form.InlineEdit({baseElement:this.wrapper,ajax:{url:BASE_URL+"agent/deals/"+this.meta.deal_id+"/ajax-save"},triggers:".edit-name-gear"});
$(this.wrapper).on("click",function(ev){editable.handleDocumentClick(ev)});$(".profile-box-container.tabbed",this.wrapper).each(function(){var simpleTabs=new DeskPRO.UI.SimpleTabs({triggerElements:"> header li",context:this});
self.ownObject(simpleTabs)});var curncyMenu=new DeskPRO.UI.Menu({menuElement:this.getEl("currency")});
this.ownObject(curncyMenu);var dltypeMenu=new DeskPRO.UI.Menu({menuElement:this.getEl("select_deal_type")});
this.ownObject(dltypeMenu);var dlstgMenu=new DeskPRO.UI.Menu({menuElement:this.getEl("select_deal_stage")});
this.ownObject(dlstgMenu);this.getEl("currency").on("change",function(){var val=$(this).val();$.ajax({url:BASE_URL+"agent/deals/"+dealId+"/ajax-save",type:"POST",dataType:"json",data:{action:"change_deal_currency",deal_currency:val},context:this,success:function(data){}})
});this.getEl("select_deal_type").on("change",function(){var dealId=self.meta.deal_id;if(!dealId){return
}$.ajax({url:BASE_URL+"agent/deals/"+dealId+"/ajax-save",data:{action:"change-dealtype",deal_type_id:$(this).val()},type:"POST",context:this,error:function(){},success:function(data){$(".set-deal-stage").html(data.deal_stage);
var dlstgDyMenu=new DeskPRO.UI.Menu({menuElement:this.getEl("select_deal_stage")});this.ownObject(dlstgDyMenu);
DeskPRO_Window.sections.deals_section.refresh()}})});$(".select-deal-stage").live("change",function(){var dealId=self.meta.deal_id;
if(!dealId){return}$.ajax({url:BASE_URL+"agent/deals/"+dealId+"/ajax-save",data:{action:"change-dealstage",deal_stage_id:$(this).val()},type:"POST",context:this,error:function(){},success:function(data){}})
})},_removePersonAndOrg:function(){this.getEl("members_list").on("click",".remove",function(){var row=$(this).closest(".member-row");
var personId=row.data("person-id");if(!personId){return}row.fadeOut("fast");$.ajax({url:BASE_URL+"agent/deals/"+self.meta.deal_id+"/ajax-save",data:{action:"remove-person",person_id:personId},type:"POST",context:this,error:function(){row.show()
},success:function(){row.remove();DeskPRO_Window.util.modCountEl(self.getEl("members_count"),"-");DeskPRO_Window.sections.deals_section.refresh()
}})});this.getEl("organizations_list").on("click",".remove",function(){var row=$(this).closest(".organization-row");
var organizationId=row.data("organization-id");if(!organizationId){return}row.fadeOut("fast");$.ajax({url:BASE_URL+"agent/deals/"+self.meta.deal_id+"/ajax-save",data:{action:"remove-organization",organization_id:organizationId},type:"POST",context:this,error:function(){row.show()
},success:function(){row.remove();DeskPRO_Window.util.modCountEl(self.getEl("members_count"),"-");DeskPRO_Window.sections.deals_section.refresh()
}})})},_initDisplayOptions:function(){this.displayOptionsList=$(".display-options:first ul.sortable-list",this.contentWrapper);
var overlay_wrapper=this.displayOptionsWrapper=$(".display-options:first",this.contentWrapper);this.displayOptionsOverlay=new DeskPRO.UI.Overlay({contentElement:overlay_wrapper,triggerElement:$(".display-options-trigger",this.contentWrapper),onContentSet:function(eventData){$("ul.sortable-list",eventData.wrapperEl).sortable({"axis":"y"})
}});this.ownObject(this.displayOptionsOverlay)},_initAssignAgentSection:function(){var el=this.getEl("agent_assign_ob");
this.assignOptionBox=new DeskPRO.UI.OptionBoxRevertable({element:el,trigger:this.getEl("assign_ob_trigger"),onSave:function(ob){var selections=ob.getAllSelected();
var agent_id=parseInt(selections.agents||0);var postData=[];postData.push({name:"agent_part_ids[]",value:selections.agents});
var label=$(".agent-label-"+agent_id,ob.getElement()).first().text().trim();var value=selections.agents;
var el=$(".prop-agent-id");if(value=="0"){value=0}if(value==0){el.text("Unassigned");el.css("background-image","")
}else{var agentInfo=DeskPRO_Window.getAgentInfo(value);el.text(label);el.css("background-image",agentInfo.pictureUrlSizable.replace("{SIZE}",20))
}$(".reply-agent-team-ob").slideUp();$.ajax({url:BASE_URL+"agent/deals/"+self.meta.deal_id+"/"+selections.agents+"/set-agent-parts.json",type:"POST",dataType:"json",data:postData,success:function(data){DeskPRO_Window.sections.deals_section.refresh()
}})}})},_initAgentSection:function(){var self=this;var obEl=this.getEl("agent_assign_ob");this.assignAgentOptionBox=new DeskPRO.UI.OptionBox({element:obEl,trigger:this.getEl("assign_btn"),onClose:function(ob){var selections=ob.getAllSelected();
var agent_id=parseInt(selections.agents||0);self.getEl("agent_id").val(agent_id);var label=$(".agent-label-"+agent_id,obEl).text().trim();
self.getEl("agent_label").text(label)}})},_initLabels:function(){this.labelsInput=new DeskPRO.UI.LabelsInput({type:"deal",textarea:$(".deal-tags input",this.wrapper),onChange:this.saveLabels.bind(this)});
this.ownObject(this.labelsInput)},saveLabels:function(){if(this._saveLabelsTimeout){window.clearTimeout(this._saveLabelsTimeout)
}this._labelsData=this.labelsInput.getFormData();this._saveLabelsTimeout=this._doSaveLabels.delay(2000,this)
},_doSaveLabels:function(){var data=this._labelsData;$.ajax({url:this.getMetaData("labelsSaveUrl"),type:"POST",context:this,data:data,dataType:"json",success:function(data){}})
},_initAssignPersonSection:function(){var newrow=$("li.newpersonrow",this.el);newrow.on("click",function(){$(".choose-user").toggle();
$(".add-new-user-container").remove()})},_initAssignOrganizationSection:function(){var newrow=$("li.neworgrow",this.el);
newrow.on("click",function(){$(".choose-org").toggle();$(".add-new-org-container").remove()})},_initUserSection:function(){var self=this;
var searchbox=this.getEl("user_searchbox");var userfields=this.getEl("user_choice");var rechooseBtn=this.getEl("switch_user");
var placeUserRow=function(html){self.placeUserRow(html)};searchbox.bind("personsearchboxclick",function(ev,personId,name,email,sb){$.ajax({type:"GET",url:BASE_URL+"agent/deals/new/set-person-row/"+personId,dataType:"html",data:{"deal_id":self.meta.deal_id},context:this,success:function(html){$("input.person-id",searchbox).val(personId);
placeUserRow(html)}});sb.close();sb.reset()});searchbox.bind("personsearchboxclicknew personsearchenter",function(ev,term,sb){$.ajax({type:"GET",url:BASE_URL+"agent/deals/new/create-person-row/0",data:{"email":term},dataType:"html",context:this,success:function(html){placeUserRow(html);
if(term.indexOf("@")!==-1){$("input.email",userfields).val(term)}else{$("input.name",userfields).val(term)
}}});sb.close();sb.reset();$(".save-trigger").live("click",function(){$.ajax({type:"GET",url:BASE_URL+"agent/deals/new/set-person-row/0",data:{"email":$(".add-new-user-container input.email").val(),"name":$(".add-new-user-container input.name").val(),"deal_id":self.meta.deal_id},dataType:"html",context:this,success:function(html){$(".add-new-user-container").remove();
placeUserRow(html)}});return false});$(".cancel-trigger").live("click",function(){$(".add-new-user-container").remove()
})})},placeUserRow:function(html){var searchbox=this.getEl("user_searchbox");var userfields=this.getEl("user_choice");
var newrow=$("li.newpersonrow",this.el);var chooseuser=$(".choose-user");var row=$(html);row.insertBefore(newrow);
userfields.empty();chooseuser.hide();userfields.show()},_initOrgEdit:function(){var self=this;var searchbox=this.getEl("org_searchbox");
var orgfields=this.getEl("org_choice");var rechooseBtn=this.getEl("switch_org");rechooseBtn.click(function(){showOrganizationChoice();
$(".org-id").val(0);return false});var showOrganizationChoice=function(){orgfields.empty();orgfields.hide();
searchbox.show();rechooseBtn.hide()};var placeOrganizationRow=function(html){self.placeOrganizationRow(html)
};var orgEdit=this.getEl("org_edit_wrap");this.getEl("org_searchbox").bind("orgsearchboxclick",function(ev,orgId,name){$(".org-id",self.getEl("org_edit_wrap")).val().trim();
$.ajax({type:"POST",url:BASE_URL+"agent/deals/new/set-organization-row/"+orgId,dataType:"html",data:{"deal_id":self.meta.deal_id},context:this,success:function(html){placeOrganizationRow(html);
$("input.organization_name",orgfields).val(term);self.El("orgselect").val("")}})}).bind("orgsearchboxcreate",function(ev,term,name){$.ajax({type:"GET",url:BASE_URL+"agent/deals/new/create-organization-row/0",dataType:"html",context:this,success:function(html){placeOrganizationRow(html);
$("input.organization_name",orgfields).val(term)}})}).bind("orgsearchreverted",function(ev,term,name){});
$(".save-org-trigger").live("click",function(){$.ajax({type:"POST",url:BASE_URL+"agent/deals/new/set-organization-row/0",dataType:"html",data:{"name":$(".add-new-org-container input.name").val(),"deal_id":self.meta.deal_id},context:this,success:function(html){placeOrganizationRow(html);
$(".add-new-org-container").remove()}})});$(".cancel-org-trigger").live("click",function(){$(".add-new-org-container").remove()
})},placeOrganizationRow:function(html){var searchbox=this.getEl("org_searchbox");var orgfields=this.getEl("org_choice");
var newrow=$("li.neworgrow",this.el);var chooseorg=$(".choose-org");var row=$(html);row.insertBefore(newrow);
chooseorg.hide();orgfields.show()},_initStatusMenus:function(){var self=this;var statusOb=new DeskPRO.UI.OptionBoxRevertable({trigger:this.getEl("status_trigger"),element:this.getEl("status_ob"),onSave:function(ob){var catEl=ob.getSelectedElements("status");
var catId=catEl.data("item-id");var title=catEl.data("full-title");self.getEl("status_label").text(title);
$.ajax({url:BASE_URL+"agent/deals/"+self.meta.deal_id+"/ajax-save",type:"POST",data:{action:"change-status",status:catId},context:self,dataType:"json",success:function(data){DeskPRO_Window.sections.deals_section.refresh()
}})}});var visibilityOb=new DeskPRO.UI.OptionBoxRevertable({trigger:this.getEl("visibility_trigger"),element:this.getEl("visibility_ob"),onSave:function(ob){var catEl=ob.getSelectedElements("visibility");
var catId=catEl.data("item-id");var title=catEl.data("full-title");self.getEl("visibility_label").text(title);
$.ajax({url:BASE_URL+"agent/deals/"+self.meta.deal_id+"/ajax-save",type:"POST",data:{action:"change-visibility",visibility:catId},context:self,dataType:"json",success:function(data){DeskPRO_Window.sections.deals_section.refresh()
}})}})},_initCustomField:function(){var fieldsRendered=this.getEl("custom_fields_rendered");var fieldsForm=this.getEl("custom_fields_editable");
var buttonsWrap=this.getEl("properties_controls");var propToggle=function(what){if(what=="display"){$(".showing-editing-fields",buttonsWrap).hide();
$(".showing-rendered-fields",buttonsWrap).show();fieldsForm.hide();fieldsRendered.show()}else{$(".showing-rendered-fields",buttonsWrap).hide();
$(".showing-editing-fields",buttonsWrap).show();fieldsRendered.hide();fieldsForm.show()}};$(".edit-fields-trigger",buttonsWrap).on("click",function(){propToggle("edit")
});$(".save-fields-trigger",buttonsWrap).on("click",function(){var formData=$('input[type="text"], input[type="password"], input:checked, select, textarea',fieldsForm);
$.ajax({url:BASE_URL+"agent/deals/"+self.meta.deal_id+"/ajax-save-custom-fields",type:"POST",data:formData,dataType:"html",success:function(rendered){fieldsRendered.empty().html(rendered);
propToggle("display")}})})}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page");DeskPRO.Agent.PageFragment.Page.NewDeal=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="newdeal";this.allowDupe=true},initPage:function(el){this.wrapper=el;this.contentWrapper=this.wrapper.children(".layout-content").attr("id",Orb.getUniqueId());
this.parent(el);this.form=$("form",this.wrapper).submit(function(ev){ev.preventDefault()});this._initDepartmentSection();
this._initUserSection();this._initOrgEdit();this._initOtherSection();var visiMenu=new DeskPRO.UI.Menu({menuElement:this.getEl("visibility")});
this.ownObject(visiMenu);$("button.submit-trigger",this.wrapper).on("click",this.submit.bind(this));$(".select-deal-type").on("change",function(){var dealId=0;
$.ajax({url:BASE_URL+"agent/deals/"+dealId+"/ajax-save",data:{action:"change-dealtype",deal_type_id:$(this).val()},type:"POST",context:this,error:function(){},success:function(data){$(".set-deal-stage").html(data.deal_stage)
}})})},closeSelf:function(){var ev={cancel:false};this.fireEvent("closeSelf",ev);if(!ev.cancel){this.parent()
}},submit:function(){var formData=this.form.serializeArray();$.ajax({url:BASE_URL+"agent/deals/new/save",type:"POST",data:formData,dataType:"json",context:this,success:function(data){if(data.success){DeskPRO_Window.runPageRoute("page:"+BASE_URL+"agent/deal/"+data.deal_id);
DeskPRO_Window.sections.deals_section.refresh();this.closeSelf()}else{alert("There was an error with the form")
}}})},_initDepartmentSection:function(){var self=this;var el=this.getEl("agent_assign_ob");this.assignOptionBox=new DeskPRO.UI.OptionBoxRevertable({element:el,trigger:this.getEl("assign_btn"),onSave:function(ob){var selections=ob.getAllSelected();
var agent_id=parseInt(selections.agents||0);var label=$(".agent-label-"+agent_id,ob.getElement()).first().text().trim();
var value=selections.agents;if(value==0){label="Unassigned"}self.getEl("agent_id").val(agent_id);self.getEl("agent_label").text(label);
$(".reply-agent-team-ob").slideUp()}})},_initUserSection:function(){var self=this;var searchbox=this.getEl("user_searchbox");
var userfields=this.getEl("user_choice");var rechooseBtn=this.getEl("switch_user");rechooseBtn.click(function(){showUserChoice();
return false});var showUserChoice=function(){userfields.empty();userfields.hide();searchbox.show();rechooseBtn.hide()
};var placeUserRow=function(html){self.placeUserRow(html)};searchbox.bind("personsearchboxclick",function(ev,personId,name,email,sb){$.ajax({type:"GET",url:BASE_URL+"agent/deals/new/get-person-row/"+personId,dataType:"html",context:this,success:function(html){$("input.person-id",searchbox).val(personId);
placeUserRow(html)}});sb.close();sb.reset()});searchbox.bind("personsearchboxclicknew personsearchenter",function(ev,term,sb){$.ajax({type:"GET",url:BASE_URL+"agent/deals/new/get-person-row/0",data:{"email":term},dataType:"html",context:this,success:function(html){placeUserRow(html);
if(term.indexOf("@")!==-1){$("input.email",userfields).val(term)}else{$("input.name",userfields).val(term)
}}});sb.close();sb.reset()})},placeUserRow:function(html){var searchbox=this.getEl("user_searchbox");
var userfields=this.getEl("user_choice");var rechooseBtn=this.getEl("switch_user");userfields.empty();
userfields.html(html);rechooseBtn.show();searchbox.hide();userfields.show()},_initOrgEdit:function(){var self=this;
var searchbox=this.getEl("org_searchbox");var orgfields=this.getEl("org_choice");var rechooseBtn=this.getEl("switch_org");
rechooseBtn.click(function(){showOrganizationChoice();$(".org-id").val(0);return false});var showOrganizationChoice=function(){orgfields.empty();
orgfields.hide();searchbox.show();rechooseBtn.hide()};var placeOrganizationRow=function(html){self.placeOrganizationRow(html)
};var orgEdit=this.getEl("org_edit_wrap");this.getEl("org_searchbox").bind("orgsearchboxclick",function(ev,orgId,name){$(".org-id",self.getEl("org_edit_wrap")).val().trim()
}).bind("orgsearchboxcreate",function(ev,term,name){$.ajax({type:"GET",url:BASE_URL+"agent/deals/new/get-organization-row/0",dataType:"html",context:this,success:function(html){placeOrganizationRow(html);
$("input.organization_name",orgfields).val(term)}})}).bind("orgsearchreverted",function(ev,term,name){})
},placeOrganizationRow:function(html){var searchbox=this.getEl("org_searchbox");var orgfields=this.getEl("org_choice");
var rechooseBtn=this.getEl("switch_org");orgfields.empty();orgfields.html(html);rechooseBtn.show();searchbox.hide();
orgfields.show()},_initOtherSection:function(){this.otherTabs=new DeskPRO.UI.SimpleTabs({triggerElements:$("li",this.getEl("other_props_tabs")),context:this.getEl("other_props_tabs_content"),autoSelectFirst:false,onTabClick:(function(ev){var contentWrap=this.getEl("other_props_tabs_content");
var navWrap=this.getEl("other_props_tabs_wrap");var tab=ev.tabEl;if(!$(".on",navWrap).length||tab.is(".on")){if(contentWrap.is(":visible")){contentWrap.hide();
navWrap.removeClass("on")}else{contentWrap.show();navWrap.addClass("on")}}}).bind(this)});this.ownObject(this.otherTabs);
var list=$(".file-list",this.wrapper);$("input",list[0]).live("click",function(){var el=$(this);var li=el.parent();
if(el.is(":checked")){li.removeClass("unchecked")}else{li.addClass("unchecked")}});DeskPRO_Window.util.fileupload(this.wrapper,{page:this})
}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page");DeskPRO.Agent.PageFragment.Page.TwitterUser=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="twitter-user"},initPage:function(el){this.el=$(el);var self=this;this.el.on("click",".follow-button",function(e){e.preventDefault();
$(this).addClass("unfollow-button").removeClass("follow-button");$(this).find(".clean-white").text("Unfollow");
$.ajax({url:self.getMetaData("saveFollowUrl"),type:"POST",data:{user_id:self.getMetaData("userId"),account_id:self.getMetaData("accountId")}})
});this.el.on("click",".unfollow-button",function(e){e.preventDefault();$(this).addClass("follow-button").removeClass("unfollow-button");
$(this).find(".clean-white").text("Follow");$.ajax({url:self.getMetaData("saveUnfollowUrl"),type:"POST",data:{user_id:self.getMetaData("userId"),account_id:self.getMetaData("accountId")}})
});var switchAccountMenu=new DeskPRO.UI.Menu({triggerElement:this.getEl("switch_account_trigger"),menuElement:this.getEl("switch_account_menu"),onItemClicked:function(info){var loadRoute=$(info.itemEl).data("load-route");
switchAccountMenu.close();DeskPRO_Window.removePage(self);DeskPRO_Window.runPageRoute("page:"+loadRoute)
}});this.el.on("click",".send-message-button",function(e){e.preventDefault();var overlay=new DeskPRO.UI.Overlay({contentMethod:"ajax",contentAjax:{url:BASE_URL+"agent/twitter/user/"+self.getMetaData("userId")+"/message-overlay"},zIndex:40000,onAjaxDone:function(){var wrapper=overlay.getWrapper();
var textarea=wrapper.find("textarea[name=text]");var helper=new DeskPRO.Agent.PageHelper.Twitter(wrapper,self,{saveMessageCallback:function(data){wrapper.addClass("loading");
$.ajax({url:self.getMetaData("saveUserMessageUrl"),type:"POST",data:data,dataType:"json"}).done(function(data){if(data.success){overlay.close()
}else{if(data.error){alert(data.error)}}}).always(function(){wrapper.removeClass("loading")})}});helper.updateTweetLength(textarea);
textarea.focus()}});overlay.open()});this.getEl("user_searchbox").on("personsearchboxclick",function(e,personId,name,email,obj){obj.close();
self.getEl("userselect").val("");$.ajax({url:self.getMetaData("saveUserPersonUrl"),data:{user_id:self.getMetaData("userId"),person_id:personId},type:"POST",dataType:"json",success:function(json){if(json.success){self.getEl("choose_user").before(json.html)
}}})});this.getEl("org_searchbox").on("orgsearchboxclick",function(e,orgId,name,obj){obj.close();self.getEl("orgselect").val("");
$.ajax({url:self.getMetaData("saveUserOrganizationUrl"),data:{user_id:self.getMetaData("userId"),organization_id:orgId},type:"POST",dataType:"json",success:function(json){if(json.success){self.getEl("org_edit_wrap").before(json.html)
}}})});$(".profile-box-container.tabbed",this.wrapper).each(function(){var simpleTabs=new DeskPRO.UI.SimpleTabs({triggerElements:"> header li",context:this})
});var statusesLoadPending=false;var statusesTab=self.getEl("statuses_tab");statusesTab.on("click",".more-box .more-button",function(){if(statusesLoadPending){return
}statusesLoadPending=true;statusesTab.find(".more-box .flat-spinner").show();$.ajax({url:$(this).data("load-url"),success:function(html){statusesTab.find(".more-box").remove();
statusesTab.append(html)},complete:function(){statusesTab.find(".more-box .flat-spinner").hide();statusesLoadPending=false
}})});var followingLoadPending=false;var followingTab=self.getEl("following_tab");followingTab.on("click",".more-box .more-button",function(){if(followingLoadPending){return
}followingLoadPending=true;followingTab.find(".more-box .flat-spinner").show();$.ajax({url:$(this).data("load-url"),success:function(html){followingTab.find(".more-box").remove();
followingTab.append(html)},complete:function(){followingTab.find(".more-box .flat-spinner").hide();followingLoadPending=false
}})});var followersLoadPending=false;var followersTab=self.getEl("followers_tab");followersTab.on("click",".more-box .more-button",function(){if(followersLoadPending){return
}followersLoadPending=true;followersTab.find(".more-box .flat-spinner").show();$.ajax({url:$(this).data("load-url"),success:function(html){followersTab.find(".more-box").remove();
followersTab.append(html)},complete:function(){followersTab.find(".more-box .flat-spinner").hide();followersLoadPending=false
}})});$(".timeago",this.el).timeago();this.twitterHelper=new DeskPRO.Agent.PageHelper.Twitter(this.el,this)
}});Orb.createNamespace("DeskPRO.Agent.PageFragment.Page");DeskPRO.Agent.PageFragment.Page.TwitterStatusOverlay=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="twitter-status-overlay"},initPage:function(el){this.el=$(el);DeskPRO_Window.initInterfaceLayerEvents(this.el);
this.twitterHelper=new DeskPRO.Agent.PageHelper.Twitter(this.el,this)}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");
DeskPRO.Agent.PageFragment.ListPane.Basic=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.Basic,initialize:function(html){this.parent(html);
this.addEvent("activate",function(){DeskPRO_Window.updateWindowUrlFragment();DeskPRO_Window.getMessageBroker().sendMessage("list-page-fragment.activated",{page:this})
},this)},enableHighlightOpenRows:function(tabtype,id_property,css_prefix){this.addEvent("watchedTabAdded",function(tab){$(css_prefix+tab.page.meta[id_property],this.wrapper||this.el).addClass("open")
});this.addEvent("watchedTabRemoved",function(tab){$(css_prefix+tab.page.meta[id_property],this.wrapper||this.el).removeClass("open")
});DeskPRO_Window.getTabWatcher().addTabTypeWatcher(tabtype,this,true)}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");
DeskPRO.Agent.PageFragment.ListPane.BasicTicketResults=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.Basic,initializeProperties:function(){this.parent();
this.wrapper=null;this.contentWrapper=null;this.layout=null;this.overlay=null;this.appendUrl=null;this.resultTypeName="basic";
this.resultTypeId="general"},initPage:function(el){var self=this;this.autoAddAjax={};this.wrapper=$(el);
if(this.meta.filter_id){DeskPRO_Window.sections.tickets_section.highlightFilterNav(this.meta.filter_id,this.meta.topGroupingOption||null)
}$(".extra-fields .agent .agent_link",this.el).on("click",function(ev){var agent_id=$(this).parent().data("prop-value");
if(agent_id){ev.stopPropagation();ev.preventDefault();DeskPRO_Window.sections.agent_chat_section.newChatWindow([agent_id])
}});DeskPRO_Window.getMessageBroker().addMessageListener("agent-notification.tickets.unlocked",(function(info){var ticketId=info.ticket_id;
$(".ticket-"+ticketId,this.contentWrapper).removeClass("locked")}).bind(this),null,[this.OBJ_ID]);DeskPRO_Window.getMessageBroker().addMessageListener("agent-notification.tickets.locked",(function(info){var ticketId=info.ticket_id;
$(".ticket-"+ticketId,this.contentWrapper).addClass("locked")}).bind(this));DeskPRO_Window.getMessageBroker().addMessageListener("tickets.deleted",(function(ticket_ids){var sels=[];
Array.each(ticket_ids,function(val){this.resultsHelper.removeResultId(val);sels.push("article.ticket-"+val)
},this);sels=sels.join(", ");var els=$(sels,this.contentWrapper).addClass("removing").fadeOut(400,function(){$(this).remove();
self.updateTicketCountLabels();self.updateUi()});this.countTotal-=els.length}).bind(this),null,[this.OBJ_ID]);
DeskPRO_Window.getMessageBroker().addMessageListener("agent.ui.ticket_updated",function(info){var ticketId=info.ticket_id;
self.addTicket(ticketId,true)},null,[this.OBJ_ID]);this.contentWrapper=$(".layout-content:first",this.wrapper);
this._initDisplayOptions();this._initFlagMenu();this._initGroupingOptions();if(this.getMetaData("noResults")){this.noMoreResults=true;
$(".no-more-results",this.contentWrapper).show()}this.performActionsBtn=$(".perform-actions-trigger",this.wrapper);
var openMassActions=function(){if(!self.massActions){self.massActions=new DeskPRO.Agent.TicketList.MassActions(self,{isListView:(self.meta.viewType=="list"?true:false),onPostApply:function(){self.selectionBar.checkNone()
},onClosed:function(){if(self.massActions){self.massActions.destroy()}self.selectionBar.checkNone();self.massActions=null
}})}self.massActions.open()};self.getEl("perform_actions_btn").on("click",function(ev){Orb.cancelEvent(ev);
openMassActions()});var viewType=this.meta.viewType;var opt={saveSelectionId:self.meta.filter_id?("filter_"+self.meta.filter_id):null,onButtonClick:function(){if(viewType!="list"&&DeskPRO_Window.paneVis.tabs){openMassActions()
}},onCountChange:function(count){if(viewType!="list"&&DeskPRO_Window.paneVis.tabs){var isOpen=self.massActions&&self.massActions.isOpen();
if(count>0&&!isOpen){openMassActions()}else{if(count<=0&&isOpen){if(self.massActions){self.massActions.close()
}}}}else{if(count>0){self.getEl("perform_actions_btn").show()}else{self.getEl("perform_actions_btn").hide()
}}}};if(viewType=="list"){this.wrapper.find(".perform-actions-trigger").on("click",function(ev){Orb.cancelEvent(ev);
openMassActions()})}if(this.meta.viewType=="list"){opt.selectionBar=$("thead, .selection-bar",el)}this.selectionBar=new DeskPRO.Agent.PageHelper.SelectionBar(this,opt);
this.ownObject(this.selectionBar);var m=new DeskPRO.UI.Menu({triggerElement:$("button.sub-group-trigger:first",this.contentWrapper),menuElement:$("ul.sub-group-menu:first",this.contentWrapper)});
this.ownObject(m);if(this.meta.groupingIgnore){var groupByMenu=$(".group-by-menu",this.wrapper);Array.each(this.meta.groupingIgnore,function(ig){$('[value="'+ig+'"], [data-group-by="'+ig+'"]',groupByMenu).remove()
})}var opt={resultIds:this.meta.ticketResultIds,perPage:this.meta.perPage||50};if(this.meta.viewType=="list"){opt.resultRowSelector="tr.row-item";
opt.resultsContainer=$(".table-result-list table",el);opt.navEl=$(".bottom-action-bar",el)}else{opt.resultsContainer=$("> .list-listing",this.getEl("is_results"))
}opt.onPostSetNewResults=function(){self.selectionBar.resetCountLabel()};this.resultsHelper=new DeskPRO.Agent.PageHelper.Results(this,opt);
this.ownObject(this.resultsHelper);delete this.meta.ticketResultIds;if(this.meta.viewType=="list"){this.resultsHelper.options.postSetNewResults=function(){self.selectionBar.controlCheck=self.wrapper.find(".selection-control");
self.selectionBar.controlCheck.on("click",function(){if($(this).is(":checked")){self.selectionBar.checkAll()
}else{self.selectionBar.checkNone()}})};$(".list-grouping-bar",this.wrapper).on("click","a[data-route]",function(ev){ev.stopPropagation();
ev.preventDefault();var route=$(this).data("route");self.loadNewListviewUrl(route.replace("listpane:","")+"&view_type=list")
})}this.enableHighlightOpenRows("ticket","ticket_id",".row-item.ticket-");this.countTotal=parseInt(this.getEl("total_count").text().trim())||0;
if(this.meta.viewType!="list"){this.listNav=new DeskPRO.Agent.PageHelper.ListNav(this)}this.selectionBar.restoreFromSessionStorage()
},handleAutoAdd:function(ticketId){var self=this;self.reloadIfStale=false;var row=$("article.ticket-"+ticketId,self.contentWrapper);
if(row[0]&&row.hasClass("removing")){return false}if(self.meta.topGroupingTerm){var li=$("#system_filters_wrap").find(".nav-selected");
if(!li[0]){$("#tickets_outline_custom_filters").find(".nav-selected")}if(!li[0]){return false}if(li.hasClass("is-stale")){if(self.meta.routeData&&self.meta.routeData.route){DeskPRO_Window.runPageRoute(self.meta.routeData.route)
}}self.reloadIfStale=true;if(!row[0]){return false}}if(self.meta.groupBy){if(self.meta.routeData&&self.meta.routeData.route){DeskPRO_Window.runPageRoute(self.meta.routeData.route)
}}self.addTicket(ticketId,false);return true},_handleResize:function(){if(!this.layout){return}this.layout.resizeAll()
},addTicket:function(ticket_id,replace_existing){var self=this;if(!this.meta.loadSingleUrl){return}var exist=self.getEl("results_wrap").find("article.ticket-"+ticket_id);
if(exist[0]&&exist.hasClass("removing")){return}this.resultsHelper.prependResultId(ticket_id);if(this.resultsHelper.getCurrentPage()==1){var url=this.meta.loadSingleUrl.replace("$ticket_id",ticket_id).replace("$view_type",this.meta.viewType||"");
if(replace_existing){var exist=self.getEl("results_wrap").find("article.ticket-"+ticket_id);if(!exist[0]||exist.hasClass("removing")){return
}}this.autoAddAjax[ticket_id]=$.ajax({url:url,dataType:"html",context:this,complete:function(){if(this.autoAddAjax[ticket_id]){delete this.autoAddAjax[ticket_id]
}},success:function(html){var el=$(html);var ticketRow=el.find("article.row-item");var ticketId=ticketRow.data("ticket-id");
if(ticketId){var tabs=DeskPRO_Window.tabWatcher.findTabType("ticket");Array.each(tabs,function(t){if(t.page.meta.ticket_id==ticket_id){ticketRow.addClass("open");
return false}})}$(".timeago",el).timeago();var exist=self.getEl("results_wrap").find("article.ticket-"+ticket_id);
if(replace_existing&&!exist[0]){return}if(exist[0]&&exist.hasClass("removing")){return}if(exist[0]&&replace_existing){if(!el.is(".row-item")){el=el.find(".row-item");
el.hide();el.detach()}exist.after(el);exist.remove();el.show()}else{if(exist[0]){exist.remove()}self.getEl("results_wrap").prepend(el);
el.slideDown("fast",self.updateUi.bind(self));this.countTotal++;this.updateTicketCountLabels()}}})}},delTicket:function(ticket_id){var self=this;
var el=$(".ticket-"+ticket_id,this.contentWrapper);if(this.autoAddAjax[ticket_id]){this.autoAddAjax[ticket_id].abort();
if(this.autoAddAjax[ticket_id]){delete this.autoAddAjax[ticket_id]}}if(!el[0]){return}el.addClass("removing");
el.animate({height:"toggle",opacity:"toggle"},"slow",function(){self.resultsHelper.removeResultId(ticket_id);
el.remove();self.countTotal--;self.updateTicketCountLabels();self.updateUi()})},updateTicketCountLabels:function(){var showing=$("article.row-item",this.wrapper).length||0;
if(this.countTotal<0){this.countTotal=0}if(this.countTotal<1){this.getEl("is_results").hide();this.getEl("no_results").show();
this.getEl("total_count").text(this.countTotal);this.wrapper.find(".results-count-display").text(this.countTotal)
}else{if(!this.resultsHelper){return}if(!this.getEl("is_results").length){DeskPRO_Window.loadListPane(this.meta.refreshUrl);
return}this.getEl("no_results").hide();this.getEl("is_results").show();var lowerBounds=((this.resultsHelper.currentPage-1)*this.resultsHelper.options.perPage)+1;
var upperBounds=(lowerBounds-1)+showing;if(upperBounds>this.countTotal){upperBounds=this.countTotal}this.getEl("showing_count").text(lowerBounds+"-"+upperBounds);
this.getEl("total_count").text(this.countTotal);this.wrapper.find(".results-count-display").text(this.countTotal);
$("span",this.getEl("total_grouped_count")).text(this.countTotal);this.selectionBar.resetCountLabel()
}},_initSearchOptions:function(){var editBtn=$(".summary .edit",this.topSection);editBtn.on("click",this.showSearchForm.bind(this));
var form=$("form.ticket-search-form",this.topSection);form.on("submit",function(ev){ev.preventDefault();
var url=form.attr("action");var data=form.serializeArray();DeskPRO_Window.loadListPane(url,{postData:data})
})},showSearchForm:function(){var criteriaList=$(".search-form",this.topSection);var criteriaTerms=$(".search-builder-tpl",this.topSection);
var editor=new DeskPRO.Form.RuleBuilder(criteriaTerms);this.ownObject(editor);$(".add-term",criteriaList).data("add-count",0).on("click",function(){var count=parseInt($(this).data("add-count"));
var basename="terms["+count+"]";$(this).data("add-count",count+1);editor.addNewRow($(".search-terms",criteriaList),basename)
});var searchDataEl=$(".search-form-data:first",this.topSection);if(searchDataEl.length){var searchData=searchDataEl.get(0).innerHTML;
searchData=$.parseJSON(searchData);if(searchData.terms){Array.each(searchData.terms,function(info,x){var basename="terms[initial_"+x+"]";
editor.addNewRow($(".search-terms",criteriaList),basename,{type:info.type,op:info.op,options:info.options})
})}if(searchData.order_by){$('[name="order_by"]',this.topSection).val(searchData.order_by)}searchDataEl.remove()
}$(".summary",this.topSection).slideUp();$(".form-panel",this.topSection).slideDown()},_initGroupingOptions:function(){var self=this;
$("div.search-top ul.grouping-info > li[data-group-id]",this.contentWrapper).on("click",function(){self.switchToSubgroup($(this).data("group-id"),$(this))
})},switchToSubgroup:function(field_id,el){if(field_id=="NONE"){this.appendUrl=null}else{this.appendUrl="&group_field_id="+field_id
}$("table.list tbody",this.contentWrapper).remove();this.loadResultPage(1);$("div.search-top ul.grouping-info > li",this.contentWrapper).removeClass("on");
if(el){el.addClass("on")}},_initFlagMenu:function(){var self=this;this.flagMenu=new DeskPRO.UI.Menu({menuElement:$("> ul.ticket-flag-menu:first",this.contentWrapper),onItemClicked:function(info){self._handleFlagMenuClick(info)
}});this.ownObject(this.flagMenu);$("table.list:first",this.contentWrapper).on("click","span.ticket-flag",function(ev){self.flagMenu.openMenu(ev)
})},_handleFlagMenuClick:function(info){var item=$(info.itemEl);var flag=item.data("flag");var m=$(info.menu.getOpenTriggerElement());
var ticketId=m.parent().parent().data("ticket-id");if(!ticketId){return}var old_flag=m.data("flag");m.removeClass("icon-flag-"+old_flag);
m.addClass("icon-flag-"+flag);m.data("flag",flag);$.ajax({url:BASE_URL+"agent/tickets/"+ticketId+"/ajax-save-flagged",type:"POST",context:this,data:{color:flag},dataType:"json",success:function(data){}})
},_initDisplayOptions:function(){var self=this;$(".detail-view-trigger",this.contentWrapper).on("click",function(){self.switchViewType("list")
});this.displayOptions=new DeskPRO.Agent.PageHelper.DisplayOptions(this,{prefId:"ticket-"+this.resultTypeName,resultId:this.resultTypeId,refreshUrl:this.meta.refreshUrl,isListView:(this.meta.viewType=="list"?true:false)});
this.ownObject(this.displayOptions);var sortMenuBtn=$(".order-by-menu-trigger",this.wrapper).first();
this.sortingMenu=new DeskPRO.UI.Menu({triggerElement:sortMenuBtn,menuElement:$(".order-by-menu",this.wrapper).first(),onItemClicked:function(info){var item=$(info.itemEl);
var prop=item.data("order-by");var label=item.find(".label").text().trim();$(".label label",sortMenuBtn).text(label);
sortMenuBtn.find(".order-dir").hide();sortMenuBtn.find(".order-dir."+prop.split("_").pop()).show();var disOptWrap=self.displayOptions.getWrapperElement();
var sel=$("select.sel-order-by",disOptWrap);$("option",sel).prop("selected",false);$("option."+prop,sel).prop("selected",true);
if(self.wrapper.find("header.list-grouping-bar").css("display")=="block"){self.wrapper.find("header.list-grouping-bar").hide();
self.getEl("grouping_loading").show()}self.displayOptions.saveAndRefresh()}});this.ownObject(this.sortingMenu);
var groupMenuBtn=$(".group-by-menu-trigger",this.wrapper).first();this.groupingMenu=new DeskPRO.UI.Menu({triggerElement:groupMenuBtn,menuElement:$(".group-by-menu",this.wrapper).first(),onItemClicked:function(info){var item=$(info.itemEl);
var prop=item.data("group-by");var label=item.text().trim();$(".label",groupMenuBtn).text(label);var url=self.meta.refreshUrl;
url=Orb.appendQueryData(url,"group_by",prop);if(self.meta.viewType=="list"){self.loadNewListviewUrl(url+"&view_type=list")
}else{self.wrapper.find("header.list-grouping-bar").hide();self.getEl("grouping_loading").show();DeskPRO_Window.loadListPane(url)
}}});this.ownObject(this.groupingMenu)},switchViewType:function(view_type){var new_url=this.meta.viewTypeUrl.replace("$view_type",view_type);
if(view_type=="list"){var oldlist=this.listview;this.listview=new DeskPRO.Agent.TicketList.ListView(this);
if(oldlist&&!oldlist.OBJ_DESTROYED){this.listview.addEvent("ajaxLoaded",function(){if(!oldlist.OBJ_DESTROYED){oldlist.destroy()
}})}this.listview.open();return}DeskPRO_Window.loadListPane(new_url,null,function(){DeskPRO_Window.removePage(self)
})},loadNewListviewUrl:function(new_url){var oldlist=this.listview;this.listview=new DeskPRO.Agent.TicketList.ListView(this,{load_url:new_url});
if(oldlist&&!oldlist.OBJ_DESTROYED){oldlist.showInnerLoading();this.listview.addEvent("ajaxLoaded",function(){if(!oldlist.OBJ_DESTROYED){oldlist.destroy()
}})}oldlist.close();this.listview.open()}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");
DeskPRO.Agent.PageFragment.ListPane.TicketFilter=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.BasicTicketResults,initializeProperties:function(){this.TYPENAME="ticket-filter";
this.resultTypeName="filter";this.resultTypeId=0},initPage:function(el){DeskPRO_Window.getMessageBroker().sendMessage("ticket-section.list-activated",{listType:"filter",id:this.getMetaData("filter_id"),topGroupingOption:this.meta.topGroupingOption||null});
this.resultTypeId=this.getMetaData("filter_id");this.parent(el)},activate:function(){if(this.getMetaData("filter_id")){DeskPRO_Window.getMessageBroker().sendMessage("filter.view-activated",this.getMetaData("filter_id"))
}},deactivate:function(){if(this.getMetaData("filter_id")){DeskPRO_Window.getMessageBroker().sendMessage("filter.view-deactivated",this.getMetaData("filter_id"))
}}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");DeskPRO.Agent.PageFragment.ListPane.OrganizationList=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="org-list";this.wrapper=null;this.contentWrapper=null;this.overlay=null;this.appendUrl=null;
this.actionsBarHelper=null;this.resultTypeName="filter";this.resultTypeId=0},initPage:function(el){var self=this;
this.wrapper=$(el);this.contentWrapper=$("div.content:first",this.wrapper);this.resultTypeId=this.meta.cache_id||0;
if(this.getMetaData("noResults")){this.noMoreResults=true;$(".no-more-results",this.contentWrapper).show()
}this.displayOptions=new DeskPRO.Agent.PageHelper.DisplayOptions(this,{prefId:"org-filter",resultId:this.resultId,refreshUrl:this.meta.refreshUrl});
this.ownObject(this.displayOptions);this.enableHighlightOpenRows("organization","org_id","article.org-");
var opt={resultIds:this.meta.orgResultIds,perPage:this.meta.perPage||50};if(this.meta.viewType&&this.meta.viewType=="list"){opt.resultRowSelector="tr.row-item";
opt.resultsContainer=$(".table-result-list table",el);opt.navEl=$(".bottom-action-bar",el)}this.resultsHelper=new DeskPRO.Agent.PageHelper.Results(this,opt);
this.ownObject(this.resultsHelper);delete this.meta.orgResultIds;var sortMenuBtn=$(".order-by-menu-trigger",this.wrapper).first();
this.sortingMenu=new DeskPRO.UI.Menu({triggerElement:sortMenuBtn,menuElement:$(".order-by-menu",this.wrapper).first(),onItemClicked:function(info){var item=$(info.itemEl);
var prop=item.data("order-by");var label=item.text().trim();$(".label",sortMenuBtn).text(label);var disOptWrap=self.displayOptions.getWrapperElement();
var sel=$("select.sel-order-by",disOptWrap);$("option",sel).prop("selected",false);$("option."+prop,sel).prop("selected",true);
self.displayOptions.saveAndRefresh()}});this.ownObject(this.sortingMenu)}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");
DeskPRO.Agent.PageFragment.ListPane.PeopleList=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="people-list";this.wrapper=null;this.contentWrapper=null;this.overlay=null;this.appendUrl=null;
this.actionsBarHelper=null;this.resultTypeName="filter";this.resultTypeId=0},initPage:function(el){var self=this;
this.wrapper=$(el);this.contentWrapper=$("div.content:first",this.wrapper);this.resultTypeId=this.meta.cache_id||0;
if(this.getMetaData("noResults")){this.noMoreResults=true;$(".no-more-results",this.contentWrapper).show()
}this.displayOptions=new DeskPRO.Agent.PageHelper.DisplayOptions(this,{prefId:"people-filter",resultId:this.resultId,refreshUrl:this.meta.refreshUrl,isListView:(this.meta.viewType=="list"?true:false)});
this.ownObject(this.displayOptions);var sortMenuBtn=$(".order-by-menu-trigger",this.wrapper).first();
this.sortingMenu=new DeskPRO.UI.Menu({triggerElement:sortMenuBtn,menuElement:$(".order-by-menu",this.wrapper).first(),onItemClicked:function(info){var item=$(info.itemEl);
var prop=item.data("order-by");var label=item.text().trim();$(".label",sortMenuBtn).text(label);var disOptWrap=self.displayOptions.getWrapperElement();
var sel=$("select.sel-order-by",disOptWrap);$("option",sel).prop("selected",false);$("option."+prop,sel).prop("selected",true);
self.displayOptions.saveAndRefresh()}});this.ownObject(this.sortingMenu);this.selectionBar=new DeskPRO.Agent.PageHelper.SelectionBar(this,{});
this.ownObject(this.selectionBar);$(".detail-view-trigger",this.wrapper).on("click",(function(){this.switchViewType("list")
}).bind(this));this.massActionsMenu=new DeskPRO.UI.Menu({triggerElement:$(".perform-actions-trigger:first",this.wrapper),menuElement:$(".actions-menu:first",this.wrapper),onItemClicked:function(info){var itemEl=$(info.itemEl);
var menuEl=itemEl.parent();var action=itemEl.data("action");if(menuEl.is(".submenu")){action=menuEl.data("action")
}var postData=self.selectionBar.getCheckedFormValues("ids");var removeFromList=false;switch(action){case"delete":break;
case"add-to-organization":var id=itemEl.data("organization-id");if(!id){return}postData.push({name:"organization_id",value:id});
break;case"del-from-organization":break;case"add-to-usergroup":var id=itemEl.data("usergroup-id");if(!id){return
}postData.push({name:"usergroup_id",value:id});break;case"del-from-usergroup":var id=itemEl.data("usergroup-id");
if(!id){return}postData.push({name:"usergroup_id",value:id});break;default:return;break}$.ajax({url:BASE_URL+"agent/feedback/filter/mass-actions/"+action,data:postData,type:"POST",dataType:"json",success:function(data){if(removeFromList){self.selectionBar.getChecked().parent().fadeOut("fast")
}else{self.selectionBar.getChecked().each(function(){var name=$(".subject",$(this).parent());DeskPRO_Window.util.showSavePuff(name)
})}self.selectionBar.checkNone()}})}});this.ownObject(this.massActionsMenu);this.enableHighlightOpenRows("person","person_id","article.person-");
var opt={resultIds:this.meta.peopleResultIds,perPage:this.meta.perPage||50};if(this.meta.viewType=="list"){opt.resultRowSelector="tr.row-item";
opt.resultsContainer=$(".table-result-list table",el);opt.navEl=$(".bottom-action-bar",el)}this.resultsHelper=new DeskPRO.Agent.PageHelper.Results(this,opt);
this.ownObject(this.resultsHelper);delete this.meta.peopleResultIds;if(this.meta.viewType!="list"){this.listNav=new DeskPRO.Agent.PageHelper.ListNav(this)
}this.wrapper.on("click","button.agent-confirm-approve",function(ev){ev.preventDefault();var el=$(this);
DeskPRO_Window.util.ajaxWithClientMessages({url:BASE_URL+"agent/people/validate/approve",data:{"people_ids[]":el.data("person-id")},success:function(){DeskPRO_Window.getMessageBroker().sendMessage("agent.person.confirmed",{person_id:el.data("person-id")});
el.closest(".validation-row").remove();self.updateUi()}})});this.wrapper.on("click","button.agent-confirm-delete",function(ev){ev.preventDefault();
var el=$(this);DeskPRO_Window.util.ajaxWithClientMessages({url:BASE_URL+"agent/people/validate/delete",data:{"people_ids[]":el.data("person-id")},success:function(){DeskPRO_Window.getMessageBroker().sendMessage("agent.person.removed",{person_id:el.data("person-id")});
el.closest("article.row-item").remove();self.updateUi()}})});DeskPRO_Window.getMessageBroker().addMessageListener("agent.person.removed",function(info){var row=self.wrapper.find("article.person-"+info.person_id);
row.remove();self.updateUi()});DeskPRO_Window.getMessageBroker().addMessageListener("agent.person.confirmed",function(info){var row=self.wrapper.find("article.person-"+info.person_id);
row.find(".validation-row").remove();self.updateUi()})},destroyPage:function(){},switchViewType:function(view_type){var new_url=this.meta.viewTypeUrl.replace("$view_type",view_type);
if(view_type=="list"){var oldlist=this.listview;this.listview=new DeskPRO.Agent.PageHelper.PeopleList.ListView(this);
if(oldlist&&!oldlist.OBJ_DESTROYED){this.listview.addEvent("ajaxLoaded",function(){if(!oldlist.OBJ_DESTROYED){oldlist.destroy()
}})}this.listview.open();return}DeskPRO_Window.loadListPane(new_url,null,function(){DeskPRO_Window.removePage(self)
})},loadNewListviewUrl:function(new_url){var oldlist=this.listview;this.listview=new DeskPRO.Agent.PageHelper.PeopleList.ListView({load_url:new_url});
if(oldlist&&!oldlist.OBJ_DESTROYED){oldlist.showInnerLoading();this.listview.addEvent("ajaxLoaded",function(){if(!oldlist.OBJ_DESTROYED){oldlist.destroy()
}})}this.listview.open()},saveDisplayOptions:function(){$(".loading-off",this.displayOptionsWrapper).hide();
$(".loading-on",this.displayOptionsWrapper).show();var data=[];var pref_name="prefs[agent.ui.people-"+this.resultTypeName+"-display-fields."+this.resultTypeId+"][]";
$('input[type="checkbox"]:checked',this.displayOptionsList).each(function(){data.push({name:pref_name,value:$(this).attr("name")})
});data.push({name:"prefs[agent.ui.people-"+this.resultTypeName+"-order-by."+this.resultTypeId+"]",value:$('select[name="order_by"]',this.displayOptionsWrapper).val()});
var url=this.getMetaData("refreshUrl");if(this.appendUrl){url+=this.appendUrl}var self=this;$.ajax({timeout:20000,type:"POST",url:this.getMetaData("saveListPrefsUrl"),data:data,success:function(){DeskPRO_Window.loadListPane(url,null,function(){DeskPRO_Window.removePage(self)
})}})}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");DeskPRO.Agent.PageFragment.ListPane.TicketFlagged=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.BasicTicketResults,initializeProperties:function(){this.parent();
this.TYPENAME="ticket-flagged";this.resultTypeName="flagged";this.resultTypeId=0},initPage:function(el){this.meta["view_name"]="flag";
this.meta["view_extra"]=this.getMetaData("flag");DeskPRO.Agent.PageFragment.ListPane.BasicTicketResults.prototype.initPage.apply(this,[el]);
this.resultTypeId=this.getMetaData("flag")}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");
DeskPRO.Agent.PageFragment.ListPane.TicketDeletedList=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.BasicTicketResults,initializeProperties:function(){this.parent();
this.TYPENAME="ticket-deleted-list";this.resultTypeName="filter";this.resultTypeId=0},initPage:function(el){this.parent(el);
this.resultTypeId=this.getMetaData("cache_id")}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");
DeskPRO.Agent.PageFragment.ListPane.TicketCustomFilter=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.BasicTicketResults,initPage:function(el){if(this.getMetaData("view_label")){DeskPRO_Window.getMessageBroker().sendMessage("ticket-section.list-activated",{listType:"label",id:this.getMetaData("label")})
}else{if(this.getMetaData("view_flag")){DeskPRO_Window.getMessageBroker().sendMessage("ticket-section.list-activated",{listType:"flag",id:this.getMetaData("flag")})
}else{if(this.getMetaData("view_spam")){DeskPRO_Window.getMessageBroker().sendMessage("ticket-section.list-activated",{listType:"archive",id:this.getMetaData("spam")})
}else{if(this.getMetaData("view_validating")){DeskPRO_Window.getMessageBroker().sendMessage("ticket-section.list-activated",{listType:"archive",id:this.getMetaData("validating")})
}else{if(this.getMetaData("view_recycle_bin")){DeskPRO_Window.getMessageBroker().sendMessage("ticket-section.list-activated",{listType:"archive",id:this.getMetaData("recycle_bin")})
}}}}}this.parent(el);this.resultTypeId=this.getMetaData("cache_id")}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");
DeskPRO.Agent.PageFragment.ListPane.TicketCustomFilterForm=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.Basic,initPage:function(el){this.wrapper=$(el);
this._initBasic();this._initFilterForm();if(this.getMetaData("autorun")){this.submitForm()}},destroyPage:function(){},_initBasic:function(){var self=this;
$("> .summary > .toggle",this.wrapper).on("click",function(){$("> .summary",self.wrapper).hide();$("> .criteria",self.wrapper).slideDown()
})},_initFilterForm:function(){var self=this;var editor=new DeskPRO.Form.RuleBuilder($(".search-tpl",this.wrapper));
editor.addEvent("newRow",function(new_row){$(".remove",new_row).on("click",function(){new_row.remove()
})});$(".search-form .add-term").data("add-count",0).on("click",function(){var count=parseInt($(this).data("add-count"));
var basename="terms["+count+"]";$(this).data("add-count",count+1);editor.addNewRow($(".search-form .search-terms",self.wrapper),basename)
});var self=this;$("button.run-filter-trigger",this.wrapper).on("click",function(){self.submitForm()});
if(this.getMetaData("preselectTerms")){var count=0;var preselectTerms=this.getMetaData("preselectTerms");
for(var i=0;i<preselectTerms.length;i++){if(!preselectTerms[i]){continue}editor.addNewRow($(".search-form .search-terms",self.wrapper),"terms["+count+"]",preselectTerms[i])
}$(".search-form .add-term",this.wrapper).data("add-count",count)}},submitForm:function(){var data=$("form.search-form-data",this.wrapper).serializeArray();
$.ajax({cache:false,type:"POST",data:data,url:this.getMetaData("formSubmitUrl"),context:this,dataType:"html",success:function(data){$(" .criteria",this.wrapper).hide();
$(".summary",this.wrapper).show();this._handleAjaxResults(data)}})},_handleAjaxResults:function(data){DeskPRO_Window.removePage(this);
var page=DeskPRO_Window.createPageFragment(data);DeskPRO_Window.addListPage(page)}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");
DeskPRO.Agent.PageFragment.ListPane.TicketSla=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.BasicTicketResults,initializeProperties:function(){this.parent();
this.TYPENAME="ticket-sla";this.resultTypeName="sla";this.resultTypeId=0},initPage:function(el){DeskPRO_Window.getMessageBroker().sendMessage("ticket-section.list-activated",{listType:"sla",id:this.getMetaData("sla_id"),topGroupingOption:this.meta.topGroupingOption||null});
this.resultTypeId=this.getMetaData("sla_id");this.parent(el)},activate:function(){if(this.getMetaData("sla_id")){DeskPRO_Window.getMessageBroker().sendMessage("sla.view-activated",this.getMetaData("sla_id"))
}},deactivate:function(){if(this.getMetaData("sla_id")){DeskPRO_Window.getMessageBroker().sendMessage("sla.view-deactivated",this.getMetaData("sla_id"))
}},updateSlaListForTicket:function(info){if(!info.ticket_id||!info.sla_id){return}this.refreshSlaTicketList()
},refreshSlaTicketList:function(){var self=this;if(this.isRefreshing){return}this.isRefreshing=true;setTimeout(function(){self.isRefreshing=false;
DeskPRO_Window.loadListPane(self.meta.refreshUrl)},0)}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");
DeskPRO.Agent.PageFragment.ListPane.RecycleBin=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="recyclebin";this.wrapper=null;this.contentWrapper=null;this.barWrapper=null;this.layout=null;
this.overlay=null;this.appendUrl=null;this.actionsBarHelper=null;this.resultTypeName="basic";this.resultTypeId="general";
this.changeManager=null;this.loadFirst=false},initPage:function(el){this.wrapper=el;var self=this;$(".type-list",el).each(function(){self.initTypeList($(this))
});$("time.timeago",this.wrapper).timeago()},initTypeList:function(listWrap){var type=listWrap.data("load-name");
var self=this;$(".list-load-more",listWrap).on("click",function(){self.loadMore(type)})},loadMore:function(loadName){var wrap=$("."+loadName+"-list.type-list",this.wrapper);
var table=$("table:first",wrap);var loadBtn=$(".list-load-more",wrap);var lastTbody=$("tbody:last",table);
var nextPage=parseInt(lastTbody.data("page"))+1;$.ajax({url:BASE_URL+"agent/recycle-bin/"+loadName+"/"+nextPage,dataType:"json",success:function(data){if(data.no_more_results){loadBtn.hide()
}if(data.count<1){return}var rows=$(data.htmls);$("time.timeago",rows).timeago();table.append(rows)}})
}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");DeskPRO.Agent.PageFragment.ListPane.KbPendingArticles=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.Basic,initPage:function(el){var self=this;
this.wrapper=el;this.actionsMenu=new DeskPRO.UI.Menu({menuElement:$("ul.actions-menu:first",this.wrapper),triggerElement:$(".perform-actions-trigger:first",this.wrapper),onItemClicked:function(info){var ids=self.selectionBar.getCheckedValues();
var els=[];var formData=[];Array.each(ids,function(id){formData.push({name:"ids[]",value:id});els.push($("article.pending-article-"+id+":first",self.wrapper).get(0))
});$(els).fadeOut();var action=$(info.itemEl).data("action");$.ajax({url:BASE_URL+"agent/kb/pending-articles/mass-actions/"+action,data:formData,type:"POST",dataType:"json",error:function(){$(els).show()
},success:function(){$(els).remove();DeskPRO_Window.util.modCountEl("#kb_pending_count","-",els.length)
}})}});this.ownObject(this.actionsMenu);this.selectionBar=new DeskPRO.Agent.PageHelper.SelectionBar(this,{onButtonClick:function(ev){self.actionsMenu.open(ev)
}});this.ownObject(this.selectionBar);DeskPRO_Window.getMessageBroker().addMessageListener("kb.pending_article_removed",function(data){self.removeFromList(data.pending_article_id)
});var newFormOverlay=new DeskPRO.UI.Overlay({contentElement:this.getEl("add_new_overlay"),zIndex:"top"});
$(".add-new-trigger",this.el).on("click",function(){newFormOverlay.open()});$(".save-new-trigger",this.getEl("add_new_overlay")).on("click",function(){self.saveNewPendingArticle();
newFormOverlay.close()});$("section.pending-articles-list",this.wrapper).on("click",".pending-delete",function(ev){ev.stopPropagation();
var row=$(this);var x=0;while(!row.is("article")){if(x++>10){return}row=row.parent()}row.slideUp("fast");
var id=$("input.item-select",row).val();$.ajax({url:BASE_URL+"agent/kb/pending-articles/"+id+"/remove",type:"POST",dataType:"json",error:function(){row.show()
},success:function(){row.remove();DeskPRO_Window.util.modCountEl("#kb_pending_count","-")}})});$("section.pending-articles-list",this.wrapper).on("click",".pending-create",function(ev){ev.stopPropagation();
var row=$(this);var x=0;while(!row.is("article")){if(x++>10){return}row=row.parent()}var id=$("input.item-select",row).val();
var ticketRoute=$("input.item-select",row).data("ticket-route");$.ajax({url:BASE_URL+"agent/kb/pending-articles/"+id+"/info",type:"POST",dataType:"json",success:function(data){if(ticketRoute){DeskPRO_Window.runPageRoute(ticketRoute)
}if(DeskPRO_Window.newArticleLoader){DeskPRO_Window.newArticleLoader.open(function(page){page.setPendingArticle(data);
if(data.ticket_id){var closeTicketId=data.ticket_id;page.addEvent("destroy",function(){Object.each(DeskPRO_Window.TabBar.getTabs(),function(tab,id){if(tab.page&&tab.page.meta.ticket_id==closeTicketId){DeskPRO_Window.removePage(tab.page)
}})})}})}}})})},saveNewPendingArticle:function(){var formWrap=this.getEl("add_new_overlay");var val=$("textarea",this.getEl("add_new_overlay")).val().trim();
if(!val){formWrap.slideUp();return}var data=[];data.push({name:"comment",value:val});$.ajax({url:BASE_URL+"agent/kb/pending-articles/new",type:"POST",data:data,context:this,dataType:"json",success:function(info){$("textarea:first",formWrap).val("");
formWrap.slideUp();var addEl=$(info.row_html);$("section.pending-articles-list",this.wrapper).prepend(addEl);
DeskPRO_Window.util.modCountEl("#kb_pending_count","+")}})},removeFromList:function(id){$("article.pending-article-"+id,this.wrapper).slideUp("fast");
DeskPRO_Window.util.modCountEl("#kb_pending_count","-");DeskPRO_Window.util.modCountEl(this.getEl("count"),"-")
}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");DeskPRO.Agent.PageFragment.ListPane.KbValidatingArticles=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.Basic,initPage:function(el){this.wrapper=el;
var self=this;$("a.view-link.edit",this.wrapper).on("click",function(ev){ev.preventDefault();self.loadPreviewEdit($(this).attr("href"))
});$("a.view-link.article",this.wrapper).on("click",function(ev){ev.preventDefault();self.loadPreviewArticle($(this).attr("href"))
})},loadPreviewEdit:function(url){var self=this;var overlay=new DeskPRO.UI.Overlay({destroyOnClose:true,contentMethod:"ajax",contentAjax:{url:url,type:"GET",context:this,dataType:"html"},maxWidth:500,maxHeight:700,onContentSet:function(ev){var contentEl=ev.contentEl;
var overlay=ev.overlay;$("button.approve-trigger",contentEl).on("click",function(ev){ev.preventDefault();
self.approveEdit($("input.article_id",contentEl).val());overlay.closeOverlay()});$("button.disapprove-trigger",contentEl).on("click",function(ev){ev.preventDefault();
self.disapproveEdit($("input.article_id",contentEl).val());overlay.closeOverlay()})}});overlay.openOverlay()
},approveEdit:function(article_id){$.ajax({url:BASE_URL+"agent/kb/validating-articles/validate/"+article_id+".json",type:"POST",context:this,dataType:"json",success:function(info){var article_id=info.article_id;
$(".article-"+article_id,this.wrapper).remove();this.removeFromList(article_id,info.type)}})},disapproveEdit:function(article_id){$.ajax({url:BASE_URL+"agent/kb/validating-articles/disapprove/"+article_id+".json",type:"POST",context:this,dataType:"json",success:function(info){var article_id=info.article_id;
$(".article-"+article_id,this.wrapper).remove();this.removeFromList(article_id,info.type)}})},removeFromList:function(article_id,type){var count_total=$(".counter-total",this.wrapper);
var count_type=$(".counter-"+type,this.wrapper);var total_int=parseInt(count_total.html());var type_int=parseInt(count_total.html());
count_total.html(total_int-1);count_type.html(type_int-1);var wrap_type=$(".wrap-"+type,this.wrapper);
if(!$("tr.article",wrap_type).length){wrap_type.remove()}},loadPreviewArticle:function(url){var self=this;
var overlay=new DeskPRO.UI.Overlay({destroyOnClose:true,contentMethod:"ajax",contentAjax:{url:url,type:"GET",context:this,dataType:"html"},maxWidth:500,maxHeight:700,onContentSet:function(ev){var contentEl=ev.contentEl;
var overlay=ev.overlay;$("button.approve-trigger",contentEl).on("click",function(ev){ev.preventDefault();
self.approveEdit($("input.article_id",contentEl).val());overlay.closeOverlay()});$("button.disapprove-trigger",contentEl).on("click",function(ev){ev.preventDefault();
self.disapproveEdit($("input.article_id",contentEl).val());overlay.closeOverlay()})}});overlay.openOverlay()
}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");DeskPRO.Agent.PageFragment.ListPane.KbList=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.Basic,initPage:function(el){var self=this;
this.wrapper=el;this.displayOptions=new DeskPRO.Agent.PageHelper.DisplayOptions(this,{prefId:"kb-filter",resultId:this.meta.resultId,refreshUrl:this.meta.refreshUrl,prefSaveResultId:"0"});
this.ownObject(this.displayOptions);this.selectionBar=new DeskPRO.Agent.PageHelper.SelectionBar(this,{onCountChange:function(count){var isOpen=self.massActions.isOpen();
if(count>0&&!isOpen){self.massActions.open()}else{if(count<=0&&isOpen){self.massActions.close()}}}});
this.ownObject(this.selectionBar);this.listWrapper=$("section.kb-simple-list",this.wrapper);DeskPRO_Window.getTabWatcher().addTabTypeWatcher("ticket",this);
this.addEvent("watchedTabActivated",function(tab){if(DeskPRO_Window.getTabWatcher().getTabType(tab)=="ticket"){self.initVisibleTicket()
}});this.addEvent("watchedTabDeactivated",function(tab){if(DeskPRO_Window.getTabWatcher().getTabType(tab)=="ticket"){self.removeVisibleTicket()
}});if(DeskPRO_Window.getTabWatcher().isTabTypeActive("ticket")){self.initVisibleTicket()}$("section.kb-simple-list",this.wrapper).on("click",".kb-insert-link",function(ev){ev.stopPropagation();
self.insertIntoTicket($(this).data("article-id"),"link")}).on("click",".kb-insert-content",function(ev){ev.stopPropagation();
self.insertIntoTicket($(this).data("article-id"),"content")});this.relatedContentList=new DeskPRO.Agent.PageHelper.RelatedContentList(this,{contentListEl:this.listWrapper});
this.ownObject(this.relatedContentList);this.sendContentLink=new DeskPRO.Agent.PageHelper.SendContentLink(this,{contentListEl:this.listWrapper});
this.ownObject(this.sendContentLink);var sortMenuBtn=$(".order-by-menu-trigger",this.wrapper).first();
this.sortingMenu=new DeskPRO.UI.Menu({triggerElement:sortMenuBtn,menuElement:$(".order-by-menu",this.wrapper).first(),onItemClicked:function(info){var item=$(info.itemEl);
var prop=item.data("order-by");var label=item.text().trim();$(".label",sortMenuBtn).text(label);var disOptWrap=self.displayOptions.getWrapperElement();
var sel=$("select.sel-order-by",disOptWrap);$("option",sel).prop("selected",false);$("option."+prop,sel).prop("selected",true);
self.displayOptions.saveAndRefresh()}});this.ownObject(this.sortingMenu);this.enableHighlightOpenRows("article","article_id","article.article-");
this.listNav=new DeskPRO.Agent.PageHelper.ListNav(this);this.massActions=new DeskPRO.Agent.PageHelper.MassActions(this,{isListView:false,applyAction:(this.massApplyAction).bind(this)});
DeskPRO.ElementHandler_Exec($("#kb-mass-action-overlay"));this._initCatEditor()},massApplyAction:function(wrapper,formData){var data=formData,myFormData=$("input, select",wrapper).serializeArray();
$(myFormData).each(function(index,param){data[param.name]=param.value});$.ajax({type:"POST",url:BASE_URL+"agent/kb/article/ajax-mass-save","data":data,"dataType":"json",success:(this.actionAppliedCallback).bind(this)})
},actionAppliedCallback:function(data){if(data&&data.success){var category=data.category;var section=DeskPRO_Window.sections.publish_section;
DeskPRO_Window.getSectionData("publish_section",function(data){(section._initSection.bind(section))(data);
$("#publish_outline_articlescat_list .kb-cat-"+category+" .is-nav-item").click()})}if(data.error){DeskPRO_Window.showAlert(data.error)
}},initVisibleTicket:function(){this.listWrapper.addClass("with-visible-ticket")},removeVisibleTicket:function(){this.listWrapper.removeClass("with-visible-ticket")
},insertIntoTicket:function(article_id,action){var ticketTab=DeskPRO_Window.getTabWatcher().getActiveTabIfType("ticket");
if(!ticketTab){return}var ticketPage=ticketTab.page;$.ajax({url:BASE_URL+"agent/kb/article/"+article_id+"/info",type:"GET",dataType:"json",success:function(data){if(action=="content"){ticketPage.appendToMessage(data.content,true)
}else{ticketPage.appendToMessage(data.permalink)}}})},_initCatEditor:function(){var self=this;var catEl=this.getEl("tab_cat");
if(!catEl[0]){return}var tree=this.getEl("cattree");var treeData=tree.data("treedata");var treeSave=this.getEl("cattree_struct");
tree.tree({data:treeData,dragAndDrop:true});tree.bind("tree.move",function(event){event.move_info.do_move();
treeSave.val(tree.tree("toJson"))});this.getEl("catfoot").find(".cat-save-trigger").on("click",function(ev){Orb.cancelEvent(ev);
var postData=catEl.find("input").serializeArray();self.getEl("catfoot").addClass("dp-loading-on");$.ajax({url:$(this).data("save-url"),data:postData,type:"POST",dataType:"json",complete:function(){self.getEl("catfoot").removeClass("dp-loading-on")
},success:function(){DeskPRO_Window.sections.publish_section.reload()}})});var delCat=this.getEl("del_cat");
delCat.find(".cat-del-trigger").on("click",function(ev){Orb.cancelEvent(ev);delCat.addClass("dp-loading-on");
$.ajax({url:$(this).data("save-url"),type:"POST",dataType:"json",complete:function(){delCat.removeClass("dp-loading-on")
},success:function(ret){if(ret.error_code&&ret.error_code=="not_empty"){DeskPRO_Window.showAlert("The category could not be deleted because it is not empty.");
return}DeskPRO_Window.sections.publish_section.reload();DeskPRO_Window.runPageRoute("listpane:"+BASE_URL+"agent/kb/list/0")
}})})}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");DeskPRO.Agent.PageFragment.ListPane.AgentChatHistory=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.Basic,initializeProperties:function(){this.parent();
this.wrapper=null;this.contentWrapper=null},initPage:function(el){DeskPRO_Window.getMessageBroker().sendMessage("agentchat-section.list-activated",{id:this.meta.agentId});
this.wrapper=$(el);this.contentWrapper=$("div.content:first",this.wrapper);this.enableHighlightOpenRows("agentchat","conversation_id",".row-item.convo-");
if(this.getMetaData("noResults")){this.noMoreResults=true;$(".no-more-results",this.contentWrapper).show()
}}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");DeskPRO.Agent.PageFragment.ListPane.AgentTeamChatHistory=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.Basic,initializeProperties:function(){this.parent();
this.wrapper=null;this.contentWrapper=null},initPage:function(el){DeskPRO_Window.getMessageBroker().sendMessage("agentchat-section.team-list-activated",{id:this.meta.agentTeamId});
this.wrapper=$(el);this.contentWrapper=$("div.content:first",this.wrapper);this.enableHighlightOpenRows("agentchat","conversation_id",".row-item.convo-");
if(this.getMetaData("noResults")){this.noMoreResults=true;$(".no-more-results",this.contentWrapper).show()
}}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");DeskPRO.Agent.PageFragment.ListPane.OpenChats=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.Basic,initPage:function(el){var self=this;
this.el=el;var agentId=this.meta.agent_id;var removeConvo=function(convoId){var row=$("article.convo-"+convoId);
row.slideUp("fast",function(){row.remove()})};var addConvo=function(convoId){DeskPRO_Window.loadRoute(self.meta.routeData)
};DeskPRO_Window.getMessageBroker().addMessageListener("chat.new",function(data){if(data.agent_id&&data.agent_id==agentId){addConvo(data.conversation_id)
}},this);DeskPRO_Window.getMessageBroker().addMessageListener("chat.reassigned",function(data){if(data.old_agent_id&&data.old_agent_id==agentId){removeConvo(data.conversation_id)
}else{if(data.agent_id&&data.agent_id==agentId){addConvo(data.conversation_id)}}},this);DeskPRO_Window.getMessageBroker().addMessageListener("chat.unassigned",function(data){if(data.old_agent_id&&data.old_agent_id==agentId){removeConvo(data.conversation_id)
}},this);DeskPRO_Window.getMessageBroker().addMessageListener("chat.ended",function(data){if(data.agent_id&&data.agent_id==agentId){removeConvo(data.conversation_id)
}},this);this.enableHighlightOpenRows("userchat","conversation_id",".row-item.convo-")}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");
DeskPRO.Agent.PageFragment.ListPane.UserChatFilter=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="chat-list";this.wrapper=null;this.contentWrapper=null;this.overlay=null;this.appendUrl=null;
this.actionsBarHelper=null;this.resultTypeName="filter";this.resultTypeId=0},initPage:function(el){var self=this;
this.el=el;this.enableHighlightOpenRows("userchat","conversation_id",".row-item.convo-");this.wrapper=$(el);
this.contentWrapper=$("div.content:first",this.wrapper);this.resultTypeId=this.meta.cache_id||0;if(this.getMetaData("noResults")){this.noMoreResults=true;
$(".no-more-results",this.contentWrapper).show()}var opt={resultIds:this.meta.resultIds,perPage:this.meta.perPage||50};
if(this.meta.viewType&&this.meta.viewType=="list"){opt.resultRowSelector="tr.row-item";opt.resultsContainer=$(".table-result-list table",el);
opt.navEl=$(".bottom-action-bar",el)}this.listNav=new DeskPRO.Agent.PageHelper.ListNav(this)}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");
DeskPRO.Agent.PageFragment.ListPane.FeedbackFilter=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.Basic,initializeProperties:function(){this.parent();
this.wrapper=null;this.filterSearchForm=null},initPage:function(el){var self=this;this.wrapper=el;this.displayOptions=new DeskPRO.Agent.PageHelper.DisplayOptions(this,{prefId:"feedback-filter",resultId:this.meta.resultId,refreshUrl:this.meta.refreshUrl,prefSaveResultId:"0"});
this.ownObject(this.displayOptions);this.selectionBar=new DeskPRO.Agent.PageHelper.SelectionBar(this,{});
this.ownObject(this.selectionBar);var sortMenuBtn=$(".order-by-menu-trigger",this.wrapper).first();this.sortingMenu=new DeskPRO.UI.Menu({triggerElement:sortMenuBtn,menuElement:$(".order-by-menu",this.wrapper).first(),onItemClicked:function(info){var item=$(info.itemEl);
var prop=item.data("order-by");var label=item.text().trim();$(".label",sortMenuBtn).text(label);var disOptWrap=self.displayOptions.getWrapperElement();
var sel=$("select.sel-order-by",disOptWrap);$("option",sel).prop("selected",false);$("option."+prop,sel).prop("selected",true);
self.displayOptions.saveAndRefresh()}});this.ownObject(this.sortingMenu);this.listWrapper=$("section.feedback-simple-list",this.wrapper);
this.relatedContentList=new DeskPRO.Agent.PageHelper.RelatedContentList(this,{contentListEl:this.listWrapper});
this.ownObject(this.relatedContentList);this.massActionsMenu=new DeskPRO.UI.Menu({triggerElement:$(".perform-actions-trigger:first",this.wrapper),menuElement:$(".actions-menu:first",this.wrapper),onItemClicked:function(info){var itemEl=$(info.itemEl);
var menuEl=itemEl.parent();var menuType=menuEl.data("menu-type");var postData=self.selectionBar.getCheckedFormValues("ids[]");
var removeFromList=false;var action="";switch(menuType){case"feedback-status-menu":action="set-status";
postData.push({name:"status",value:itemEl.data("option-value")});break;case"feedback-category-menu":action="set-category";
postData.push({name:"category_id",value:itemEl.data("category-id")});break;case"feedback-massactions-menu":switch(itemEl.data("action")){case"delete":action="set-status";
postData.push({name:"status",value:"hidden.deleted"});removeFromList=true;break;case"spam":action="set-status";
postData.push({name:"status",value:"hidden.spam"});removeFromList=true;break}break;default:return;break
}$.ajax({url:BASE_URL+"agent/feedback/filter/mass-actions/"+action,data:postData,type:"POST",dataType:"json",success:function(data){if(removeFromList){self.selectionBar.getChecked().parent().fadeOut("fast")
}self.selectionBar.checkNone();DeskPRO_Window.runPageRoute("listpane:"+self.meta.routeUrl);DeskPRO_Window.sections.feedback_section.reload()
}})}});this.ownObject(this.massActionsMenu);var opt={resultIds:this.meta.resultIds,perPage:this.meta.perPage||50,refreshMode:true,currentPage:this.meta.currentPage};
this.resultsHelper=new DeskPRO.Agent.PageHelper.Results(this,opt);this.ownObject(this.resultsHelper);
this.enableHighlightOpenRows("feedback","feedback_id","article.feedback-");this.listNav=new DeskPRO.Agent.PageHelper.ListNav(this)
}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");DeskPRO.Agent.PageFragment.ListPane.NewCustomFilter=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.Basic,initializeProperties:function(){this.parent();
this.wrapper=null;this.filterSearchForm=null},initPage:function(el){this.wrapper=el;this.topSection=$(".list-top-area",this.wrapper);
var criteriaList=$(".search-form",this.topSection);var criteriaTerms=$(".search-builder-tpl",this.topSection);
var editor=new DeskPRO.Form.RuleBuilder(criteriaTerms);$(".add-term",criteriaList).data("add-count",0).on("click",function(){var count=parseInt($(this).data("add-count"));
var basename="terms["+count+"]";$(this).data("add-count",count+1);editor.addNewRow($(".search-terms",criteriaList),basename)
});var searchDataEl=$(".search-form-data:first",this.topSection);if(searchDataEl.length){var searchData=searchDataEl.get(0).innerHTML;
searchData=$.parseJSON(searchData);if(searchData.terms){Array.each(searchData.terms,function(info,x){var basename="terms[initial_"+x+"]";
editor.addNewRow($(".search-terms",criteriaList),basename,{type:info.type,op:info.op,options:info.options})
})}if(searchData.order_by){$('[name="order_by"]',this.topSection).val(searchData.order_by)}searchDataEl.remove()
}var form=$("form.ticket-search-form",this.topSection);form.on("submit",function(ev){ev.preventDefault();
var url=form.attr("action");var data=form.serializeArray();DeskPRO_Window.loadListPane(url,{postData:data})
})}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");DeskPRO.Agent.PageFragment.ListPane.NewsList=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.Basic,initializeProperties:function(){this.parent();
this.wrapper=null},initPage:function(el){this.wrapper=el;this.displayOptions=new DeskPRO.Agent.PageHelper.DisplayOptions(this,{prefId:"news-filter",resultId:this.meta.resultId,refreshUrl:this.meta.refreshUrl,prefSaveResultId:"0"});
this.ownObject(this.displayOptions);this.selectionBar=new DeskPRO.Agent.PageHelper.SelectionBar(this,{});
this.ownObject(this.selectionBar);this.listWrapper=$("section.news-simple-list",this.wrapper);this.relatedContentList=new DeskPRO.Agent.PageHelper.RelatedContentList(this,{contentListEl:this.listWrapper});
this.ownObject(this.relatedContentList);this.enableHighlightOpenRows("news","news_id","article.news-");
this.listNav=new DeskPRO.Agent.PageHelper.ListNav(this);this._initCatEditor()},_initCatEditor:function(){var self=this;
var catEl=this.getEl("tab_cat");if(!catEl[0]){return}var tree=this.getEl("cattree");var treeData=tree.data("treedata");
var treeSave=this.getEl("cattree_struct");tree.tree({data:treeData,dragAndDrop:true});tree.bind("tree.move",function(event){event.move_info.do_move();
treeSave.val(tree.tree("toJson"))});this.getEl("catfoot").find(".cat-save-trigger").on("click",function(ev){Orb.cancelEvent(ev);
var postData=catEl.find("input").serializeArray();self.getEl("catfoot").addClass("dp-loading-on");$.ajax({url:$(this).data("save-url"),data:postData,type:"POST",dataType:"json",complete:function(){self.getEl("catfoot").removeClass("dp-loading-on")
},success:function(){DeskPRO_Window.sections.publish_section.reload()}})});var delCat=this.getEl("del_cat");
delCat.find(".cat-del-trigger").on("click",function(ev){Orb.cancelEvent(ev);delCat.addClass("dp-loading-on");
$.ajax({url:$(this).data("save-url"),type:"POST",dataType:"json",complete:function(){delCat.removeClass("dp-loading-on")
},success:function(ret){if(ret.error_code&&ret.error_code=="not_empty"){DeskPRO_Window.showAlert("The category could not be deleted because it is not empty.");
return}DeskPRO_Window.sections.publish_section.reload();DeskPRO_Window.runPageRoute("listpane:"+BASE_URL+"agent/kb/list/0")
}})})}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");DeskPRO.Agent.PageFragment.ListPane.DownloadList=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.Basic,initPage:function(el){var self=this;
this.wrapper=el;this.displayOptions=new DeskPRO.Agent.PageHelper.DisplayOptions(this,{prefId:"download-filter",resultId:this.meta.resultId,refreshUrl:this.meta.refreshUrl,prefSaveResultId:"0"});
this.ownObject(this.displayOptions);this.selectionBar=new DeskPRO.Agent.PageHelper.SelectionBar(this,{});
this.ownObject(this.selectionBar);this.listWrapper=$("section.downloads-simple-list",this.wrapper).on("click",".dl-insert-link",function(){self.insertIntoTicket($(this).data("download-id"),"link")
}).on("click",".dl-insert-attach",function(){self.insertIntoTicket($(this).data("download-id"),"attach")
});DeskPRO_Window.getTabWatcher().addTabTypeWatcher("ticket",this);this.addEvent("watchedTabActivated",function(tab){if(DeskPRO_Window.getTabWatcher().getTabType(tab)=="ticket"){self.initVisibleTicket()
}});this.addEvent("watchedTabDeactivated",function(tab){if(DeskPRO_Window.getTabWatcher().getTabType(tab)=="ticket"){self.removeVisibleTicket()
}});if(DeskPRO_Window.getTabWatcher().isTabTypeActive("ticket")){self.initVisibleTicket()}this.relatedContentList=new DeskPRO.Agent.PageHelper.RelatedContentList(this,{contentListEl:this.listWrapper});
this.ownObject(this.relatedContentList);var sortMenuBtn=$(".order-by-menu-trigger",this.wrapper).first();
this.sortingMenu=new DeskPRO.UI.Menu({triggerElement:sortMenuBtn,menuElement:$(".order-by-menu",this.wrapper).first(),onItemClicked:function(info){var item=$(info.itemEl);
var prop=item.data("order-by");var label=item.text().trim();$(".label",sortMenuBtn).text(label);var disOptWrap=self.displayOptions.getWrapperElement();
var sel=$("select.sel-order-by",disOptWrap);$("option",sel).prop("selected",false);$("option."+prop,sel).prop("selected",true);
self.displayOptions.saveAndRefresh()}});this.ownObject(this.sortingMenu);this.enableHighlightOpenRows("download","download_id","article.download-");
this.listNav=new DeskPRO.Agent.PageHelper.ListNav(this);this._initCatEditor()},initVisibleTicket:function(){this.listWrapper.addClass("with-visible-ticket")
},removeVisibleTicket:function(){this.listWrapper.removeClass("with-visible-ticket")},insertIntoTicket:function(download_id,action){var ticketTab=DeskPRO_Window.getTabWatcher().getActiveTabIfType("ticket");
if(!ticketTab){return}var ticketPage=ticketTab.page;$.ajax({url:BASE_URL+"agent/downloads/file/"+download_id+"/info",type:"GET",dataType:"json",success:function(data){if(action=="attach"){ticketPage.addAttachToList(data)
}else{ticketPage.appendToMessage(data.permalink)}}})},_initCatEditor:function(){var self=this;var catEl=this.getEl("tab_cat");
if(!catEl[0]){return}var tree=this.getEl("cattree");var treeData=tree.data("treedata");var treeSave=this.getEl("cattree_struct");
tree.tree({data:treeData,dragAndDrop:true});tree.bind("tree.move",function(event){event.move_info.do_move();
treeSave.val(tree.tree("toJson"))});this.getEl("catfoot").find(".cat-save-trigger").on("click",function(ev){Orb.cancelEvent(ev);
var postData=catEl.find("input").serializeArray();self.getEl("catfoot").addClass("dp-loading-on");$.ajax({url:$(this).data("save-url"),data:postData,type:"POST",dataType:"json",complete:function(){self.getEl("catfoot").removeClass("dp-loading-on")
},success:function(){DeskPRO_Window.sections.publish_section.reload()}})});var delCat=this.getEl("del_cat");
delCat.find(".cat-del-trigger").on("click",function(ev){Orb.cancelEvent(ev);delCat.addClass("dp-loading-on");
$.ajax({url:$(this).data("save-url"),type:"POST",dataType:"json",complete:function(){delCat.removeClass("dp-loading-on")
},success:function(ret){if(ret.error_code&&ret.error_code=="not_empty"){DeskPRO_Window.showAlert("The category could not be deleted because it is not empty.");
return}DeskPRO_Window.sections.publish_section.reload();DeskPRO_Window.runPageRoute("listpane:"+BASE_URL+"agent/downloads/list/0")
}})})}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");DeskPRO.Agent.PageFragment.ListPane.PublishListComments=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.Basic,initPage:function(el){var self=this;
this.wrapper=el;var btn=this.wrapper.find(".list-selection-bar .perform-actions-trigger");var load=this.wrapper.find(".list-selection-bar .ajax-loading");
this.actionsMenu=new DeskPRO.UI.Menu({menuElement:$("ul.actions-menu:first",this.wrapper),triggerElement:$(".perform-actions-trigger:first",this.wrapper),onItemClicked:function(info){var data=[];
var lines=[];$("input.item-select:checked",this.wrapper).each(function(){lines.push($(this).parent().get(0));
var typename=$(this).data("content-type");var id=$(this).data("comment-id");data.push({name:"content["+typename+"][]",value:id})
});if(!data.length){return}btn.hide();load.show();var action=$(info.itemEl).data("action");$.ajax({url:BASE_URL+"agent/publish/comments/validating-mass-actions/"+action,data:data,type:"POST",dataType:"json",complete:function(){load.hide();
btn.show()},success:function(){DeskPRO_Window.runPageRoute("listpane:"+BASE_URL+"agent/publish/comments/list/"+self.meta.viewType);
if(DeskPRO_Window.sections.publish_section){DeskPRO_Window.sections.publish_section.reload()}}})}});this.ownObject(this.actionsMenu);
this.selectionBar=new DeskPRO.Agent.PageHelper.SelectionBar(this,{onButtonClick:function(ev){self.actionsMenu.open(ev)
}});this.ownObject(this.selectionBar);var findRowInfo=function(el){var row=$(el);var editRow=$(el).closest("div.edit-comment");
if(editRow.length){var row=$("article."+editRow.data("content-type")+"-"+editRow.data("comment-id"));
return findRowInfo(row)}row=row.closest("article");var check=$("input.item-select",row);if(!check.length){return
}var info={row:row,contentType:$(check).data("content-type"),commentId:$(check).data("comment-id")};var editRow=$("div.edit-"+info.contentType+"-"+info.commentId,self.wrapper);
DP.console.log(editRow);info.editRow=editRow;return info};this.wrapper.on("click",".validate-approve",function(ev){ev.stopPropagation();
var info=findRowInfo(this);self.approveComment(info.contentType,info.commentId,info.row)});this.wrapper.on("click",".validate-delete",function(ev){ev.stopPropagation();
var info=findRowInfo(this);self.deleteComment(info.contentType,info.commentId,info.row)});this.wrapper.on("click",".validate-edit",function(ev){ev.stopPropagation();
var info=findRowInfo(this);self.editComment(info.contentType,info.commentId,info.row,info)});this.wrapper.on("click",".comment-editsave-trigger",function(ev){var info=findRowInfo(this);
var commentText=$("textarea",info.editRow).val().trim();if(!commentText.length){info.row.show();info.editRow.hide()
}$.ajax({url:BASE_URL+"agent/publish/comments/save-comment/"+info.contentType+"/"+info.commentId,type:"POST",data:{comment:commentText},dataType:"json",success:function(data){var rendered=$(".rendered",info.row);
rendered.html(data.comment_html);info.row.show();info.editRow.hide()}})});this.wrapper.on("click",".comment-editcancel-trigger",function(ev){var info=findRowInfo(this);
var editEl=info.editRow;info.row.show();editEl.hide()});this.wrapper.on("click",".validate-create-ticket",function(ev){var info=findRowInfo(this);
$.ajax({url:BASE_URL+"agent/publish/comments/new-ticket-info/"+info.contentType+"/"+info.commentId+".json",type:"GET",dataType:"json",success:function(data){DeskPRO_Window.newTicketLoader.open(function(page){page.setNewByComment(data)
})}})});DeskPRO_Window.getMessageBroker().addMessageListener("agent-ui.comment-remove",function(data){$("article."+data.comment_type+"-"+data.comment_id,this.wrapper).fadeOut()
})},deleteComment:function(typename,commentId,el){if(!el){el=$("article."+typename+"-"+commentId,this.wrapper)
}el.fadeOut();this.updateCount("sub");$.ajax({url:BASE_URL+"agent/publish/comments/delete/"+typename+"/"+commentId,type:"POST",context:this,dataType:"json",error:function(){this.updateCount("add");
el.fadeIn()},success:function(data){el.remove();if(DeskPRO_Window.sections.publish_section){DeskPRO_Window.sections.publish_section.modCommentCount(typename,"-")
}}})},approveComment:function(typename,commentId,el){if(!el){el=$("article."+typename+"-"+commentId,this.wrapper)
}el.fadeOut();this.updateCount("sub");$.ajax({url:BASE_URL+"agent/publish/comments/approve/"+typename+"/"+commentId,type:"POST",context:this,dataType:"json",error:function(){this.updateCount("add");
if(el){el.fadeIn()}},success:function(data){if(el){el.remove()}}})},editComment:function(typename,commentId,el,info){el.hide();
var editEl=info.editRow;editEl.show()},updateCount:function(action,num){var countEl=$("#publish_validating_comments_count");
var count=parseInt(countEl.text());num=num||1;if(action=="add"){count+=num}else{count-=num}if(count<0){count=0
}var countEl=$("#publish_validating_comments_count").text(count);DeskPRO_Window.sections.publish_section.recountBadge()
}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");DeskPRO.Agent.PageFragment.ListPane.PublishValidatingComments=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.Basic,initPage:function(el){var self=this;
this.wrapper=el;var btn=this.wrapper.find(".list-selection-bar .perform-actions-trigger");var load=this.wrapper.find(".list-selection-bar .ajax-loading");
this.actionsMenu=new DeskPRO.UI.Menu({menuElement:$("ul.actions-menu:first",this.wrapper),triggerElement:$(".perform-actions-trigger:first",this.wrapper),onItemClicked:function(info){var data=[];
var lines=[];$("input.item-select:checked",this.wrapper).each(function(){lines.push($(this).parent().get(0));
var typename=$(this).data("content-type");var id=$(this).data("comment-id");data.push({name:"content["+typename+"][]",value:id})
});if(!data.length){return}btn.hide();load.show();var action=$(info.itemEl).data("action");$.ajax({url:BASE_URL+"agent/publish/comments/validating-mass-actions/"+action,data:data,type:"POST",dataType:"json",complete:function(){load.hide();
btn.show()},success:function(){self.selectionBar.checkNone();self.updateCount("sub",lines.length);$(lines).fadeOut()
}})}});this.ownObject(this.actionsMenu);this.selectionBar=new DeskPRO.Agent.PageHelper.SelectionBar(this,{onButtonClick:function(ev){self.actionsMenu.open(ev)
}});this.ownObject(this.selectionBar);var findRowInfo=function(el){var row=$(el);var editRow=$(el).closest("div.edit-comment");
if(editRow.length){var row=$("article."+editRow.data("content-type")+"-"+editRow.data("comment-id"));
return findRowInfo(row)}row=row.closest("article");var check=$("input.item-select",row);if(!check.length){return
}var info={row:row,contentType:$(check).data("content-type"),commentId:$(check).data("comment-id")};var editRow=$("div.edit-"+info.contentType+"-"+info.commentId,self.wrapper);
DP.console.log(editRow);info.editRow=editRow;return info};this.wrapper.on("click",".validate-approve",function(ev){ev.stopPropagation();
var info=findRowInfo(this);self.approveComment(info.contentType,info.commentId,info.row)});this.wrapper.on("click",".validate-delete",function(ev){ev.stopPropagation();
var info=findRowInfo(this);self.deleteComment(info.contentType,info.commentId,info.row)});this.wrapper.on("click",".validate-edit",function(ev){ev.stopPropagation();
var info=findRowInfo(this);self.editComment(info.contentType,info.commentId,info.row,info)});this.wrapper.on("click",".comment-editsave-trigger",function(ev){var info=findRowInfo(this);
var commentText=$("textarea",info.editRow).val().trim();if(!commentText.length){info.row.show();info.editRow.hide()
}$.ajax({url:BASE_URL+"agent/publish/comments/save-comment/"+info.contentType+"/"+info.commentId,type:"POST",data:{comment:commentText},dataType:"json",success:function(data){var rendered=$(".rendered",info.row);
rendered.html(data.comment_html);info.row.show();info.editRow.hide()}})});this.wrapper.on("click",".comment-editcancel-trigger",function(ev){var info=findRowInfo(this);
var editEl=info.editRow;info.row.show();editEl.hide()});this.wrapper.on("click",".validate-create-ticket",function(ev){var info=findRowInfo(this);
$.ajax({url:BASE_URL+"agent/publish/comments/new-ticket-info/"+info.contentType+"/"+info.commentId+".json",type:"GET",dataType:"json",success:function(data){DeskPRO_Window.newTicketLoader.open(function(page){page.setNewByComment(data)
})}})});DeskPRO_Window.getMessageBroker().addMessageListener("agent-ui.comment-remove",function(data){$("article."+data.comment_type+"-"+data.comment_id,this.wrapper).fadeOut()
})},deleteComment:function(typename,commentId,el){if(!el){el=$("article."+typename+"-"+commentId,this.wrapper)
}el.fadeOut();this.updateCount("sub");$.ajax({url:BASE_URL+"agent/publish/comments/delete/"+typename+"/"+commentId,type:"POST",context:this,dataType:"json",error:function(){this.updateCount("add");
el.fadeIn()},success:function(data){el.remove();if(DeskPRO_Window.sections.publish_section){DeskPRO_Window.sections.publish_section.modCommentCount(typename,"-")
}}})},approveComment:function(typename,commentId,el){if(!el){el=$("article."+typename+"-"+commentId,this.wrapper)
}el.fadeOut();this.updateCount("sub");$.ajax({url:BASE_URL+"agent/publish/comments/approve/"+typename+"/"+commentId,type:"POST",context:this,dataType:"json",error:function(){this.updateCount("add");
if(el){el.fadeIn()}},success:function(data){if(el){el.remove()}}})},editComment:function(typename,commentId,el,info){el.hide();
var editEl=info.editRow;editEl.show()},updateCount:function(action,num){var countEl=$("#publish_validating_comments_count");
var count=parseInt(countEl.text());num=num||1;if(action=="add"){count+=num}else{count-=num}if(count<0){count=0
}var countEl=$("#publish_validating_comments_count").text(count);DeskPRO_Window.sections.publish_section.recountBadge()
}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");DeskPRO.Agent.PageFragment.ListPane.PublishValidatingContent=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.Basic,initPage:function(el){var self=this;
this.wrapper=el;DeskPRO_Window.getMessageBroker().addMessageListener("publish.validating.list-remove",function(info){var el=$("article."+info.typename+"-"+info.contentId).slideUp();
self.listRemove(el)});var btn=this.wrapper.find(".list-selection-bar .perform-actions-trigger");var load=this.wrapper.find(".list-selection-bar .ajax-loading");
this.actionsMenu=new DeskPRO.UI.Menu({menuElement:$("ul.actions-menu:first",this.wrapper),triggerElement:$(".perform-actions-trigger:first",this.wrapper),onItemClicked:function(info){var data=[];
var lines=[];$("input.item-select:checked",this.wrapper).each(function(){lines.push($(this).parent().get(0));
var typename=$(this).data("content-type");var id=$(this).data("content-id");data.push({name:"content["+typename+"][]",value:id})
});if(!data.length){return}var action=$(info.itemEl).data("action");btn.hide();load.show();var sendFn=function(){$.ajax({url:BASE_URL+"agent/publish/content/validating-mass-actions/"+action,data:data,type:"POST",dataType:"json",complete:function(){load.hide();
btn.show()},success:function(){$(lines).fadeOut().each(function(){self.listRemove($(this))})}})};if(action=="disapprove"){DeskPRO_Window.showPrompt("Enter a reason or comment to send to the authors",function(reason){data.push({name:"reason",value:reason});
sendFn()})}else{sendFn()}}});this.ownObject(this.actionsMenu);this.selectionBar=new DeskPRO.Agent.PageHelper.SelectionBar(this,{onButtonClick:function(ev){self.actionsMenu.open(ev)
}});this.ownObject(this.selectionBar);this.enableHighlightOpenRows("feedback","feedback_id",".row-item.feedback-")
},listRemove:function(el){DeskPRO_Window.util.modCountEl($("#publish_validating_count"),"-");DeskPRO_Window.sections.publish_section.recountBadge();
this.selectionBar.checkNone()}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");DeskPRO.Agent.PageFragment.ListPane.PublishDraftsList=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.Basic,initPage:function(el){var self=this;
this.wrapper=el;DeskPRO_Window.getMessageBroker().addMessageListener("publish.drafts.list-remove",function(info){$("article."+info.typename+"-"+info.contentId,this.wrapper).slideUp()
},this);this.actionsMenu=new DeskPRO.UI.Menu({triggerElement:$(".perform-actions-trigger:first",this.wrapper),menuElement:$("ul.actions-menu:first",this.wrapper),onItemClicked:function(info){var data=[];
var lines=[];$("input.item-select:checked",this.wrapper).each(function(){lines.push($(this).parent().get(0));
var typename=$(this).data("content-type");var id=$(this).data("content-id");if(typename&&id){data.push({name:"content["+typename+"][]",value:id})
}});if(!data.length){return}var action=$(info.itemEl).data("action");$.ajax({url:BASE_URL+"agent/publish/drafts/mass-actions/"+action,data:data,type:"POST",dataType:"json",context:this,success:function(data){self.selectionBar.checkNone();
if(data.affected){Array.each(data.affected,function(info){DeskPRO_Window.getMessageBroker().sendMessage("publish.drafts.list-remove",info)
},this)}}})}});this.ownObject(this.actionsMenu);this.selectionBar=new DeskPRO.Agent.PageHelper.SelectionBar(this,{onButtonClick:function(ev){self.actionsMenu.open(ev)
}});this.ownObject(this.selectionBar)}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");DeskPRO.Agent.PageFragment.ListPane.PublishSearch=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.Basic,initPage:function(el){var self=this;
this.wrapper=el;this.listWrapper=$("section.list-listing",this.wrapper);this.sendContentLink=new DeskPRO.Agent.PageHelper.SendContentLink(this,{contentListEl:this.listWrapper});
this.ownObject(this.sendContentLink)}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");DeskPRO.Agent.PageFragment.ListPane.FeedbackSearch=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.Basic,initPage:function(el){var self=this;
this.wrapper=el}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");DeskPRO.Agent.PageFragment.ListPane.PublishSearchLog=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="publish_searchlog"},initPage:function(el){this.tabs=new DeskPRO.UI.SimpleTabs({triggerElements:$("li",this.getEl("tabs"))});
this.ownObject(this.tabs)}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");DeskPRO.Agent.PageFragment.ListPane.FeedbackCommentsValidating=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.PublishValidatingComments,updateCount:function(action){var countEl=$("#feedback_comments_validating_count");
var count=parseInt(countEl.text());if(action=="add"){count++}else{count--}if(count<0){count=0}var countEl=$("#feedback_comments_validating_count").text(count);
DeskPRO_Window.sections.feedback_section.recountBadge()}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");
DeskPRO.Agent.PageFragment.ListPane.FeedbackContentValidating=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.PublishValidatingContent,listRemove:function(el){DeskPRO_Window.util.modCountEl($("#feedback_validating_count"),"-");
DeskPRO_Window.sections.feedback_section.recountBadge();this.selectionBar.checkNone()}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");
DeskPRO.Agent.PageFragment.ListPane.TaskList=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="task-list"},initPage:function(el){var self=this;if(DeskPRO_Window.sections.tasks_section){DeskPRO_Window.sections.tasks_section.doRelaodPage=false
}var control=new DeskPRO.Agent.PageHelper.TaskListControl(el,{menuVis:this.getEl("menu_vis"),assignOb:this.getEl("assign_ob"),completeCountEl:this.getEl("complete_count")});
control.addEvent("updateUi",function(){self.updateUi()})}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");
DeskPRO.Agent.PageFragment.ListPane.Search=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="search";this.wrapper=null},initPage:function(el){this.wrapper=el},initTypeList:function(listWrap){},loadMore:function(loadName){}});
Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");DeskPRO.Agent.PageFragment.ListPane.DealList=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="deal-list";this.resultTypeName="basic";this.resultTypeId="general"},initPage:function(el){var self=this;
var openForEl=null;this._initDisplayOptions();this.listWrapper=$("section.deal-simple-list",this.wrapper);
this.relatedContentList=new DeskPRO.Agent.PageHelper.RelatedContentList(this,{contentListEl:this.listWrapper});
this.ownObject(this.relatedContentList)},_initDisplayOptions:function(){var self=this;var sortMenuBtn=$(".order-by-menu-trigger",this.wrapper).first();
this.sortingMenu=new DeskPRO.UI.Menu({triggerElement:sortMenuBtn,menuElement:$(".order-by-menu",this.wrapper).first(),onItemClicked:function(info){var item=$(info.itemEl);
var prop=item.data("order-by");var label=item.text().trim();$(".label",sortMenuBtn).text(label);var url=self.meta.refreshUrl;
url=Orb.appendQueryData(url,"order_by",prop);DeskPRO_Window.loadListPane(url)}});this.ownObject(this.sortingMenu);
var groupMenuBtn=$(".group-by-menu-trigger",this.wrapper).first();this.groupingMenu=new DeskPRO.UI.Menu({triggerElement:groupMenuBtn,menuElement:$(".group-by-menu",this.wrapper).first(),onItemClicked:function(info){var item=$(info.itemEl);
var prop=item.data("group-by");var label=item.text().trim();$(".label",groupMenuBtn).text(label);var url=self.meta.refreshUrl;
url=Orb.appendQueryData(url,"group_by",prop);DeskPRO_Window.loadListPane(url)}});this.ownObject(this.groupingMenu);
this.displayOptions=new DeskPRO.Agent.PageHelper.DisplayOptions(this,{prefId:"deal-filter",refreshUrl:this.meta.refreshUrl});
this.ownObject(this.displayOptions)}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");DeskPRO.Agent.PageFragment.ListPane.TwitterFollowers=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.Basic,initPage:function(el){this.wrapper=$(el);
this.content=$(".content",this.wrapper);var self=this;this.meta.fetchResultsUrl=this.meta.listUrl;DeskPRO_Window.getMessageBroker().sendMessage("twitter-section.list-activated",{listUrl:this.meta.listUrl});
var helper=new DeskPRO.Agent.PageHelper.Twitter(this.content,this,{messageUrl:this.getMetaData("saveUserMessageUrl"),userArchiveHideCallback:function(row){var pageHelper=self.resultsHelper,page=pageHelper.getCurrentPage(),numPages=pageHelper.getNumPages();
pageHelper.adjustResultCount(-1);if(page<numPages){var data={};data.last=1;data.page=page;setTimeout(function(){$.ajax({url:self.getMetaData("listUrl"),dataType:"html",data:data,success:function(html){var $html=$(html);
self.content.find(".followers-list").append($html)}})},200)}else{if(pageHelper.resultCount<=0){self.wrapper.find(".list-listing.no-results").show();
self.wrapper.find(".results-nav").hide()}}}});this.content.find("textarea").TextAreaExpander();var opt={perPage:this.meta.perPage||25,currentPage:this.meta.currentPage,totalCount:this.meta.totalCount,resultRowSelector:"article.twitter-user",resultsContainer:this.content};
this.resultsHelper=new DeskPRO.Agent.PageHelper.Results(this,opt);this.ownObject(this.resultsHelper)}});
Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");DeskPRO.Agent.PageFragment.ListPane.TwitterStatus=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.Basic,initializeProperties:function(){this.parent();
this.TYPENAME="twitter-status-list";this.countReflected={}},initPage:function(el){this.wrapper=$(el);
var self=this;DeskPRO_Window.getMessageBroker().sendMessage("twitter-section.list-activated",{listUrl:this.meta.statusListUrl});
this.meta.fetchResultsUrl=this.meta.statusListUrl;this.header=$(".header",this.wrapper);this.content=$(".content",this.wrapper);
this.twitterHelper=new DeskPRO.Agent.PageHelper.Twitter(this.content,this,{statusArchiveHideCallback:function(row){var id=parseInt(row.data("status-id"),10);
if(id&&!self.countReflected[id]){self.countReflected[id]=true;self.resultsHelper.adjustResultCount(-1)
}self._afterTweetRemoved(0)}});this._initHeader();this._initContent(this.content);this._initControls(this.content);
this.wrapper.on("click",".new-tweet-list-indicator",function(){self.reload()});var opt={perPage:this.meta.perPage||25,currentPage:this.meta.currentPage,totalCount:this.meta.totalCount,resultRowSelector:"article.twitter-status",resultsContainer:this.content,preFetchCallback:function(data){$.each(self._getDisplayOptions(),function(k,v){if(/boolean|number|string/.test(typeof v)){data.push({name:k,value:v})
}else{$.each(v,function(kk,vv){data.push({name:k+"["+kk+"]",value:vv})})}});return data},onPostSetNewResults:function(x,y,results){self._afterLoading(results)
}};this.resultsHelper=new DeskPRO.Agent.PageHelper.Results(this,opt);this.ownObject(this.resultsHelper);
DeskPRO_Window.getMessageBroker().addMessageListener("agent.tweet-added",function(data){self.adjustTweetCountsFromClientMessage(data,1);
self.adjustShownTweetsForTweetAdded(data);self.countReflected={}});DeskPRO_Window.getMessageBroker().addMessageListener("agent.tweet-updated",function(data){if(data.trigger_user_id&&data.trigger_user_id==DESKPRO_PERSON_ID){return
}if(typeof data.change_archived!=="undefined"){if(data.change_archived){self.adjustTweetCountsFromClientMessage(data,-1)
}else{self.adjustTweetCountsFromClientMessage(data,1)}}else{if(data.deleted){self.adjustTweetCountsFromClientMessage(data,-1)
}}self.adjustShownTweetsForTweetUpdated(data);self.countReflected={}})},adjustTweetCountsFromClientMessage:function(data,adjustAmount){var accountId=data.account_id;
if(this.countReflected[data.account_status_id]){return}if(this._tweetAppliesToPage(data)&&this.resultsHelper&&this.resultsHelper.options){this.countReflected[data.account_status_id]=true;
this.resultsHelper.adjustResultCount(adjustAmount)}},adjustShownTweetsForTweetAdded:function(data){if(this.content.find(".twitter-status-"+data.account_status_id).length){return
}if(!this.resultsHelper||!this.resultsHelper.options){return}if(this._tweetAppliesToPage(data)){if(this.resultsHelper.getCurrentPage()>1){this.adjustNewTweetIndicator(1)
}else{this.addTweetToPage(data.account_status_id,data.tweet_html)}}},adjustNewTweetIndicator:function(adjust){var newIndicator=this.wrapper.find(".new-tweet-list-indicator");
var newCount=(newIndicator.data("new-count")||0)+adjust;newIndicator.data("new-count",newCount);newIndicator.text(newCount==1?"1 new tweet":newCount+" new tweets").show()
},_tweetAppliesToPage:function(data){if(!this.meta.accountId||this.meta.accountId!=data.account_id){return false
}if(data.is_from_self){return(this.menuOptions.filter("[name=account]").is(":checked")||this.meta.listRoute=="agent_twitter_sent_list")
}var isInInbox=($.inArray(data.status_type,["direct","reply","mention","retweet"])!==-1||data.is_favorited);
switch(this.meta.listRoute){case"agent_twitter_mine_list":if(data.assignment!=="agent:"+DESKPRO_PERSON_ID){return false
}break;case"agent_twitter_team_list":var hasOwnTeam=false;for(var i=0;i<DESKPRO_TEAM_IDS.length;i++){var teamId=DESKPRO_TEAM_IDS[i];
if(data.assignment==="agent_team:"+teamId){hasOwnTeam=true;break}}if(!hasOwnTeam){return false}break;
case"agent_twitter_unassigned_list":if(data.assignment!==""){return false}if(!isInInbox){return false
}break;case"agent_twitter_all_list":if(!isInInbox){return false}break;case"agent_twitter_timeline_list":if(data.status_type!=="timeline"){return false
}break;case"agent_twitter_sent_list":return false;case"agent_twitter_run_search":return false;default:return false
}if(this.meta.group){switch(this.meta.group){case"type":if(this.meta.groupValue=="favorite"){if(!data.is_favorited){return false
}}else{if(data.status_type!==this.meta.groupValue){return false}}break;case"agent":if(data.agent_id!=this.meta.groupValue){return false
}break;case"team":if(data.agent_team_id!=this.meta.groupValue){return false}break}}return true},adjustShownTweetsForTweetUpdated:function(data){var row=this.content.find(".twitter-status-"+data.account_status_id);
if(row.length){if(typeof data.change_archived!=="undefined"){var showArchived=this.menuOptions.filter("[name=archived]").is(":checked");
if(data.change_archived&&!showArchived){this.removeTweetFromPage(data.account_status_id)}}if(data.deleted){this.removeTweetFromPage(data.account_status_id)
}if(data.reply_added_html&&data.reply_added_id){if(!row.find(".twitter-reply-"+data.reply_added_id).length){var html=$(data.reply_added_html);
row.find(".twitter-replies").append(html);$(".timeago",html).timeago();row.find(".reply-list").show()
}}if(data.note_added_html&&data.note_added_id){if(!row.find(".twitter-note-"+data.note_added_id).length){var html=$(data.note_added_html);
row.find(".note-list").append(html);$(".timeago",html).timeago();row.find(".status-notes").show()}}if(data.edited_html){row.find(".main-status-body .status-text").html(data.edited_html)
}if(data.retweeted){var link=row.find("li.opt-trigger.retweet, li.opt-trigger.retweeted");link.addClass("retweeted").removeClass("retweet");
link.find("label").text("Retweeted")}if(data.unretweeted){var link=row.find("li.opt-trigger.retweet, li.opt-trigger.retweeted");
link.addClass("retweet").removeClass("retweeted");link.find("label").text("Retweet")}if(data.favorited){row.find(".add-favorite, .favorited").addClass("favorited").removeClass("add-favorite")
}if(data.unfavorited){row.find(".add-favorite, .favorited").addClass("add-favorite").removeClass("favorited")
}if(typeof data.change_assignment!=="undefined"){var opt=row.find('.agents_sel option[value="'+data.change_assignment+'"]');
if(opt.length){opt.closest("select").val(data.change_assignment);var label=opt.text().trim();if(data.change_assignment=="agent:"+DESKPRO_PERSON_ID){label="Me"
}var labelEl=row.find("li.opt-trigger.agent label");if(data.assignment_picture){labelEl.text(" "+label).prepend($('<img class="agent-assign-icon" />').attr("src",data.assignment_picture))
}else{labelEl.text(label)}}}}else{if(typeof data.change_archived!=="undefined"&&!data.change_archived){if(this.resultsHelper.getCurrentPage()==1){this.addTweetToPage(data.account_status_id,data.tweet_html)
}}}if(this.content.find(".twitter-reply-"+data.account_status_id).length){if(data.deleted){this.removeReplyFromPage(data.account_status_id)
}if(data.edited_html){var row=this.content.find(".twitter-reply-"+data.account_status_id);row.find(".status-text").html(data.edited_html)
}}},addTweetToPage:function(account_status_id,html){if(!this.resultsHelper||!this.resultsHelper.options){return
}if(!this.countReflected[account_status_id]){this.resultsHelper.adjustResultCount(1);this.countReflected[account_status_id]=true
}var $html=$(html);this.content.find(".twitter-status-list").prepend($html);this._afterLoading($html);
this.adjustShownTweets()},adjustShownTweets:function(){var count=this.resultsHelper.updateShowingCount();
if(count===false){return}if(count==0){this.wrapper.find(".list-listing.no-results").show()}else{this.wrapper.find(".list-listing.no-results").hide()
}if(count>this.resultsHelper.options.perPage){$(this.resultsHelper.options.resultRowSelector,this.resultsHelper.resultsContainer).slice(this.resultsHelper.options.perPage-count).remove();
this.resultsHelper.updateShowingCount()}},removeTweetFromPage:function(account_status_id){var el=this.content.find(".twitter-status-"+account_status_id).filter(":not(:animated)");
if(el.length){el.remove();if(!this.countReflected[account_status_id]){this.resultsHelper.adjustResultCount(-1);
this.countReflected[account_status_id]=true}this._afterTweetRemoved(0)}},removeReplyFromPage:function(account_status_id){var el=this.content.find(".twitter-reply-"+account_status_id);
if(el.length){var row=this.twitterHelper.closestRow(el);el.remove();if(!row.find(".twitter-replies .twitter-reply").length){row.find(".reply-list").hide()
}}},_afterTweetRemoved:function(delay){var pageHelper=this.resultsHelper,page=pageHelper.getCurrentPage(),numPages=pageHelper.getNumPages();
var self=this;if(!this.resultsHelper||!this.resultsHelper.options){return}pageHelper.updateShowingCount();
if(page<numPages){var data=this._getDisplayOptions();data.last=1;data.page=page;setTimeout(function(){$.ajax({url:self.getMetaData("statusListUrl"),dataType:"html",data:data,success:function(html){var $html=$(html);
self.content.find(".twitter-status-list").append($html);self._afterLoading($html)}})},delay||0)}else{if(pageHelper.resultCount<=0){this.wrapper.find(".list-listing.no-results").show();
this.wrapper.find(".results-nav").hide()}}},_afterLoading:function(content){if(!content){content=this.content
}this._initContent(content);this._initControls(content);this.wrapper.find(".new-tweet-list-indicator").data("new-count",0).hide();
if(this.selectionBar){this.selectionBar.updateCount()}if(this.resultsHelper&&this.resultsHelper.options){this.resultsHelper.updateShowingCount()
}},_initHeader:function(){this._initSortByFields();this._initIncludeFields();var self=this;this.selectionBar=new DeskPRO.Agent.PageHelper.SelectionBar(this,{onButtonClick:function(){self.massActions.open()
},onCountChange:function(count){var isOpen=self.massActions.isOpen();if(count>0&&!isOpen){self.massActions.open()
}else{if(count<=0&&isOpen){self.massActions.close()}}},checkSelector:".twitter-status:not(.archived) input.item-select"});
this.ownObject(this.selectionBar);this.massActions=new DeskPRO.Agent.PageHelper.MassActions(this,{isListView:false,applyAction:function(wrapper,formData){var data=formData,myFormData=$("input, textarea, select",wrapper).serializeArray();
$(myFormData).each(function(index,param){data[param.name]=param.value});wrapper.addClass("loading");$.ajax({type:"POST",url:BASE_URL+"agent/twitter/status/ajax-mass-save.json","data":data,"dataType":"json",success:function(){self.massActions.close();
self.reload()}}).done(function(){wrapper.removeClass("loading")})},closeOnApply:false,openAction:function(wrapper){if(!wrapper.data("twitter-helper")){wrapper.data("twitter-helper",new DeskPRO.Agent.PageHelper.Twitter($("#twitter-mass-action-overlay"),self))
}}});this.ownObject(this.massActions)},_initContent:function(content){var self=this;$(".timeago",content).timeago();
var list=content.find(".twitter-status-list");if(list.length&&list.data("page")&&this.resultsHelper){this.resultsHelper.setPage(parseInt(list.data("page"),10),true);
this.resultsHelper.setResultCount(parseInt(list.data("total-count"),10))}},_initControls:function(content){},_initSortByFields:function(){var self=this;
var sortMenuBtn=$(".order-by-menu-trigger",this.header).first();this.sortingMenu=new DeskPRO.UI.Menu({triggerElement:sortMenuBtn,menuElement:$(".order-by-menu",this.header).first(),onItemClicked:function(info){var item=$(info.itemEl);
var prop=item.data("order-by");var label=item.find(".label").text().trim();$(".label label",sortMenuBtn).text(label);
sortMenuBtn.find(".order-dir").hide();sortMenuBtn.find(".order-dir."+prop.split("_").pop()).show();sortMenuBtn.data("dir",prop);
self.sortingMenu.close();self.reload()}});this.ownObject(this.sortingMenu)},_initIncludeFields:function(){var self=this;
this.menuOptions=this.header.find(".btn-controls input:checkbox");this.menuOptions.click(function(){self.reload()
})},_getDisplayOptions:function(){var options={include:{}};if(this.menuOptions){this.menuOptions.each(function(){var field=$(this);
options.include[field.attr("name")]=field.attr("checked")?1:0})}return options},reload:function(){$.ajax({url:this.getMetaData("statusListUrl"),dataType:"html",data:this._getDisplayOptions(),context:this,success:function(html){this.content.html(html);
this._afterLoading()}})},highlightStatus:function(id){$(".twitter-status",this.content).removeClass("highlight");
$(".status-"+id,this.content).addClass("highlight")},downlightStatus:function(id){$(".twitter-status-"+id,this.content).removeClass("highlight")
}});Orb.createNamespace("DeskPRO.Agent.PageFragment.ListPane");DeskPRO.Agent.PageFragment.ListPane.TwitterSearch=new Orb.Class({Extends:DeskPRO.Agent.PageFragment.ListPane.TwitterStatus,initPage:function(el){var self=this;
this.parent(el);this.maxTwitterId=el.find(".twitter-status-list").attr("data-twitter-max-id");this.updateInterval=setInterval(function(){$.ajax({url:self.meta.statusListUrl,data:{since_id:self.maxTwitterId},dataType:"html",success:function(html){var $html=$(html).first();
if($html.data("added")){self.maxTwitterId=$html.attr("data-twitter-max-id");self.resultsHelper.adjustResultCount($html.data("added"));
if(self.resultsHelper.getCurrentPage()>1){self.adjustNewTweetIndicator($html.data("added"))}else{var adding=$html.find(".row-item.twitter-status");
self.content.find(".twitter-status-list").prepend(adding);self._afterLoading(adding);self.adjustShownTweets()
}}}})},60*1000)},destroy:function(){clearInterval(this.updateInterval)}});Orb.createNamespace("DeskPRO.Agent.ElementHandler");
DeskPRO.Agent.ElementHandler.FormSaver=new Orb.Class({Extends:DeskPRO.ElementHandler,init:function(){var self=this;
this.textarea=$("textarea",this.el);this.inout=$("input:text",this.el);this.list=null;this.resultHtmlKey=this.el.data("form-result-html-key")||"html";
if(this.el.data("form-list-selector")){this.list=this.el.closest(this.el.data("form-list-selector"))}DP.console.log(this.list);
this.url=this.el.data("form-save-url");this.statusSave=$("header .save",this.el);this.statusSaved=$("header .saved",this.el);
this.statusSaving=$("header .is-loading",this.el);this.statusSave.on("click",function(ev){ev.preventDefault();
self.save()});this.textarea.on("change",this.touch.bind(this));this.textarea.on("keypress",this.touch.bind(this));
this.inout.on("change",this.touch.bind(this));this.inout.on("keypress",this.touch.bind(this));this.countEl=null;
if(this.el.data("form-count-el")){this.countEl=$(this.el.data("form-count-el"))}},touch:function(){this.statusSave.show();
this.statusSaved.hide();this.statusSaving.hide()},save:function(){this.statusSave.hide();this.statusSaved.hide();
this.statusSaving.show();var formEls=$("input, textarea, select",this.el);var postData=formEls.serializeArray();
var doSend=true;var checkBlankEls=formEls.filter("[data-not-blank]").each(function(){if($(this).val().trim()===""){doSend=false;
return false}});if(!doSend){this.statusSave.hide();this.statusSaved.hide();this.statusSaving.hide();return
}$.ajax({url:this.url,type:"POST",data:postData,dataType:"json",context:this,complete:function(){this.statusSave.hide();
this.statusSaved.show();this.statusSaving.hide();window.setTimeout((function(){this.statusSaved.fadeOut("slow")
}).bind(this),1000)},success:function(data){if(data.error){return}if(this.list){var newRow=$(data[this.resultHtmlKey]);
DeskPRO_Window.initInterfaceServices(newRow);if(this.el.parent().get(0)==this.list.get(0)){newRow.insertBefore(this.el)
}else{this.list.append(newRow)}this.textarea.val("")}if(this.countEl){DeskPRO_Window.util.modCountEl(this.countEl,"+")
}}})}});Orb.createNamespace("DeskPRO.Agent.ElementHandler");DeskPRO.Agent.ElementHandler.TicketReplyBox=new Orb.Class({Extends:DeskPRO.ElementHandler,init:function(){this.baseId=this.el.data("base-id");
this.agentNotifyListShown=false},initPage:function(){var self=this;this.page=this.el.closest(".with-page-fragment").data("page-fragment");
this.lang=eval(this.el.data("dp-lang")||"{}");var textarea=this.getElById("replybox_txt"),isWysiwyg=false;
this.textarea=textarea;this.isNote=false;var snippetBtn=null;var closeTabCheck=this.getElById("close_tab_opt");
var closeReply=this.el.data("close-reply")?true:false;var closeNote=this.el.data("close-note")?true:false;
var agentSel=this.getElById("agent_sel");var agentSelText=this.getElById("agent_sel_text");var agentSelCheck=this.getElById("agent_sel_check");
var teamSel=this.getElById("agent_team_sel");var teamSelText=this.getElById("agent_team_sel_text");var teamSelCheck=this.getElById("agent_team_sel_check");
if(DeskPRO_Window.canUseAgentReplyRte()){var sig=this.el.find("textarea.signature-value-html").val()||"";
sig=sig.replace(/<div class="dp-signature-start">([\w\W]*)<\/div>/,'<p class="dp-signature-start">$1</p>');
var draft=this.getElById("draft_html");if(draft.length){textarea.val(draft.val())}else{if(sig){textarea.val(($.browser.msie?"<p></p><p></p>":"<p><br></p><p><br></p>")+"\n\n"+sig)
}}isWysiwyg=true;DeskPRO_Window.initRteAgentReply(textarea,{defaultIsHtml:true,inlineHiddenPosition:this.getElById("is_html_reply"),autosaveContent:"ticket",minHeight:120,autosaveContentId:(this.page?this.page.meta.ticket_id:false),focusCallback:function(){if(!self.page.hasReplyFocused){self.wrapper.find("div.layout-content").trigger("goscrolltop")
}self.page.hasReplyFocused=true},preAutosaveCallback:function(textarea,data){if(self.getElById("reply_is_trans").val()!=""){var newContent=textarea.data("redactor").getCode(),name=textarea.attr("name");
data=[];data.push({name:name,value:newContent})}data.push({name:"extras[is_note]",value:self.isNote?1:0});
self.el.find('input[name="attach[]"]').each(function(){data.push({name:"extras[attach][]",value:$(this).val()})
});self.el.find('input[name="blob_inline_ids[]"]').each(function(){data.push({name:"extras[blob_inline_ids][]",value:$(this).val()})
});return data},callback:function(obj){obj.addBtnFirst("dp_attach","Click here to attach a file. You may also drag a file from your computer desktop into this reply area to upload attachments faster.",function(){});
obj.addBtnAfter("dp_attach","dp_snippets","Open snippets",function(){});obj.addBtnSeparatorAfter("dp_attach");
snippetBtn=obj.$toolbar.find(".redactor_btn_dp_snippets").closest("li");var snippets_html=self.lang.snippets_btn;
snippets_html=snippets_html.replace(/Ss/,'<span class="show-key-shortcut">S</span>');snippetBtn.addClass("snippets").find("a").html(snippets_html);
var attachBtn=obj.$toolbar.find(".redactor_btn_dp_attach").closest("li");attachBtn.addClass("attach");
attachBtn.find("a").text(self.lang.attach_btn).append('<input type="file" class="file" name="file-upload" />');
obj.addBtnSeparatorAfter("dp_snippets")}});this.getElById("is_html_reply").val(1);if(textarea.data("redactor")){var ed=textarea.getEditor();
var lastH=ed.height();if(DESKPRO_ENABLE_KB_SHORTCUTS){ed.on("keyup",function(ev){var isCtrl=false;if(ev.ctrlKey&&DeskPRO_Window.keyboardShortcuts.isMac){isCtrl=true
}else{if(ev.altKey){isCtrl=true}}if(isCtrl){if(isCtrl&&(ev.which==85)){ev.preventDefault();self.page.shortcutReplySetAwaitingUser();
return}if(isCtrl&&(ev.which==65)){ev.preventDefault();self.page.shortcutReplySetAwaitingAgent();return
}if(isCtrl&&(ev.which==68)){ev.preventDefault();self.page.shortcutReplySetResolved();return}if(isCtrl&&(ev.which==82)){ev.preventDefault();
self.page.shortcutSendReply();return}if(isCtrl&&(ev.which==83)){ev.preventDefault();window.setTimeout(function(){self.page.shortcutOpenSnippets()
},10);return}if(isCtrl&&(ev.which==79)){ev.preventDefault();window.setTimeout(function(){self.page.shortcutReplyOpenProperties()
},10);return}}})}var heightUp=function(){textarea.addClass("touched");if(self.page&&lastH!=ed.height()){var newH=ed.height();
var hDiff=newH-lastH;lastH=newH;if(!self.page.meta.ticket_reverse_order){self.page.doScrollBottom=true
}window.setTimeout(function(){if(self.page){var sEl=self.page.wrapper.find(".layout-content").first().find(".scroll-viewport").first();
if(sEl&&sEl[0]){sEl.get(0).scrollTop=sEl.get(0).scrollTop+hDiff}var focus=textarea.getObject().getFocus();
if(focus&&focus[0]){if(focus[0].nodeType==3){var focusEl=$(focus[0].parentNode)}else{var focusEl=$(focus[0])
}var focusPos=focusEl.offset();if(focusPos.top+focusEl.height()>$("#dp_window").height()){self.page.updateUi(newH)
}}else{self.page.updateUi()}}},60)}};ed.on("paste",function(ev){heightUp()});ed.on("keypress change",function(){heightUp()
});this._initAgentNotifier(textarea)}}else{var sig=this.el.find("textarea.signature-value").val();if(sig){textarea.val("\n\n"+sig)
}textarea.data("expander-max-height",$(window).height()-500).TextAreaExpander(150,$(window).height()-500).on("textareaexpander_expanded",function(){var h=$(this).height();
window.setTimeout(function(){if(self.page&&$(window).height()-500>h){if(!self.page.meta.ticket_reverse_order){self.page.wrapper.find("div.layout-content").trigger("goscrollbottom")
}}},250)});textarea.on("keypress change",function(){$(this).addClass("touched")})}var translateControls=this.el.find(".translate-controls");
if(translateControls[0]){var transTrigger=translateControls.find(".trans-trigger");translateControls.find("select").on("change",function(ev){var langId=$(this).val();
var langTitle=$.trim($(this).find(":selected").text());transTrigger.find(".translate-lang").data("locale",langId).text(langTitle)
});transTrigger.on("click",function(ev){Orb.cancelEvent(ev);self.refreshMessageTranslation(transTrigger.find(".translate-lang").data("locale"))
});var textarea2=self.getElById("replybox_txt2");DeskPRO_Window.initRteAgentReply(textarea2,{defaultIsHtml:true,minHeight:120,callback:function(obj){obj.addBtn("dp_cancel_trans","Cancel message translation",function(){self.closeMessageTranslation()
});obj.setBtnRight("dp_cancel_trans");var cancelTransBtn=obj.$toolbar.find(".redactor_btn_dp_cancel_trans").closest("li");
cancelTransBtn.addClass("cancel_trans");cancelTransBtn.find("a").text("Cancel Translation")}});self.page.getEl("value_form").find(".language_id").on("change",function(){var langId=$(this).val();
if(!langId){langId=DESKPRO_DEFAULT_LANG_ID}var langLocale=DESKPRO_NAME_REGISTRY.lang_data[langId].locale;
var langTitle=$.trim(DESKPRO_NAME_REGISTRY.lang_data[langId].title);transTrigger.find(".translate-lang").data("locale",langLocale).text(langTitle)
})}var wasAgentChecked=agentSelCheck.prop("checked");var wasTeamChecked=teamSelCheck.prop("checked");
var storedReplyText="";var storedNoteText="";var replyMode="reply";this.getElById("replybox_replytab_btn").on("click",function(){if(replyMode=="reply"){return
}replyMode="reply";self.el.removeClass("dp-note-on");$(this).addClass("on");self.getElById("replybox_notetab_btn").removeClass("on");
$(".hide-note:not(.is-hidden)",self.el).show();$(".hide-reply",self.el).hide();self.getElById("is_note").val("0");
self.isNote=false;self.hideAgentNotifyList();if(closeReply){closeTabCheck.prop("checked",true)}else{closeTabCheck.prop("checked",false)
}if(wasAgentChecked){agentSelCheck.prop("checked",true)}if(wasTeamChecked){teamSelCheck.prop("checked",true)
}if(isWysiwyg&&textarea.data("redactor")){storedNoteText=textarea.getCode();textarea.setCode(storedReplyText||"")
}else{storedNoteText=textarea.val();textarea.val(storedReplyText||"")}if(self.page){var scroller=self.page.wrapper.find("div.layout-content");
scroller.data("scroll_handler").updateSize();if(!self.page.meta.ticket_reverse_order){scroller.trigger("goscrollbottom")
}}});this.getElById("replybox_notetab_btn").on("click",function(){if(replyMode=="note"){return}replyMode="note";
self.el.addClass("dp-note-on");$(this).addClass("on");self.getElById("replybox_replytab_btn").removeClass("on");
$(".hide-note",self.el).hide();$(".hide-reply",self.el).show();self.getElById("is_note").val("1");self.isNote=true;
self.hideAgentNotifyList();if(closeNote){closeTabCheck.prop("checked",true)}else{closeTabCheck.prop("checked",false)
}if(isWysiwyg&&textarea.data("redactor")){storedReplyText=textarea.getCode();textarea.setCode(storedNoteText||"")
}else{storedReplyText=textarea.val();textarea.val(storedNoteText||"")}wasAgentChecked=agentSelCheck.prop("checked");
wasTeamChecked=teamSelCheck.prop("checked");agentSelCheck.prop("checked",false);teamSelCheck.prop("checked",false);
if(self.page){var scroller=self.page.wrapper.find("div.layout-content");scroller.data("scroll_handler").updateSize();
if(!self.page.meta.ticket_reverse_order){scroller.trigger("goscrollbottom")}}});if(this.el.data("default-is-note")=="1"){this.el.addClass("dp-note-on");
this.getElById("replybox_notetab_btn").addClass("on");this.getElById("replybox_replytab_btn").removeClass("on");
$(".hide-note",this.el).hide();$(".hide-reply",this.el).show();this.getElById("is_note").val("1");this.isNote=true;
this.hideAgentNotifyList()}this.el.find(".expander").on("click",function(){var target=self.el.find($(this).data("target"));
if(target.is(":visible")){$(this).removeClass("expanded").addClass("is-hidden");target.slideUp("fast")
}else{$(this).addClass("expanded").removeClass("is-hidden");target.slideDown("fast")}});var cc_add_wrap=this.getElById("newcc");
var cc_del_wrap=this.getElById("delcc");var cc_row=this.getElById("cc_row");var cc_input=this.getElById("cc_input");
var cc_user_rows=this.getElById("cc_user_rows");cc_row.autoCompleteElement=new DeskPRO.Agent.ElementHandler.SimpleAutoComplete(cc_row);
this.ccRowTpl="";var ccRemoveFunction=function(){var row=$(this).closest(".cc-user-row");var input=$('<input type="hidden" />');
input.attr("name","delcc[]");input.val(row.data("email-address"));cc_del_wrap.append(input);row.remove()
};$(".user-rows",cc_row).on("click",".remove-row-trigger",ccRemoveFunction);$(".cc-saverow-trigger",cc_row).on("click",function(ev){var user_row=$(self.ccRowTpl);
var email=$("input.user-part",cc_row).val().trim();var parts=email.split("@");if(email==""||parts.length!=2||!parts[0]||!parts[1]||email.indexOf(",")!=-1){return
}var input=$('<input type="hidden" />');input.attr("name","addcc[]");input.val(email);$("input.user-part",cc_row).val("");
cc_add_wrap.append(input);var newrow=$("<li />").addClass("cc-user-row").data("email",email);newrow.append('<span class="btn-small-remove remove-row-trigger" />');
var span=$('<span class="user-email" />');span.text(email);newrow.append(" ");newrow.append(span);cc_user_rows.append(newrow);
ev.stopPropagation();cc_row.autoCompleteElement.close()});DeskPRO_Window.util.fileupload(this.el,{dropZone:this.getElById("file_drop_zone"),uploadTemplate:$(".template-upload",this.el),downloadTemplate:$(".template-download",this.el)});
this.el.bind("fileuploaddone",function(){self.getElById("attach_row").show().removeClass("is-hidden");
if(self.page){self.page.updateUi();if(!self.page.meta.ticket_reverse_order){if(self.page.scrollHandlers&&self.page.scrollHandlers[0]){$(self.page.scrollHandlers[0]).data("scroll_handler").getElement().trigger("goscrollbottom_stick")
}}}});this.el.bind("fileuploadstart",function(){self.getElById("attach_row").show().removeClass("is-hidden");
if(self.page){self.page.updateUi();if(self.page.scrollHandlers&&self.page.scrollHandlers[0]){if(!self.page.meta.ticket_reverse_order){$(self.page.scrollHandlers[0]).data("scroll_handler").getElement().trigger("goscrollbottom_stick")
}}}});this.el.on("click",".remove-attach-trigger",function(){var row=$(this).closest("li");row.fadeOut("fast",function(){row.remove();
var rows=$("ul.files li",self.getElById("attach_row"));if(!rows.length){self.getElById("attach_row").hide().addClass("is-hidden");
if(self.page){self.page.updateUi();if(!self.page.meta.ticket_reverse_order){if(self.page.scrollHandlers&&self.page.scrollHandlers[0]){$(self.page.scrollHandlers[0]).data("scroll_handler").getElement().trigger("goscrollbottom_stick")
}}}}})});$(".option-buttons",this.el).on("click","li.toggle",function(){if($(this).hasClass("keep_open_toggle")){return
}var check=$(":checkbox",this);if(!check.length){return}if(check.is(":checked")){check.attr("checked",false);
$(this).removeClass("on")}else{check.attr("checked",true);$(this).addClass("on")}});this.snippetsViewer=new DeskPRO.Agent.Widget.SnippetViewer({driver:DeskPRO_Window.ticketSnippetDriver,triggerElement:snippetBtn,onBeforeOpen:function(){if(isWysiwyg&&textarea.data("redactor")){try{textarea.data("redactor").saveSelection()
}catch(e){}}},onSnippetClick:function(info){if(!self.page){return}var ticketLangId=self.page.getEl("value_form").find(".language_id").val();
var snippetId=info.snippetId;var snippetCode=info.snippetCode;var agentText;var defaultText;var wantText;
var useText;var result;Array.each(snippetCode,function(info){if(info.value){if(info.language_id==ticketLangId){wantText=info.value
}if(info.language_id==DESKPRO_PERSON_LANG_ID){agentText=info.value}if(info.language_id==DESKPRO_DEFAULT_LANG_ID){defaultText=info.value
}useText=info.value}});if(wantText){useText=wantText}else{if(agentText){useText=agentText}else{if(defaultText){useText=defaultText
}}}try{var tpl=twig({data:useText,strict_variables:false});if(tpl){result=tpl.render({ticket:self.page.meta.api_data},{strict_variables:false})
}else{result=useText}}catch(e){console.log("Snippet render failed: %o",e);result=useText}if(isWysiwyg&&textarea.data("redactor")){try{textarea.data("redactor").restoreSelection();
textarea.data("redactor").setBuffer()}catch(e){}var html=result;html=html.replace(/<\/p>\s*<p>/g,"<br/>");
html=html.replace(/^<p>/,"");html=html.replace(/<\/p>$/,"");textarea.data("redactor").insertHtml(html)
}else{self.page.insertTextInReply(result)}self.snippetsViewer.close()}});self.wasSnippetOpen=false;this.el.bind("page_deactivate",function(){if(self.snippetsViewer&&self.snippetsViewer.pop&&self.snippetsViewer.pop.isOpen()){self.snippetsViewer.close();
self.wasSnippetOpen=true}});this.el.bind("page_activate",function(){if(self.wasSnippetOpen){self.snippetsViewer.open()
}});if(textarea.data("redactor")){var ed=textarea.getEditor();var api=textarea.data("redactor");var te=new DeskPRO.TextExpander({textarea:ed,onCombo:function(combo,ev){combo=combo.replace(/%/g,"");
if(window.DESKPRO_TICKET_SNIPPET_SHORTCODES&&window.DESKPRO_TICKET_SNIPPET_SHORTCODES[combo]){ev.preventDefault();
var snippetId=window.DESKPRO_TICKET_SNIPPET_SHORTCODES[combo];var focus=api.getFocus(),focusNode=$(focus[0]),testText;
if(focus[0].nodeType==3){testText=focusNode.text().substring(0,focus[1])}else{focus[0]=focusNode.contents().get(focus[1]-1);
focusNode=$(focus[0]);testText=focusNode.text();focus[1]=testText.length}var lastAt=testText.lastIndexOf("%"),matches=[];
if(lastAt!=-1){api.setSelection(focus[0],lastAt,focus[0],focus[1])}var editable=$.browser.webkit?' contenteditable="false"':"";
api.insertHtml('<span class="editor-inserting-var snippet-'+snippetId+'" '+editable+' data-snippet-id="'+snippetId+'">Inserting snippet...</span>');
if(!self.page){self.page=self.el.closest(".with-page-fragment").data("page-fragment")}if(self.page){self.page.pauseSend=true
}$.ajax({url:BASE_URL+"agent/text-snippets/tickets/"+snippetId+".json",dataType:"json",complete:function(){if(self.page){self.page.pauseSend=false
}},success:function(data){var snippet=data.snippet;var ticketLangId=self.page?self.page.getEl("value_form").find(".language_id").val():0;
var snippetId=snippet.id;var snippetCode=snippet.snippet;var agentText;var defaultText;var wantText;var useText;
var result;Array.each(snippetCode,function(info){if(info.language_id==ticketLangId){wantText=info.value
}if(info.language_id==DESKPRO_PERSON_LANG_ID){agentText=info.value}if(info.language_id==DESKPRO_DEFAULT_LANG_ID){defaultText=info.value
}useText=info.value});if(wantText){useText=wantText}else{if(agentText){useText=agentText}else{if(defaultText){useText=defaultText
}}}try{var tpl=twig({data:useText,strict_variables:true});if(tpl){result=tpl.render({ticket:self.page?self.page.meta.api_data:{}},{strict_variables:true})
}else{result=useText}}catch(e){console.log("Snippet render failed: %o",e);result=useText}var data=result;
var el=api.$editor.find(".editor-inserting-var.snippet-"+snippetId);data=$("<div>"+data+"</div>");var coll=data.find("> br");
coll.last().remove();var cursor=$('<span class="_cursor"></span>');var cursorPos=data.find("> p");if(!cursorPos[0]){cursorPos=data
}el.after(data);cursorPos.append(cursor);el.remove();var next=data.next();if(next.is("br")){next.remove()
}if(cursor.next().is("br")){cursor.next().remove()}if(cursor.prev().is("br")){cursor.prev().remove()}api.setSelection(cursor[0],0,cursor[0],0);
api.syncCode()}})}}})}var statusDetailEl=this.getElById("status_detail");this.statusMenu=new DeskPRO.UI.Menu({triggerElement:$(".status-trigger",statusDetailEl),menuElement:this.getElById("status_menu"),onItemClicked:function(info){var item=$(info.itemEl);
var val=item.data("status");if(val=="no-change"){self.getElById("ticket_do_status").val(0);statusDetailEl.removeClass("changed")
}else{$(".new-val-label",statusDetailEl).text(item.text().trim());self.getElById("ticket_do_status").val(1);
self.getElById("ticket_status").val(val);statusDetailEl.addClass("changed")}}});window.setTimeout(function(){DP.select(agentSel);
DP.select(teamSel)},150);agentSel.on("change",function(){var option=agentSel.find(":selected");agentSelText.text(option.data("name-short"));
agentSelText.css("background-image","url("+option.data("icon")+")");agentSelCheck.prop("checked",true);
if(agentSel.data("auto-switch-status")){if(agentSelCheck.get(0).checked){if(self.getElById("action").val().indexOf("macro")===-1){self.setReplyAsOptionName("awaiting_agent")
}}}});teamSel.on("change",function(){teamSelText.text($(this).find(":selected").text());teamSelCheck.prop("checked",true)
});var option=agentSel.find(":selected");agentSelText.text(option.data("name-short"));agentSelText.css("background-image","url("+option.data("icon")+")");
teamSelText.text(teamSel.find(":selected").text());if(agentSel.data("auto-switch-status")){agentSelCheck.on("change",function(){if(agentSelCheck.get(0).checked){if(self.getElById("action").val().indexOf("macro")===-1){self.setReplyAsOptionName("awaiting_agent")
}}})}this.el.on("submit",function(ev){ev.preventDefault();ev.stopPropagation()});this.el.find(".submit-trigger").on("click",function(ev){ev.preventDefault();
ev.stopPropagation();if(isWysiwyg&&textarea.data("redactor")){textarea.data("redactor").syncCode()}if(isWysiwyg){var copy=$.trim(self.el.find(".editor-row").find(".redactor_editor").text()).replace(/\s/g," ");
var tmp=$("<div/>").html(self.el.find("textarea.signature-value-html").val());var sig=$.trim(tmp.text()).replace(/\s/g," ");
if(!copy||copy==sig){DeskPRO_Window.showAlert("Please enter a message.");return}}self.getElById("action").val(self.getElById("reply_as_type").data("type"));
var formData=self.el.serializeArray();self.el.trigger("replyboxsubmit",[formData,self])});this.getElById("keep_open_toggle").on("click",function(ev){ev.preventDefault();
if($(this).hasClass("radio-on")){$(this).removeClass("radio-on on")}else{$(this).addClass("radio-on on")
}});var statusMenuTrigger=this.el.find(".status-menu-trigger");var footerEl=this.el.find("footer").first();
var statusMenu=this.getElById("status_menu");var statusMenuH=null;var statusBackdrop=null;var statusMacroFilter=null;
var statusMacroList=statusMenu.find(".macro-list");var statusMacroListMap=null;var statusListItems=null;
var replyAsType=this.getElById("reply_as_type");var closeStatusMenu=function(){statusBackdrop.hide();
statusMenu.hide()};var updateStatusPos=function(){statusMenuH=statusMenu.height();if(statusMenu>500){statusMenu.find("macro-list").css("max-height",500).css("overflow","auto");
statusMenuH=500}var pos=footerEl.offset();statusMenu.css({left:pos.left+6,top:pos.top-statusMenuH+3})
};var openStatusMenu=function(){statusListItems=statusMenu.find("li[data-type]").not(".off");if(!statusBackdrop){statusBackdrop=$('<div class="backdrop"></div>');
statusBackdrop.appendTo("body");statusBackdrop.on("click",function(ev){ev.stopPropagation();closeStatusMenu()
});statusMenu.detach().appendTo("body");statusMacroFilter=statusMenu.find(".macro-filter");statusMenu.on("click","li[data-type]",function(ev){ev.stopPropagation();
self.setReplyAsOption($(this));closeStatusMenu()});statusMacroFilter.on("keyup",function(ev){var isCtrl=false;
if(ev.ctrlKey&&DeskPRO_Window.keyboardShortcuts.isMac){isCtrl=true}else{if(ev.altKey){isCtrl=true}}if(isCtrl){if(isCtrl&&(ev.which==85)){closeStatusMenu();
self.page.shortcutReplySetAwaitingUser();return}if(isCtrl&&(ev.which==65)){closeStatusMenu();self.page.shortcutReplySetAwaitingAgent();
return}if(isCtrl&&(ev.which==68)){closeStatusMenu();self.page.shortcutReplySetResolved();return}}if(ev.keyCode==13){ev.preventDefault();
var current=statusListItems.filter(".cursor");if(current[0]){self.setReplyAsOption(current);closeStatusMenu()
}}else{if(ev.keyCode==27){ev.preventDefault();closeStatusMenu()}else{if(ev.keyCode==40||ev.keyCode==38){ev.preventDefault();
var dir=ev.keyCode==40?"down":"up";var current=statusListItems.filter(".cursor");if(!current.length){if(dir=="down"){statusListItems.first().addClass("cursor")
}else{statusListItems.last().addClass("cursor")}}else{var nextIndex=statusListItems.index(current);if(dir=="down"){nextIndex++
}else{nextIndex--}if(nextIndex<0){nextIndex=statusListItems.length-1}else{if(nextIndex>(statusListItems.length-1)){nextIndex=0
}}current.removeClass("cursor");statusListItems.eq(nextIndex).addClass("cursor")}}}}});statusMacroFilter.on("keyup",function(){var val=$.trim($(this).val());
if(!val){statusMacroList.find("li").show().removeClass("off");updateStatusPos()}else{var lis=statusMacroList.find("li");
var lis_show=[];val=val.toLowerCase();if(window.DESKPRO_MACRO_LABELS){if(!statusMacroListMap){statusMacroListMap={};
for(var i=0;i<window.DESKPRO_MACRO_LABELS.length;i++){statusMacroListMap[window.DESKPRO_MACRO_LABELS[i][0]]=document.getElementById(self.baseId+"_res_ticketmacro_"+window.DESKPRO_MACRO_LABELS[i][0])
}}for(var i=0;i<window.DESKPRO_MACRO_LABELS.length;i++){if(window.DESKPRO_MACRO_LABELS[i][1].indexOf(val)!==-1){if(statusMacroListMap[window.DESKPRO_MACRO_LABELS[i][0]]){lis_show.push(statusMacroListMap[window.DESKPRO_MACRO_LABELS[i][0]])
}else{lis_show.push(document.getElementById(self.baseId+"_res_ticketmacro_"+window.DESKPRO_MACRO_LABELS[i][0]))
}}}if(lis_show.length){if(lis_show.length<lis.length){lis.not(lis_show).addClass("off").hide()}$(lis_show).removeClass("off").show()
}else{lis.addClass("off").hide()}}else{statusMacroList.find("li").each(function(){if($(this).text().toLowerCase().indexOf(val)!==-1){$(this).show().removeClass("off")
}else{$(this).hide().addClass("off")}})}updateStatusPos()}statusListItems=statusMenu.find("li[data-type]").not(".off");
if(!statusListItems.filter(".cursor")[0]){statusMenu.find("li.cursor").removeClass("cursor");statusListItems.first().addClass("cursor")
}})}var type=replyAsType.data("type");statusMenu.find("li").removeClass("cursor").filter("[data-type]").removeClass("on").filter('[data-type="'+type+'"]').addClass("on");
var w=self.getElById("reply_btn_group").width()-3;if(w<200){w=200}statusMenu.width(w);statusBackdrop.show();
updateStatusPos();statusMenu.show();statusMacroFilter.focus()};this.openStatusMenu=openStatusMenu;statusMenuTrigger.on("click",function(ev){ev.preventDefault();
openStatusMenu()});$("#settingswin").on("dp_macros_updated",function(ev){Array.each(ev.macroItems,function(info){var has=statusMacroList.find(".res-ticketmacro-"+info.id);
if(has[0]){return}var li=$('<li><div class="on-icon"><i class="icon-okay"></i></div><span class="macro-title"></span></li>');
if(self.page){li.data("get-macro-url",BASE_URL+"agent/tickets/"+self.page.meta.ticket_id+"/ajax-get-macro?macro_id="+info.id+"&macro_reply_context=1")
}li.data("label","Send Reply and "+info.title);li.data("type","macro:"+info.id);li.attr("data-type","macro:"+info.id);
li.find(".macro-title").text(info.title);statusMacroList.append(li)})});if(this.page){this.page.setTicketReplyBox(this);
if(agentSel.val()==this.page.getEl("value_form").find(".agent_id").val()){agentSelCheck.prop("checked",false)
}if(teamSel.val()==this.page.getEl("value_form").find(".agent_team_id").val()){teamSelCheck.prop("checked",false)
}}if(!window.DESKPRO_MACRO_LABELS){window.DESKPRO_MACRO_LABELS=[];statusMacroListMap={};statusMacroList.find("li").each(function(){var label=$(this).data("macro-title").toLowerCase();
var macro_id=parseInt($(this).data("macro-id"));window.DESKPRO_MACRO_LABELS.push([macro_id,label.toLowerCase()]);
statusMacroListMap[macro_id]=this})}if(this.el.hasClass("dp-note-on")){this.getElById("replybox_notetab_btn").click()
}},setReplyAsOptionName:function(name){var item=this.getElById("status_menu").find('li[data-type="'+name+'"]').first();
if(item[0]){this.setReplyAsOption(item)}},setReplyAsOption:function(item){var replyAsType=this.getElById("reply_as_type");
var html=Orb.escapeHtml(item.data("label"));html=html.replace(/^Send Reply/,'Send <span class="show-key-shortcut">R</span>eply');
replyAsType.data("type",item.data("type")).html(html);var macroUrl=item.data("get-macro-url");var textarea=this.textarea;
var api=this.textarea.data("redactor");if(this.el.data("resolve-auto-close")){if(item.data("type")=="resolved"){this.getElById("close_tab_opt").prop("checked",true)
}}if(!macroUrl){this.getElById("actions_row").hide();if(this.page){this.page.updateUi();if(!this.page.meta.ticket_reverse_order){this.page.wrapper.find("div.layout-content").trigger("goscrollbottom")
}}}else{var actionsRow=this.getElById("actions_row");var actionsRowList=actionsRow.find("ul");actionsRowList.empty();
actionsRowList.append('<li class="load"><i class="flat-spinner"></i></li>');actionsRow.show();if(this.page){this.page.updateUi();
if(!this.page.meta.ticket_reverse_order){this.page.wrapper.find("div.layout-content").trigger("goscrollbottom")
}}$.ajax({url:macroUrl,type:"GET",context:this,dataType:"json",success:function(data){actionsRowList.empty();
Array.each(data.descriptions,function(desc){var li=$("<li />");li.html(desc);actionsRowList.append(li)
});var sig=null;if(api){sig=api.$editor.find(".dp-signature-start");if(!sig[0]){sig=null}}actionsRowList.find(".with-reply, .with-snippet").each(function(){var pos=$(this).data("reply-pos");
var html=$(this).find(".reply-text").get(0).innerHTML;if(pos){if(api){if(pos=="overwrite"){api.$editor.html(html);
if(sig){api.$editor.append(sig)}}else{if(pos=="prepend"){api.$editor.prepend(html)}else{if(sig){var usesig=sig;
var prev=sig.prev();if(prev[0]&&prev.is("p")&&$.trim(prev.text())===""){usesig=prev;var prev2=prev.prev();
if(prev2[0]&&prev2.is("p")&&$.trim(prev2.text())===""){prev2.remove()}}usesig.before(html)}else{api.$editor.append(html)
}}}api.syncCode()}else{var text=$("<div>"+html+"</div>");text=text.text().trim();textarea.val($.trim(textarea.val()+"\n\n"+text))
}}});var agentId=parseInt(actionsRowList.find(".with-agent").data("agent-id"));if(agentId){if(agentId==-1){agentId=DESKPRO_PERSON_ID
}this.getElById("agent_sel").select2("val",agentId);this.getElById("agent_sel").change()}var agentTeamId=parseInt(actionsRowList.find(".with-agent-team").data("agent-team-id"));
if(agentTeamId){if(agentTeamId==-1){if(!window.DESKPRO_TEAM_IDS||!window.DESKPRO_TEAM_IDS.length){agentTeamId=null
}else{agentTeamId=window.DESKPRO_TEAM_IDS[0]}}if(agentTeamId){this.getElById("agent_team_sel").select2("val",agentTeamId);
this.getElById("agent_team_sel").change()}}if(actionsRowList.find(".with-close-tab")){this.getElById("close_tab_opt").prop("checked",true)
}if(this.page){this.page.updateUi();if(!this.page.meta.ticket_reverse_order){this.page.wrapper.find("div.layout-content").trigger("goscrollbottom")
}}}})}if(this.page){this.page.focusOnReply()}},hideAgentNotifyList:function(){DeskPRO_Window.hideAgentNotifyList(this)
},_initAgentNotifier:function(textarea){DeskPRO_Window.initAgentNotifierForRte(this,textarea,this.page&&this.page.meta.agentMap?this.page.meta.agentMap:false)
},getElById:function(id){var el=$("#"+this.baseId+"_"+id);return el},addCc:function(email){var input=$(".token-input input",this.getElById("cc_input"));
input.val(email).focus().blur()},removeCc:function(email){$(".token-x",this.getElById("cc_input")).each(function(){if($(this).data("for-value")==email){$(this).click()
}})},appendToMessage:function(content){var textarea=this.getElById("replybox_txt");var isWysiwyg=textarea.data("redactor")?true:false;
var sig=this.getElById("signature_value").val();if(isWysiwyg){sig=DP.convertTextToWysiwygHtml(sig,true);
content=DP.convertTextToWysiwygHtml(content,true);var val=textarea.getCode();if(val=="<p></p>"||val=="<p><br></p>"){val=""
}}else{var val=textarea.val()}if(val.trim().length){if(sig.length&&val.indexOf(sig,val.length-sig.length)!==-1){val=content+val
}else{val+=" ";val+=content}}else{val=content}if(isWysiwyg){textarea.setCode(val)}else{textarea.val(val)
}},refreshMessageTranslation:function(to){var self=this;var previewRow=this.el.find(".translate-row");
if(!to){this.closeMessageTranslation();return}var formData={from:"me",to:to,message_text:this.getElById("replybox_txt").val()};
var translateControls=this.el.find(".translate-controls");translateControls.addClass("dp-loading-on");
$.ajax({url:window.DESKPRO_TRANSLATE_SERVICE.translate_text_url,data:formData,type:"POST",dataType:"json",complete:function(){translateControls.removeClass("dp-loading-on")
},success:function(data){previewRow.show();self.getElById("replybox_txt2").data("redactor").setCode(formData.message_text);
self.getElById("replybox_txt").data("redactor").setCode(data.message);self.getElById("reply_is_trans").val(to)
}})},closeMessageTranslation:function(){var previewRow=this.el.find(".translate-row");previewRow.hide();
this.getElById("replybox_txt").data("redactor").setCode(this.getElById("replybox_txt2").data("redactor").getCode());
this.getElById("replybox_txt2").data("redactor").setCode("");this.getElById("reply_is_trans").val("")
},destroy:function(){var textarea=this.getElById("replybox_txt");if(textarea.data("redactor")){try{textarea.destroyEditor()
}catch(e){}}if(this.agentNotifyList){this.agentNotifyList.remove()}if(this.snippetsViewer){this.snippetsViewer.destroy()
}}});Orb.createNamespace("DeskPRO.Agent.ElementHandler");DeskPRO.Agent.ElementHandler.TicketCcManage=new Orb.Class({Extends:DeskPRO.ElementHandler,initPage:function(){var self=this;
var addUrl=this.el.data("add-url");this.deleteUrl=this.el.data("delete-url");var list=$("ul",this.el).first();
var newrow=$("li.newrow",this.el);this.el.find("li").each(function(){self.initRow($(this))});var addRow=$(".addrow",this.el);
if(addRow.length){addRow.autoCompleteElement=new DeskPRO.Agent.ElementHandler.SimpleAutoComplete(addRow);
addRow.on("click",".cc-saverow-trigger",function(ev){var email=$("input",addRow).val().trim();if(!email){return
}addRow.addClass("loading");$.ajax({url:addUrl,type:"POST",data:{email_address:email},dataType:"json",complete:function(){addRow.removeClass("loading")
},success:function(data){if(data.error){if(data.error_code=="invalid_email"){DeskPRO_Window.showAlert("Please enter a valid email address")
}else{if(data.error_code=="invalid_email_gatewayaccount"){DeskPRO_Window.showAlert("The email address you entered belongs to a an account in Admin > Tickets > Email Accounts. You cannot add email accounts as CCs.")
}else{if(data.error_code=="is_agent"){DeskPRO_Window.showAlert('The user you specified is an agent. To add an agent to this ticket, use the "Add a follower" button in the Properties box.');
self.el.closest(".tabViewDetailContent").find("ul.cc-row-list").each(function(){$(this).empty().html(data.cc_list||"");
$(this).find("li").each(function(){self.initRow($(this))})})}}}return}if(data.is_dupe){DeskPRO_Window.showAlert("The user you specified is already on this ticket.");
return}addRow.find("input").val("");self.el.find("ul.cc-row-list").each(function(){$(this).empty().html(data.cc_list||"");
$(this).find("li").each(function(){self.initRow($(this))})})}})})}},initRow:function(row){var self=this;
row.find(".remove-row-trigger").on("click",function(ev){ev.stopPropagation();ev.preventDefault();var personId=row.data("person-id");
var email=row.data("email-address");if(personId){$.ajax({url:self.deleteUrl,type:"POST",data:{person_id:personId},dataType:"json",success:function(data){self.el.closest(".tabViewDetailContent").find("ul.cc-row-list").each(function(){$(this).empty().html(data.cc_list||"");
self.el.find("ul.cc-row-list").each(function(){$(this).empty().html(data.cc_list||"");$(this).find("li").each(function(){self.initRow($(this))
})})})},error:function(){row.show()}});row.fadeOut("fast")}row.fadeOut("fast",function(){row.remove()
})})}});Orb.createNamespace("DeskPRO.Agent.ElementHandler");DeskPRO.Agent.ElementHandler.SimpleAutoComplete=new Orb.Class({Extends:DeskPRO.ElementHandler,initPage:function(){var self=this;
this.searchUrl=BASE_URL+"agent/people-search/search-quick?format=json&limit=10&start_with=a";this.el.on("click",".cc-people-search-trigger",function(){self.open()
})},_initResultsBox:function(){var self=this;if(this._hasInitResultsBox){return}this._hasInitResultsBox=true;
this.termInput=$(".cc-people-search-trigger",this.el);this.resultsBox=$(".person-search-box",this.el);
this.resultsList=$(".results-list",this.resultsBox);this.addButton=$(".cc-saverow-trigger",this.el);this.tplHtml=DeskPRO_Window.util.getPlainTpl($(".user-row-tpl",this.el.parent()));
var updateCaller=this.updateCaller=new DeskPRO.TouchCaller({timeout:500,callback:(this.updateResults).bind(this),context:this});
this.termInput.on("keypress",function(ev){if(ev.keyCode==27){self.close.bind(self)}else{if(ev.keyCode==13){ev.preventDefault();
var current=$("li.on",self.resultsList);if(current.length){var personId=current.data("person-id");var name=$(".user-name",current).text().trim();
var email=$(".user-email",current).text().trim();self.termInput.val(email);self.el.trigger("personsearchboxclick",[personId,name,email,self])
}else{var term=self.getTerm();self.el.trigger("personsearchboxclicknew",[term,self])}self.addButton.click();
self.close()}else{if(ev.keyCode==40||ev.keyCode==38){ev.preventDefault();var dir=ev.keyCode==40?"down":"up";
var current=$("li.on",self.resultsList);$("li",self.resultsList).removeClass("on");if(!current.length){if(dir=="down"){$("li",self.resultsList).first().addClass("on")
}else{$("li",self.resultsList).last().addClass("on")}}else{if(dir=="down"){var next=current.next("li");
if(!next.length){next=$("li",self.resultsList).first()}}else{var next=current.prev("li");if(!next.length){next=$("li",self.resultsList).last()
}}next.addClass("on")}}else{updateCaller.touch(self.getTerm())}}}}).on("change",function(){updateCaller.touch(self.getTerm())
});this.termInput.on("click",function(ev){self.open();ev.stopPropagation()});this.resultsBox.on("click",function(ev){ev.stopPropagation()
});$(document).on("click",this.close.bind(this));this.resultsList.on("click","li",function(ev){ev.preventDefault();
var email=$(".user-email",this).text().trim();self.termInput.val(email);self.addButton.click();self.close()
});this.resultsBox.detach().hide().appendTo("body")},reset:function(){if(this.runningAjax){this.runningAjax.abort();
this.runningAjax=null}this.termInput.val("");this.resultsList.empty()},refreshPosition:function(){var termPos=this.termInput.offset();
var termW=this.termInput.outerWidth();var termH=this.termInput.outerHeight();this.resultsBox.css({top:termPos.top+termH-1,left:termPos.left,width:termW,position:"absolute",zIndex:"1000"})
},getTerm:function(){return this.termInput.val().trim()},updateResults:function(){var term=this.getTerm();
var postData=[];postData.push({name:"term",value:term});this.runningAjax=$.ajax({type:"GET",url:this.searchUrl,data:postData,dataType:"json",context:this,complete:function(){this.runningAjax=null
},success:function(data){var currentPersonId=parseInt($("li.on",this.resultsList).data("person-id"))||0;
this.resultsList.empty();Array.each(data,function(user){var row=$(this.tplHtml);row.data("person-id",user.id);
row.attr("person-id",user.id);row.addClass("person-"+user.id);if(currentPersonId&&currentPersonId==parseInt(user.id)){row.addClass("on");
currentPersonId=false}if(this.el.data("highlight-term")){var term=Orb.escapeHtml(this.getTerm());var name=Orb.escapeHtml(user.name);
var email=Orb.escapeHtml(user.email);term=(term+"").replace(/([\\\.\+\*\?\[\^\]\$\(\)\{\}\=\!\<\>\|\:])/g,"\\$1");
name=name.replace(new RegExp("("+term+")","gi"),'<span class="highlight">$1</span>');email=email.replace(new RegExp("("+term+")","gi"),'<span class="highlight">$1</span>');
$(".user-name",row).html(name);$(".user-email",row).html(email)}else{$(".user-name",row).text(user.name);
$(".user-email",row).text(user.email)}if(!user.email||user.name==user.email){$("address",row).hide()}this.resultsList.append(row)
},this);if(this.termInput.is(":focus")&&data.length){this.open()}}})},open:function(){this._initResultsBox();
this.refreshPosition();this.resultsBox.show()},close:function(){if(this.resultsBox){this.resultsBox.hide()
}},destroy:function(){if(this._hasInitResultsBox){this.resultsBox.remove()}this.resultsBox=null;this.resultsBox=null
}});Orb.createNamespace("DeskPRO.Agent.ElementHandler");DeskPRO.Agent.ElementHandler.TabBox=new Orb.Class({Extends:DeskPRO.ElementHandler,initPage:function(){var ul=$("nav ul",this.el).first();
this.tabs=new DeskPRO.UI.SimpleTabs({triggerElements:$("li",ul),context:this.el})},destroy:function(){if(this.tabs){this.tabs.destroy();
this.tabs=null}this.el=null}});Orb.createNamespace("DeskPRO.Agent.ElementHandler");DeskPRO.Agent.ElementHandler.PersonSearchBox=new Orb.Class({Extends:DeskPRO.ElementHandler,initPage:function(){var self=this;
this.termInput=$("input.term",this.el);this.idInput=$("input.person-id",this.el);this.resultsBox=$(".person-search-box",this.el);
this.resultsList=$(".results-list",this.resultsBox);this.termInput.on("focus",function(){self.open()});
this.el.on("dp_hide",function(){self.close()})},_initResultsBox:function(){var self=this;if(this._hasInitResultsBox){return
}this._hasInitResultsBox=true;this.tplHtml=DeskPRO_Window.util.getPlainTpl($(".user-row-tpl",this.el));
var updateCaller;this.updateCaller=new DeskPRO.TouchCaller({timeout:500,callback:this.updateResults,context:this});
updateCaller=this.updateCaller;this.termInput.on("keydown",function(ev){if(ev.keyCode==13){ev.preventDefault();
var current=$("li.on",self.resultsList);if(current.length){var personId=current.data("person-id");var name=$(".user-name",current).text().trim();
var email=$(".user-email",current).text().trim();self.termInput.val(email);self.el.trigger("personsearchboxclick",[personId,name,email,self])
}else{var term=self.getTerm();self.el.trigger("personsearchboxclicknew",[term,self])}}else{if(ev.keyCode==40||ev.keyCode==38){ev.preventDefault();
var dir=ev.keyCode==40?"down":"up";var current=$("li.on",self.resultsList);$("li",self.resultsList).removeClass("on");
if(!current.length){if(dir=="down"){$("li",self.resultsList).first().addClass("on")}else{$("li",self.resultsList).last().addClass("on")
}}else{if(dir=="down"){var next=current.next("li");if(!next.length){next=$("li",self.resultsList).first()
}}else{var next=current.prev("li");if(!next.length){next=$("li",self.resultsList).last()}}next.addClass("on")
}}}}).on("keyup",function(ev){if(ev.keyCode==13){}else{if(ev.keyCode==40||ev.keyCode==38){}else{updateCaller.touch(self.getTerm())
}}}).on("change",function(){updateCaller.touch(self.getTerm())});this.termInput.on("click",function(ev){ev.stopPropagation()
});this.resultsBox.on("click",function(ev){ev.stopPropagation()});$(document).on("click",this.close.bind(this));
$(this.termInput).closest(".doc-layer").on("click",this.close.bind(this));this.resultsList.on("click","li",function(ev){ev.preventDefault();
var personId=$(this).data("person-id");var name=$(".user-name",this).text().trim();var email=$(".user-email",this).text().trim();
self.el.trigger("personsearchboxclick",[personId,name,email,self])});$(".create-user",this.resultsBox).on("click",function(ev){ev.preventDefault();
var term=self.getTerm();self.el.trigger("personsearchboxclicknew",[term,self])});this.boundEl=this.termInput;
if(this.el.data("position-bound")){var boundDesc=this.el.data("position-bound");if(boundDesc[0]=="#"){this.boundEl=$(boundDesc)
}else{if(boundDesc=="@self"){this.boundEl=this.el}else{if(boundDesc.test(/^@parent\((.*?)\)$/)){var sel=boundDesc.match(/^@parent\((.*?)\)$/)[1];
this.boundEl=this.el.closest(sel)}else{this.boundEl=$(boundDesc,this.el)}}}}if(!this.boundEl||!this.boundEl.length){DP.console.error("Could not find position-bound element %s on %o",this.el.data("position-bound"),this)
}this.resultsBox.detach().hide().appendTo("body")},reset:function(){if(this.runningAjax){this.runningAjax.abort();
this.runningAjax=null}this.termInput.val("");this.resultsList.empty()},refreshPosition:function(){var termPos=this.boundEl.offset();
var termW=this.boundEl.outerWidth();var termH=this.boundEl.outerHeight();this.resultsBox.css({top:termPos.top+termH-1,left:termPos.left,width:termW})
},getTerm:function(){return this.termInput.val().trim()},updateResults:function(){var url=this.el.data("search-url");
var term=this.getTerm();var postData=[];postData.push({name:this.el.data("search-param")||"term",value:term});
this.termInput.parent().addClass("loading");this.runningAjax=$.ajax({type:"GET",url:url,data:postData,dataType:"json",context:this,complete:function(){this.termInput.parent().removeClass("loading");
this.runningAjax=null},success:function(data){var currentPersonId=parseInt($("li.on",this.resultsList).data("person-id"))||0;
this.resultsList.empty();Array.each(data,function(user){var row=$(this.tplHtml);row.data("person-id",user.id);
row.attr("person-id",user.id);row.addClass("person-"+user.id);if(currentPersonId&&currentPersonId==parseInt(user.id)){row.addClass("on");
currentPersonId=false}if(this.el.data("highlight-term")){var term=Orb.escapeHtml(this.getTerm());var name=Orb.escapeHtml(user.name);
var email=Orb.escapeHtml(user.email);term=(term+"").replace(/([\\\.\+\*\?\[\^\]\$\(\)\{\}\=\!\<\>\|\:])/g,"\\$1");
name=name.replace(new RegExp("("+term+")","gi"),'<span class="highlight">$1</span>');email=email.replace(new RegExp("("+term+")","gi"),'<span class="highlight">$1</span>');
$(".user-name",row).html(name);$(".user-email",row).html(email)}else{$(".user-name",row).text(user.name);
$(".user-email",row).text(user.email)}if(!user.email||user.name==user.email){$("address",row).hide()}this.resultsList.append(row)
},this)}})},open:function(){this._initResultsBox();this.refreshPosition();this.resultsBox.show()},close:function(){if(this.resultsBox){this.resultsBox.hide()
}},destroy:function(){if(this._hasInitResultsBox){this.resultsBox.remove()}this.resultsBox=null;this.idInput=null;
this.resultsBox=null}});Orb.createNamespace("DeskPRO.Agent.ElementHandler");DeskPRO.Agent.ElementHandler.OrgSearchBox=new Orb.Class({Extends:DeskPRO.ElementHandler,initPage:function(){var self=this;
this.el.data("org-search-box",this);this.termInput=$("input.org-name",this.el);this.idInput=$("input.org-id",this.el);
this.resultsBox=$(".person-search-box",this.el);this.resultsList=$(".results-list",this.resultsBox);this.termInput.on("focus",function(){self.open();
if(self.el.data("touch-focus")){self.updateCaller.touch(self.getTerm(),true)}});this.el.on("dp_hide",function(){self.close()
})},_initResultsBox:function(){var self=this;if(this._hasInitResultsBox){return}this._hasInitResultsBox=true;
this.tplHtml=DeskPRO_Window.util.getPlainTpl($(".user-row-tpl",this.el));var updateCaller;this.updateCaller=new DeskPRO.TouchCaller({timeout:500,callback:this.updateResults,context:this});
updateCaller=this.updateCaller;this.termInput.on("keyup",function(){updateCaller.touch(self.getTerm())
}).on("change",function(){updateCaller.touch(self.getTerm())});this.termInput.on("click",function(ev){ev.stopPropagation()
});this.resultsBox.on("click",function(ev){ev.stopPropagation()});if(this.el.data("super-container")){this.el.closest(this.el.data("super-container")).on("click",this.close.bind(this))
}else{$(document).on("click",this.close.bind(this))}this.resultsList.on("click","li",function(ev){ev.preventDefault();
var orgId=$(this).data("org-id");var name=$(".org-name",this).text().trim();self.termInput.val(name);
self.idInput.val(orgId);self.el.removeClass("is-new").addClass("is-set");self.wasSet=true;self.close();
self.el.trigger("orgsearchboxclick",[orgId,name,self])});$(".create-org",this.resultsBox).on("click",function(ev){ev.preventDefault();
self.idInput.val("0");self.el.addClass("is-new").removeClass("is-set");self.wasSet=true;self.close();
self.el.trigger("orgsearchboxcreate",[self.getTerm(),self])});this.boundEl=this.termInput;if(this.el.data("position-bound")){var boundDesc=this.el.data("position-bound");
if(boundDesc[0]=="#"){this.boundEl=$(boundDesc)}else{if(boundDesc=="@self"){this.boundEl=this.el}else{if(boundDesc.test(/^@parent\((.*?)\)$/)){var sel=boundDesc.match(/^@parent\((.*?)\)$/)[1];
this.boundEl=this.el.closest(sel)}else{this.boundEl=$(boundDesc,this.el)}}}}if(!this.boundEl||!this.boundEl.length){DP.console.error("Could not find position-bound element %s on %o",this.el.data("position-bound"),this)
}this.resultsBox.detach().hide().appendTo("body")},reset:function(){this.termInput.val("");this.resultsList.empty()
},refreshPosition:function(){var termPos=this.boundEl.offset();var termW=this.boundEl.outerWidth()+6;
var termH=this.boundEl.outerHeight();this.resultsBox.css({top:termPos.top+termH-1,left:termPos.left-1,width:termW})
},getTerm:function(){return this.termInput.val().trim()},updateResults:function(){var url=this.el.data("search-url");
var term=this.getTerm();var postData=[];postData.push({name:this.el.data("search-param")||"term",value:term});
this.runningAjax=$.ajax({type:"GET",url:url,data:postData,dataType:"json",context:this,complete:function(){this.runningAjax=null
},success:function(data){this.resultsList.empty();Array.each(data,function(org){var row=$(this.tplHtml);
row.data("org-id",org.id);row.attr("org-id",org.id);if(this.el.data("highlight-term")){var term=Orb.escapeHtml(this.getTerm());
var name=Orb.escapeHtml(org.name);term=(term+"").replace(/([\\\.\+\*\?\[\^\]\$\(\)\{\}\=\!\<\>\|\:])/g,"\\$1");
name=name.replace(new RegExp("("+term+")","gi"),'<span class="highlight">$1</span>');$(".org-name",row).html(name)
}else{$(".org-name",row).text(org.name)}this.resultsList.append(row)},this)}})},open:function(){this.origValue=this.termInput.val();
this.wasSet=false;this._initResultsBox();this.refreshPosition();this.resultsBox.show()},close:function(){if(this.resultsBox){this.resultsBox.hide()
}if(!this.idInput){return}if(!this.wasSet){if(!this.termInput.val().trim().length){this.idInput.val("0");
this.el.removeClass("is-new").removeClass("is-set");this.el.trigger("orgsearchboxcleared",[this])}else{this.termInput.val(this.origValue);
this.el.trigger("orgsearchreverted",[this.getTerm(),this])}}},destroy:function(){if(this._hasInitResultsBox){this.resultsBox.remove()
}this.resultsBox=null;this.idInput=null;this.resultsBox=null}});Orb.createNamespace("DeskPRO.Agent.ElementHandler");
DeskPRO.Agent.ElementHandler.TicketSearchBox=new Orb.Class({Extends:DeskPRO.ElementHandler,initPage:function(){var self=this;
this.termInput=$("input.term",this.el);this.idInput=$("input.ticket-id",this.el);this.resultsBox=$(".ticket-search-box",this.el);
this.resultsList=$(".results-list",this.resultsBox);this.termInput.on("focus",function(){self.open()});
this.el.on("dp_hide",function(){self.close()})},_initResultsBox:function(){var self=this;if(this._hasInitResultsBox){return
}this._hasInitResultsBox=true;this.tplHtml=DeskPRO_Window.util.getPlainTpl($(".ticket-row-tpl",this.el));
var updateCaller;this.updateCaller=new DeskPRO.TouchCaller({timeout:500,callback:this.updateResults,context:this});
updateCaller=this.updateCaller;this.termInput.on("keypress",function(ev){if(ev.keyCode==13){ev.preventDefault();
var current=$("li.on",self.resultsList);if(current.length){var ticketId=current.data("ticket-id");var subject=$(".ticket-subject",current).text().trim();
self.termInput.val(subject);self.el.trigger("ticketsearchboxclick",[ticketId,subject,self])}}else{if(ev.keyCode==40||ev.keyCode==38){ev.preventDefault();
var dir=ev.keyCode==40?"down":"up";var current=$("li.on",self.resultsList);$("li",self.resultsList).removeClass("on");
if(!current.length){if(dir=="down"){$("li",self.resultsList).first().addClass("on")}else{$("li",self.resultsList).last().addClass("on")
}}else{if(dir=="down"){var next=current.next("li");if(!next.length){next=$("li",self.resultsList).first()
}}else{var next=current.prev("li");if(!next.length){next=$("li",self.resultsList).last()}}next.addClass("on")
}}else{updateCaller.touch(self.getTerm())}}}).on("change",function(){updateCaller.touch(self.getTerm())
});this.termInput.on("click",function(ev){ev.stopPropagation()});this.resultsBox.on("click",function(ev){ev.stopPropagation()
});$(document).on("click",this.close.bind(this));$(this.termInput).closest(".doc-layer").on("click",this.close.bind(this));
this.resultsList.on("click","li",function(ev){ev.preventDefault();var ticketId=$(this).data("ticket-id");
var subject=$(".ticket-subject",this).text().trim();self.el.trigger("ticketsearchboxclick",[ticketId,subject,self])
});this.boundEl=this.termInput;if(this.el.data("position-bound")){var boundDesc=this.el.data("position-bound");
if(boundDesc[0]=="#"){this.boundEl=$(boundDesc)}else{if(boundDesc=="@self"){this.boundEl=this.el}else{if(boundDesc.test(/^@parent\((.*?)\)$/)){var sel=boundDesc.match(/^@parent\((.*?)\)$/)[1];
this.boundEl=this.el.closest(sel)}else{this.boundEl=$(boundDesc,this.el)}}}}if(!this.boundEl||!this.boundEl.length){DP.console.error("Could not find position-bound element %s on %o",this.el.data("position-bound"),this)
}this.resultsBox.detach().hide().appendTo("body")},reset:function(){if(this.runningAjax){this.runningAjax.abort();
this.runningAjax=null}this.termInput.val("");this.resultsList.empty()},refreshPosition:function(){var termPos=this.boundEl.offset();
var termW=this.boundEl.outerWidth();var termH=this.boundEl.outerHeight();this.resultsBox.css({top:termPos.top+termH-1,left:termPos.left,width:termW})
},getTerm:function(){return this.termInput.val().trim()},updateResults:function(){var url=this.el.data("search-url");
var term=this.getTerm();var postData=[];postData.push({name:this.el.data("search-param")||"term",value:term});
this.termInput.parent().addClass("loading");this.runningAjax=$.ajax({type:"GET",url:url,data:postData,dataType:"json",context:this,complete:function(){this.termInput.parent().removeClass("loading");
this.runningAjax=null},success:function(data){var currentTicketId=parseInt($("li.on",this.resultsList).data("ticket-id"))||0;
this.resultsList.empty();Array.each(data,function(ticket){var row=$(this.tplHtml);row.data("ticket-id",ticket.id);
row.attr("ticket-id",ticket.id);row.addClass("ticket-"+ticket.id);if(ticket.status=="awaiting_agent"){row.find(".ticket-status").addClass("awaiting_agent").text("Awaiting Agent")
}else{if(ticket.status=="awaiting_user"){row.find(".ticket-status").addClass("awaiting_user").text("Awaiting User")
}else{if(ticket.status=="resolved"){row.find(".ticket-status").addClass("resolved").text("Resolved")}else{if(ticket.status=="closed"){row.find(".ticket-status").addClass("closed").text("Closed")
}else{row.find(".ticket-status").remove()}}}}var d=new Date(ticket.last_activity*1000);row.find(".ticket-time").attr("datetime",d.toISOString()).timeago();
if(currentTicketId&&currentTicketId==parseInt(ticket.id)){row.addClass("on");currentTicketId=false}if(this.el.data("highlight-term")){var term=Orb.escapeHtml(this.getTerm());
var subject=Orb.escapeHtml(ticket.subject);term=(term+"").replace(/([\\\.\+\*\?\[\^\]\$\(\)\{\}\=\!\<\>\|\:])/g,"\\$1");
subject=subject.replace(new RegExp("("+term+")","gi"),'<span class="highlight">$1</span>');$(".ticket-subject",row).html(subject)
}else{$(".ticket-subject",row).text(ticket.subject)}$(".ticket-id",row).text(ticket.id);this.resultsList.append(row)
},this)}})},open:function(){this._initResultsBox();this.refreshPosition();this.resultsBox.show()},close:function(){this.resultsBox.hide()
},destroy:function(){if(this._hasInitResultsBox){this.resultsBox.remove()}this.resultsBox=null;this.idInput=null;
this.resultsBox=null}});Orb.createNamespace("DeskPRO.Agent.ElementHandler");DeskPRO.Agent.ElementHandler.PhoneCountryCode=new Orb.Class({Extends:DeskPRO.ElementHandler,initPage:function(){this.optionsList=$(this.el.data("options-list"));
var options=[];$("li",this.optionsList).each(function(){options.push({country_code:$(this).data("country-code"),value:$(this).data("calling-code"),label:$(this).html()})
});var countryCodeSel=$(".country-code",this.el);var flagEl=$(".icon-flag",this.el);var updateIcon=function(){if(countryCodeSel.is(".cancel-next-update")){countryCodeSel.removeClass("cancel-next-update");
return}var val=countryCodeSel.val().trim();var cc=null;if(val){Array.each(options,function(opt){if((opt.value+"")==(val+"")){cc=opt.country_code
}})}if(cc){flagEl.attr("class","").addClass("icon-flag").addClass("icon-flag-"+cc.toLowerCase()).show()
}else{flagEl.hide()}countryCodeSel.autocomplete("close")};countryCodeSel.autocomplete({minLength:0,source:function(req,callback){var term=req.term.trim();
if(term===""){return options}var ret=[];Array.each(options,function(opt){if((opt.value+"").indexOf(term)===0){ret.push(opt)
}});callback(ret)},delay:0}).on("change",updateIcon).data("autocomplete")._renderItem=function(ul,item){return $("<li></li>").addClass("ui-menu-item").data("item.autocomplete",item).html(item.label).appendTo(ul)
};updateIcon()}});Orb.createNamespace("DeskPRO.Agent.ElementHandler");DeskPRO.Agent.ElementHandler.QuickSearch=new Orb.Class({Extends:DeskPRO.ElementHandler,initPage:function(){var searchBox=$("#dp_search_box");
var searchHelp=$("#dp_header_search_help");var searchUrl=this.el.data("search-url");var listWrap=$("#dp_search_box_list_wrap");
var list=$("#dp_search_box_list");var eatClick=false;searchBox.data("handler",{setSearch:function(term){searchBox.focus();
searchBox.val("");searchBox.val(term);updateSearch(true)}});list.on("click",".show-more",function(ev){Orb.cancelEvent(ev);
var type=$(this).closest(".title").data("type");if(type){list.find("li.type-"+type).show().addClass("dp-vis")
}$(this).hide();searchBox.addClass("dp-focus");searchBox.removeClass("dp-stick-open");searchBox.focus()
});listWrap.on("mousedown",function(ev){$(this).addClass("dp-focus");searchBox.focus();Orb.cancelEvent(ev);
ev.stopImmediatePropagation()});list.on("mousedown",function(ev){$(this).addClass("dp-focus");searchBox.focus();
Orb.cancelEvent(ev);ev.stopImmediatePropagation()});$("#dp_search_box_help_trigger").on("mousedown",function(ev){Orb.cancelEvent(ev);
searchBox.addClass("dp-stick-open dp-regaining-focus");searchHelp.addClass("active");var closeFn=function(){searchBox.addClass("dp-focus");
searchBox.removeClass("dp-stick-open");searchHelp.removeClass("active");searchBox.focus();window.setTimeout(function(){searchBox.removeClass("dp-regaining-focus")
},200)};if(!searchHelp.data("has-init")){searchHelp.on("click",function(ev){ev.stopPropagation()})}Orb.shimClickCallback(closeFn,"zindex-chrome0")
});$("#search_icons_nav").find("li").on("click",function(ev){Orb.cancelEvent(ev);var section=$(this).data("target-section");
DeskPRO_Window.switchToSection(section);DeskPRO_Window.sections[section].getSectionElement().find(".pane-tabs").find('[data-tab-id="pane-content-search"]').click();
Orb.shimClickCallbackPop()});var lastWinW=0;searchBox.on("focus",function(){var winW=$(window).width();
$(this).addClass("dp-focus");if($(this).hasClass("expanded")){if(list.find("li")[0]){openResults()}return
}var txt,wrap,w,addToW;addToW=125;if(!$("#dp_header_logo_wrap").is(":visible")){addToW=0}$("#dp_header_logo_wrap").hide();
wrap=$("#dp_header_search_wrap");if(wrap.data("orig-width")&&winW==lastWinW){w=wrap.data("orig-width")
}else{w=wrap.width();wrap.data("orig-width",w)}wrap.width(w+addToW);if(addToW){wrap.css("margin-right","8px")
}txt=$(this);if(txt.data("orig-width")&&winW==lastWinW){w=txt.data("orig-width")}else{w=txt.width();txt.data("orig-width",w)
}txt.addClass("expanded");if(addToW){txt.stop();txt.animate({width:w+addToW},300,function(){$("#dp_search_box_help_trigger").show();
$("#dp_search_box_help_trigger").css("opacity",0);$("#dp_search_box_help_trigger").animate({opacity:100},1500)
})}else{$("#dp_search_box_help_trigger").show();$("#dp_search_box_help_trigger").css("opacity",0);$("#dp_search_box_help_trigger").stop();
$("#dp_search_box_help_trigger").animate({opacity:100},1500)}}).on("blur",function(){$(this).removeClass("dp-focus");
if($(this).hasClass("dp-regaining-focus")){return}window.setTimeout(function(){if(!searchBox.hasClass("dp-focus")){closeResults()
}if(searchBox.val().length||searchBox.hasClass("dp-stick-open")){return}var txt,wrap,w;wrap=$("#dp_header_search_wrap");
wrap.width(wrap.data("orig-width"));wrap.css("margin-right","0");txt=searchBox;txt.stop();$("#dp_search_box_help_trigger").stop();
txt.width(txt.data("orig-width")).removeClass("expanded");$("#dp_search_box_help_trigger").hide();$("#dp_header_logo_wrap").show()
},130)});var clearResults=function(){list.empty()};var closeResults=function(){listWrap.hide()};var openResults=function(){listWrap.show()
};var setResults=function(results,clear){var self=this;clearResults();if(!results){closeResults();return
}var count=0;Object.each(results,function(typeResults,type){var sectionEl,listEl,resultEl,hasMore,res,subList,subResultEl,subRes;
if(!typeResults||!typeResults.length||!$.isArray(typeResults)){return}sectionEl=$(DeskPRO_Window.util.getPlainTpl("#dp_header_search_row_title_tpl"));
sectionEl.data("type",type);sectionEl.find(".type-icon").addClass($("#dp_header_search_row_title_tpl").data("icon-"+type)||"icon-caret-right");
sectionEl.find(".type-title").text($("#dp_header_search_row_title_tpl").data("title-"+type)||type);sectionEl.find(".show-more").hide();
sectionEl.appendTo(list);hasMore=false;for(var ri=0;ri<typeResults.length;ri++){count++;res=typeResults[ri];
resultEl=$(DeskPRO_Window.util.getPlainTpl("#dp_header_search_row_tpl"));resultEl.addClass(type+" "+"type-"+type).data("type",type);
resultEl.find(".row-id").text(res.id);resultEl.find(".row-title").html(res.title);resultEl.data("route",res.route).attr("data-route",res.route);
resultEl.data("route-notabreload","1").attr("data-route-notabreload","1");if(res.subs){subList=$("<ul></ul>");
for(var sub_ri=0;sub_ri<res.subs.length;sub_ri++){subRes=res.subs[sub_ri];subResultEl=$(DeskPRO_Window.util.getPlainTpl("#dp_header_search_row_tpl"));
subResultEl.addClass(subRes.type+" "+"type-"+subRes.type).data("type",subRes.type);subResultEl.find(".row-id").text(subRes.id);
subResultEl.find(".row-title").html(subRes.title);subResultEl.data("route",subRes.route).attr("data-route",subRes.route);
subResultEl.data("route-notabreload","1").attr("data-route-notabreload","1");subResultEl.appendTo(subList)
}subList.hide();subList.appendTo(resultEl);resultEl.find(".row-title").first().before('<span class="sublist-toggle"></span>')
}if(ri>=5){resultEl.hide();hasMore=true}else{resultEl.addClass("dp-vis")}resultEl.appendTo(list)}if(hasMore){var showMoreEl=sectionEl.find(".show-more");
Orb.phraseTextEl(showMoreEl,{count:typeResults.length-5});showMoreEl.show()}},this);list.find(".sublist-toggle").on("click",function(ev){Orb.cancelEvent(ev);
eatClick=true;$(this).addClass("dp-focus");searchBox.focus();if($(this).hasClass("expanded")){$(this).removeClass("expanded");
$(this).closest("li").find("ul").hide()}else{$(this).addClass("expanded");$(this).closest("li").find("ul").show()
}});list.find("[data-route]").on("click",function(ev){console.log("CLick");Orb.cancelEvent(ev);ev.stopImmediatePropagation();
DeskPRO_Window.runPageRouteFromElement($(this));searchBox.blur();closeResults();eatClick=false});if(count){openResults()
}else{closeResults()}};var updateSearch=function(force){if(updateTimeout){window.clearTimeout(updateTimeout);
updateTimeout=null}if(runningAjax){if(force){runningAjax.abort()}else{return}}var input=$.trim(searchBox.val());
if(input===""){clearResults();closeResults()}if(input==prevInput&&!force){return}prevInput=input;$("#dp_search_box_help_trigger").hide();
$("#dp_search_box_loading").show();$.ajax({url:searchUrl,data:{q:input},type:"GET",dataType:"json",complete:function(){$("#dp_search_box_help_trigger").show();
$("#dp_search_box_loading").hide();runningAjax=null;if(updateTimeout){window.clearTimeout(updateTimeout);
updateTimeout=null}updateSearch()},success:function(results){setResults(results)}})};var runningAjax=null;
var eatNext=false;var prevInput=null;var updateTimeout=null;searchBox.on("keydown",function(ev){if(ev.keyCode==13){Orb.cancelEvent(ev);
var current=list.find(".dp-cursor");eatNext=true;if(current[0]){DeskPRO_Window.runPageRouteFromElement(current);
searchBox.blur();closeResults()}else{updateSearch(true)}}else{if(ev.keyCode==40||ev.keyCode==38){Orb.cancelEvent(ev);
eatNext=true;var current=list.find(".dp-cursor");current.removeClass("dp-cursor");var dir=ev.keyCode==40?"down":"up";
var next;if(!current.length){if(dir=="down"){list.find(".dp-vis").first().addClass("dp-cursor")}else{list.find(".dp-vis").last().addClass("dp-cursor")
}}else{if(dir=="down"){next=current.next("li.dp-vis");if(!next.length){next=current.next().next("li.dp-vis")
}if(!next.length){next=list.find(".dp-vis").first().addClass("dp-cursor")}}else{next=current.prev("li.dp-vis");
if(!next.length){next=current.prev().prev("li.dp-vis")}if(!next.length){next=list.find(".dp-vis").last().addClass("dp-cursor")
}}next.addClass("dp-cursor")}}else{if(!updateTimeout){updateTimeout=window.setTimeout(updateSearch,520)
}}}}).on("keypress",function(ev){if(!updateTimeout){updateTimeout=window.setTimeout(updateSearch,520)
}})}});Orb.createNamespace("DeskPRO.Agent.ElementHandler");DeskPRO.Agent.ElementHandler.PasswordPrompt=new Orb.Class({Extends:DeskPRO.ElementHandler,init:function(){var self=this;
this.el.bind("dp_open",function(ev,options){self.open(options)})},_initOverlay:function(){var self=this;
if(this._hasInit){return}this._hasInit=true;this.el.detach().hide().appendTo("body");this.passwordField=$("input.password-input",this.el);
this.explainEl=$(".explain-wrap",this.el);this.backdropEl=$('<div class="backdrop dp-overlay-backdrop" />');
this.backdropEl.css("z-index","40000").hide().appendTo("body");this.backdropEl.on("click",(function(ev){ev.stopPropagation();
this.close()}).bind(this));$("header .close-trigger",this.el).on("click",(function(ev){ev.stopPropagation();
ev.preventDefault();this.close()}).bind(this));$("button.continue-trigger").on("click",function(){var password=self.passwordField.val();
if(password===""){return}$.ajax({url:BASE_URL+"agent/password-confirm-code.json",type:"POST",dataType:"json",data:{password:password},context:self,success:function(res){if(res.invalid){this.failedFn(this);
this.el.addClass("with-error")}else{this.cancelFn=function(){};this.close();this.successFn(res.code,this)
}}})})},open:function(options){this.successFn=options.success||function(){};this.failedFn=options.failed||function(){};
this.cancelFn=options.cancel||function(){};this._initOverlay();if(options.explain){if(typeof options.explain==="string"){this.explainEl.text(options.explain).show()
}else{this.explainEl.append(options.explain).show()}}this.updatePositions();this.el.show()},updatePositions:function(){var elW=this.el.width();
var elH=this.el.height();var pageW=$(window).width();var pageH=$(window).height();this.el.css({top:(pageH-elH)/2,left:(pageW-elW)/2})
},close:function(){this.cancelFn();this.el.hide();this.backdropEl.hide()},reset:function(){this.cancelFn();
this.cancelFn=null;this.successFn=null;this.failedFn=null;this.passwordField.val("");this.explainEl.empty().hide();
this.el.removeClass("with-error")}});Orb.createNamespace("DeskPRO.Agent.ElementHandler");DeskPRO.Agent.ElementHandler.TimezoneSwitch=new Orb.Class({Extends:DeskPRO.ElementHandler,init:function(){var self=this;
this.el.bind("dp_open",function(ev,options){self.open(options)})},_initOverlay:function(){var self=this;
if(this._hasInit){return}this._hasInit=true;var now=new Date();var hour=now.getHours();var ampm="am";
if(hour>12){hour-=12;ampm="pm"}var min=now.getMinutes();if(min<10){min="0"+min}var time=hour+":"+min+" "+ampm;
this.el.find(".js_time").text(time);this.el.detach().hide().appendTo("body");this.backdropEl=$('<div class="backdrop dp-overlay-backdrop" />');
this.backdropEl.css("z-index","40000").hide().appendTo("body");this.backdropEl.on("click",(function(ev){ev.stopPropagation();
this.close()}).bind(this));$("header .close-trigger",this.el).on("click",(function(ev){ev.stopPropagation();
ev.preventDefault();this.close()}).bind(this));var tzField=$("select.timezone",this.el);DP.select(tzField);
this.el.find("button.dismiss-trigger").on("click",function(){$.ajax({url:BASE_URL+"agent/misc/ajax-save-prefs",type:"POST",dataType:"json",data:[{name:"prefs[agent.ui.tz_detect_dismiss]",value:DESKPRO_TIME_OUT_OF_SYNC}]});
self.close();return});this.el.find("button.continue-trigger").on("click",function(){var tz=tzField.find("option:selected").val();
if(!tz){self.close();return}$.ajax({url:BASE_URL+"agent/settings/profile/update-timezone.json",type:"POST",dataType:"json",data:{timezone:tz},context:self,success:function(res){self.close();
DeskPRO_Window.util.reloadInterface()}})})},open:function(options){this._initOverlay();this.updatePositions();
this.el.show()},updatePositions:function(){var elW=this.el.width();var elH=this.el.height();var pageW=$(window).width();
var pageH=$(window).height();this.el.css({top:(pageH-elH)/2,left:(pageW-elW)/2})},close:function(){this.el.hide();
this.backdropEl.hide()}});Orb.createNamespace("DeskPRO.Admin.ElementHandler");DeskPRO.Admin.ElementHandler.RadioExpander=new Orb.Class({Extends:DeskPRO.ElementHandler,init:function(){var self=this;
var groupClass=this.el.data("group-class");var expandClass=this.el.data("expand-class");var radios=$(".option-trigger",this.el);
var firstSubRadio=this.el.data("select-first-subradio");var currentGroup=null;function switchtoradio(radio){self.el.find("."+groupClass+".on").removeClass("on");
if(currentGroup&&expandClass){$("."+expandClass,currentGroup).hide()}var group=radio.closest("."+groupClass).addClass("on");
if(expandClass){$("."+expandClass,group).show()}currentGroup=group;if(firstSubRadio){group.find(":radio."+firstSubRadio).first().click()
}}$(":radio.option-trigger:checked",this.el).each(function(){switchtoradio($(this))});this.el.on("click",":radio.option-trigger",function(){switchtoradio($(this))
});this.el.on("click","."+groupClass+":not(.on)",function(e){var radio=$(this).find(".option-trigger");
if(radio.length){radio.prop("checked","checked");switchtoradio(radio);if(!$(e.target).is("input[type=radio]")){radio.change()
}}})}});Orb.createNamespace("DeskPRO.Agent.ElementHandler");DeskPRO.Agent.ElementHandler.FirstLogin=new Orb.Class({Extends:DeskPRO.ElementHandler,initPage:function(){var self=this;
var el=this.el;window.FIRST_LOGIN_WINDOW=this;DeskPRO_Window.util.fileupload(this.el.find(".profile-picture"));
this.el.find(".profile-picture").bind("fileuploadadd",function(){$(".files",el).empty()});$('<div style="position:absolute;top:0;left:0;right:0;bottom:0;z-index:51001;background-color:rgba(255,255,255,0.55);"></div>').appendTo("body");
this.el.find(".save-trigger").on("click",function(ev){ev.preventDefault();ev.stopPropagation();var name=el.find("input.name").val().trim();
if(!name){alert("Please enter your name");return}$(this).after($('<i class="flat-spinner"></i>'));$(this).hide();
$.ajax({url:el.find("form").attr("action"),type:"POST",data:{new_blob_id:el.find("input.new_blob_id").val(),name:el.find("input.name").val(),timezone:el.find("select.timezone").val()},dataType:"json",complete:function(){window.location.reload(false)
}})});DP.select(this.el.find("select"));this.updatePositions();this.el.show()},updatePositions:function(){var left=($(window).width()/2)-(this.el.outerWidth()/2);
this.el.css("left",left);this.el.show()}});Orb.createNamespace("DeskPRO.Agent.ElementHandler");DeskPRO.Agent.ElementHandler.TwitterFeed=new Orb.Class({Extends:DeskPRO.ElementHandler,init:function(){this.twitterUsername=this.el.data("twitter-username");
this.tpl=DeskPRO_Window.util.getPlainTpl($(".twitter-list-item-tpl",this.el));this.list=$(".twitter-list",this.el);
this.limit=parseInt(this.el.data("tweet-limit"))||5},initPage:function(){var ify=function(){return{entities:function(t){return t.replace(/(&[a-z0-9]+;)/g,function(m){return ENTITIES[m]
})},link:function(t){return t.replace(/[a-z]+:\/\/([a-z0-9-_]+\.[a-z0-9-_:~\+#%&\?\/.=]+[^:\.,\)\s*$])/ig,function(m,link){return'<a title="'+m+'" href="'+m+'">'+((link.length>36)?link.substr(0,35)+"&hellip;":link)+"</a>"
})},at:function(t){return t.replace(/(^|[^\w]+)\@([a-zA-Z0-9_]{1,15}(\/[a-zA-Z0-9-_]+)*)/g,function(m,m1,m2){return m1+'@<a href="http://twitter.com/'+m2+'">'+m2+"</a>"
})},hash:function(t){return t.replace(/(^|[^&\w'"]+)\#([a-zA-Z0-9_^"^<]+)/g,function(m,m1,m2){return m.substr(-1)==='"'||m.substr(-1)=="<"?m:m1+'#<a href="http://search.twitter.com/search?q=%23'+m2+'">'+m2+"</a>"
})},clean:function(tweet){return this.hash(this.at(this.link(tweet)))}}}();$.ajax({url:"http://api.twitter.com/1/statuses/user_timeline.json?screen_name="+this.twitterUsername,dataType:"jsonp",context:this,success:function(data){Array.each(data,function(tweet,index){if(index>this.limit){return false
}var item=$(this.tpl);var text=tweet.text;text=ify.clean(text);$(".tweet",item).html(text);this.list.append(item);
this.el.show()},this)}})}});Orb.createNamespace("DeskPRO.Agent.SourcePane");DeskPRO.Agent.SourcePane.SearchForm=new Orb.Class({Implements:[Orb.Util.Events],initialize:function(el){var self=this;
this.el=el;this.origHtml=el.html();this.hasInit=false;this.formPanels=[];this.widgets=[];this.el.addClass("dp-with-activate-listener");
this.el.on("dp_activated",function(){self.initPanel()})},reset:function(){this.el.html(this.origHtml);
Array.each(this.formPanels,function(formPanel){formPanel.destroy()});this.formPanels=[];this.widgets=[];
this.hasInit=false;this.initPanel()},getFormData:function(){var postData=[];var visitedEls=[];postData=Orb.serializeFormElements(this.el.find(".add-to-search"),visitedEls);
Array.each(this.formPanels,function(panel){postData=postData.append(Orb.serializeFormElements(panel.el.find(".add-to-search"),visitedEls))
});return postData},initPanel:function(){if(this.hasInit){return}this.hasInit=true;var self=this;this.el.find(".trigger-open-panel").each(function(){if($(this).hasClass("has-init-trigger-open-panel")){return
}$(this).addClass("has-init-trigger-open-panel");var panelTrigger=$(this);var panelEl=self.el.find("."+panelTrigger.data("panel-id")).first();
var panelSummary=self.el.find(panelTrigger.data("target-summary")).first();var panel=new DeskPRO.Agent.SourcePane.SearchFormPanel(panelEl);
panel.targetSummaryEl=panelSummary;panelTrigger.on("click",function(ev){Orb.cancelEvent(ev);panel.open(this)
});self.formPanels.push(panel)});var submitBtn=this.el.find(".trigger-submit-search").on("click",function(ev){Orb.cancelEvent(ev);
var postData=self.getFormData();DeskPRO_Window.loadListPane($(this).data("search-url"),{postData:postData})
});submitBtn=submitBtn.first();this.el.find(".reset-form-trigger").on("click",function(ev){Orb.cancelEvent(ev);
self.reset()});this.el.find('input[type="text"]').on("keypress",function(ev){if(ev.keyCode==13){submitBtn.click()
}});this.initStandardFormElements(this.el)},initStandardFormElements:function(context){var self=this;
context.find(".trigger-clone-row").each(function(ev){var btn=$(this);var target=$(btn.data("target"));
btn.data("tpl",target.html())});context.find(".trigger-clone-row").on("click",function(ev){Orb.cancelEvent(ev);
var btn=$(this);var target=$(btn.data("target"));var targetList=$(btn.data("target-list"));var clone=$("<div/>").html(btn.data("tpl")).addClass("pane-row add-to-search");
clone.removeClass("row-orig");self.initStandardFormElements(clone);clone.insertAfter(targetList)});context.find(".trigger-remove-row").on("click",function(ev){Orb.cancelEvent(ev);
$(this).closest(".pane-row").remove()});context.find(".dp-select-widget-simple").each(function(){var widget=new DeskPRO.UI.Select.WidgetSimple($(this));
self.widgets.push(widget)});context.find(".date-term-wrap").each(function(){var el=$(this);var status=el.find(".status-value-outer").hide();
var dateTerm=new DeskPRO.Agent.RuleBuilder.DateTerm({ruleBuilder:null,rowEl:el,rowId:null,opMenu:null});
dateTerm.initRow();el.find("select.op").on("change",function(){if($(this).val()!="0"){dateTerm.updateStatus();
status.show()}else{status.hide()}});if(el.data("base-name")){var baseName=el.data("base-name");el.find("input").each(function(){$(this).attr("name",baseName+"["+$(this).attr("name")+"][]")
})}})},destroy:function(){Array.each(this.formPanels,function(formPanel){formPanel.destroy()});this.formPanels=[]
}});DeskPRO.Agent.SourcePane.SearchFormPanel=new Orb.Class({Implements:[Orb.Util.Events],initialize:function(el){this.el=el;
this._isOpen=false;this.hasInit=false;this.shim=null;this.updateTypesTimer=null;this.searchBuilderLists=[];
this.searchValList=[];this.searchStringList=[];this.targetSummaryEl=null},initPanel:function(){if(this.hasInit){return
}this.hasInit=true;this.el.find(".with-select2").each(function(){DP.select($(this))});var self=this;this.el.detach().appendTo("body");
this.el.find(".with-search-builder").each(function(){if($(this).hasClass("has-init-search-builder")){return
}$(this).addClass("has-init-search-builder");var critTpl=$(this).find(".criteria_tpl");var critList=$(this).find(".criteria_list");
self.searchBuilderLists.push(critList.get(0));var editor=new DeskPRO.Form.RuleBuilder(critTpl);editor.addEvent("newRow",function(new_row){$(".trigger-remove-row",new_row).on("click",function(){new_row.remove()
})});$(".add-term",critList).on("click",function(){var basename="terms["+Orb.uuid()+"]";editor.addNewRow($(".search-terms",critList),basename)
})});this.searchValList=self.el.find(".ensure-value");if(this.el.data("target-summary")){this.targetSummaryEl=$(this.el.data("target-summary"))
}if(this.targetSummaryEl){this.el.find(".search-string").on("keyup keydown change",function(){self.targetSummaryEl.text(($(this).val()))
});if(this.targetSummaryEl.is("input.is-bound")){this.targetSummaryEl.on("focus",function(ev){if(self.el.find(".pane-row").length>1){$(this).blur();
self.open()}});this.targetSummaryEl.on("keypress",function(ev){if(self.el.find(".pane-row").length>1){$(this).val("");
$(this).blur();self.open()}else{self.el.find('input[type="text"]').val("")}})}}this.shim=$('<div class="dp-shim"></div>');
this.shim.appendTo("body");this.shim.on("click",function(ev){Orb.cancelEvent(ev);self.close()})},updateTypes:function(){var self=this;
var texts=[];if(this.searchBuilderLists.length){Array.each(this.searchBuilderLists,function(o_el){$.trim($(o_el).find(".builder-type-choice").each(function(){var el=$(this);
var type=$.trim($(el).find("select").find("option").filter(":selected").text());if(type){texts.push(type)
}}))})}if(this.searchValList.length){this.searchValList.each(function(){var val=$(this).val()||"";if(val.length!=0){texts.push($(this).closest(".pane-row").find(".row-label").text())
}})}var searchStringList=self.el.find(".search-string");if(searchStringList.length){searchStringList.each(function(){var val=$(this).val()||"";
if(val.length){texts.push(val)}})}if(self.targetSummaryEl.is("input")){self.targetSummaryEl.val(texts.join(", "))
}else{self.targetSummaryEl.text(texts.join(", "))}},getEl:function(){return this.el},isOpen:function(){return this._isOpen
},open:function(nearEl){var self=this;if(!this.updateTypesTimer){this.updateTypesTimer=window.setInterval(function(){self.updateTypes()
},300)}if(this._isOpen){return}this._isOpen=true;this.initPanel();this.el.show();this.shim.show();var left=269;
var top=200;if(nearEl){top=$(nearEl).offset().top-10}var winH=$(window).height();var maxH=winH-top-80;
if(maxH<250){if(winH>250){top-=(250-maxH)}else{top=60}maxH=winH-top-80}if(winH/1.5>500){maxH=parseInt(Math.min(maxH,winH/1.5))
}this.el.css({left:left,top:top,"max-height":maxH})},close:function(){if(!this._isOpen){return}this._isOpen=false;
if(this.updateTypesTimer){window.clearTimeout(this.updateTypesTimer);this.updateTypesTimer=null}this.el.hide();
this.shim.hide()},destroy:function(){this.close();if(this.hasInit){this.el.detach();this.shim.detach();
Array.each(this.widgets,function(w){w.destroy()})}}});